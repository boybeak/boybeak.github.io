<!DOCTYPE html><html lang="zh-CN" id="theme-light-mode"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="boybeak"><meta name="google-site-verification" content="Dw6K7nrSaFd0T-q4SAzzloGzxypfdeMRnSHyid3trNI"><meta name="msvalidate.01" content="FF63C4E8F966AF567DA7288160196C79"><title>ARouter源码分析 · HikingMan</title><meta name="description" content="在阅读源码前，请先下载源码：ARouter
最近阅读ARouter源码，发现这真的是一个非常优秀的框架。激发出兴趣来读一下他的源码，实际上，这个框架的结构非常简单。这个框架可以分为主流程和辅助流程来拆开分析。
主流程包含编译时和运行时两个部分，其中编译时主要做的是路由路径表的构建，运行时主要做的是路"><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon-32x32.png"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/tags">Tags</a></li><li> <a href="/sitemap.xml">sitemap</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-search" onclick="openWindow();"></a></li><li><a class="fa fa-sun-o" onclick="darkLightToggle();"></a></li></div><div class="avatar"><img src="/images/logo.jpg"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/logo-large.png" style="width:192px;" alt="favicon"><h3 title=""><a href="/">HikingMan</a></h3><div class="description"><p>不是去哪里，而是去看日出</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/boybeak"><i class="fa fa-github"></i></a></li><li><a href="mailto:boybeak@gmail.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.zhihu.com/people/gao-yun-fei-65"><i class="fa fa-mortar-board"></i></a></li></ul><h4>我的作品</h4><ul class="app-links"><li> <a target="_blank" rel="noopener" href="https://github.com/boybeak/JustTodo"> <img src="/images/justtodo-icon-256.png" alt="_"><p>JustTodo</p></a></li><li> <a target="_blank" rel="noopener" href="https://github.com/boybeak/TranslatorDocs"> <img src="/images/translator-icon-256.png" alt="_"><p>Translator</p></a></li><li> <a target="_blank" rel="noopener" href="https://github.com/boybeak/DeskNote"> <img src="/images/desknote-icon-256.png" alt="_"><p>DeskNote</p></a></li></ul></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> boybeak</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><span>Anatolo </span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>ARouter源码分析</a></h3></div><div class="post-content"><p><p>在阅读源码前，请先下载源码：<a target="_blank" rel="noopener" href="https://github.com/alibaba/ARouter">ARouter</a></p>
<p>最近阅读ARouter源码，发现这真的是一个非常优秀的框架。激发出兴趣来读一下他的源码，实际上，这个框架的结构非常简单。这个框架可以分为<strong>主流程</strong>和<strong>辅助流程</strong>来拆开分析。</p>
<p>主流程包含<strong>编译时</strong>和<strong>运行时</strong>两个部分，其中编译时主要做的是路由路径表的构建，运行时主要做的是路由路径表的加载；</p>
<p>辅助流程主要就是做<strong>启动优化</strong>。</p>
<h2 id="主流程"><a href="#主流程" class="headerlink" title="主流程"></a>主流程</h2><h3 id="1-编译时"><a href="#1-编译时" class="headerlink" title="1. 编译时"></a>1. 编译时</h3><p>这部分主要涉及到的是路由路径表的构建，其实现原理是<strong>APT</strong>，即<strong>注解处理器</strong>。</p>
<p>使用ARouter时候，需要在目标类上，通过**@Route<strong>注解进行标记，注解处理器处理的就是这个注解。打开源码路径下的<em>arouter-compiler</em>这个module，找到</strong>RouteProcessor<strong>，这个类就是用来处理</strong>@Route**注解的类。这里需要了解的知识，除了APT，还有java-poet，请自行了解这些。</p>
<p>Processor类的入口方法是<em>process</em>方法，这个方法返回true，则这个处理器已经完成了自己的任务，不会被重复调用。其他比较重要的方法有<em>getSupportedSourceVersion</em>，<em>getSupportedAnnotationTypes</em>等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;? <span class="keyword">extends</span> <span class="title class_">Element</span>&gt; routeElements = roundEnv.getElementsAnnotatedWith(Route.class);</span><br></pre></td></tr></table></figure>

<p>通过这个方法，获取所有被**@Route**标记的元素。</p>
<p>获取到<em>routeElements</em>后，在<em>parseRoutes</em>方法进行处理。我们以最常用的Activity为例，进行分析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rootMap.clear();	<span class="comment">//用来分类存储标记元素</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用来检测元素是否为对应的类型，通过Types.isSubtype()方法来检测。</span></span><br><span class="line"><span class="type">TypeMirror</span> <span class="variable">type_Activity</span> <span class="operator">=</span> elementUtils.getTypeElement(ACTIVITY).asType();</span><br><span class="line"><span class="type">TypeMirror</span> <span class="variable">type_Service</span> <span class="operator">=</span> elementUtils.getTypeElement(SERVICE).asType();</span><br><span class="line"><span class="type">TypeMirror</span> <span class="variable">fragmentTm</span> <span class="operator">=</span> elementUtils.getTypeElement(FRAGMENT).asType();</span><br><span class="line"><span class="type">TypeMirror</span> <span class="variable">fragmentTmV4</span> <span class="operator">=</span> elementUtils.getTypeElement(Consts.FRAGMENT_V4).asType();</span><br></pre></td></tr></table></figure>

<p>最后将分类号的元素信息，存储在成员变量groupMap中去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, Set&lt;RouteMeta&gt;&gt; groupMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>然后再通过这个groupMap，借助java-poet，来生成真实的类。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ARouter$$Group$$test</span> <span class="keyword">implements</span> <span class="title class_">IRouteGroup</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadInto</span><span class="params">(Map&lt;String, RouteMeta&gt; atlas)</span> &#123;</span><br><span class="line">    atlas.put(<span class="string">&quot;/test/activity1&quot;</span>, RouteMeta.build(RouteType.ACTIVITY, Test1Activity.class, <span class="string">&quot;/test/activity1&quot;</span>, <span class="string">&quot;test&quot;</span>, <span class="keyword">new</span> <span class="title class_">java</span>.util.HashMap&lt;String, Integer&gt;()&#123;&#123;put(<span class="string">&quot;ser&quot;</span>, <span class="number">9</span>); put(<span class="string">&quot;ch&quot;</span>, <span class="number">5</span>); put(<span class="string">&quot;fl&quot;</span>, <span class="number">6</span>); put(<span class="string">&quot;dou&quot;</span>, <span class="number">7</span>); put(<span class="string">&quot;boy&quot;</span>, <span class="number">0</span>); put(<span class="string">&quot;url&quot;</span>, <span class="number">8</span>); put(<span class="string">&quot;pac&quot;</span>, <span class="number">10</span>); put(<span class="string">&quot;obj&quot;</span>, <span class="number">11</span>); put(<span class="string">&quot;name&quot;</span>, <span class="number">8</span>); put(<span class="string">&quot;objList&quot;</span>, <span class="number">11</span>); put(<span class="string">&quot;map&quot;</span>, <span class="number">11</span>); put(<span class="string">&quot;age&quot;</span>, <span class="number">3</span>); put(<span class="string">&quot;height&quot;</span>, <span class="number">3</span>); &#125;&#125;, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">    atlas.put(<span class="string">&quot;/test/activity2&quot;</span>, RouteMeta.build(RouteType.ACTIVITY, Test2Activity.class, <span class="string">&quot;/test/activity2&quot;</span>, <span class="string">&quot;test&quot;</span>, <span class="keyword">new</span> <span class="title class_">java</span>.util.HashMap&lt;String, Integer&gt;()&#123;&#123;put(<span class="string">&quot;key1&quot;</span>, <span class="number">8</span>); &#125;&#125;, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">    atlas.put(<span class="string">&quot;/test/activity3&quot;</span>, RouteMeta.build(RouteType.ACTIVITY, Test3Activity.class, <span class="string">&quot;/test/activity3&quot;</span>, <span class="string">&quot;test&quot;</span>, <span class="keyword">new</span> <span class="title class_">java</span>.util.HashMap&lt;String, Integer&gt;()&#123;&#123;put(<span class="string">&quot;name&quot;</span>, <span class="number">8</span>); put(<span class="string">&quot;boy&quot;</span>, <span class="number">0</span>); put(<span class="string">&quot;age&quot;</span>, <span class="number">3</span>); &#125;&#125;, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">    atlas.put(<span class="string">&quot;/test/activity4&quot;</span>, RouteMeta.build(RouteType.ACTIVITY, Test4Activity.class, <span class="string">&quot;/test/activity4&quot;</span>, <span class="string">&quot;test&quot;</span>, <span class="literal">null</span>, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">    atlas.put(<span class="string">&quot;/test/fragment&quot;</span>, RouteMeta.build(RouteType.FRAGMENT, BlankFragment.class, <span class="string">&quot;/test/fragment&quot;</span>, <span class="string">&quot;test&quot;</span>, <span class="keyword">new</span> <span class="title class_">java</span>.util.HashMap&lt;String, Integer&gt;()&#123;&#123;put(<span class="string">&quot;obj&quot;</span>, <span class="number">11</span>); put(<span class="string">&quot;name&quot;</span>, <span class="number">8</span>); &#125;&#125;, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">    atlas.put(<span class="string">&quot;/test/webview&quot;</span>, RouteMeta.build(RouteType.ACTIVITY, TestWebview.class, <span class="string">&quot;/test/webview&quot;</span>, <span class="string">&quot;test&quot;</span>, <span class="literal">null</span>, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-运行时"><a href="#2-运行时" class="headerlink" title="2. 运行时"></a>2. 运行时</h3><p>这部分主要做的是，在*ARouter.init()*时候，将上过程生成的路径表加载到内存中。</p>
<blockquote>
<p>如果你以官方demo程序验证这一步，需要将app&#x2F;build.gradle中的<code>apply plugin: &#39;com.alibaba.arouter&#39;</code>这一行代码注释掉。</p>
</blockquote>
<p>我们以<em>ARouter.init</em>方法为入口，实际上最终实现init流程的是LogisticsCenter类的<em>init</em>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(Context context, ThreadPoolExecutor tpe)</span> <span class="keyword">throws</span> HandlerException &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (registerByPlugin) &#123;</span><br><span class="line">    <span class="comment">//这是在辅助流程需要去讲的</span></span><br><span class="line">  	logger.info(TAG, <span class="string">&quot;Load router map by arouter-auto-register plugin.&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Set&lt;String&gt; routerMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// It will rebuild router map every times when debuggable.</span></span><br><span class="line">    <span class="keyword">if</span> (ARouter.debuggable() || PackageUtils.isNewVersion(context)) &#123;</span><br><span class="line">      logger.info(TAG, <span class="string">&quot;Run with debug mode or new install, rebuild router map.&quot;</span>);</span><br><span class="line">      <span class="comment">// These class was generated by arouter-compiler.</span></span><br><span class="line">      routerMap = ClassUtils.getFileNameByPackageName(mContext, ROUTE_ROOT_PAKCAGE);</span><br><span class="line">      <span class="keyword">if</span> (!routerMap.isEmpty()) &#123;</span><br><span class="line">        context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).edit().putStringSet(AROUTER_SP_KEY_MAP, routerMap).apply();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      PackageUtils.updateVersion(context);    <span class="comment">// Save new version name when router map update finishes.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.info(TAG, <span class="string">&quot;Load router map from cache.&quot;</span>);</span><br><span class="line">      routerMap = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).getStringSet(AROUTER_SP_KEY_MAP, <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;()));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要着重看的是这一句：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">routerMap = ClassUtils.getFileNameByPackageName(mContext, ROUTE_ROOT_PAKCAGE);</span><br></pre></td></tr></table></figure>

<p>我们查看这个方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title function_">getFileNameByPackageName</span><span class="params">(Context context, <span class="keyword">final</span> String packageName)</span> <span class="keyword">throws</span> PackageManager.NameNotFoundException, IOException, InterruptedException &#123;</span><br><span class="line">  <span class="keyword">final</span> Set&lt;String&gt; classNames = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  List&lt;String&gt; paths = getSourcePaths(context);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">parserCtl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(paths.size());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">final</span> String path : paths) &#123;</span><br><span class="line">    Log.v(TAG, <span class="string">&quot;getFileNameByPackageName path=&quot;</span> + path);</span><br><span class="line">    DefaultPoolExecutor.getInstance().execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DexFile</span> <span class="variable">dexfile</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (path.endsWith(EXTRACTED_SUFFIX)) &#123;</span><br><span class="line">            <span class="comment">//NOT use new DexFile(path), because it will throw &quot;permission error in /data/dalvik-cache&quot;</span></span><br><span class="line">            dexfile = DexFile.loadDex(path, path + <span class="string">&quot;.tmp&quot;</span>, <span class="number">0</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dexfile = <span class="keyword">new</span> <span class="title class_">DexFile</span>(path);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          Enumeration&lt;String&gt; dexEntries = dexfile.entries();</span><br><span class="line">          <span class="keyword">while</span> (dexEntries.hasMoreElements()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> dexEntries.nextElement();</span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(packageName)) &#123;</span><br><span class="line">              Log.v(TAG, <span class="string">&quot;find CLASS NAME &quot;</span> + className);</span><br><span class="line">              classNames.add(className);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">          Log.e(<span class="string">&quot;ARouter&quot;</span>, <span class="string">&quot;Scan map file in dex files made error.&quot;</span>, ignore);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="literal">null</span> != dexfile) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              dexfile.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          parserCtl.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  parserCtl.await();</span><br><span class="line"></span><br><span class="line">  Log.d(Consts.TAG, <span class="string">&quot;Filter &quot;</span> + classNames.size() + <span class="string">&quot; classes by packageName &lt;&quot;</span> + packageName + <span class="string">&quot;&gt;&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> classNames;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意其中的<em>getSourcePaths</em>方法，这是从代码目录，来获取所有代码目录，然后在</p>
<p><em>getFileNameByPackageName</em>找出以<code>com.alibaba.android.arouter.routes</code>为开头包名的类，这些就是我们在步骤1中生成的辅助类。</p>
<p>这个方法结束后，回到<em>LogisticsCenter#init</em>方法，接下来要做的就是，把加载到的辅助类，通过反射生成对象，再调用其<em>loadTo</em>方法，将路由路径表加载到Warehouse类中去，方便以后的查询。</p>
<h2 id="辅助流程"><a href="#辅助流程" class="headerlink" title="辅助流程"></a>辅助流程</h2><p>在以上的流程中，有一个严重的问题，那就是执行<em>ARouter#init</em>方法的时间过长，以源码的demo为例，在InstantRun的情况下，OnePlus5T需要100多毫秒才能初始化完，这对于程序启动优化来说，是一个不可忽视的时间了。那么如何解决这个问题呢？</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MainActivity: init cost 134</span><br></pre></td></tr></table></figure>

<p>这就是在上一步中，要求你注释掉的代码起作用了，将<code>apply plugin: &#39;com.alibaba.arouter&#39;</code>解除注释，让其发挥作用。</p>
<p>这里需要关注的module是<code>arouter-gradle-plugin</code>。</p>
<p>先来看一下，使用了<code>apply plugin: &#39;com.alibaba.arouter&#39;</code>的神奇效果。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MainActivity: init cost 19</span><br></pre></td></tr></table></figure>

<p>通过优化，让<em>ARouter#init</em>消耗时间直接降低了一个数量级，那么<code>arouter-gradle-plugin</code>是怎么做到的呢？</p>
<p>这需要你先了解一下[ASM](&#x2F;android&#x2F;ASM.md)。简单来说，这是一种字节码编程技术，通过修改编译后的字节码的方式，来对原始逻辑增强。</p>
<p>我们再来看<em>ARouter#init</em>的最终实现类和方法<em>LogisticsCenter#init</em>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(Context context, ThreadPoolExecutor tpe)</span> <span class="keyword">throws</span> HandlerException &#123;</span><br><span class="line">  ....</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">startInit</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="comment">//billy.qi modified at 2017-12-06</span></span><br><span class="line">    <span class="comment">//load by plugin first</span></span><br><span class="line">    loadRouterMap();</span><br><span class="line">    <span class="keyword">if</span> (registerByPlugin) &#123;</span><br><span class="line">      logger.info(TAG, <span class="string">&quot;Load router map by arouter-auto-register plugin.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ....</span><br><span class="line">    &#125;</span><br><span class="line">    .....</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HandlerException</span>(TAG + <span class="string">&quot;ARouter init logistics center exception! [&quot;</span> + e.getMessage() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到，当<code>registerByPlugin</code>为true的时候，则只是打印了一句日志，我们再看loadRouterMap()这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loadRouterMap</span><span class="params">()</span> &#123;</span><br><span class="line">  registerByPlugin = <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">//auto generate register code by gradle plugin: arouter-auto-register</span></span><br><span class="line">  <span class="comment">// looks like below:</span></span><br><span class="line">  <span class="comment">// registerRouteRoot(new ARouter..Root..modulejava());</span></span><br><span class="line">  <span class="comment">// registerRouteRoot(new ARouter..Root..modulekotlin());</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的逻辑非常简单，到底在哪里去加载的路由路径表呢？我们看这个方法的注释，发现，这个方法是被<code>arouter-auto-register</code>自动生成的。</p>
<p>我们打开<code>arouter-gradle-plugin/resources/META-INF/gradle-plugins</code>这个目录，可以看到，有一个<em>com.alibaba.arouter.properties</em>文件，查看其内容：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">implementation-class</span>=<span class="string">com.alibaba.android.arouter.register.launch.PluginLaunch</span></span><br></pre></td></tr></table></figure>

<p>这个<em>PluginLaunch</em>便是此gradle plugin的入口类。查看此类：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PluginLaunch</span> <span class="keyword">implements</span> <span class="title class_">Plugin</span>&lt;Project&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">void</span> apply(Project project) &#123;</span><br><span class="line">    <span class="keyword">def</span> isApp = project.plugins.hasPlugin(AppPlugin)</span><br><span class="line">    <span class="comment">//only application module needs this plugin to generate register code</span></span><br><span class="line">    <span class="keyword">if</span> (isApp) &#123;</span><br><span class="line">      Logger.make(project)</span><br><span class="line"></span><br><span class="line">      Logger.i(<span class="string">&#x27;Project enable arouter-register plugin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">def</span> android = project.extensions.getByType(AppExtension)</span><br><span class="line">      <span class="keyword">def</span> transformImpl = <span class="keyword">new</span> RegisterTransform(project)</span><br><span class="line"></span><br><span class="line">      <span class="comment">//init arouter-auto-register settings</span></span><br><span class="line">      ArrayList&lt;ScanSetting&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">3</span>)</span><br><span class="line">      list.add(<span class="keyword">new</span> ScanSetting(<span class="string">&#x27;IRouteRoot&#x27;</span>))</span><br><span class="line">      list.add(<span class="keyword">new</span> ScanSetting(<span class="string">&#x27;IInterceptorGroup&#x27;</span>))</span><br><span class="line">      list.add(<span class="keyword">new</span> ScanSetting(<span class="string">&#x27;IProviderGroup&#x27;</span>))</span><br><span class="line">      RegisterTransform.registerList = list</span><br><span class="line">      <span class="comment">//register this plugin</span></span><br><span class="line">      android.registerTransform(transformImpl)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们查看其代码，可以发现，这里一共做了三件事：</p>
<ol>
<li>判断是否为app module，如果不是，则不做任何事，在app module下做2和3两步；</li>
<li>生成了一个RegisterTransform，并为其静态变量registerList赋值，<strong>注意此处赋值的registerList中包含的三个对象</strong>；</li>
<li>注册此RegisterTransform。</li>
</ol>
<p>接下来，就轮到<em>RegisterTransform</em>来执行了。</p>
<p>Transform类，简单来说，就是可以在编译时，扫描所有的jar和class，包括引用类库中的。在扫描过程中，就可以借助<strong>ASM</strong>技术对目标类进行更改。</p>
<p>我们看其入口方法<em>transform</em>：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="type">void</span> transform(Context context, Collection&lt;TransformInput&gt; inputs, Collection&lt;TransformInput&gt; referencedInputs, TransformOutputProvider outputProvider, <span class="type">boolean</span> isIncremental) <span class="keyword">throws</span> IOException, TransformException, InterruptedException &#123;</span><br><span class="line">  inputs.each &#123; TransformInput input -&gt;</span><br><span class="line">    <span class="comment">// scan all jars</span></span><br><span class="line">    input.jarInputs.each &#123; JarInput jarInput -&gt;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">if</span> (ScanUtil.shouldProcessPreDexJar(src.absolutePath)) &#123;</span><br><span class="line">        ScanUtil.scanJar(src, dest)</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  input.directoryInputs.each &#123; DirectoryInput directoryInput -&gt;</span><br><span class="line">    ...</span><br><span class="line">    directoryInput.file.eachFileRecurse &#123; File file -&gt;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">if</span>(file.isFile() &amp;&amp; ScanUtil.shouldProcessClass(path))&#123;</span><br><span class="line">        ScanUtil.scanClass(file)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>省去了一些细节，只保留了主线逻辑，我们可以看到，其扫描到的jar和class都经过了ScanUtils的方法来处理，我们继续跟踪下去，会发现，<em>scanJar</em>也是循环调用的<em>scanClass</em>，这样我们直接看<em>scanClass</em>方法：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">void</span> scanClass(InputStream inputStream) &#123;</span><br><span class="line">  ClassReader cr = <span class="keyword">new</span> ClassReader(inputStream)</span><br><span class="line">  ClassWriter cw = <span class="keyword">new</span> ClassWriter(cr, <span class="number">0</span>)</span><br><span class="line">  ScanClassVisitor cv = <span class="keyword">new</span> ScanClassVisitor(Opcodes.ASM5, cw)</span><br><span class="line">  cr.accept(cv, ClassReader.EXPAND_FRAMES)</span><br><span class="line">  inputStream.close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ScanClassVisitor</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line"></span><br><span class="line">  ScanClassVisitor(<span class="type">int</span> api, ClassVisitor cv) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(api, cv)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> visit(<span class="type">int</span> version, <span class="type">int</span> access, String name, String signature,</span><br><span class="line">             String superName, String[] interfaces) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.visit(version, access, name, signature, superName, interfaces)</span><br><span class="line">    RegisterTransform.registerList.each &#123; ext -&gt;</span><br><span class="line">      <span class="keyword">if</span> (ext.interfaceName &amp;&amp; interfaces != <span class="literal">null</span>) &#123;</span><br><span class="line">        interfaces.each &#123; itName -&gt;</span><br><span class="line">          <span class="keyword">if</span> (itName == ext.interfaceName) &#123;</span><br><span class="line">            <span class="comment">//fix repeated inject init code when Multi-channel packaging</span></span><br><span class="line">            <span class="keyword">if</span> (!ext.classList.contains(name)) &#123;</span><br><span class="line">              ext.classList.add(name)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里就又涉及到了ASM的知识，ScanClassVisitor是访问某个类的内部结构。</p>
<blockquote>
<p>version：类的版本；</p>
<p>access：表示类的访问权限，public，private，protected等；</p>
<p>name：类的名字；</p>
<p>signature：有无泛型；</p>
<p>superName：其父类；</p>
<p>interfaces：其实现的接口；</p>
</blockquote>
<p>在<em>ScanClassVisitor</em>中，并没有对类做修改，只是从遍历过的类中，把我们关心的类挑出来。那么，我们关心哪些类呢？</p>
<p>在<em>PluginLaunch</em>类中，我们注册了三个<em>ScanSettings</em>类，分别是<strong>IRouteRoot</strong>、<strong>IInterceptorGroup</strong>和<strong>IProviderGroup</strong>，也就是说，我们把实现了这三个接口的类，挑出来，加入到各自对应的ScanSettings类中记录起来。这三个接口是不是很熟悉？就是通过APT生成的用来记录路由路径表的类。</p>
<p>等收集好了这些记录的路径表信息后，就可以对<em>LogisticsCenter</em>通过ASM进行修改了。我们接着看<em>RegisterTransform#transform</em>方法中剩下的逻辑。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fileContainsInitClass) &#123;</span><br><span class="line">  registerList.each &#123; ext -&gt;</span><br><span class="line">    Logger.i(<span class="string">&#x27;Insert register code to file &#x27;</span> + fileContainsInitClass.absolutePath)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ext.classList.isEmpty()) &#123;</span><br><span class="line">      Logger.e(<span class="string">&quot;No class implements found for interface:&quot;</span> + ext.interfaceName)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ext.classList.each &#123;</span><br><span class="line">        Logger.i(it)</span><br><span class="line">      &#125;</span><br><span class="line">      RegisterCodeGenerator.insertInitCodeTo(ext)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意此处的insertInitCodeTo方法，这就是ASM修改的入口了。这里不对修改过程进行详细解释了。我们直接对比看<em>LogisticsCenter</em>修改前后关键代码的对比。</p>
<p>在<em>app&#x2F;build</em>目录下，找到生成的apk文件，通过AndroidStudio来查看其中的class，找到关键<em>LogisticsCenter</em>关键方法<em>loadRouterMap</em>。</p>
<blockquote>
<p>具体过程如下：</p>
<p>app&#x2F;build&#x2F;outputs&#x2F;apk&#x2F;debug&#x2F;app-debug.apk -&gt; classes.dex(双击) -&gt; 找到<em>LogisticsCenter#loadRouterMap</em>方法 -&gt; 右键: show Bytecode。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不使用apply plugin: &#x27;com.alibaba.arouter&#x27;</span></span><br><span class="line">.method <span class="keyword">private</span> <span class="keyword">static</span> <span class="title function_">loadRouterMap</span><span class="params">()</span>V</span><br><span class="line">    .registers <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    .line <span class="number">64</span></span><br><span class="line">    const/<span class="number">4</span> v0, <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">    sput-<span class="type">boolean</span> v0, Lcom/alibaba/android/arouter/core/LogisticsCenter;-&gt;registerByPlugin:Z</span><br><span class="line"></span><br><span class="line">    .line <span class="number">69</span></span><br><span class="line">    <span class="keyword">return</span>-<span class="keyword">void</span></span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用apply plugin: &#x27;com.alibaba.arouter&#x27;</span></span><br><span class="line">.method <span class="keyword">private</span> <span class="keyword">static</span> <span class="title function_">loadRouterMap</span><span class="params">()</span>V</span><br><span class="line">    .registers <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    .line <span class="number">64</span></span><br><span class="line">    const/<span class="number">4</span> v0, <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">    sput-<span class="type">boolean</span> v0, Lcom/alibaba/android/arouter/core/LogisticsCenter;-&gt;registerByPlugin:Z</span><br><span class="line"></span><br><span class="line">    .line <span class="number">69</span></span><br><span class="line">    const-string v0, <span class="string">&quot;com.alibaba.android.arouter.routes.ARouter$$Root$$modulejava&quot;</span></span><br><span class="line"></span><br><span class="line">    invoke-<span class="keyword">static</span> &#123;v0&#125;, Lcom/alibaba/android/arouter/core/LogisticsCenter;-&gt;register(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">    const-string v0, <span class="string">&quot;com.alibaba.android.arouter.routes.ARouter$$Root$$modulekotlin&quot;</span></span><br><span class="line"></span><br><span class="line">    invoke-<span class="keyword">static</span> &#123;v0&#125;, Lcom/alibaba/android/arouter/core/LogisticsCenter;-&gt;register(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">    const-string v0, <span class="string">&quot;com.alibaba.android.arouter.routes.ARouter$$Root$$arouterapi&quot;</span></span><br><span class="line"></span><br><span class="line">    invoke-<span class="keyword">static</span> &#123;v0&#125;, Lcom/alibaba/android/arouter/core/LogisticsCenter;-&gt;register(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">    const-string v0, <span class="string">&quot;com.alibaba.android.arouter.routes.ARouter$$Root$$app&quot;</span></span><br><span class="line"></span><br><span class="line">    invoke-<span class="keyword">static</span> &#123;v0&#125;, Lcom/alibaba/android/arouter/core/LogisticsCenter;-&gt;register(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">    const-string v0, <span class="string">&quot;com.alibaba.android.arouter.routes.ARouter$$Interceptors$$modulejava&quot;</span></span><br><span class="line"></span><br><span class="line">    invoke-<span class="keyword">static</span> &#123;v0&#125;, Lcom/alibaba/android/arouter/core/LogisticsCenter;-&gt;register(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">    const-string v0, <span class="string">&quot;com.alibaba.android.arouter.routes.ARouter$$Interceptors$$app&quot;</span></span><br><span class="line"></span><br><span class="line">    invoke-<span class="keyword">static</span> &#123;v0&#125;, Lcom/alibaba/android/arouter/core/LogisticsCenter;-&gt;register(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">    const-string v0, <span class="string">&quot;com.alibaba.android.arouter.routes.ARouter$$Providers$$modulejava&quot;</span></span><br><span class="line"></span><br><span class="line">    invoke-<span class="keyword">static</span> &#123;v0&#125;, Lcom/alibaba/android/arouter/core/LogisticsCenter;-&gt;register(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">    const-string v0, <span class="string">&quot;com.alibaba.android.arouter.routes.ARouter$$Providers$$modulekotlin&quot;</span></span><br><span class="line"></span><br><span class="line">    invoke-<span class="keyword">static</span> &#123;v0&#125;, Lcom/alibaba/android/arouter/core/LogisticsCenter;-&gt;register(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">    const-string v0, <span class="string">&quot;com.alibaba.android.arouter.routes.ARouter$$Providers$$arouterapi&quot;</span></span><br><span class="line"></span><br><span class="line">    invoke-<span class="keyword">static</span> &#123;v0&#125;, Lcom/alibaba/android/arouter/core/LogisticsCenter;-&gt;register(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">    const-string v0, <span class="string">&quot;com.alibaba.android.arouter.routes.ARouter$$Providers$$app&quot;</span></span><br><span class="line"></span><br><span class="line">    invoke-<span class="keyword">static</span> &#123;v0&#125;, Lcom/alibaba/android/arouter/core/LogisticsCenter;-&gt;register(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>-<span class="keyword">void</span></span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>

<p>对比发现，使用<code>apply plugin: &#39;com.alibaba.arouter&#39;</code>后，这个方法增加了很多代码，基本上就是在加载路由路径表。使用这个gradle插件的基本思想就是，将查找路由路径表的过程，从<strong>运行时</strong>提前到了<strong>编译时</strong>，这算是一种AOT(Ahead of time)思想。</p>
<p>将最耗时的查找过程提前，也就解决了ARouter初始化时间过长的问题。</p>
</p><div class="tip">本文采用CC-BY-SA-3.0协议，转载请注明出处<br>Author: boybeak</div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2020-11-28</span><a class="tag" href="/categories/源码分析/" title="源码分析">源码分析 </a><i class="fa fa-tag"></i><a class="tag" href="/tags/Android/" title="Android">Android </a><span class="leancloud_visitors"></span><span>About 3382 words, 11 min 16 sec  read</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/intent/tweet?text=I%20have%20found%20a%20great%20blog.%0A%0AHikingMan%20%C2%B7%20ARouter%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%0Ahttp://example.com/2020/11/28/2022-09-17-ARouter%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/%0A"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2020/12/13/2022-09-19-Apk%E7%98%A6%E8%BA%AB%E6%9C%AF/" title="Apk瘦身术">Previous</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2020/11/23/2022-09-19-ASM/" title="ASM库介绍与使用">Next</a></li></ul></div><script src="/js/visitors.js"></script><a id="comments"></a><div id="gitalk_container" style="padding:10px"></div><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>const gitalk = new Gitalk({
    clientID: '39e6af26be4db13bc1c2',
    clientSecret: '6958fae781c21e07373de773717a847710e3dc98',
    repo: 'blog-comments',      // The repository of store comments,
    owner: 'boybeak',
    admin: ['boybeak'],
    id: 'ARouter源码分析',      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
})
gitalk.render('gitalk_container')</script></div></div></div></div><script src="/js/darkLightToggle.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>