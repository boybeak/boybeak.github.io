<!DOCTYPE html><html lang="zh-CN" id="theme-dark-mode"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Yourname"><title>AMS启动流程 · Hexo</title><meta name="description" content="AMS是ActivityManagerService的简称，看名字，似乎是Activity的manager，实际上，它管理的可不只是Activity。
系统启动流程123456789graph TD;    style A fill:#fff    style F fill:#5befb9    Z"><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon-32x32.png"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/tags">Tags</a></li><li> <a href="/about">About</a></li><li> <a href="/links">Links</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-search" onclick="openWindow();"></a></li><li><a class="fa fa-sun-o" onclick="darkLightToggle();"></a></li></div><div class="avatar"><img src="/images/apple-touch-icon-300x300.jpg"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/logo@2x.webp" style="width:220px;" alt="favicon"><h3 title=""><a href="/">Hexo</a></h3><div class="description"><p>A simple and beautiful blog</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/Lhcfl"><i class="fa fa-github"></i></a></li><li><a href="mailto:yourname@example.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://zhihu.com/people/jin-xin-4-68"><i class="fa fa-mortar-board"></i></a></li></ul></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> Yourname</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><span>Anatolo </span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>AMS启动流程</a></h3></div><div class="post-content"><p><p>AMS是ActivityManagerService的简称，看名字，似乎是Activity的manager，实际上，它管理的可不只是Activity。</p>
<h2 id="系统启动流程"><a href="#系统启动流程" class="headerlink" title="系统启动流程"></a>系统启动流程</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">    style A fill:#fff</span><br><span class="line">    style F fill:#5befb9</span><br><span class="line">    Z&#123;&#123;Boot ROM&#125;&#125; --&gt; A([Boot Loader]);</span><br><span class="line">    A --&gt; B(Kernel);</span><br><span class="line">    B --&gt; C(&quot;init(pid=1)/C++ Framework Native&quot;);</span><br><span class="line">    C --&gt; D(Zygote/Android Runtime);</span><br><span class="line">    D --&gt; E(System Server/Java Framework);</span><br><span class="line">    E --&gt; F(Apps);</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>面试题：一个应用启动，为什么不从init进程或者SystemServer进程fork，而是从Zygote进程fork。</strong></p>
<p><em>Zygote作为一个孵化器，可以提前加载一些资源，这样fork时给予<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/48147304">Copy-on-Write</a>机制创建的其他进程能够直接利用这些资源，而不用重新加载。比如system_server就可以直接使用Zygote中的JNI函数、共享库、常用的类以及主题资源。</em></p>
<p><em>SystemServer相比Zygote多运行了AMS、WMS等服务，这些对于一个应用程序来说是不需要的，另外fork对多线程不友好，仅会将发起调用的线程拷贝到子进程，这可能会导致死锁，而SystemServer中肯定是有很多多线程的。</em></p>
<p><strong>如何导致死锁的？</strong></p>
<p>在POSIX标准中，fork行为是这样的：赋值整个用户空间的数据（通常使用copy-on-write的策略，所以可以实现速度很快）以及所有系统对象，然后仅复制当前线程到子进程。这里：所有父进程中别的线程，到了子进程都是突然蒸发掉的。</p>
<p>对于锁来说，从OS看，每个锁都有一个所有者，即最后依次lock它的线程。假设这样一个环境，在fork之前，有一个子线程lock了某个锁，获得了对锁的所有权，fork以后，在子进程中，所有的额外线程都人间蒸发了，而锁却被正常赋值了，在子进程看来，这个锁没有主人，所以没有任何人可以对它解锁，当子进程中的某个线程想lock这个锁时候，不再有任何手段可以解开了，程序发生死锁。</p>
</blockquote>
<h2 id="Zygote集成启动"><a href="#Zygote集成启动" class="headerlink" title="Zygote集成启动"></a>Zygote集成启动</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">    A[&quot;init.cpp - main()&quot;] --&gt; B[解析init.zygote.rc];</span><br><span class="line">    B --&gt; C[&quot;启动main类型服务 do_class_start()&quot;];</span><br><span class="line">    C --&gt; D[&quot;启动zygote服务 start()&quot;];</span><br><span class="line">    D --&gt; E[&quot;创建Zygote进程 fork()&quot;];</span><br><span class="line">    E --&gt; |execv|F[&quot;app_main.cpp - main()&quot;];</span><br></pre></td></tr></table></figure>



<h2 id="System-Server进程启动"><a href="#System-Server进程启动" class="headerlink" title="System Server进程启动"></a>System Server进程启动</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">    A[&quot;app_main.cpp - main()&quot;] --&gt; B[&quot;AndroidRuntime.start()&quot;];</span><br><span class="line">    B --&gt; C[&quot;startVM()&quot;];</span><br><span class="line">    C --&gt; D[&quot;startReg()&quot;];</span><br><span class="line">    D --&gt; E[&quot;ZygoteInit.main()&quot;];</span><br><span class="line">    E --&gt; F[&quot;registerZygoteSocket()&quot;];</span><br><span class="line">    F --&gt; G[&quot;preload&quot;];</span><br><span class="line">    G --&gt; H[&quot;startSystemServer&quot;];</span><br><span class="line">    H --&gt; I[&quot;runSelectLoop&quot;];</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/master/services/java/com/android/server/SystemServer.java">SystemServer.java</a></p>
<h2 id="AMS启动流程"><a href="#AMS启动流程" class="headerlink" title="AMS启动流程"></a>AMS启动流程</h2><p><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/base/+/master/services/core/java/com/android/server/am/ActivityManagerService.java">ActivityManagerService.java</a></p>
<p>在SystemServer的<code>startBootstrapServices</code>方法中，开始了AMS的启动。</p>
<h3 id="AMS启动过程中做了哪些事？"><a href="#AMS启动过程中做了哪些事？" class="headerlink" title="AMS启动过程中做了哪些事？"></a>AMS启动过程中做了哪些事？</h3><p>与<code>adb shell dumpsys</code>相关的一些process服务，比如<code>meminfo</code>、<code>gfxinfo</code>、<code>dbinfo</code>等，具体请参考<code>setSystemProcess</code>方法。</p>
<h2 id="Activity启动流程"><a href="#Activity启动流程" class="headerlink" title="Activity启动流程"></a>Activity启动流程</h2><p>ActivityStactSupervisor</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR;</span><br><span class="line">A[ActivityStactSupervisor] --&gt; B[mHomeStack];</span><br><span class="line">A --&gt; C[mFocusedStack];</span><br><span class="line">subgraph ActivityStack[&quot;ActivityStack&quot;]</span><br><span class="line">  subgraph TaskRecord</span><br><span class="line">    AR1[ActivityRecord]</span><br><span class="line">    AR2[ActivityRecord]</span><br><span class="line">    AR3[ActivityRecord]</span><br><span class="line">  end</span><br><span class="line">  subgraph TaskRecord2</span><br><span class="line">    AR4[ActivityRecord]</span><br><span class="line">    AR5[ActivityRecord]</span><br><span class="line">    AR6[ActivityRecord]</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line">B --&gt; ActivityStack;</span><br><span class="line">C --&gt; ActivityStack;</span><br></pre></td></tr></table></figure>

<p>Activity启动简图</p>
<blockquote>
<p>面试题：Zygote为什么不采用Binder机制进行IPC通信。</p>
<p>Binder机制中存在Binder线程池，是多线程的，如果Zygote采用Binder的话，就存在了上面说的fork多线程死锁问题了。其实严格来说，Binder机制不一定要多线程，所谓的Binder线程只不过是在循环读取Binder驱动消息而已，只注册一个Binder线程也是可以工作的，比如ServiceManager，实际上Zygote尽管没有采用Binder机制，它也不是单线程的，但它在fork前主动停止了其他线程，fork后重新启动了。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">  A([Launcher]) --&gt; B&#123;&quot;SystemServer - AMS&lt;br&gt;(app是否启动)&quot;&#125;;</span><br><span class="line">  B --&gt; |否, 请求创建app进程|C[Zygote];</span><br><span class="line">  B -.-&gt; |&quot;是, 1. ActivityManager.getService()&quot;|D(App):::app;</span><br><span class="line">  C --&gt;|fork| D</span><br><span class="line">  D --&gt;|&quot;2. mgr.attachApplication(mAppThread, startSeq)&quot;| B;</span><br><span class="line">	classDef app fill:#5befb9</span><br></pre></td></tr></table></figure>

<p>Activity启动细节图</p>
<p><strong>Launcher到AMS阶段</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">	participant A as Launcher</span><br><span class="line">	participant B as Activity</span><br><span class="line">	participant C as Instrumentation</span><br><span class="line">	participant D as IActivityManager</span><br><span class="line">	participant E as AMS</span><br><span class="line">	</span><br><span class="line">	A -&gt;&gt; B: startActivity</span><br><span class="line">	B --&gt; B: startActivityForResult</span><br><span class="line">	B -&gt;&gt; C: execStartActivity</span><br><span class="line">	C -&gt;&gt; D: startActivity</span><br><span class="line">	D -&gt;&gt; E: startActivity</span><br></pre></td></tr></table></figure>

<p><strong>AMS到ApplicationThread阶段</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">	participant A as AMS</span><br><span class="line">	participant B as ActivityStart</span><br><span class="line">	participant C as ActivityStackSupervisor</span><br><span class="line">	participant D as ActivityStack</span><br><span class="line">	participant E as ApplicationThread</span><br><span class="line">	A -&gt;&gt; A: startActivityStarter</span><br><span class="line">	A -&gt;&gt; B: startActivityMyWait</span><br><span class="line">	B -&gt;&gt; B: startActivityLocked</span><br><span class="line">	B -&gt;&gt; B: startActivity</span><br><span class="line">	B -&gt;&gt; B: startActivityUnchecked</span><br><span class="line">	B -&gt;&gt; C: startSpecificActivityLocked</span><br></pre></td></tr></table></figure>

<p><strong>ApplicationThread到Activity</strong></p>
</p><div class="tip">本文采用CC-BY-SA-3.0协议，转载请注明出处<br>Author: boybeak</div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2020-10-21</span><a class="tag" href="/categories/Android技巧/" title="Android技巧">Android技巧 </a><i class="fa fa-tag"></i><a class="tag" href="/tags/Android/" title="Android">Android </a><span class="leancloud_visitors"></span><span>About 1162 words, 3 min 52 sec  read</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/intent/tweet?text=I%20have%20found%20a%20great%20blog.%0A%0AHexo%20%C2%B7%20AMS%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%0Ahttp://example.com/2020/10/21/2022-09-19-AMS%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/%0A"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2020/10/22/2022-09-19-Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" title="Activity启动流程">Previous</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2020/10/21/2022-09-19-App%E4%BF%9D%E6%B4%BB%E6%9C%AF/" title="App保活术">Next</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/darkLightToggle.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>