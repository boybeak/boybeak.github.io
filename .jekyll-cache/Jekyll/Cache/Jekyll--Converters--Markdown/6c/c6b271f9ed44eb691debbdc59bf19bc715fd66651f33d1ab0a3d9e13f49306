I"”É<h1 id="asmåº“ä»‹ç»ä¸ä½¿ç”¨">ASMåº“ä»‹ç»ä¸ä½¿ç”¨</h1>

<blockquote>
  <p><a href="https://www.jianshu.com/p/905be2a9a700">åŸæ–‡</a></p>
</blockquote>

<p>å‰é¢å‡ ç¯‡æ–‡ç« ä»‹ç»äº† .class æ–‡ä»¶çš„ç»“æ„ã€JVM å¦‚ä½•åŠ è½½ .class æ–‡ä»¶ã€JVM ä¸­å¦‚ä½•æ‰§è¡Œæ–¹æ³•çš„è°ƒç”¨å’Œè®¿é—®è€…æ¨¡å¼ï¼Œå…¶å®å‰é¢å‡ ç¯‡æ–‡ç« éƒ½æ˜¯ä¸ºè¿™ç¯‡æ–‡ç« åšé“ºå«çš„ï¼Œå¦‚æœä¸çŸ¥é“ .class æ–‡ä»¶ç»“æ„ã€ä¹Ÿä¸çŸ¥é“åœ¨ JVM ä¸­ .class æ–‡ä»¶ä¸­çš„æ–¹æ³•æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ï¼Œè¿™ç¯‡æ–‡ç« ä¸­çš„æœ‰äº›éƒ¨åˆ†å¯èƒ½ä¼šçœ‹ä¸æ‡‚ï¼Œæ‰€ä»¥æ¨èå…ˆçœ‹ä¸‹å‰é¢å‡ ç¯‡æ–‡ç« ã€‚
 è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç» ASM åº“çš„ç»“æ„ã€ä¸»è¦çš„ APIï¼Œå¹¶ä¸”é€šè¿‡ä¸¤ä¸ªç¤ºä¾‹è¯´æ˜å¦‚ä½•é€šè¿‡ ASM ä¿®æ”¹ .class æ–‡ä»¶ä¸­çš„æ–¹æ³•å’Œå±æ€§ã€‚</p>

<p><img src="/assets/images/ezgif-6-73b502b11e16.jpg" alt="img" /></p>

<p>catalog.png</p>

<h3 id="ä¸€-asm-çš„ç»“æ„">ä¸€. ASM çš„ç»“æ„</h3>

<p>ASM åº“æ˜¯ä¸€æ¬¾åŸºäº Java å­—èŠ‚ç å±‚é¢çš„ä»£ç åˆ†æå’Œä¿®æ”¹å·¥å…·ã€‚ASM å¯ä»¥ç›´æ¥ç”Ÿäº§äºŒè¿›åˆ¶çš„ class æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åœ¨ç±»è¢«åŠ è½½å…¥ JVM ä¹‹å‰åŠ¨æ€ä¿®æ”¹ç±»è¡Œä¸ºã€‚
 ASM åº“çš„ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<table>
  <tbody>
    <tr>
      <td>![img](https://upload-images.jianshu.io/upload_images/4179925-d4f950ec94a12cde.png?imageMogr2/auto-orient/strip</td>
      <td>imageView2/2/w/820/format/webp)</td>
    </tr>
  </tbody>
</table>

<p>asm_arch.png</p>

<ul>
  <li>Coreï¼šä¸ºå…¶ä»–åŒ…æä¾›åŸºç¡€çš„è¯»ã€å†™ã€è½¬åŒ–Javaå­—èŠ‚ç å’Œå®šä¹‰çš„APIï¼Œå¹¶ä¸”å¯ä»¥ç”ŸæˆJavaå­—èŠ‚ç å’Œå®ç°å¤§éƒ¨åˆ†å­—èŠ‚ç çš„è½¬æ¢ï¼Œåœ¨ <a href="https://www.jianshu.com/p/e4b8cb0b3204">è®¿é—®è€…æ¨¡å¼å’Œ ASM</a> ä¸­ä»‹ç»çš„å‡ ä¸ªé‡è¦çš„ç±»å°±åœ¨ Core API ä¸­ï¼šClassReaderã€ClassVisitor å’Œ ClassWriter ç±».</li>
  <li>Treeï¼šæä¾›äº† Java å­—èŠ‚ç åœ¨å†…å­˜ä¸­çš„è¡¨ç°</li>
  <li>Commonsï¼šæä¾›äº†ä¸€äº›å¸¸ç”¨çš„ç®€åŒ–å­—èŠ‚ç ç”Ÿæˆã€è½¬æ¢çš„ç±»å’Œé€‚é…å™¨</li>
  <li>Utilï¼šåŒ…å«ä¸€äº›å¸®åŠ©ç±»å’Œç®€å•çš„å­—èŠ‚ç ä¿®æ”¹ç±»ï¼Œæœ‰åˆ©äºåœ¨å¼€å‘æˆ–è€…æµ‹è¯•ä¸­ä½¿ç”¨</li>
  <li>XMLï¼šæä¾›ä¸€ä¸ªé€‚é…å™¨å°†XMLå’ŒSAX-comliantè½¬åŒ–æˆå­—èŠ‚ç ç»“æ„ï¼Œå¯ä»¥å…è®¸ä½¿ç”¨XSLTå»å®šä¹‰å­—èŠ‚ç è½¬åŒ–</li>
</ul>

<h3 id="äºŒ-core-api-ä»‹ç»">äºŒ. Core API ä»‹ç»</h3>

<h4 id="21-classvisitor-æŠ½è±¡ç±»">2.1 ClassVisitor æŠ½è±¡ç±»</h4>

<table>
  <tbody>
    <tr>
      <td>å¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨ ClassVisitor ä¸­æä¾›äº†å’Œç±»ç»“æ„åŒåçš„ä¸€äº›æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¼šå¯¹ç±»ä¸­ç›¸åº”çš„éƒ¨åˆ†è¿›è¡Œæ“ä½œï¼Œè€Œä¸”æ˜¯æœ‰é¡ºåºçš„ï¼švisit [ visitSource ] [ visitOuterClass ] ( visitAnnotation</td>
      <td>visitAttribute )* (visitInnerClass</td>
      <td>visitField</td>
      <td>visitMethod )* visitEnd</td>
    </tr>
  </tbody>
</table>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ClassVisitor</span> <span class="o">{</span>

        <span class="o">......</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visit</span><span class="o">(</span><span class="kt">int</span> <span class="n">version</span><span class="o">,</span> <span class="kt">int</span> <span class="n">access</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">signature</span><span class="o">,</span> <span class="nc">String</span> <span class="n">superName</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">interfaces</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitSource</span><span class="o">(</span><span class="nc">String</span> <span class="n">source</span><span class="o">,</span> <span class="nc">String</span> <span class="n">debug</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitOuterClass</span><span class="o">(</span><span class="nc">String</span> <span class="n">owner</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">desc</span><span class="o">);</span>
    <span class="kd">public</span> <span class="nc">AnnotationVisitor</span> <span class="nf">visitAnnotation</span><span class="o">(</span><span class="nc">String</span> <span class="n">desc</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">visible</span><span class="o">);</span>
    <span class="kd">public</span> <span class="nc">AnnotationVisitor</span> <span class="nf">visitTypeAnnotation</span><span class="o">(</span><span class="kt">int</span> <span class="n">typeRef</span><span class="o">,</span> <span class="nc">TypePath</span> <span class="n">typePath</span><span class="o">,</span> <span class="nc">String</span> <span class="n">desc</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">visible</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitAttribute</span><span class="o">(</span><span class="nc">Attribute</span> <span class="n">attr</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitInnerClass</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">outerName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">innerName</span><span class="o">,</span> <span class="kt">int</span> <span class="n">access</span><span class="o">);</span>
    <span class="kd">public</span> <span class="nc">FieldVisitor</span> <span class="nf">visitField</span><span class="o">(</span><span class="kt">int</span> <span class="n">access</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">desc</span><span class="o">,</span> <span class="nc">String</span> <span class="n">signature</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">value</span><span class="o">);</span>
    <span class="kd">public</span> <span class="nc">MethodVisitor</span> <span class="nf">visitMethod</span><span class="o">(</span><span class="kt">int</span> <span class="n">access</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">desc</span><span class="o">,</span> <span class="nc">String</span> <span class="n">signature</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">exceptions</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitEnd</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>void visit(int version, int access, String name, String signature, String superName, String[] interfaces)
 è¯¥æ–¹æ³•æ˜¯å½“æ‰«æç±»æ—¶ç¬¬ä¸€ä¸ªè°ƒç”¨çš„æ–¹æ³•ï¼Œä¸»è¦ç”¨äºç±»å£°æ˜ä½¿ç”¨ã€‚ä¸‹é¢æ˜¯å¯¹æ–¹æ³•ä¸­å„ä¸ªå‚æ•°çš„ç¤ºæ„ï¼švisit( ç±»ç‰ˆæœ¬ , ä¿®é¥°ç¬¦ , ç±»å , æ³›å‹ä¿¡æ¯ , ç»§æ‰¿çš„çˆ¶ç±» , å®ç°çš„æ¥å£)</li>
  <li>AnnotationVisitor visitAnnotation(String desc, boolean visible)
 è¯¥æ–¹æ³•æ˜¯å½“æ‰«æå™¨æ‰«æåˆ°ç±»æ³¨è§£å£°æ˜æ—¶è¿›è¡Œè°ƒç”¨ã€‚ä¸‹é¢æ˜¯å¯¹æ–¹æ³•ä¸­å„ä¸ªå‚æ•°çš„ç¤ºæ„ï¼švisitAnnotation(æ³¨è§£ç±»å‹ , æ³¨è§£æ˜¯å¦å¯ä»¥åœ¨ JVM ä¸­å¯è§)ã€‚</li>
  <li>FieldVisitor visitField(int access, String name, String desc, String signature, Object value)
 è¯¥æ–¹æ³•æ˜¯å½“æ‰«æå™¨æ‰«æåˆ°ç±»ä¸­å­—æ®µæ—¶è¿›è¡Œè°ƒç”¨ã€‚ä¸‹é¢æ˜¯å¯¹æ–¹æ³•ä¸­å„ä¸ªå‚æ•°çš„ç¤ºæ„ï¼švisitField(ä¿®é¥°ç¬¦ , å­—æ®µå , å­—æ®µç±»å‹ , æ³›å‹æè¿° , é»˜è®¤å€¼)</li>
  <li>MethodVisitor visitMethod(int access, String name, String desc, String signature, String[] exceptions)
 è¯¥æ–¹æ³•æ˜¯å½“æ‰«æå™¨æ‰«æåˆ°ç±»çš„æ–¹æ³•æ—¶è¿›è¡Œè°ƒç”¨ã€‚ä¸‹é¢æ˜¯å¯¹æ–¹æ³•ä¸­å„ä¸ªå‚æ•°çš„ç¤ºæ„ï¼švisitMethod(ä¿®é¥°ç¬¦ , æ–¹æ³•å , æ–¹æ³•ç­¾å , æ³›å‹ä¿¡æ¯ , æŠ›å‡ºçš„å¼‚å¸¸)</li>
  <li>void visitEnd()
 è¯¥æ–¹æ³•æ˜¯å½“æ‰«æå™¨å®Œæˆç±»æ‰«ææ—¶æ‰ä¼šè°ƒç”¨ï¼Œå¦‚æœæƒ³åœ¨ç±»ä¸­è¿½åŠ æŸäº›æ–¹æ³•</li>
</ol>

<h4 id="22-classreader-ç±»">2.2 ClassReader ç±»</h4>

<p>è¿™ä¸ªç±»ä¼šå°† .class æ–‡ä»¶è¯»å…¥åˆ° ClassReader ä¸­çš„å­—èŠ‚æ•°ç»„ä¸­ï¼Œå®ƒçš„ accept æ–¹æ³•æ¥å—ä¸€ä¸ª ClassVisitor å®ç°ç±»ï¼Œå¹¶æŒ‰ç…§é¡ºåºè°ƒç”¨ ClassVisitor ä¸­çš„æ–¹æ³•</p>

<h4 id="23-classwriter-ç±»">2.3 ClassWriter ç±»</h4>

<p>ClassWriter æ˜¯ä¸€ä¸ª ClassVisitor çš„å­ç±»ï¼Œæ˜¯å’Œ ClassReader å¯¹åº”çš„ç±»ï¼ŒClassReader æ˜¯å°† .class æ–‡ä»¶è¯»å…¥åˆ°ä¸€ä¸ªå­—èŠ‚æ•°ç»„ä¸­ï¼ŒClassWriter æ˜¯å°†ä¿®æ”¹åçš„ç±»çš„å­—èŠ‚ç å†…å®¹ä»¥å­—èŠ‚æ•°ç»„çš„å½¢å¼è¾“å‡ºã€‚</p>

<h4 id="24-methodvisitor--adviceadapter">2.4 MethodVisitor &amp; AdviceAdapter</h4>

<p>MethodVisitor æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå½“ ASM çš„ ClassReader è¯»å–åˆ° Method æ—¶å°±è½¬å…¥ MethodVisitor æ¥å£å¤„ç†ã€‚
 AdviceAdapter æ˜¯ MethodVisitor çš„å­ç±»ï¼Œä½¿ç”¨ AdviceAdapter å¯ä»¥æ›´æ–¹ä¾¿çš„ä¿®æ”¹æ–¹æ³•çš„å­—èŠ‚ç ã€‚
 AdviceAdapter çš„æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<table>
  <tbody>
    <tr>
      <td>![img](https:////upload-images.jianshu.io/upload_images/4179925-f5a428b729962860.png?imageMogr2/auto-orient/strip</td>
      <td>imageView2/2/w/1160/format/webp)</td>
    </tr>
  </tbody>
</table>

<p>AdviceAdapter.png</p>

<p>å…¶ä¸­æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªæ–¹æ³•å¦‚ä¸‹ï¼š</p>

<ol>
  <li>void visitCode()ï¼šè¡¨ç¤º ASM å¼€å§‹æ‰«æè¿™ä¸ªæ–¹æ³•</li>
  <li>void onMethodEnter()ï¼šè¿›å…¥è¿™ä¸ªæ–¹æ³•</li>
  <li>void onMethodExit()ï¼šå³å°†ä»è¿™ä¸ªæ–¹æ³•å‡ºå»</li>
  <li>void onVisitEnd()ï¼šè¡¨ç¤ºæ–¹æ³•æ‰«ç å®Œæ¯•</li>
</ol>

<h4 id="25-fieldvisitor-æŠ½è±¡ç±»">2.5 FieldVisitor æŠ½è±¡ç±»</h4>

<p>FieldVisitor æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå½“ ASM çš„ ClassReader è¯»å–åˆ° Field æ—¶å°±è½¬å…¥ FieldVisitor æ¥å£å¤„ç†ã€‚å’Œåˆ†æ MethodVisitor çš„æ–¹æ³•ä¸€æ ·ï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹æºç æ³¨é‡Šè¿›è¡Œå­¦ä¹ ï¼Œè¿™é‡Œä¸å†è¯¦ç»†ä»‹ç»</p>

<h4 id="26-æ“ä½œæµç¨‹">2.6 æ“ä½œæµç¨‹</h4>

<ol>
  <li>éœ€è¦åˆ›å»ºä¸€ä¸ª ClassReader å¯¹è±¡ï¼Œå°† .class æ–‡ä»¶çš„å†…å®¹è¯»å…¥åˆ°ä¸€ä¸ªå­—èŠ‚æ•°ç»„ä¸­</li>
  <li>ç„¶åéœ€è¦ä¸€ä¸ª ClassWriter çš„å¯¹è±¡å°†æ“ä½œä¹‹åçš„å­—èŠ‚ç çš„å­—èŠ‚æ•°ç»„å›å†™</li>
  <li>éœ€è¦äº‹ä»¶è¿‡æ»¤å™¨ ClassVisitorã€‚åœ¨è°ƒç”¨ ClassVisitor çš„æŸäº›æ–¹æ³•æ—¶ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ XXXVisitor å¯¹è±¡ï¼Œå½“æˆ‘ä»¬éœ€è¦ä¿®æ”¹å¯¹åº”çš„å†…å®¹æ—¶åªè¦å®ç°è‡ªå·±çš„ XXXVisitor å¹¶è¿”å›å°±å¯ä»¥äº†</li>
</ol>

<h3 id="ä¸‰-ç¤ºä¾‹">ä¸‰. ç¤ºä¾‹</h3>

<h4 id="31-ä¿®æ”¹ç±»ä¸­æ–¹æ³•çš„å­—èŠ‚ç ">3.1 ä¿®æ”¹ç±»ä¸­æ–¹æ³•çš„å­—èŠ‚ç </h4>

<p>å‡å¦‚ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ª HelloWorld ç±»ï¼Œå¦‚ä¸‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.lijiankun24.asmpractice.demo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorld</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sayHello</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>é€šè¿‡ <code class="language-plaintext highlighter-rouge">javac HelloWorld.java</code> å’Œ <code class="language-plaintext highlighter-rouge">javap -verbose HelloWorld.class</code> å¯ä»¥æŸ¥çœ‹åˆ° sayName() æ–¹æ³•çš„å­—èŠ‚ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">public</span> <span class="kt">void</span> <span class="nf">sayHello</span><span class="p">();</span>
    <span class="n">descriptor</span><span class="o">:</span> <span class="p">()</span><span class="n">V</span>
    <span class="n">flags</span><span class="o">:</span> <span class="n">ACC_PUBLIC</span>
    <span class="n">Code</span><span class="o">:</span>
      <span class="n">stack</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">locals</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">args_size</span><span class="o">=</span><span class="mi">1</span>
         <span class="mi">0</span><span class="o">:</span> <span class="n">ldc2_w</span>        <span class="err">#</span><span class="mi">2</span>                  <span class="c1">// long 2000l</span>
         <span class="mi">3</span><span class="o">:</span> <span class="n">invokestatic</span>  <span class="err">#</span><span class="mi">4</span>                  <span class="c1">// Method java/lang/Thread.sleep:(J)V</span>
         <span class="mi">6</span><span class="o">:</span> <span class="k">goto</span>          <span class="mi">14</span>
         <span class="mi">9</span><span class="o">:</span> <span class="n">astore_1</span>
        <span class="mi">10</span><span class="o">:</span> <span class="n">aload_1</span>
        <span class="mi">11</span><span class="o">:</span> <span class="n">invokevirtual</span> <span class="err">#</span><span class="mi">6</span>                  <span class="c1">// Method java/lang/InterruptedException.printStackTrace:()V</span>
        <span class="mi">14</span><span class="o">:</span> <span class="k">return</span>
      <span class="n">Exception</span> <span class="n">table</span><span class="o">:</span>
         <span class="n">from</span>    <span class="n">to</span>  <span class="n">target</span> <span class="n">type</span>
             <span class="mi">0</span>     <span class="mi">6</span>     <span class="mi">9</span>   <span class="n">Class</span> <span class="n">java</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">InterruptedException</span>
      <span class="n">LineNumberTable</span><span class="o">:</span>
        <span class="n">line</span> <span class="mi">5</span><span class="o">:</span> <span class="mi">0</span>
        <span class="n">line</span> <span class="mi">8</span><span class="o">:</span> <span class="mi">6</span>
        <span class="n">line</span> <span class="mi">6</span><span class="o">:</span> <span class="mi">9</span>
        <span class="n">line</span> <span class="mi">7</span><span class="o">:</span> <span class="mi">10</span>
        <span class="n">line</span> <span class="mi">9</span><span class="o">:</span> <span class="mi">14</span>
      <span class="n">StackMapTable</span><span class="o">:</span> <span class="n">number_of_entries</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">frame_type</span> <span class="o">=</span> <span class="mi">73</span> <span class="cm">/* same_locals_1_stack_item */</span>
          <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span> <span class="k">class</span> <span class="nc">java</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">InterruptedException</span> <span class="p">]</span>
        <span class="n">frame_type</span> <span class="o">=</span> <span class="mi">4</span> <span class="cm">/* same */</span>
</code></pre></div></div>

<p>æˆ‘ä»¬é€šè¿‡ ASM ä¿®æ”¹ HelloWorld.class å­—èŠ‚ç æ–‡ä»¶ï¼Œå®ç°ç»Ÿè®¡æ–¹æ³•æ‰§è¡Œæ—¶é—´çš„åŠŸèƒ½</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CostTime</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">redefinePersonClass</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">redefinePersonClass</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">className</span> <span class="o">=</span> <span class="s">"com.lijiankun24.asmpractice.demo.HelloWorld"</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="s">"/Users/lijiankun/Desktop/HelloWorld.class"</span><span class="o">);</span>
            <span class="nc">ClassReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassReader</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>                               <span class="c1">// 1. åˆ›å»º ClassReader è¯»å…¥ .class æ–‡ä»¶åˆ°å†…å­˜ä¸­</span>
            <span class="nc">ClassWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassWriter</span><span class="o">(</span><span class="n">reader</span><span class="o">,</span> <span class="nc">ClassWriter</span><span class="o">.</span><span class="na">COMPUTE_MAXS</span><span class="o">);</span>                 <span class="c1">// 2. åˆ›å»º ClassWriter å¯¹è±¡ï¼Œå°†æ“ä½œä¹‹åçš„å­—èŠ‚ç çš„å­—èŠ‚æ•°ç»„å›å†™</span>
            <span class="nc">ClassVisitor</span> <span class="n">change</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ChangeVisitor</span><span class="o">(</span><span class="n">writer</span><span class="o">);</span>                                        <span class="c1">// 3. åˆ›å»ºè‡ªå®šä¹‰çš„ ClassVisitor å¯¹è±¡</span>
            <span class="n">reader</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">change</span><span class="o">,</span> <span class="nc">ClassReader</span><span class="o">.</span><span class="na">EXPAND_FRAMES</span><span class="o">);</span>                                       <span class="c1">// 4. å°† ClassVisitor å¯¹è±¡ä¼ å…¥ ClassReader ä¸­</span>

            <span class="nc">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyClassLoader</span><span class="o">().</span><span class="na">defineClass</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="n">writer</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
            <span class="nc">Object</span> <span class="n">personObj</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
            <span class="nc">Method</span> <span class="n">nameMethod</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"sayHello"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="n">nameMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">personObj</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Success!"</span><span class="o">);</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">code</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>                                                               <span class="c1">// è·å–ä¿®æ”¹åçš„ class æ–‡ä»¶å¯¹åº”çš„å­—èŠ‚æ•°ç»„</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="s">"/Users/lijiankun/Desktop/HelloWorld2.class"</span><span class="o">);</span>    <span class="c1">// å°†äºŒè¿›åˆ¶æµå†™åˆ°æœ¬åœ°ç£ç›˜ä¸Š</span>
                <span class="n">fos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">code</span><span class="o">);</span>
                <span class="n">fos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Failure!"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ChangeVisitor</span> <span class="kd">extends</span> <span class="nc">ClassVisitor</span> <span class="o">{</span>

        <span class="nc">ChangeVisitor</span><span class="o">(</span><span class="nc">ClassVisitor</span> <span class="n">classVisitor</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="nc">Opcodes</span><span class="o">.</span><span class="na">ASM5</span><span class="o">,</span> <span class="n">classVisitor</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">MethodVisitor</span> <span class="nf">visitMethod</span><span class="o">(</span><span class="kt">int</span> <span class="n">access</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">desc</span><span class="o">,</span> <span class="nc">String</span> <span class="n">signature</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">exceptions</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">MethodVisitor</span> <span class="n">methodVisitor</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">visitMethod</span><span class="o">(</span><span class="n">access</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">desc</span><span class="o">,</span> <span class="n">signature</span><span class="o">,</span> <span class="n">exceptions</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"&lt;init&gt;"</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">methodVisitor</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">ChangeAdapter</span><span class="o">(</span><span class="nc">Opcodes</span><span class="o">.</span><span class="na">ASM4</span><span class="o">,</span> <span class="n">methodVisitor</span><span class="o">,</span> <span class="n">access</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">desc</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ChangeAdapter</span> <span class="kd">extends</span> <span class="nc">AdviceAdapter</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">startTimeId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>

        <span class="kd">private</span> <span class="nc">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="nc">ChangeAdapter</span><span class="o">(</span><span class="kt">int</span> <span class="n">api</span><span class="o">,</span> <span class="nc">MethodVisitor</span> <span class="n">mv</span><span class="o">,</span> <span class="kt">int</span> <span class="n">access</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">desc</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">api</span><span class="o">,</span> <span class="n">mv</span><span class="o">,</span> <span class="n">access</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">desc</span><span class="o">);</span>
            <span class="n">methodName</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onMethodEnter</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">onMethodEnter</span><span class="o">();</span>
            <span class="n">startTimeId</span> <span class="o">=</span> <span class="n">newLocal</span><span class="o">(</span><span class="nc">Type</span><span class="o">.</span><span class="na">LONG_TYPE</span><span class="o">);</span>
            <span class="n">mv</span><span class="o">.</span><span class="na">visitMethodInsn</span><span class="o">(</span><span class="no">INVOKESTATIC</span><span class="o">,</span> <span class="s">"java/lang/System"</span><span class="o">,</span> <span class="s">"currentTimeMillis"</span><span class="o">,</span> <span class="s">"()J"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="n">mv</span><span class="o">.</span><span class="na">visitIntInsn</span><span class="o">(</span><span class="no">LSTORE</span><span class="o">,</span> <span class="n">startTimeId</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onMethodExit</span><span class="o">(</span><span class="kt">int</span> <span class="n">opcode</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">onMethodExit</span><span class="o">(</span><span class="n">opcode</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">durationId</span> <span class="o">=</span> <span class="n">newLocal</span><span class="o">(</span><span class="nc">Type</span><span class="o">.</span><span class="na">LONG_TYPE</span><span class="o">);</span>
            <span class="n">mv</span><span class="o">.</span><span class="na">visitMethodInsn</span><span class="o">(</span><span class="no">INVOKESTATIC</span><span class="o">,</span> <span class="s">"java/lang/System"</span><span class="o">,</span> <span class="s">"currentTimeMillis"</span><span class="o">,</span> <span class="s">"()J"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="n">mv</span><span class="o">.</span><span class="na">visitVarInsn</span><span class="o">(</span><span class="no">LLOAD</span><span class="o">,</span> <span class="n">startTimeId</span><span class="o">);</span>
            <span class="n">mv</span><span class="o">.</span><span class="na">visitInsn</span><span class="o">(</span><span class="no">LSUB</span><span class="o">);</span>
            <span class="n">mv</span><span class="o">.</span><span class="na">visitVarInsn</span><span class="o">(</span><span class="no">LSTORE</span><span class="o">,</span> <span class="n">durationId</span><span class="o">);</span>
            <span class="n">mv</span><span class="o">.</span><span class="na">visitFieldInsn</span><span class="o">(</span><span class="no">GETSTATIC</span><span class="o">,</span> <span class="s">"java/lang/System"</span><span class="o">,</span> <span class="s">"out"</span><span class="o">,</span> <span class="s">"Ljava/io/PrintStream;"</span><span class="o">);</span>
            <span class="n">mv</span><span class="o">.</span><span class="na">visitTypeInsn</span><span class="o">(</span><span class="no">NEW</span><span class="o">,</span> <span class="s">"java/lang/StringBuilder"</span><span class="o">);</span>
            <span class="n">mv</span><span class="o">.</span><span class="na">visitInsn</span><span class="o">(</span><span class="no">DUP</span><span class="o">);</span>
            <span class="n">mv</span><span class="o">.</span><span class="na">visitMethodInsn</span><span class="o">(</span><span class="no">INVOKESPECIAL</span><span class="o">,</span> <span class="s">"java/lang/StringBuilder"</span><span class="o">,</span> <span class="s">"&lt;init&gt;"</span><span class="o">,</span> <span class="s">"()V"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="n">mv</span><span class="o">.</span><span class="na">visitLdcInsn</span><span class="o">(</span><span class="s">"The cost time of "</span> <span class="o">+</span> <span class="n">methodName</span> <span class="o">+</span> <span class="s">" is "</span><span class="o">);</span>
            <span class="n">mv</span><span class="o">.</span><span class="na">visitMethodInsn</span><span class="o">(</span><span class="no">INVOKEVIRTUAL</span><span class="o">,</span> <span class="s">"java/lang/StringBuilder"</span><span class="o">,</span> <span class="s">"append"</span><span class="o">,</span> <span class="s">"(Ljava/lang/String;)Ljava/lang/StringBuilder;"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="n">mv</span><span class="o">.</span><span class="na">visitVarInsn</span><span class="o">(</span><span class="no">LLOAD</span><span class="o">,</span> <span class="n">durationId</span><span class="o">);</span>
            <span class="n">mv</span><span class="o">.</span><span class="na">visitMethodInsn</span><span class="o">(</span><span class="no">INVOKEVIRTUAL</span><span class="o">,</span> <span class="s">"java/lang/StringBuilder"</span><span class="o">,</span> <span class="s">"append"</span><span class="o">,</span> <span class="s">"(J)Ljava/lang/StringBuilder;"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="n">mv</span><span class="o">.</span><span class="na">visitMethodInsn</span><span class="o">(</span><span class="no">INVOKEVIRTUAL</span><span class="o">,</span> <span class="s">"java/lang/StringBuilder"</span><span class="o">,</span> <span class="s">"toString"</span><span class="o">,</span> <span class="s">"()Ljava/lang/String;"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="n">mv</span><span class="o">.</span><span class="na">visitMethodInsn</span><span class="o">(</span><span class="no">INVOKEVIRTUAL</span><span class="o">,</span> <span class="s">"java/io/PrintStream"</span><span class="o">,</span> <span class="s">"println"</span><span class="o">,</span> <span class="s">"(Ljava/lang/String;)V"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æ‰§è¡Œç»“æœå¦‚ä¸‹å›¾æ‰€ç¤º</p>

<table>
  <tbody>
    <tr>
      <td>![img](https:////upload-images.jianshu.io/upload_images/4179925-32ee7bd0974a4679.png?imageMogr2/auto-orient/strip</td>
      <td>imageView2/2/w/1200/format/webp)</td>
    </tr>
  </tbody>
</table>

<p>Class.png</p>

<p>åç¼–è¯‘ HelloWorld2.class æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤º</p>

<table>
  <tbody>
    <tr>
      <td>![img](https:////upload-images.jianshu.io/upload_images/4179925-af582100631d7eec.png?imageMogr2/auto-orient/strip</td>
      <td>imageView2/2/w/1200/format/webp)</td>
    </tr>
  </tbody>
</table>

<p>Class1.png</p>

<h4 id="32-ä¿®æ”¹ç±»ä¸­å±æ€§çš„å­—èŠ‚ç ">3.2 ä¿®æ”¹ç±»ä¸­å±æ€§çš„å­—èŠ‚ç </h4>

<p>è¿™ä¸€èŠ‚ä¸­æˆ‘ä»¬å°†å±•ç¤ºä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ Core API å¯¹ç±»ä¸­çš„å±æ€§è¿›è¡Œæ“ä½œã€‚</p>

<p>å‡å¦‚è¯´ï¼Œç°åœ¨æœ‰ä¸€ä¸ª Person.java ç±»å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">sex</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬æƒ³ä¸ºè¿™ä¸ªç±»ï¼Œæ·»åŠ ä¸€ä¸ª â€˜public int ageâ€™ çš„å±æ€§è¯¥æ€ä¹ˆæ·»åŠ å‘¢ï¼Ÿæˆ‘ä»¬ä¼šé¢å¯¹ä¸¤ä¸ªé—®é¢˜ï¼š</p>

<ol>
  <li>è¯¥è°ƒç”¨ ASM çš„å“ªä¸ª API æ·»åŠ å±æ€§å‘¢ï¼Ÿ</li>
  <li>åœ¨ä½•æ—¶å†™æ·»åŠ å±æ€§çš„ä»£ç ï¼Ÿ</li>
</ol>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä¸€ä¸€è§£å†³ä¸Šé¢çš„ä¸¤ä¸ªé—®é¢˜ï¼Ÿ</p>

<h5 id="321-æ·»åŠ å±æ€§çš„-api">3.2.1 æ·»åŠ å±æ€§çš„ API</h5>

<p>æŒ‰ç…§æˆ‘ä»¬åˆ†æçš„ä¸Šè¿°çš„ 2.6 æ“ä½œæµç¨‹å™è¿°ï¼Œéœ€è¦ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š</p>

<ol>
  <li>éœ€è¦åˆ›å»ºä¸€ä¸ª ClassReader å¯¹è±¡ï¼Œå°† .class æ–‡ä»¶çš„å†…å®¹è¯»å…¥åˆ°ä¸€ä¸ªå­—èŠ‚æ•°ç»„ä¸­</li>
  <li>ç„¶åéœ€è¦ä¸€ä¸ª ClassWriter çš„å¯¹è±¡å°†æ“ä½œä¹‹åçš„å­—èŠ‚ç çš„å­—èŠ‚æ•°ç»„å›å†™</li>
  <li>éœ€è¦åˆ›å»ºä¸€ä¸ªäº‹ä»¶è¿‡æ»¤å™¨ ClassVisitorã€‚äº‹ä»¶è¿‡æ»¤å™¨ä¸­çš„æŸäº›æ–¹æ³•å¯ä»¥äº§ç”Ÿä¸€ä¸ªæ–°çš„XXXVisitorå¯¹è±¡ï¼Œå½“æˆ‘ä»¬éœ€è¦ä¿®æ”¹å¯¹åº”çš„å†…å®¹æ—¶åªè¦å®ç°è‡ªå·±çš„XXXVisitorå¹¶è¿”å›å°±å¯ä»¥äº†</li>
</ol>

<p>åœ¨ä¸Šé¢ä¸‰ä¸ªæ­¥éª¤ä¸­ï¼Œå¯ä»¥æ“ä½œçš„å°±æ˜¯ ClassVisitor äº†ã€‚ClassVisitor æ¥å£æä¾›äº†å’Œç±»ç»“æ„åŒåçš„ä¸€äº›æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¯ä»¥å¯¹ç›¸åº”çš„ç±»ç»“æ„è¿›è¡Œæ“ä½œã€‚</p>

<p>åœ¨ä½¿ç”¨ ClassVisitor æ·»åŠ ç±»å±æ€§çš„æ—¶å€™ï¼Œåªéœ€è¦æ·»åŠ ä¸€å¥è¯å°±å¯ä»¥äº†ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">classVisitor</span><span class="o">.</span><span class="na">visitField</span><span class="o">(</span><span class="nc">Opcodes</span><span class="o">.</span><span class="na">ACC_PUBLIC</span><span class="o">,</span> <span class="s">"age"</span><span class="o">,</span> <span class="nc">Type</span><span class="o">.</span><span class="na">getDescriptor</span><span class="o">(</span><span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>![img](https:////upload-images.jianshu.io/upload_images/4179925-8c703df0b005aae7.png?imageMogr2/auto-orient/strip</td>
      <td>imageView2/2/w/1200/format/webp)</td>
    </tr>
  </tbody>
</table>

<p>visitField.png</p>

<h5 id="322-æ·»åŠ å±æ€§çš„æ—¶æœº">3.2.2 æ·»åŠ å±æ€§çš„æ—¶æœº</h5>

<p>æˆ‘ä»¬å…ˆæš‚ä¸”åœ¨ ClassVisitor çš„ visitEnd() æ–¹æ³•ä¸­å†™å…¥ä¸Šé¢çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤º</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Transform</span> <span class="kd">extends</span> <span class="nc">ClassVisitor</span> <span class="o">{</span>  

    <span class="kd">public</span> <span class="nf">Transform</span><span class="o">(</span><span class="nc">ClassVisitor</span> <span class="n">cv</span><span class="o">)</span> <span class="o">{</span>  
        <span class="kd">super</span><span class="o">(</span><span class="n">cv</span><span class="o">);</span>  
    <span class="o">}</span>  

    <span class="nd">@Override</span>  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitEnd</span><span class="o">()</span> <span class="o">{</span>  
        <span class="n">cv</span><span class="o">.</span><span class="na">visitField</span><span class="o">(</span><span class="nc">Opcodes</span><span class="o">.</span><span class="na">ACC_PUBLIC</span><span class="o">,</span> <span class="s">"age"</span><span class="o">,</span> <span class="nc">Type</span><span class="o">.</span><span class="na">getDescriptor</span><span class="o">(</span><span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>  
    <span class="o">}</span>  
<span class="o">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å†™å¦‚ä¸‹çš„æµ‹è¯•ç±»ï¼Œæµ‹è¯•ä¸€ä¸‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FieldPractice</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addAgeField</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addAgeField</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="s">"/Users/lijiankun/Desktop/Person.class"</span><span class="o">);</span>
            <span class="nc">ClassReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassReader</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>

            <span class="nc">ClassWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassWriter</span><span class="o">(</span><span class="nc">ClassWriter</span><span class="o">.</span><span class="na">COMPUTE_MAXS</span><span class="o">);</span>

            <span class="nc">ClassVisitor</span> <span class="n">visitor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Transform</span><span class="o">(</span><span class="n">writer</span><span class="o">);</span>
            <span class="n">reader</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">visitor</span><span class="o">,</span> <span class="nc">ClassReader</span><span class="o">.</span><span class="na">SKIP_DEBUG</span><span class="o">);</span>

            <span class="kt">byte</span><span class="o">[]</span> <span class="n">classFile</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
            <span class="nc">MyClassLoader</span> <span class="n">classLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyClassLoader</span><span class="o">();</span>
            <span class="nc">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">classLoader</span><span class="o">.</span><span class="na">defineClass</span><span class="o">(</span><span class="s">"Person"</span><span class="o">,</span> <span class="n">classFile</span><span class="o">);</span>
            <span class="nc">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">obj</span><span class="o">));</span> <span class="c1">//----(1)</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">obj</span><span class="o">));</span>  <span class="c1">//----(2)</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å…¶è¾“å‡ºå…¥ä¸‹æ‰€ç¤ºï¼š</p>

<table>
  <tbody>
    <tr>
      <td>![img](https:////upload-images.jianshu.io/upload_images/4179925-a718d240e05a2198.png?imageMogr2/auto-orient/strip</td>
      <td>imageView2/2/w/1200/format/webp)</td>
    </tr>
  </tbody>
</table>

<p>visitFieldResult.png</p>

<p>é‚£å¦‚æœæˆ‘ä»¬å°è¯•åœ¨ ClassVisitor#visitField() æ–¹æ³•ä¸­æ·»åŠ å±æ€§å¯ä»¥å—ï¼Ÿæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ Transform æµ‹è¯•ä¸€ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Transform</span> <span class="kd">extends</span> <span class="nc">ClassVisitor</span> <span class="o">{</span>

    <span class="nc">Transform</span><span class="o">(</span><span class="nc">ClassVisitor</span> <span class="n">classVisitor</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="nc">Opcodes</span><span class="o">.</span><span class="na">ASM5</span><span class="o">,</span> <span class="n">classVisitor</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">FieldVisitor</span> <span class="nf">visitField</span><span class="o">(</span><span class="kt">int</span> <span class="n">access</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">desc</span><span class="o">,</span> <span class="nc">String</span> <span class="n">signature</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">cv</span><span class="o">.</span><span class="na">visitField</span><span class="o">(</span><span class="nc">Opcodes</span><span class="o">.</span><span class="na">ACC_PUBLIC</span><span class="o">,</span> <span class="s">"age"</span><span class="o">,</span> <span class="nc">Type</span><span class="o">.</span><span class="na">getDescriptor</span><span class="o">(</span><span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">visitField</span><span class="o">(</span><span class="n">access</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">desc</span><span class="o">,</span> <span class="n">signature</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿˜æ˜¯ä½¿ç”¨ä¸Šé¢çš„æµ‹è¯•ä»£ç æµ‹è¯•ä¸€ä¸‹ï¼Œä¼šæœ‰å¦‚ä¸‹çš„æµ‹è¯•ç»“æœ</p>

<table>
  <tbody>
    <tr>
      <td>![img](https:////upload-images.jianshu.io/upload_images/4179925-e2e730e41623be28.png?imageMogr2/auto-orient/strip</td>
      <td>imageView2/2/w/1200/format/webp)</td>
    </tr>
  </tbody>
</table>

<p>visitFieldError.png</p>

<p>åœ¨ Person ç±»ä¸­æœ‰é‡å¤çš„å±æ€§ï¼Œä¸ºä»€ä¹ˆä¼šæŠ¥è¿™ä¸ªé”™è¯¯å‘¢ï¼Ÿ</p>

<p>åˆ†æ ClassVisitor#visitField() æ–¹æ³•å¯å¾—çŸ¥ï¼Œåªè¦è®¿é—®ç±»ä¸­çš„ä¸€ä¸ªå±æ€§ï¼ŒvisitField() æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œåœ¨ Person ç±»ä¸­æœ‰ä¸¤ä¸ªå±æ€§ï¼Œæ‰€ä»¥ visitField() æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼Œä¹Ÿå°±æ·»åŠ äº†ä¸¤æ¬¡ â€˜public int ageâ€™ å±æ€§ï¼Œå°±æŠ¥äº†ä¸Šè¿°çš„é”™è¯¯ï¼Œè€Œ visitEnd() æ–¹æ³•åªæœ‰åœ¨æœ€åæ‰ä¼šè¢«è°ƒç”¨ä¸”åªè°ƒç”¨ä¸€æ¬¡ï¼Œæ‰€ä»¥åœ¨ visitEnd() æ–¹æ³•ä¸­æ˜¯æ·»åŠ å±æ€§çš„æœ€ä½³æ—¶æœº</p>

<h4 id="33-asmifier">3.3 ASMifier</h4>

<p>å¯èƒ½æœ‰äººä¼šé—®ï¼Œæˆ‘åˆšå¼€å§‹å­¦ï¼Œä¸Šé¢ä¾‹å­ä¸­é‚£äº› ASM çš„ä»£ç æˆ‘è¿˜ä¸ä¼šå†™ï¼Œæ€ä¹ˆåŠå‘¢ï¼ŸASM å®˜æ–¹ä¸ºæˆ‘ä»¬æä¾›äº† <a href="https://asm.ow2.io/#Q10">ASMifier</a>ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆè¿™äº›æ™¦æ¶©éš¾æ‡‚çš„ ASM ä»£ç ã€‚</p>

<p>æ¯”å¦‚ï¼Œæˆ‘æƒ³é€šè¿‡ ASM å®ç°ç»Ÿè®¡ä¸€ä¸ªæ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿä¸€èˆ¬ä¼šæœ‰å¦‚ä¸‹çš„ä»£ç ï¼š</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">package</span> <span class="n">com</span><span class="p">.</span><span class="n">lijiankun24</span><span class="p">.</span><span class="n">classpractice</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Demo</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">costTime</span><span class="p">()</span> <span class="p">{</span>
        <span class="kt">long</span> <span class="n">startTime</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="nf">currentTimeMillis</span><span class="p">();</span>
        <span class="c1">// ......</span>
        <span class="kt">long</span> <span class="n">duration</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="nf">currentTimeMillis</span><span class="p">()</span> <span class="p">-</span> <span class="n">startTime</span><span class="p">;</span>
        <span class="n">System</span><span class="p">.</span><span class="k">out</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"The cost time of this method is "</span> <span class="p">+</span> <span class="n">duration</span> <span class="p">+</span> <span class="s">" ms"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>é‚£ä¸Šé¢è¿™æ®µä»£ç å¯¹åº”çš„ ASM ä»£ç æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼Œä½¿ç”¨ ASMifier è‡ªåŠ¨ç”Ÿæˆï¼š</p>

<ol>
  <li>é€šè¿‡ <code class="language-plaintext highlighter-rouge">javac</code> ç¼–è¯‘è¯¥ <code class="language-plaintext highlighter-rouge">Demo.java</code> æ–‡ä»¶ç”Ÿæˆå¯¹åº”çš„ <code class="language-plaintext highlighter-rouge">Demo.class</code> æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤º</li>
</ol>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">javac</span> <span class="nt">Demo</span><span class="nc">.java</span>
</code></pre></div></div>

<ol>
  <li>é€šè¿‡ ASMifier è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ ASM ä»£ç ã€‚é¦–å…ˆéœ€è¦åœ¨<a href="https://asm.ow2.io/#Q10">ASMå®˜ç½‘</a> ä¸‹è½½ <code class="language-plaintext highlighter-rouge">asm-all.jar</code> åº“ï¼Œæˆ‘ä¸‹è½½çš„æ˜¯æœ€æ–°çš„ <code class="language-plaintext highlighter-rouge">asm-all-5.2.jar</code>ï¼Œç„¶åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼Œå³å¯ç”Ÿæˆ</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">java</span> <span class="o">-</span><span class="n">classpath</span> <span class="n">asm</span><span class="o">-</span><span class="n">all</span><span class="o">-</span><span class="mf">5.2</span><span class="o">.</span><span class="na">jar</span> <span class="n">org</span><span class="o">.</span><span class="na">objectweb</span><span class="o">.</span><span class="na">asm</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">ASMifier</span> <span class="nc">Demo</span><span class="o">.</span><span class="na">class</span>
</code></pre></div></div>

<p>æˆªå›¾å¦‚ä¸‹ï¼š</p>

<table>
  <tbody>
    <tr>
      <td>![img](https:////upload-images.jianshu.io/upload_images/4179925-0cc8712718f08ea0.png?imageMogr2/auto-orient/strip</td>
      <td>imageView2/2/w/1200/format/webp)</td>
    </tr>
  </tbody>
</table>

<p>DemoDump.png</p>

<p><a href="https://my.oschina.net/ta8210/blog/163550">æ·±å…¥å­—èŠ‚ç  â€“ ç©è½¬ ASM-Bytecode åŸ è</a>
 <a href="http://www.easemob.com/news/729">ç¾å›¢çƒ­æ›´æ–¹æ¡ˆASMå®è·µ</a></p>

<p>43äººç‚¹èµ</p>

<p><a href="">Java ç›¸å…³</a></p>

<p>ä½œè€…ï¼šlijiankun24
é“¾æ¥ï¼šhttps://www.jianshu.com/p/905be2a9a700
æ¥æºï¼šç®€ä¹¦
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
:ET