<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Glide源码分析与自我实现(三)——APT的使用与GIF的优化</title>
  
  <link rel="icon" href="/assets/icons/favicon-32x32.png" type="image/*">
  

  
  <meta name="google-site-verification" content="Dw6K7nrSaFd0T-q4SAzzloGzxypfdeMRnSHyid3trNI" />
  
  
  <meta name="msvalidate.01" content="FF63C4E8F966AF567DA7288160196C79" />
  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Glide源码分析与自我实现(三)——APT的使用与GIF的优化 | Boybeak</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Glide源码分析与自我实现(三)——APT的使用与GIF的优化" />
<meta name="author" content="boybeak" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="项目Demo地址：GifHelper" />
<meta property="og:description" content="项目Demo地址：GifHelper" />
<link rel="canonical" href="/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/2022/09/17/Glide%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%8E%E8%87%AA%E6%88%91%E5%AE%9E%E7%8E%B03.html" />
<meta property="og:url" content="/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/2022/09/17/Glide%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%8E%E8%87%AA%E6%88%91%E5%AE%9E%E7%8E%B03.html" />
<meta property="og:site_name" content="Boybeak" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-09-17T03:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Glide源码分析与自我实现(三)——APT的使用与GIF的优化" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"boybeak"},"dateModified":"2022-09-17T03:00:00+00:00","datePublished":"2022-09-17T03:00:00+00:00","description":"项目Demo地址：GifHelper","headline":"Glide源码分析与自我实现(三)——APT的使用与GIF的优化","mainEntityOfPage":{"@type":"WebPage","@id":"/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/2022/09/17/Glide%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%8E%E8%87%AA%E6%88%91%E5%AE%9E%E7%8E%B03.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/icons/favicon-32x32.png"},"name":"boybeak"},"url":"/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/2022/09/17/Glide%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%8E%E8%87%AA%E6%88%91%E5%AE%9E%E7%8E%B03.html"}</script>
<!-- End Jekyll SEO tag -->


  <link rel="stylesheet"
    href="/assets/css/style.css">
  <link rel="stylesheet"
    href="/assets/css/rouge-github-auto.css">
  <link rel="stylesheet"
    href="/assets/css/github-markdown.css">

  <script src="https://unpkg.com/sober@0.6.8/dist/sober.min.js"></script>

  <script
    src="/assets/js/sobekyll.js"></script>

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-6JFG91EQ3M"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', "G-6JFG91EQ3M");
  </script>
  

</head>

<body>
  <s-page theme="auto">
    <s-drawer id="drawer">
      <s-scroll-view slot="start" style="height: 100%;">
    <div>
        
        <div class="author">
            <img class="author-avatar" src="https://avatars.githubusercontent.com/u/6696502?v=4">
            <span class="author-name">boybeak</span>
        </div>
        
        
        <s-divider style="padding: 0px; margin: 0px;"></s-divider>
        
        <s-menu style="width: 100%;">
            
            <div slot="label">Contact Me</div>
            
            
            
            <s-menu-item onclick="window.open('https://github.com/boybeak')">
                
                <s-icon slot="start">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3 .3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5 .3-6.2 2.3zm44.2-1.7c-2.9 .7-4.9 2.6-4.6 4.9 .3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3 .7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3 .3 2.9 2.3 3.9 1.6 1 3.6 .7 4.3-.7 .7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3 .7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3 .7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
                </s-icon>
                

                Github
                
            </s-menu-item>
            
            <s-menu-item onclick="window.open('https://x.com/BeakInAir')">
                
                <s-icon slot="start">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
                </s-icon>
                

                X
                
            </s-menu-item>
            
            <s-menu-item onclick="window.open('mailto:boybeak@gmail.com')">
                
                <s-icon slot="start">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4 0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4c0-26.5-21.5-48-48-48L48 64zM0 176L0 384c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64l0-208L294.4 339.2c-22.8 17.1-54 17.1-76.8 0L0 176z"/></svg>
                </s-icon>
                

                Email
                
            </s-menu-item>
            
            
        </s-menu>
        
        <s-menu style="width: 100%;">
            
            <div slot="label">My Apps</div>
            
            
            
            <s-menu-item onclick="window.open('')">
                
                <img slot="start" src="/assets/images/AODVolume.png" style="width: 32px; height: 32px; object-fit: cover;">
                

                AOD Volume
                
            </s-menu-item>
            
            <s-menu-item onclick="window.open('https://github.com/boybeak/JustTodo')">
                
                <img slot="start" src="/assets/images/JustTodo.png" style="width: 32px; height: 32px; object-fit: cover;">
                

                JustTodo
                
            </s-menu-item>
            
            <s-menu-item onclick="window.open('https://github.com/boybeak/DeskNote')">
                
                <img slot="start" src="/assets/images/DeskNote.png" style="width: 32px; height: 32px; object-fit: cover;">
                

                DeskNote
                
            </s-menu-item>
            
            <s-menu-item onclick="window.open('https://github.com/boybeak/TranslatorDocs')">
                
                <img slot="start" src="/assets/images/Translator.png" style="width: 32px; height: 32px; object-fit: cover;">
                

                Translator
                
            </s-menu-item>
            
            
        </s-menu>
        
        <s-menu style="width: 100%;">
            
            
            
            <s-menu-item onclick="window.open('https://1kafei.com/user/payment/new/boybeak/069DN2BH0I7/?referrer=/boybeak/')">
                
                <s-icon slot="start">
                    <svg stroke-width="0" viewBox="0 0 24 24" class="inline-block text-primary" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg" style="font-size: 30px;"><path d="M7 22h10a1 1 0 0 0 .99-.858L19.867 8H21V6h-1.382l-1.724-3.447A.998.998 0 0 0 17 2H7c-.379 0-.725.214-.895.553L4.382 6H3v2h1.133L6.01 21.142A1 1 0 0 0 7 22zm10.418-11H6.582l-.429-3h11.693l-.428 3zm-9.551 9-.429-3h9.123l-.429 3H7.867zM7.618 4h8.764l1 2H6.618l1-2z"></path></svg>
                </s-icon>
                

                Donate Me
                
            </s-menu-item>
            
            <s-menu-item onclick="window.open('/about')">
                
                <s-icon slot="start">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"></path></svg>
                </s-icon>
                

                About
                
            </s-menu-item>
            
            
        </s-menu>
        
        
    </div>
</s-scroll-view>
      <main>
        <s-appbar>
    <s-icon-button slot="navigation" onclick="document.querySelector('#drawer').toggle()">
        <s-icon type="menu"></s-icon>
    </s-icon-button>
    <!-- onclick="window.open('', '_self')" -->
    <a class="app-bar-title" slot="headline" href="/"> Boybeak </a>

    
    <s-popup-menu slot="action">
        <s-button type="text" slot="trigger" class="app-bar-action">
            Tags
            <s-icon type="arrow_drop_down" slot="end"></s-icon>
        </s-button>
        
        <s-popup-menu-item onclick="selfOpen('/tag/android')">Android</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/tag/陷阱与缺陷')">陷阱与缺陷</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/tag/kotlin')">Kotlin</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/tag/translator')">Translator</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/tag/j2v8')">J2V8</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/tag/camera')">Camera</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/tag/macos')">macOS</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/tag/静态库')">静态库</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/tag/justtodo')">JustTodo</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/tag/面试')">面试</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/tag/hexo')">Hexo</s-popup-menu-item>
        
    </s-popup-menu>
    

    
    <s-popup-menu slot="action">
        <s-button type="text" slot="trigger" class="app-bar-action">
            Categories
            <s-icon type="arrow_drop_down" slot="end"></s-icon>
        </s-button>
        
        
        <s-popup-menu-item onclick="selfOpen('/category/源码分析')">源码分析</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/category/android技巧')">Android技巧</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/category/陷阱与缺陷')">陷阱与缺陷</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/category/kotlin')">Kotlin</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/category/native')">Native</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/category/translator')">Translator</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/category/独立开发笔记')">独立开发笔记</s-popup-menu-item>
        
        <s-popup-menu-item onclick="selfOpen('/category/面试笔记')">面试笔记</s-popup-menu-item>
        
    </s-popup-menu>
    
</s-appbar>
        <s-scroll-view>
          <div class="contentWrapper">
            <div class="content">
              <article>
  <h1 style="margin-block-start: 0; margin-block-end: 0;">Glide源码分析与自我实现(三)——APT的使用与GIF的优化</h1>
  <p class="post-meta">
    <s-icon style="width: 20px; height: 20px;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
        <path
            d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-80h80v80h320v-80h80v80h40q33 0 56.5 23.5T840-720v560q0 33-23.5 56.5T760-80H200Zm0-80h560v-400H200v400Zm0-480h560v-80H200v80Zm0 0v-80 80Zm280 240q-17 0-28.5-11.5T440-440q0-17 11.5-28.5T480-480q17 0 28.5 11.5T520-440q0 17-11.5 28.5T480-400Zm-160 0q-17 0-28.5-11.5T280-440q0-17 11.5-28.5T320-480q17 0 28.5 11.5T360-440q0 17-11.5 28.5T320-400Zm320 0q-17 0-28.5-11.5T600-440q0-17 11.5-28.5T640-480q17 0 28.5 11.5T680-440q0 17-11.5 28.5T640-400ZM480-240q-17 0-28.5-11.5T440-280q0-17 11.5-28.5T480-320q17 0 28.5 11.5T520-280q0 17-11.5 28.5T480-240Zm-160 0q-17 0-28.5-11.5T280-280q0-17 11.5-28.5T320-320q17 0 28.5 11.5T360-280q0 17-11.5 28.5T320-240Zm320 0q-17 0-28.5-11.5T600-280q0-17 11.5-28.5T640-320q17 0 28.5 11.5T680-280q0 17-11.5 28.5T640-240Z">
        </path>
    </svg>
</s-icon>
<small>
    
    

    
    
    September 17
    
    
</small>
  </p>
  
  <div class="post-content">
    <div class="markdown-body" style="background-color: transparent; min-height: 0px;">
      <p>项目Demo地址：<a href="https://github.com/boybeak/GifHelper">GifHelper</a></p>

<p><strong>什么是APT？</strong></p>

<p><strong>APT</strong>是<strong>Annotation Processing Tool</strong>的简称，即<strong>编译时注解处理器</strong>。它是一个javac的工具，在编译时，通过注解，按照规则自动生成相关代码的工具。</p>

<p><strong>APT与Glide什么关系？</strong></p>

<p>我们通常通过在build.gradle加入这样一段代码来引入Glide库。</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">repositories</span> <span class="o">{</span>
  <span class="n">google</span><span class="o">()</span>
  <span class="n">jcenter</span><span class="o">()</span>
<span class="o">}</span>

<span class="n">dependencies</span> <span class="o">{</span>
  <span class="n">implementation</span> <span class="s1">'com.github.bumptech.glide:glide:4.11.0'</span>
  <span class="n">annotationProcessor</span> <span class="s1">'com.github.bumptech.glide:compiler:4.11.0'</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这里有一个<code class="language-plaintext highlighter-rouge">annotationProcessor</code>，这就是对Glide提供的APT进行引用。我们查看Glide的源码结构，可以看到一个名为<em>annotation</em>的文件夹，这里就是与APT有关的部分。</p>

<p><img src="/assets/images/glide_struct.jpg" alt="Glide Struct" /></p>

<p>接下来我们先通过GIF优化，看一看Glide的APT能实现的神奇效果，在这之后，再来分析Glide是如何通过APT实现的。</p>

<blockquote>
  <p><strong>注意：</strong>如果使用kotlin需要先加入<code class="language-plaintext highlighter-rouge">apply plugin: 'kotlin-kapt'</code>插件，并且将<code class="language-plaintext highlighter-rouge">annotationProcessor</code>改成<code class="language-plaintext highlighter-rouge">kapt</code>。</p>
</blockquote>

<h2 id="gif优化">GIF优化</h2>

<p><strong>为什么要优化GIF？</strong></p>

<p>有人可能会有疑问，Glide相比其他图片加载框架的优势之一，就是支持GIF，为什么还要做优化呢？</p>

<p>先看两个截图来对比优化前后的CPU和内存使用情况。</p>

<p><img src="/assets/images/gif_before_optimization.png" alt="优化前" /></p>

<p><img src="/assets/images/gif_after_optimization.png" alt="优化后" /></p>

<p>我们可以看出，优化后，CPU和内存状况都好了很多，那么我们是怎么做的呢？这就需要用到谷歌官方的两个库——<a href="https://android.googlesource.com/platform/external/giflib/+/refs/heads/master">giflib</a>和<a href="https://android.googlesource.com/platform/frameworks/ex/+/refs/heads/master/framesequence/">FrameSequence</a>，这两个库需要我们自己编译成.so文件，具体可以参考示例项目<a href="https://github.com/boybeak/GifHelper">GifHelper</a>。</p>

<p>我们查看GifHolder中的代码。</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">GifHolder</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="nc">View</span><span class="p">)</span> <span class="p">:</span> <span class="nc">AbsHolder</span><span class="p">&lt;</span><span class="nc">GifItem</span><span class="p">&gt;(</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">..</span><span class="p">.</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">gifIV</span> <span class="p">=</span> <span class="n">view</span><span class="p">&lt;</span><span class="nc">ImageView</span><span class="p">&gt;(</span><span class="nc">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">gifIV</span><span class="p">)</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onBind</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nc">GifItem</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="n">absAdapter</span><span class="p">:</span> <span class="nc">AnyAdapter</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">useGifX</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 优化后的加载方式</span>
    	<span class="nc">GlideApp</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="n">itemView</span><span class="p">).</span><span class="nf">asGifX</span><span class="p">().</span><span class="nf">load</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="nf">source</span><span class="p">()).</span><span class="nf">into</span><span class="p">(</span><span class="n">gifIV</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 优化前的加载方式</span>
      <span class="nc">Glide</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="n">itemView</span><span class="p">).</span><span class="nf">asGif</span><span class="p">().</span><span class="nf">load</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="nf">source</span><span class="p">()).</span><span class="nf">into</span><span class="p">(</span><span class="n">gifIV</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="o">....</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我们可以看到，加载后有这样一条语句：<code class="language-plaintext highlighter-rouge">GlideApp.with(itemView).asGifX().load(item.source()).into(gifIV)</code>，也许你会懵逼，哪里有GlideApp？哪里有asGifX()方法？我引入Glide后怎么没有看到这两个东西？这就涉及到了APT的内容了。想要看Glide官方文档的可以看<a href="http://bumptech.github.io/glide/doc/configuration.html#glidemodule">这里</a>。</p>

<p>一切的起因，要从<strong>@GlideModule</strong>这个注解说起，我们打开demo中的MyAppGlideModule类，可以看到这个类有一个@GlideModule注解。</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@GlideModule</span>
<span class="kd">class</span> <span class="nc">MyAppGlideModule</span> <span class="p">:</span> <span class="nc">AppGlideModule</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">registerComponents</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="nc">Context</span><span class="p">,</span> <span class="n">glide</span><span class="p">:</span> <span class="nc">Glide</span><span class="p">,</span> <span class="n">registry</span><span class="p">:</span> <span class="nc">Registry</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="nf">registerComponents</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">glide</span><span class="p">,</span> <span class="n">registry</span><span class="p">)</span>
    <span class="n">registry</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Registry</span><span class="p">.</span><span class="nc">BUCKET_GIF</span><span class="p">,</span> <span class="nc">InputStream</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">,</span>
                    <span class="nc">FrameSequenceDrawable</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">,</span> <span class="nc">GifDecoder</span><span class="p">(</span><span class="n">glide</span><span class="p">.</span><span class="n">bitmapPool</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我们再点开这个注解的源码，如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">CLASS</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">GlideModule</span> <span class="o">{</span>
  <span class="cm">/**
   * Returns the name of the class that will be used as a replacement for {@code
   * com.bumptech.glide.Glide} in Applications that depend on Glide's generated code.
   */</span>
  <span class="nc">String</span> <span class="nf">glideName</span><span class="o">()</span> <span class="k">default</span> <span class="s">"GlideApp"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>我们现在看到“GlideApp”了，是glideName这个注解属性的默认值。我们来逐条分析一下这个注解类的相关信息：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">@Target(ElementType.TYPE)</code>：指明这个注解的作用对象——只对类生效；</li>
  <li><code class="language-plaintext highlighter-rouge">@Retention(RetentionPolicy.CLASS)</code>：指明了这个注解的作用阶段——编译时记录在class文件中；</li>
  <li><code class="language-plaintext highlighter-rouge">public @interface GlideModule</code>：这是一个注解接口，接口名<strong>GlideModule</strong>；</li>
  <li><code class="language-plaintext highlighter-rouge">String glideName() default "GlideApp"</code>：这个注解接口需要一个名为<em>glideName</em>的属性，属性默认值为“GlideApp”。</li>
</ul>

<blockquote>
  <p>RetentionPolicy：</p>

  <ul>
    <li><strong>SOURCE</strong>：这样的注解会被编译器擦除，只在编码阶段生效，目的是为了提示开发者，比如<strong>@IntDef</strong>、<strong>@StringDef</strong>、<strong>@Visibility</strong>、<strong>@NonNull</strong>；</li>
    <li><strong>CLASS</strong>：记录在class文件中，编译时对编译器可见，运行时对VM不可见，这是RetentionPolicy的默认值，比如<strong>@NotNull</strong>;</li>
    <li><strong>RUNTIME</strong>：记录在class文件中，在运行时需要反射获取其属性值，比如<strong>@Column</strong>。</li>
  </ul>
</blockquote>

<p>就是这个<strong>@GlideModule</strong>属性，为我们生成了GlideApp类，这其中的生成过程，我们稍后再说，先把Gif优化的流程说完。</p>

<p>添加<strong>@GlideModule</strong>后，再次编译看，是否有了GlideApp这个类了。</p>

<p>我们再来看<em>MyAppGlideModule</em>中的代码，<code class="language-plaintext highlighter-rouge">registry.append</code>方法，这是为Glide添加一种解析类型。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* 
* @param bucket 要添加的类型id.
* @param dataClass 要从什么数据进行解析。 ({@link java.io.InputStream}, {@link
*     java.io.FileDescriptor} etc).
* @param resourceClass 要解析成什么数据。 ({@link android.graphics.Bitmap},
*     {@link com.bumptech.glide.load.resource.gif.GifDrawable} etc).
* @param decoder 用什么解码器进行解析 {@link ResourceDecoder}。
*/</span>
<span class="nd">@NonNull</span>
<span class="kd">public</span> <span class="o">&lt;</span><span class="nc">Data</span><span class="o">,</span> <span class="nc">TResource</span><span class="o">&gt;</span> <span class="nc">Registry</span> <span class="nf">append</span><span class="o">(</span>
  <span class="nd">@NonNull</span> <span class="nc">String</span> <span class="n">bucket</span><span class="o">,</span>
  <span class="nd">@NonNull</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="nc">Data</span><span class="o">&gt;</span> <span class="n">dataClass</span><span class="o">,</span>
  <span class="nd">@NonNull</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="nc">TResource</span><span class="o">&gt;</span> <span class="n">resourceClass</span><span class="o">,</span>
  <span class="nd">@NonNull</span> <span class="nc">ResourceDecoder</span><span class="o">&lt;</span><span class="nc">Data</span><span class="o">,</span> <span class="nc">TResource</span><span class="o">&gt;</span> <span class="n">decoder</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">decoderRegistry</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">bucket</span><span class="o">,</span> <span class="n">decoder</span><span class="o">,</span> <span class="n">dataClass</span><span class="o">,</span> <span class="n">resourceClass</span><span class="o">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>接下来就要引入谷歌官方的两个类库了，<a href="https://android.googlesource.com/platform/frameworks/ex/+/android-9.0.0_r16/framesequence/">FrameSquence</a>和<a href="https://android.googlesource.com/platform/external/giflib/+/android-9.0.0_r16">giflib</a>。大家可以根据需要下载对应版本的库，不过这两个库的版本最好要对应。</p>

<p>下载后需要编译，项目结构参考<a href="https://github.com/boybeak/GifHelper">GifHelper</a>项目中的framesequence/src/main/jni文件夹。注意，需要将FrameSequence_gif.h中的include部分进行修改。</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">- #include "config.h"
- #include "gif_lib.h"
</span><span class="err">改成</span>
+ #include "giflib/config.h"
<span class="gi">+ #include "giflib/gif_lib.h"
</span></code></pre></div></div>

<p>然后执行ndk-build，则会在jni同级的目录下，生成一个libs文件夹，.so文件就在这里。</p>

<p>接下来需要去自定义GifDecoder.java了，直接上代码：</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">GifDecoder</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">bmpPool</span><span class="p">:</span> <span class="nc">BitmapPool</span><span class="p">)</span> <span class="p">:</span> <span class="nc">ResourceDecoder</span><span class="p">&lt;</span><span class="nc">InputStream</span><span class="p">,</span> <span class="nc">FrameSequenceDrawable</span><span class="p">&gt;</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">headerParser</span> <span class="p">=</span> <span class="nc">DefaultImageHeaderParser</span><span class="p">()</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">handles</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nc">InputStream</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="nc">Options</span><span class="p">):</span> <span class="nc">Boolean</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">!(</span><span class="n">options</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="nc">GifOptions</span><span class="p">.</span><span class="nc">DISABLE_ANIMATION</span><span class="p">)</span> <span class="o">?:</span> <span class="k">true</span><span class="p">)</span>
            <span class="p">&amp;&amp;</span> <span class="n">headerParser</span><span class="p">.</span><span class="nf">getType</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="p">==</span> <span class="nc">ImageHeaderParser</span><span class="p">.</span><span class="nc">ImageType</span><span class="p">.</span><span class="nc">GIF</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">decode</span><span class="p">(</span>
        <span class="n">source</span><span class="p">:</span> <span class="nc">InputStream</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
        <span class="n">height</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="nc">Options</span>
    <span class="p">):</span> <span class="nc">Resource</span><span class="p">&lt;</span><span class="nc">FrameSequenceDrawable</span><span class="p">&gt;?</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">fs</span> <span class="p">=</span> <span class="nc">FrameSequence</span><span class="p">.</span><span class="nf">decodeStream</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">fsd</span> <span class="p">=</span> <span class="nc">FrameSequenceDrawable</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">FrameSequenceDrawable</span><span class="p">.</span><span class="nc">BitmapProvider</span> <span class="p">{</span>
            <span class="k">override</span> <span class="k">fun</span> <span class="nf">acquireBitmap</span><span class="p">(</span><span class="n">minWidth</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="n">minHeight</span><span class="p">:</span> <span class="nc">Int</span><span class="p">):</span> <span class="nc">Bitmap</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">bmpPool</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">minWidth</span><span class="p">,</span> <span class="n">minHeight</span><span class="p">,</span> <span class="nc">Bitmap</span><span class="p">.</span><span class="nc">Config</span><span class="p">.</span><span class="nc">ARGB_8888</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="k">override</span> <span class="k">fun</span> <span class="nf">releaseBitmap</span><span class="p">(</span><span class="n">bitmap</span><span class="p">:</span> <span class="nc">Bitmap</span><span class="p">?)</span> <span class="p">{</span>
                <span class="n">bmpPool</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">bitmap</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="nc">GifResource</span><span class="p">(</span><span class="n">fsd</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这个类里只需要实现两个方法：<code class="language-plaintext highlighter-rouge">handles</code>和<code class="language-plaintext highlighter-rouge">decode</code>：</p>

<ul>
  <li>handles：能否解析该输入源，能则返回true；</li>
  <li>decode：如果handles返回true，则执行此方法，返回一个Resource对象包裹住目标类型对象。</li>
</ul>

<p>我们通过Glide自带的<em>ImageHeaderParser</em>来检测该输入流是否是gif图像的输入流，如果是且可以执行动画，则进行decode操作。</p>

<p>我们着重看decode方法，这里需要重点看的是，在构建<em>FrameSequenceDrawable</em>时候，传入了一个<em>BitmapProvider</em>对象，这就是提高Gif效率的关键，在这个<em>BitmapProvider</em>里面，我们通过BitmapPool，去寻找可用尺寸的Bitmap，通过<strong>池化</strong>的方式，减小了内存开销，增加里Bitmap利用率。</p>

<p>接下来看，如何添加<code class="language-plaintext highlighter-rouge">asGifX</code>方法。我们都知道，传统的Glide调用方式如下图：</p>

<p><code class="language-plaintext highlighter-rouge">Glide.with(itemView).asGif().load(item.source()).into(gifIV)</code></p>

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div class="mermaid">
graph LR;
A[Glide] --&gt;|"with(xxx)"| B[RequestManager] --&gt;|"asGif"| C[RequestBuilder];
</div>

<p>而新的方式却不同，如下图：</p>

<p><code class="language-plaintext highlighter-rouge">GlideApp.with(itemView).asGifX().load(item.source()).into(gifIV)</code></p>

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div class="mermaid">
graph LR;
A[GlideApp] --&gt;|"with(xxx)"| B[GlideRequests]  --&gt;|asGifX| C[GlideRequest];
</div>

<p>这其中的<em>GlideRequest</em>和<em>GlideRequest</em>，同样都是生成的类，其中GlideRequests继承自RequestManager，GlideRequest继承自RequestBuilder。</p>

<p>这两个类的生成，同样是<strong>@GlideModule</strong>的作用，但是<code class="language-plaintext highlighter-rouge">asGifX</code>这个方法是什么时候定义的呢？我们去查看<code class="language-plaintext highlighter-rouge">asGifX</code>这个方法的代码：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
* @see GifExtension#asGifX(RequestBuilder)
*/</span>
<span class="nd">@NonNull</span>
<span class="nd">@CheckResult</span>
<span class="kd">public</span> <span class="nc">GlideRequest</span><span class="o">&lt;</span><span class="nc">FrameSequenceDrawable</span><span class="o">&gt;</span> <span class="nf">asGifX</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="o">(</span><span class="nc">GlideRequest</span><span class="o">&lt;</span><span class="nc">FrameSequenceDrawable</span><span class="o">&gt;)</span> <span class="nc">GifExtension</span><span class="o">.</span><span class="na">asGifX</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">as</span><span class="o">(</span><span class="nc">FrameSequenceDrawable</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>我们看到实际上这个类的具体实现，是依靠GifExtension类，我们去看这个类的代码：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@GlideExtension</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GifExtension</span> <span class="o">{</span>
    <span class="nd">@NonNull</span>
    <span class="nd">@GlideType</span><span class="o">(</span><span class="nc">FrameSequenceDrawable</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">RequestBuilder</span><span class="o">&lt;</span><span class="nc">FrameSequenceDrawable</span><span class="o">&gt;</span> <span class="nf">asGifX</span><span class="o">(</span><span class="nc">RequestBuilder</span><span class="o">&lt;</span><span class="nc">FrameSequenceDrawable</span><span class="o">&gt;</span> <span class="n">requestBuilder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">requestBuilder</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="nc">RequestOptions</span>
                <span class="o">.</span><span class="na">decodeTypeOf</span><span class="o">(</span><span class="nc">FrameSequenceDrawable</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">lock</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="nf">GifExtension</span><span class="o">(){}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这个类需要我们自己实现，并且需要标记<strong>@GlideExtension</strong>注解，又是注解的功劳。</p>

<p>到此为止，Gif优化的主流程就全部讲完了，接下来就要看这两个注解——<strong>@GlideModule</strong>和<strong>@GlideExtension</strong>到底做了什么？</p>

<h2 id="glidemodule和glideextension">@GlideModule和@GlideExtension</h2>

<p>源码在Glide项目的annotation/compiler内，这种APT项目的入口文件标记在src/main/resources/META-INF/gradle内，这其中有一个incremental.annotation.processors文件，我们查看其内容：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>com.bumptech.glide.annotation.compiler.GlideAnnotationProcessor,aggregating
</code></pre></div></div>

<p>可以得知，程序入口在GlideAnnotationProcessor这个类，查看这个类的源码，我只提取了关键部分：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">GlideAnnotationProcessor</span> <span class="kd">extends</span> <span class="nc">AbstractProcessor</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="kd">private</span> <span class="nc">LibraryModuleProcessor</span> <span class="n">libraryModuleProcessor</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">AppModuleProcessor</span> <span class="n">appModuleProcessor</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isGeneratedAppGlideModuleWritten</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">ExtensionProcessor</span> <span class="n">extensionProcessor</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getSupportedAnnotationTypes</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
    <span class="n">result</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">libraryModuleProcessor</span><span class="o">.</span><span class="na">getSupportedAnnotationTypes</span><span class="o">());</span>
    <span class="n">result</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">extensionProcessor</span><span class="o">.</span><span class="na">getSupportedAnnotationTypes</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">process</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">TypeElement</span><span class="o">&gt;</span> <span class="n">set</span><span class="o">,</span> <span class="nc">RoundEnvironment</span> <span class="n">env</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">processorUtil</span><span class="o">.</span><span class="na">process</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="n">newModulesWritten</span> <span class="o">=</span> <span class="n">libraryModuleProcessor</span><span class="o">.</span><span class="na">processModules</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="n">newExtensionWritten</span> <span class="o">=</span> <span class="n">extensionProcessor</span><span class="o">.</span><span class="na">processExtensions</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>
    <span class="n">appModuleProcessor</span><span class="o">.</span><span class="na">processModules</span><span class="o">(</span><span class="n">set</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">newExtensionWritten</span> <span class="o">||</span> <span class="n">newModulesWritten</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isGeneratedAppGlideModuleWritten</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Cannot process annotations after writing AppGlideModule"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">isGeneratedAppGlideModuleWritten</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">isGeneratedAppGlideModuleWritten</span> <span class="o">=</span> <span class="n">appModuleProcessor</span><span class="o">.</span><span class="na">maybeWriteAppModule</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">getSupportedAnnotationTypes</code>方法中标记了，支持哪些注解的解析，其中<code class="language-plaintext highlighter-rouge">libraryModuleProcessor.getSupportedAnnotationTypes()</code>中返回了<strong>@GlideModule</strong>，<code class="language-plaintext highlighter-rouge">extensionProcessor.getSupportedAnnotationTypes()</code>中返回了<strong>@GlideExtension</strong>。</li>
  <li>process方法中开始了对注解的处理。</li>
</ul>

<p>注解的处理，需要你对<a href="https://github.com/square/javapoet"><strong>javapoet</strong></a>有一点点了解，如果暂时不想去了解，你只需要知道，这个类库是通过字符串和占位符来生成Java代码的工具类库，因为接下来的生成代码工作，Glide就是通过这个类库来实现的。</p>

<p>具体的生成过程不再赘述，从入口类<em>GlideAnnotationProcessor</em>追踪下去，就能看到。</p>

<h2 id="为什么优化能提高效率">为什么优化能提高效率？</h2>

<p>Glide默认Gif加载方案，是通过GifDrawable来实现的，而GifDrawable是通过GifFrameLoader来加载帧数据的。具体代码分析可以看参考文章，我这里简单来说一下原因：</p>

<ul>
  <li>默认方案是串行执行的，比如在加载显示第N帧，这一帧显示完毕，再去解析第N+1帧，当播放第N+1帧的时间窗口到了以后，如果已经解析完毕，则能正常显示，如果不能解析完毕，则会卡顿了；</li>
  <li>GifFrameLoader内部是用了一个mainLooper的handler来进行流程控制，具体可以看GifFrameLoader里的代码，这种方式本身在时间上就不是准时的，与应用内其他各种系统共享mainLooper，如果其他事件执行占用时间较长，也会影响这里的效率了。</li>
</ul>

<p>我们再来说说优化方案，优化的原因也简单说一下：</p>

<ul>
  <li>优化方案是<strong>并行+双缓冲</strong>执行的，在显示第N帧的BitmapA同时，会有一个后台线程在解析第N+1帧的BitmapB，当需要显示第N+1帧BitmapB的时候，两帧的Bitmap交换，BitmapA则进入后台线程去解析第N+2帧了；</li>
  <li>在native去解析数据，效率更高；</li>
  <li>通过BitmapPool提高了内存利用率。</li>
</ul>

<p>借用参考文章里的一张图</p>

<p><img src="/assets/images/gif.webp" alt="Gif" /></p>

<h2 id="参考文章">参考文章</h2>

<p><a href="https://juejin.im/post/6854573219425288199">Glide加载Gif的卡顿优化思路分析</a></p>

    </div>
  </div>
  
  <p class="post-meta">
    
    <s-icon style="width: 20px; height: 20px;">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
        <path
          d="m240-160 40-160H120l20-80h160l40-160H180l20-80h160l40-160h80l-40 160h160l40-160h80l-40 160h160l-20 80H660l-40 160h160l-20 80H600l-40 160h-80l40-160H360l-40 160h-80Zm140-240h160l40-160H420l-40 160Z">
        </path>
      </svg>
    </s-icon>
    
    <a href="/tag/android">Android</a>
    
    <space style="margin-right: 8px;"></space>
    

    
    <s-icon style="width: 20px; height: 20px;">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
        <path
          d="m260-520 220-360 220 360H260ZM700-80q-75 0-127.5-52.5T520-260q0-75 52.5-127.5T700-440q75 0 127.5 52.5T880-260q0 75-52.5 127.5T700-80Zm-580-20v-320h320v320H120Zm580-60q42 0 71-29t29-71q0-42-29-71t-71-29q-42 0-71 29t-29 71q0 42 29 71t71 29Zm-500-20h160v-160H200v160Zm202-420h156l-78-126-78 126Zm78 0ZM360-340Zm340 80Z">
        </path>
      </svg>
    </s-icon>
    
    <a href="/category/源码分析">源码分析</a>
    
    
  </p>
</article>
            </div>
            <footer style="max-width: 100%; padding: 24px;">
    Powered by <a href="https://sobekyll.github.io/">Sobekyll</a>, based on <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://soberjs.com/">SoberJS</a>.
</footer>
          </div>
        </s-scroll-view>
      </main>
    </s-drawer>
  </s-page>
</body>

</html>