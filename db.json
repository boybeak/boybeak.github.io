{"meta":{"version":1,"warehouse":"5.0.1"},"models":{"Asset":[{"_id":"themes/hexober/source/404.md","path":"404.md","modified":0,"renderable":1},{"_id":"themes/hexober/source/css/github-markdown.min.css","path":"css/github-markdown.min.css","modified":0,"renderable":1},{"_id":"themes/hexober/source/css/layout.css","path":"css/layout.css","modified":0,"renderable":1},{"_id":"themes/hexober/source/css/prism-theme-github-dark.css","path":"css/prism-theme-github-dark.css","modified":0,"renderable":1},{"_id":"themes/hexober/source/css/prism-theme-github-light.css","path":"css/prism-theme-github-light.css","modified":0,"renderable":1},{"_id":"themes/hexober/source/assets/hexober-icon.svg","path":"assets/hexober-icon.svg","modified":0,"renderable":1},{"_id":"themes/hexober/source/assets/ic-category.svg","path":"assets/ic-category.svg","modified":0,"renderable":1},{"_id":"themes/hexober/source/assets/ic-date.svg","path":"assets/ic-date.svg","modified":0,"renderable":1},{"_id":"themes/hexober/source/assets/ic-tag.svg","path":"assets/ic-tag.svg","modified":0,"renderable":1},{"_id":"themes/hexober/source/assets/ic-theme-dark.svg","path":"assets/ic-theme-dark.svg","modified":0,"renderable":1},{"_id":"themes/hexober/source/assets/ic-theme-auto.svg","path":"assets/ic-theme-auto.svg","modified":0,"renderable":1},{"_id":"themes/hexober/source/assets/ic-theme-light.svg","path":"assets/ic-theme-light.svg","modified":0,"renderable":1},{"_id":"themes/hexober/source/js/color-thief.umd.js","path":"js/color-thief.umd.js","modified":0,"renderable":1},{"_id":"themes/hexober/source/js/prism.js","path":"js/prism.js","modified":0,"renderable":1},{"_id":"themes/hexober/source/js/layout.js","path":"js/layout.js","modified":0,"renderable":1},{"_id":"themes/hexober/source/js/sober.min.js","path":"js/sober.min.js","modified":0,"renderable":1},{"_id":"source/sitemap.xml","path":"sitemap.xml","modified":0,"renderable":0},{"_id":"source/assets/favicon-16x16.png","path":"assets/favicon-16x16.png","modified":0,"renderable":0},{"_id":"source/assets/favicon-32x32.png","path":"assets/favicon-32x32.png","modified":0,"renderable":0},{"_id":"source/assets/favicon-96x96.png","path":"assets/favicon-96x96.png","modified":0,"renderable":0},{"_id":"source/images/4179925-0cc8712718f08ea0.webp","path":"images/4179925-0cc8712718f08ea0.webp","modified":0,"renderable":0},{"_id":"source/images/4179925-32ee7bd0974a4679.webp","path":"images/4179925-32ee7bd0974a4679.webp","modified":0,"renderable":0},{"_id":"source/images/4179925-8c703df0b005aae7.webp","path":"images/4179925-8c703df0b005aae7.webp","modified":0,"renderable":0},{"_id":"source/images/4179925-a718d240e05a2198.webp","path":"images/4179925-a718d240e05a2198.webp","modified":0,"renderable":0},{"_id":"source/images/4179925-af582100631d7eec.webp","path":"images/4179925-af582100631d7eec.webp","modified":0,"renderable":0},{"_id":"source/images/4179925-d4f950ec94a12cde.webp","path":"images/4179925-d4f950ec94a12cde.webp","modified":0,"renderable":0},{"_id":"source/images/4179925-e2e730e41623be28.webp","path":"images/4179925-e2e730e41623be28.webp","modified":0,"renderable":0},{"_id":"source/images/4179925-f5a428b729962860.webp","path":"images/4179925-f5a428b729962860.webp","modified":0,"renderable":0},{"_id":"source/images/android_binder.jpg","path":"images/android_binder.jpg","modified":0,"renderable":0},{"_id":"source/images/apple-touch-icon-300x300.jpg","path":"images/apple-touch-icon-300x300.jpg","modified":0,"renderable":0},{"_id":"source/images/binder.jpg","path":"images/binder.jpg","modified":0,"renderable":0},{"_id":"source/images/binder_data_trans.jpg","path":"images/binder_data_trans.jpg","modified":0,"renderable":0},{"_id":"source/images/client_server_service_manager.jpg","path":"images/client_server_service_manager.jpg","modified":0,"renderable":0},{"_id":"source/images/dest-note-right.gif","path":"images/dest-note-right.gif","modified":0,"renderable":0},{"_id":"source/images/dest-note.gif","path":"images/dest-note.gif","modified":0,"renderable":0},{"_id":"source/images/ezgif-6-73b502b11e16.jpg","path":"images/ezgif-6-73b502b11e16.jpg","modified":0,"renderable":0},{"_id":"source/images/favicon-16x16.png","path":"images/favicon-16x16.png","modified":0,"renderable":0},{"_id":"source/images/favicon-32x32.png","path":"images/favicon-32x32.png","modified":0,"renderable":0},{"_id":"source/images/favicon-96x96.png","path":"images/favicon-96x96.png","modified":0,"renderable":0},{"_id":"source/images/favicon.svg","path":"images/favicon.svg","modified":0,"renderable":0},{"_id":"source/images/forground_service.png","path":"images/forground_service.png","modified":0,"renderable":0},{"_id":"source/images/getNumber.png","path":"images/getNumber.png","modified":0,"renderable":0},{"_id":"source/images/gif.webp","path":"images/gif.webp","modified":0,"renderable":0},{"_id":"source/images/gif_after_optimization.png","path":"images/gif_after_optimization.png","modified":0,"renderable":0},{"_id":"source/images/gif_before_optimization.png","path":"images/gif_before_optimization.png","modified":0,"renderable":0},{"_id":"source/images/glide_struct.jpg","path":"images/glide_struct.jpg","modified":0,"renderable":0},{"_id":"source/images/jd_loader_manager.jpg","path":"images/jd_loader_manager.jpg","modified":0,"renderable":0},{"_id":"source/images/jitpack.png","path":"images/jitpack.png","modified":0,"renderable":0},{"_id":"source/images/just-todo.gif","path":"images/just-todo.gif","modified":0,"renderable":0},{"_id":"source/images/keyboard-height.gif","path":"images/keyboard-height.gif","modified":0,"renderable":0},{"_id":"source/images/kotlin-native-starter.jpg","path":"images/kotlin-native-starter.jpg","modified":0,"renderable":0},{"_id":"source/images/linux_ipc.jpg","path":"images/linux_ipc.jpg","modified":0,"renderable":0},{"_id":"source/images/linux_memory.png","path":"images/linux_memory.png","modified":0,"renderable":0},{"_id":"source/images/macOS-App-crash.png","path":"images/macOS-App-crash.png","modified":0,"renderable":0},{"_id":"source/images/mc_build_push.jpg","path":"images/mc_build_push.jpg","modified":0,"renderable":0},{"_id":"source/images/mc_cer_push.png","path":"images/mc_cer_push.png","modified":0,"renderable":0},{"_id":"source/images/mc_create.jpg","path":"images/mc_create.jpg","modified":0,"renderable":0},{"_id":"source/images/mc_publish.jpg","path":"images/mc_publish.jpg","modified":0,"renderable":0},{"_id":"source/images/mc_pwd.png","path":"images/mc_pwd.png","modified":0,"renderable":0},{"_id":"source/images/mc_replay.jpg","path":"images/mc_replay.jpg","modified":0,"renderable":0},{"_id":"source/images/mc_resolved.jpg","path":"images/mc_resolved.jpg","modified":0,"renderable":0},{"_id":"source/images/menu_bar_extra.png","path":"images/menu_bar_extra.png","modified":0,"renderable":0},{"_id":"source/images/my_face.jpeg","path":"images/my_face.jpeg","modified":0,"renderable":0},{"_id":"source/images/my_todo_ui_init.png","path":"images/my_todo_ui_init.png","modified":0,"renderable":0},{"_id":"source/images/net_model.png","path":"images/net_model.png","modified":0,"renderable":0},{"_id":"source/images/normal_popover.png","path":"images/normal_popover.png","modified":0,"renderable":0},{"_id":"source/images/oom_adj.png","path":"images/oom_adj.png","modified":0,"renderable":0},{"_id":"source/images/playground.jpg","path":"images/playground.jpg","modified":0,"renderable":0},{"_id":"source/images/preview.jpg","path":"images/preview.jpg","modified":0,"renderable":0},{"_id":"source/images/process_priority.jpg","path":"images/process_priority.jpg","modified":0,"renderable":0},{"_id":"source/images/request_implementions.jpg","path":"images/request_implementions.jpg","modified":0,"renderable":0},{"_id":"source/images/search.svg","path":"images/search.svg","modified":0,"renderable":0},{"_id":"source/images/sober_my_todo.png","path":"images/sober_my_todo.png","modified":0,"renderable":0},{"_id":"source/images/traditional_ipc.jpg","path":"images/traditional_ipc.jpg","modified":0,"renderable":0},{"_id":"source/images/translator-logo-512.png","path":"images/translator-logo-512.png","modified":0,"renderable":0},{"_id":"source/images/tray_app_hello_world.png","path":"images/tray_app_hello_world.png","modified":0,"renderable":0},{"_id":"source/images/unnormal_popover.png","path":"images/unnormal_popover.png","modified":0,"renderable":0},{"_id":"source/images/xcode-select.jpg","path":"images/xcode-select.jpg","modified":0,"renderable":0}],"Cache":[{"_id":"source/google0c9079771358e13d.html","hash":"a7e81a4d8f67e52bec5881ba79555d3a4c820e5f","modified":1727507314809},{"_id":"source/sitemap.xml","hash":"364e4666fd7cbe0eb3672acf980f71622d2782f8","modified":1727507341977},{"_id":"source/_posts/2022-09-17-ARouter源码分析.md","hash":"40c90194e910b5d433b8c96a8de89b2603311d7a","modified":1731505114523},{"_id":"source/assets/favicon-16x16.png","hash":"618e521e7fcdee391904eb640a5afcee0e1827df","modified":1727248442243},{"_id":"source/assets/favicon-96x96.png","hash":"01a700c5ae676575307a49e447255c1b48c56911","modified":1727248442255},{"_id":"source/assets/favicon-32x32.png","hash":"015aec45aa904c6e3abb5c1c88850b56d75e54d4","modified":1727248442252},{"_id":"source/_posts/2022-09-17-Glide源码分析与自我实现1.md","hash":"9182f07b7703f58e4a3bd30f8090a717a2da0fff","modified":1731505139268},{"_id":"source/_posts/2022-09-17-Glide源码分析与自我实现2.md","hash":"7bae1fa38c8cce59967700742a2ca32e1b2329a8","modified":1731505148753},{"_id":"source/_posts/2022-09-17-Glide源码分析与自我实现3.md","hash":"27683061f83dddfd22031856491a2499fbc2fb91","modified":1731505160779},{"_id":"source/_posts/2022-09-17-Jetpack之Lifecycle源码分析.md","hash":"1f66fc8a047a4ffcb211ceabdb2437803859eafc","modified":1731505169304},{"_id":"source/_posts/2022-09-17-Jetpack之LiveData源码分析.md","hash":"96c64ddd4aa399194c4ca79075a4323d3e8ad8e1","modified":1731505176076},{"_id":"source/_posts/2022-09-17-LeakCanary原理分析.md","hash":"6a2d843fc3e4fc88b83c941f9ade56047aaafd7e","modified":1731505185949},{"_id":"source/_posts/2022-09-17-LiveEventBus源码分析.md","hash":"f2c68b870d2b5a0d609ef5c8d8805ed48c6f119e","modified":1731505196122},{"_id":"source/_posts/2022-09-17-手撸一个路由框架IRouter.md","hash":"a4e8080c6f26ebe2257def41a3ffcea4eb4d807b","modified":1731505208741},{"_id":"source/_posts/2022-09-19-AMS启动流程.md","hash":"33003dc4a11740d1de779a907f22bc9ddec82ca7","modified":1731505238620},{"_id":"source/_posts/2022-09-19-Activity启动流程.md","hash":"f16b2d4b5a3c1284b24159c1fedc9b3506488808","modified":1731505216962},{"_id":"source/_posts/2022-09-19-ASM.md","hash":"c76a42b69581e0b26e8ad76a2937ef9de99ebd64","modified":1731505263298},{"_id":"source/_posts/2022-09-19-App保活术.md","hash":"c5a226da491fad4dd9f486f66518753218e4298c","modified":1731505256523},{"_id":"source/_posts/2022-09-19-Intent.FLAG_ACTIVITY_XXX到底能干啥.md","hash":"c24d3f4ca681f65dfaacecdef810b0dae2757b19","modified":1731553686157},{"_id":"source/_posts/2022-09-19-LaunchMode.md","hash":"90f2986aaaae8135cb6a266f223f777eac624cdd","modified":1731505308898},{"_id":"source/_posts/2022-09-19-Mavencentral.md","hash":"2da61f0f54dda2fe0f99ffb113779af697f796d5","modified":1731505319370},{"_id":"source/_posts/2022-09-19-Apk瘦身术.md","hash":"bd156cb8d555642c3092e8f44a8aaa1936ebd337","modified":1731505249640},{"_id":"source/_posts/2022-09-19-Binder机制分析.md","hash":"47557437c68babfbfd5b06e502828c6bad93d5a8","modified":1731505283589},{"_id":"source/_posts/2022-09-22-难忘的bug.md","hash":"486463c114f5910150873a994633a2207af1b1f2","modified":1731505340297},{"_id":"source/.DS_Store","hash":"f7fd1d18884df8a6d5637cb6e4f1c2df2f094c47","modified":1727248217323},{"_id":"source/_posts/2022-10-13-clipToXXX.md","hash":"368cd33a53cf2dbbe7bd0f2c19605ea73a65a522","modified":1731505364699},{"_id":"source/_posts/2022-09-23-Kotlin Native.md","hash":"8c5110147dad0e960278bc7a0c73a87ed780e865","modified":1731505350556},{"_id":"source/_posts/2022-11-02-Translator.md","hash":"f39bb15fc4e050d4298e8279214a6d3e057d1862","modified":1731553715470},{"_id":"source/_posts/2023-03-04-Jitpack托管库.md","hash":"abc355bf504acace3564078188be5be69e6e40c7","modified":1727232782292},{"_id":"source/_posts/2023-05-04-难忘的调试技巧.md","hash":"c14976c95b77ccd123c15547da0e58bd988f7114","modified":1727232782294},{"_id":"source/_posts/2023-07-29-软键盘高度监测最佳实践.md","hash":"d6fbe04de2befed350defa808b9d92f0764f00de","modified":1727232782297},{"_id":"source/_posts/2023-11-20-相机录像新姿势-OpenGL共享上下文+MediaCodec.md","hash":"bf3aabf32f175e3fff14c24158030a9adab699f3","modified":1727232782304},{"_id":"source/_posts/2023-11-12-Camera无变形任意尺寸预览.md","hash":"7c495aae140bbe1dff31be90daebef5106c39b00","modified":1727232782300},{"_id":"source/_posts/2023-08-12-J2V8深度绑定机制分享.md","hash":"af63740e652452013602e91c411ad2757b66d978","modified":1727232782298},{"_id":"source/_posts/2024-04-26-MacOS项目中引入c静态库.md","hash":"1e3ff88889ef3938d53a1f2e5255feb5207f4bf2","modified":1727232782307},{"_id":"source/_posts/2024-04-29-MacOS项目引入c语言源码.md","hash":"3c0dac652765ea1c7bcd3fefd41ba32b7e6bbc82","modified":1727232782309},{"_id":"source/_posts/2024-05-08-MacOS SwiftUI托盘应用开发.md","hash":"0494f9c3bcbf589a2461ba1cad882fdaaceb5bd6","modified":1727232782311},{"_id":"source/_posts/2024-05-11-JustTodo开发(一) 项目初始化.md","hash":"ea8990f416b7b285d37e861665e9e5346347d616","modified":1727232782313},{"_id":"source/_posts/2024-05-12-JustTodo开发(二) 界面初始化.md","hash":"d5c89ae5f1e3c72f8bfdab5b0a902da5c2161e0d","modified":1727232782315},{"_id":"source/_posts/2024-05-17-JustTodo开发(三) 更换技术路线，跑步前进.md","hash":"ac4470394fd26e1c566fad7974d8e46ebdbec4dc","modified":1727232782319},{"_id":"source/_posts/2024-05-26-JustTodo开发(五) SwiftUI + web.md","hash":"c4e97a1b16b0f4c52455908c8e820a0c6fb3dacd","modified":1727232782323},{"_id":"source/_posts/2024-06-04-发布Swift Package库.md","hash":"2a8fab5f7fc8e18cb306713faad5a413d19f0e77","modified":1727232782325},{"_id":"source/_posts/2024-06-14-Tray-macOS菜单栏app开发库.md","hash":"ca503fef30c8a524306a5906ed79b70f1de3f207","modified":1727232782327},{"_id":"source/_posts/2024-06-16-面试总结1.md","hash":"b856d64fedf7f4a5887b4e9db16326a439036ed1","modified":1727232782334},{"_id":"source/_posts/2024-09-22-写了一个Hexo主题与插件.md","hash":"288c24cc283c0042938af9816bec3a06d0fa8fde","modified":1727232782352},{"_id":"source/_posts/2024-05-23-JustTodo开发(四) 初版完成.md","hash":"ccf0a80a07814985b5e7080f08fd1a8d669dbae2","modified":1727232782321},{"_id":"source/_posts/hello-world.md","hash":"7d98d6592de80fdcd2949bd7401cec12afd98cdf","modified":1727232782361},{"_id":"source/images/4179925-32ee7bd0974a4679.webp","hash":"5fdfb0b5c499cac0475c92c80d8b5be23d869327","modified":1727232798674},{"_id":"source/images/4179925-8c703df0b005aae7.webp","hash":"b415ef84a48ab432ce4e37a67d3c54fb6230bb86","modified":1727232798672},{"_id":"source/images/4179925-a718d240e05a2198.webp","hash":"93fb0fbb7e80ed4ef018f92aee8acbe3d4744767","modified":1727232798676},{"_id":"source/images/4179925-d4f950ec94a12cde.webp","hash":"360f383a07df52841e903eb8be377849efe63b12","modified":1727232798679},{"_id":"source/images/4179925-e2e730e41623be28.webp","hash":"26752200cf7a78b368f9a42391fc1e9309997099","modified":1727232798681},{"_id":"source/images/4179925-af582100631d7eec.webp","hash":"1d42ed4533a6066850ed1aad571442d235fa7277","modified":1727232798677},{"_id":"source/images/apple-touch-icon-300x300.jpg","hash":"b109526f061bb095ac80f4009848d71b6a5c1799","modified":1727232798688},{"_id":"source/images/binder_data_trans.jpg","hash":"f8d277ca4d20af9c1a9691b9de8d02875752b68c","modified":1727232798690},{"_id":"source/images/client_server_service_manager.jpg","hash":"2e6f8a81f85a0300770ba872db8c4149a9580726","modified":1727232798694},{"_id":"source/images/ezgif-6-73b502b11e16.jpg","hash":"293f7545de3735a9c87977288084fe2791ae4b2e","modified":1727232798704},{"_id":"source/images/favicon-32x32.png","hash":"015aec45aa904c6e3abb5c1c88850b56d75e54d4","modified":1727232798707},{"_id":"source/images/favicon-96x96.png","hash":"01a700c5ae676575307a49e447255c1b48c56911","modified":1727232798711},{"_id":"source/images/favicon.svg","hash":"fd1617505a3aa939beaea9b9dce49b587ebf3d2d","modified":1727232798713},{"_id":"source/images/favicon-16x16.png","hash":"618e521e7fcdee391904eb640a5afcee0e1827df","modified":1727232798705},{"_id":"source/images/getNumber.png","hash":"0ba10affe6517ade100a4ddf9a1deb0d9805e427","modified":1727232798717},{"_id":"source/images/gif.webp","hash":"46111574995ed72ee8949e13fd5d4dd8dc5004ac","modified":1727232798724},{"_id":"source/images/gif_after_optimization.png","hash":"34702fa3776daca783e662e67ac913b27f0ea465","modified":1727232798719},{"_id":"source/images/gif_before_optimization.png","hash":"1152538c1414ae1bfe24c12f676d58eea7586756","modified":1727232798722},{"_id":"source/images/jitpack.png","hash":"633451dead176bb2802317d27c794495bf4c3ffc","modified":1727232798730},{"_id":"source/images/linux_memory.png","hash":"45c233172da59f1386edd3bb7567a1fa37721428","modified":1727232798745},{"_id":"source/images/my_face.jpeg","hash":"48ba48ce5373c648492340c2e02cba366f741f0c","modified":1727232798769},{"_id":"source/images/normal_popover.png","hash":"1d1dd401e8520ccf9f218b75866aa387aa3dc074","modified":1727232798801},{"_id":"source/images/my_todo_ui_init.png","hash":"35817512898acf0133f4e173655a7e06c1db2fbc","modified":1727232798771},{"_id":"source/images/oom_adj.png","hash":"dce29cb9f5d462a52f5e816c2f33d1dad2b5ce87","modified":1727232798806},{"_id":"source/images/playground.jpg","hash":"c36f5625c5a874c7537f60840bad8ad98335b061","modified":1727232798808},{"_id":"source/images/search.svg","hash":"74e01292f5ff20c9252c1b3b6f54cf3a18f91a59","modified":1727232798818},{"_id":"source/images/preview.jpg","hash":"0ca7f124f18d5d4ab78d4f741c5ce6221b83e861","modified":1727232798810},{"_id":"source/images/sober_my_todo.png","hash":"ce0ae20f0ba2a25f5da201d66a5d26447dc5f0bd","modified":1727232798820},{"_id":"source/images/translator-logo-512.png","hash":"126df804480c037d33275c383f38380534c42f4b","modified":1727232798824},{"_id":"source/images/unnormal_popover.png","hash":"f9986b034a10bc18533e8ad81f19c779f1797f21","modified":1727232798828},{"_id":"source/images/tray_app_hello_world.png","hash":"520741f48ef719ad717f930edae84cba04510023","modified":1727232798826},{"_id":"source/images/android_binder.jpg","hash":"37493760a630f10c998c9c208564a38bc39aaf22","modified":1727232798687},{"_id":"source/images/4179925-f5a428b729962860.webp","hash":"e7f12b909fd9eaed28d0c32394569d3b7b6c1c50","modified":1727232798685},{"_id":"source/images/binder.jpg","hash":"a573fd41bc104f928b3ca21b7435b00072ac29e3","modified":1727232798692},{"_id":"source/images/glide_struct.jpg","hash":"f7882b9ad23e69abcede6bfb648550f4d2c3d9b6","modified":1727232798726},{"_id":"source/images/linux_ipc.jpg","hash":"f06a3c6aa83daa173e3ad2f65310b1327f30c006","modified":1727232798743},{"_id":"source/images/macOS-App-crash.png","hash":"2e1c1b36052ab2eacc2b14ca02f13696221dde3d","modified":1727232798747},{"_id":"source/images/request_implementions.jpg","hash":"3435f6bb6261d9b4a96f4d2729b96f83ba3790d9","modified":1727232798814},{"_id":"source/images/process_priority.jpg","hash":"aada1c63d4e8d0c48daa883d9b88039ba038a077","modified":1727232798812},{"_id":"source/images/traditional_ipc.jpg","hash":"61969966ad978ba30f947177d6a637f5e89b6931","modified":1727232798822},{"_id":"source/images/xcode-select.jpg","hash":"17c798c8a595d3ba244a89c120fefcb8ad4a70dd","modified":1727232798832},{"_id":"source/images/4179925-0cc8712718f08ea0.webp","hash":"5dbbc103ee4bb410176301250240131b448c09f1","modified":1727232798669},{"_id":"source/images/forground_service.png","hash":"f37e153d42f48afa0140c52d17afef7ece16c7e6","modified":1727232798715},{"_id":"source/images/jd_loader_manager.jpg","hash":"6896c7533aab7508a4e9804eacbeb00280163b1f","modified":1727232798728},{"_id":"source/images/kotlin-native-starter.jpg","hash":"fad8a024ac6b003d9a087061837fb5478625f749","modified":1727232798741},{"_id":"source/images/mc_build_push.jpg","hash":"4188af5cae1d89336e6bb414540592417e40e0cf","modified":1727232798750},{"_id":"source/images/mc_publish.jpg","hash":"fb0ae474f33b24693ae0c341bf1bda54e532375a","modified":1727232798756},{"_id":"source/images/mc_pwd.png","hash":"b738d236271676ea6929bd9fd4d14ba8360bff49","modified":1727232798758},{"_id":"source/images/mc_resolved.jpg","hash":"b9558df7a4a2ba7bea0ebc156dd782fca3f1f943","modified":1727232798765},{"_id":"themes/hexober/README.md","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1727232241210},{"_id":"source/images/net_model.png","hash":"2e150de90280ef4c660f355aef8af7a0f102894e","modified":1727232798793},{"_id":"source/images/menu_bar_extra.png","hash":"e4f0301ee77b5e6947f483da1f57b2b1be84d96e","modified":1727232798767},{"_id":"source/images/dest-note-right.gif","hash":"bbcf736f49bf22f95a18f43770881f0efd939ea6","modified":1727232798699},{"_id":"source/images/mc_cer_push.png","hash":"69ee7895a0014ce62629191b2d4cf16fdc308cd4","modified":1727232798753},{"_id":"themes/hexober/_config.yml","hash":"c765feb833ab3b3b0f2dab1ef96c703fc528f8c5","modified":1727232241210},{"_id":"themes/hexober/theme.js","hash":"f2051cd168e27ba22f372b104ca9b0f563f85b75","modified":1727232241220},{"_id":"themes/hexober/layout/head.ejs","hash":"9fd951086522defe78769efe7b4d7423427ba10d","modified":1727507993525},{"_id":"themes/hexober/package.json","hash":"6579e01da1fcb1b6e7618130a31dda4c2c46dd1c","modified":1727232241215},{"_id":"themes/hexober/layout/footer.ejs","hash":"cee12cfa92070c3fdc9450c81ccd11fba650d819","modified":1727506405970},{"_id":"themes/hexober/layout/header.ejs","hash":"7649084f9bb1ab728594aa4289d4c5bedb6b156a","modified":1727232241212},{"_id":"themes/hexober/layout/layout.ejs","hash":"d017fb7ae783da19e6c141962deadbea77cae3d0","modified":1727232241213},{"_id":"themes/hexober/layout/nav.ejs","hash":"73e946cf6023907e72d7fce7451eac075d485347","modified":1727232241213},{"_id":"themes/hexober/layout/post.ejs","hash":"feb8f3aa3b3a18c94304bacf199693f603760d3f","modified":1727232241215},{"_id":"themes/hexober/layout/page.ejs","hash":"65fff5d4484a5edb430b938cbddf5d8b7d4ce3f3","modified":1727232241213},{"_id":"themes/hexober/scripts/svgHelper.js","hash":"48b4e5d97a8da6ac8417e4706df5d70a02f621a5","modified":1727232241216},{"_id":"themes/hexober/layout/index.ejs","hash":"049524db32e07aa83ac46d5e18be7febe8312a87","modified":1727232241212},{"_id":"themes/hexober/source/404.md","hash":"4e872a0cd523ff98fa542459b82c27fe35f129ea","modified":1727232241216},{"_id":"themes/hexober/layout/partials/gallery.ejs","hash":"cfbaee55a34afc26be18289824151f3153f91242","modified":1727232241214},{"_id":"themes/hexober/layout/partials/post_content.ejs","hash":"93a13f627ae9fb9da2e7fd74499ff09c03420053","modified":1727232241214},{"_id":"themes/hexober/layout/partials/post_item.ejs","hash":"0371821940df9c99ac1a02780cea617c5028f249","modified":1727232241215},{"_id":"themes/hexober/layout/partials/index_content.ejs","hash":"33bb8688188c8ed630451d18018b4033cc668eb1","modified":1727232241214},{"_id":"themes/hexober/layout/archive.ejs","hash":"b5f67b3905bfe63fe8f5656ba59f9e30f293ef25","modified":1727232241211},{"_id":"themes/hexober/layout/partials/tag_cat_bar.ejs","hash":"6a84025798fa8bb3668c048fefa7d879c383afa4","modified":1727232241215},{"_id":"themes/hexober/source/css/github-markdown.min.css","hash":"3d2cdfec82d8924d415b3cd831b5019fd7d66d66","modified":1727232241218},{"_id":"themes/hexober/source/css/layout.css","hash":"fccaf65cc0680e13d34ae3458b2c1bec3820bbfc","modified":1731553416456},{"_id":"themes/hexober/source/css/prism-theme-github-light.css","hash":"e990125677199c5db7d8a507c1d55b474c69f777","modified":1727232241219},{"_id":"themes/hexober/source/assets/hexober-icon.svg","hash":"556fa6a996aa310a313109214a53bcac154332e0","modified":1727506402892},{"_id":"themes/hexober/source/assets/ic-category.svg","hash":"c032ec569cd927d55a3d632dc561ad549539f8cc","modified":1727232241217},{"_id":"themes/hexober/source/assets/ic-date.svg","hash":"bcd6b6e5b0e250b078c82d0c421d7d0abb0af15b","modified":1727232241217},{"_id":"themes/hexober/source/assets/ic-tag.svg","hash":"0aa4f5562cae66644198203446edd7b520dfe713","modified":1727232241217},{"_id":"themes/hexober/source/assets/ic-theme-dark.svg","hash":"c7cfcdf679c72a4f7ae173680ab67ea87a386370","modified":1727232241217},{"_id":"themes/hexober/source/assets/ic-theme-auto.svg","hash":"c0f251000a24a6b573ecd098b8dcd549f2c07c30","modified":1727232241217},{"_id":"themes/hexober/source/assets/ic-theme-light.svg","hash":"790f72873755fb2e1a075a2c2ee99b5839327d63","modified":1727232241218},{"_id":"themes/hexober/source/js/color-thief.umd.js","hash":"36f05192bb87facacfc800c28b25fcdc890bad3a","modified":1727232241219},{"_id":"themes/hexober/source/js/prism.js","hash":"cc4a0863a7381b09d369ab5c495563814e4424e2","modified":1727232241220},{"_id":"themes/hexober/source/js/layout.js","hash":"1ba01bf94acb5b807dcae25529c7463f3ce05f6c","modified":1727232241220},{"_id":"themes/hexober/source/css/prism-theme-github-dark.css","hash":"c4f4fba66ef0ce76c0e6c6afbddf41aab7d90064","modified":1727232241219},{"_id":"source/images/mc_create.jpg","hash":"7d909da0bf201d3f045e0b04fb784c78508d95d3","modified":1727232798754},{"_id":"themes/hexober/source/js/sober.min.js","hash":"42021b2eae2ba38d25626b51a1d75fe147c66765","modified":1727232241220},{"_id":"source/images/dest-note.gif","hash":"b0dabe2fa9ce9761da5733bcf3c361be10439d9e","modified":1727232798701},{"_id":"source/images/mc_replay.jpg","hash":"3a927929c1e0cd4f536eb061c9517a86585b6664","modified":1727232798760},{"_id":"source/images/keyboard-height.gif","hash":"9d27fe0fe134f731fc1e5930e103a03de5fbf243","modified":1727232798739},{"_id":"source/images/just-todo.gif","hash":"90bc8821909af748021864120d1e1d6da9ec6d27","modified":1727232798734},{"_id":"public/2024/09/25/2022-11-02-Translator/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1727508151173},{"_id":"public/google0c9079771358e13d.html","hash":"83fb551eb5b7ae4c902e2514f55083d120050d4f","modified":1727508151173},{"_id":"public/2024/09/25/hello-world/index.html","hash":"13ef87aaebb5b630854710213f568c063ac80b4f","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-22-难忘的bug/index.html","hash":"c182c3f84e8bef265e1686cd2597a952c7e44884","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-19-LaunchMode/index.html","hash":"87fbd6a2da7c8aab49133cc9f87845fabed3fc13","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-19-Binder机制分析/index.html","hash":"8fd367b52107f61cfc6b9b0c335a36632be854a0","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-23-Kotlin Native/index.html","hash":"aef0a76cbcfec2a3b25d71b5b4fef365beca7f5b","modified":1727508151173},{"_id":"public/2024/09/25/2022-10-13-clipToXXX/index.html","hash":"cb30cb54e78f661c38e806fe2981120ec02ce738","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-19-ASM/index.html","hash":"6907a940eefab961a9115dfa6c22d91372f51635","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-19-App保活术/index.html","hash":"0c30e207e25dd3a3187afe622ad65859200cde77","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-19-Mavencentral/index.html","hash":"9ce17b53d82844b183aec92b588595504c4d97db","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-19-Apk瘦身术/index.html","hash":"4ecb40449e7afcb7e2671c4aeceb3d4e428d0ae7","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-19-AMS启动流程/index.html","hash":"5bb5ae956d8e3c8eaa543861f4541aebadcc2968","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-19-Activity启动流程/index.html","hash":"c028b29284dc54c4d4a27279211856aac97b9bc1","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-17-LiveEventBus源码分析/index.html","hash":"112079f99d79db41bea33a3c3890beac9c24872c","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-17-手撸一个路由框架IRouter/index.html","hash":"036f14a4729789414ee8e0dbb19b71b8bac187f1","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-17-LeakCanary原理分析/index.html","hash":"ca0b9319be303c55d5303268d275dc1ffe5bbef8","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-17-Jetpack之Lifecycle源码分析/index.html","hash":"1996515872ed351f600e5a22c0f331549e8b2ffe","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-17-Jetpack之LiveData源码分析/index.html","hash":"1aaeefacdf5d3c575e63ee2742b44aaafaa4d290","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-17-Glide源码分析与自我实现2/index.html","hash":"4289786407c700b171d94aa613c26d546458a37c","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-17-Glide源码分析与自我实现1/index.html","hash":"c268194534654cb48f6157faf999594582f8e423","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-17-ARouter源码分析/index.html","hash":"04163fe041a34a418807a9326c026852c3847f4c","modified":1727508151173},{"_id":"public/2024/09/25/2022-09-17-Glide源码分析与自我实现3/index.html","hash":"d85956cc42cb15a0f1dd35ef7d1a63f37ecd411b","modified":1727508151173},{"_id":"public/2024/09/22/2024-09-22-写了一个Hexo主题与插件/index.html","hash":"e1d48496450c90414018d3e93adb91c56b9756c4","modified":1727508151173},{"_id":"public/2024/06/16/2024-06-16-面试总结1/index.html","hash":"1af59c00fec09e8a92f6eeda36cf2d4d147c9f8e","modified":1727508151173},{"_id":"public/2024/06/14/2024-06-14-Tray-macOS菜单栏app开发库/index.html","hash":"1454bad8eaa99b1fce4dbd51660333f2165104dd","modified":1727508151173},{"_id":"public/2024/06/04/2024-06-04-发布Swift Package库/index.html","hash":"9d6ee8bef1381c445c65d347165c3d70d6e33893","modified":1727508151173},{"_id":"public/2024/05/26/2024-05-26-JustTodo开发(五) SwiftUI + web/index.html","hash":"9619d44d107f28c47d1b6bfc58303c636e5fff6b","modified":1727508151173},{"_id":"public/2024/05/23/2024-05-23-JustTodo开发(四) 初版完成/index.html","hash":"a3b5e3c42a14e9c34d8a9c9264bd65beb5d7b1b0","modified":1727508151173},{"_id":"public/2024/05/17/2024-05-17-JustTodo开发(三) 更换技术路线，跑步前进/index.html","hash":"90ac8d115dc86031726248cdd96acb535969e583","modified":1727508151173},{"_id":"public/2024/05/12/2024-05-12-JustTodo开发(二) 界面初始化/index.html","hash":"187b8db2551360aa5dec3f544bad73b36a3ce698","modified":1727508151173},{"_id":"public/2024/05/11/2024-05-11-JustTodo开发(一) 项目初始化/index.html","hash":"89bd5f85a444a360aeb2d748261a525ffc6c03eb","modified":1727508151173},{"_id":"public/2024/05/08/2024-05-08-MacOS SwiftUI托盘应用开发/index.html","hash":"bbce12f5a91b5493959fa69764ce88435c0f983a","modified":1727508151173},{"_id":"public/2024/04/29/2024-04-29-MacOS项目引入c语言源码/index.html","hash":"e071586b82fc1a61ca14af38e965f4e723d6437a","modified":1727508151173},{"_id":"public/2024/04/26/2024-04-26-MacOS项目中引入c静态库/index.html","hash":"1badae7662219fa7a31abfbb3bbcc26a8c9c531b","modified":1727508151173},{"_id":"public/2023/11/20/2023-11-20-相机录像新姿势-OpenGL共享上下文+MediaCodec/index.html","hash":"21bdd37960a6ac4333796578453b8d9305521ce2","modified":1727508151173},{"_id":"public/2023/08/12/2023-08-12-J2V8深度绑定机制分享/index.html","hash":"5b3a5d5047449c646cacd60c801c96d685aa84c9","modified":1727508151173},{"_id":"public/2023/11/12/2023-11-12-Camera无变形任意尺寸预览/index.html","hash":"df96833e5a3730df4dc1e89b3790c68e1e779adb","modified":1727508151173},{"_id":"public/2023/05/04/2023-05-04-难忘的调试技巧/index.html","hash":"f038472d24a60a040b16bf4628701b5b6427c257","modified":1727508151173},{"_id":"public/2023/03/04/2023-03-04-Jitpack托管库/index.html","hash":"492069857829594e8bf68fcfb7e12c74a352c8c8","modified":1727508151173},{"_id":"public/2023/07/29/2023-07-29-软键盘高度监测最佳实践/index.html","hash":"c47a558ead87842ddd62717634e36f1554bc00da","modified":1727508151173},{"_id":"public/2022/09/19/2022-09-19-Intent.FLAG_ACTIVITY_XXX到底能干啥/index.html","hash":"a7e75febc2f55e749704e7484f5499e5fe3e6fd1","modified":1727508151173},{"_id":"public/archives/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/page/2/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/page/3/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/page/4/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/page/5/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2022/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2022/09/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2023/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2023/03/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2023/05/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2023/07/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2023/08/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2023/11/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2024/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2024/page/2/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2024/page/3/index.html","hash":"54c26955c118425f6dc512c96d472cfeca3eeaf7","modified":1727508151173},{"_id":"public/archives/2024/page/4/index.html","hash":"54c26955c118425f6dc512c96d472cfeca3eeaf7","modified":1727508151173},{"_id":"public/archives/2024/04/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2024/05/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2024/06/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2024/09/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2024/09/page/2/index.html","hash":"54c26955c118425f6dc512c96d472cfeca3eeaf7","modified":1727508151173},{"_id":"public/archives/2024/09/page/3/index.html","hash":"54c26955c118425f6dc512c96d472cfeca3eeaf7","modified":1727508151173},{"_id":"public/categories/源码分析/index.html","hash":"f32b6315e10ba8ab61dc4dd7251e2e339e20f690","modified":1731553615303},{"_id":"public/categories/Android技巧/index.html","hash":"57050a17280eb53fc2bb262d5246b08cedf26e05","modified":1731553615303},{"_id":"public/categories/Android技巧/page/2/index.html","hash":"57050a17280eb53fc2bb262d5246b08cedf26e05","modified":1731553615303},{"_id":"public/categories/Kotlin-Native/index.html","hash":"ff34a0ad5fbb3b7e7b482a90d034dc24a4571438","modified":1731553615303},{"_id":"public/categories/陷阱与缺陷/index.html","hash":"cf92cd2a7bf4048da491ba09e01ec59b011afdf3","modified":1731553615303},{"_id":"public/categories/Translator/index.html","hash":"319673b5c05780e5bca44574dfe5f5943b95dedc","modified":1731553615303},{"_id":"public/categories/独立开发笔记/index.html","hash":"6c42538d123dc43b698a965ccde7581ede1befef","modified":1731553615303},{"_id":"public/categories/面试笔记/index.html","hash":"093f1650ffc4fd0b0e8ec800eef13bdfa274057d","modified":1731553615303},{"_id":"public/index.html","hash":"c291b3dbd08f8041f8192d0ca8f4683cc32692a8","modified":1731553615303},{"_id":"public/page/2/index.html","hash":"d2eff0ce3ba8760a5675fb427d00d43361b08220","modified":1731553615303},{"_id":"public/page/3/index.html","hash":"1aff3b2dca54bdec315f5aa2d4d9d3bda47092a5","modified":1731553615303},{"_id":"public/page/5/index.html","hash":"07ccdb6200ea74a9014b4c2f97c22998cc99fcd5","modified":1731553615303},{"_id":"public/page/4/index.html","hash":"9a2406db1e81dc7793dd5c6c33ecc8aa3263116a","modified":1731553615303},{"_id":"public/tags/Android/index.html","hash":"7c447cbdd995fcebb67f8de88d6b7d9836e9d395","modified":1731553615303},{"_id":"public/tags/Android/page/2/index.html","hash":"7c447cbdd995fcebb67f8de88d6b7d9836e9d395","modified":1731553615303},{"_id":"public/tags/Android/page/3/index.html","hash":"7c447cbdd995fcebb67f8de88d6b7d9836e9d395","modified":1731553615303},{"_id":"public/tags/Kotlin/index.html","hash":"4f7cbbc1c5fb24bebf6da2815fdff1d38db19a37","modified":1731553615303},{"_id":"public/tags/陷阱与缺陷/index.html","hash":"67b2cd2cd72de8ab19d6ed46b9234c9a5f24a836","modified":1731553615303},{"_id":"public/tags/Translator/index.html","hash":"e749f69d9ed983d5af6a6e1619122535bf48408f","modified":1731553615303},{"_id":"public/tags/J2V8/index.html","hash":"06e6c16340f63f9d243971c5c4070e73a9a97253","modified":1731553615303},{"_id":"public/tags/Camera/index.html","hash":"6a23c355993f3f233d1d3ae528efe698da2cfce2","modified":1731553615303},{"_id":"public/tags/macOS/index.html","hash":"6b4acffb7b251000467e56a3f99d844d4ef8b04c","modified":1731553615303},{"_id":"public/tags/静态库/index.html","hash":"b9f25fa24835b5728371fb0e5bb172c10e2107ae","modified":1731553615303},{"_id":"public/tags/JustTodo/index.html","hash":"e17322d29408744888bb5c49c5a4f9cb70bf1e11","modified":1731553615303},{"_id":"public/tags/Hexo/index.html","hash":"3f03cf1a415008e31ac1616389889dd3cc2bfd8f","modified":1731553615303},{"_id":"public/tags/面试/index.html","hash":"3ce78af1c0ffbc8e21c42902163360dfbdb9c2e4","modified":1731553615303},{"_id":"public/assets/hexober-icon.svg","hash":"556fa6a996aa310a313109214a53bcac154332e0","modified":1727508151173},{"_id":"public/assets/ic-date.svg","hash":"bcd6b6e5b0e250b078c82d0c421d7d0abb0af15b","modified":1727508151173},{"_id":"public/assets/ic-category.svg","hash":"c032ec569cd927d55a3d632dc561ad549539f8cc","modified":1727508151173},{"_id":"public/assets/ic-tag.svg","hash":"0aa4f5562cae66644198203446edd7b520dfe713","modified":1727508151173},{"_id":"public/assets/ic-theme-light.svg","hash":"790f72873755fb2e1a075a2c2ee99b5839327d63","modified":1727508151173},{"_id":"public/assets/ic-theme-auto.svg","hash":"c0f251000a24a6b573ecd098b8dcd549f2c07c30","modified":1727508151173},{"_id":"public/sitemap.xml","hash":"364e4666fd7cbe0eb3672acf980f71622d2782f8","modified":1727508151173},{"_id":"public/assets/favicon-16x16.png","hash":"618e521e7fcdee391904eb640a5afcee0e1827df","modified":1727508151173},{"_id":"public/assets/favicon-32x32.png","hash":"015aec45aa904c6e3abb5c1c88850b56d75e54d4","modified":1727508151173},{"_id":"public/assets/favicon-96x96.png","hash":"01a700c5ae676575307a49e447255c1b48c56911","modified":1727508151173},{"_id":"public/images/4179925-8c703df0b005aae7.webp","hash":"b415ef84a48ab432ce4e37a67d3c54fb6230bb86","modified":1727508151173},{"_id":"public/images/4179925-32ee7bd0974a4679.webp","hash":"5fdfb0b5c499cac0475c92c80d8b5be23d869327","modified":1727508151173},{"_id":"public/images/4179925-af582100631d7eec.webp","hash":"1d42ed4533a6066850ed1aad571442d235fa7277","modified":1727508151173},{"_id":"public/images/4179925-d4f950ec94a12cde.webp","hash":"360f383a07df52841e903eb8be377849efe63b12","modified":1727508151173},{"_id":"public/images/4179925-e2e730e41623be28.webp","hash":"26752200cf7a78b368f9a42391fc1e9309997099","modified":1727508151173},{"_id":"public/images/4179925-a718d240e05a2198.webp","hash":"93fb0fbb7e80ed4ef018f92aee8acbe3d4744767","modified":1727508151173},{"_id":"public/images/client_server_service_manager.jpg","hash":"2e6f8a81f85a0300770ba872db8c4149a9580726","modified":1727508151173},{"_id":"public/images/binder_data_trans.jpg","hash":"f8d277ca4d20af9c1a9691b9de8d02875752b68c","modified":1727508151173},{"_id":"public/images/apple-touch-icon-300x300.jpg","hash":"b109526f061bb095ac80f4009848d71b6a5c1799","modified":1727508151173},{"_id":"public/images/ezgif-6-73b502b11e16.jpg","hash":"293f7545de3735a9c87977288084fe2791ae4b2e","modified":1727508151173},{"_id":"public/images/favicon-16x16.png","hash":"618e521e7fcdee391904eb640a5afcee0e1827df","modified":1727508151173},{"_id":"public/images/favicon-96x96.png","hash":"01a700c5ae676575307a49e447255c1b48c56911","modified":1727508151173},{"_id":"public/images/favicon-32x32.png","hash":"015aec45aa904c6e3abb5c1c88850b56d75e54d4","modified":1727508151173},{"_id":"public/images/favicon.svg","hash":"fd1617505a3aa939beaea9b9dce49b587ebf3d2d","modified":1727508151173},{"_id":"public/images/getNumber.png","hash":"0ba10affe6517ade100a4ddf9a1deb0d9805e427","modified":1727508151173},{"_id":"public/images/gif.webp","hash":"46111574995ed72ee8949e13fd5d4dd8dc5004ac","modified":1727508151173},{"_id":"public/images/gif_after_optimization.png","hash":"34702fa3776daca783e662e67ac913b27f0ea465","modified":1727508151173},{"_id":"public/images/gif_before_optimization.png","hash":"1152538c1414ae1bfe24c12f676d58eea7586756","modified":1727508151173},{"_id":"public/images/jitpack.png","hash":"633451dead176bb2802317d27c794495bf4c3ffc","modified":1727508151173},{"_id":"public/images/linux_memory.png","hash":"45c233172da59f1386edd3bb7567a1fa37721428","modified":1727508151173},{"_id":"public/images/my_face.jpeg","hash":"48ba48ce5373c648492340c2e02cba366f741f0c","modified":1727508151173},{"_id":"public/images/my_todo_ui_init.png","hash":"35817512898acf0133f4e173655a7e06c1db2fbc","modified":1727508151173},{"_id":"public/images/normal_popover.png","hash":"1d1dd401e8520ccf9f218b75866aa387aa3dc074","modified":1727508151173},{"_id":"public/images/oom_adj.png","hash":"dce29cb9f5d462a52f5e816c2f33d1dad2b5ce87","modified":1727508151173},{"_id":"public/images/playground.jpg","hash":"c36f5625c5a874c7537f60840bad8ad98335b061","modified":1727508151173},{"_id":"public/images/preview.jpg","hash":"0ca7f124f18d5d4ab78d4f741c5ce6221b83e861","modified":1727508151173},{"_id":"public/images/search.svg","hash":"74e01292f5ff20c9252c1b3b6f54cf3a18f91a59","modified":1727508151173},{"_id":"public/images/sober_my_todo.png","hash":"ce0ae20f0ba2a25f5da201d66a5d26447dc5f0bd","modified":1727508151173},{"_id":"public/images/translator-logo-512.png","hash":"126df804480c037d33275c383f38380534c42f4b","modified":1727508151173},{"_id":"public/images/tray_app_hello_world.png","hash":"520741f48ef719ad717f930edae84cba04510023","modified":1727508151173},{"_id":"public/images/unnormal_popover.png","hash":"f9986b034a10bc18533e8ad81f19c779f1797f21","modified":1727508151173},{"_id":"public/assets/ic-theme-dark.svg","hash":"c7cfcdf679c72a4f7ae173680ab67ea87a386370","modified":1727508151173},{"_id":"public/images/4179925-f5a428b729962860.webp","hash":"e7f12b909fd9eaed28d0c32394569d3b7b6c1c50","modified":1727508151173},{"_id":"public/images/android_binder.jpg","hash":"37493760a630f10c998c9c208564a38bc39aaf22","modified":1727508151173},{"_id":"public/images/binder.jpg","hash":"a573fd41bc104f928b3ca21b7435b00072ac29e3","modified":1727508151173},{"_id":"public/404.html","hash":"c83538cbe43ded4d14d446138d5c02fe88118b32","modified":1727508151173},{"_id":"public/css/layout.css","hash":"fccaf65cc0680e13d34ae3458b2c1bec3820bbfc","modified":1731553615303},{"_id":"public/css/prism-theme-github-dark.css","hash":"c4f4fba66ef0ce76c0e6c6afbddf41aab7d90064","modified":1727508151173},{"_id":"public/css/prism-theme-github-light.css","hash":"e990125677199c5db7d8a507c1d55b474c69f777","modified":1727508151173},{"_id":"public/js/color-thief.umd.js","hash":"36f05192bb87facacfc800c28b25fcdc890bad3a","modified":1727508151173},{"_id":"public/js/layout.js","hash":"1ba01bf94acb5b807dcae25529c7463f3ce05f6c","modified":1727508151173},{"_id":"public/css/github-markdown.min.css","hash":"3d2cdfec82d8924d415b3cd831b5019fd7d66d66","modified":1727508151173},{"_id":"public/js/prism.js","hash":"cc4a0863a7381b09d369ab5c495563814e4424e2","modified":1727508151173},{"_id":"public/js/sober.min.js","hash":"42021b2eae2ba38d25626b51a1d75fe147c66765","modified":1727508151173},{"_id":"public/images/glide_struct.jpg","hash":"f7882b9ad23e69abcede6bfb648550f4d2c3d9b6","modified":1727508151173},{"_id":"public/images/linux_ipc.jpg","hash":"f06a3c6aa83daa173e3ad2f65310b1327f30c006","modified":1727508151173},{"_id":"public/images/macOS-App-crash.png","hash":"2e1c1b36052ab2eacc2b14ca02f13696221dde3d","modified":1727508151173},{"_id":"public/images/process_priority.jpg","hash":"aada1c63d4e8d0c48daa883d9b88039ba038a077","modified":1727508151173},{"_id":"public/images/request_implementions.jpg","hash":"3435f6bb6261d9b4a96f4d2729b96f83ba3790d9","modified":1727508151173},{"_id":"public/images/traditional_ipc.jpg","hash":"61969966ad978ba30f947177d6a637f5e89b6931","modified":1727508151173},{"_id":"public/images/xcode-select.jpg","hash":"17c798c8a595d3ba244a89c120fefcb8ad4a70dd","modified":1727508151173},{"_id":"public/images/4179925-0cc8712718f08ea0.webp","hash":"5dbbc103ee4bb410176301250240131b448c09f1","modified":1727508151173},{"_id":"public/images/forground_service.png","hash":"f37e153d42f48afa0140c52d17afef7ece16c7e6","modified":1727508151173},{"_id":"public/images/jd_loader_manager.jpg","hash":"6896c7533aab7508a4e9804eacbeb00280163b1f","modified":1727508151173},{"_id":"public/images/kotlin-native-starter.jpg","hash":"fad8a024ac6b003d9a087061837fb5478625f749","modified":1727508151173},{"_id":"public/images/mc_build_push.jpg","hash":"4188af5cae1d89336e6bb414540592417e40e0cf","modified":1727508151173},{"_id":"public/images/mc_publish.jpg","hash":"fb0ae474f33b24693ae0c341bf1bda54e532375a","modified":1727508151173},{"_id":"public/images/mc_pwd.png","hash":"b738d236271676ea6929bd9fd4d14ba8360bff49","modified":1727508151173},{"_id":"public/images/mc_resolved.jpg","hash":"b9558df7a4a2ba7bea0ebc156dd782fca3f1f943","modified":1727508151173},{"_id":"public/images/menu_bar_extra.png","hash":"e4f0301ee77b5e6947f483da1f57b2b1be84d96e","modified":1727508151173},{"_id":"public/images/net_model.png","hash":"2e150de90280ef4c660f355aef8af7a0f102894e","modified":1727508151173},{"_id":"public/images/dest-note-right.gif","hash":"bbcf736f49bf22f95a18f43770881f0efd939ea6","modified":1727508151173},{"_id":"public/images/mc_cer_push.png","hash":"69ee7895a0014ce62629191b2d4cf16fdc308cd4","modified":1727508151173},{"_id":"public/images/mc_create.jpg","hash":"7d909da0bf201d3f045e0b04fb784c78508d95d3","modified":1727508151173},{"_id":"public/images/dest-note.gif","hash":"b0dabe2fa9ce9761da5733bcf3c361be10439d9e","modified":1727508151173},{"_id":"public/images/mc_replay.jpg","hash":"3a927929c1e0cd4f536eb061c9517a86585b6664","modified":1727508151173},{"_id":"public/images/keyboard-height.gif","hash":"9d27fe0fe134f731fc1e5930e103a03de5fbf243","modified":1727508151173},{"_id":"public/images/just-todo.gif","hash":"90bc8821909af748021864120d1e1d6da9ec6d27","modified":1727508151173},{"_id":"public/2022/11/02/2022-11-02-Translator/index.html","hash":"08930c1b076b9f1ad0f74c07cc7726900fada186","modified":1731553719336},{"_id":"public/2022/10/13/2022-10-13-clipToXXX/index.html","hash":"c6d0ae7dee2643a03d358e0a5b3be1495930071e","modified":1731553615303},{"_id":"public/2022/09/23/2022-09-23-Kotlin Native/index.html","hash":"3cd5f42b9dd4d4e931da9d072e26087ce2ca129e","modified":1731553615303},{"_id":"public/2022/09/22/2022-09-22-难忘的bug/index.html","hash":"3d0191a709f26e1e2cc0fce8b15f58c2c5e2fa6b","modified":1731553615303},{"_id":"public/2022/09/19/2022-09-19-Mavencentral/index.html","hash":"de9b5118d57f5ff87e60eeec1fe79021e39be330","modified":1731553615303},{"_id":"public/2022/09/19/2022-09-19-Binder机制分析/index.html","hash":"c254530acefb612be3d620acf2993d2e91cb6fd0","modified":1731553615303},{"_id":"public/2022/09/19/2022-09-19-ASM/index.html","hash":"5fe211fb34041cbc60c1eb519ac845ad17630b7c","modified":1731553615303},{"_id":"public/2022/09/19/2022-09-19-App保活术/index.html","hash":"89e4ed8d8edaffb08d7c7acd7c4d4b6a0bcd6925","modified":1731553615303},{"_id":"public/2022/09/19/2022-09-19-Apk瘦身术/index.html","hash":"b293b79da97ecc648e767440415880b18170d05e","modified":1731553615303},{"_id":"public/2022/09/19/2022-09-19-AMS启动流程/index.html","hash":"8930f4baaa5e1101b241428683d2ed3ef539e891","modified":1731553615303},{"_id":"public/2022/09/19/2022-09-19-Activity启动流程/index.html","hash":"f30c28f90c42052d150e2f8ffb24fde04c7d78ed","modified":1731553615303},{"_id":"public/2022/09/17/2022-09-17-手撸一个路由框架IRouter/index.html","hash":"9861a970d802dcbb49ee37ee8f886f32503cd7b5","modified":1731553615303},{"_id":"public/2022/09/17/2022-09-17-LeakCanary原理分析/index.html","hash":"bb2311ab4477ed1c1d7e7931d69c997b2805a1f9","modified":1731553615303},{"_id":"public/2022/09/17/2022-09-17-LiveEventBus源码分析/index.html","hash":"ff8e23b30edd0e73648e383fd6351c6e9163d3e2","modified":1731553615303},{"_id":"public/2022/09/17/2022-09-17-Jetpack之LiveData源码分析/index.html","hash":"fafd2325bc3fc5a873dc3f49f03a85b078d5d8bb","modified":1731553615303},{"_id":"public/2022/09/17/2022-09-17-Jetpack之Lifecycle源码分析/index.html","hash":"ce4ff8cc2cac45f1c44645bb439f99bad767a7db","modified":1731553615303},{"_id":"public/2022/09/17/2022-09-17-Glide源码分析与自我实现3/index.html","hash":"ed103326cbecc914ab51d009721704e41fd10846","modified":1731553615303},{"_id":"public/2022/09/17/2022-09-17-Glide源码分析与自我实现2/index.html","hash":"0134a43908d6a0d95b9ff89d820760e16f78b83a","modified":1731553615303},{"_id":"public/2022/09/17/2022-09-17-Glide源码分析与自我实现1/index.html","hash":"2d4e030ed53812fe2ed37a049ffad3bee1e9d5d7","modified":1731553615303},{"_id":"public/2022/09/17/2022-09-17-ARouter源码分析/index.html","hash":"3d4fa1a7693615aa0b33756461479fd17f36eb17","modified":1731553615303},{"_id":"public/2022/09/19/2022-09-19-LaunchMode/index.html","hash":"fab1ab0d869017d79c29d31664097d8a9751d5cd","modified":1731553615303},{"_id":"public/archives/2022/page/2/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2022/page/3/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2022/09/page/2/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2022/10/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303},{"_id":"public/archives/2022/11/index.html","hash":"3247a76bea569b3f5fd9b4261c5dc61d87417786","modified":1731553615303}],"Category":[{"name":"源码分析","_id":"cm1ltr0fw0003bji02j179ag8"},{"name":"Android技巧","_id":"cm1ltr0g0000qbji02tp2cwl5"},{"name":"Kotlin Native","_id":"cm1ltr0g2001nbji05nmmgq0a"},{"name":"陷阱与缺陷","_id":"cm1ltr0g3001xbji08n4mca3m"},{"name":"Translator","_id":"cm1ltr0g30026bji0hh19c26i"},{"name":"独立开发笔记","_id":"cm1ltr0g5002pbji0eluthjb4"},{"name":"面试笔记","_id":"cm1ltr0g7003obji066vubhrm"}],"Data":[],"Page":[{"_content":"google-site-verification: google0c9079771358e13d.html","source":"google0c9079771358e13d.html","raw":"google-site-verification: google0c9079771358e13d.html","date":"2024-09-28T07:21:52.058Z","updated":"2024-09-28T07:08:34.809Z","path":"google0c9079771358e13d.html","title":"","comments":1,"layout":"page","_id":"cm1ltr0fs0000bji023bo4m7l","content":"google-site-verification: google0c9079771358e13d.html","excerpt":"","more":"google-site-verification: google0c9079771358e13d.html"}],"Post":[{"layout":"post","title":"Glide源码分析与自我实现(一)——数据加载主流程","author":"boybeak","date":"2022-09-16T17:00:00.000Z","_content":"\n> 本文基于Glide 4.11.0\n\n阅读前请参考[Glide 源码分析解读-基于最新版Glide 4.9.0](https://zhuanlan.zhihu.com/p/60425157)一文，该文章中，将Glide中各个部分的作用分析的非常好了。\n\nGlide几乎是现在做Android图片加载的最佳选择了。如此优秀的一个框架是如何实现的呢？如果让我们自己来实现该怎么做呢？我们就通过自己实现一个低配版Glide的方式，来探究Glide中是如何实现的。\n\n我们就称我们自己低配版Glide为**Slide**。那么Slide要实现哪些功能呢？简单来说，就是**获取图片**+**界面显示**。我们通过先构架大体框架，再分步丰富其中细节的方式，来构建Slide的整体结构。\n\n```mermaid\nflowchart LR;\nA[获取图片] --> C[Slide] --> B[界面显示];\n```\n\n```java\nGlide.with(xxx).load(url).into(iv);\n```\n\n这是Glide一个典型的最为简单的调用过程。那么在这个过程中发生了哪些事情呢？\n\n我们可以通过这个链式调用的返回值发现，有如下过程：\n\n```mermaid\ngraph LR;\nstyle A fill:#aaffcc\nstyle D fill:#ffaa99\nA(Glide) -->|\"with(xxx)\"| B(RequestManager) -->|\"load(xxx)\"| C(RequestBuilder) -->|\"into(iv)\"| D(Target);\n```\n\n## Glide.with(xxx)发生了什么事？\n\n阅读源码发现，`Glide.with(xxx)`的最终实现类是*RequestManagerRetriever.java*类。继续跟踪，我们在这个类中，看到这样一个方法。\n\n```java\n@NonNull\nprivate RequestManager supportFragmentGet(\n  @NonNull Context context,\n  @NonNull FragmentManager fm,\n  @Nullable Fragment parentHint,\n  boolean isParentVisible) {\n  SupportRequestManagerFragment current = getSupportRequestManagerFragment(fm, parentHint);\n  RequestManager requestManager = current.getRequestManager();\n\n  .....\n\n    return requestManager;\n}\n```\n\n重点关注这个getSupportRequestManagerFragment方法。\n\n```java\n//getSupportRequestManagerFragment\n@NonNull\nprivate SupportRequestManagerFragment getSupportRequestManagerFragment(\n  @NonNull final FragmentManager fm, @Nullable Fragment parentHint) {\n  SupportRequestManagerFragment current =\n    (SupportRequestManagerFragment) fm.findFragmentByTag(FRAGMENT_TAG);\n  if (current == null) {\n    current = pendingSupportRequestManagerFragments.get(fm);\n    if (current == null) {\n      current = new SupportRequestManagerFragment();\n      current.setParentFragmentHint(parentHint);\n      pendingSupportRequestManagerFragments.put(fm, current);\n      fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss();\n      handler.obtainMessage(ID_REMOVE_SUPPORT_FRAGMENT_MANAGER, fm).sendToTarget();\n    }\n  }\n  return current;\n}\n```\n\n其实，这里是一个Glide检测到界面生命周期的关键了。**Glide就是通过像当前Activity添加一个一个无UI的Fragment来探测生命周期的**。\n\n> **注意：**在执行了添加fragment的语句`fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss()`后，又马上通过handler发送了一个一个message，这里需要熟悉Handler机制才能理解，简单来说，就是添加fragment操作，实际上也是通过handler执行的，这是一个异步的过程，如何检测到fragment已经添加完成了呢？就是在`commitAllowingStateLoss`后，马上去发送一条指定的消息，利用handler处理message的顺序性，来获知fragment已经添加完成。\n\n经过添加*SupportRequestManagerFragment*后，我们获得了探测当前界面生命周期的能力。\n\n继续阅读`supportFragmentGet`方法代码，**RequestManager**是从**SupportRequestManagerFragment**拿到的，如果拿到的是空，则创建一个，设置到该fragment当中去。\n\n\n\n## RequestManager.load(xxx)发生了什么？\n\n我们以`load(url)`为例，来探究这部分代码。\n\n这个方法，返回的是*RequestBuilder*这个类，看名字就知道，这是一个构建者模式中的Builder类，主要是在添加各种配置项，比如RequestOptions、RequestListener等。\n\n\n\n## RequestBuilder.into(iv)发生了什么？\n\n其实，这里才是真正开始触发发起请求的地方。\n\n### RequestBuilder\n\n我们把`into(ImageView)`方法作为入口，一路跟踪，可以发现最终的实现是如下方法。\n\n```java\nprivate <Y extends Target<TranscodeType>> Y into(\n  @NonNull Y target,\n  @Nullable RequestListener<TranscodeType> targetListener,\n  BaseRequestOptions<?> options,\n  Executor callbackExecutor) {\n  Preconditions.checkNotNull(target);\n  if (!isModelSet) {\n    throw new IllegalArgumentException(\"You must call #load() before calling #into()\");\n  }\n\n  Request request = buildRequest(target, targetListener, options, callbackExecutor);\n\n  Request previous = target.getRequest();\n  if (request.isEquivalentTo(previous)\n      && !isSkipMemoryCacheWithCompletePreviousRequest(options, previous)) {\n    // If the request is completed, beginning again will ensure the result is re-delivered,\n    // triggering RequestListeners and Targets. If the request is failed, beginning again will\n    // restart the request, giving it another chance to complete. If the request is already\n    // running, we can let it continue running without interruption.\n    if (!Preconditions.checkNotNull(previous).isRunning()) {\n      // Use the previous request rather than the new one to allow for optimizations like skipping\n      // setting placeholders, tracking and un-tracking Targets, and obtaining View dimensions\n      // that are done in the individual Request.\n      previous.begin();\n    }\n    return target;\n  }\n\n  requestManager.clear(target);\n  target.setRequest(request);\n  requestManager.track(target, request);\n\n  return target;\n}\n```\n\n这个方法主要是做了以下事情：\n\n1. 是否已经有一个request在处理相同的请求，如果有，则判断是否正在运行，没有正在运行则开始运行；\n2. 如果没有一个request在处理此请求，则对target做一些清理操作，与之前的请求解绑，为当前target设置新的请求，然后requestManager开始追踪这个请求。\n\n接下来我们就按照`requestManager.track(target, request)`这段代码继续追踪。来到RequestManager的track方法。\n\n### RequestManager\n\n```java\nsynchronized void track(@NonNull Target<?> target, @NonNull Request request) {\n  targetTracker.track(target);\n  requestTracker.runRequest(request);\n}\n```\n\n这个方法很简单，只有两个方法。\n\n#### TargetTracker\n\n```java\nprivate final Set<Target<?>> targets =\n      Collections.newSetFromMap(new WeakHashMap<Target<?>, Boolean>());\n\npublic void track(@NonNull Target<?> target) {\n  targets.add(target);\n}\n```\n\n这里把一个target存放在WeakHashMap中，因为target是与生命周期有关的东西，比如ImageView对应的**ImageViewTarget**，所以这么做是为了防止内存泄漏。\n\n#### RequestTracker\n\n```java\n/** Starts tracking the given request. */\npublic void runRequest(@NonNull Request request) {\n  requests.add(request);\n  if (!isPaused) {\n    request.begin();\n  } else {\n    request.clear();\n    if (Log.isLoggable(TAG, Log.VERBOSE)) {\n      Log.v(TAG, \"Paused, delaying request\");\n    }\n    pendingRequests.add(request);\n  }\n}\n```\n\n这里是将暂停的request加入到pendingRequests中去，如果不是暂停的request，则调用其begin方法。\n\n我们查看*Request*类的子类，可以看到下图。\n\n![request_implementions](/images/request_implementions.jpg)\n\n可以看到一共有4个类实现了*Request*类，其中*FakeRequest*类是用于测试的，不去考虑。其他三个类的作用如下：\n\n1. **ThumbnailRequestCoordinator:** 用来加载thumbnail；\n2. **ErrorRequestCoordinator:** 用来加载错误时候，展示错误状态； \n3. **SingleRequest:** 这才是用来加载目标图片的request。\n\n我们重点去看SingleRequest的begin方法。\n\n### SingleRequest\n\n```java\npublic void begin() {\n  synchronized (requestLock) {\n    assertNotCallingCallbacks();\n    stateVerifier.throwIfRecycled();\n    startTime = LogTime.getLogTime();\n    if (model == null) {\n      if (Util.isValidDimensions(overrideWidth, overrideHeight)) {\n        width = overrideWidth;\n        height = overrideHeight;\n      }\n      // Only log at more verbose log levels if the user has set a fallback drawable, because\n      // fallback Drawables indicate the user expects null models occasionally.\n      int logLevel = getFallbackDrawable() == null ? Log.WARN : Log.DEBUG;\n      onLoadFailed(new GlideException(\"Received null model\"), logLevel);\n      return;\n    }\n\n    if (status == Status.RUNNING) {\n      throw new IllegalArgumentException(\"Cannot restart a running request\");\n    }\n\n    // If we're restarted after we're complete (usually via something like a notifyDataSetChanged\n    // that starts an identical request into the same Target or View), we can simply use the\n    // resource and size we retrieved the last time around and skip obtaining a new size, starting\n    // a new load etc. This does mean that users who want to restart a load because they expect\n    // that the view size has changed will need to explicitly clear the View or Target before\n    // starting the new load.\n    if (status == Status.COMPLETE) {\n      onResourceReady(\n        resource, DataSource.MEMORY_CACHE, /* isLoadedFromAlternateCacheKey= */ false);\n      return;\n    }\n\n    // Restarts for requests that are neither complete nor running can be treated as new requests\n    // and can run again from the beginning.\n\n    status = Status.WAITING_FOR_SIZE;\n    if (Util.isValidDimensions(overrideWidth, overrideHeight)) {\n      onSizeReady(overrideWidth, overrideHeight);\n    } else {\n      target.getSize(this);\n    }\n\n    if ((status == Status.RUNNING || status == Status.WAITING_FOR_SIZE)\n        && canNotifyStatusChanged()) {\n      target.onLoadStarted(getPlaceholderDrawable());\n    }\n    if (IS_VERBOSE_LOGGABLE) {\n      logV(\"finished run method in \" + LogTime.getElapsedMillis(startTime));\n    }\n  }\n}\n```\n\n代码虽长，但是结构简单。主要做了以下事情：\n\n1. 检查model是否是空，model就是要加载的数据来源，比如url、resourceId、File等；\n2. 判断request状态，不能重新开始一个正在运行的请求；\n3. 判断request状态，如果是已经完成的请求，则说明资源已经存在，直接调用`onResourceReady`方法并返回；\n4. 接下来就来到判断target尺寸的过程了，如果target尺寸已经确定，比如view尺寸measure结束后，则调用`onSizeReady`方法，**注意：实际的网络请求就在这个onSizeReady方法中，因为只有target的尺寸确定了，才能进行请求并处理图片；**\n5. 如果尺寸未确定，则调用`target.getSize`方法去监听尺寸事件，具体可以参考`ViewTarget#getSize`方法，这是一个通过onPreDrawListener来监听尺寸的；\n6. 接下来回调`onLoadStarted`方法，并且显示加载过程状态。\n\n我们着重看网络请求那个分支，也就是`onSizeReady`方法。\n\n```java\n@Override\npublic void onSizeReady(int width, int height) {\n  ......\n\tloadStatus = engine.load(\n    glideContext,\n    model,\n    requestOptions.getSignature(),\n    this.width,\n    this.height,\n    requestOptions.getResourceClass(),\n    transcodeClass,\n    priority,\n    requestOptions.getDiskCacheStrategy(),\n    requestOptions.getTransformations(),\n    requestOptions.isTransformationRequired(),\n    requestOptions.isScaleOnlyOrNoTransform(),\n    requestOptions.getOptions(),\n    requestOptions.isMemoryCacheable(),\n    requestOptions.getUseUnlimitedSourceGeneratorsPool(),\n    requestOptions.getUseAnimationPool(),\n    requestOptions.getOnlyRetrieveFromCache(),\n    this,\n    callbackExecutor\n  );\n  ...\n}\n```\n\n关键代码来了！这个`engine`就是Glide的核心。这个engine是在Glide初始化时候生成的一个实例。\n\n### Engine\n\nEngine不只是用于加载图片，而是一个任务执行核心引擎，它要执行的不只是请求远程图片的任务，包括解码任务等，它执行的实际上是一个个的job。\n\n跟踪上一阶段中的`engine.load`方法，来到是这个方法的关键部分——调用`waitForExistingOrStartNewJob`。\n\n在这个方法中，主要做了以下事情：\n\n```mermaid\ngraph TD;\nA{{是否有一个job执行相同操作}} --> |有|B[为此job添加新的回调];\nA --> |无|C[添加并执行一个EngineJob];\n```\n\n#### EngineJob.start(decodeJob)\n\n```java\npublic synchronized void start(DecodeJob<R> decodeJob) {\n  this.decodeJob = decodeJob;\n  GlideExecutor executor =\n    decodeJob.willDecodeFromCache() ? diskCacheExecutor : getActiveSourceExecutor();\n  executor.execute(decodeJob);\n}\n```\n\n这里执行的是decodeJob。\n\n> 这里需要着重关注一点，就是`executor.execute(decodeJob)`的时候，就已经通过*GlideExecutor*的sourceExecutor.Builder创建了一个**ThreadPoolExecutor**，也就是在这里实现线程池异步执行任务。**ThreadPoolExecutor**并不是Glide提供的实现，而是在java.util.concurrent包下。\n\n#### DecodeJob\n\nDecodeJob是一个*Runnable*类，所以，我们查看其run方法。\n\n接下来的调用路径参考下图。\n\n```mermaid\ngraph TD;\nsubgraph DecodeJob;\nA(run) --> B[runWrapped] --> C[runGenerators] --> D[getNextGenerator];\nend;\nsubgraph SourceGenerator\nD --> E[startNext] --> F[startNextLoad];\nend;\nsubgraph HttpUrlFetcher\nF --> G[loadData] --> H[loadDataWithRedirects];\nend;\n```\n\n经过这么长的调用链，我们终于来到了网络请求的部分，我们可以看到Glide原生使用的*HttpURLConnection*进行网络请求的。**获取到InputStream后，在SourceGenerator中的cacheData方法进行缓存处理。**\n\n#### 获取到数据后的处理\n\n通过`DataFetcherGenerator.FetcherReadyCallback`可以探知到数据获取成功或者失败，如果获取成功，则在`DecodeJob#onDataFetcherReady`中处理。关键代码如下：\n\n```java\npublic void onDataFetcherReady(\n      Key sourceKey, Object data, DataFetcher<?> fetcher, DataSource dataSource, Key attemptedKey) {\n  .....\n  if (Thread.currentThread() != currentThread) {\n    runReason = RunReason.DECODE_DATA;\n    callback.reschedule(this);\n  } else {\n    .....\n  }\n}\n```\n\n更改任务状态，重新执行此任务，则重新执行到`getNextGenerator`方法，此时则会返回**DataCacheGenerator**来处理从Disk缓存加载的任务。\n\n## 获取图片\n\n首先，图片来源有哪些？\n\n1. 资源图片：drawable, assets, raw, mipmap这些程序中自带的图片；\n2. 本地图片：本地存储设备上的图片；\n3. 远端图片：我们服务器或者来自第三方服务器的图片，通过URL来获取。这就需要**异步网络请求**，请求结束以后，要**缓存**图片，避免重复请求远端图片，造成时间、网络的浪费。\n\n```mermaid\ngraph LR;\nA[Slide];\nB([1. 资源图片]) --> A;\nC([2. 本地图片]) --> A;\nE{缓存是否存在} --> |是,交给Slide|A;\nE --> |否,网络请求|D([3. 远端图片]);\nD -.-> |获取到图片并缓存|E;\n\n```\n\n\n\n那么接下来，要丰富的细节，就来到了**网络请求**和**缓存**了。\n\n\n\n### 网络请求\n\n\n\n### 缓存\n\n","source":"_posts/2022-09-17-Glide源码分析与自我实现1.md","raw":"---\nlayout: post\ntitle: Glide源码分析与自我实现(一)——数据加载主流程\nauthor: boybeak\ncategory: 源码分析\ntags: Android\ndate: 2022-09-17 01:00:00\n---\n\n> 本文基于Glide 4.11.0\n\n阅读前请参考[Glide 源码分析解读-基于最新版Glide 4.9.0](https://zhuanlan.zhihu.com/p/60425157)一文，该文章中，将Glide中各个部分的作用分析的非常好了。\n\nGlide几乎是现在做Android图片加载的最佳选择了。如此优秀的一个框架是如何实现的呢？如果让我们自己来实现该怎么做呢？我们就通过自己实现一个低配版Glide的方式，来探究Glide中是如何实现的。\n\n我们就称我们自己低配版Glide为**Slide**。那么Slide要实现哪些功能呢？简单来说，就是**获取图片**+**界面显示**。我们通过先构架大体框架，再分步丰富其中细节的方式，来构建Slide的整体结构。\n\n```mermaid\nflowchart LR;\nA[获取图片] --> C[Slide] --> B[界面显示];\n```\n\n```java\nGlide.with(xxx).load(url).into(iv);\n```\n\n这是Glide一个典型的最为简单的调用过程。那么在这个过程中发生了哪些事情呢？\n\n我们可以通过这个链式调用的返回值发现，有如下过程：\n\n```mermaid\ngraph LR;\nstyle A fill:#aaffcc\nstyle D fill:#ffaa99\nA(Glide) -->|\"with(xxx)\"| B(RequestManager) -->|\"load(xxx)\"| C(RequestBuilder) -->|\"into(iv)\"| D(Target);\n```\n\n## Glide.with(xxx)发生了什么事？\n\n阅读源码发现，`Glide.with(xxx)`的最终实现类是*RequestManagerRetriever.java*类。继续跟踪，我们在这个类中，看到这样一个方法。\n\n```java\n@NonNull\nprivate RequestManager supportFragmentGet(\n  @NonNull Context context,\n  @NonNull FragmentManager fm,\n  @Nullable Fragment parentHint,\n  boolean isParentVisible) {\n  SupportRequestManagerFragment current = getSupportRequestManagerFragment(fm, parentHint);\n  RequestManager requestManager = current.getRequestManager();\n\n  .....\n\n    return requestManager;\n}\n```\n\n重点关注这个getSupportRequestManagerFragment方法。\n\n```java\n//getSupportRequestManagerFragment\n@NonNull\nprivate SupportRequestManagerFragment getSupportRequestManagerFragment(\n  @NonNull final FragmentManager fm, @Nullable Fragment parentHint) {\n  SupportRequestManagerFragment current =\n    (SupportRequestManagerFragment) fm.findFragmentByTag(FRAGMENT_TAG);\n  if (current == null) {\n    current = pendingSupportRequestManagerFragments.get(fm);\n    if (current == null) {\n      current = new SupportRequestManagerFragment();\n      current.setParentFragmentHint(parentHint);\n      pendingSupportRequestManagerFragments.put(fm, current);\n      fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss();\n      handler.obtainMessage(ID_REMOVE_SUPPORT_FRAGMENT_MANAGER, fm).sendToTarget();\n    }\n  }\n  return current;\n}\n```\n\n其实，这里是一个Glide检测到界面生命周期的关键了。**Glide就是通过像当前Activity添加一个一个无UI的Fragment来探测生命周期的**。\n\n> **注意：**在执行了添加fragment的语句`fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss()`后，又马上通过handler发送了一个一个message，这里需要熟悉Handler机制才能理解，简单来说，就是添加fragment操作，实际上也是通过handler执行的，这是一个异步的过程，如何检测到fragment已经添加完成了呢？就是在`commitAllowingStateLoss`后，马上去发送一条指定的消息，利用handler处理message的顺序性，来获知fragment已经添加完成。\n\n经过添加*SupportRequestManagerFragment*后，我们获得了探测当前界面生命周期的能力。\n\n继续阅读`supportFragmentGet`方法代码，**RequestManager**是从**SupportRequestManagerFragment**拿到的，如果拿到的是空，则创建一个，设置到该fragment当中去。\n\n\n\n## RequestManager.load(xxx)发生了什么？\n\n我们以`load(url)`为例，来探究这部分代码。\n\n这个方法，返回的是*RequestBuilder*这个类，看名字就知道，这是一个构建者模式中的Builder类，主要是在添加各种配置项，比如RequestOptions、RequestListener等。\n\n\n\n## RequestBuilder.into(iv)发生了什么？\n\n其实，这里才是真正开始触发发起请求的地方。\n\n### RequestBuilder\n\n我们把`into(ImageView)`方法作为入口，一路跟踪，可以发现最终的实现是如下方法。\n\n```java\nprivate <Y extends Target<TranscodeType>> Y into(\n  @NonNull Y target,\n  @Nullable RequestListener<TranscodeType> targetListener,\n  BaseRequestOptions<?> options,\n  Executor callbackExecutor) {\n  Preconditions.checkNotNull(target);\n  if (!isModelSet) {\n    throw new IllegalArgumentException(\"You must call #load() before calling #into()\");\n  }\n\n  Request request = buildRequest(target, targetListener, options, callbackExecutor);\n\n  Request previous = target.getRequest();\n  if (request.isEquivalentTo(previous)\n      && !isSkipMemoryCacheWithCompletePreviousRequest(options, previous)) {\n    // If the request is completed, beginning again will ensure the result is re-delivered,\n    // triggering RequestListeners and Targets. If the request is failed, beginning again will\n    // restart the request, giving it another chance to complete. If the request is already\n    // running, we can let it continue running without interruption.\n    if (!Preconditions.checkNotNull(previous).isRunning()) {\n      // Use the previous request rather than the new one to allow for optimizations like skipping\n      // setting placeholders, tracking and un-tracking Targets, and obtaining View dimensions\n      // that are done in the individual Request.\n      previous.begin();\n    }\n    return target;\n  }\n\n  requestManager.clear(target);\n  target.setRequest(request);\n  requestManager.track(target, request);\n\n  return target;\n}\n```\n\n这个方法主要是做了以下事情：\n\n1. 是否已经有一个request在处理相同的请求，如果有，则判断是否正在运行，没有正在运行则开始运行；\n2. 如果没有一个request在处理此请求，则对target做一些清理操作，与之前的请求解绑，为当前target设置新的请求，然后requestManager开始追踪这个请求。\n\n接下来我们就按照`requestManager.track(target, request)`这段代码继续追踪。来到RequestManager的track方法。\n\n### RequestManager\n\n```java\nsynchronized void track(@NonNull Target<?> target, @NonNull Request request) {\n  targetTracker.track(target);\n  requestTracker.runRequest(request);\n}\n```\n\n这个方法很简单，只有两个方法。\n\n#### TargetTracker\n\n```java\nprivate final Set<Target<?>> targets =\n      Collections.newSetFromMap(new WeakHashMap<Target<?>, Boolean>());\n\npublic void track(@NonNull Target<?> target) {\n  targets.add(target);\n}\n```\n\n这里把一个target存放在WeakHashMap中，因为target是与生命周期有关的东西，比如ImageView对应的**ImageViewTarget**，所以这么做是为了防止内存泄漏。\n\n#### RequestTracker\n\n```java\n/** Starts tracking the given request. */\npublic void runRequest(@NonNull Request request) {\n  requests.add(request);\n  if (!isPaused) {\n    request.begin();\n  } else {\n    request.clear();\n    if (Log.isLoggable(TAG, Log.VERBOSE)) {\n      Log.v(TAG, \"Paused, delaying request\");\n    }\n    pendingRequests.add(request);\n  }\n}\n```\n\n这里是将暂停的request加入到pendingRequests中去，如果不是暂停的request，则调用其begin方法。\n\n我们查看*Request*类的子类，可以看到下图。\n\n![request_implementions](/images/request_implementions.jpg)\n\n可以看到一共有4个类实现了*Request*类，其中*FakeRequest*类是用于测试的，不去考虑。其他三个类的作用如下：\n\n1. **ThumbnailRequestCoordinator:** 用来加载thumbnail；\n2. **ErrorRequestCoordinator:** 用来加载错误时候，展示错误状态； \n3. **SingleRequest:** 这才是用来加载目标图片的request。\n\n我们重点去看SingleRequest的begin方法。\n\n### SingleRequest\n\n```java\npublic void begin() {\n  synchronized (requestLock) {\n    assertNotCallingCallbacks();\n    stateVerifier.throwIfRecycled();\n    startTime = LogTime.getLogTime();\n    if (model == null) {\n      if (Util.isValidDimensions(overrideWidth, overrideHeight)) {\n        width = overrideWidth;\n        height = overrideHeight;\n      }\n      // Only log at more verbose log levels if the user has set a fallback drawable, because\n      // fallback Drawables indicate the user expects null models occasionally.\n      int logLevel = getFallbackDrawable() == null ? Log.WARN : Log.DEBUG;\n      onLoadFailed(new GlideException(\"Received null model\"), logLevel);\n      return;\n    }\n\n    if (status == Status.RUNNING) {\n      throw new IllegalArgumentException(\"Cannot restart a running request\");\n    }\n\n    // If we're restarted after we're complete (usually via something like a notifyDataSetChanged\n    // that starts an identical request into the same Target or View), we can simply use the\n    // resource and size we retrieved the last time around and skip obtaining a new size, starting\n    // a new load etc. This does mean that users who want to restart a load because they expect\n    // that the view size has changed will need to explicitly clear the View or Target before\n    // starting the new load.\n    if (status == Status.COMPLETE) {\n      onResourceReady(\n        resource, DataSource.MEMORY_CACHE, /* isLoadedFromAlternateCacheKey= */ false);\n      return;\n    }\n\n    // Restarts for requests that are neither complete nor running can be treated as new requests\n    // and can run again from the beginning.\n\n    status = Status.WAITING_FOR_SIZE;\n    if (Util.isValidDimensions(overrideWidth, overrideHeight)) {\n      onSizeReady(overrideWidth, overrideHeight);\n    } else {\n      target.getSize(this);\n    }\n\n    if ((status == Status.RUNNING || status == Status.WAITING_FOR_SIZE)\n        && canNotifyStatusChanged()) {\n      target.onLoadStarted(getPlaceholderDrawable());\n    }\n    if (IS_VERBOSE_LOGGABLE) {\n      logV(\"finished run method in \" + LogTime.getElapsedMillis(startTime));\n    }\n  }\n}\n```\n\n代码虽长，但是结构简单。主要做了以下事情：\n\n1. 检查model是否是空，model就是要加载的数据来源，比如url、resourceId、File等；\n2. 判断request状态，不能重新开始一个正在运行的请求；\n3. 判断request状态，如果是已经完成的请求，则说明资源已经存在，直接调用`onResourceReady`方法并返回；\n4. 接下来就来到判断target尺寸的过程了，如果target尺寸已经确定，比如view尺寸measure结束后，则调用`onSizeReady`方法，**注意：实际的网络请求就在这个onSizeReady方法中，因为只有target的尺寸确定了，才能进行请求并处理图片；**\n5. 如果尺寸未确定，则调用`target.getSize`方法去监听尺寸事件，具体可以参考`ViewTarget#getSize`方法，这是一个通过onPreDrawListener来监听尺寸的；\n6. 接下来回调`onLoadStarted`方法，并且显示加载过程状态。\n\n我们着重看网络请求那个分支，也就是`onSizeReady`方法。\n\n```java\n@Override\npublic void onSizeReady(int width, int height) {\n  ......\n\tloadStatus = engine.load(\n    glideContext,\n    model,\n    requestOptions.getSignature(),\n    this.width,\n    this.height,\n    requestOptions.getResourceClass(),\n    transcodeClass,\n    priority,\n    requestOptions.getDiskCacheStrategy(),\n    requestOptions.getTransformations(),\n    requestOptions.isTransformationRequired(),\n    requestOptions.isScaleOnlyOrNoTransform(),\n    requestOptions.getOptions(),\n    requestOptions.isMemoryCacheable(),\n    requestOptions.getUseUnlimitedSourceGeneratorsPool(),\n    requestOptions.getUseAnimationPool(),\n    requestOptions.getOnlyRetrieveFromCache(),\n    this,\n    callbackExecutor\n  );\n  ...\n}\n```\n\n关键代码来了！这个`engine`就是Glide的核心。这个engine是在Glide初始化时候生成的一个实例。\n\n### Engine\n\nEngine不只是用于加载图片，而是一个任务执行核心引擎，它要执行的不只是请求远程图片的任务，包括解码任务等，它执行的实际上是一个个的job。\n\n跟踪上一阶段中的`engine.load`方法，来到是这个方法的关键部分——调用`waitForExistingOrStartNewJob`。\n\n在这个方法中，主要做了以下事情：\n\n```mermaid\ngraph TD;\nA{{是否有一个job执行相同操作}} --> |有|B[为此job添加新的回调];\nA --> |无|C[添加并执行一个EngineJob];\n```\n\n#### EngineJob.start(decodeJob)\n\n```java\npublic synchronized void start(DecodeJob<R> decodeJob) {\n  this.decodeJob = decodeJob;\n  GlideExecutor executor =\n    decodeJob.willDecodeFromCache() ? diskCacheExecutor : getActiveSourceExecutor();\n  executor.execute(decodeJob);\n}\n```\n\n这里执行的是decodeJob。\n\n> 这里需要着重关注一点，就是`executor.execute(decodeJob)`的时候，就已经通过*GlideExecutor*的sourceExecutor.Builder创建了一个**ThreadPoolExecutor**，也就是在这里实现线程池异步执行任务。**ThreadPoolExecutor**并不是Glide提供的实现，而是在java.util.concurrent包下。\n\n#### DecodeJob\n\nDecodeJob是一个*Runnable*类，所以，我们查看其run方法。\n\n接下来的调用路径参考下图。\n\n```mermaid\ngraph TD;\nsubgraph DecodeJob;\nA(run) --> B[runWrapped] --> C[runGenerators] --> D[getNextGenerator];\nend;\nsubgraph SourceGenerator\nD --> E[startNext] --> F[startNextLoad];\nend;\nsubgraph HttpUrlFetcher\nF --> G[loadData] --> H[loadDataWithRedirects];\nend;\n```\n\n经过这么长的调用链，我们终于来到了网络请求的部分，我们可以看到Glide原生使用的*HttpURLConnection*进行网络请求的。**获取到InputStream后，在SourceGenerator中的cacheData方法进行缓存处理。**\n\n#### 获取到数据后的处理\n\n通过`DataFetcherGenerator.FetcherReadyCallback`可以探知到数据获取成功或者失败，如果获取成功，则在`DecodeJob#onDataFetcherReady`中处理。关键代码如下：\n\n```java\npublic void onDataFetcherReady(\n      Key sourceKey, Object data, DataFetcher<?> fetcher, DataSource dataSource, Key attemptedKey) {\n  .....\n  if (Thread.currentThread() != currentThread) {\n    runReason = RunReason.DECODE_DATA;\n    callback.reschedule(this);\n  } else {\n    .....\n  }\n}\n```\n\n更改任务状态，重新执行此任务，则重新执行到`getNextGenerator`方法，此时则会返回**DataCacheGenerator**来处理从Disk缓存加载的任务。\n\n## 获取图片\n\n首先，图片来源有哪些？\n\n1. 资源图片：drawable, assets, raw, mipmap这些程序中自带的图片；\n2. 本地图片：本地存储设备上的图片；\n3. 远端图片：我们服务器或者来自第三方服务器的图片，通过URL来获取。这就需要**异步网络请求**，请求结束以后，要**缓存**图片，避免重复请求远端图片，造成时间、网络的浪费。\n\n```mermaid\ngraph LR;\nA[Slide];\nB([1. 资源图片]) --> A;\nC([2. 本地图片]) --> A;\nE{缓存是否存在} --> |是,交给Slide|A;\nE --> |否,网络请求|D([3. 远端图片]);\nD -.-> |获取到图片并缓存|E;\n\n```\n\n\n\n那么接下来，要丰富的细节，就来到了**网络请求**和**缓存**了。\n\n\n\n### 网络请求\n\n\n\n### 缓存\n\n","slug":"2022-09-17-Glide源码分析与自我实现1","published":1,"updated":"2024-11-13T13:38:59.268Z","_id":"cm1ltr0fu0001bji0hv4ze1u6","comments":1,"photos":["/images/request_implementions.jpg"],"content":"<blockquote>\n<p>本文基于Glide 4.11.0</p>\n</blockquote>\n<p>阅读前请参考<a href=\"https://zhuanlan.zhihu.com/p/60425157\">Glide 源码分析解读-基于最新版Glide 4.9.0</a>一文，该文章中，将Glide中各个部分的作用分析的非常好了。</p>\n<p>Glide几乎是现在做Android图片加载的最佳选择了。如此优秀的一个框架是如何实现的呢？如果让我们自己来实现该怎么做呢？我们就通过自己实现一个低配版Glide的方式，来探究Glide中是如何实现的。</p>\n<p>我们就称我们自己低配版Glide为<strong>Slide</strong>。那么Slide要实现哪些功能呢？简单来说，就是<strong>获取图片</strong>+<strong>界面显示</strong>。我们通过先构架大体框架，再分步丰富其中细节的方式，来构建Slide的整体结构。</p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">flowchart</span> LR<span class=\"token punctuation\">;</span>\nA<span class=\"token text string\">[获取图片]</span> <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">[Slide]</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">[界面显示]</span><span class=\"token punctuation\">;</span></code></pre>\n\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token class-name\">Glide</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">with</span><span class=\"token punctuation\">(</span>xxx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span>iv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>这是Glide一个典型的最为简单的调用过程。那么在这个过程中发生了哪些事情呢？</p>\n<p>我们可以通过这个链式调用的返回值发现，有如下过程：</p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> LR<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">style</span> A <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#aaffcc</span>\n<span class=\"token keyword\">style</span> D <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#ffaa99</span>\nA<span class=\"token text string\">(Glide)</span> <span class=\"token arrow operator\">--></span><span class=\"token label property\">|\"with(xxx)\"|</span> B<span class=\"token text string\">(RequestManager)</span> <span class=\"token arrow operator\">--></span><span class=\"token label property\">|\"load(xxx)\"|</span> C<span class=\"token text string\">(RequestBuilder)</span> <span class=\"token arrow operator\">--></span><span class=\"token label property\">|\"into(iv)\"|</span> D<span class=\"token text string\">(Target)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<h2 id=\"Glide-with-xxx-发生了什么事？\"><a href=\"#Glide-with-xxx-发生了什么事？\" class=\"headerlink\" title=\"Glide.with(xxx)发生了什么事？\"></a>Glide.with(xxx)发生了什么事？</h2><p>阅读源码发现，<code>Glide.with(xxx)</code>的最终实现类是<em>RequestManagerRetriever.java</em>类。继续跟踪，我们在这个类中，看到这样一个方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@NonNull</span>\n<span class=\"token keyword\">private</span> <span class=\"token class-name\">RequestManager</span> <span class=\"token function\">supportFragmentGet</span><span class=\"token punctuation\">(</span>\n  <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">,</span>\n  <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">FragmentManager</span> fm<span class=\"token punctuation\">,</span>\n  <span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">Fragment</span> parentHint<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">boolean</span> isParentVisible<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token class-name\">SupportRequestManagerFragment</span> current <span class=\"token operator\">=</span> <span class=\"token function\">getSupportRequestManagerFragment</span><span class=\"token punctuation\">(</span>fm<span class=\"token punctuation\">,</span> parentHint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">RequestManager</span> requestManager <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span><span class=\"token function\">getRequestManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token keyword\">return</span> requestManager<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>重点关注这个getSupportRequestManagerFragment方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">//getSupportRequestManagerFragment</span>\n<span class=\"token annotation punctuation\">@NonNull</span>\n<span class=\"token keyword\">private</span> <span class=\"token class-name\">SupportRequestManagerFragment</span> <span class=\"token function\">getSupportRequestManagerFragment</span><span class=\"token punctuation\">(</span>\n  <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">FragmentManager</span> fm<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">Fragment</span> parentHint<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token class-name\">SupportRequestManagerFragment</span> current <span class=\"token operator\">=</span>\n    <span class=\"token punctuation\">(</span><span class=\"token class-name\">SupportRequestManagerFragment</span><span class=\"token punctuation\">)</span> fm<span class=\"token punctuation\">.</span><span class=\"token function\">findFragmentByTag</span><span class=\"token punctuation\">(</span><span class=\"token constant\">FRAGMENT_TAG</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    current <span class=\"token operator\">=</span> pendingSupportRequestManagerFragments<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>fm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      current <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SupportRequestManagerFragment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      current<span class=\"token punctuation\">.</span><span class=\"token function\">setParentFragmentHint</span><span class=\"token punctuation\">(</span>parentHint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      pendingSupportRequestManagerFragments<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>fm<span class=\"token punctuation\">,</span> current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      fm<span class=\"token punctuation\">.</span><span class=\"token function\">beginTransaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> <span class=\"token constant\">FRAGMENT_TAG</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">commitAllowingStateLoss</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      handler<span class=\"token punctuation\">.</span><span class=\"token function\">obtainMessage</span><span class=\"token punctuation\">(</span><span class=\"token constant\">ID_REMOVE_SUPPORT_FRAGMENT_MANAGER</span><span class=\"token punctuation\">,</span> fm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sendToTarget</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">return</span> current<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>其实，这里是一个Glide检测到界面生命周期的关键了。<strong>Glide就是通过像当前Activity添加一个一个无UI的Fragment来探测生命周期的</strong>。</p>\n<blockquote>\n<p><strong>注意：</strong>在执行了添加fragment的语句<code>fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss()</code>后，又马上通过handler发送了一个一个message，这里需要熟悉Handler机制才能理解，简单来说，就是添加fragment操作，实际上也是通过handler执行的，这是一个异步的过程，如何检测到fragment已经添加完成了呢？就是在<code>commitAllowingStateLoss</code>后，马上去发送一条指定的消息，利用handler处理message的顺序性，来获知fragment已经添加完成。</p>\n</blockquote>\n<p>经过添加<em>SupportRequestManagerFragment</em>后，我们获得了探测当前界面生命周期的能力。</p>\n<p>继续阅读<code>supportFragmentGet</code>方法代码，<strong>RequestManager</strong>是从<strong>SupportRequestManagerFragment</strong>拿到的，如果拿到的是空，则创建一个，设置到该fragment当中去。</p>\n<h2 id=\"RequestManager-load-xxx-发生了什么？\"><a href=\"#RequestManager-load-xxx-发生了什么？\" class=\"headerlink\" title=\"RequestManager.load(xxx)发生了什么？\"></a>RequestManager.load(xxx)发生了什么？</h2><p>我们以<code>load(url)</code>为例，来探究这部分代码。</p>\n<p>这个方法，返回的是<em>RequestBuilder</em>这个类，看名字就知道，这是一个构建者模式中的Builder类，主要是在添加各种配置项，比如RequestOptions、RequestListener等。</p>\n<h2 id=\"RequestBuilder-into-iv-发生了什么？\"><a href=\"#RequestBuilder-into-iv-发生了什么？\" class=\"headerlink\" title=\"RequestBuilder.into(iv)发生了什么？\"></a>RequestBuilder.into(iv)发生了什么？</h2><p>其实，这里才是真正开始触发发起请求的地方。</p>\n<h3 id=\"RequestBuilder\"><a href=\"#RequestBuilder\" class=\"headerlink\" title=\"RequestBuilder\"></a>RequestBuilder</h3><p>我们把<code>into(ImageView)</code>方法作为入口，一路跟踪，可以发现最终的实现是如下方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Y</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Target</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TranscodeType</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">Y</span> <span class=\"token function\">into</span><span class=\"token punctuation\">(</span>\n  <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Y</span> target<span class=\"token punctuation\">,</span>\n  <span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">RequestListener</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TranscodeType</span><span class=\"token punctuation\">></span></span> targetListener<span class=\"token punctuation\">,</span>\n  <span class=\"token class-name\">BaseRequestOptions</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> options<span class=\"token punctuation\">,</span>\n  <span class=\"token class-name\">Executor</span> callbackExecutor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token class-name\">Preconditions</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkNotNull</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isModelSet<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"You must call #load() before calling #into()\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token class-name\">Request</span> request <span class=\"token operator\">=</span> <span class=\"token function\">buildRequest</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> targetListener<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">,</span> callbackExecutor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">Request</span> previous <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span><span class=\"token function\">getRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">isEquivalentTo</span><span class=\"token punctuation\">(</span>previous<span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">isSkipMemoryCacheWithCompletePreviousRequest</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">,</span> previous<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// If the request is completed, beginning again will ensure the result is re-delivered,</span>\n    <span class=\"token comment\">// triggering RequestListeners and Targets. If the request is failed, beginning again will</span>\n    <span class=\"token comment\">// restart the request, giving it another chance to complete. If the request is already</span>\n    <span class=\"token comment\">// running, we can let it continue running without interruption.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token class-name\">Preconditions</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkNotNull</span><span class=\"token punctuation\">(</span>previous<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isRunning</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token comment\">// Use the previous request rather than the new one to allow for optimizations like skipping</span>\n      <span class=\"token comment\">// setting placeholders, tracking and un-tracking Targets, and obtaining View dimensions</span>\n      <span class=\"token comment\">// that are done in the individual Request.</span>\n      previous<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">return</span> target<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  requestManager<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  target<span class=\"token punctuation\">.</span><span class=\"token function\">setRequest</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  requestManager<span class=\"token punctuation\">.</span><span class=\"token function\">track</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> target<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这个方法主要是做了以下事情：</p>\n<ol>\n<li>是否已经有一个request在处理相同的请求，如果有，则判断是否正在运行，没有正在运行则开始运行；</li>\n<li>如果没有一个request在处理此请求，则对target做一些清理操作，与之前的请求解绑，为当前target设置新的请求，然后requestManager开始追踪这个请求。</li>\n</ol>\n<p>接下来我们就按照<code>requestManager.track(target, request)</code>这段代码继续追踪。来到RequestManager的track方法。</p>\n<h3 id=\"RequestManager\"><a href=\"#RequestManager\" class=\"headerlink\" title=\"RequestManager\"></a>RequestManager</h3><pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">track</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Target</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> target<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Request</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  targetTracker<span class=\"token punctuation\">.</span><span class=\"token function\">track</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  requestTracker<span class=\"token punctuation\">.</span><span class=\"token function\">runRequest</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这个方法很简单，只有两个方法。</p>\n<h4 id=\"TargetTracker\"><a href=\"#TargetTracker\" class=\"headerlink\" title=\"TargetTracker\"></a>TargetTracker</h4><pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Target</span><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> targets <span class=\"token operator\">=</span>\n      <span class=\"token class-name\">Collections</span><span class=\"token punctuation\">.</span><span class=\"token function\">newSetFromMap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakHashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Target</span><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">track</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Target</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> target<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  targets<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里把一个target存放在WeakHashMap中，因为target是与生命周期有关的东西，比如ImageView对应的<strong>ImageViewTarget</strong>，所以这么做是为了防止内存泄漏。</p>\n<h4 id=\"RequestTracker\"><a href=\"#RequestTracker\" class=\"headerlink\" title=\"RequestTracker\"></a>RequestTracker</h4><pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">/** Starts tracking the given request. */</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">runRequest</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Request</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  requests<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isPaused<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    request<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    request<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">isLoggable</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token constant\">VERBOSE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Paused, delaying request\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    pendingRequests<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里是将暂停的request加入到pendingRequests中去，如果不是暂停的request，则调用其begin方法。</p>\n<p>我们查看<em>Request</em>类的子类，可以看到下图。</p>\n<p><img src=\"/images/request_implementions.jpg\" alt=\"request_implementions\"></p>\n<p>可以看到一共有4个类实现了<em>Request</em>类，其中<em>FakeRequest</em>类是用于测试的，不去考虑。其他三个类的作用如下：</p>\n<ol>\n<li><strong>ThumbnailRequestCoordinator:</strong> 用来加载thumbnail；</li>\n<li><strong>ErrorRequestCoordinator:</strong> 用来加载错误时候，展示错误状态； </li>\n<li><strong>SingleRequest:</strong> 这才是用来加载目标图片的request。</li>\n</ol>\n<p>我们重点去看SingleRequest的begin方法。</p>\n<h3 id=\"SingleRequest\"><a href=\"#SingleRequest\" class=\"headerlink\" title=\"SingleRequest\"></a>SingleRequest</h3><pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>requestLock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token function\">assertNotCallingCallbacks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    stateVerifier<span class=\"token punctuation\">.</span><span class=\"token function\">throwIfRecycled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    startTime <span class=\"token operator\">=</span> <span class=\"token class-name\">LogTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLogTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>model <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Util</span><span class=\"token punctuation\">.</span><span class=\"token function\">isValidDimensions</span><span class=\"token punctuation\">(</span>overrideWidth<span class=\"token punctuation\">,</span> overrideHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        width <span class=\"token operator\">=</span> overrideWidth<span class=\"token punctuation\">;</span>\n        height <span class=\"token operator\">=</span> overrideHeight<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token comment\">// Only log at more verbose log levels if the user has set a fallback drawable, because</span>\n      <span class=\"token comment\">// fallback Drawables indicate the user expects null models occasionally.</span>\n      <span class=\"token keyword\">int</span> logLevel <span class=\"token operator\">=</span> <span class=\"token function\">getFallbackDrawable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WARN</span> <span class=\"token operator\">:</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token constant\">DEBUG</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">onLoadFailed</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">GlideException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Received null model\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> logLevel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> <span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span><span class=\"token constant\">RUNNING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot restart a running request\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token comment\">// If we're restarted after we're complete (usually via something like a notifyDataSetChanged</span>\n    <span class=\"token comment\">// that starts an identical request into the same Target or View), we can simply use the</span>\n    <span class=\"token comment\">// resource and size we retrieved the last time around and skip obtaining a new size, starting</span>\n    <span class=\"token comment\">// a new load etc. This does mean that users who want to restart a load because they expect</span>\n    <span class=\"token comment\">// that the view size has changed will need to explicitly clear the View or Target before</span>\n    <span class=\"token comment\">// starting the new load.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> <span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span><span class=\"token constant\">COMPLETE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">onResourceReady</span><span class=\"token punctuation\">(</span>\n        resource<span class=\"token punctuation\">,</span> <span class=\"token class-name\">DataSource</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MEMORY_CACHE</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">/* isLoadedFromAlternateCacheKey= */</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token comment\">// Restarts for requests that are neither complete nor running can be treated as new requests</span>\n    <span class=\"token comment\">// and can run again from the beginning.</span>\n\n    status <span class=\"token operator\">=</span> <span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WAITING_FOR_SIZE</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Util</span><span class=\"token punctuation\">.</span><span class=\"token function\">isValidDimensions</span><span class=\"token punctuation\">(</span>overrideWidth<span class=\"token punctuation\">,</span> overrideHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">onSizeReady</span><span class=\"token punctuation\">(</span>overrideWidth<span class=\"token punctuation\">,</span> overrideHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n      target<span class=\"token punctuation\">.</span><span class=\"token function\">getSize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> <span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span><span class=\"token constant\">RUNNING</span> <span class=\"token operator\">||</span> status <span class=\"token operator\">==</span> <span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WAITING_FOR_SIZE</span><span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">canNotifyStatusChanged</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      target<span class=\"token punctuation\">.</span><span class=\"token function\">onLoadStarted</span><span class=\"token punctuation\">(</span><span class=\"token function\">getPlaceholderDrawable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">IS_VERBOSE_LOGGABLE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">logV</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"finished run method in \"</span> <span class=\"token operator\">+</span> <span class=\"token class-name\">LogTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getElapsedMillis</span><span class=\"token punctuation\">(</span>startTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>代码虽长，但是结构简单。主要做了以下事情：</p>\n<ol>\n<li>检查model是否是空，model就是要加载的数据来源，比如url、resourceId、File等；</li>\n<li>判断request状态，不能重新开始一个正在运行的请求；</li>\n<li>判断request状态，如果是已经完成的请求，则说明资源已经存在，直接调用<code>onResourceReady</code>方法并返回；</li>\n<li>接下来就来到判断target尺寸的过程了，如果target尺寸已经确定，比如view尺寸measure结束后，则调用<code>onSizeReady</code>方法，<strong>注意：实际的网络请求就在这个onSizeReady方法中，因为只有target的尺寸确定了，才能进行请求并处理图片；</strong></li>\n<li>如果尺寸未确定，则调用<code>target.getSize</code>方法去监听尺寸事件，具体可以参考<code>ViewTarget#getSize</code>方法，这是一个通过onPreDrawListener来监听尺寸的；</li>\n<li>接下来回调<code>onLoadStarted</code>方法，并且显示加载过程状态。</li>\n</ol>\n<p>我们着重看网络请求那个分支，也就是<code>onSizeReady</code>方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onSizeReady</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> width<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> height<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\tloadStatus <span class=\"token operator\">=</span> engine<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>\n    glideContext<span class=\"token punctuation\">,</span>\n    model<span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">getSignature</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">getResourceClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    transcodeClass<span class=\"token punctuation\">,</span>\n    priority<span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">getDiskCacheStrategy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">getTransformations</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">isTransformationRequired</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">isScaleOnlyOrNoTransform</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">getOptions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">isMemoryCacheable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">getUseUnlimitedSourceGeneratorsPool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">getUseAnimationPool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">getOnlyRetrieveFromCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span>\n    callbackExecutor\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>关键代码来了！这个<code>engine</code>就是Glide的核心。这个engine是在Glide初始化时候生成的一个实例。</p>\n<h3 id=\"Engine\"><a href=\"#Engine\" class=\"headerlink\" title=\"Engine\"></a>Engine</h3><p>Engine不只是用于加载图片，而是一个任务执行核心引擎，它要执行的不只是请求远程图片的任务，包括解码任务等，它执行的实际上是一个个的job。</p>\n<p>跟踪上一阶段中的<code>engine.load</code>方法，来到是这个方法的关键部分——调用<code>waitForExistingOrStartNewJob</code>。</p>\n<p>在这个方法中，主要做了以下事情：</p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\nA<span class=\"token text string\">&#123;&#123;是否有一个job执行相同操作&#125;&#125;</span> <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|有|</span>B<span class=\"token text string\">[为此job添加新的回调]</span><span class=\"token punctuation\">;</span>\nA <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|无|</span>C<span class=\"token text string\">[添加并执行一个EngineJob]</span><span class=\"token punctuation\">;</span></code></pre>\n\n<h4 id=\"EngineJob-start-decodeJob\"><a href=\"#EngineJob-start-decodeJob\" class=\"headerlink\" title=\"EngineJob.start(decodeJob)\"></a>EngineJob.start(decodeJob)</h4><pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DecodeJob</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">></span></span> decodeJob<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>decodeJob <span class=\"token operator\">=</span> decodeJob<span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">GlideExecutor</span> executor <span class=\"token operator\">=</span>\n    decodeJob<span class=\"token punctuation\">.</span><span class=\"token function\">willDecodeFromCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> diskCacheExecutor <span class=\"token operator\">:</span> <span class=\"token function\">getActiveSourceExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  executor<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>decodeJob<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里执行的是decodeJob。</p>\n<blockquote>\n<p>这里需要着重关注一点，就是<code>executor.execute(decodeJob)</code>的时候，就已经通过<em>GlideExecutor</em>的sourceExecutor.Builder创建了一个<strong>ThreadPoolExecutor</strong>，也就是在这里实现线程池异步执行任务。<strong>ThreadPoolExecutor</strong>并不是Glide提供的实现，而是在java.util.concurrent包下。</p>\n</blockquote>\n<h4 id=\"DecodeJob\"><a href=\"#DecodeJob\" class=\"headerlink\" title=\"DecodeJob\"></a>DecodeJob</h4><p>DecodeJob是一个<em>Runnable</em>类，所以，我们查看其run方法。</p>\n<p>接下来的调用路径参考下图。</p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> DecodeJob<span class=\"token punctuation\">;</span>\nA<span class=\"token text string\">(run)</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">[runWrapped]</span> <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">[runGenerators]</span> <span class=\"token arrow operator\">--></span> D<span class=\"token text string\">[getNextGenerator]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> SourceGenerator\nD <span class=\"token arrow operator\">--></span> E<span class=\"token text string\">[startNext]</span> <span class=\"token arrow operator\">--></span> F<span class=\"token text string\">[startNextLoad]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> HttpUrlFetcher\nF <span class=\"token arrow operator\">--></span> G<span class=\"token text string\">[loadData]</span> <span class=\"token arrow operator\">--></span> H<span class=\"token text string\">[loadDataWithRedirects]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>经过这么长的调用链，我们终于来到了网络请求的部分，我们可以看到Glide原生使用的<em>HttpURLConnection</em>进行网络请求的。<strong>获取到InputStream后，在SourceGenerator中的cacheData方法进行缓存处理。</strong></p>\n<h4 id=\"获取到数据后的处理\"><a href=\"#获取到数据后的处理\" class=\"headerlink\" title=\"获取到数据后的处理\"></a>获取到数据后的处理</h4><p>通过<code>DataFetcherGenerator.FetcherReadyCallback</code>可以探知到数据获取成功或者失败，如果获取成功，则在<code>DecodeJob#onDataFetcherReady</code>中处理。关键代码如下：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onDataFetcherReady</span><span class=\"token punctuation\">(</span>\n      <span class=\"token class-name\">Key</span> sourceKey<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> data<span class=\"token punctuation\">,</span> <span class=\"token class-name\">DataFetcher</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> fetcher<span class=\"token punctuation\">,</span> <span class=\"token class-name\">DataSource</span> dataSource<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Key</span> attemptedKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> currentThread<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    runReason <span class=\"token operator\">=</span> <span class=\"token class-name\">RunReason</span><span class=\"token punctuation\">.</span><span class=\"token constant\">DECODE_DATA</span><span class=\"token punctuation\">;</span>\n    callback<span class=\"token punctuation\">.</span><span class=\"token function\">reschedule</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>更改任务状态，重新执行此任务，则重新执行到<code>getNextGenerator</code>方法，此时则会返回<strong>DataCacheGenerator</strong>来处理从Disk缓存加载的任务。</p>\n<h2 id=\"获取图片\"><a href=\"#获取图片\" class=\"headerlink\" title=\"获取图片\"></a>获取图片</h2><p>首先，图片来源有哪些？</p>\n<ol>\n<li>资源图片：drawable, assets, raw, mipmap这些程序中自带的图片；</li>\n<li>本地图片：本地存储设备上的图片；</li>\n<li>远端图片：我们服务器或者来自第三方服务器的图片，通过URL来获取。这就需要<strong>异步网络请求</strong>，请求结束以后，要<strong>缓存</strong>图片，避免重复请求远端图片，造成时间、网络的浪费。</li>\n</ol>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> LR<span class=\"token punctuation\">;</span>\nA<span class=\"token text string\">[Slide]</span><span class=\"token punctuation\">;</span>\nB<span class=\"token text string\">([1. 资源图片])</span> <span class=\"token arrow operator\">--></span> A<span class=\"token punctuation\">;</span>\nC<span class=\"token text string\">([2. 本地图片])</span> <span class=\"token arrow operator\">--></span> A<span class=\"token punctuation\">;</span>\nE<span class=\"token text string\">&#123;缓存是否存在&#125;</span> <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|是,交给Slide|</span>A<span class=\"token punctuation\">;</span>\nE <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|否,网络请求|</span>D<span class=\"token text string\">([3. 远端图片])</span><span class=\"token punctuation\">;</span>\nD <span class=\"token arrow operator\">-.-></span> <span class=\"token label property\">|获取到图片并缓存|</span>E<span class=\"token punctuation\">;</span>\n</code></pre>\n\n\n\n<p>那么接下来，要丰富的细节，就来到了<strong>网络请求</strong>和<strong>缓存</strong>了。</p>\n<h3 id=\"网络请求\"><a href=\"#网络请求\" class=\"headerlink\" title=\"网络请求\"></a>网络请求</h3><h3 id=\"缓存\"><a href=\"#缓存\" class=\"headerlink\" title=\"缓存\"></a>缓存</h3>","excerpt":"","more":"<blockquote>\n<p>本文基于Glide 4.11.0</p>\n</blockquote>\n<p>阅读前请参考<a href=\"https://zhuanlan.zhihu.com/p/60425157\">Glide 源码分析解读-基于最新版Glide 4.9.0</a>一文，该文章中，将Glide中各个部分的作用分析的非常好了。</p>\n<p>Glide几乎是现在做Android图片加载的最佳选择了。如此优秀的一个框架是如何实现的呢？如果让我们自己来实现该怎么做呢？我们就通过自己实现一个低配版Glide的方式，来探究Glide中是如何实现的。</p>\n<p>我们就称我们自己低配版Glide为<strong>Slide</strong>。那么Slide要实现哪些功能呢？简单来说，就是<strong>获取图片</strong>+<strong>界面显示</strong>。我们通过先构架大体框架，再分步丰富其中细节的方式，来构建Slide的整体结构。</p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">flowchart</span> LR<span class=\"token punctuation\">;</span>\nA<span class=\"token text string\">[获取图片]</span> <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">[Slide]</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">[界面显示]</span><span class=\"token punctuation\">;</span></code></pre>\n\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token class-name\">Glide</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">with</span><span class=\"token punctuation\">(</span>xxx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span>iv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>这是Glide一个典型的最为简单的调用过程。那么在这个过程中发生了哪些事情呢？</p>\n<p>我们可以通过这个链式调用的返回值发现，有如下过程：</p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> LR<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">style</span> A <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#aaffcc</span>\n<span class=\"token keyword\">style</span> D <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#ffaa99</span>\nA<span class=\"token text string\">(Glide)</span> <span class=\"token arrow operator\">--></span><span class=\"token label property\">|\"with(xxx)\"|</span> B<span class=\"token text string\">(RequestManager)</span> <span class=\"token arrow operator\">--></span><span class=\"token label property\">|\"load(xxx)\"|</span> C<span class=\"token text string\">(RequestBuilder)</span> <span class=\"token arrow operator\">--></span><span class=\"token label property\">|\"into(iv)\"|</span> D<span class=\"token text string\">(Target)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<h2 id=\"Glide-with-xxx-发生了什么事？\"><a href=\"#Glide-with-xxx-发生了什么事？\" class=\"headerlink\" title=\"Glide.with(xxx)发生了什么事？\"></a>Glide.with(xxx)发生了什么事？</h2><p>阅读源码发现，<code>Glide.with(xxx)</code>的最终实现类是<em>RequestManagerRetriever.java</em>类。继续跟踪，我们在这个类中，看到这样一个方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@NonNull</span>\n<span class=\"token keyword\">private</span> <span class=\"token class-name\">RequestManager</span> <span class=\"token function\">supportFragmentGet</span><span class=\"token punctuation\">(</span>\n  <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">,</span>\n  <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">FragmentManager</span> fm<span class=\"token punctuation\">,</span>\n  <span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">Fragment</span> parentHint<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">boolean</span> isParentVisible<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token class-name\">SupportRequestManagerFragment</span> current <span class=\"token operator\">=</span> <span class=\"token function\">getSupportRequestManagerFragment</span><span class=\"token punctuation\">(</span>fm<span class=\"token punctuation\">,</span> parentHint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">RequestManager</span> requestManager <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span><span class=\"token function\">getRequestManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token keyword\">return</span> requestManager<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>重点关注这个getSupportRequestManagerFragment方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">//getSupportRequestManagerFragment</span>\n<span class=\"token annotation punctuation\">@NonNull</span>\n<span class=\"token keyword\">private</span> <span class=\"token class-name\">SupportRequestManagerFragment</span> <span class=\"token function\">getSupportRequestManagerFragment</span><span class=\"token punctuation\">(</span>\n  <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">FragmentManager</span> fm<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">Fragment</span> parentHint<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token class-name\">SupportRequestManagerFragment</span> current <span class=\"token operator\">=</span>\n    <span class=\"token punctuation\">(</span><span class=\"token class-name\">SupportRequestManagerFragment</span><span class=\"token punctuation\">)</span> fm<span class=\"token punctuation\">.</span><span class=\"token function\">findFragmentByTag</span><span class=\"token punctuation\">(</span><span class=\"token constant\">FRAGMENT_TAG</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    current <span class=\"token operator\">=</span> pendingSupportRequestManagerFragments<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>fm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      current <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SupportRequestManagerFragment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      current<span class=\"token punctuation\">.</span><span class=\"token function\">setParentFragmentHint</span><span class=\"token punctuation\">(</span>parentHint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      pendingSupportRequestManagerFragments<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>fm<span class=\"token punctuation\">,</span> current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      fm<span class=\"token punctuation\">.</span><span class=\"token function\">beginTransaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> <span class=\"token constant\">FRAGMENT_TAG</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">commitAllowingStateLoss</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      handler<span class=\"token punctuation\">.</span><span class=\"token function\">obtainMessage</span><span class=\"token punctuation\">(</span><span class=\"token constant\">ID_REMOVE_SUPPORT_FRAGMENT_MANAGER</span><span class=\"token punctuation\">,</span> fm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sendToTarget</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">return</span> current<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>其实，这里是一个Glide检测到界面生命周期的关键了。<strong>Glide就是通过像当前Activity添加一个一个无UI的Fragment来探测生命周期的</strong>。</p>\n<blockquote>\n<p><strong>注意：</strong>在执行了添加fragment的语句<code>fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss()</code>后，又马上通过handler发送了一个一个message，这里需要熟悉Handler机制才能理解，简单来说，就是添加fragment操作，实际上也是通过handler执行的，这是一个异步的过程，如何检测到fragment已经添加完成了呢？就是在<code>commitAllowingStateLoss</code>后，马上去发送一条指定的消息，利用handler处理message的顺序性，来获知fragment已经添加完成。</p>\n</blockquote>\n<p>经过添加<em>SupportRequestManagerFragment</em>后，我们获得了探测当前界面生命周期的能力。</p>\n<p>继续阅读<code>supportFragmentGet</code>方法代码，<strong>RequestManager</strong>是从<strong>SupportRequestManagerFragment</strong>拿到的，如果拿到的是空，则创建一个，设置到该fragment当中去。</p>\n<h2 id=\"RequestManager-load-xxx-发生了什么？\"><a href=\"#RequestManager-load-xxx-发生了什么？\" class=\"headerlink\" title=\"RequestManager.load(xxx)发生了什么？\"></a>RequestManager.load(xxx)发生了什么？</h2><p>我们以<code>load(url)</code>为例，来探究这部分代码。</p>\n<p>这个方法，返回的是<em>RequestBuilder</em>这个类，看名字就知道，这是一个构建者模式中的Builder类，主要是在添加各种配置项，比如RequestOptions、RequestListener等。</p>\n<h2 id=\"RequestBuilder-into-iv-发生了什么？\"><a href=\"#RequestBuilder-into-iv-发生了什么？\" class=\"headerlink\" title=\"RequestBuilder.into(iv)发生了什么？\"></a>RequestBuilder.into(iv)发生了什么？</h2><p>其实，这里才是真正开始触发发起请求的地方。</p>\n<h3 id=\"RequestBuilder\"><a href=\"#RequestBuilder\" class=\"headerlink\" title=\"RequestBuilder\"></a>RequestBuilder</h3><p>我们把<code>into(ImageView)</code>方法作为入口，一路跟踪，可以发现最终的实现是如下方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Y</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Target</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TranscodeType</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">Y</span> <span class=\"token function\">into</span><span class=\"token punctuation\">(</span>\n  <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Y</span> target<span class=\"token punctuation\">,</span>\n  <span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">RequestListener</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TranscodeType</span><span class=\"token punctuation\">></span></span> targetListener<span class=\"token punctuation\">,</span>\n  <span class=\"token class-name\">BaseRequestOptions</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> options<span class=\"token punctuation\">,</span>\n  <span class=\"token class-name\">Executor</span> callbackExecutor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token class-name\">Preconditions</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkNotNull</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isModelSet<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"You must call #load() before calling #into()\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token class-name\">Request</span> request <span class=\"token operator\">=</span> <span class=\"token function\">buildRequest</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> targetListener<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">,</span> callbackExecutor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">Request</span> previous <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span><span class=\"token function\">getRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">isEquivalentTo</span><span class=\"token punctuation\">(</span>previous<span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">isSkipMemoryCacheWithCompletePreviousRequest</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">,</span> previous<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// If the request is completed, beginning again will ensure the result is re-delivered,</span>\n    <span class=\"token comment\">// triggering RequestListeners and Targets. If the request is failed, beginning again will</span>\n    <span class=\"token comment\">// restart the request, giving it another chance to complete. If the request is already</span>\n    <span class=\"token comment\">// running, we can let it continue running without interruption.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token class-name\">Preconditions</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkNotNull</span><span class=\"token punctuation\">(</span>previous<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isRunning</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token comment\">// Use the previous request rather than the new one to allow for optimizations like skipping</span>\n      <span class=\"token comment\">// setting placeholders, tracking and un-tracking Targets, and obtaining View dimensions</span>\n      <span class=\"token comment\">// that are done in the individual Request.</span>\n      previous<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">return</span> target<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  requestManager<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  target<span class=\"token punctuation\">.</span><span class=\"token function\">setRequest</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  requestManager<span class=\"token punctuation\">.</span><span class=\"token function\">track</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> target<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这个方法主要是做了以下事情：</p>\n<ol>\n<li>是否已经有一个request在处理相同的请求，如果有，则判断是否正在运行，没有正在运行则开始运行；</li>\n<li>如果没有一个request在处理此请求，则对target做一些清理操作，与之前的请求解绑，为当前target设置新的请求，然后requestManager开始追踪这个请求。</li>\n</ol>\n<p>接下来我们就按照<code>requestManager.track(target, request)</code>这段代码继续追踪。来到RequestManager的track方法。</p>\n<h3 id=\"RequestManager\"><a href=\"#RequestManager\" class=\"headerlink\" title=\"RequestManager\"></a>RequestManager</h3><pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">track</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Target</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> target<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Request</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  targetTracker<span class=\"token punctuation\">.</span><span class=\"token function\">track</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  requestTracker<span class=\"token punctuation\">.</span><span class=\"token function\">runRequest</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这个方法很简单，只有两个方法。</p>\n<h4 id=\"TargetTracker\"><a href=\"#TargetTracker\" class=\"headerlink\" title=\"TargetTracker\"></a>TargetTracker</h4><pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Target</span><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> targets <span class=\"token operator\">=</span>\n      <span class=\"token class-name\">Collections</span><span class=\"token punctuation\">.</span><span class=\"token function\">newSetFromMap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakHashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Target</span><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">track</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Target</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> target<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  targets<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里把一个target存放在WeakHashMap中，因为target是与生命周期有关的东西，比如ImageView对应的<strong>ImageViewTarget</strong>，所以这么做是为了防止内存泄漏。</p>\n<h4 id=\"RequestTracker\"><a href=\"#RequestTracker\" class=\"headerlink\" title=\"RequestTracker\"></a>RequestTracker</h4><pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">/** Starts tracking the given request. */</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">runRequest</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Request</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  requests<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isPaused<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    request<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    request<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">isLoggable</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token constant\">VERBOSE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Paused, delaying request\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    pendingRequests<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里是将暂停的request加入到pendingRequests中去，如果不是暂停的request，则调用其begin方法。</p>\n<p>我们查看<em>Request</em>类的子类，可以看到下图。</p>\n<p><img src=\"/images/request_implementions.jpg\" alt=\"request_implementions\"></p>\n<p>可以看到一共有4个类实现了<em>Request</em>类，其中<em>FakeRequest</em>类是用于测试的，不去考虑。其他三个类的作用如下：</p>\n<ol>\n<li><strong>ThumbnailRequestCoordinator:</strong> 用来加载thumbnail；</li>\n<li><strong>ErrorRequestCoordinator:</strong> 用来加载错误时候，展示错误状态； </li>\n<li><strong>SingleRequest:</strong> 这才是用来加载目标图片的request。</li>\n</ol>\n<p>我们重点去看SingleRequest的begin方法。</p>\n<h3 id=\"SingleRequest\"><a href=\"#SingleRequest\" class=\"headerlink\" title=\"SingleRequest\"></a>SingleRequest</h3><pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>requestLock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token function\">assertNotCallingCallbacks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    stateVerifier<span class=\"token punctuation\">.</span><span class=\"token function\">throwIfRecycled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    startTime <span class=\"token operator\">=</span> <span class=\"token class-name\">LogTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLogTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>model <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Util</span><span class=\"token punctuation\">.</span><span class=\"token function\">isValidDimensions</span><span class=\"token punctuation\">(</span>overrideWidth<span class=\"token punctuation\">,</span> overrideHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        width <span class=\"token operator\">=</span> overrideWidth<span class=\"token punctuation\">;</span>\n        height <span class=\"token operator\">=</span> overrideHeight<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token comment\">// Only log at more verbose log levels if the user has set a fallback drawable, because</span>\n      <span class=\"token comment\">// fallback Drawables indicate the user expects null models occasionally.</span>\n      <span class=\"token keyword\">int</span> logLevel <span class=\"token operator\">=</span> <span class=\"token function\">getFallbackDrawable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WARN</span> <span class=\"token operator\">:</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token constant\">DEBUG</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">onLoadFailed</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">GlideException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Received null model\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> logLevel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> <span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span><span class=\"token constant\">RUNNING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot restart a running request\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token comment\">// If we're restarted after we're complete (usually via something like a notifyDataSetChanged</span>\n    <span class=\"token comment\">// that starts an identical request into the same Target or View), we can simply use the</span>\n    <span class=\"token comment\">// resource and size we retrieved the last time around and skip obtaining a new size, starting</span>\n    <span class=\"token comment\">// a new load etc. This does mean that users who want to restart a load because they expect</span>\n    <span class=\"token comment\">// that the view size has changed will need to explicitly clear the View or Target before</span>\n    <span class=\"token comment\">// starting the new load.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> <span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span><span class=\"token constant\">COMPLETE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">onResourceReady</span><span class=\"token punctuation\">(</span>\n        resource<span class=\"token punctuation\">,</span> <span class=\"token class-name\">DataSource</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MEMORY_CACHE</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">/* isLoadedFromAlternateCacheKey= */</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token comment\">// Restarts for requests that are neither complete nor running can be treated as new requests</span>\n    <span class=\"token comment\">// and can run again from the beginning.</span>\n\n    status <span class=\"token operator\">=</span> <span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WAITING_FOR_SIZE</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Util</span><span class=\"token punctuation\">.</span><span class=\"token function\">isValidDimensions</span><span class=\"token punctuation\">(</span>overrideWidth<span class=\"token punctuation\">,</span> overrideHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">onSizeReady</span><span class=\"token punctuation\">(</span>overrideWidth<span class=\"token punctuation\">,</span> overrideHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n      target<span class=\"token punctuation\">.</span><span class=\"token function\">getSize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> <span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span><span class=\"token constant\">RUNNING</span> <span class=\"token operator\">||</span> status <span class=\"token operator\">==</span> <span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WAITING_FOR_SIZE</span><span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">canNotifyStatusChanged</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      target<span class=\"token punctuation\">.</span><span class=\"token function\">onLoadStarted</span><span class=\"token punctuation\">(</span><span class=\"token function\">getPlaceholderDrawable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">IS_VERBOSE_LOGGABLE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">logV</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"finished run method in \"</span> <span class=\"token operator\">+</span> <span class=\"token class-name\">LogTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getElapsedMillis</span><span class=\"token punctuation\">(</span>startTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>代码虽长，但是结构简单。主要做了以下事情：</p>\n<ol>\n<li>检查model是否是空，model就是要加载的数据来源，比如url、resourceId、File等；</li>\n<li>判断request状态，不能重新开始一个正在运行的请求；</li>\n<li>判断request状态，如果是已经完成的请求，则说明资源已经存在，直接调用<code>onResourceReady</code>方法并返回；</li>\n<li>接下来就来到判断target尺寸的过程了，如果target尺寸已经确定，比如view尺寸measure结束后，则调用<code>onSizeReady</code>方法，<strong>注意：实际的网络请求就在这个onSizeReady方法中，因为只有target的尺寸确定了，才能进行请求并处理图片；</strong></li>\n<li>如果尺寸未确定，则调用<code>target.getSize</code>方法去监听尺寸事件，具体可以参考<code>ViewTarget#getSize</code>方法，这是一个通过onPreDrawListener来监听尺寸的；</li>\n<li>接下来回调<code>onLoadStarted</code>方法，并且显示加载过程状态。</li>\n</ol>\n<p>我们着重看网络请求那个分支，也就是<code>onSizeReady</code>方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onSizeReady</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> width<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> height<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\tloadStatus <span class=\"token operator\">=</span> engine<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>\n    glideContext<span class=\"token punctuation\">,</span>\n    model<span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">getSignature</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">getResourceClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    transcodeClass<span class=\"token punctuation\">,</span>\n    priority<span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">getDiskCacheStrategy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">getTransformations</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">isTransformationRequired</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">isScaleOnlyOrNoTransform</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">getOptions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">isMemoryCacheable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">getUseUnlimitedSourceGeneratorsPool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">getUseAnimationPool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requestOptions<span class=\"token punctuation\">.</span><span class=\"token function\">getOnlyRetrieveFromCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span>\n    callbackExecutor\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>关键代码来了！这个<code>engine</code>就是Glide的核心。这个engine是在Glide初始化时候生成的一个实例。</p>\n<h3 id=\"Engine\"><a href=\"#Engine\" class=\"headerlink\" title=\"Engine\"></a>Engine</h3><p>Engine不只是用于加载图片，而是一个任务执行核心引擎，它要执行的不只是请求远程图片的任务，包括解码任务等，它执行的实际上是一个个的job。</p>\n<p>跟踪上一阶段中的<code>engine.load</code>方法，来到是这个方法的关键部分——调用<code>waitForExistingOrStartNewJob</code>。</p>\n<p>在这个方法中，主要做了以下事情：</p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\nA<span class=\"token text string\">&#123;&#123;是否有一个job执行相同操作&#125;&#125;</span> <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|有|</span>B<span class=\"token text string\">[为此job添加新的回调]</span><span class=\"token punctuation\">;</span>\nA <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|无|</span>C<span class=\"token text string\">[添加并执行一个EngineJob]</span><span class=\"token punctuation\">;</span></code></pre>\n\n<h4 id=\"EngineJob-start-decodeJob\"><a href=\"#EngineJob-start-decodeJob\" class=\"headerlink\" title=\"EngineJob.start(decodeJob)\"></a>EngineJob.start(decodeJob)</h4><pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DecodeJob</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">></span></span> decodeJob<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>decodeJob <span class=\"token operator\">=</span> decodeJob<span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">GlideExecutor</span> executor <span class=\"token operator\">=</span>\n    decodeJob<span class=\"token punctuation\">.</span><span class=\"token function\">willDecodeFromCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> diskCacheExecutor <span class=\"token operator\">:</span> <span class=\"token function\">getActiveSourceExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  executor<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>decodeJob<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里执行的是decodeJob。</p>\n<blockquote>\n<p>这里需要着重关注一点，就是<code>executor.execute(decodeJob)</code>的时候，就已经通过<em>GlideExecutor</em>的sourceExecutor.Builder创建了一个<strong>ThreadPoolExecutor</strong>，也就是在这里实现线程池异步执行任务。<strong>ThreadPoolExecutor</strong>并不是Glide提供的实现，而是在java.util.concurrent包下。</p>\n</blockquote>\n<h4 id=\"DecodeJob\"><a href=\"#DecodeJob\" class=\"headerlink\" title=\"DecodeJob\"></a>DecodeJob</h4><p>DecodeJob是一个<em>Runnable</em>类，所以，我们查看其run方法。</p>\n<p>接下来的调用路径参考下图。</p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> DecodeJob<span class=\"token punctuation\">;</span>\nA<span class=\"token text string\">(run)</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">[runWrapped]</span> <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">[runGenerators]</span> <span class=\"token arrow operator\">--></span> D<span class=\"token text string\">[getNextGenerator]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> SourceGenerator\nD <span class=\"token arrow operator\">--></span> E<span class=\"token text string\">[startNext]</span> <span class=\"token arrow operator\">--></span> F<span class=\"token text string\">[startNextLoad]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> HttpUrlFetcher\nF <span class=\"token arrow operator\">--></span> G<span class=\"token text string\">[loadData]</span> <span class=\"token arrow operator\">--></span> H<span class=\"token text string\">[loadDataWithRedirects]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>经过这么长的调用链，我们终于来到了网络请求的部分，我们可以看到Glide原生使用的<em>HttpURLConnection</em>进行网络请求的。<strong>获取到InputStream后，在SourceGenerator中的cacheData方法进行缓存处理。</strong></p>\n<h4 id=\"获取到数据后的处理\"><a href=\"#获取到数据后的处理\" class=\"headerlink\" title=\"获取到数据后的处理\"></a>获取到数据后的处理</h4><p>通过<code>DataFetcherGenerator.FetcherReadyCallback</code>可以探知到数据获取成功或者失败，如果获取成功，则在<code>DecodeJob#onDataFetcherReady</code>中处理。关键代码如下：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onDataFetcherReady</span><span class=\"token punctuation\">(</span>\n      <span class=\"token class-name\">Key</span> sourceKey<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> data<span class=\"token punctuation\">,</span> <span class=\"token class-name\">DataFetcher</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> fetcher<span class=\"token punctuation\">,</span> <span class=\"token class-name\">DataSource</span> dataSource<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Key</span> attemptedKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> currentThread<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    runReason <span class=\"token operator\">=</span> <span class=\"token class-name\">RunReason</span><span class=\"token punctuation\">.</span><span class=\"token constant\">DECODE_DATA</span><span class=\"token punctuation\">;</span>\n    callback<span class=\"token punctuation\">.</span><span class=\"token function\">reschedule</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>更改任务状态，重新执行此任务，则重新执行到<code>getNextGenerator</code>方法，此时则会返回<strong>DataCacheGenerator</strong>来处理从Disk缓存加载的任务。</p>\n<h2 id=\"获取图片\"><a href=\"#获取图片\" class=\"headerlink\" title=\"获取图片\"></a>获取图片</h2><p>首先，图片来源有哪些？</p>\n<ol>\n<li>资源图片：drawable, assets, raw, mipmap这些程序中自带的图片；</li>\n<li>本地图片：本地存储设备上的图片；</li>\n<li>远端图片：我们服务器或者来自第三方服务器的图片，通过URL来获取。这就需要<strong>异步网络请求</strong>，请求结束以后，要<strong>缓存</strong>图片，避免重复请求远端图片，造成时间、网络的浪费。</li>\n</ol>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> LR<span class=\"token punctuation\">;</span>\nA<span class=\"token text string\">[Slide]</span><span class=\"token punctuation\">;</span>\nB<span class=\"token text string\">([1. 资源图片])</span> <span class=\"token arrow operator\">--></span> A<span class=\"token punctuation\">;</span>\nC<span class=\"token text string\">([2. 本地图片])</span> <span class=\"token arrow operator\">--></span> A<span class=\"token punctuation\">;</span>\nE<span class=\"token text string\">&#123;缓存是否存在&#125;</span> <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|是,交给Slide|</span>A<span class=\"token punctuation\">;</span>\nE <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|否,网络请求|</span>D<span class=\"token text string\">([3. 远端图片])</span><span class=\"token punctuation\">;</span>\nD <span class=\"token arrow operator\">-.-></span> <span class=\"token label property\">|获取到图片并缓存|</span>E<span class=\"token punctuation\">;</span>\n</code></pre>\n\n\n\n<p>那么接下来，要丰富的细节，就来到了<strong>网络请求</strong>和<strong>缓存</strong>了。</p>\n<h3 id=\"网络请求\"><a href=\"#网络请求\" class=\"headerlink\" title=\"网络请求\"></a>网络请求</h3><h3 id=\"缓存\"><a href=\"#缓存\" class=\"headerlink\" title=\"缓存\"></a>缓存</h3>"},{"layout":"post","title":"Glide源码分析与自我实现(二)——缓存与BitmapPool","author":"boybeak","date":"2022-09-16T18:00:00.000Z","_content":"\n\n> 本文基于Glide 4.11.0\n\n参考文章：[Glide 源码分析解读-缓存模块-基于最新版Glide 4.9.0](https://zhuanlan.zhihu.com/p/60426316)\n\n**注意：**由于版本差异问题，本文有些部分与参考文章有差异。\n\n缓存模块是Glide中非常重要的部分，Glide图片加载的高效性，几乎有一半功劳都在这里了。\n\n一般来说，Glide有三级缓存，就是**内存缓存**、**磁盘缓存**和**网络缓存**。\n\n先来看缓存流程图，如下：\n\n```mermaid\ngraph TD;\nstyle A fill:#99ccff\nstyle B1 fill:#aaffaa\nA(发起请求) --> B{1. 通过<br>ActiveResources<br>获取资源} --> |命中|B1([加载完成]);\nB --> |未命中|C{2. 通过<br>MemoryCache<br>获取资源} --> |命中|C1[缓存至<br>ActiveResources] --> B1;\nC --> |未命中|D{3. 通过<br>DiskCache<br>获取资源} --> |命中|D1[缓存至<br>MemoryCache] --> C1;\nD --> |未命中|E[\"4. 通过数据源(网络、文件等)<br>加载数据\"] --> E1[缓存至<br>DiskCache] --> D1;\n```\n\n## 内存缓存\n\n内存缓存主要靠三个部分组成：**ActiveResources**、**MemoryCache**和**BitmapPool**。\n\n### ActiveResources\n\nActiveResources表示当前正在活动中的资源。ActiveResources通过一个`Map<Key, ResourceWeakReference>`来保存活动中的资源，其中的ResourceWeakReference就是资源数据，在构建这个ResourceWeakReference的时候必须传入一个ReferenceQueue用来检测资源是否被回收。\n\n> **Q1：如何探知WeakReference中的值被回收了呢？**\n>\n> ```java\n> ReferenceQueue queue = ...;\n> WeakReference wr = new WeakReference(value, queue);\n> ```\n>\n> 当构建WeakReference的时候，如果传入了queue参数，则在value被回收的时候，wr会被加入到queue中去，这样，通过检测queue中是否有值，就可以探知value是否被回收了。\n\n那么，在何时去探知ReferenceQueue中的值呢？我们查看ActiveResources的关键代码：\n\n```java\n/*构造方法中，通过monitorClearedResourcesExecutor执行了cleanReferenceQueue()方法。\n*/\nActiveResources(boolean isActiveResourceRetentionAllowed) {\n  this(\n    isActiveResourceRetentionAllowed,\n    java.util.concurrent.Executors.newSingleThreadExecutor(\n      new ThreadFactory() {\n        @Override\n        public Thread newThread(@NonNull final Runnable r) {\n          return new Thread(\n            new Runnable() {\n              @Override\n              public void run() {\n                Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);\n                r.run();\n              }\n            },\n            \"glide-active-resources\");\n        }\n      }));\n}\n\n@VisibleForTesting\nActiveResources(\n  boolean isActiveResourceRetentionAllowed, Executor monitorClearedResourcesExecutor) {\n  this.isActiveResourceRetentionAllowed = isActiveResourceRetentionAllowed;\n  this.monitorClearedResourcesExecutor = monitorClearedResourcesExecutor;\n\n  monitorClearedResourcesExecutor.execute(\n    new Runnable() {\n      @Override\n      public void run() {\n        cleanReferenceQueue();\n      }\n    });\n}\n\n\nvoid cleanReferenceQueue() {\n  while (!isShutdown) {\n    try {\n      ResourceWeakReference ref = (ResourceWeakReference) resourceReferenceQueue.remove();\n      cleanupActiveReference(ref);\n\n      // This section for testing only.\n      DequeuedResourceCallback current = cb;\n      if (current != null) {\n        current.onResourceDequeued();\n      }\n      // End for testing only.\n    } catch (InterruptedException e) {\n      Thread.currentThread().interrupt();\n    }\n  }\n}\n```\n\n我们通过代码可以看出，`cleanReferenceQueue`是一个靠`isShutdown`变量控制的**死循环**方法，这个方法执行在一个优先级为`THREAD_PRIORITY_BACKGROUND`的线程上。\n\n> **Q2：那么，既然是死循环方法，会不会过多的占用CPU资源呢？**\n>\n> 其实不会的，因为ReferenceQueue#remove是一个阻塞式的方法，如果没有元素可以被remove，则等待至有元素可以remove的时候，等待期间释放CPU。\n\n> **注意：**此处与**参考文章**中的说法不同，这是因为版本差异。查看[Glide update log hsitory](https://github.com/bumptech/glide/commit/8f1ea5c07dff7ade8c49c324bcb5a7f40d0b4891#diff-c46e6c0760c04e74cb867c2bdf9cdee90ab279b119268478524c42cc743cb8a9)，可以看出**出于避免在主线程做清理的原因**，将清理任务放在了后台线程，而不是放在IdleHandler中。\n\n\n\n**那么被回收了的资源去哪里了呢？**\n\n我们查看`cleanupActiveReference`方法，得知，通过*ResourceListener#onResourceReleased*回调，交给了**Engine**来处理，我们查看Engine的onResourceReleased方法。\n\n```java\n@Override\npublic void onResourceReleased(Key cacheKey, EngineResource<?> resource) {\n  activeResources.deactivate(cacheKey);\n  if (resource.isMemoryCacheable()) {\n    cache.put(cacheKey, resource);\n  } else {\n    resourceRecycler.recycle(resource, /*forceNextFrame=*/ false);\n  }\n}\n```\n\n从这里我们发现，这里出现了两种情况：\n\n1. 如果资源是**MemoryCacheable**的，则缓存在MemoryCache；\n2. 如果资源不是**MemoryCacheable**的，则交给ResourceRecycler调用Resource的recycle()方法来回收，如果此Resource为BitmapResource，则会将Bitmap回收到BitmapPool中去。\n\n\n\n在开始MemoryCache和BitmapPool前，需要先了解一下**MemorySizeCalculator**这个类，这个类是用来计算 BitmapPool 、ArrayPool 以及 MemoryCache **大小**的。\n\n### MemoryCache\n\nMemoryCache的具体实现类是LruResourceCache，而实际的逻辑方法，都在其父类LruCache中，以put方法为例。\n\n```java\n@Nullable\npublic synchronized Y put(@NonNull T key, @Nullable Y item) {\n  final int itemSize = getSize(item);\n  if (itemSize >= maxSize) {\n    onItemEvicted(key, item);\n    return null;\n  }\n\n  if (item != null) {\n    currentSize += itemSize;\n  }\n  @Nullable Entry<Y> old = cache.put(key, item == null ? null : new Entry<>(item, itemSize));\n  if (old != null) {\n    currentSize -= old.size;\n\n    if (!old.value.equals(item)) {\n      onItemEvicted(key, old.value);\n    }\n  }\n  evict();\n\n  return old != null ? old.value : null;\n}\n```\n\n当有一个新的item被put进去以后，会替换出一个老的值old，如果old非为空，则需要将当前容量减去old的大小，如果old并非新的item，则需要通过onItemEvicted进行回调，通知有老值被**“驱逐”**了。最后还要执行一次evict方法，按照LRU算法，将超出maxSize的item**“驱逐”**出去，以确保在maxSize范围内。\n\n```java\nprotected synchronized void trimToSize(long size) {\n  Map.Entry<T, Entry<Y>> last;\n  Iterator<Map.Entry<T, Entry<Y>>> cacheIterator;\n  while (currentSize > size) {\n    cacheIterator = cache.entrySet().iterator();\n    last = cacheIterator.next();\n    final Entry<Y> toRemove = last.getValue();\n    currentSize -= toRemove.size;\n    final T key = last.getKey();\n    cacheIterator.remove();\n    onItemEvicted(key, toRemove.value);\n  }\n}\n\nprivate void evict() {\n  trimToSize(maxSize);\n}\n```\n\n被**\"驱逐\"**的值去哪里了呢？我们查看*MemoryCache*类的源码，可以知道是通过*ResourceRemovedListener*回调给了*Engine*，在*Engine*中我们查看*onResourceRemoved*方法。\n\n```java\n@Override\npublic void onResourceRemoved(@NonNull final Resource<?> resource) {\n  // Avoid deadlock with RequestManagers when recycling triggers recursive clear() calls.\n  // See b/145519760.\n  resourceRecycler.recycle(resource, /*forceNextFrame=*/ true);\n}\n```\n\n我们可以看到，这里同样是通过resourceRecycler进行了回收。在这里，则是交给resource自己的recycle()方法来处理，比如，*BitmapResource*是交给了*BitmapPool*进行处理。\n\n\n\n### BitmapPool\n\n这里是专门用来存放被回收的Bitmap的，其中**BitmapDrawableResource**、**BitmapResource**都持有一个**BitmapPool**变量，在执行recycle()方法时候，调用*BitmapPool#put()*方法。我们来看一下这个BitmapPool的默认实现类**LruBitmapPool**的方法实现。\n\n```java\n@Override\npublic synchronized void put(Bitmap bitmap) {\n  if (bitmap == null) {\n    throw new NullPointerException(\"Bitmap must not be null\");\n  }\n  if (bitmap.isRecycled()) {\n    throw new IllegalStateException(\"Cannot pool recycled bitmap\");\n  }\n  if (!bitmap.isMutable()\n      || strategy.getSize(bitmap) > maxSize\n      || !allowedConfigs.contains(bitmap.getConfig())) {\n    if (Log.isLoggable(TAG, Log.VERBOSE)) {\n      Log.v(\n        TAG,\n        \"Reject bitmap from pool\"\n        + \", bitmap: \"\n        + strategy.logBitmap(bitmap)\n        + \", is mutable: \"\n        + bitmap.isMutable()\n        + \", is allowed config: \"\n        + allowedConfigs.contains(bitmap.getConfig()));\n    }\n    bitmap.recycle();\n    return;\n  }\n\n  final int size = strategy.getSize(bitmap);\n  strategy.put(bitmap);\n  tracker.add(bitmap);\n\t...\n}\n```\n\n这里我们可以看出，当Bitmap在三种情况下是不会被BitmapPool缓存起来的：\n\n1. 这个bitmap是非mutable的，也就是说是不允许被复用的；\n2. 这一个bitmap的字节数大小已经超过了可以容纳的总大小；\n3. BitmapPool中不允许的Config类型。\n\n在这种情况，bitmap就被直接recycle掉，而不是放入缓存等待下次使用。\n\n如果不满足这三种情况，则会被strategy缓存起来，等待下次使用。\n\n我们再看LruBitmapPool#get()方法。\n\n```java\n@Override\n@NonNull\npublic Bitmap get(int width, int height, Bitmap.Config config) {\n  Bitmap result = getDirtyOrNull(width, height, config);\n  if (result != null) {\n    result.eraseColor(Color.TRANSPARENT);\n  } else {\n    result = createBitmap(width, height, config);\n  }\n  return result;\n}\n```\n\n我们可以看到，当能够查询到符合条件的Bitmap的时候，会先通过eraseColor方法，将其变成透明图片，然后再交给调用者来使用；如果查询不到，则创建一个新图交给调用者来使用。\n\n> LruBitmapPool的LruPoolStrategy变量，在KITKAT以及以上，是SizeConfigStrategy，在以下是AttributeStrategy，这是因为在KITKAT版本以下，Bitmap的复用需要尺寸的严格匹配，但是KITKAT及以上没有这个问题，只要被复用的图片尺寸比目标尺寸大就可以。\n\n\n\n### ArrayPool\n\nArrayPool主要用在**ThumbnailStreamOpener**和**ByteBufferGifDecoder**中，具体的实现类为**LruArrayPool**。\n\n在LruArrayPool中，通过groupedMap来缓存数据，而缓存数据的byte字节数是通过**ArrayAdapterInterface**来计算的，ArrayAdapterInterface是一个接口，实现类有两个：**IntegerArrayAdapter**和**ByteArrayAdapter**，分别对应缓存int[].class和byte[].class。\n\nStreamGifDecoder和StreamBitmapDecoder都有一个ArrayPool成员。解码过程中需要用到byte[]，但不是直接new byte[]，而是调用`ArrayPool.get()`从对象池中拿，用完了归还。\n\n\n\n\n\n## DiskCache\n\n在上一章[Glide源码分析与自我实现(一)——数据加载主流程]({{site.base_url}}/源码分析系列/Glide源码分析与自我实现2.md)中，提到过数据加载的主流程，其中一个非常重要的类是 **DecodeJob**，在这个类的`getNextGenerator`方法中，返回的**SourceGenerator**会用来加载远程数据，但是这个方法不止返回这一个**DataFetcherGenerator**类，这是一个通过条件判断，返回不同DataFetcherGenerator类的方法。\n\n```java\nprivate DataFetcherGenerator getNextGenerator() {\n  switch (stage) {\n    case RESOURCE_CACHE:\n      return new ResourceCacheGenerator(decodeHelper, this);\n    case DATA_CACHE:\n      return new DataCacheGenerator(decodeHelper, this);\n    case SOURCE:\n      return new SourceGenerator(decodeHelper, this);\n    case FINISHED:\n      return null;\n    default:\n      throw new IllegalStateException(\"Unrecognized stage: \" + stage);\n  }\n}\n```\n\n实际上，这是依次递进的**有限状态机**设计模式，当一个获取数据请求到来时候，此时是默认状态INITIALIZE，然后通过`getNextStage`方法判断下一个状态是什么，再按照新的状态获取DataFetcherGenerator，然后随着任务的执行，不断改变状态。\n\n```java\nprivate Stage getNextStage(Stage current) {\n  switch (current) {\n    case INITIALIZE:\n      return diskCacheStrategy.decodeCachedResource()\n        ? Stage.RESOURCE_CACHE\n        : getNextStage(Stage.RESOURCE_CACHE);\n    case RESOURCE_CACHE:\n      return diskCacheStrategy.decodeCachedData()\n        ? Stage.DATA_CACHE\n        : getNextStage(Stage.DATA_CACHE);\n    case DATA_CACHE:\n      // Skip loading from source if the user opted to only retrieve the resource from cache.\n      return onlyRetrieveFromCache ? Stage.FINISHED : Stage.SOURCE;\n    case SOURCE:\n    case FINISHED:\n      return Stage.FINISHED;\n    default:\n      throw new IllegalArgumentException(\"Unrecognized stage: \" + current);\n  }\n}\n```\n\n其状态变更顺序为INITIALIZE -> RESOURCE_CACHE -> DATA_CACHE -> SOURCE，代表着ResourceCacheGenerator、DataCacheGenerator和SourceGenerator，当从ResourceCahce中拿不到数据，则向DataCacheGenerator请求数据，如果还是拿不到，则通过SourceGenerator去请求数据了。\n\n在这个过程中，SourceGenerator向DiskCache中写入数据，ResourceCacheGenerator和DataCacheGenerator从DiskCache中读取数据。\n\n```java\nclass ResourceCacheGenerator implements DataFetcherGenerator,\n\n  @Override\n  public boolean startNext() {\n      ...\n      currentKey = new ResourceCacheKey(sourceId, helper.getSignature(), helper.getWidth(),\n          helper.getHeight(), transformation, resourceClass, helper.getOptions());\n      cacheFile = helper.getDiskCache().get(currentKey);\n      if (cacheFile != null) {\n        this.sourceKey = sourceId;\n        modelLoaders = helper.getModelLoaders(cacheFile);\n        modelLoaderIndex = 0;\n      }\n    }\n  }\n}\n\nclass DataCacheGenerator implements DataFetcherGenerator,\n\n  @Override\n  public boolean startNext() {\n    while (modelLoaders == null || !hasNextModelLoader()) {\n      ...\n      Key sourceId = cacheKeys.get(sourceIdIndex);\n      Key originalKey = new DataCacheKey(sourceId, helper.getSignature());\n      cacheFile = helper.getDiskCache().get(originalKey);\n      if (cacheFile != null) {\n        this.sourceKey = sourceId;\n        modelLoaders = helper.getModelLoaders(cacheFile);\n        modelLoaderIndex = 0;\n      }\n    }\n}\n\nclass SourceGenerator implements DataFetcherGenerator {\n\n  @Override\n  public boolean startNext() {\n    if (dataToCache != null) {\n      Object data = dataToCache;\n      dataToCache = null;\n      cacheData(data);\n    }\n    ...\n  }\n\n  private void cacheData(Object dataToCache) {\n    long startTime = LogTime.getLogTime();\n    try {\n      Encoder<Object> encoder = helper.getSourceEncoder(dataToCache);\n      DataCacheWriter<Object> writer =\n          new DataCacheWriter<>(encoder, dataToCache, helper.getOptions());\n      originalKey = new DataCacheKey(loadData.sourceKey, helper.getSignature());\n      helper.getDiskCache().put(originalKey, writer);\n      ...\n    } finally {\n      loadData.fetcher.cleanup();\n    }\n\n    sourceCacheGenerator =\n        new DataCacheGenerator(Collections.singletonList(loadData.sourceKey), helper, this);\n  }\n}\n```\n\nDiskCache的默认实现类是**DiskLruCacheWrapper**，其内部通过**DiskLruCache**来管理磁盘缓存。\n\n\n\n## 总结\n\n到现在，Glide主要部分已经分析的差不多了，实际上这个优秀的框架可挖的地方还有很多，比如通过[APT来实现很好的扩展]({{site.base_url}}/源码分析系列/Glide源码分析与自我实现3.md)，框架中涉及多种涉及模式等。\n\n> 其中涉及到的涉及模式，比如无处不在的**构建者模式**和**工厂模式**，DecodeJob中的**有限状态机模式**，还有BitmapPool和ArrayPool中的**享元模式**，DiskLruCacheWrapper中的**代理模式**等。\n\n## 参考文章\n\n[Glide缓存分析](https://www.sunmoonblog.com/2018/07/27/glide-cache/)","source":"_posts/2022-09-17-Glide源码分析与自我实现2.md","raw":"---\nlayout: post\ntitle: Glide源码分析与自我实现(二)——缓存与BitmapPool\nauthor: boybeak\ncategory: 源码分析\ntags: Android\ndate: 2022-09-17 02:00:00\n---\n\n\n> 本文基于Glide 4.11.0\n\n参考文章：[Glide 源码分析解读-缓存模块-基于最新版Glide 4.9.0](https://zhuanlan.zhihu.com/p/60426316)\n\n**注意：**由于版本差异问题，本文有些部分与参考文章有差异。\n\n缓存模块是Glide中非常重要的部分，Glide图片加载的高效性，几乎有一半功劳都在这里了。\n\n一般来说，Glide有三级缓存，就是**内存缓存**、**磁盘缓存**和**网络缓存**。\n\n先来看缓存流程图，如下：\n\n```mermaid\ngraph TD;\nstyle A fill:#99ccff\nstyle B1 fill:#aaffaa\nA(发起请求) --> B{1. 通过<br>ActiveResources<br>获取资源} --> |命中|B1([加载完成]);\nB --> |未命中|C{2. 通过<br>MemoryCache<br>获取资源} --> |命中|C1[缓存至<br>ActiveResources] --> B1;\nC --> |未命中|D{3. 通过<br>DiskCache<br>获取资源} --> |命中|D1[缓存至<br>MemoryCache] --> C1;\nD --> |未命中|E[\"4. 通过数据源(网络、文件等)<br>加载数据\"] --> E1[缓存至<br>DiskCache] --> D1;\n```\n\n## 内存缓存\n\n内存缓存主要靠三个部分组成：**ActiveResources**、**MemoryCache**和**BitmapPool**。\n\n### ActiveResources\n\nActiveResources表示当前正在活动中的资源。ActiveResources通过一个`Map<Key, ResourceWeakReference>`来保存活动中的资源，其中的ResourceWeakReference就是资源数据，在构建这个ResourceWeakReference的时候必须传入一个ReferenceQueue用来检测资源是否被回收。\n\n> **Q1：如何探知WeakReference中的值被回收了呢？**\n>\n> ```java\n> ReferenceQueue queue = ...;\n> WeakReference wr = new WeakReference(value, queue);\n> ```\n>\n> 当构建WeakReference的时候，如果传入了queue参数，则在value被回收的时候，wr会被加入到queue中去，这样，通过检测queue中是否有值，就可以探知value是否被回收了。\n\n那么，在何时去探知ReferenceQueue中的值呢？我们查看ActiveResources的关键代码：\n\n```java\n/*构造方法中，通过monitorClearedResourcesExecutor执行了cleanReferenceQueue()方法。\n*/\nActiveResources(boolean isActiveResourceRetentionAllowed) {\n  this(\n    isActiveResourceRetentionAllowed,\n    java.util.concurrent.Executors.newSingleThreadExecutor(\n      new ThreadFactory() {\n        @Override\n        public Thread newThread(@NonNull final Runnable r) {\n          return new Thread(\n            new Runnable() {\n              @Override\n              public void run() {\n                Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);\n                r.run();\n              }\n            },\n            \"glide-active-resources\");\n        }\n      }));\n}\n\n@VisibleForTesting\nActiveResources(\n  boolean isActiveResourceRetentionAllowed, Executor monitorClearedResourcesExecutor) {\n  this.isActiveResourceRetentionAllowed = isActiveResourceRetentionAllowed;\n  this.monitorClearedResourcesExecutor = monitorClearedResourcesExecutor;\n\n  monitorClearedResourcesExecutor.execute(\n    new Runnable() {\n      @Override\n      public void run() {\n        cleanReferenceQueue();\n      }\n    });\n}\n\n\nvoid cleanReferenceQueue() {\n  while (!isShutdown) {\n    try {\n      ResourceWeakReference ref = (ResourceWeakReference) resourceReferenceQueue.remove();\n      cleanupActiveReference(ref);\n\n      // This section for testing only.\n      DequeuedResourceCallback current = cb;\n      if (current != null) {\n        current.onResourceDequeued();\n      }\n      // End for testing only.\n    } catch (InterruptedException e) {\n      Thread.currentThread().interrupt();\n    }\n  }\n}\n```\n\n我们通过代码可以看出，`cleanReferenceQueue`是一个靠`isShutdown`变量控制的**死循环**方法，这个方法执行在一个优先级为`THREAD_PRIORITY_BACKGROUND`的线程上。\n\n> **Q2：那么，既然是死循环方法，会不会过多的占用CPU资源呢？**\n>\n> 其实不会的，因为ReferenceQueue#remove是一个阻塞式的方法，如果没有元素可以被remove，则等待至有元素可以remove的时候，等待期间释放CPU。\n\n> **注意：**此处与**参考文章**中的说法不同，这是因为版本差异。查看[Glide update log hsitory](https://github.com/bumptech/glide/commit/8f1ea5c07dff7ade8c49c324bcb5a7f40d0b4891#diff-c46e6c0760c04e74cb867c2bdf9cdee90ab279b119268478524c42cc743cb8a9)，可以看出**出于避免在主线程做清理的原因**，将清理任务放在了后台线程，而不是放在IdleHandler中。\n\n\n\n**那么被回收了的资源去哪里了呢？**\n\n我们查看`cleanupActiveReference`方法，得知，通过*ResourceListener#onResourceReleased*回调，交给了**Engine**来处理，我们查看Engine的onResourceReleased方法。\n\n```java\n@Override\npublic void onResourceReleased(Key cacheKey, EngineResource<?> resource) {\n  activeResources.deactivate(cacheKey);\n  if (resource.isMemoryCacheable()) {\n    cache.put(cacheKey, resource);\n  } else {\n    resourceRecycler.recycle(resource, /*forceNextFrame=*/ false);\n  }\n}\n```\n\n从这里我们发现，这里出现了两种情况：\n\n1. 如果资源是**MemoryCacheable**的，则缓存在MemoryCache；\n2. 如果资源不是**MemoryCacheable**的，则交给ResourceRecycler调用Resource的recycle()方法来回收，如果此Resource为BitmapResource，则会将Bitmap回收到BitmapPool中去。\n\n\n\n在开始MemoryCache和BitmapPool前，需要先了解一下**MemorySizeCalculator**这个类，这个类是用来计算 BitmapPool 、ArrayPool 以及 MemoryCache **大小**的。\n\n### MemoryCache\n\nMemoryCache的具体实现类是LruResourceCache，而实际的逻辑方法，都在其父类LruCache中，以put方法为例。\n\n```java\n@Nullable\npublic synchronized Y put(@NonNull T key, @Nullable Y item) {\n  final int itemSize = getSize(item);\n  if (itemSize >= maxSize) {\n    onItemEvicted(key, item);\n    return null;\n  }\n\n  if (item != null) {\n    currentSize += itemSize;\n  }\n  @Nullable Entry<Y> old = cache.put(key, item == null ? null : new Entry<>(item, itemSize));\n  if (old != null) {\n    currentSize -= old.size;\n\n    if (!old.value.equals(item)) {\n      onItemEvicted(key, old.value);\n    }\n  }\n  evict();\n\n  return old != null ? old.value : null;\n}\n```\n\n当有一个新的item被put进去以后，会替换出一个老的值old，如果old非为空，则需要将当前容量减去old的大小，如果old并非新的item，则需要通过onItemEvicted进行回调，通知有老值被**“驱逐”**了。最后还要执行一次evict方法，按照LRU算法，将超出maxSize的item**“驱逐”**出去，以确保在maxSize范围内。\n\n```java\nprotected synchronized void trimToSize(long size) {\n  Map.Entry<T, Entry<Y>> last;\n  Iterator<Map.Entry<T, Entry<Y>>> cacheIterator;\n  while (currentSize > size) {\n    cacheIterator = cache.entrySet().iterator();\n    last = cacheIterator.next();\n    final Entry<Y> toRemove = last.getValue();\n    currentSize -= toRemove.size;\n    final T key = last.getKey();\n    cacheIterator.remove();\n    onItemEvicted(key, toRemove.value);\n  }\n}\n\nprivate void evict() {\n  trimToSize(maxSize);\n}\n```\n\n被**\"驱逐\"**的值去哪里了呢？我们查看*MemoryCache*类的源码，可以知道是通过*ResourceRemovedListener*回调给了*Engine*，在*Engine*中我们查看*onResourceRemoved*方法。\n\n```java\n@Override\npublic void onResourceRemoved(@NonNull final Resource<?> resource) {\n  // Avoid deadlock with RequestManagers when recycling triggers recursive clear() calls.\n  // See b/145519760.\n  resourceRecycler.recycle(resource, /*forceNextFrame=*/ true);\n}\n```\n\n我们可以看到，这里同样是通过resourceRecycler进行了回收。在这里，则是交给resource自己的recycle()方法来处理，比如，*BitmapResource*是交给了*BitmapPool*进行处理。\n\n\n\n### BitmapPool\n\n这里是专门用来存放被回收的Bitmap的，其中**BitmapDrawableResource**、**BitmapResource**都持有一个**BitmapPool**变量，在执行recycle()方法时候，调用*BitmapPool#put()*方法。我们来看一下这个BitmapPool的默认实现类**LruBitmapPool**的方法实现。\n\n```java\n@Override\npublic synchronized void put(Bitmap bitmap) {\n  if (bitmap == null) {\n    throw new NullPointerException(\"Bitmap must not be null\");\n  }\n  if (bitmap.isRecycled()) {\n    throw new IllegalStateException(\"Cannot pool recycled bitmap\");\n  }\n  if (!bitmap.isMutable()\n      || strategy.getSize(bitmap) > maxSize\n      || !allowedConfigs.contains(bitmap.getConfig())) {\n    if (Log.isLoggable(TAG, Log.VERBOSE)) {\n      Log.v(\n        TAG,\n        \"Reject bitmap from pool\"\n        + \", bitmap: \"\n        + strategy.logBitmap(bitmap)\n        + \", is mutable: \"\n        + bitmap.isMutable()\n        + \", is allowed config: \"\n        + allowedConfigs.contains(bitmap.getConfig()));\n    }\n    bitmap.recycle();\n    return;\n  }\n\n  final int size = strategy.getSize(bitmap);\n  strategy.put(bitmap);\n  tracker.add(bitmap);\n\t...\n}\n```\n\n这里我们可以看出，当Bitmap在三种情况下是不会被BitmapPool缓存起来的：\n\n1. 这个bitmap是非mutable的，也就是说是不允许被复用的；\n2. 这一个bitmap的字节数大小已经超过了可以容纳的总大小；\n3. BitmapPool中不允许的Config类型。\n\n在这种情况，bitmap就被直接recycle掉，而不是放入缓存等待下次使用。\n\n如果不满足这三种情况，则会被strategy缓存起来，等待下次使用。\n\n我们再看LruBitmapPool#get()方法。\n\n```java\n@Override\n@NonNull\npublic Bitmap get(int width, int height, Bitmap.Config config) {\n  Bitmap result = getDirtyOrNull(width, height, config);\n  if (result != null) {\n    result.eraseColor(Color.TRANSPARENT);\n  } else {\n    result = createBitmap(width, height, config);\n  }\n  return result;\n}\n```\n\n我们可以看到，当能够查询到符合条件的Bitmap的时候，会先通过eraseColor方法，将其变成透明图片，然后再交给调用者来使用；如果查询不到，则创建一个新图交给调用者来使用。\n\n> LruBitmapPool的LruPoolStrategy变量，在KITKAT以及以上，是SizeConfigStrategy，在以下是AttributeStrategy，这是因为在KITKAT版本以下，Bitmap的复用需要尺寸的严格匹配，但是KITKAT及以上没有这个问题，只要被复用的图片尺寸比目标尺寸大就可以。\n\n\n\n### ArrayPool\n\nArrayPool主要用在**ThumbnailStreamOpener**和**ByteBufferGifDecoder**中，具体的实现类为**LruArrayPool**。\n\n在LruArrayPool中，通过groupedMap来缓存数据，而缓存数据的byte字节数是通过**ArrayAdapterInterface**来计算的，ArrayAdapterInterface是一个接口，实现类有两个：**IntegerArrayAdapter**和**ByteArrayAdapter**，分别对应缓存int[].class和byte[].class。\n\nStreamGifDecoder和StreamBitmapDecoder都有一个ArrayPool成员。解码过程中需要用到byte[]，但不是直接new byte[]，而是调用`ArrayPool.get()`从对象池中拿，用完了归还。\n\n\n\n\n\n## DiskCache\n\n在上一章[Glide源码分析与自我实现(一)——数据加载主流程]({{site.base_url}}/源码分析系列/Glide源码分析与自我实现2.md)中，提到过数据加载的主流程，其中一个非常重要的类是 **DecodeJob**，在这个类的`getNextGenerator`方法中，返回的**SourceGenerator**会用来加载远程数据，但是这个方法不止返回这一个**DataFetcherGenerator**类，这是一个通过条件判断，返回不同DataFetcherGenerator类的方法。\n\n```java\nprivate DataFetcherGenerator getNextGenerator() {\n  switch (stage) {\n    case RESOURCE_CACHE:\n      return new ResourceCacheGenerator(decodeHelper, this);\n    case DATA_CACHE:\n      return new DataCacheGenerator(decodeHelper, this);\n    case SOURCE:\n      return new SourceGenerator(decodeHelper, this);\n    case FINISHED:\n      return null;\n    default:\n      throw new IllegalStateException(\"Unrecognized stage: \" + stage);\n  }\n}\n```\n\n实际上，这是依次递进的**有限状态机**设计模式，当一个获取数据请求到来时候，此时是默认状态INITIALIZE，然后通过`getNextStage`方法判断下一个状态是什么，再按照新的状态获取DataFetcherGenerator，然后随着任务的执行，不断改变状态。\n\n```java\nprivate Stage getNextStage(Stage current) {\n  switch (current) {\n    case INITIALIZE:\n      return diskCacheStrategy.decodeCachedResource()\n        ? Stage.RESOURCE_CACHE\n        : getNextStage(Stage.RESOURCE_CACHE);\n    case RESOURCE_CACHE:\n      return diskCacheStrategy.decodeCachedData()\n        ? Stage.DATA_CACHE\n        : getNextStage(Stage.DATA_CACHE);\n    case DATA_CACHE:\n      // Skip loading from source if the user opted to only retrieve the resource from cache.\n      return onlyRetrieveFromCache ? Stage.FINISHED : Stage.SOURCE;\n    case SOURCE:\n    case FINISHED:\n      return Stage.FINISHED;\n    default:\n      throw new IllegalArgumentException(\"Unrecognized stage: \" + current);\n  }\n}\n```\n\n其状态变更顺序为INITIALIZE -> RESOURCE_CACHE -> DATA_CACHE -> SOURCE，代表着ResourceCacheGenerator、DataCacheGenerator和SourceGenerator，当从ResourceCahce中拿不到数据，则向DataCacheGenerator请求数据，如果还是拿不到，则通过SourceGenerator去请求数据了。\n\n在这个过程中，SourceGenerator向DiskCache中写入数据，ResourceCacheGenerator和DataCacheGenerator从DiskCache中读取数据。\n\n```java\nclass ResourceCacheGenerator implements DataFetcherGenerator,\n\n  @Override\n  public boolean startNext() {\n      ...\n      currentKey = new ResourceCacheKey(sourceId, helper.getSignature(), helper.getWidth(),\n          helper.getHeight(), transformation, resourceClass, helper.getOptions());\n      cacheFile = helper.getDiskCache().get(currentKey);\n      if (cacheFile != null) {\n        this.sourceKey = sourceId;\n        modelLoaders = helper.getModelLoaders(cacheFile);\n        modelLoaderIndex = 0;\n      }\n    }\n  }\n}\n\nclass DataCacheGenerator implements DataFetcherGenerator,\n\n  @Override\n  public boolean startNext() {\n    while (modelLoaders == null || !hasNextModelLoader()) {\n      ...\n      Key sourceId = cacheKeys.get(sourceIdIndex);\n      Key originalKey = new DataCacheKey(sourceId, helper.getSignature());\n      cacheFile = helper.getDiskCache().get(originalKey);\n      if (cacheFile != null) {\n        this.sourceKey = sourceId;\n        modelLoaders = helper.getModelLoaders(cacheFile);\n        modelLoaderIndex = 0;\n      }\n    }\n}\n\nclass SourceGenerator implements DataFetcherGenerator {\n\n  @Override\n  public boolean startNext() {\n    if (dataToCache != null) {\n      Object data = dataToCache;\n      dataToCache = null;\n      cacheData(data);\n    }\n    ...\n  }\n\n  private void cacheData(Object dataToCache) {\n    long startTime = LogTime.getLogTime();\n    try {\n      Encoder<Object> encoder = helper.getSourceEncoder(dataToCache);\n      DataCacheWriter<Object> writer =\n          new DataCacheWriter<>(encoder, dataToCache, helper.getOptions());\n      originalKey = new DataCacheKey(loadData.sourceKey, helper.getSignature());\n      helper.getDiskCache().put(originalKey, writer);\n      ...\n    } finally {\n      loadData.fetcher.cleanup();\n    }\n\n    sourceCacheGenerator =\n        new DataCacheGenerator(Collections.singletonList(loadData.sourceKey), helper, this);\n  }\n}\n```\n\nDiskCache的默认实现类是**DiskLruCacheWrapper**，其内部通过**DiskLruCache**来管理磁盘缓存。\n\n\n\n## 总结\n\n到现在，Glide主要部分已经分析的差不多了，实际上这个优秀的框架可挖的地方还有很多，比如通过[APT来实现很好的扩展]({{site.base_url}}/源码分析系列/Glide源码分析与自我实现3.md)，框架中涉及多种涉及模式等。\n\n> 其中涉及到的涉及模式，比如无处不在的**构建者模式**和**工厂模式**，DecodeJob中的**有限状态机模式**，还有BitmapPool和ArrayPool中的**享元模式**，DiskLruCacheWrapper中的**代理模式**等。\n\n## 参考文章\n\n[Glide缓存分析](https://www.sunmoonblog.com/2018/07/27/glide-cache/)","slug":"2022-09-17-Glide源码分析与自我实现2","published":1,"updated":"2024-11-13T13:39:08.753Z","_id":"cm1ltr0fv0002bji010yn3i8n","comments":1,"photos":[],"content":"<blockquote>\n<p>本文基于Glide 4.11.0</p>\n</blockquote>\n<p>参考文章：<a href=\"https://zhuanlan.zhihu.com/p/60426316\">Glide 源码分析解读-缓存模块-基于最新版Glide 4.9.0</a></p>\n<p><strong>注意：</strong>由于版本差异问题，本文有些部分与参考文章有差异。</p>\n<p>缓存模块是Glide中非常重要的部分，Glide图片加载的高效性，几乎有一半功劳都在这里了。</p>\n<p>一般来说，Glide有三级缓存，就是<strong>内存缓存</strong>、<strong>磁盘缓存</strong>和<strong>网络缓存</strong>。</p>\n<p>先来看缓存流程图，如下：</p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">style</span> A <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#99ccff</span>\n<span class=\"token keyword\">style</span> B1 <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#aaffaa</span>\nA<span class=\"token text string\">(发起请求)</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">&#123;1. 通过&lt;br>ActiveResources&lt;br>获取资源&#125;</span> <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|命中|</span>B1<span class=\"token text string\">([加载完成])</span><span class=\"token punctuation\">;</span>\nB <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|未命中|</span>C<span class=\"token text string\">&#123;2. 通过&lt;br>MemoryCache&lt;br>获取资源&#125;</span> <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|命中|</span>C1<span class=\"token text string\">[缓存至&lt;br>ActiveResources]</span> <span class=\"token arrow operator\">--></span> B1<span class=\"token punctuation\">;</span>\nC <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|未命中|</span>D<span class=\"token text string\">&#123;3. 通过&lt;br>DiskCache&lt;br>获取资源&#125;</span> <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|命中|</span>D1<span class=\"token text string\">[缓存至&lt;br>MemoryCache]</span> <span class=\"token arrow operator\">--></span> C1<span class=\"token punctuation\">;</span>\nD <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|未命中|</span>E<span class=\"token text string\">[\"4. 通过数据源(网络、文件等)&lt;br>加载数据\"]</span> <span class=\"token arrow operator\">--></span> E1<span class=\"token text string\">[缓存至&lt;br>DiskCache]</span> <span class=\"token arrow operator\">--></span> D1<span class=\"token punctuation\">;</span></code></pre>\n\n<h2 id=\"内存缓存\"><a href=\"#内存缓存\" class=\"headerlink\" title=\"内存缓存\"></a>内存缓存</h2><p>内存缓存主要靠三个部分组成：<strong>ActiveResources</strong>、<strong>MemoryCache</strong>和<strong>BitmapPool</strong>。</p>\n<h3 id=\"ActiveResources\"><a href=\"#ActiveResources\" class=\"headerlink\" title=\"ActiveResources\"></a>ActiveResources</h3><p>ActiveResources表示当前正在活动中的资源。ActiveResources通过一个<code>Map&lt;Key, ResourceWeakReference&gt;</code>来保存活动中的资源，其中的ResourceWeakReference就是资源数据，在构建这个ResourceWeakReference的时候必须传入一个ReferenceQueue用来检测资源是否被回收。</p>\n<blockquote>\n<p><strong>Q1：如何探知WeakReference中的值被回收了呢？</strong></p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token class-name\">ReferenceQueue</span> queue <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">WeakReference</span> wr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakReference</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> queue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>当构建WeakReference的时候，如果传入了queue参数，则在value被回收的时候，wr会被加入到queue中去，这样，通过检测queue中是否有值，就可以探知value是否被回收了。</p>\n</blockquote>\n<p>那么，在何时去探知ReferenceQueue中的值呢？我们查看ActiveResources的关键代码：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">/*构造方法中，通过monitorClearedResourcesExecutor执行了cleanReferenceQueue()方法。\n*/</span>\n<span class=\"token class-name\">ActiveResources</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> isActiveResourceRetentionAllowed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span>\n    isActiveResourceRetentionAllowed<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span>Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newSingleThreadExecutor</span><span class=\"token punctuation\">(</span>\n      <span class=\"token keyword\">new</span> <span class=\"token class-name\">ThreadFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">Thread</span> <span class=\"token function\">newThread</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Runnable</span> r<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n          <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n              <span class=\"token annotation punctuation\">@Override</span>\n              <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token class-name\">Process</span><span class=\"token punctuation\">.</span><span class=\"token function\">setThreadPriority</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Process</span><span class=\"token punctuation\">.</span><span class=\"token constant\">THREAD_PRIORITY_BACKGROUND</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                r<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">&#125;</span>\n            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"glide-active-resources\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token annotation punctuation\">@VisibleForTesting</span>\n<span class=\"token class-name\">ActiveResources</span><span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">boolean</span> isActiveResourceRetentionAllowed<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Executor</span> monitorClearedResourcesExecutor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>isActiveResourceRetentionAllowed <span class=\"token operator\">=</span> isActiveResourceRetentionAllowed<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>monitorClearedResourcesExecutor <span class=\"token operator\">=</span> monitorClearedResourcesExecutor<span class=\"token punctuation\">;</span>\n\n  monitorClearedResourcesExecutor<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token annotation punctuation\">@Override</span>\n      <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">cleanReferenceQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">cleanReferenceQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isShutdown<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token class-name\">ResourceWeakReference</span> ref <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ResourceWeakReference</span><span class=\"token punctuation\">)</span> resourceReferenceQueue<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">cleanupActiveReference</span><span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// This section for testing only.</span>\n      <span class=\"token class-name\">DequeuedResourceCallback</span> current <span class=\"token operator\">=</span> cb<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        current<span class=\"token punctuation\">.</span><span class=\"token function\">onResourceDequeued</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token comment\">// End for testing only.</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们通过代码可以看出，<code>cleanReferenceQueue</code>是一个靠<code>isShutdown</code>变量控制的<strong>死循环</strong>方法，这个方法执行在一个优先级为<code>THREAD_PRIORITY_BACKGROUND</code>的线程上。</p>\n<blockquote>\n<p><strong>Q2：那么，既然是死循环方法，会不会过多的占用CPU资源呢？</strong></p>\n<p>其实不会的，因为ReferenceQueue#remove是一个阻塞式的方法，如果没有元素可以被remove，则等待至有元素可以remove的时候，等待期间释放CPU。</p>\n</blockquote>\n<blockquote>\n<p><strong>注意：</strong>此处与<strong>参考文章</strong>中的说法不同，这是因为版本差异。查看<a href=\"https://github.com/bumptech/glide/commit/8f1ea5c07dff7ade8c49c324bcb5a7f40d0b4891#diff-c46e6c0760c04e74cb867c2bdf9cdee90ab279b119268478524c42cc743cb8a9\">Glide update log hsitory</a>，可以看出<strong>出于避免在主线程做清理的原因</strong>，将清理任务放在了后台线程，而不是放在IdleHandler中。</p>\n</blockquote>\n<p><strong>那么被回收了的资源去哪里了呢？</strong></p>\n<p>我们查看<code>cleanupActiveReference</code>方法，得知，通过<em>ResourceListener#onResourceReleased</em>回调，交给了<strong>Engine</strong>来处理，我们查看Engine的onResourceReleased方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onResourceReleased</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Key</span> cacheKey<span class=\"token punctuation\">,</span> <span class=\"token class-name\">EngineResource</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> resource<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  activeResources<span class=\"token punctuation\">.</span><span class=\"token function\">deactivate</span><span class=\"token punctuation\">(</span>cacheKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>resource<span class=\"token punctuation\">.</span><span class=\"token function\">isMemoryCacheable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>cacheKey<span class=\"token punctuation\">,</span> resource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    resourceRecycler<span class=\"token punctuation\">.</span><span class=\"token function\">recycle</span><span class=\"token punctuation\">(</span>resource<span class=\"token punctuation\">,</span> <span class=\"token comment\">/*forceNextFrame=*/</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>从这里我们发现，这里出现了两种情况：</p>\n<ol>\n<li>如果资源是<strong>MemoryCacheable</strong>的，则缓存在MemoryCache；</li>\n<li>如果资源不是<strong>MemoryCacheable</strong>的，则交给ResourceRecycler调用Resource的recycle()方法来回收，如果此Resource为BitmapResource，则会将Bitmap回收到BitmapPool中去。</li>\n</ol>\n<p>在开始MemoryCache和BitmapPool前，需要先了解一下<strong>MemorySizeCalculator</strong>这个类，这个类是用来计算 BitmapPool 、ArrayPool 以及 MemoryCache <strong>大小</strong>的。</p>\n<h3 id=\"MemoryCache\"><a href=\"#MemoryCache\" class=\"headerlink\" title=\"MemoryCache\"></a>MemoryCache</h3><p>MemoryCache的具体实现类是LruResourceCache，而实际的逻辑方法，都在其父类LruCache中，以put方法为例。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Nullable</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token class-name\">Y</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">T</span> key<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">Y</span> item<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> itemSize <span class=\"token operator\">=</span> <span class=\"token function\">getSize</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>itemSize <span class=\"token operator\">>=</span> maxSize<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token function\">onItemEvicted</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>item <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    currentSize <span class=\"token operator\">+=</span> itemSize<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Y</span><span class=\"token punctuation\">></span></span> old <span class=\"token operator\">=</span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> item <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">,</span> itemSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>old <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    currentSize <span class=\"token operator\">-=</span> old<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>old<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">onItemEvicted</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> old<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token function\">evict</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> old <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> old<span class=\"token punctuation\">.</span>value <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>当有一个新的item被put进去以后，会替换出一个老的值old，如果old非为空，则需要将当前容量减去old的大小，如果old并非新的item，则需要通过onItemEvicted进行回调，通知有老值被<strong>“驱逐”</strong>了。最后还要执行一次evict方法，按照LRU算法，将超出maxSize的item<strong>“驱逐”</strong>出去，以确保在maxSize范围内。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">protected</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">trimToSize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Y</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> last<span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Y</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> cacheIterator<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>currentSize <span class=\"token operator\">></span> size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    cacheIterator <span class=\"token operator\">=</span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">entrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    last <span class=\"token operator\">=</span> cacheIterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Y</span><span class=\"token punctuation\">></span></span> toRemove <span class=\"token operator\">=</span> last<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    currentSize <span class=\"token operator\">-=</span> toRemove<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">T</span> key <span class=\"token operator\">=</span> last<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cacheIterator<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">onItemEvicted</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> toRemove<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">evict</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">trimToSize</span><span class=\"token punctuation\">(</span>maxSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>被**”驱逐”*<em>的值去哪里了呢？我们查看</em>MemoryCache<em>类的源码，可以知道是通过</em>ResourceRemovedListener<em>回调给了</em>Engine<em>，在</em>Engine<em>中我们查看</em>onResourceRemoved*方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onResourceRemoved</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Resource</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> resource<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// Avoid deadlock with RequestManagers when recycling triggers recursive clear() calls.</span>\n  <span class=\"token comment\">// See b/145519760.</span>\n  resourceRecycler<span class=\"token punctuation\">.</span><span class=\"token function\">recycle</span><span class=\"token punctuation\">(</span>resource<span class=\"token punctuation\">,</span> <span class=\"token comment\">/*forceNextFrame=*/</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，这里同样是通过resourceRecycler进行了回收。在这里，则是交给resource自己的recycle()方法来处理，比如，<em>BitmapResource</em>是交给了<em>BitmapPool</em>进行处理。</p>\n<h3 id=\"BitmapPool\"><a href=\"#BitmapPool\" class=\"headerlink\" title=\"BitmapPool\"></a>BitmapPool</h3><p>这里是专门用来存放被回收的Bitmap的，其中<strong>BitmapDrawableResource</strong>、<strong>BitmapResource</strong>都持有一个<strong>BitmapPool</strong>变量，在执行recycle()方法时候，调用*BitmapPool#put()*方法。我们来看一下这个BitmapPool的默认实现类<strong>LruBitmapPool</strong>的方法实现。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Bitmap</span> bitmap<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bitmap <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NullPointerException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Bitmap must not be null\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">isRecycled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot pool recycled bitmap\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">isMutable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">||</span> strategy<span class=\"token punctuation\">.</span><span class=\"token function\">getSize</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> maxSize\n      <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>allowedConfigs<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">getConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">isLoggable</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token constant\">VERBOSE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>\n        <span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Reject bitmap from pool\"</span>\n        <span class=\"token operator\">+</span> <span class=\"token string\">\", bitmap: \"</span>\n        <span class=\"token operator\">+</span> strategy<span class=\"token punctuation\">.</span><span class=\"token function\">logBitmap</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">+</span> <span class=\"token string\">\", is mutable: \"</span>\n        <span class=\"token operator\">+</span> bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">isMutable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">+</span> <span class=\"token string\">\", is allowed config: \"</span>\n        <span class=\"token operator\">+</span> allowedConfigs<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">getConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">recycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> strategy<span class=\"token punctuation\">.</span><span class=\"token function\">getSize</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  strategy<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  tracker<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里我们可以看出，当Bitmap在三种情况下是不会被BitmapPool缓存起来的：</p>\n<ol>\n<li>这个bitmap是非mutable的，也就是说是不允许被复用的；</li>\n<li>这一个bitmap的字节数大小已经超过了可以容纳的总大小；</li>\n<li>BitmapPool中不允许的Config类型。</li>\n</ol>\n<p>在这种情况，bitmap就被直接recycle掉，而不是放入缓存等待下次使用。</p>\n<p>如果不满足这三种情况，则会被strategy缓存起来，等待下次使用。</p>\n<p>我们再看LruBitmapPool#get()方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token annotation punctuation\">@NonNull</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">Bitmap</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> width<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> height<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Bitmap<span class=\"token punctuation\">.</span>Config</span> config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token class-name\">Bitmap</span> result <span class=\"token operator\">=</span> <span class=\"token function\">getDirtyOrNull</span><span class=\"token punctuation\">(</span>width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    result<span class=\"token punctuation\">.</span><span class=\"token function\">eraseColor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Color</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TRANSPARENT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    result <span class=\"token operator\">=</span> <span class=\"token function\">createBitmap</span><span class=\"token punctuation\">(</span>width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，当能够查询到符合条件的Bitmap的时候，会先通过eraseColor方法，将其变成透明图片，然后再交给调用者来使用；如果查询不到，则创建一个新图交给调用者来使用。</p>\n<blockquote>\n<p>LruBitmapPool的LruPoolStrategy变量，在KITKAT以及以上，是SizeConfigStrategy，在以下是AttributeStrategy，这是因为在KITKAT版本以下，Bitmap的复用需要尺寸的严格匹配，但是KITKAT及以上没有这个问题，只要被复用的图片尺寸比目标尺寸大就可以。</p>\n</blockquote>\n<h3 id=\"ArrayPool\"><a href=\"#ArrayPool\" class=\"headerlink\" title=\"ArrayPool\"></a>ArrayPool</h3><p>ArrayPool主要用在<strong>ThumbnailStreamOpener</strong>和<strong>ByteBufferGifDecoder</strong>中，具体的实现类为<strong>LruArrayPool</strong>。</p>\n<p>在LruArrayPool中，通过groupedMap来缓存数据，而缓存数据的byte字节数是通过<strong>ArrayAdapterInterface</strong>来计算的，ArrayAdapterInterface是一个接口，实现类有两个：<strong>IntegerArrayAdapter</strong>和<strong>ByteArrayAdapter</strong>，分别对应缓存int[].class和byte[].class。</p>\n<p>StreamGifDecoder和StreamBitmapDecoder都有一个ArrayPool成员。解码过程中需要用到byte[]，但不是直接new byte[]，而是调用<code>ArrayPool.get()</code>从对象池中拿，用完了归还。</p>\n<h2 id=\"DiskCache\"><a href=\"#DiskCache\" class=\"headerlink\" title=\"DiskCache\"></a>DiskCache</h2><p>在上一章[Glide源码分析与自我实现(一)——数据加载主流程](&#x2F;源码分析系列&#x2F;Glide源码分析与自我实现2.md)中，提到过数据加载的主流程，其中一个非常重要的类是 <strong>DecodeJob</strong>，在这个类的<code>getNextGenerator</code>方法中，返回的<strong>SourceGenerator</strong>会用来加载远程数据，但是这个方法不止返回这一个<strong>DataFetcherGenerator</strong>类，这是一个通过条件判断，返回不同DataFetcherGenerator类的方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token class-name\">DataFetcherGenerator</span> <span class=\"token function\">getNextGenerator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>stage<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">RESOURCE_CACHE</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ResourceCacheGenerator</span><span class=\"token punctuation\">(</span>decodeHelper<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">DATA_CACHE</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DataCacheGenerator</span><span class=\"token punctuation\">(</span>decodeHelper<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">SOURCE</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SourceGenerator</span><span class=\"token punctuation\">(</span>decodeHelper<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">FINISHED</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unrecognized stage: \"</span> <span class=\"token operator\">+</span> stage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>实际上，这是依次递进的<strong>有限状态机</strong>设计模式，当一个获取数据请求到来时候，此时是默认状态INITIALIZE，然后通过<code>getNextStage</code>方法判断下一个状态是什么，再按照新的状态获取DataFetcherGenerator，然后随着任务的执行，不断改变状态。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token class-name\">Stage</span> <span class=\"token function\">getNextStage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Stage</span> current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">INITIALIZE</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> diskCacheStrategy<span class=\"token punctuation\">.</span><span class=\"token function\">decodeCachedResource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">?</span> <span class=\"token class-name\">Stage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">RESOURCE_CACHE</span>\n        <span class=\"token operator\">:</span> <span class=\"token function\">getNextStage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Stage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">RESOURCE_CACHE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">RESOURCE_CACHE</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> diskCacheStrategy<span class=\"token punctuation\">.</span><span class=\"token function\">decodeCachedData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">?</span> <span class=\"token class-name\">Stage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">DATA_CACHE</span>\n        <span class=\"token operator\">:</span> <span class=\"token function\">getNextStage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Stage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">DATA_CACHE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">DATA_CACHE</span><span class=\"token operator\">:</span>\n      <span class=\"token comment\">// Skip loading from source if the user opted to only retrieve the resource from cache.</span>\n      <span class=\"token keyword\">return</span> onlyRetrieveFromCache <span class=\"token operator\">?</span> <span class=\"token class-name\">Stage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FINISHED</span> <span class=\"token operator\">:</span> <span class=\"token class-name\">Stage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SOURCE</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">SOURCE</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">FINISHED</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token class-name\">Stage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FINISHED</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unrecognized stage: \"</span> <span class=\"token operator\">+</span> current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>其状态变更顺序为INITIALIZE -&gt; RESOURCE_CACHE -&gt; DATA_CACHE -&gt; SOURCE，代表着ResourceCacheGenerator、DataCacheGenerator和SourceGenerator，当从ResourceCahce中拿不到数据，则向DataCacheGenerator请求数据，如果还是拿不到，则通过SourceGenerator去请求数据了。</p>\n<p>在这个过程中，SourceGenerator向DiskCache中写入数据，ResourceCacheGenerator和DataCacheGenerator从DiskCache中读取数据。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ResourceCacheGenerator</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">DataFetcherGenerator</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">startNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n      currentKey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ResourceCacheKey</span><span class=\"token punctuation\">(</span>sourceId<span class=\"token punctuation\">,</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getSignature</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          helper<span class=\"token punctuation\">.</span><span class=\"token function\">getHeight</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> transformation<span class=\"token punctuation\">,</span> resourceClass<span class=\"token punctuation\">,</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getOptions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      cacheFile <span class=\"token operator\">=</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getDiskCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>currentKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cacheFile <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>sourceKey <span class=\"token operator\">=</span> sourceId<span class=\"token punctuation\">;</span>\n        modelLoaders <span class=\"token operator\">=</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getModelLoaders</span><span class=\"token punctuation\">(</span>cacheFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        modelLoaderIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">DataCacheGenerator</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">DataFetcherGenerator</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">startNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>modelLoaders <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token function\">hasNextModelLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n      <span class=\"token class-name\">Key</span> sourceId <span class=\"token operator\">=</span> cacheKeys<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>sourceIdIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token class-name\">Key</span> originalKey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DataCacheKey</span><span class=\"token punctuation\">(</span>sourceId<span class=\"token punctuation\">,</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getSignature</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      cacheFile <span class=\"token operator\">=</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getDiskCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>originalKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cacheFile <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>sourceKey <span class=\"token operator\">=</span> sourceId<span class=\"token punctuation\">;</span>\n        modelLoaders <span class=\"token operator\">=</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getModelLoaders</span><span class=\"token punctuation\">(</span>cacheFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        modelLoaderIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">SourceGenerator</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">DataFetcherGenerator</span> <span class=\"token punctuation\">&#123;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">startNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dataToCache <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token class-name\">Object</span> data <span class=\"token operator\">=</span> dataToCache<span class=\"token punctuation\">;</span>\n      dataToCache <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">cacheData</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">cacheData</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> dataToCache<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">long</span> startTime <span class=\"token operator\">=</span> <span class=\"token class-name\">LogTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLogTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token class-name\">Encoder</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> encoder <span class=\"token operator\">=</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getSourceEncoder</span><span class=\"token punctuation\">(</span>dataToCache<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token class-name\">DataCacheWriter</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> writer <span class=\"token operator\">=</span>\n          <span class=\"token keyword\">new</span> <span class=\"token class-name\">DataCacheWriter</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>encoder<span class=\"token punctuation\">,</span> dataToCache<span class=\"token punctuation\">,</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getOptions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      originalKey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DataCacheKey</span><span class=\"token punctuation\">(</span>loadData<span class=\"token punctuation\">.</span>sourceKey<span class=\"token punctuation\">,</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getSignature</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      helper<span class=\"token punctuation\">.</span><span class=\"token function\">getDiskCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>originalKey<span class=\"token punctuation\">,</span> writer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span>\n      loadData<span class=\"token punctuation\">.</span>fetcher<span class=\"token punctuation\">.</span><span class=\"token function\">cleanup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    sourceCacheGenerator <span class=\"token operator\">=</span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">DataCacheGenerator</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collections</span><span class=\"token punctuation\">.</span><span class=\"token function\">singletonList</span><span class=\"token punctuation\">(</span>loadData<span class=\"token punctuation\">.</span>sourceKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> helper<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>DiskCache的默认实现类是<strong>DiskLruCacheWrapper</strong>，其内部通过<strong>DiskLruCache</strong>来管理磁盘缓存。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>到现在，Glide主要部分已经分析的差不多了，实际上这个优秀的框架可挖的地方还有很多，比如通过[APT来实现很好的扩展](&#x2F;源码分析系列&#x2F;Glide源码分析与自我实现3.md)，框架中涉及多种涉及模式等。</p>\n<blockquote>\n<p>其中涉及到的涉及模式，比如无处不在的<strong>构建者模式</strong>和<strong>工厂模式</strong>，DecodeJob中的<strong>有限状态机模式</strong>，还有BitmapPool和ArrayPool中的<strong>享元模式</strong>，DiskLruCacheWrapper中的<strong>代理模式</strong>等。</p>\n</blockquote>\n<h2 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h2><p><a href=\"https://www.sunmoonblog.com/2018/07/27/glide-cache/\">Glide缓存分析</a></p>\n","excerpt":"","more":"<blockquote>\n<p>本文基于Glide 4.11.0</p>\n</blockquote>\n<p>参考文章：<a href=\"https://zhuanlan.zhihu.com/p/60426316\">Glide 源码分析解读-缓存模块-基于最新版Glide 4.9.0</a></p>\n<p><strong>注意：</strong>由于版本差异问题，本文有些部分与参考文章有差异。</p>\n<p>缓存模块是Glide中非常重要的部分，Glide图片加载的高效性，几乎有一半功劳都在这里了。</p>\n<p>一般来说，Glide有三级缓存，就是<strong>内存缓存</strong>、<strong>磁盘缓存</strong>和<strong>网络缓存</strong>。</p>\n<p>先来看缓存流程图，如下：</p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">style</span> A <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#99ccff</span>\n<span class=\"token keyword\">style</span> B1 <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#aaffaa</span>\nA<span class=\"token text string\">(发起请求)</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">&#123;1. 通过&lt;br>ActiveResources&lt;br>获取资源&#125;</span> <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|命中|</span>B1<span class=\"token text string\">([加载完成])</span><span class=\"token punctuation\">;</span>\nB <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|未命中|</span>C<span class=\"token text string\">&#123;2. 通过&lt;br>MemoryCache&lt;br>获取资源&#125;</span> <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|命中|</span>C1<span class=\"token text string\">[缓存至&lt;br>ActiveResources]</span> <span class=\"token arrow operator\">--></span> B1<span class=\"token punctuation\">;</span>\nC <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|未命中|</span>D<span class=\"token text string\">&#123;3. 通过&lt;br>DiskCache&lt;br>获取资源&#125;</span> <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|命中|</span>D1<span class=\"token text string\">[缓存至&lt;br>MemoryCache]</span> <span class=\"token arrow operator\">--></span> C1<span class=\"token punctuation\">;</span>\nD <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|未命中|</span>E<span class=\"token text string\">[\"4. 通过数据源(网络、文件等)&lt;br>加载数据\"]</span> <span class=\"token arrow operator\">--></span> E1<span class=\"token text string\">[缓存至&lt;br>DiskCache]</span> <span class=\"token arrow operator\">--></span> D1<span class=\"token punctuation\">;</span></code></pre>\n\n<h2 id=\"内存缓存\"><a href=\"#内存缓存\" class=\"headerlink\" title=\"内存缓存\"></a>内存缓存</h2><p>内存缓存主要靠三个部分组成：<strong>ActiveResources</strong>、<strong>MemoryCache</strong>和<strong>BitmapPool</strong>。</p>\n<h3 id=\"ActiveResources\"><a href=\"#ActiveResources\" class=\"headerlink\" title=\"ActiveResources\"></a>ActiveResources</h3><p>ActiveResources表示当前正在活动中的资源。ActiveResources通过一个<code>Map&lt;Key, ResourceWeakReference&gt;</code>来保存活动中的资源，其中的ResourceWeakReference就是资源数据，在构建这个ResourceWeakReference的时候必须传入一个ReferenceQueue用来检测资源是否被回收。</p>\n<blockquote>\n<p><strong>Q1：如何探知WeakReference中的值被回收了呢？</strong></p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token class-name\">ReferenceQueue</span> queue <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">WeakReference</span> wr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakReference</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> queue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>当构建WeakReference的时候，如果传入了queue参数，则在value被回收的时候，wr会被加入到queue中去，这样，通过检测queue中是否有值，就可以探知value是否被回收了。</p>\n</blockquote>\n<p>那么，在何时去探知ReferenceQueue中的值呢？我们查看ActiveResources的关键代码：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">/*构造方法中，通过monitorClearedResourcesExecutor执行了cleanReferenceQueue()方法。\n*/</span>\n<span class=\"token class-name\">ActiveResources</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> isActiveResourceRetentionAllowed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span>\n    isActiveResourceRetentionAllowed<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span>Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newSingleThreadExecutor</span><span class=\"token punctuation\">(</span>\n      <span class=\"token keyword\">new</span> <span class=\"token class-name\">ThreadFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">Thread</span> <span class=\"token function\">newThread</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Runnable</span> r<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n          <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n              <span class=\"token annotation punctuation\">@Override</span>\n              <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token class-name\">Process</span><span class=\"token punctuation\">.</span><span class=\"token function\">setThreadPriority</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Process</span><span class=\"token punctuation\">.</span><span class=\"token constant\">THREAD_PRIORITY_BACKGROUND</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                r<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">&#125;</span>\n            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"glide-active-resources\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token annotation punctuation\">@VisibleForTesting</span>\n<span class=\"token class-name\">ActiveResources</span><span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">boolean</span> isActiveResourceRetentionAllowed<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Executor</span> monitorClearedResourcesExecutor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>isActiveResourceRetentionAllowed <span class=\"token operator\">=</span> isActiveResourceRetentionAllowed<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>monitorClearedResourcesExecutor <span class=\"token operator\">=</span> monitorClearedResourcesExecutor<span class=\"token punctuation\">;</span>\n\n  monitorClearedResourcesExecutor<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token annotation punctuation\">@Override</span>\n      <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">cleanReferenceQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">cleanReferenceQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isShutdown<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token class-name\">ResourceWeakReference</span> ref <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ResourceWeakReference</span><span class=\"token punctuation\">)</span> resourceReferenceQueue<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">cleanupActiveReference</span><span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// This section for testing only.</span>\n      <span class=\"token class-name\">DequeuedResourceCallback</span> current <span class=\"token operator\">=</span> cb<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        current<span class=\"token punctuation\">.</span><span class=\"token function\">onResourceDequeued</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token comment\">// End for testing only.</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们通过代码可以看出，<code>cleanReferenceQueue</code>是一个靠<code>isShutdown</code>变量控制的<strong>死循环</strong>方法，这个方法执行在一个优先级为<code>THREAD_PRIORITY_BACKGROUND</code>的线程上。</p>\n<blockquote>\n<p><strong>Q2：那么，既然是死循环方法，会不会过多的占用CPU资源呢？</strong></p>\n<p>其实不会的，因为ReferenceQueue#remove是一个阻塞式的方法，如果没有元素可以被remove，则等待至有元素可以remove的时候，等待期间释放CPU。</p>\n</blockquote>\n<blockquote>\n<p><strong>注意：</strong>此处与<strong>参考文章</strong>中的说法不同，这是因为版本差异。查看<a href=\"https://github.com/bumptech/glide/commit/8f1ea5c07dff7ade8c49c324bcb5a7f40d0b4891#diff-c46e6c0760c04e74cb867c2bdf9cdee90ab279b119268478524c42cc743cb8a9\">Glide update log hsitory</a>，可以看出<strong>出于避免在主线程做清理的原因</strong>，将清理任务放在了后台线程，而不是放在IdleHandler中。</p>\n</blockquote>\n<p><strong>那么被回收了的资源去哪里了呢？</strong></p>\n<p>我们查看<code>cleanupActiveReference</code>方法，得知，通过<em>ResourceListener#onResourceReleased</em>回调，交给了<strong>Engine</strong>来处理，我们查看Engine的onResourceReleased方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onResourceReleased</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Key</span> cacheKey<span class=\"token punctuation\">,</span> <span class=\"token class-name\">EngineResource</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> resource<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  activeResources<span class=\"token punctuation\">.</span><span class=\"token function\">deactivate</span><span class=\"token punctuation\">(</span>cacheKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>resource<span class=\"token punctuation\">.</span><span class=\"token function\">isMemoryCacheable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>cacheKey<span class=\"token punctuation\">,</span> resource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    resourceRecycler<span class=\"token punctuation\">.</span><span class=\"token function\">recycle</span><span class=\"token punctuation\">(</span>resource<span class=\"token punctuation\">,</span> <span class=\"token comment\">/*forceNextFrame=*/</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>从这里我们发现，这里出现了两种情况：</p>\n<ol>\n<li>如果资源是<strong>MemoryCacheable</strong>的，则缓存在MemoryCache；</li>\n<li>如果资源不是<strong>MemoryCacheable</strong>的，则交给ResourceRecycler调用Resource的recycle()方法来回收，如果此Resource为BitmapResource，则会将Bitmap回收到BitmapPool中去。</li>\n</ol>\n<p>在开始MemoryCache和BitmapPool前，需要先了解一下<strong>MemorySizeCalculator</strong>这个类，这个类是用来计算 BitmapPool 、ArrayPool 以及 MemoryCache <strong>大小</strong>的。</p>\n<h3 id=\"MemoryCache\"><a href=\"#MemoryCache\" class=\"headerlink\" title=\"MemoryCache\"></a>MemoryCache</h3><p>MemoryCache的具体实现类是LruResourceCache，而实际的逻辑方法，都在其父类LruCache中，以put方法为例。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Nullable</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token class-name\">Y</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">T</span> key<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">Y</span> item<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> itemSize <span class=\"token operator\">=</span> <span class=\"token function\">getSize</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>itemSize <span class=\"token operator\">>=</span> maxSize<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token function\">onItemEvicted</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>item <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    currentSize <span class=\"token operator\">+=</span> itemSize<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Y</span><span class=\"token punctuation\">></span></span> old <span class=\"token operator\">=</span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> item <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">,</span> itemSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>old <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    currentSize <span class=\"token operator\">-=</span> old<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>old<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">onItemEvicted</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> old<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token function\">evict</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> old <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> old<span class=\"token punctuation\">.</span>value <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>当有一个新的item被put进去以后，会替换出一个老的值old，如果old非为空，则需要将当前容量减去old的大小，如果old并非新的item，则需要通过onItemEvicted进行回调，通知有老值被<strong>“驱逐”</strong>了。最后还要执行一次evict方法，按照LRU算法，将超出maxSize的item<strong>“驱逐”</strong>出去，以确保在maxSize范围内。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">protected</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">trimToSize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Y</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> last<span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Y</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> cacheIterator<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>currentSize <span class=\"token operator\">></span> size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    cacheIterator <span class=\"token operator\">=</span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">entrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    last <span class=\"token operator\">=</span> cacheIterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Y</span><span class=\"token punctuation\">></span></span> toRemove <span class=\"token operator\">=</span> last<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    currentSize <span class=\"token operator\">-=</span> toRemove<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">T</span> key <span class=\"token operator\">=</span> last<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cacheIterator<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">onItemEvicted</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> toRemove<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">evict</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">trimToSize</span><span class=\"token punctuation\">(</span>maxSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>被**”驱逐”*<em>的值去哪里了呢？我们查看</em>MemoryCache<em>类的源码，可以知道是通过</em>ResourceRemovedListener<em>回调给了</em>Engine<em>，在</em>Engine<em>中我们查看</em>onResourceRemoved*方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onResourceRemoved</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Resource</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> resource<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// Avoid deadlock with RequestManagers when recycling triggers recursive clear() calls.</span>\n  <span class=\"token comment\">// See b/145519760.</span>\n  resourceRecycler<span class=\"token punctuation\">.</span><span class=\"token function\">recycle</span><span class=\"token punctuation\">(</span>resource<span class=\"token punctuation\">,</span> <span class=\"token comment\">/*forceNextFrame=*/</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，这里同样是通过resourceRecycler进行了回收。在这里，则是交给resource自己的recycle()方法来处理，比如，<em>BitmapResource</em>是交给了<em>BitmapPool</em>进行处理。</p>\n<h3 id=\"BitmapPool\"><a href=\"#BitmapPool\" class=\"headerlink\" title=\"BitmapPool\"></a>BitmapPool</h3><p>这里是专门用来存放被回收的Bitmap的，其中<strong>BitmapDrawableResource</strong>、<strong>BitmapResource</strong>都持有一个<strong>BitmapPool</strong>变量，在执行recycle()方法时候，调用*BitmapPool#put()*方法。我们来看一下这个BitmapPool的默认实现类<strong>LruBitmapPool</strong>的方法实现。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Bitmap</span> bitmap<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bitmap <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NullPointerException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Bitmap must not be null\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">isRecycled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot pool recycled bitmap\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">isMutable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">||</span> strategy<span class=\"token punctuation\">.</span><span class=\"token function\">getSize</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> maxSize\n      <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>allowedConfigs<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">getConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">isLoggable</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token constant\">VERBOSE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>\n        <span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Reject bitmap from pool\"</span>\n        <span class=\"token operator\">+</span> <span class=\"token string\">\", bitmap: \"</span>\n        <span class=\"token operator\">+</span> strategy<span class=\"token punctuation\">.</span><span class=\"token function\">logBitmap</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">+</span> <span class=\"token string\">\", is mutable: \"</span>\n        <span class=\"token operator\">+</span> bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">isMutable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">+</span> <span class=\"token string\">\", is allowed config: \"</span>\n        <span class=\"token operator\">+</span> allowedConfigs<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">getConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">recycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> strategy<span class=\"token punctuation\">.</span><span class=\"token function\">getSize</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  strategy<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  tracker<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里我们可以看出，当Bitmap在三种情况下是不会被BitmapPool缓存起来的：</p>\n<ol>\n<li>这个bitmap是非mutable的，也就是说是不允许被复用的；</li>\n<li>这一个bitmap的字节数大小已经超过了可以容纳的总大小；</li>\n<li>BitmapPool中不允许的Config类型。</li>\n</ol>\n<p>在这种情况，bitmap就被直接recycle掉，而不是放入缓存等待下次使用。</p>\n<p>如果不满足这三种情况，则会被strategy缓存起来，等待下次使用。</p>\n<p>我们再看LruBitmapPool#get()方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token annotation punctuation\">@NonNull</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">Bitmap</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> width<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> height<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Bitmap<span class=\"token punctuation\">.</span>Config</span> config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token class-name\">Bitmap</span> result <span class=\"token operator\">=</span> <span class=\"token function\">getDirtyOrNull</span><span class=\"token punctuation\">(</span>width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    result<span class=\"token punctuation\">.</span><span class=\"token function\">eraseColor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Color</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TRANSPARENT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    result <span class=\"token operator\">=</span> <span class=\"token function\">createBitmap</span><span class=\"token punctuation\">(</span>width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，当能够查询到符合条件的Bitmap的时候，会先通过eraseColor方法，将其变成透明图片，然后再交给调用者来使用；如果查询不到，则创建一个新图交给调用者来使用。</p>\n<blockquote>\n<p>LruBitmapPool的LruPoolStrategy变量，在KITKAT以及以上，是SizeConfigStrategy，在以下是AttributeStrategy，这是因为在KITKAT版本以下，Bitmap的复用需要尺寸的严格匹配，但是KITKAT及以上没有这个问题，只要被复用的图片尺寸比目标尺寸大就可以。</p>\n</blockquote>\n<h3 id=\"ArrayPool\"><a href=\"#ArrayPool\" class=\"headerlink\" title=\"ArrayPool\"></a>ArrayPool</h3><p>ArrayPool主要用在<strong>ThumbnailStreamOpener</strong>和<strong>ByteBufferGifDecoder</strong>中，具体的实现类为<strong>LruArrayPool</strong>。</p>\n<p>在LruArrayPool中，通过groupedMap来缓存数据，而缓存数据的byte字节数是通过<strong>ArrayAdapterInterface</strong>来计算的，ArrayAdapterInterface是一个接口，实现类有两个：<strong>IntegerArrayAdapter</strong>和<strong>ByteArrayAdapter</strong>，分别对应缓存int[].class和byte[].class。</p>\n<p>StreamGifDecoder和StreamBitmapDecoder都有一个ArrayPool成员。解码过程中需要用到byte[]，但不是直接new byte[]，而是调用<code>ArrayPool.get()</code>从对象池中拿，用完了归还。</p>\n<h2 id=\"DiskCache\"><a href=\"#DiskCache\" class=\"headerlink\" title=\"DiskCache\"></a>DiskCache</h2><p>在上一章[Glide源码分析与自我实现(一)——数据加载主流程](&#x2F;源码分析系列&#x2F;Glide源码分析与自我实现2.md)中，提到过数据加载的主流程，其中一个非常重要的类是 <strong>DecodeJob</strong>，在这个类的<code>getNextGenerator</code>方法中，返回的<strong>SourceGenerator</strong>会用来加载远程数据，但是这个方法不止返回这一个<strong>DataFetcherGenerator</strong>类，这是一个通过条件判断，返回不同DataFetcherGenerator类的方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token class-name\">DataFetcherGenerator</span> <span class=\"token function\">getNextGenerator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>stage<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">RESOURCE_CACHE</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ResourceCacheGenerator</span><span class=\"token punctuation\">(</span>decodeHelper<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">DATA_CACHE</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DataCacheGenerator</span><span class=\"token punctuation\">(</span>decodeHelper<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">SOURCE</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SourceGenerator</span><span class=\"token punctuation\">(</span>decodeHelper<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">FINISHED</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unrecognized stage: \"</span> <span class=\"token operator\">+</span> stage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>实际上，这是依次递进的<strong>有限状态机</strong>设计模式，当一个获取数据请求到来时候，此时是默认状态INITIALIZE，然后通过<code>getNextStage</code>方法判断下一个状态是什么，再按照新的状态获取DataFetcherGenerator，然后随着任务的执行，不断改变状态。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token class-name\">Stage</span> <span class=\"token function\">getNextStage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Stage</span> current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">INITIALIZE</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> diskCacheStrategy<span class=\"token punctuation\">.</span><span class=\"token function\">decodeCachedResource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">?</span> <span class=\"token class-name\">Stage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">RESOURCE_CACHE</span>\n        <span class=\"token operator\">:</span> <span class=\"token function\">getNextStage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Stage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">RESOURCE_CACHE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">RESOURCE_CACHE</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> diskCacheStrategy<span class=\"token punctuation\">.</span><span class=\"token function\">decodeCachedData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">?</span> <span class=\"token class-name\">Stage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">DATA_CACHE</span>\n        <span class=\"token operator\">:</span> <span class=\"token function\">getNextStage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Stage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">DATA_CACHE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">DATA_CACHE</span><span class=\"token operator\">:</span>\n      <span class=\"token comment\">// Skip loading from source if the user opted to only retrieve the resource from cache.</span>\n      <span class=\"token keyword\">return</span> onlyRetrieveFromCache <span class=\"token operator\">?</span> <span class=\"token class-name\">Stage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FINISHED</span> <span class=\"token operator\">:</span> <span class=\"token class-name\">Stage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SOURCE</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">SOURCE</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">FINISHED</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token class-name\">Stage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FINISHED</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unrecognized stage: \"</span> <span class=\"token operator\">+</span> current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>其状态变更顺序为INITIALIZE -&gt; RESOURCE_CACHE -&gt; DATA_CACHE -&gt; SOURCE，代表着ResourceCacheGenerator、DataCacheGenerator和SourceGenerator，当从ResourceCahce中拿不到数据，则向DataCacheGenerator请求数据，如果还是拿不到，则通过SourceGenerator去请求数据了。</p>\n<p>在这个过程中，SourceGenerator向DiskCache中写入数据，ResourceCacheGenerator和DataCacheGenerator从DiskCache中读取数据。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ResourceCacheGenerator</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">DataFetcherGenerator</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">startNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n      currentKey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ResourceCacheKey</span><span class=\"token punctuation\">(</span>sourceId<span class=\"token punctuation\">,</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getSignature</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          helper<span class=\"token punctuation\">.</span><span class=\"token function\">getHeight</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> transformation<span class=\"token punctuation\">,</span> resourceClass<span class=\"token punctuation\">,</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getOptions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      cacheFile <span class=\"token operator\">=</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getDiskCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>currentKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cacheFile <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>sourceKey <span class=\"token operator\">=</span> sourceId<span class=\"token punctuation\">;</span>\n        modelLoaders <span class=\"token operator\">=</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getModelLoaders</span><span class=\"token punctuation\">(</span>cacheFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        modelLoaderIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">DataCacheGenerator</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">DataFetcherGenerator</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">startNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>modelLoaders <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token function\">hasNextModelLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n      <span class=\"token class-name\">Key</span> sourceId <span class=\"token operator\">=</span> cacheKeys<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>sourceIdIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token class-name\">Key</span> originalKey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DataCacheKey</span><span class=\"token punctuation\">(</span>sourceId<span class=\"token punctuation\">,</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getSignature</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      cacheFile <span class=\"token operator\">=</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getDiskCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>originalKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cacheFile <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>sourceKey <span class=\"token operator\">=</span> sourceId<span class=\"token punctuation\">;</span>\n        modelLoaders <span class=\"token operator\">=</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getModelLoaders</span><span class=\"token punctuation\">(</span>cacheFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        modelLoaderIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">SourceGenerator</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">DataFetcherGenerator</span> <span class=\"token punctuation\">&#123;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">startNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dataToCache <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token class-name\">Object</span> data <span class=\"token operator\">=</span> dataToCache<span class=\"token punctuation\">;</span>\n      dataToCache <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">cacheData</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">cacheData</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> dataToCache<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">long</span> startTime <span class=\"token operator\">=</span> <span class=\"token class-name\">LogTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLogTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token class-name\">Encoder</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> encoder <span class=\"token operator\">=</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getSourceEncoder</span><span class=\"token punctuation\">(</span>dataToCache<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token class-name\">DataCacheWriter</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> writer <span class=\"token operator\">=</span>\n          <span class=\"token keyword\">new</span> <span class=\"token class-name\">DataCacheWriter</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>encoder<span class=\"token punctuation\">,</span> dataToCache<span class=\"token punctuation\">,</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getOptions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      originalKey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DataCacheKey</span><span class=\"token punctuation\">(</span>loadData<span class=\"token punctuation\">.</span>sourceKey<span class=\"token punctuation\">,</span> helper<span class=\"token punctuation\">.</span><span class=\"token function\">getSignature</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      helper<span class=\"token punctuation\">.</span><span class=\"token function\">getDiskCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>originalKey<span class=\"token punctuation\">,</span> writer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span>\n      loadData<span class=\"token punctuation\">.</span>fetcher<span class=\"token punctuation\">.</span><span class=\"token function\">cleanup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    sourceCacheGenerator <span class=\"token operator\">=</span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">DataCacheGenerator</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collections</span><span class=\"token punctuation\">.</span><span class=\"token function\">singletonList</span><span class=\"token punctuation\">(</span>loadData<span class=\"token punctuation\">.</span>sourceKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> helper<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>DiskCache的默认实现类是<strong>DiskLruCacheWrapper</strong>，其内部通过<strong>DiskLruCache</strong>来管理磁盘缓存。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>到现在，Glide主要部分已经分析的差不多了，实际上这个优秀的框架可挖的地方还有很多，比如通过[APT来实现很好的扩展](&#x2F;源码分析系列&#x2F;Glide源码分析与自我实现3.md)，框架中涉及多种涉及模式等。</p>\n<blockquote>\n<p>其中涉及到的涉及模式，比如无处不在的<strong>构建者模式</strong>和<strong>工厂模式</strong>，DecodeJob中的<strong>有限状态机模式</strong>，还有BitmapPool和ArrayPool中的<strong>享元模式</strong>，DiskLruCacheWrapper中的<strong>代理模式</strong>等。</p>\n</blockquote>\n<h2 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h2><p><a href=\"https://www.sunmoonblog.com/2018/07/27/glide-cache/\">Glide缓存分析</a></p>\n"},{"layout":"post","title":"Jetpack之Lifecycle源码分析","author":"boybeak","date":"2022-09-16T20:00:00.000Z","_content":"\n\n这是一篇解析jetpack库中的**Lifecycle**库的分析文章。\n\n```groovy\ndef lifecycle_version = \"2.2.0\"\n// Lifecycles only (without ViewModel or LiveData)\nimplementation \"androidx.lifecycle:lifecycle-runtime-ktx:$lifecycle_version\"\n// Annotation processor\nkapt \"androidx.lifecycle:lifecycle-compiler:$lifecycle_version\"\n```\n\n```kotlin\nclass MyObserver : LifecycleObserver {\n    @OnLifecycleEvent(Lifecycle.Event.ON_CREATE)\n    fun onCreate() {\n\n    }\n\n    @OnLifecycleEvent(Lifecycle.Event.ON_PAUSE)\n    fun onPause() {\n\n    }\n}\n```\n\n```kotlin\nclass MainActivity : AppCompatActivity() {\n    override fun onCreate(savedInstanceState: Bundle?) {\n        super.onCreate(savedInstanceState)\n        setContentView(R.layout.activity_main)\n\n        lifecycle.addObserver(MyObserver())\n    }\n}\n```\n\n这是一个很典型的Lifecycle库的使用过程，通过注解的方式，在*MyObserver*中声明对应的生命周期函数，然后将这个*MyObserver*实例添加到*MainActivity*的lifecycle中去。\n\n看到与注解相关，熟悉框架源码的朋友可能已经知道如何去分析了，很可能用到**注解处理器**，与[**ARouter**](https://boybeak.github.io/2020/11/28/2022-09-17-ARouter%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/)类似，Lifecycle的工作流程也分成两部分——**编译时**和**运行时**。\n\n简要的说，在编译时，生成**LifecycleObserver**的辅助类；在运行时，*addObserver*方法被调用后，解析出对应observer的辅助类。\n\n## 生命周期探知\n\n在正式详解这两个过程前，我们需要先要了解Lifecycle库是如何感知生命周期的呢？\n\n读过Glide源码(附上[Glide源码解读](https://boybeak.github.io/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97/Glide%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%8E%E8%87%AA%E6%88%91%E5%AE%9E%E7%8E%B01.html))的同学可能知道，Glide感知生命周期是通过一个无UI的fragment来实现的，其实，Lifecycle也是这么做的。\n\n对外提供生命周期的类，需要实现LifecycleOwner接口。\n\n```kotlin\npublic interface LifecycleOwner {\n    /**\n     * Returns the Lifecycle of the provider.\n     *\n     * @return The lifecycle of the provider.\n     */\n    @NonNull\n    Lifecycle getLifecycle();\n}\n```\n\n我们以*AppCompatActivity*为例去查看它是如何实现的这个接口，我们查看其父类中有一个*ComponentActivity*类(AppCompatActivity -> FragmentActivity -> ComponentActivity)。\n\n```kotlin\npublic class ComponentActivity extends androidx.core.app.ComponentActivity implements\n        LifecycleOwner,\n        ViewModelStoreOwner,\n        SavedStateRegistryOwner,\n        OnBackPressedDispatcherOwner {\n        @Override\n    protected void onCreate(@Nullable Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        mSavedStateRegistryController.performRestore(savedInstanceState);\n        ReportFragment.injectIfNeededIn(this);\n        if (mContentLayoutId != 0) {\n            setContentView(mContentLayoutId);\n        }\n    }\n}\n```\n\n注意此处，有一个*ReportFragment*执行了injectIfNeededIn方法，在这个方法中，就是检测是否已经添加了这个*ReportFragment*，如果没添加则添加一个。继续查看这个*ReportFragment*的源码，可以在其生命周期函数中，执行了分发生命周期的流程。\n\n```kotlin\npublic class ReportFragment extends Fragment {\n  static void dispatch(@NonNull Activity activity, @NonNull Lifecycle.Event event) {\n    if (activity instanceof LifecycleRegistryOwner) {\n      ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);\n      return;\n    }\n\n    if (activity instanceof LifecycleOwner) { // 3\n      Lifecycle lifecycle = ((LifecycleOwner) activity).getLifecycle();\n      if (lifecycle instanceof LifecycleRegistry) {\n        ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);\n      }\n    }\n  }\n\n  private void dispatchCreate(ActivityInitializationListener listener) {\n    if (listener != null) {\n      listener.onCreate();\n    }\n  }\n\n  @Override\n  public void onActivityCreated(Bundle savedInstanceState) {\n    super.onActivityCreated(savedInstanceState);\n    dispatchCreate(mProcessListener);\n    dispatch(Lifecycle.Event.ON_CREATE); // 1\n  }\n\n  private void dispatch(@NonNull Lifecycle.Event event) {\n    if (Build.VERSION.SDK_INT < 29) {\n      // Only dispatch events from ReportFragment on API levels prior\n      // to API 29. On API 29+, this is handled by the ActivityLifecycleCallbacks\n      // added in ReportFragment.injectIfNeededIn\n      dispatch(getActivity(), event); // 2\n    }\n  }\n\n}\n```\n\n看代码中我标注的注释顺序onActivityCreated -> dispatch(Lifecycle.Event) -> dispatch(Activity, Lifecycle.Event)，我们看到最后一个流程中，拿到*Lifecycle*对象后，判断是否为*LifecycleRegistry*类，如果是，则调用handleLifecycleEvent方法。这里，*ComponentActivity*提供的*Lifecycle*对象就是*LifecycleRegistry*类。\n\n经过这样一个流程，我们就将感知生命周期的无UI的*ReportFragment*与执行事件的*LifecycleRegistry*进行了连接。这样我们就获得了感知生命周期的能力了。\n\n那么具体是如何执行到*MyObserver*对应的生命周期的方法的呢？\n\n> 或许你看到这里，会觉得很简单，在*LifecycleRegistry*维护一个observer队列，然后在执行handleLifecycleEvent方法的时候，通过反射从*MyObserver*中筛选出带有 ** @OnLifecycleEvent ** 注解的方法，如果注解中的值与事件event相等，则通过method.invoke()来调用。\n>\n> 可是谷歌工程师并没有这么做，因为在执行事件时候，经过这么多反射，效率会很低。那么正确的流程是怎么样的？这就需要我们关注上面提到的两个流程了——**编译时**和**运行时**。\n\n\n\n## 编译时\n\n参考[Lifecycle-compiler](https://android.googlesource.com/platform/frameworks/support/+/androidx-master-dev/lifecycle/lifecycle-compiler)源码。\n\n通过注解处理器，AS为我们生成了MyObserver的辅助类——*MyObserver_LifecycleAdapter*。\n\n```java\npublic class MyObserver_LifecycleAdapter implements GeneratedAdapter {\n  final MyObserver mReceiver;\n\n  MyObserver_LifecycleAdapter(MyObserver receiver) {\n    this.mReceiver = receiver;\n  }\n\n  @Override\n  public void callMethods(LifecycleOwner owner, Lifecycle.Event event, boolean onAny,\n      MethodCallsLogger logger) {\n    boolean hasLogger = logger != null;\n    if (onAny) {\n      return;\n    }\n    if (event == Lifecycle.Event.ON_CREATE) {\n      if (!hasLogger || logger.approveCall(\"onCreate\", 1)) {\n        mReceiver.onCreate();\n      }\n      return;\n    }\n    if (event == Lifecycle.Event.ON_PAUSE) {\n      if (!hasLogger || logger.approveCall(\"onPause\", 1)) {\n        mReceiver.onPause();\n      }\n      return;\n    }\n  }\n}\n```\n\n我们可以看到，实际的生命周期事件分发是在这里完成的。那么这个辅助类是在哪里被使用到的呢？\n\n接下来就是**运行时**发挥作用的时候了。\n\n\n\n## 运行时\n\n运行时的起点，是从*addObserver*开始的。\n\n我们查看*LifecycleRegistry#addObserver*方法。\n\n```java\nprivate FastSafeIterableMap<LifecycleObserver, ObserverWithState> mObserverMap =\n            new FastSafeIterableMap<>();\n@Override\npublic void addObserver(@NonNull LifecycleObserver observer) {\n  State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;\n  ObserverWithState statefulObserver = new ObserverWithState(observer, initialState);\n  ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);\n  ...\n}\n```\n\n我们可以看到，*LifecycleRegistry*中并不是直接维护observer对象，而是维护*ObserverWithState*对象。\n\n```java\nstatic class ObserverWithState {\n  State mState;\n  LifecycleEventObserver mLifecycleObserver;\n\n  ObserverWithState(LifecycleObserver observer, State initialState) {\n    mLifecycleObserver = Lifecycling.lifecycleEventObserver(observer);\n    mState = initialState;\n  }\n\n  void dispatchEvent(LifecycleOwner owner, Event event) {\n    State newState = getStateAfter(event);\n    mState = min(mState, newState);\n    mLifecycleObserver.onStateChanged(owner, event);\n    mState = newState;\n  }\n}\n```\n\n在这个类的构造方法中，执行了一个`mLifecycleObserver = Lifecycling.lifecycleEventObserver(observer);`\n\n在我们的案例中，这个方法返回了一个*SingleGeneratedAdapterObserver*类，我们查看这个类的代码。\n\n```java\nclass SingleGeneratedAdapterObserver implements LifecycleEventObserver {\n\n    private final GeneratedAdapter mGeneratedAdapter;\n\n    SingleGeneratedAdapterObserver(GeneratedAdapter generatedAdapter) {\n        mGeneratedAdapter = generatedAdapter;\n    }\n\n    @Override\n    public void onStateChanged(@NonNull LifecycleOwner source, @NonNull Lifecycle.Event event) {\n        mGeneratedAdapter.callMethods(source, event, false, null);\n        mGeneratedAdapter.callMethods(source, event, true, null);\n    }\n}\n```\n\n也就是在这里，调用了*MyObserver_LifecycleAdapter*的*callMethods*方法。\n\n那么是如何找到*MyObserver_LifecycleAdapter*方法的呢？\n\n在*Lifecycling*类中，通过observer的类名来找的，我们看到有这样的一个方法：\n\n```java\npublic static String getAdapterName(String className) {\n  return className.replace(\".\", \"_\") + \"_LifecycleAdapter\";\n}\n```\n\n这样，整个流程就串起来了。\n\n\n\n## 总结\n\n编译时：生成*XXX_LifecycleAdapter*类，用来分发不同的生命周期事件。\n\n运行时：在addObserver时候，通过类名找到这个*XXX_LifecycleAdapter*类，生成对象在*LifecycleRegistry*中进行维护；在ReportFragment方法中触发生命周期时候，调用*LifecycleRegistry*的*handleLifecycleEvent*方法进行具体的生命周期事件分发。\n\n总体来看，其整个流程并不复杂，我们可以看到ARouter、Glide的影子，读过其他源码后，理解这个并不难。","source":"_posts/2022-09-17-Jetpack之Lifecycle源码分析.md","raw":"---\nlayout: post\ntitle: Jetpack之Lifecycle源码分析\nauthor: boybeak\ncategory: 源码分析\ntags: Android\ndate: 2022-09-17 04:00:00\n---\n\n\n这是一篇解析jetpack库中的**Lifecycle**库的分析文章。\n\n```groovy\ndef lifecycle_version = \"2.2.0\"\n// Lifecycles only (without ViewModel or LiveData)\nimplementation \"androidx.lifecycle:lifecycle-runtime-ktx:$lifecycle_version\"\n// Annotation processor\nkapt \"androidx.lifecycle:lifecycle-compiler:$lifecycle_version\"\n```\n\n```kotlin\nclass MyObserver : LifecycleObserver {\n    @OnLifecycleEvent(Lifecycle.Event.ON_CREATE)\n    fun onCreate() {\n\n    }\n\n    @OnLifecycleEvent(Lifecycle.Event.ON_PAUSE)\n    fun onPause() {\n\n    }\n}\n```\n\n```kotlin\nclass MainActivity : AppCompatActivity() {\n    override fun onCreate(savedInstanceState: Bundle?) {\n        super.onCreate(savedInstanceState)\n        setContentView(R.layout.activity_main)\n\n        lifecycle.addObserver(MyObserver())\n    }\n}\n```\n\n这是一个很典型的Lifecycle库的使用过程，通过注解的方式，在*MyObserver*中声明对应的生命周期函数，然后将这个*MyObserver*实例添加到*MainActivity*的lifecycle中去。\n\n看到与注解相关，熟悉框架源码的朋友可能已经知道如何去分析了，很可能用到**注解处理器**，与[**ARouter**](https://boybeak.github.io/2020/11/28/2022-09-17-ARouter%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/)类似，Lifecycle的工作流程也分成两部分——**编译时**和**运行时**。\n\n简要的说，在编译时，生成**LifecycleObserver**的辅助类；在运行时，*addObserver*方法被调用后，解析出对应observer的辅助类。\n\n## 生命周期探知\n\n在正式详解这两个过程前，我们需要先要了解Lifecycle库是如何感知生命周期的呢？\n\n读过Glide源码(附上[Glide源码解读](https://boybeak.github.io/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97/Glide%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%8E%E8%87%AA%E6%88%91%E5%AE%9E%E7%8E%B01.html))的同学可能知道，Glide感知生命周期是通过一个无UI的fragment来实现的，其实，Lifecycle也是这么做的。\n\n对外提供生命周期的类，需要实现LifecycleOwner接口。\n\n```kotlin\npublic interface LifecycleOwner {\n    /**\n     * Returns the Lifecycle of the provider.\n     *\n     * @return The lifecycle of the provider.\n     */\n    @NonNull\n    Lifecycle getLifecycle();\n}\n```\n\n我们以*AppCompatActivity*为例去查看它是如何实现的这个接口，我们查看其父类中有一个*ComponentActivity*类(AppCompatActivity -> FragmentActivity -> ComponentActivity)。\n\n```kotlin\npublic class ComponentActivity extends androidx.core.app.ComponentActivity implements\n        LifecycleOwner,\n        ViewModelStoreOwner,\n        SavedStateRegistryOwner,\n        OnBackPressedDispatcherOwner {\n        @Override\n    protected void onCreate(@Nullable Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        mSavedStateRegistryController.performRestore(savedInstanceState);\n        ReportFragment.injectIfNeededIn(this);\n        if (mContentLayoutId != 0) {\n            setContentView(mContentLayoutId);\n        }\n    }\n}\n```\n\n注意此处，有一个*ReportFragment*执行了injectIfNeededIn方法，在这个方法中，就是检测是否已经添加了这个*ReportFragment*，如果没添加则添加一个。继续查看这个*ReportFragment*的源码，可以在其生命周期函数中，执行了分发生命周期的流程。\n\n```kotlin\npublic class ReportFragment extends Fragment {\n  static void dispatch(@NonNull Activity activity, @NonNull Lifecycle.Event event) {\n    if (activity instanceof LifecycleRegistryOwner) {\n      ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);\n      return;\n    }\n\n    if (activity instanceof LifecycleOwner) { // 3\n      Lifecycle lifecycle = ((LifecycleOwner) activity).getLifecycle();\n      if (lifecycle instanceof LifecycleRegistry) {\n        ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);\n      }\n    }\n  }\n\n  private void dispatchCreate(ActivityInitializationListener listener) {\n    if (listener != null) {\n      listener.onCreate();\n    }\n  }\n\n  @Override\n  public void onActivityCreated(Bundle savedInstanceState) {\n    super.onActivityCreated(savedInstanceState);\n    dispatchCreate(mProcessListener);\n    dispatch(Lifecycle.Event.ON_CREATE); // 1\n  }\n\n  private void dispatch(@NonNull Lifecycle.Event event) {\n    if (Build.VERSION.SDK_INT < 29) {\n      // Only dispatch events from ReportFragment on API levels prior\n      // to API 29. On API 29+, this is handled by the ActivityLifecycleCallbacks\n      // added in ReportFragment.injectIfNeededIn\n      dispatch(getActivity(), event); // 2\n    }\n  }\n\n}\n```\n\n看代码中我标注的注释顺序onActivityCreated -> dispatch(Lifecycle.Event) -> dispatch(Activity, Lifecycle.Event)，我们看到最后一个流程中，拿到*Lifecycle*对象后，判断是否为*LifecycleRegistry*类，如果是，则调用handleLifecycleEvent方法。这里，*ComponentActivity*提供的*Lifecycle*对象就是*LifecycleRegistry*类。\n\n经过这样一个流程，我们就将感知生命周期的无UI的*ReportFragment*与执行事件的*LifecycleRegistry*进行了连接。这样我们就获得了感知生命周期的能力了。\n\n那么具体是如何执行到*MyObserver*对应的生命周期的方法的呢？\n\n> 或许你看到这里，会觉得很简单，在*LifecycleRegistry*维护一个observer队列，然后在执行handleLifecycleEvent方法的时候，通过反射从*MyObserver*中筛选出带有 ** @OnLifecycleEvent ** 注解的方法，如果注解中的值与事件event相等，则通过method.invoke()来调用。\n>\n> 可是谷歌工程师并没有这么做，因为在执行事件时候，经过这么多反射，效率会很低。那么正确的流程是怎么样的？这就需要我们关注上面提到的两个流程了——**编译时**和**运行时**。\n\n\n\n## 编译时\n\n参考[Lifecycle-compiler](https://android.googlesource.com/platform/frameworks/support/+/androidx-master-dev/lifecycle/lifecycle-compiler)源码。\n\n通过注解处理器，AS为我们生成了MyObserver的辅助类——*MyObserver_LifecycleAdapter*。\n\n```java\npublic class MyObserver_LifecycleAdapter implements GeneratedAdapter {\n  final MyObserver mReceiver;\n\n  MyObserver_LifecycleAdapter(MyObserver receiver) {\n    this.mReceiver = receiver;\n  }\n\n  @Override\n  public void callMethods(LifecycleOwner owner, Lifecycle.Event event, boolean onAny,\n      MethodCallsLogger logger) {\n    boolean hasLogger = logger != null;\n    if (onAny) {\n      return;\n    }\n    if (event == Lifecycle.Event.ON_CREATE) {\n      if (!hasLogger || logger.approveCall(\"onCreate\", 1)) {\n        mReceiver.onCreate();\n      }\n      return;\n    }\n    if (event == Lifecycle.Event.ON_PAUSE) {\n      if (!hasLogger || logger.approveCall(\"onPause\", 1)) {\n        mReceiver.onPause();\n      }\n      return;\n    }\n  }\n}\n```\n\n我们可以看到，实际的生命周期事件分发是在这里完成的。那么这个辅助类是在哪里被使用到的呢？\n\n接下来就是**运行时**发挥作用的时候了。\n\n\n\n## 运行时\n\n运行时的起点，是从*addObserver*开始的。\n\n我们查看*LifecycleRegistry#addObserver*方法。\n\n```java\nprivate FastSafeIterableMap<LifecycleObserver, ObserverWithState> mObserverMap =\n            new FastSafeIterableMap<>();\n@Override\npublic void addObserver(@NonNull LifecycleObserver observer) {\n  State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;\n  ObserverWithState statefulObserver = new ObserverWithState(observer, initialState);\n  ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);\n  ...\n}\n```\n\n我们可以看到，*LifecycleRegistry*中并不是直接维护observer对象，而是维护*ObserverWithState*对象。\n\n```java\nstatic class ObserverWithState {\n  State mState;\n  LifecycleEventObserver mLifecycleObserver;\n\n  ObserverWithState(LifecycleObserver observer, State initialState) {\n    mLifecycleObserver = Lifecycling.lifecycleEventObserver(observer);\n    mState = initialState;\n  }\n\n  void dispatchEvent(LifecycleOwner owner, Event event) {\n    State newState = getStateAfter(event);\n    mState = min(mState, newState);\n    mLifecycleObserver.onStateChanged(owner, event);\n    mState = newState;\n  }\n}\n```\n\n在这个类的构造方法中，执行了一个`mLifecycleObserver = Lifecycling.lifecycleEventObserver(observer);`\n\n在我们的案例中，这个方法返回了一个*SingleGeneratedAdapterObserver*类，我们查看这个类的代码。\n\n```java\nclass SingleGeneratedAdapterObserver implements LifecycleEventObserver {\n\n    private final GeneratedAdapter mGeneratedAdapter;\n\n    SingleGeneratedAdapterObserver(GeneratedAdapter generatedAdapter) {\n        mGeneratedAdapter = generatedAdapter;\n    }\n\n    @Override\n    public void onStateChanged(@NonNull LifecycleOwner source, @NonNull Lifecycle.Event event) {\n        mGeneratedAdapter.callMethods(source, event, false, null);\n        mGeneratedAdapter.callMethods(source, event, true, null);\n    }\n}\n```\n\n也就是在这里，调用了*MyObserver_LifecycleAdapter*的*callMethods*方法。\n\n那么是如何找到*MyObserver_LifecycleAdapter*方法的呢？\n\n在*Lifecycling*类中，通过observer的类名来找的，我们看到有这样的一个方法：\n\n```java\npublic static String getAdapterName(String className) {\n  return className.replace(\".\", \"_\") + \"_LifecycleAdapter\";\n}\n```\n\n这样，整个流程就串起来了。\n\n\n\n## 总结\n\n编译时：生成*XXX_LifecycleAdapter*类，用来分发不同的生命周期事件。\n\n运行时：在addObserver时候，通过类名找到这个*XXX_LifecycleAdapter*类，生成对象在*LifecycleRegistry*中进行维护；在ReportFragment方法中触发生命周期时候，调用*LifecycleRegistry*的*handleLifecycleEvent*方法进行具体的生命周期事件分发。\n\n总体来看，其整个流程并不复杂，我们可以看到ARouter、Glide的影子，读过其他源码后，理解这个并不难。","slug":"2022-09-17-Jetpack之Lifecycle源码分析","published":1,"updated":"2024-11-13T13:39:29.304Z","_id":"cm1ltr0fw0005bji02k3s4lvx","comments":1,"photos":[],"content":"<p>这是一篇解析jetpack库中的<strong>Lifecycle</strong>库的分析文章。</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\"><span class=\"token keyword\">def</span> lifecycle_version <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"2.2.0\"</span></span>\n<span class=\"token comment\">// Lifecycles only (without ViewModel or LiveData)</span>\nimplementation <span class=\"token interpolation-string\"><span class=\"token string\">\"androidx.lifecycle:lifecycle-runtime-ktx:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">lifecycle_version</span></span><span class=\"token string\">\"</span></span>\n<span class=\"token comment\">// Annotation processor</span>\nkapt <span class=\"token interpolation-string\"><span class=\"token string\">\"androidx.lifecycle:lifecycle-compiler:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">lifecycle_version</span></span><span class=\"token string\">\"</span></span></code></pre>\n\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> MyObserver <span class=\"token operator\">:</span> LifecycleObserver <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token annotation builtin\">@OnLifecycleEvent</span><span class=\"token punctuation\">(</span>Lifecycle<span class=\"token punctuation\">.</span>Event<span class=\"token punctuation\">.</span>ON_CREATE<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token annotation builtin\">@OnLifecycleEvent</span><span class=\"token punctuation\">(</span>Lifecycle<span class=\"token punctuation\">.</span>Event<span class=\"token punctuation\">.</span>ON_PAUSE<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">onPause</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> MainActivity <span class=\"token operator\">:</span> <span class=\"token function\">AppCompatActivity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token operator\">:</span> Bundle<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">setContentView</span><span class=\"token punctuation\">(</span>R<span class=\"token punctuation\">.</span>layout<span class=\"token punctuation\">.</span>activity_main<span class=\"token punctuation\">)</span>\n\n        lifecycle<span class=\"token punctuation\">.</span><span class=\"token function\">addObserver</span><span class=\"token punctuation\">(</span><span class=\"token function\">MyObserver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这是一个很典型的Lifecycle库的使用过程，通过注解的方式，在<em>MyObserver</em>中声明对应的生命周期函数，然后将这个<em>MyObserver</em>实例添加到<em>MainActivity</em>的lifecycle中去。</p>\n<p>看到与注解相关，熟悉框架源码的朋友可能已经知道如何去分析了，很可能用到<strong>注解处理器</strong>，与<a href=\"https://boybeak.github.io/2020/11/28/2022-09-17-ARouter%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/\"><strong>ARouter</strong></a>类似，Lifecycle的工作流程也分成两部分——<strong>编译时</strong>和<strong>运行时</strong>。</p>\n<p>简要的说，在编译时，生成<strong>LifecycleObserver</strong>的辅助类；在运行时，<em>addObserver</em>方法被调用后，解析出对应observer的辅助类。</p>\n<h2 id=\"生命周期探知\"><a href=\"#生命周期探知\" class=\"headerlink\" title=\"生命周期探知\"></a>生命周期探知</h2><p>在正式详解这两个过程前，我们需要先要了解Lifecycle库是如何感知生命周期的呢？</p>\n<p>读过Glide源码(附上<a href=\"https://boybeak.github.io/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97/Glide%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%8E%E8%87%AA%E6%88%91%E5%AE%9E%E7%8E%B01.html\">Glide源码解读</a>)的同学可能知道，Glide感知生命周期是通过一个无UI的fragment来实现的，其实，Lifecycle也是这么做的。</p>\n<p>对外提供生命周期的类，需要实现LifecycleOwner接口。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> LifecycleOwner <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">/**\n     * Returns the Lifecycle of the provider.\n     *\n     * @return The lifecycle of the provider.\n     */</span>\n    <span class=\"token annotation builtin\">@NonNull</span>\n    Lifecycle <span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们以<em>AppCompatActivity</em>为例去查看它是如何实现的这个接口，我们查看其父类中有一个<em>ComponentActivity</em>类(AppCompatActivity -&gt; FragmentActivity -&gt; ComponentActivity)。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> ComponentActivity extends androidx<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span>ComponentActivity implements\n        LifecycleOwner<span class=\"token punctuation\">,</span>\n        ViewModelStoreOwner<span class=\"token punctuation\">,</span>\n        SavedStateRegistryOwner<span class=\"token punctuation\">,</span>\n        OnBackPressedDispatcherOwner <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token annotation builtin\">@Override</span>\n    <span class=\"token keyword\">protected</span> void <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token annotation builtin\">@Nullable</span> Bundle savedInstanceState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mSavedStateRegistryController<span class=\"token punctuation\">.</span><span class=\"token function\">performRestore</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        ReportFragment<span class=\"token punctuation\">.</span><span class=\"token function\">injectIfNeededIn</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mContentLayoutId <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token function\">setContentView</span><span class=\"token punctuation\">(</span>mContentLayoutId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>注意此处，有一个<em>ReportFragment</em>执行了injectIfNeededIn方法，在这个方法中，就是检测是否已经添加了这个<em>ReportFragment</em>，如果没添加则添加一个。继续查看这个<em>ReportFragment</em>的源码，可以在其生命周期函数中，执行了分发生命周期的流程。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> ReportFragment extends Fragment <span class=\"token punctuation\">&#123;</span>\n  static void <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token annotation builtin\">@NonNull</span> Activity activity<span class=\"token punctuation\">,</span> <span class=\"token annotation builtin\">@NonNull</span> Lifecycle<span class=\"token punctuation\">.</span>Event event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>activity instanceof LifecycleRegistryOwner<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>LifecycleRegistryOwner<span class=\"token punctuation\">)</span> activity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleLifecycleEvent</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>activity instanceof LifecycleOwner<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// 3</span>\n      Lifecycle lifecycle <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>LifecycleOwner<span class=\"token punctuation\">)</span> activity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lifecycle instanceof LifecycleRegistry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>LifecycleRegistry<span class=\"token punctuation\">)</span> lifecycle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleLifecycleEvent</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">private</span> void <span class=\"token function\">dispatchCreate</span><span class=\"token punctuation\">(</span>ActivityInitializationListener listener<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>listener <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      listener<span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token annotation builtin\">@Override</span>\n  <span class=\"token keyword\">public</span> void <span class=\"token function\">onActivityCreated</span><span class=\"token punctuation\">(</span>Bundle savedInstanceState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onActivityCreated</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">dispatchCreate</span><span class=\"token punctuation\">(</span>mProcessListener<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>Lifecycle<span class=\"token punctuation\">.</span>Event<span class=\"token punctuation\">.</span>ON_CREATE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">private</span> void <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token annotation builtin\">@NonNull</span> Lifecycle<span class=\"token punctuation\">.</span>Event event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Build<span class=\"token punctuation\">.</span>VERSION<span class=\"token punctuation\">.</span>SDK_INT <span class=\"token operator\">&lt;</span> <span class=\"token number\">29</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token comment\">// Only dispatch events from ReportFragment on API levels prior</span>\n      <span class=\"token comment\">// to API 29. On API 29+, this is handled by the ActivityLifecycleCallbacks</span>\n      <span class=\"token comment\">// added in ReportFragment.injectIfNeededIn</span>\n      <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">getActivity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 2</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>看代码中我标注的注释顺序onActivityCreated -&gt; dispatch(Lifecycle.Event) -&gt; dispatch(Activity, Lifecycle.Event)，我们看到最后一个流程中，拿到<em>Lifecycle</em>对象后，判断是否为<em>LifecycleRegistry</em>类，如果是，则调用handleLifecycleEvent方法。这里，<em>ComponentActivity</em>提供的<em>Lifecycle</em>对象就是<em>LifecycleRegistry</em>类。</p>\n<p>经过这样一个流程，我们就将感知生命周期的无UI的<em>ReportFragment</em>与执行事件的<em>LifecycleRegistry</em>进行了连接。这样我们就获得了感知生命周期的能力了。</p>\n<p>那么具体是如何执行到<em>MyObserver</em>对应的生命周期的方法的呢？</p>\n<blockquote>\n<p>或许你看到这里，会觉得很简单，在<em>LifecycleRegistry</em>维护一个observer队列，然后在执行handleLifecycleEvent方法的时候，通过反射从<em>MyObserver</em>中筛选出带有 ** @OnLifecycleEvent ** 注解的方法，如果注解中的值与事件event相等，则通过method.invoke()来调用。</p>\n<p>可是谷歌工程师并没有这么做，因为在执行事件时候，经过这么多反射，效率会很低。那么正确的流程是怎么样的？这就需要我们关注上面提到的两个流程了——<strong>编译时</strong>和<strong>运行时</strong>。</p>\n</blockquote>\n<h2 id=\"编译时\"><a href=\"#编译时\" class=\"headerlink\" title=\"编译时\"></a>编译时</h2><p>参考<a href=\"https://android.googlesource.com/platform/frameworks/support/+/androidx-master-dev/lifecycle/lifecycle-compiler\">Lifecycle-compiler</a>源码。</p>\n<p>通过注解处理器，AS为我们生成了MyObserver的辅助类——<em>MyObserver_LifecycleAdapter</em>。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyObserver_LifecycleAdapter</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">GeneratedAdapter</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">final</span> <span class=\"token class-name\">MyObserver</span> mReceiver<span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">MyObserver_LifecycleAdapter</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MyObserver</span> receiver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mReceiver <span class=\"token operator\">=</span> receiver<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">callMethods</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span> event<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> onAny<span class=\"token punctuation\">,</span>\n      <span class=\"token class-name\">MethodCallsLogger</span> logger<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">boolean</span> hasLogger <span class=\"token operator\">=</span> logger <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>onAny<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event <span class=\"token operator\">==</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ON_CREATE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hasLogger <span class=\"token operator\">||</span> logger<span class=\"token punctuation\">.</span><span class=\"token function\">approveCall</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"onCreate\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        mReceiver<span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event <span class=\"token operator\">==</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ON_PAUSE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hasLogger <span class=\"token operator\">||</span> logger<span class=\"token punctuation\">.</span><span class=\"token function\">approveCall</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"onPause\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        mReceiver<span class=\"token punctuation\">.</span><span class=\"token function\">onPause</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，实际的生命周期事件分发是在这里完成的。那么这个辅助类是在哪里被使用到的呢？</p>\n<p>接下来就是<strong>运行时</strong>发挥作用的时候了。</p>\n<h2 id=\"运行时\"><a href=\"#运行时\" class=\"headerlink\" title=\"运行时\"></a>运行时</h2><p>运行时的起点，是从<em>addObserver</em>开始的。</p>\n<p>我们查看<em>LifecycleRegistry#addObserver</em>方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token class-name\">FastSafeIterableMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LifecycleObserver</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ObserverWithState</span><span class=\"token punctuation\">></span></span> mObserverMap <span class=\"token operator\">=</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">FastSafeIterableMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addObserver</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">LifecycleObserver</span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token class-name\">State</span> initialState <span class=\"token operator\">=</span> mState <span class=\"token operator\">==</span> <span class=\"token constant\">DESTROYED</span> <span class=\"token operator\">?</span> <span class=\"token constant\">DESTROYED</span> <span class=\"token operator\">:</span> <span class=\"token constant\">INITIALIZED</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">ObserverWithState</span> statefulObserver <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObserverWithState</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">,</span> initialState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">ObserverWithState</span> previous <span class=\"token operator\">=</span> mObserverMap<span class=\"token punctuation\">.</span><span class=\"token function\">putIfAbsent</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">,</span> statefulObserver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，<em>LifecycleRegistry</em>中并不是直接维护observer对象，而是维护<em>ObserverWithState</em>对象。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ObserverWithState</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token class-name\">State</span> mState<span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">LifecycleEventObserver</span> mLifecycleObserver<span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">ObserverWithState</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleObserver</span> observer<span class=\"token punctuation\">,</span> <span class=\"token class-name\">State</span> initialState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    mLifecycleObserver <span class=\"token operator\">=</span> <span class=\"token class-name\">Lifecycling</span><span class=\"token punctuation\">.</span><span class=\"token function\">lifecycleEventObserver</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mState <span class=\"token operator\">=</span> initialState<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">void</span> <span class=\"token function\">dispatchEvent</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Event</span> event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token class-name\">State</span> newState <span class=\"token operator\">=</span> <span class=\"token function\">getStateAfter</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mState <span class=\"token operator\">=</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>mState<span class=\"token punctuation\">,</span> newState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mLifecycleObserver<span class=\"token punctuation\">.</span><span class=\"token function\">onStateChanged</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mState <span class=\"token operator\">=</span> newState<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在这个类的构造方法中，执行了一个<code>mLifecycleObserver = Lifecycling.lifecycleEventObserver(observer);</code></p>\n<p>在我们的案例中，这个方法返回了一个<em>SingleGeneratedAdapterObserver</em>类，我们查看这个类的代码。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">SingleGeneratedAdapterObserver</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">LifecycleEventObserver</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">GeneratedAdapter</span> mGeneratedAdapter<span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">SingleGeneratedAdapterObserver</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">GeneratedAdapter</span> generatedAdapter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        mGeneratedAdapter <span class=\"token operator\">=</span> generatedAdapter<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">LifecycleOwner</span> source<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span> event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        mGeneratedAdapter<span class=\"token punctuation\">.</span><span class=\"token function\">callMethods</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mGeneratedAdapter<span class=\"token punctuation\">.</span><span class=\"token function\">callMethods</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>也就是在这里，调用了<em>MyObserver_LifecycleAdapter</em>的<em>callMethods</em>方法。</p>\n<p>那么是如何找到<em>MyObserver_LifecycleAdapter</em>方法的呢？</p>\n<p>在<em>Lifecycling</em>类中，通过observer的类名来找的，我们看到有这样的一个方法：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getAdapterName</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> className<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">return</span> className<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"_\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"_LifecycleAdapter\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这样，整个流程就串起来了。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>编译时：生成<em>XXX_LifecycleAdapter</em>类，用来分发不同的生命周期事件。</p>\n<p>运行时：在addObserver时候，通过类名找到这个<em>XXX_LifecycleAdapter</em>类，生成对象在<em>LifecycleRegistry</em>中进行维护；在ReportFragment方法中触发生命周期时候，调用<em>LifecycleRegistry</em>的<em>handleLifecycleEvent</em>方法进行具体的生命周期事件分发。</p>\n<p>总体来看，其整个流程并不复杂，我们可以看到ARouter、Glide的影子，读过其他源码后，理解这个并不难。</p>\n","excerpt":"","more":"<p>这是一篇解析jetpack库中的<strong>Lifecycle</strong>库的分析文章。</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\"><span class=\"token keyword\">def</span> lifecycle_version <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"2.2.0\"</span></span>\n<span class=\"token comment\">// Lifecycles only (without ViewModel or LiveData)</span>\nimplementation <span class=\"token interpolation-string\"><span class=\"token string\">\"androidx.lifecycle:lifecycle-runtime-ktx:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">lifecycle_version</span></span><span class=\"token string\">\"</span></span>\n<span class=\"token comment\">// Annotation processor</span>\nkapt <span class=\"token interpolation-string\"><span class=\"token string\">\"androidx.lifecycle:lifecycle-compiler:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">lifecycle_version</span></span><span class=\"token string\">\"</span></span></code></pre>\n\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> MyObserver <span class=\"token operator\">:</span> LifecycleObserver <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token annotation builtin\">@OnLifecycleEvent</span><span class=\"token punctuation\">(</span>Lifecycle<span class=\"token punctuation\">.</span>Event<span class=\"token punctuation\">.</span>ON_CREATE<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token annotation builtin\">@OnLifecycleEvent</span><span class=\"token punctuation\">(</span>Lifecycle<span class=\"token punctuation\">.</span>Event<span class=\"token punctuation\">.</span>ON_PAUSE<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">onPause</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> MainActivity <span class=\"token operator\">:</span> <span class=\"token function\">AppCompatActivity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token operator\">:</span> Bundle<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">setContentView</span><span class=\"token punctuation\">(</span>R<span class=\"token punctuation\">.</span>layout<span class=\"token punctuation\">.</span>activity_main<span class=\"token punctuation\">)</span>\n\n        lifecycle<span class=\"token punctuation\">.</span><span class=\"token function\">addObserver</span><span class=\"token punctuation\">(</span><span class=\"token function\">MyObserver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这是一个很典型的Lifecycle库的使用过程，通过注解的方式，在<em>MyObserver</em>中声明对应的生命周期函数，然后将这个<em>MyObserver</em>实例添加到<em>MainActivity</em>的lifecycle中去。</p>\n<p>看到与注解相关，熟悉框架源码的朋友可能已经知道如何去分析了，很可能用到<strong>注解处理器</strong>，与<a href=\"https://boybeak.github.io/2020/11/28/2022-09-17-ARouter%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/\"><strong>ARouter</strong></a>类似，Lifecycle的工作流程也分成两部分——<strong>编译时</strong>和<strong>运行时</strong>。</p>\n<p>简要的说，在编译时，生成<strong>LifecycleObserver</strong>的辅助类；在运行时，<em>addObserver</em>方法被调用后，解析出对应observer的辅助类。</p>\n<h2 id=\"生命周期探知\"><a href=\"#生命周期探知\" class=\"headerlink\" title=\"生命周期探知\"></a>生命周期探知</h2><p>在正式详解这两个过程前，我们需要先要了解Lifecycle库是如何感知生命周期的呢？</p>\n<p>读过Glide源码(附上<a href=\"https://boybeak.github.io/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97/Glide%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%8E%E8%87%AA%E6%88%91%E5%AE%9E%E7%8E%B01.html\">Glide源码解读</a>)的同学可能知道，Glide感知生命周期是通过一个无UI的fragment来实现的，其实，Lifecycle也是这么做的。</p>\n<p>对外提供生命周期的类，需要实现LifecycleOwner接口。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> LifecycleOwner <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">/**\n     * Returns the Lifecycle of the provider.\n     *\n     * @return The lifecycle of the provider.\n     */</span>\n    <span class=\"token annotation builtin\">@NonNull</span>\n    Lifecycle <span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们以<em>AppCompatActivity</em>为例去查看它是如何实现的这个接口，我们查看其父类中有一个<em>ComponentActivity</em>类(AppCompatActivity -&gt; FragmentActivity -&gt; ComponentActivity)。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> ComponentActivity extends androidx<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span>ComponentActivity implements\n        LifecycleOwner<span class=\"token punctuation\">,</span>\n        ViewModelStoreOwner<span class=\"token punctuation\">,</span>\n        SavedStateRegistryOwner<span class=\"token punctuation\">,</span>\n        OnBackPressedDispatcherOwner <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token annotation builtin\">@Override</span>\n    <span class=\"token keyword\">protected</span> void <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token annotation builtin\">@Nullable</span> Bundle savedInstanceState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mSavedStateRegistryController<span class=\"token punctuation\">.</span><span class=\"token function\">performRestore</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        ReportFragment<span class=\"token punctuation\">.</span><span class=\"token function\">injectIfNeededIn</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mContentLayoutId <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token function\">setContentView</span><span class=\"token punctuation\">(</span>mContentLayoutId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>注意此处，有一个<em>ReportFragment</em>执行了injectIfNeededIn方法，在这个方法中，就是检测是否已经添加了这个<em>ReportFragment</em>，如果没添加则添加一个。继续查看这个<em>ReportFragment</em>的源码，可以在其生命周期函数中，执行了分发生命周期的流程。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> ReportFragment extends Fragment <span class=\"token punctuation\">&#123;</span>\n  static void <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token annotation builtin\">@NonNull</span> Activity activity<span class=\"token punctuation\">,</span> <span class=\"token annotation builtin\">@NonNull</span> Lifecycle<span class=\"token punctuation\">.</span>Event event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>activity instanceof LifecycleRegistryOwner<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>LifecycleRegistryOwner<span class=\"token punctuation\">)</span> activity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleLifecycleEvent</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>activity instanceof LifecycleOwner<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// 3</span>\n      Lifecycle lifecycle <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>LifecycleOwner<span class=\"token punctuation\">)</span> activity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lifecycle instanceof LifecycleRegistry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>LifecycleRegistry<span class=\"token punctuation\">)</span> lifecycle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleLifecycleEvent</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">private</span> void <span class=\"token function\">dispatchCreate</span><span class=\"token punctuation\">(</span>ActivityInitializationListener listener<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>listener <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      listener<span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token annotation builtin\">@Override</span>\n  <span class=\"token keyword\">public</span> void <span class=\"token function\">onActivityCreated</span><span class=\"token punctuation\">(</span>Bundle savedInstanceState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onActivityCreated</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">dispatchCreate</span><span class=\"token punctuation\">(</span>mProcessListener<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>Lifecycle<span class=\"token punctuation\">.</span>Event<span class=\"token punctuation\">.</span>ON_CREATE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">private</span> void <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token annotation builtin\">@NonNull</span> Lifecycle<span class=\"token punctuation\">.</span>Event event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Build<span class=\"token punctuation\">.</span>VERSION<span class=\"token punctuation\">.</span>SDK_INT <span class=\"token operator\">&lt;</span> <span class=\"token number\">29</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token comment\">// Only dispatch events from ReportFragment on API levels prior</span>\n      <span class=\"token comment\">// to API 29. On API 29+, this is handled by the ActivityLifecycleCallbacks</span>\n      <span class=\"token comment\">// added in ReportFragment.injectIfNeededIn</span>\n      <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">getActivity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 2</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>看代码中我标注的注释顺序onActivityCreated -&gt; dispatch(Lifecycle.Event) -&gt; dispatch(Activity, Lifecycle.Event)，我们看到最后一个流程中，拿到<em>Lifecycle</em>对象后，判断是否为<em>LifecycleRegistry</em>类，如果是，则调用handleLifecycleEvent方法。这里，<em>ComponentActivity</em>提供的<em>Lifecycle</em>对象就是<em>LifecycleRegistry</em>类。</p>\n<p>经过这样一个流程，我们就将感知生命周期的无UI的<em>ReportFragment</em>与执行事件的<em>LifecycleRegistry</em>进行了连接。这样我们就获得了感知生命周期的能力了。</p>\n<p>那么具体是如何执行到<em>MyObserver</em>对应的生命周期的方法的呢？</p>\n<blockquote>\n<p>或许你看到这里，会觉得很简单，在<em>LifecycleRegistry</em>维护一个observer队列，然后在执行handleLifecycleEvent方法的时候，通过反射从<em>MyObserver</em>中筛选出带有 ** @OnLifecycleEvent ** 注解的方法，如果注解中的值与事件event相等，则通过method.invoke()来调用。</p>\n<p>可是谷歌工程师并没有这么做，因为在执行事件时候，经过这么多反射，效率会很低。那么正确的流程是怎么样的？这就需要我们关注上面提到的两个流程了——<strong>编译时</strong>和<strong>运行时</strong>。</p>\n</blockquote>\n<h2 id=\"编译时\"><a href=\"#编译时\" class=\"headerlink\" title=\"编译时\"></a>编译时</h2><p>参考<a href=\"https://android.googlesource.com/platform/frameworks/support/+/androidx-master-dev/lifecycle/lifecycle-compiler\">Lifecycle-compiler</a>源码。</p>\n<p>通过注解处理器，AS为我们生成了MyObserver的辅助类——<em>MyObserver_LifecycleAdapter</em>。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyObserver_LifecycleAdapter</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">GeneratedAdapter</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">final</span> <span class=\"token class-name\">MyObserver</span> mReceiver<span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">MyObserver_LifecycleAdapter</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MyObserver</span> receiver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mReceiver <span class=\"token operator\">=</span> receiver<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">callMethods</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span> event<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> onAny<span class=\"token punctuation\">,</span>\n      <span class=\"token class-name\">MethodCallsLogger</span> logger<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">boolean</span> hasLogger <span class=\"token operator\">=</span> logger <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>onAny<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event <span class=\"token operator\">==</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ON_CREATE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hasLogger <span class=\"token operator\">||</span> logger<span class=\"token punctuation\">.</span><span class=\"token function\">approveCall</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"onCreate\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        mReceiver<span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event <span class=\"token operator\">==</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ON_PAUSE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hasLogger <span class=\"token operator\">||</span> logger<span class=\"token punctuation\">.</span><span class=\"token function\">approveCall</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"onPause\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        mReceiver<span class=\"token punctuation\">.</span><span class=\"token function\">onPause</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，实际的生命周期事件分发是在这里完成的。那么这个辅助类是在哪里被使用到的呢？</p>\n<p>接下来就是<strong>运行时</strong>发挥作用的时候了。</p>\n<h2 id=\"运行时\"><a href=\"#运行时\" class=\"headerlink\" title=\"运行时\"></a>运行时</h2><p>运行时的起点，是从<em>addObserver</em>开始的。</p>\n<p>我们查看<em>LifecycleRegistry#addObserver</em>方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token class-name\">FastSafeIterableMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LifecycleObserver</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ObserverWithState</span><span class=\"token punctuation\">></span></span> mObserverMap <span class=\"token operator\">=</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">FastSafeIterableMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addObserver</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">LifecycleObserver</span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token class-name\">State</span> initialState <span class=\"token operator\">=</span> mState <span class=\"token operator\">==</span> <span class=\"token constant\">DESTROYED</span> <span class=\"token operator\">?</span> <span class=\"token constant\">DESTROYED</span> <span class=\"token operator\">:</span> <span class=\"token constant\">INITIALIZED</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">ObserverWithState</span> statefulObserver <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObserverWithState</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">,</span> initialState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">ObserverWithState</span> previous <span class=\"token operator\">=</span> mObserverMap<span class=\"token punctuation\">.</span><span class=\"token function\">putIfAbsent</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">,</span> statefulObserver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，<em>LifecycleRegistry</em>中并不是直接维护observer对象，而是维护<em>ObserverWithState</em>对象。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ObserverWithState</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token class-name\">State</span> mState<span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">LifecycleEventObserver</span> mLifecycleObserver<span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">ObserverWithState</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleObserver</span> observer<span class=\"token punctuation\">,</span> <span class=\"token class-name\">State</span> initialState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    mLifecycleObserver <span class=\"token operator\">=</span> <span class=\"token class-name\">Lifecycling</span><span class=\"token punctuation\">.</span><span class=\"token function\">lifecycleEventObserver</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mState <span class=\"token operator\">=</span> initialState<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">void</span> <span class=\"token function\">dispatchEvent</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Event</span> event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token class-name\">State</span> newState <span class=\"token operator\">=</span> <span class=\"token function\">getStateAfter</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mState <span class=\"token operator\">=</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>mState<span class=\"token punctuation\">,</span> newState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mLifecycleObserver<span class=\"token punctuation\">.</span><span class=\"token function\">onStateChanged</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mState <span class=\"token operator\">=</span> newState<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在这个类的构造方法中，执行了一个<code>mLifecycleObserver = Lifecycling.lifecycleEventObserver(observer);</code></p>\n<p>在我们的案例中，这个方法返回了一个<em>SingleGeneratedAdapterObserver</em>类，我们查看这个类的代码。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">SingleGeneratedAdapterObserver</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">LifecycleEventObserver</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">GeneratedAdapter</span> mGeneratedAdapter<span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">SingleGeneratedAdapterObserver</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">GeneratedAdapter</span> generatedAdapter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        mGeneratedAdapter <span class=\"token operator\">=</span> generatedAdapter<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">LifecycleOwner</span> source<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span> event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        mGeneratedAdapter<span class=\"token punctuation\">.</span><span class=\"token function\">callMethods</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mGeneratedAdapter<span class=\"token punctuation\">.</span><span class=\"token function\">callMethods</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>也就是在这里，调用了<em>MyObserver_LifecycleAdapter</em>的<em>callMethods</em>方法。</p>\n<p>那么是如何找到<em>MyObserver_LifecycleAdapter</em>方法的呢？</p>\n<p>在<em>Lifecycling</em>类中，通过observer的类名来找的，我们看到有这样的一个方法：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getAdapterName</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> className<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">return</span> className<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"_\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"_LifecycleAdapter\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这样，整个流程就串起来了。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>编译时：生成<em>XXX_LifecycleAdapter</em>类，用来分发不同的生命周期事件。</p>\n<p>运行时：在addObserver时候，通过类名找到这个<em>XXX_LifecycleAdapter</em>类，生成对象在<em>LifecycleRegistry</em>中进行维护；在ReportFragment方法中触发生命周期时候，调用<em>LifecycleRegistry</em>的<em>handleLifecycleEvent</em>方法进行具体的生命周期事件分发。</p>\n<p>总体来看，其整个流程并不复杂，我们可以看到ARouter、Glide的影子，读过其他源码后，理解这个并不难。</p>\n"},{"layout":"post","title":"ARouter源码分析","author":"boybeak","date":"2022-09-16T16:00:00.000Z","_content":"\n\n在阅读源码前，请先下载源码：[ARouter](https://github.com/alibaba/ARouter)\n\n最近阅读ARouter源码，发现这真的是一个非常优秀的框架。激发出兴趣来读一下他的源码，实际上，这个框架的结构非常简单。这个框架可以分为**主流程**和**辅助流程**来拆开分析。\n\n主流程包含**编译时**和**运行时**两个部分，其中编译时主要做的是路由路径表的构建，运行时主要做的是路由路径表的加载；\n\n辅助流程主要就是做**启动优化**。\n\n## 主流程\n\n### 1. 编译时\n\n这部分主要涉及到的是路由路径表的构建，其实现原理是**APT**，即**注解处理器**。\n\n使用ARouter时候，需要在目标类上，通过**@Route**注解进行标记，注解处理器处理的就是这个注解。打开源码路径下的*arouter-compiler*这个module，找到**RouteProcessor**，这个类就是用来处理**@Route**注解的类。这里需要了解的知识，除了APT，还有java-poet，请自行了解这些。\n\nProcessor类的入口方法是*process*方法，这个方法返回true，则这个处理器已经完成了自己的任务，不会被重复调用。其他比较重要的方法有*getSupportedSourceVersion*，*getSupportedAnnotationTypes*等。\n\n```java\nSet<? extends Element> routeElements = roundEnv.getElementsAnnotatedWith(Route.class);\n```\n\n通过这个方法，获取所有被**@Route**标记的元素。\n\n获取到*routeElements*后，在*parseRoutes*方法进行处理。我们以最常用的Activity为例，进行分析。\n\n```java\nrootMap.clear();\t//用来分类存储标记元素\n\n// 用来检测元素是否为对应的类型，通过Types.isSubtype()方法来检测。\nTypeMirror type_Activity = elementUtils.getTypeElement(ACTIVITY).asType();\nTypeMirror type_Service = elementUtils.getTypeElement(SERVICE).asType();\nTypeMirror fragmentTm = elementUtils.getTypeElement(FRAGMENT).asType();\nTypeMirror fragmentTmV4 = elementUtils.getTypeElement(Consts.FRAGMENT_V4).asType();\n```\n\n最后将分类号的元素信息，存储在成员变量groupMap中去。\n\n```java\nprivate Map<String, Set<RouteMeta>> groupMap = new HashMap<>();\n```\n\n然后再通过这个groupMap，借助java-poet，来生成真实的类。如下：\n\n```java\npublic class ARouter$$Group$$test implements IRouteGroup {\n  @Override\n  public void loadInto(Map<String, RouteMeta> atlas) {\n    atlas.put(\"/test/activity1\", RouteMeta.build(RouteType.ACTIVITY, Test1Activity.class, \"/test/activity1\", \"test\", new java.util.HashMap<String, Integer>(){{put(\"ser\", 9); put(\"ch\", 5); put(\"fl\", 6); put(\"dou\", 7); put(\"boy\", 0); put(\"url\", 8); put(\"pac\", 10); put(\"obj\", 11); put(\"name\", 8); put(\"objList\", 11); put(\"map\", 11); put(\"age\", 3); put(\"height\", 3); }}, -1, -2147483648));\n    atlas.put(\"/test/activity2\", RouteMeta.build(RouteType.ACTIVITY, Test2Activity.class, \"/test/activity2\", \"test\", new java.util.HashMap<String, Integer>(){{put(\"key1\", 8); }}, -1, -2147483648));\n    atlas.put(\"/test/activity3\", RouteMeta.build(RouteType.ACTIVITY, Test3Activity.class, \"/test/activity3\", \"test\", new java.util.HashMap<String, Integer>(){{put(\"name\", 8); put(\"boy\", 0); put(\"age\", 3); }}, -1, -2147483648));\n    atlas.put(\"/test/activity4\", RouteMeta.build(RouteType.ACTIVITY, Test4Activity.class, \"/test/activity4\", \"test\", null, -1, -2147483648));\n    atlas.put(\"/test/fragment\", RouteMeta.build(RouteType.FRAGMENT, BlankFragment.class, \"/test/fragment\", \"test\", new java.util.HashMap<String, Integer>(){{put(\"obj\", 11); put(\"name\", 8); }}, -1, -2147483648));\n    atlas.put(\"/test/webview\", RouteMeta.build(RouteType.ACTIVITY, TestWebview.class, \"/test/webview\", \"test\", null, -1, -2147483648));\n  }\n}\n```\n\n\n\n### 2. 运行时\n\n这部分主要做的是，在*ARouter.init()*时候，将上过程生成的路径表加载到内存中。\n\n> 如果你以官方demo程序验证这一步，需要将app/build.gradle中的`apply plugin: 'com.alibaba.arouter'`这一行代码注释掉。\n\n我们以*ARouter.init*方法为入口，实际上最终实现init流程的是LogisticsCenter类的*init*方法。\n\n```java\npublic synchronized static void init(Context context, ThreadPoolExecutor tpe) throws HandlerException {\n  ...\n  if (registerByPlugin) {\n    //这是在辅助流程需要去讲的\n  \tlogger.info(TAG, \"Load router map by arouter-auto-register plugin.\");\n  } else {\n    Set<String> routerMap;\n\n    // It will rebuild router map every times when debuggable.\n    if (ARouter.debuggable() || PackageUtils.isNewVersion(context)) {\n      logger.info(TAG, \"Run with debug mode or new install, rebuild router map.\");\n      // These class was generated by arouter-compiler.\n      routerMap = ClassUtils.getFileNameByPackageName(mContext, ROUTE_ROOT_PAKCAGE);\n      if (!routerMap.isEmpty()) {\n        context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).edit().putStringSet(AROUTER_SP_KEY_MAP, routerMap).apply();\n      }\n\n      PackageUtils.updateVersion(context);    // Save new version name when router map update finishes.\n    } else {\n      logger.info(TAG, \"Load router map from cache.\");\n      routerMap = new HashSet<>(context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).getStringSet(AROUTER_SP_KEY_MAP, new HashSet<String>()));\n    }\n  }\n}\n```\n\n这里需要着重看的是这一句：\n\n```java\nrouterMap = ClassUtils.getFileNameByPackageName(mContext, ROUTE_ROOT_PAKCAGE);\n```\n\n我们查看这个方法:\n\n```java\npublic static Set<String> getFileNameByPackageName(Context context, final String packageName) throws PackageManager.NameNotFoundException, IOException, InterruptedException {\n  final Set<String> classNames = new HashSet<>();\n\n  List<String> paths = getSourcePaths(context);\n  final CountDownLatch parserCtl = new CountDownLatch(paths.size());\n\n  for (final String path : paths) {\n    Log.v(TAG, \"getFileNameByPackageName path=\" + path);\n    DefaultPoolExecutor.getInstance().execute(new Runnable() {\n      @Override\n      public void run() {\n        DexFile dexfile = null;\n\n        try {\n          if (path.endsWith(EXTRACTED_SUFFIX)) {\n            //NOT use new DexFile(path), because it will throw \"permission error in /data/dalvik-cache\"\n            dexfile = DexFile.loadDex(path, path + \".tmp\", 0);\n          } else {\n            dexfile = new DexFile(path);\n          }\n\n          Enumeration<String> dexEntries = dexfile.entries();\n          while (dexEntries.hasMoreElements()) {\n            String className = dexEntries.nextElement();\n            if (className.startsWith(packageName)) {\n              Log.v(TAG, \"find CLASS NAME \" + className);\n              classNames.add(className);\n            }\n          }\n        } catch (Throwable ignore) {\n          Log.e(\"ARouter\", \"Scan map file in dex files made error.\", ignore);\n        } finally {\n          if (null != dexfile) {\n            try {\n              dexfile.close();\n            } catch (Throwable ignore) {\n            }\n          }\n\n          parserCtl.countDown();\n        }\n      }\n    });\n  }\n\n  parserCtl.await();\n\n  Log.d(Consts.TAG, \"Filter \" + classNames.size() + \" classes by packageName <\" + packageName + \">\");\n  return classNames;\n}\n```\n\n注意其中的*getSourcePaths*方法，这是从代码目录，来获取所有代码目录，然后在\n\n*getFileNameByPackageName*找出以`com.alibaba.android.arouter.routes`为开头包名的类，这些就是我们在步骤1中生成的辅助类。\n\n这个方法结束后，回到*LogisticsCenter#init*方法，接下来要做的就是，把加载到的辅助类，通过反射生成对象，再调用其*loadTo*方法，将路由路径表加载到Warehouse类中去，方便以后的查询。\n\n\n\n## 辅助流程\n\n在以上的流程中，有一个严重的问题，那就是执行*ARouter#init*方法的时间过长，以源码的demo为例，在InstantRun的情况下，OnePlus5T需要100多毫秒才能初始化完，这对于程序启动优化来说，是一个不可忽视的时间了。那么如何解决这个问题呢？\n\n```shell\nMainActivity: init cost 134\n```\n\n这就是在上一步中，要求你注释掉的代码起作用了，将`apply plugin: 'com.alibaba.arouter'`解除注释，让其发挥作用。\n\n这里需要关注的module是`arouter-gradle-plugin`。\n\n先来看一下，使用了`apply plugin: 'com.alibaba.arouter'`的神奇效果。\n\n```shell\nMainActivity: init cost 19\n```\n\n通过优化，让*ARouter#init*消耗时间直接降低了一个数量级，那么`arouter-gradle-plugin`是怎么做到的呢？\n\n这需要你先了解一下[ASM]({{site.base_url}}/android/ASM.md)。简单来说，这是一种字节码编程技术，通过修改编译后的字节码的方式，来对原始逻辑增强。\n\n我们再来看*ARouter#init*的最终实现类和方法*LogisticsCenter#init*：\n\n```java\npublic synchronized static void init(Context context, ThreadPoolExecutor tpe) throws HandlerException {\n  ....\n  try {\n    long startInit = System.currentTimeMillis();\n    //billy.qi modified at 2017-12-06\n    //load by plugin first\n    loadRouterMap();\n    if (registerByPlugin) {\n      logger.info(TAG, \"Load router map by arouter-auto-register plugin.\");\n    } else {\n      ....\n    }\n    .....\n  } catch (Exception e) {\n    throw new HandlerException(TAG + \"ARouter init logistics center exception! [\" + e.getMessage() + \"]\");\n  }\n}\n```\n\n我们可以看到，当`registerByPlugin`为true的时候，则只是打印了一句日志，我们再看loadRouterMap()这个方法：\n\n```java\nprivate static void loadRouterMap() {\n  registerByPlugin = false;\n  //auto generate register code by gradle plugin: arouter-auto-register\n  // looks like below:\n  // registerRouteRoot(new ARouter..Root..modulejava());\n  // registerRouteRoot(new ARouter..Root..modulekotlin());\n}\n```\n\n这里的逻辑非常简单，到底在哪里去加载的路由路径表呢？我们看这个方法的注释，发现，这个方法是被`arouter-auto-register`自动生成的。\n\n我们打开`arouter-gradle-plugin/resources/META-INF/gradle-plugins`这个目录，可以看到，有一个*com.alibaba.arouter.properties*文件，查看其内容：\n\n```properties\nimplementation-class=com.alibaba.android.arouter.register.launch.PluginLaunch\n```\n\n这个*PluginLaunch*便是此gradle plugin的入口类。查看此类：\n\n```groovy\npublic class PluginLaunch implements Plugin<Project> {\n\n  @Override\n  public void apply(Project project) {\n    def isApp = project.plugins.hasPlugin(AppPlugin)\n    //only application module needs this plugin to generate register code\n    if (isApp) {\n      Logger.make(project)\n\n      Logger.i('Project enable arouter-register plugin')\n\n      def android = project.extensions.getByType(AppExtension)\n      def transformImpl = new RegisterTransform(project)\n\n      //init arouter-auto-register settings\n      ArrayList<ScanSetting> list = new ArrayList<>(3)\n      list.add(new ScanSetting('IRouteRoot'))\n      list.add(new ScanSetting('IInterceptorGroup'))\n      list.add(new ScanSetting('IProviderGroup'))\n      RegisterTransform.registerList = list\n      //register this plugin\n      android.registerTransform(transformImpl)\n    }\n  }\n\n}\n```\n\n我们查看其代码，可以发现，这里一共做了三件事：\n\n1. 判断是否为app module，如果不是，则不做任何事，在app module下做2和3两步；\n2. 生成了一个RegisterTransform，并为其静态变量registerList赋值，**注意此处赋值的registerList中包含的三个对象**；\n3. 注册此RegisterTransform。\n\n接下来，就轮到*RegisterTransform*来执行了。\n\nTransform类，简单来说，就是可以在编译时，扫描所有的jar和class，包括引用类库中的。在扫描过程中，就可以借助**ASM**技术对目标类进行更改。\n\n我们看其入口方法*transform*：\n\n```groovy\n@Override\nvoid transform(Context context, Collection<TransformInput> inputs, Collection<TransformInput> referencedInputs, TransformOutputProvider outputProvider, boolean isIncremental) throws IOException, TransformException, InterruptedException {\n  inputs.each { TransformInput input ->\n    // scan all jars\n    input.jarInputs.each { JarInput jarInput ->\n      ...\n      if (ScanUtil.shouldProcessPreDexJar(src.absolutePath)) {\n        ScanUtil.scanJar(src, dest)\n      }\n      ...\n    }\n  }\n  input.directoryInputs.each { DirectoryInput directoryInput ->\n    ...\n    directoryInput.file.eachFileRecurse { File file ->\n      ...\n      if(file.isFile() && ScanUtil.shouldProcessClass(path)){\n        ScanUtil.scanClass(file)\n      }\n    }\n    ...\n  }\n}\n```\n\n省去了一些细节，只保留了主线逻辑，我们可以看到，其扫描到的jar和class都经过了ScanUtils的方法来处理，我们继续跟踪下去，会发现，*scanJar*也是循环调用的*scanClass*，这样我们直接看*scanClass*方法：\n\n```groovy\nstatic void scanClass(InputStream inputStream) {\n  ClassReader cr = new ClassReader(inputStream)\n  ClassWriter cw = new ClassWriter(cr, 0)\n  ScanClassVisitor cv = new ScanClassVisitor(Opcodes.ASM5, cw)\n  cr.accept(cv, ClassReader.EXPAND_FRAMES)\n  inputStream.close()\n}\n\nstatic class ScanClassVisitor extends ClassVisitor {\n\n  ScanClassVisitor(int api, ClassVisitor cv) {\n    super(api, cv)\n  }\n\n  void visit(int version, int access, String name, String signature,\n             String superName, String[] interfaces) {\n    super.visit(version, access, name, signature, superName, interfaces)\n    RegisterTransform.registerList.each { ext ->\n      if (ext.interfaceName && interfaces != null) {\n        interfaces.each { itName ->\n          if (itName == ext.interfaceName) {\n            //fix repeated inject init code when Multi-channel packaging\n            if (!ext.classList.contains(name)) {\n              ext.classList.add(name)\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\n这里就又涉及到了ASM的知识，ScanClassVisitor是访问某个类的内部结构。\n\n>version：类的版本；\n>\n>access：表示类的访问权限，public，private，protected等；\n>\n>name：类的名字；\n>\n>signature：有无泛型；\n>\n>superName：其父类；\n>\n>interfaces：其实现的接口；\n\n在*ScanClassVisitor*中，并没有对类做修改，只是从遍历过的类中，把我们关心的类挑出来。那么，我们关心哪些类呢？\n\n在*PluginLaunch*类中，我们注册了三个*ScanSettings*类，分别是**IRouteRoot**、**IInterceptorGroup**和**IProviderGroup**，也就是说，我们把实现了这三个接口的类，挑出来，加入到各自对应的ScanSettings类中记录起来。这三个接口是不是很熟悉？就是通过APT生成的用来记录路由路径表的类。\n\n等收集好了这些记录的路径表信息后，就可以对*LogisticsCenter*通过ASM进行修改了。我们接着看*RegisterTransform#transform*方法中剩下的逻辑。\n\n```groovy\nif (fileContainsInitClass) {\n  registerList.each { ext ->\n    Logger.i('Insert register code to file ' + fileContainsInitClass.absolutePath)\n\n    if (ext.classList.isEmpty()) {\n      Logger.e(\"No class implements found for interface:\" + ext.interfaceName)\n    } else {\n      ext.classList.each {\n        Logger.i(it)\n      }\n      RegisterCodeGenerator.insertInitCodeTo(ext)\n    }\n  }\n}\n```\n\n注意此处的insertInitCodeTo方法，这就是ASM修改的入口了。这里不对修改过程进行详细解释了。我们直接对比看*LogisticsCenter*修改前后关键代码的对比。\n\n在*app/build*目录下，找到生成的apk文件，通过AndroidStudio来查看其中的class，找到关键*LogisticsCenter*关键方法*loadRouterMap*。\n\n> 具体过程如下：\n>\n> app/build/outputs/apk/debug/app-debug.apk -> classes.dex(双击) -> 找到*LogisticsCenter#loadRouterMap*方法 -> 右键: show Bytecode。\n\n```java\n// 不使用apply plugin: 'com.alibaba.arouter'\n.method private static loadRouterMap()V\n    .registers 1\n\n    .line 64\n    const/4 v0, 0x0\n\n    sput-boolean v0, Lcom/alibaba/android/arouter/core/LogisticsCenter;->registerByPlugin:Z\n\n    .line 69\n    return-void\n.end method\n```\n\n```java\n// 使用apply plugin: 'com.alibaba.arouter'\n.method private static loadRouterMap()V\n    .registers 1\n\n    .line 64\n    const/4 v0, 0x0\n\n    sput-boolean v0, Lcom/alibaba/android/arouter/core/LogisticsCenter;->registerByPlugin:Z\n\n    .line 69\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Root$$modulejava\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Root$$modulekotlin\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Root$$arouterapi\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Root$$app\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Interceptors$$modulejava\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Interceptors$$app\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Providers$$modulejava\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Providers$$modulekotlin\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Providers$$arouterapi\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Providers$$app\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    return-void\n.end method\n```\n\n对比发现，使用`apply plugin: 'com.alibaba.arouter'`后，这个方法增加了很多代码，基本上就是在加载路由路径表。使用这个gradle插件的基本思想就是，将查找路由路径表的过程，从**运行时**提前到了**编译时**，这算是一种AOT(Ahead of time)思想。\n\n将最耗时的查找过程提前，也就解决了ARouter初始化时间过长的问题。","source":"_posts/2022-09-17-ARouter源码分析.md","raw":"---\nlayout: post\ntitle: ARouter源码分析\nauthor: boybeak\ncategory: 源码分析\ntags: Android\ndate: 2022-09-17 00:00:00\n---\n\n\n在阅读源码前，请先下载源码：[ARouter](https://github.com/alibaba/ARouter)\n\n最近阅读ARouter源码，发现这真的是一个非常优秀的框架。激发出兴趣来读一下他的源码，实际上，这个框架的结构非常简单。这个框架可以分为**主流程**和**辅助流程**来拆开分析。\n\n主流程包含**编译时**和**运行时**两个部分，其中编译时主要做的是路由路径表的构建，运行时主要做的是路由路径表的加载；\n\n辅助流程主要就是做**启动优化**。\n\n## 主流程\n\n### 1. 编译时\n\n这部分主要涉及到的是路由路径表的构建，其实现原理是**APT**，即**注解处理器**。\n\n使用ARouter时候，需要在目标类上，通过**@Route**注解进行标记，注解处理器处理的就是这个注解。打开源码路径下的*arouter-compiler*这个module，找到**RouteProcessor**，这个类就是用来处理**@Route**注解的类。这里需要了解的知识，除了APT，还有java-poet，请自行了解这些。\n\nProcessor类的入口方法是*process*方法，这个方法返回true，则这个处理器已经完成了自己的任务，不会被重复调用。其他比较重要的方法有*getSupportedSourceVersion*，*getSupportedAnnotationTypes*等。\n\n```java\nSet<? extends Element> routeElements = roundEnv.getElementsAnnotatedWith(Route.class);\n```\n\n通过这个方法，获取所有被**@Route**标记的元素。\n\n获取到*routeElements*后，在*parseRoutes*方法进行处理。我们以最常用的Activity为例，进行分析。\n\n```java\nrootMap.clear();\t//用来分类存储标记元素\n\n// 用来检测元素是否为对应的类型，通过Types.isSubtype()方法来检测。\nTypeMirror type_Activity = elementUtils.getTypeElement(ACTIVITY).asType();\nTypeMirror type_Service = elementUtils.getTypeElement(SERVICE).asType();\nTypeMirror fragmentTm = elementUtils.getTypeElement(FRAGMENT).asType();\nTypeMirror fragmentTmV4 = elementUtils.getTypeElement(Consts.FRAGMENT_V4).asType();\n```\n\n最后将分类号的元素信息，存储在成员变量groupMap中去。\n\n```java\nprivate Map<String, Set<RouteMeta>> groupMap = new HashMap<>();\n```\n\n然后再通过这个groupMap，借助java-poet，来生成真实的类。如下：\n\n```java\npublic class ARouter$$Group$$test implements IRouteGroup {\n  @Override\n  public void loadInto(Map<String, RouteMeta> atlas) {\n    atlas.put(\"/test/activity1\", RouteMeta.build(RouteType.ACTIVITY, Test1Activity.class, \"/test/activity1\", \"test\", new java.util.HashMap<String, Integer>(){{put(\"ser\", 9); put(\"ch\", 5); put(\"fl\", 6); put(\"dou\", 7); put(\"boy\", 0); put(\"url\", 8); put(\"pac\", 10); put(\"obj\", 11); put(\"name\", 8); put(\"objList\", 11); put(\"map\", 11); put(\"age\", 3); put(\"height\", 3); }}, -1, -2147483648));\n    atlas.put(\"/test/activity2\", RouteMeta.build(RouteType.ACTIVITY, Test2Activity.class, \"/test/activity2\", \"test\", new java.util.HashMap<String, Integer>(){{put(\"key1\", 8); }}, -1, -2147483648));\n    atlas.put(\"/test/activity3\", RouteMeta.build(RouteType.ACTIVITY, Test3Activity.class, \"/test/activity3\", \"test\", new java.util.HashMap<String, Integer>(){{put(\"name\", 8); put(\"boy\", 0); put(\"age\", 3); }}, -1, -2147483648));\n    atlas.put(\"/test/activity4\", RouteMeta.build(RouteType.ACTIVITY, Test4Activity.class, \"/test/activity4\", \"test\", null, -1, -2147483648));\n    atlas.put(\"/test/fragment\", RouteMeta.build(RouteType.FRAGMENT, BlankFragment.class, \"/test/fragment\", \"test\", new java.util.HashMap<String, Integer>(){{put(\"obj\", 11); put(\"name\", 8); }}, -1, -2147483648));\n    atlas.put(\"/test/webview\", RouteMeta.build(RouteType.ACTIVITY, TestWebview.class, \"/test/webview\", \"test\", null, -1, -2147483648));\n  }\n}\n```\n\n\n\n### 2. 运行时\n\n这部分主要做的是，在*ARouter.init()*时候，将上过程生成的路径表加载到内存中。\n\n> 如果你以官方demo程序验证这一步，需要将app/build.gradle中的`apply plugin: 'com.alibaba.arouter'`这一行代码注释掉。\n\n我们以*ARouter.init*方法为入口，实际上最终实现init流程的是LogisticsCenter类的*init*方法。\n\n```java\npublic synchronized static void init(Context context, ThreadPoolExecutor tpe) throws HandlerException {\n  ...\n  if (registerByPlugin) {\n    //这是在辅助流程需要去讲的\n  \tlogger.info(TAG, \"Load router map by arouter-auto-register plugin.\");\n  } else {\n    Set<String> routerMap;\n\n    // It will rebuild router map every times when debuggable.\n    if (ARouter.debuggable() || PackageUtils.isNewVersion(context)) {\n      logger.info(TAG, \"Run with debug mode or new install, rebuild router map.\");\n      // These class was generated by arouter-compiler.\n      routerMap = ClassUtils.getFileNameByPackageName(mContext, ROUTE_ROOT_PAKCAGE);\n      if (!routerMap.isEmpty()) {\n        context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).edit().putStringSet(AROUTER_SP_KEY_MAP, routerMap).apply();\n      }\n\n      PackageUtils.updateVersion(context);    // Save new version name when router map update finishes.\n    } else {\n      logger.info(TAG, \"Load router map from cache.\");\n      routerMap = new HashSet<>(context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).getStringSet(AROUTER_SP_KEY_MAP, new HashSet<String>()));\n    }\n  }\n}\n```\n\n这里需要着重看的是这一句：\n\n```java\nrouterMap = ClassUtils.getFileNameByPackageName(mContext, ROUTE_ROOT_PAKCAGE);\n```\n\n我们查看这个方法:\n\n```java\npublic static Set<String> getFileNameByPackageName(Context context, final String packageName) throws PackageManager.NameNotFoundException, IOException, InterruptedException {\n  final Set<String> classNames = new HashSet<>();\n\n  List<String> paths = getSourcePaths(context);\n  final CountDownLatch parserCtl = new CountDownLatch(paths.size());\n\n  for (final String path : paths) {\n    Log.v(TAG, \"getFileNameByPackageName path=\" + path);\n    DefaultPoolExecutor.getInstance().execute(new Runnable() {\n      @Override\n      public void run() {\n        DexFile dexfile = null;\n\n        try {\n          if (path.endsWith(EXTRACTED_SUFFIX)) {\n            //NOT use new DexFile(path), because it will throw \"permission error in /data/dalvik-cache\"\n            dexfile = DexFile.loadDex(path, path + \".tmp\", 0);\n          } else {\n            dexfile = new DexFile(path);\n          }\n\n          Enumeration<String> dexEntries = dexfile.entries();\n          while (dexEntries.hasMoreElements()) {\n            String className = dexEntries.nextElement();\n            if (className.startsWith(packageName)) {\n              Log.v(TAG, \"find CLASS NAME \" + className);\n              classNames.add(className);\n            }\n          }\n        } catch (Throwable ignore) {\n          Log.e(\"ARouter\", \"Scan map file in dex files made error.\", ignore);\n        } finally {\n          if (null != dexfile) {\n            try {\n              dexfile.close();\n            } catch (Throwable ignore) {\n            }\n          }\n\n          parserCtl.countDown();\n        }\n      }\n    });\n  }\n\n  parserCtl.await();\n\n  Log.d(Consts.TAG, \"Filter \" + classNames.size() + \" classes by packageName <\" + packageName + \">\");\n  return classNames;\n}\n```\n\n注意其中的*getSourcePaths*方法，这是从代码目录，来获取所有代码目录，然后在\n\n*getFileNameByPackageName*找出以`com.alibaba.android.arouter.routes`为开头包名的类，这些就是我们在步骤1中生成的辅助类。\n\n这个方法结束后，回到*LogisticsCenter#init*方法，接下来要做的就是，把加载到的辅助类，通过反射生成对象，再调用其*loadTo*方法，将路由路径表加载到Warehouse类中去，方便以后的查询。\n\n\n\n## 辅助流程\n\n在以上的流程中，有一个严重的问题，那就是执行*ARouter#init*方法的时间过长，以源码的demo为例，在InstantRun的情况下，OnePlus5T需要100多毫秒才能初始化完，这对于程序启动优化来说，是一个不可忽视的时间了。那么如何解决这个问题呢？\n\n```shell\nMainActivity: init cost 134\n```\n\n这就是在上一步中，要求你注释掉的代码起作用了，将`apply plugin: 'com.alibaba.arouter'`解除注释，让其发挥作用。\n\n这里需要关注的module是`arouter-gradle-plugin`。\n\n先来看一下，使用了`apply plugin: 'com.alibaba.arouter'`的神奇效果。\n\n```shell\nMainActivity: init cost 19\n```\n\n通过优化，让*ARouter#init*消耗时间直接降低了一个数量级，那么`arouter-gradle-plugin`是怎么做到的呢？\n\n这需要你先了解一下[ASM]({{site.base_url}}/android/ASM.md)。简单来说，这是一种字节码编程技术，通过修改编译后的字节码的方式，来对原始逻辑增强。\n\n我们再来看*ARouter#init*的最终实现类和方法*LogisticsCenter#init*：\n\n```java\npublic synchronized static void init(Context context, ThreadPoolExecutor tpe) throws HandlerException {\n  ....\n  try {\n    long startInit = System.currentTimeMillis();\n    //billy.qi modified at 2017-12-06\n    //load by plugin first\n    loadRouterMap();\n    if (registerByPlugin) {\n      logger.info(TAG, \"Load router map by arouter-auto-register plugin.\");\n    } else {\n      ....\n    }\n    .....\n  } catch (Exception e) {\n    throw new HandlerException(TAG + \"ARouter init logistics center exception! [\" + e.getMessage() + \"]\");\n  }\n}\n```\n\n我们可以看到，当`registerByPlugin`为true的时候，则只是打印了一句日志，我们再看loadRouterMap()这个方法：\n\n```java\nprivate static void loadRouterMap() {\n  registerByPlugin = false;\n  //auto generate register code by gradle plugin: arouter-auto-register\n  // looks like below:\n  // registerRouteRoot(new ARouter..Root..modulejava());\n  // registerRouteRoot(new ARouter..Root..modulekotlin());\n}\n```\n\n这里的逻辑非常简单，到底在哪里去加载的路由路径表呢？我们看这个方法的注释，发现，这个方法是被`arouter-auto-register`自动生成的。\n\n我们打开`arouter-gradle-plugin/resources/META-INF/gradle-plugins`这个目录，可以看到，有一个*com.alibaba.arouter.properties*文件，查看其内容：\n\n```properties\nimplementation-class=com.alibaba.android.arouter.register.launch.PluginLaunch\n```\n\n这个*PluginLaunch*便是此gradle plugin的入口类。查看此类：\n\n```groovy\npublic class PluginLaunch implements Plugin<Project> {\n\n  @Override\n  public void apply(Project project) {\n    def isApp = project.plugins.hasPlugin(AppPlugin)\n    //only application module needs this plugin to generate register code\n    if (isApp) {\n      Logger.make(project)\n\n      Logger.i('Project enable arouter-register plugin')\n\n      def android = project.extensions.getByType(AppExtension)\n      def transformImpl = new RegisterTransform(project)\n\n      //init arouter-auto-register settings\n      ArrayList<ScanSetting> list = new ArrayList<>(3)\n      list.add(new ScanSetting('IRouteRoot'))\n      list.add(new ScanSetting('IInterceptorGroup'))\n      list.add(new ScanSetting('IProviderGroup'))\n      RegisterTransform.registerList = list\n      //register this plugin\n      android.registerTransform(transformImpl)\n    }\n  }\n\n}\n```\n\n我们查看其代码，可以发现，这里一共做了三件事：\n\n1. 判断是否为app module，如果不是，则不做任何事，在app module下做2和3两步；\n2. 生成了一个RegisterTransform，并为其静态变量registerList赋值，**注意此处赋值的registerList中包含的三个对象**；\n3. 注册此RegisterTransform。\n\n接下来，就轮到*RegisterTransform*来执行了。\n\nTransform类，简单来说，就是可以在编译时，扫描所有的jar和class，包括引用类库中的。在扫描过程中，就可以借助**ASM**技术对目标类进行更改。\n\n我们看其入口方法*transform*：\n\n```groovy\n@Override\nvoid transform(Context context, Collection<TransformInput> inputs, Collection<TransformInput> referencedInputs, TransformOutputProvider outputProvider, boolean isIncremental) throws IOException, TransformException, InterruptedException {\n  inputs.each { TransformInput input ->\n    // scan all jars\n    input.jarInputs.each { JarInput jarInput ->\n      ...\n      if (ScanUtil.shouldProcessPreDexJar(src.absolutePath)) {\n        ScanUtil.scanJar(src, dest)\n      }\n      ...\n    }\n  }\n  input.directoryInputs.each { DirectoryInput directoryInput ->\n    ...\n    directoryInput.file.eachFileRecurse { File file ->\n      ...\n      if(file.isFile() && ScanUtil.shouldProcessClass(path)){\n        ScanUtil.scanClass(file)\n      }\n    }\n    ...\n  }\n}\n```\n\n省去了一些细节，只保留了主线逻辑，我们可以看到，其扫描到的jar和class都经过了ScanUtils的方法来处理，我们继续跟踪下去，会发现，*scanJar*也是循环调用的*scanClass*，这样我们直接看*scanClass*方法：\n\n```groovy\nstatic void scanClass(InputStream inputStream) {\n  ClassReader cr = new ClassReader(inputStream)\n  ClassWriter cw = new ClassWriter(cr, 0)\n  ScanClassVisitor cv = new ScanClassVisitor(Opcodes.ASM5, cw)\n  cr.accept(cv, ClassReader.EXPAND_FRAMES)\n  inputStream.close()\n}\n\nstatic class ScanClassVisitor extends ClassVisitor {\n\n  ScanClassVisitor(int api, ClassVisitor cv) {\n    super(api, cv)\n  }\n\n  void visit(int version, int access, String name, String signature,\n             String superName, String[] interfaces) {\n    super.visit(version, access, name, signature, superName, interfaces)\n    RegisterTransform.registerList.each { ext ->\n      if (ext.interfaceName && interfaces != null) {\n        interfaces.each { itName ->\n          if (itName == ext.interfaceName) {\n            //fix repeated inject init code when Multi-channel packaging\n            if (!ext.classList.contains(name)) {\n              ext.classList.add(name)\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\n这里就又涉及到了ASM的知识，ScanClassVisitor是访问某个类的内部结构。\n\n>version：类的版本；\n>\n>access：表示类的访问权限，public，private，protected等；\n>\n>name：类的名字；\n>\n>signature：有无泛型；\n>\n>superName：其父类；\n>\n>interfaces：其实现的接口；\n\n在*ScanClassVisitor*中，并没有对类做修改，只是从遍历过的类中，把我们关心的类挑出来。那么，我们关心哪些类呢？\n\n在*PluginLaunch*类中，我们注册了三个*ScanSettings*类，分别是**IRouteRoot**、**IInterceptorGroup**和**IProviderGroup**，也就是说，我们把实现了这三个接口的类，挑出来，加入到各自对应的ScanSettings类中记录起来。这三个接口是不是很熟悉？就是通过APT生成的用来记录路由路径表的类。\n\n等收集好了这些记录的路径表信息后，就可以对*LogisticsCenter*通过ASM进行修改了。我们接着看*RegisterTransform#transform*方法中剩下的逻辑。\n\n```groovy\nif (fileContainsInitClass) {\n  registerList.each { ext ->\n    Logger.i('Insert register code to file ' + fileContainsInitClass.absolutePath)\n\n    if (ext.classList.isEmpty()) {\n      Logger.e(\"No class implements found for interface:\" + ext.interfaceName)\n    } else {\n      ext.classList.each {\n        Logger.i(it)\n      }\n      RegisterCodeGenerator.insertInitCodeTo(ext)\n    }\n  }\n}\n```\n\n注意此处的insertInitCodeTo方法，这就是ASM修改的入口了。这里不对修改过程进行详细解释了。我们直接对比看*LogisticsCenter*修改前后关键代码的对比。\n\n在*app/build*目录下，找到生成的apk文件，通过AndroidStudio来查看其中的class，找到关键*LogisticsCenter*关键方法*loadRouterMap*。\n\n> 具体过程如下：\n>\n> app/build/outputs/apk/debug/app-debug.apk -> classes.dex(双击) -> 找到*LogisticsCenter#loadRouterMap*方法 -> 右键: show Bytecode。\n\n```java\n// 不使用apply plugin: 'com.alibaba.arouter'\n.method private static loadRouterMap()V\n    .registers 1\n\n    .line 64\n    const/4 v0, 0x0\n\n    sput-boolean v0, Lcom/alibaba/android/arouter/core/LogisticsCenter;->registerByPlugin:Z\n\n    .line 69\n    return-void\n.end method\n```\n\n```java\n// 使用apply plugin: 'com.alibaba.arouter'\n.method private static loadRouterMap()V\n    .registers 1\n\n    .line 64\n    const/4 v0, 0x0\n\n    sput-boolean v0, Lcom/alibaba/android/arouter/core/LogisticsCenter;->registerByPlugin:Z\n\n    .line 69\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Root$$modulejava\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Root$$modulekotlin\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Root$$arouterapi\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Root$$app\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Interceptors$$modulejava\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Interceptors$$app\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Providers$$modulejava\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Providers$$modulekotlin\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Providers$$arouterapi\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    const-string v0, \"com.alibaba.android.arouter.routes.ARouter$$Providers$$app\"\n\n    invoke-static {v0}, Lcom/alibaba/android/arouter/core/LogisticsCenter;->register(Ljava/lang/String;)V\n\n    return-void\n.end method\n```\n\n对比发现，使用`apply plugin: 'com.alibaba.arouter'`后，这个方法增加了很多代码，基本上就是在加载路由路径表。使用这个gradle插件的基本思想就是，将查找路由路径表的过程，从**运行时**提前到了**编译时**，这算是一种AOT(Ahead of time)思想。\n\n将最耗时的查找过程提前，也就解决了ARouter初始化时间过长的问题。","slug":"2022-09-17-ARouter源码分析","published":1,"updated":"2024-11-13T13:38:34.523Z","_id":"cm1ltr0fx0006bji012l19ffc","comments":1,"photos":[],"content":"<p>在阅读源码前，请先下载源码：<a href=\"https://github.com/alibaba/ARouter\">ARouter</a></p>\n<p>最近阅读ARouter源码，发现这真的是一个非常优秀的框架。激发出兴趣来读一下他的源码，实际上，这个框架的结构非常简单。这个框架可以分为<strong>主流程</strong>和<strong>辅助流程</strong>来拆开分析。</p>\n<p>主流程包含<strong>编译时</strong>和<strong>运行时</strong>两个部分，其中编译时主要做的是路由路径表的构建，运行时主要做的是路由路径表的加载；</p>\n<p>辅助流程主要就是做<strong>启动优化</strong>。</p>\n<h2 id=\"主流程\"><a href=\"#主流程\" class=\"headerlink\" title=\"主流程\"></a>主流程</h2><h3 id=\"1-编译时\"><a href=\"#1-编译时\" class=\"headerlink\" title=\"1. 编译时\"></a>1. 编译时</h3><p>这部分主要涉及到的是路由路径表的构建，其实现原理是<strong>APT</strong>，即<strong>注解处理器</strong>。</p>\n<p>使用ARouter时候，需要在目标类上，通过**@Route<strong>注解进行标记，注解处理器处理的就是这个注解。打开源码路径下的<em>arouter-compiler</em>这个module，找到</strong>RouteProcessor<strong>，这个类就是用来处理</strong>@Route**注解的类。这里需要了解的知识，除了APT，还有java-poet，请自行了解这些。</p>\n<p>Processor类的入口方法是<em>process</em>方法，这个方法返回true，则这个处理器已经完成了自己的任务，不会被重复调用。其他比较重要的方法有<em>getSupportedSourceVersion</em>，<em>getSupportedAnnotationTypes</em>等。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Element</span><span class=\"token punctuation\">></span></span> routeElements <span class=\"token operator\">=</span> roundEnv<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsAnnotatedWith</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Route</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>通过这个方法，获取所有被**@Route**标记的元素。</p>\n<p>获取到<em>routeElements</em>后，在<em>parseRoutes</em>方法进行处理。我们以最常用的Activity为例，进行分析。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\">rootMap<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">//用来分类存储标记元素</span>\n\n<span class=\"token comment\">// 用来检测元素是否为对应的类型，通过Types.isSubtype()方法来检测。</span>\n<span class=\"token class-name\">TypeMirror</span> type_Activity <span class=\"token operator\">=</span> elementUtils<span class=\"token punctuation\">.</span><span class=\"token function\">getTypeElement</span><span class=\"token punctuation\">(</span><span class=\"token constant\">ACTIVITY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">asType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">TypeMirror</span> type_Service <span class=\"token operator\">=</span> elementUtils<span class=\"token punctuation\">.</span><span class=\"token function\">getTypeElement</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SERVICE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">asType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">TypeMirror</span> fragmentTm <span class=\"token operator\">=</span> elementUtils<span class=\"token punctuation\">.</span><span class=\"token function\">getTypeElement</span><span class=\"token punctuation\">(</span><span class=\"token constant\">FRAGMENT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">asType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">TypeMirror</span> fragmentTmV4 <span class=\"token operator\">=</span> elementUtils<span class=\"token punctuation\">.</span><span class=\"token function\">getTypeElement</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Consts</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FRAGMENT_V4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">asType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>最后将分类号的元素信息，存储在成员变量groupMap中去。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">RouteMeta</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> groupMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>然后再通过这个groupMap，借助java-poet，来生成真实的类。如下：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ARouter</span>$$<span class=\"token class-name\">Group</span>$$test <span class=\"token keyword\">implements</span> <span class=\"token class-name\">IRouteGroup</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">loadInto</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RouteMeta</span><span class=\"token punctuation\">></span></span> atlas<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    atlas<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/test/activity1\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RouteMeta</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RouteType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVITY</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Test1Activity</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/test/activity1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span>HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ser\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ch\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fl\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dou\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"boy\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pac\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"obj\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"objList\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"map\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"age\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"height\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2147483648</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    atlas<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/test/activity2\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RouteMeta</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RouteType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVITY</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Test2Activity</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/test/activity2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span>HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"key1\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2147483648</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    atlas<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/test/activity3\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RouteMeta</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RouteType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVITY</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Test3Activity</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/test/activity3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span>HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"boy\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"age\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2147483648</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    atlas<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/test/activity4\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RouteMeta</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RouteType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVITY</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Test4Activity</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/test/activity4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2147483648</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    atlas<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/test/fragment\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RouteMeta</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RouteType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FRAGMENT</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">BlankFragment</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/test/fragment\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span>HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"obj\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2147483648</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    atlas<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/test/webview\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RouteMeta</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RouteType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVITY</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TestWebview</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/test/webview\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2147483648</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n\n\n<h3 id=\"2-运行时\"><a href=\"#2-运行时\" class=\"headerlink\" title=\"2. 运行时\"></a>2. 运行时</h3><p>这部分主要做的是，在*ARouter.init()*时候，将上过程生成的路径表加载到内存中。</p>\n<blockquote>\n<p>如果你以官方demo程序验证这一步，需要将app&#x2F;build.gradle中的<code>apply plugin: &#39;com.alibaba.arouter&#39;</code>这一行代码注释掉。</p>\n</blockquote>\n<p>我们以<em>ARouter.init</em>方法为入口，实际上最终实现init流程的是LogisticsCenter类的<em>init</em>方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ThreadPoolExecutor</span> tpe<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">HandlerException</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>registerByPlugin<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">//这是在辅助流程需要去讲的</span>\n  \tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Load router map by arouter-auto-register plugin.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> routerMap<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// It will rebuild router map every times when debuggable.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ARouter</span><span class=\"token punctuation\">.</span><span class=\"token function\">debuggable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token class-name\">PackageUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isNewVersion</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      logger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Run with debug mode or new install, rebuild router map.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">// These class was generated by arouter-compiler.</span>\n      routerMap <span class=\"token operator\">=</span> <span class=\"token class-name\">ClassUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getFileNameByPackageName</span><span class=\"token punctuation\">(</span>mContext<span class=\"token punctuation\">,</span> <span class=\"token constant\">ROUTE_ROOT_PAKCAGE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>routerMap<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        context<span class=\"token punctuation\">.</span><span class=\"token function\">getSharedPreferences</span><span class=\"token punctuation\">(</span><span class=\"token constant\">AROUTER_SP_CACHE_KEY</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Context</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MODE_PRIVATE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">edit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">putStringSet</span><span class=\"token punctuation\">(</span><span class=\"token constant\">AROUTER_SP_KEY_MAP</span><span class=\"token punctuation\">,</span> routerMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n\n      <span class=\"token class-name\">PackageUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">updateVersion</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Save new version name when router map update finishes.</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n      logger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Load router map from cache.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      routerMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span><span class=\"token function\">getSharedPreferences</span><span class=\"token punctuation\">(</span><span class=\"token constant\">AROUTER_SP_CACHE_KEY</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Context</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MODE_PRIVATE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getStringSet</span><span class=\"token punctuation\">(</span><span class=\"token constant\">AROUTER_SP_KEY_MAP</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里需要着重看的是这一句：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\">routerMap <span class=\"token operator\">=</span> <span class=\"token class-name\">ClassUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getFileNameByPackageName</span><span class=\"token punctuation\">(</span>mContext<span class=\"token punctuation\">,</span> <span class=\"token constant\">ROUTE_ROOT_PAKCAGE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>我们查看这个方法:</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getFileNameByPackageName</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> packageName<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">PackageManager<span class=\"token punctuation\">.</span>NameNotFoundException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">final</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> classNames <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> paths <span class=\"token operator\">=</span> <span class=\"token function\">getSourcePaths</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">final</span> <span class=\"token class-name\">CountDownLatch</span> parserCtl <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CountDownLatch</span><span class=\"token punctuation\">(</span>paths<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> path <span class=\"token operator\">:</span> paths<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"getFileNameByPackageName path=\"</span> <span class=\"token operator\">+</span> path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">DefaultPoolExecutor</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token annotation punctuation\">@Override</span>\n      <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">DexFile</span> dexfile <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">endsWith</span><span class=\"token punctuation\">(</span><span class=\"token constant\">EXTRACTED_SUFFIX</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">//NOT use new DexFile(path), because it will throw \"permission error in /data/dalvik-cache\"</span>\n            dexfile <span class=\"token operator\">=</span> <span class=\"token class-name\">DexFile</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadDex</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> path <span class=\"token operator\">+</span> <span class=\"token string\">\".tmp\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n            dexfile <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DexFile</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">&#125;</span>\n\n          <span class=\"token class-name\">Enumeration</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> dexEntries <span class=\"token operator\">=</span> dexfile<span class=\"token punctuation\">.</span><span class=\"token function\">entries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>dexEntries<span class=\"token punctuation\">.</span><span class=\"token function\">hasMoreElements</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">String</span> className <span class=\"token operator\">=</span> dexEntries<span class=\"token punctuation\">.</span><span class=\"token function\">nextElement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>className<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span>packageName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n              <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"find CLASS NAME \"</span> <span class=\"token operator\">+</span> className<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              classNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>className<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span>\n          <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> ignore<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n          <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">e</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ARouter\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Scan map file in dex files made error.\"</span><span class=\"token punctuation\">,</span> ignore<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span> <span class=\"token operator\">!=</span> dexfile<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n              dexfile<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> ignore<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token punctuation\">&#125;</span>\n          <span class=\"token punctuation\">&#125;</span>\n\n          parserCtl<span class=\"token punctuation\">.</span><span class=\"token function\">countDown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  parserCtl<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">d</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Consts</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Filter \"</span> <span class=\"token operator\">+</span> classNames<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" classes by packageName &lt;\"</span> <span class=\"token operator\">+</span> packageName <span class=\"token operator\">+</span> <span class=\"token string\">\">\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> classNames<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>注意其中的<em>getSourcePaths</em>方法，这是从代码目录，来获取所有代码目录，然后在</p>\n<p><em>getFileNameByPackageName</em>找出以<code>com.alibaba.android.arouter.routes</code>为开头包名的类，这些就是我们在步骤1中生成的辅助类。</p>\n<p>这个方法结束后，回到<em>LogisticsCenter#init</em>方法，接下来要做的就是，把加载到的辅助类，通过反射生成对象，再调用其<em>loadTo</em>方法，将路由路径表加载到Warehouse类中去，方便以后的查询。</p>\n<h2 id=\"辅助流程\"><a href=\"#辅助流程\" class=\"headerlink\" title=\"辅助流程\"></a>辅助流程</h2><p>在以上的流程中，有一个严重的问题，那就是执行<em>ARouter#init</em>方法的时间过长，以源码的demo为例，在InstantRun的情况下，OnePlus5T需要100多毫秒才能初始化完，这对于程序启动优化来说，是一个不可忽视的时间了。那么如何解决这个问题呢？</p>\n<pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">MainActivity: init cost <span class=\"token number\">134</span></code></pre>\n\n<p>这就是在上一步中，要求你注释掉的代码起作用了，将<code>apply plugin: &#39;com.alibaba.arouter&#39;</code>解除注释，让其发挥作用。</p>\n<p>这里需要关注的module是<code>arouter-gradle-plugin</code>。</p>\n<p>先来看一下，使用了<code>apply plugin: &#39;com.alibaba.arouter&#39;</code>的神奇效果。</p>\n<pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">MainActivity: init cost <span class=\"token number\">19</span></code></pre>\n\n<p>通过优化，让<em>ARouter#init</em>消耗时间直接降低了一个数量级，那么<code>arouter-gradle-plugin</code>是怎么做到的呢？</p>\n<p>这需要你先了解一下[ASM](&#x2F;android&#x2F;ASM.md)。简单来说，这是一种字节码编程技术，通过修改编译后的字节码的方式，来对原始逻辑增强。</p>\n<p>我们再来看<em>ARouter#init</em>的最终实现类和方法<em>LogisticsCenter#init</em>：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ThreadPoolExecutor</span> tpe<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">HandlerException</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">long</span> startInit <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//billy.qi modified at 2017-12-06</span>\n    <span class=\"token comment\">//load by plugin first</span>\n    <span class=\"token function\">loadRouterMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>registerByPlugin<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      logger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Load router map by arouter-auto-register plugin.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HandlerException</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"ARouter init logistics center exception! [\"</span> <span class=\"token operator\">+</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，当<code>registerByPlugin</code>为true的时候，则只是打印了一句日志，我们再看loadRouterMap()这个方法：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">loadRouterMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  registerByPlugin <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">//auto generate register code by gradle plugin: arouter-auto-register</span>\n  <span class=\"token comment\">// looks like below:</span>\n  <span class=\"token comment\">// registerRouteRoot(new ARouter..Root..modulejava());</span>\n  <span class=\"token comment\">// registerRouteRoot(new ARouter..Root..modulekotlin());</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里的逻辑非常简单，到底在哪里去加载的路由路径表呢？我们看这个方法的注释，发现，这个方法是被<code>arouter-auto-register</code>自动生成的。</p>\n<p>我们打开<code>arouter-gradle-plugin/resources/META-INF/gradle-plugins</code>这个目录，可以看到，有一个<em>com.alibaba.arouter.properties</em>文件，查看其内容：</p>\n<pre class=\"language-properties\" data-language=\"properties\"><code class=\"language-properties\"><span class=\"token key attr-name\">implementation-class</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">com.alibaba.android.arouter.register.launch.PluginLaunch</span></code></pre>\n\n<p>这个<em>PluginLaunch</em>便是此gradle plugin的入口类。查看此类：</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PluginLaunch</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Plugin</span><span class=\"token operator\">&lt;</span>Project<span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>Project project<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">def</span> isApp <span class=\"token operator\">=</span> project<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span><span class=\"token function\">hasPlugin</span><span class=\"token punctuation\">(</span>AppPlugin<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">//only application module needs this plugin to generate register code</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isApp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      Logger<span class=\"token punctuation\">.</span><span class=\"token function\">make</span><span class=\"token punctuation\">(</span>project<span class=\"token punctuation\">)</span>\n\n      Logger<span class=\"token punctuation\">.</span><span class=\"token function\">i</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Project enable arouter-register plugin'</span><span class=\"token punctuation\">)</span>\n\n      <span class=\"token keyword\">def</span> android <span class=\"token operator\">=</span> project<span class=\"token punctuation\">.</span>extensions<span class=\"token punctuation\">.</span><span class=\"token function\">getByType</span><span class=\"token punctuation\">(</span>AppExtension<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">def</span> transformImpl <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RegisterTransform</span><span class=\"token punctuation\">(</span>project<span class=\"token punctuation\">)</span>\n\n      <span class=\"token comment\">//init arouter-auto-register settings</span>\n      ArrayList<span class=\"token operator\">&lt;</span>ScanSetting<span class=\"token operator\">></span> list <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n      list<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ScanSetting</span><span class=\"token punctuation\">(</span><span class=\"token string\">'IRouteRoot'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      list<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ScanSetting</span><span class=\"token punctuation\">(</span><span class=\"token string\">'IInterceptorGroup'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      list<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ScanSetting</span><span class=\"token punctuation\">(</span><span class=\"token string\">'IProviderGroup'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      RegisterTransform<span class=\"token punctuation\">.</span>registerList <span class=\"token operator\">=</span> list\n      <span class=\"token comment\">//register this plugin</span>\n      android<span class=\"token punctuation\">.</span><span class=\"token function\">registerTransform</span><span class=\"token punctuation\">(</span>transformImpl<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们查看其代码，可以发现，这里一共做了三件事：</p>\n<ol>\n<li>判断是否为app module，如果不是，则不做任何事，在app module下做2和3两步；</li>\n<li>生成了一个RegisterTransform，并为其静态变量registerList赋值，<strong>注意此处赋值的registerList中包含的三个对象</strong>；</li>\n<li>注册此RegisterTransform。</li>\n</ol>\n<p>接下来，就轮到<em>RegisterTransform</em>来执行了。</p>\n<p>Transform类，简单来说，就是可以在编译时，扫描所有的jar和class，包括引用类库中的。在扫描过程中，就可以借助<strong>ASM</strong>技术对目标类进行更改。</p>\n<p>我们看其入口方法<em>transform</em>：</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">transform</span><span class=\"token punctuation\">(</span>Context context<span class=\"token punctuation\">,</span> Collection<span class=\"token operator\">&lt;</span>TransformInput<span class=\"token operator\">></span> inputs<span class=\"token punctuation\">,</span> Collection<span class=\"token operator\">&lt;</span>TransformInput<span class=\"token operator\">></span> referencedInputs<span class=\"token punctuation\">,</span> TransformOutputProvider outputProvider<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> isIncremental<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> IOException<span class=\"token punctuation\">,</span> TransformException<span class=\"token punctuation\">,</span> InterruptedException <span class=\"token punctuation\">&#123;</span>\n  inputs<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span> TransformInput input <span class=\"token operator\">-></span>\n    <span class=\"token comment\">// scan all jars</span>\n    input<span class=\"token punctuation\">.</span>jarInputs<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span> JarInput jarInput <span class=\"token operator\">-></span>\n      <span class=\"token punctuation\">...</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ScanUtil<span class=\"token punctuation\">.</span><span class=\"token function\">shouldProcessPreDexJar</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">.</span>absolutePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        ScanUtil<span class=\"token punctuation\">.</span><span class=\"token function\">scanJar</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">,</span> dest<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">...</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  input<span class=\"token punctuation\">.</span>directoryInputs<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span> DirectoryInput directoryInput <span class=\"token operator\">-></span>\n    <span class=\"token punctuation\">...</span>\n    directoryInput<span class=\"token punctuation\">.</span>file<span class=\"token punctuation\">.</span>eachFileRecurse <span class=\"token punctuation\">&#123;</span> File file <span class=\"token operator\">-></span>\n      <span class=\"token punctuation\">...</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span><span class=\"token function\">isFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> ScanUtil<span class=\"token punctuation\">.</span><span class=\"token function\">shouldProcessClass</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n        ScanUtil<span class=\"token punctuation\">.</span><span class=\"token function\">scanClass</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">...</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>省去了一些细节，只保留了主线逻辑，我们可以看到，其扫描到的jar和class都经过了ScanUtils的方法来处理，我们继续跟踪下去，会发现，<em>scanJar</em>也是循环调用的<em>scanClass</em>，这样我们直接看<em>scanClass</em>方法：</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">scanClass</span><span class=\"token punctuation\">(</span>InputStream inputStream<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  ClassReader cr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassReader</span><span class=\"token punctuation\">(</span>inputStream<span class=\"token punctuation\">)</span>\n  ClassWriter cw <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassWriter</span><span class=\"token punctuation\">(</span>cr<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n  ScanClassVisitor cv <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ScanClassVisitor</span><span class=\"token punctuation\">(</span>Opcodes<span class=\"token punctuation\">.</span>ASM5<span class=\"token punctuation\">,</span> cw<span class=\"token punctuation\">)</span>\n  cr<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span>cv<span class=\"token punctuation\">,</span> ClassReader<span class=\"token punctuation\">.</span>EXPAND_FRAMES<span class=\"token punctuation\">)</span>\n  inputStream<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ScanClassVisitor</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ClassVisitor</span> <span class=\"token punctuation\">&#123;</span>\n\n  <span class=\"token function\">ScanClassVisitor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> api<span class=\"token punctuation\">,</span> ClassVisitor cv<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>api<span class=\"token punctuation\">,</span> cv<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">void</span> <span class=\"token function\">visit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> version<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> access<span class=\"token punctuation\">,</span> String name<span class=\"token punctuation\">,</span> String signature<span class=\"token punctuation\">,</span>\n             String superName<span class=\"token punctuation\">,</span> String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> interfaces<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">visit</span><span class=\"token punctuation\">(</span>version<span class=\"token punctuation\">,</span> access<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">,</span> superName<span class=\"token punctuation\">,</span> interfaces<span class=\"token punctuation\">)</span>\n    RegisterTransform<span class=\"token punctuation\">.</span>registerList<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span> ext <span class=\"token operator\">-></span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ext<span class=\"token punctuation\">.</span>interfaceName <span class=\"token operator\">&amp;&amp;</span> interfaces <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        interfaces<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span> itName <span class=\"token operator\">-></span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>itName <span class=\"token operator\">==</span> ext<span class=\"token punctuation\">.</span>interfaceName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">//fix repeated inject init code when Multi-channel packaging</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>ext<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n              ext<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#125;</span>\n          <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里就又涉及到了ASM的知识，ScanClassVisitor是访问某个类的内部结构。</p>\n<blockquote>\n<p>version：类的版本；</p>\n<p>access：表示类的访问权限，public，private，protected等；</p>\n<p>name：类的名字；</p>\n<p>signature：有无泛型；</p>\n<p>superName：其父类；</p>\n<p>interfaces：其实现的接口；</p>\n</blockquote>\n<p>在<em>ScanClassVisitor</em>中，并没有对类做修改，只是从遍历过的类中，把我们关心的类挑出来。那么，我们关心哪些类呢？</p>\n<p>在<em>PluginLaunch</em>类中，我们注册了三个<em>ScanSettings</em>类，分别是<strong>IRouteRoot</strong>、<strong>IInterceptorGroup</strong>和<strong>IProviderGroup</strong>，也就是说，我们把实现了这三个接口的类，挑出来，加入到各自对应的ScanSettings类中记录起来。这三个接口是不是很熟悉？就是通过APT生成的用来记录路由路径表的类。</p>\n<p>等收集好了这些记录的路径表信息后，就可以对<em>LogisticsCenter</em>通过ASM进行修改了。我们接着看<em>RegisterTransform#transform</em>方法中剩下的逻辑。</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fileContainsInitClass<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  registerList<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span> ext <span class=\"token operator\">-></span>\n    Logger<span class=\"token punctuation\">.</span><span class=\"token function\">i</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Insert register code to file '</span> <span class=\"token operator\">+</span> fileContainsInitClass<span class=\"token punctuation\">.</span>absolutePath<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ext<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      Logger<span class=\"token punctuation\">.</span><span class=\"token function\">e</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">\"No class implements found for interface:\"</span></span> <span class=\"token operator\">+</span> ext<span class=\"token punctuation\">.</span>interfaceName<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n      ext<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span>\n        Logger<span class=\"token punctuation\">.</span><span class=\"token function\">i</span><span class=\"token punctuation\">(</span>it<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">&#125;</span>\n      RegisterCodeGenerator<span class=\"token punctuation\">.</span><span class=\"token function\">insertInitCodeTo</span><span class=\"token punctuation\">(</span>ext<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>注意此处的insertInitCodeTo方法，这就是ASM修改的入口了。这里不对修改过程进行详细解释了。我们直接对比看<em>LogisticsCenter</em>修改前后关键代码的对比。</p>\n<p>在<em>app&#x2F;build</em>目录下，找到生成的apk文件，通过AndroidStudio来查看其中的class，找到关键<em>LogisticsCenter</em>关键方法<em>loadRouterMap</em>。</p>\n<blockquote>\n<p>具体过程如下：</p>\n<p>app&#x2F;build&#x2F;outputs&#x2F;apk&#x2F;debug&#x2F;app-debug.apk -&gt; classes.dex(双击) -&gt; 找到<em>LogisticsCenter#loadRouterMap</em>方法 -&gt; 右键: show Bytecode。</p>\n</blockquote>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">// 不使用apply plugin: 'com.alibaba.arouter'</span>\n<span class=\"token punctuation\">.</span>method <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token function\">loadRouterMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n    <span class=\"token punctuation\">.</span>registers <span class=\"token number\">1</span>\n\n    <span class=\"token punctuation\">.</span>line <span class=\"token number\">64</span>\n    <span class=\"token keyword\">const</span><span class=\"token operator\">/</span><span class=\"token number\">4</span> v0<span class=\"token punctuation\">,</span> <span class=\"token number\">0x0</span>\n\n    sput<span class=\"token operator\">-</span><span class=\"token keyword\">boolean</span> v0<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span>registerByPlugin<span class=\"token operator\">:</span><span class=\"token class-name\">Z</span>\n\n    <span class=\"token punctuation\">.</span>line <span class=\"token number\">69</span>\n    <span class=\"token keyword\">return</span><span class=\"token operator\">-</span><span class=\"token keyword\">void</span>\n<span class=\"token punctuation\">.</span>end method</code></pre>\n\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">// 使用apply plugin: 'com.alibaba.arouter'</span>\n<span class=\"token punctuation\">.</span>method <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token function\">loadRouterMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n    <span class=\"token punctuation\">.</span>registers <span class=\"token number\">1</span>\n\n    <span class=\"token punctuation\">.</span>line <span class=\"token number\">64</span>\n    <span class=\"token keyword\">const</span><span class=\"token operator\">/</span><span class=\"token number\">4</span> v0<span class=\"token punctuation\">,</span> <span class=\"token number\">0x0</span>\n\n    sput<span class=\"token operator\">-</span><span class=\"token keyword\">boolean</span> v0<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span>registerByPlugin<span class=\"token operator\">:</span><span class=\"token class-name\">Z</span>\n\n    <span class=\"token punctuation\">.</span>line <span class=\"token number\">69</span>\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Root$$modulejava\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Root$$modulekotlin\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Root$$arouterapi\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Root$$app\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Interceptors$$modulejava\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Interceptors$$app\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Providers$$modulejava\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Providers$$modulekotlin\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Providers$$arouterapi\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Providers$$app\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">return</span><span class=\"token operator\">-</span><span class=\"token keyword\">void</span>\n<span class=\"token punctuation\">.</span>end method</code></pre>\n\n<p>对比发现，使用<code>apply plugin: &#39;com.alibaba.arouter&#39;</code>后，这个方法增加了很多代码，基本上就是在加载路由路径表。使用这个gradle插件的基本思想就是，将查找路由路径表的过程，从<strong>运行时</strong>提前到了<strong>编译时</strong>，这算是一种AOT(Ahead of time)思想。</p>\n<p>将最耗时的查找过程提前，也就解决了ARouter初始化时间过长的问题。</p>\n","excerpt":"","more":"<p>在阅读源码前，请先下载源码：<a href=\"https://github.com/alibaba/ARouter\">ARouter</a></p>\n<p>最近阅读ARouter源码，发现这真的是一个非常优秀的框架。激发出兴趣来读一下他的源码，实际上，这个框架的结构非常简单。这个框架可以分为<strong>主流程</strong>和<strong>辅助流程</strong>来拆开分析。</p>\n<p>主流程包含<strong>编译时</strong>和<strong>运行时</strong>两个部分，其中编译时主要做的是路由路径表的构建，运行时主要做的是路由路径表的加载；</p>\n<p>辅助流程主要就是做<strong>启动优化</strong>。</p>\n<h2 id=\"主流程\"><a href=\"#主流程\" class=\"headerlink\" title=\"主流程\"></a>主流程</h2><h3 id=\"1-编译时\"><a href=\"#1-编译时\" class=\"headerlink\" title=\"1. 编译时\"></a>1. 编译时</h3><p>这部分主要涉及到的是路由路径表的构建，其实现原理是<strong>APT</strong>，即<strong>注解处理器</strong>。</p>\n<p>使用ARouter时候，需要在目标类上，通过**@Route<strong>注解进行标记，注解处理器处理的就是这个注解。打开源码路径下的<em>arouter-compiler</em>这个module，找到</strong>RouteProcessor<strong>，这个类就是用来处理</strong>@Route**注解的类。这里需要了解的知识，除了APT，还有java-poet，请自行了解这些。</p>\n<p>Processor类的入口方法是<em>process</em>方法，这个方法返回true，则这个处理器已经完成了自己的任务，不会被重复调用。其他比较重要的方法有<em>getSupportedSourceVersion</em>，<em>getSupportedAnnotationTypes</em>等。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Element</span><span class=\"token punctuation\">></span></span> routeElements <span class=\"token operator\">=</span> roundEnv<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsAnnotatedWith</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Route</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>通过这个方法，获取所有被**@Route**标记的元素。</p>\n<p>获取到<em>routeElements</em>后，在<em>parseRoutes</em>方法进行处理。我们以最常用的Activity为例，进行分析。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\">rootMap<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">//用来分类存储标记元素</span>\n\n<span class=\"token comment\">// 用来检测元素是否为对应的类型，通过Types.isSubtype()方法来检测。</span>\n<span class=\"token class-name\">TypeMirror</span> type_Activity <span class=\"token operator\">=</span> elementUtils<span class=\"token punctuation\">.</span><span class=\"token function\">getTypeElement</span><span class=\"token punctuation\">(</span><span class=\"token constant\">ACTIVITY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">asType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">TypeMirror</span> type_Service <span class=\"token operator\">=</span> elementUtils<span class=\"token punctuation\">.</span><span class=\"token function\">getTypeElement</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SERVICE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">asType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">TypeMirror</span> fragmentTm <span class=\"token operator\">=</span> elementUtils<span class=\"token punctuation\">.</span><span class=\"token function\">getTypeElement</span><span class=\"token punctuation\">(</span><span class=\"token constant\">FRAGMENT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">asType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">TypeMirror</span> fragmentTmV4 <span class=\"token operator\">=</span> elementUtils<span class=\"token punctuation\">.</span><span class=\"token function\">getTypeElement</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Consts</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FRAGMENT_V4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">asType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>最后将分类号的元素信息，存储在成员变量groupMap中去。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">RouteMeta</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> groupMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>然后再通过这个groupMap，借助java-poet，来生成真实的类。如下：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ARouter</span>$$<span class=\"token class-name\">Group</span>$$test <span class=\"token keyword\">implements</span> <span class=\"token class-name\">IRouteGroup</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">loadInto</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RouteMeta</span><span class=\"token punctuation\">></span></span> atlas<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    atlas<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/test/activity1\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RouteMeta</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RouteType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVITY</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Test1Activity</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/test/activity1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span>HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ser\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ch\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fl\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dou\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"boy\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pac\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"obj\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"objList\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"map\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"age\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"height\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2147483648</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    atlas<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/test/activity2\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RouteMeta</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RouteType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVITY</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Test2Activity</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/test/activity2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span>HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"key1\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2147483648</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    atlas<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/test/activity3\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RouteMeta</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RouteType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVITY</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Test3Activity</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/test/activity3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span>HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"boy\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"age\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2147483648</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    atlas<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/test/activity4\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RouteMeta</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RouteType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVITY</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Test4Activity</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/test/activity4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2147483648</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    atlas<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/test/fragment\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RouteMeta</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RouteType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FRAGMENT</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">BlankFragment</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/test/fragment\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span>HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"obj\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2147483648</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    atlas<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/test/webview\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RouteMeta</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RouteType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVITY</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TestWebview</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/test/webview\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2147483648</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n\n\n<h3 id=\"2-运行时\"><a href=\"#2-运行时\" class=\"headerlink\" title=\"2. 运行时\"></a>2. 运行时</h3><p>这部分主要做的是，在*ARouter.init()*时候，将上过程生成的路径表加载到内存中。</p>\n<blockquote>\n<p>如果你以官方demo程序验证这一步，需要将app&#x2F;build.gradle中的<code>apply plugin: &#39;com.alibaba.arouter&#39;</code>这一行代码注释掉。</p>\n</blockquote>\n<p>我们以<em>ARouter.init</em>方法为入口，实际上最终实现init流程的是LogisticsCenter类的<em>init</em>方法。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ThreadPoolExecutor</span> tpe<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">HandlerException</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>registerByPlugin<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">//这是在辅助流程需要去讲的</span>\n  \tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Load router map by arouter-auto-register plugin.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> routerMap<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// It will rebuild router map every times when debuggable.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ARouter</span><span class=\"token punctuation\">.</span><span class=\"token function\">debuggable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token class-name\">PackageUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isNewVersion</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      logger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Run with debug mode or new install, rebuild router map.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">// These class was generated by arouter-compiler.</span>\n      routerMap <span class=\"token operator\">=</span> <span class=\"token class-name\">ClassUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getFileNameByPackageName</span><span class=\"token punctuation\">(</span>mContext<span class=\"token punctuation\">,</span> <span class=\"token constant\">ROUTE_ROOT_PAKCAGE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>routerMap<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        context<span class=\"token punctuation\">.</span><span class=\"token function\">getSharedPreferences</span><span class=\"token punctuation\">(</span><span class=\"token constant\">AROUTER_SP_CACHE_KEY</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Context</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MODE_PRIVATE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">edit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">putStringSet</span><span class=\"token punctuation\">(</span><span class=\"token constant\">AROUTER_SP_KEY_MAP</span><span class=\"token punctuation\">,</span> routerMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n\n      <span class=\"token class-name\">PackageUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">updateVersion</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Save new version name when router map update finishes.</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n      logger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Load router map from cache.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      routerMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span><span class=\"token function\">getSharedPreferences</span><span class=\"token punctuation\">(</span><span class=\"token constant\">AROUTER_SP_CACHE_KEY</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Context</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MODE_PRIVATE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getStringSet</span><span class=\"token punctuation\">(</span><span class=\"token constant\">AROUTER_SP_KEY_MAP</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里需要着重看的是这一句：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\">routerMap <span class=\"token operator\">=</span> <span class=\"token class-name\">ClassUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getFileNameByPackageName</span><span class=\"token punctuation\">(</span>mContext<span class=\"token punctuation\">,</span> <span class=\"token constant\">ROUTE_ROOT_PAKCAGE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>我们查看这个方法:</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getFileNameByPackageName</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> packageName<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">PackageManager<span class=\"token punctuation\">.</span>NameNotFoundException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">final</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> classNames <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> paths <span class=\"token operator\">=</span> <span class=\"token function\">getSourcePaths</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">final</span> <span class=\"token class-name\">CountDownLatch</span> parserCtl <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CountDownLatch</span><span class=\"token punctuation\">(</span>paths<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> path <span class=\"token operator\">:</span> paths<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"getFileNameByPackageName path=\"</span> <span class=\"token operator\">+</span> path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">DefaultPoolExecutor</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token annotation punctuation\">@Override</span>\n      <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">DexFile</span> dexfile <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">endsWith</span><span class=\"token punctuation\">(</span><span class=\"token constant\">EXTRACTED_SUFFIX</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">//NOT use new DexFile(path), because it will throw \"permission error in /data/dalvik-cache\"</span>\n            dexfile <span class=\"token operator\">=</span> <span class=\"token class-name\">DexFile</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadDex</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> path <span class=\"token operator\">+</span> <span class=\"token string\">\".tmp\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n            dexfile <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DexFile</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">&#125;</span>\n\n          <span class=\"token class-name\">Enumeration</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> dexEntries <span class=\"token operator\">=</span> dexfile<span class=\"token punctuation\">.</span><span class=\"token function\">entries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>dexEntries<span class=\"token punctuation\">.</span><span class=\"token function\">hasMoreElements</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">String</span> className <span class=\"token operator\">=</span> dexEntries<span class=\"token punctuation\">.</span><span class=\"token function\">nextElement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>className<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span>packageName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n              <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"find CLASS NAME \"</span> <span class=\"token operator\">+</span> className<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              classNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>className<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span>\n          <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> ignore<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n          <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">e</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ARouter\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Scan map file in dex files made error.\"</span><span class=\"token punctuation\">,</span> ignore<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span> <span class=\"token operator\">!=</span> dexfile<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n              dexfile<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> ignore<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token punctuation\">&#125;</span>\n          <span class=\"token punctuation\">&#125;</span>\n\n          parserCtl<span class=\"token punctuation\">.</span><span class=\"token function\">countDown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  parserCtl<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">d</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Consts</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Filter \"</span> <span class=\"token operator\">+</span> classNames<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" classes by packageName &lt;\"</span> <span class=\"token operator\">+</span> packageName <span class=\"token operator\">+</span> <span class=\"token string\">\">\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> classNames<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>注意其中的<em>getSourcePaths</em>方法，这是从代码目录，来获取所有代码目录，然后在</p>\n<p><em>getFileNameByPackageName</em>找出以<code>com.alibaba.android.arouter.routes</code>为开头包名的类，这些就是我们在步骤1中生成的辅助类。</p>\n<p>这个方法结束后，回到<em>LogisticsCenter#init</em>方法，接下来要做的就是，把加载到的辅助类，通过反射生成对象，再调用其<em>loadTo</em>方法，将路由路径表加载到Warehouse类中去，方便以后的查询。</p>\n<h2 id=\"辅助流程\"><a href=\"#辅助流程\" class=\"headerlink\" title=\"辅助流程\"></a>辅助流程</h2><p>在以上的流程中，有一个严重的问题，那就是执行<em>ARouter#init</em>方法的时间过长，以源码的demo为例，在InstantRun的情况下，OnePlus5T需要100多毫秒才能初始化完，这对于程序启动优化来说，是一个不可忽视的时间了。那么如何解决这个问题呢？</p>\n<pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">MainActivity: init cost <span class=\"token number\">134</span></code></pre>\n\n<p>这就是在上一步中，要求你注释掉的代码起作用了，将<code>apply plugin: &#39;com.alibaba.arouter&#39;</code>解除注释，让其发挥作用。</p>\n<p>这里需要关注的module是<code>arouter-gradle-plugin</code>。</p>\n<p>先来看一下，使用了<code>apply plugin: &#39;com.alibaba.arouter&#39;</code>的神奇效果。</p>\n<pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">MainActivity: init cost <span class=\"token number\">19</span></code></pre>\n\n<p>通过优化，让<em>ARouter#init</em>消耗时间直接降低了一个数量级，那么<code>arouter-gradle-plugin</code>是怎么做到的呢？</p>\n<p>这需要你先了解一下[ASM](&#x2F;android&#x2F;ASM.md)。简单来说，这是一种字节码编程技术，通过修改编译后的字节码的方式，来对原始逻辑增强。</p>\n<p>我们再来看<em>ARouter#init</em>的最终实现类和方法<em>LogisticsCenter#init</em>：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ThreadPoolExecutor</span> tpe<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">HandlerException</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">long</span> startInit <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//billy.qi modified at 2017-12-06</span>\n    <span class=\"token comment\">//load by plugin first</span>\n    <span class=\"token function\">loadRouterMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>registerByPlugin<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      logger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Load router map by arouter-auto-register plugin.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HandlerException</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TAG</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"ARouter init logistics center exception! [\"</span> <span class=\"token operator\">+</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，当<code>registerByPlugin</code>为true的时候，则只是打印了一句日志，我们再看loadRouterMap()这个方法：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">loadRouterMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  registerByPlugin <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">//auto generate register code by gradle plugin: arouter-auto-register</span>\n  <span class=\"token comment\">// looks like below:</span>\n  <span class=\"token comment\">// registerRouteRoot(new ARouter..Root..modulejava());</span>\n  <span class=\"token comment\">// registerRouteRoot(new ARouter..Root..modulekotlin());</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里的逻辑非常简单，到底在哪里去加载的路由路径表呢？我们看这个方法的注释，发现，这个方法是被<code>arouter-auto-register</code>自动生成的。</p>\n<p>我们打开<code>arouter-gradle-plugin/resources/META-INF/gradle-plugins</code>这个目录，可以看到，有一个<em>com.alibaba.arouter.properties</em>文件，查看其内容：</p>\n<pre class=\"language-properties\" data-language=\"properties\"><code class=\"language-properties\"><span class=\"token key attr-name\">implementation-class</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">com.alibaba.android.arouter.register.launch.PluginLaunch</span></code></pre>\n\n<p>这个<em>PluginLaunch</em>便是此gradle plugin的入口类。查看此类：</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PluginLaunch</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Plugin</span><span class=\"token operator\">&lt;</span>Project<span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>Project project<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">def</span> isApp <span class=\"token operator\">=</span> project<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span><span class=\"token function\">hasPlugin</span><span class=\"token punctuation\">(</span>AppPlugin<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">//only application module needs this plugin to generate register code</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isApp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      Logger<span class=\"token punctuation\">.</span><span class=\"token function\">make</span><span class=\"token punctuation\">(</span>project<span class=\"token punctuation\">)</span>\n\n      Logger<span class=\"token punctuation\">.</span><span class=\"token function\">i</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Project enable arouter-register plugin'</span><span class=\"token punctuation\">)</span>\n\n      <span class=\"token keyword\">def</span> android <span class=\"token operator\">=</span> project<span class=\"token punctuation\">.</span>extensions<span class=\"token punctuation\">.</span><span class=\"token function\">getByType</span><span class=\"token punctuation\">(</span>AppExtension<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">def</span> transformImpl <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RegisterTransform</span><span class=\"token punctuation\">(</span>project<span class=\"token punctuation\">)</span>\n\n      <span class=\"token comment\">//init arouter-auto-register settings</span>\n      ArrayList<span class=\"token operator\">&lt;</span>ScanSetting<span class=\"token operator\">></span> list <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n      list<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ScanSetting</span><span class=\"token punctuation\">(</span><span class=\"token string\">'IRouteRoot'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      list<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ScanSetting</span><span class=\"token punctuation\">(</span><span class=\"token string\">'IInterceptorGroup'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      list<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ScanSetting</span><span class=\"token punctuation\">(</span><span class=\"token string\">'IProviderGroup'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      RegisterTransform<span class=\"token punctuation\">.</span>registerList <span class=\"token operator\">=</span> list\n      <span class=\"token comment\">//register this plugin</span>\n      android<span class=\"token punctuation\">.</span><span class=\"token function\">registerTransform</span><span class=\"token punctuation\">(</span>transformImpl<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们查看其代码，可以发现，这里一共做了三件事：</p>\n<ol>\n<li>判断是否为app module，如果不是，则不做任何事，在app module下做2和3两步；</li>\n<li>生成了一个RegisterTransform，并为其静态变量registerList赋值，<strong>注意此处赋值的registerList中包含的三个对象</strong>；</li>\n<li>注册此RegisterTransform。</li>\n</ol>\n<p>接下来，就轮到<em>RegisterTransform</em>来执行了。</p>\n<p>Transform类，简单来说，就是可以在编译时，扫描所有的jar和class，包括引用类库中的。在扫描过程中，就可以借助<strong>ASM</strong>技术对目标类进行更改。</p>\n<p>我们看其入口方法<em>transform</em>：</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">transform</span><span class=\"token punctuation\">(</span>Context context<span class=\"token punctuation\">,</span> Collection<span class=\"token operator\">&lt;</span>TransformInput<span class=\"token operator\">></span> inputs<span class=\"token punctuation\">,</span> Collection<span class=\"token operator\">&lt;</span>TransformInput<span class=\"token operator\">></span> referencedInputs<span class=\"token punctuation\">,</span> TransformOutputProvider outputProvider<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> isIncremental<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> IOException<span class=\"token punctuation\">,</span> TransformException<span class=\"token punctuation\">,</span> InterruptedException <span class=\"token punctuation\">&#123;</span>\n  inputs<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span> TransformInput input <span class=\"token operator\">-></span>\n    <span class=\"token comment\">// scan all jars</span>\n    input<span class=\"token punctuation\">.</span>jarInputs<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span> JarInput jarInput <span class=\"token operator\">-></span>\n      <span class=\"token punctuation\">...</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ScanUtil<span class=\"token punctuation\">.</span><span class=\"token function\">shouldProcessPreDexJar</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">.</span>absolutePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        ScanUtil<span class=\"token punctuation\">.</span><span class=\"token function\">scanJar</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">,</span> dest<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">...</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  input<span class=\"token punctuation\">.</span>directoryInputs<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span> DirectoryInput directoryInput <span class=\"token operator\">-></span>\n    <span class=\"token punctuation\">...</span>\n    directoryInput<span class=\"token punctuation\">.</span>file<span class=\"token punctuation\">.</span>eachFileRecurse <span class=\"token punctuation\">&#123;</span> File file <span class=\"token operator\">-></span>\n      <span class=\"token punctuation\">...</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span><span class=\"token function\">isFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> ScanUtil<span class=\"token punctuation\">.</span><span class=\"token function\">shouldProcessClass</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n        ScanUtil<span class=\"token punctuation\">.</span><span class=\"token function\">scanClass</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">...</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>省去了一些细节，只保留了主线逻辑，我们可以看到，其扫描到的jar和class都经过了ScanUtils的方法来处理，我们继续跟踪下去，会发现，<em>scanJar</em>也是循环调用的<em>scanClass</em>，这样我们直接看<em>scanClass</em>方法：</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">scanClass</span><span class=\"token punctuation\">(</span>InputStream inputStream<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  ClassReader cr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassReader</span><span class=\"token punctuation\">(</span>inputStream<span class=\"token punctuation\">)</span>\n  ClassWriter cw <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassWriter</span><span class=\"token punctuation\">(</span>cr<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n  ScanClassVisitor cv <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ScanClassVisitor</span><span class=\"token punctuation\">(</span>Opcodes<span class=\"token punctuation\">.</span>ASM5<span class=\"token punctuation\">,</span> cw<span class=\"token punctuation\">)</span>\n  cr<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span>cv<span class=\"token punctuation\">,</span> ClassReader<span class=\"token punctuation\">.</span>EXPAND_FRAMES<span class=\"token punctuation\">)</span>\n  inputStream<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ScanClassVisitor</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ClassVisitor</span> <span class=\"token punctuation\">&#123;</span>\n\n  <span class=\"token function\">ScanClassVisitor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> api<span class=\"token punctuation\">,</span> ClassVisitor cv<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>api<span class=\"token punctuation\">,</span> cv<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">void</span> <span class=\"token function\">visit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> version<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> access<span class=\"token punctuation\">,</span> String name<span class=\"token punctuation\">,</span> String signature<span class=\"token punctuation\">,</span>\n             String superName<span class=\"token punctuation\">,</span> String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> interfaces<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">visit</span><span class=\"token punctuation\">(</span>version<span class=\"token punctuation\">,</span> access<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">,</span> superName<span class=\"token punctuation\">,</span> interfaces<span class=\"token punctuation\">)</span>\n    RegisterTransform<span class=\"token punctuation\">.</span>registerList<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span> ext <span class=\"token operator\">-></span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ext<span class=\"token punctuation\">.</span>interfaceName <span class=\"token operator\">&amp;&amp;</span> interfaces <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        interfaces<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span> itName <span class=\"token operator\">-></span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>itName <span class=\"token operator\">==</span> ext<span class=\"token punctuation\">.</span>interfaceName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">//fix repeated inject init code when Multi-channel packaging</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>ext<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n              ext<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#125;</span>\n          <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里就又涉及到了ASM的知识，ScanClassVisitor是访问某个类的内部结构。</p>\n<blockquote>\n<p>version：类的版本；</p>\n<p>access：表示类的访问权限，public，private，protected等；</p>\n<p>name：类的名字；</p>\n<p>signature：有无泛型；</p>\n<p>superName：其父类；</p>\n<p>interfaces：其实现的接口；</p>\n</blockquote>\n<p>在<em>ScanClassVisitor</em>中，并没有对类做修改，只是从遍历过的类中，把我们关心的类挑出来。那么，我们关心哪些类呢？</p>\n<p>在<em>PluginLaunch</em>类中，我们注册了三个<em>ScanSettings</em>类，分别是<strong>IRouteRoot</strong>、<strong>IInterceptorGroup</strong>和<strong>IProviderGroup</strong>，也就是说，我们把实现了这三个接口的类，挑出来，加入到各自对应的ScanSettings类中记录起来。这三个接口是不是很熟悉？就是通过APT生成的用来记录路由路径表的类。</p>\n<p>等收集好了这些记录的路径表信息后，就可以对<em>LogisticsCenter</em>通过ASM进行修改了。我们接着看<em>RegisterTransform#transform</em>方法中剩下的逻辑。</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fileContainsInitClass<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  registerList<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span> ext <span class=\"token operator\">-></span>\n    Logger<span class=\"token punctuation\">.</span><span class=\"token function\">i</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Insert register code to file '</span> <span class=\"token operator\">+</span> fileContainsInitClass<span class=\"token punctuation\">.</span>absolutePath<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ext<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      Logger<span class=\"token punctuation\">.</span><span class=\"token function\">e</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">\"No class implements found for interface:\"</span></span> <span class=\"token operator\">+</span> ext<span class=\"token punctuation\">.</span>interfaceName<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n      ext<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span>\n        Logger<span class=\"token punctuation\">.</span><span class=\"token function\">i</span><span class=\"token punctuation\">(</span>it<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">&#125;</span>\n      RegisterCodeGenerator<span class=\"token punctuation\">.</span><span class=\"token function\">insertInitCodeTo</span><span class=\"token punctuation\">(</span>ext<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>注意此处的insertInitCodeTo方法，这就是ASM修改的入口了。这里不对修改过程进行详细解释了。我们直接对比看<em>LogisticsCenter</em>修改前后关键代码的对比。</p>\n<p>在<em>app&#x2F;build</em>目录下，找到生成的apk文件，通过AndroidStudio来查看其中的class，找到关键<em>LogisticsCenter</em>关键方法<em>loadRouterMap</em>。</p>\n<blockquote>\n<p>具体过程如下：</p>\n<p>app&#x2F;build&#x2F;outputs&#x2F;apk&#x2F;debug&#x2F;app-debug.apk -&gt; classes.dex(双击) -&gt; 找到<em>LogisticsCenter#loadRouterMap</em>方法 -&gt; 右键: show Bytecode。</p>\n</blockquote>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">// 不使用apply plugin: 'com.alibaba.arouter'</span>\n<span class=\"token punctuation\">.</span>method <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token function\">loadRouterMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n    <span class=\"token punctuation\">.</span>registers <span class=\"token number\">1</span>\n\n    <span class=\"token punctuation\">.</span>line <span class=\"token number\">64</span>\n    <span class=\"token keyword\">const</span><span class=\"token operator\">/</span><span class=\"token number\">4</span> v0<span class=\"token punctuation\">,</span> <span class=\"token number\">0x0</span>\n\n    sput<span class=\"token operator\">-</span><span class=\"token keyword\">boolean</span> v0<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span>registerByPlugin<span class=\"token operator\">:</span><span class=\"token class-name\">Z</span>\n\n    <span class=\"token punctuation\">.</span>line <span class=\"token number\">69</span>\n    <span class=\"token keyword\">return</span><span class=\"token operator\">-</span><span class=\"token keyword\">void</span>\n<span class=\"token punctuation\">.</span>end method</code></pre>\n\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">// 使用apply plugin: 'com.alibaba.arouter'</span>\n<span class=\"token punctuation\">.</span>method <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token function\">loadRouterMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n    <span class=\"token punctuation\">.</span>registers <span class=\"token number\">1</span>\n\n    <span class=\"token punctuation\">.</span>line <span class=\"token number\">64</span>\n    <span class=\"token keyword\">const</span><span class=\"token operator\">/</span><span class=\"token number\">4</span> v0<span class=\"token punctuation\">,</span> <span class=\"token number\">0x0</span>\n\n    sput<span class=\"token operator\">-</span><span class=\"token keyword\">boolean</span> v0<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span>registerByPlugin<span class=\"token operator\">:</span><span class=\"token class-name\">Z</span>\n\n    <span class=\"token punctuation\">.</span>line <span class=\"token number\">69</span>\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Root$$modulejava\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Root$$modulekotlin\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Root$$arouterapi\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Root$$app\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Interceptors$$modulejava\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Interceptors$$app\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Providers$$modulejava\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Providers$$modulekotlin\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Providers$$arouterapi\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v0<span class=\"token punctuation\">,</span> <span class=\"token string\">\"com.alibaba.android.arouter.routes.ARouter$$Providers$$app\"</span>\n\n    invoke<span class=\"token operator\">-</span><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>v0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lcom</span><span class=\"token operator\">/</span>alibaba<span class=\"token operator\">/</span>android<span class=\"token operator\">/</span>arouter<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span><span class=\"token class-name\">LogisticsCenter</span><span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ljava</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">V</span>\n\n    <span class=\"token keyword\">return</span><span class=\"token operator\">-</span><span class=\"token keyword\">void</span>\n<span class=\"token punctuation\">.</span>end method</code></pre>\n\n<p>对比发现，使用<code>apply plugin: &#39;com.alibaba.arouter&#39;</code>后，这个方法增加了很多代码，基本上就是在加载路由路径表。使用这个gradle插件的基本思想就是，将查找路由路径表的过程，从<strong>运行时</strong>提前到了<strong>编译时</strong>，这算是一种AOT(Ahead of time)思想。</p>\n<p>将最耗时的查找过程提前，也就解决了ARouter初始化时间过长的问题。</p>\n"},{"layout":"post","title":"LeakCanary原理分析","author":"boybeak","date":"2022-09-16T22:00:00.000Z","_content":"\n\n```groovy\ndependencies {\n  // debugImplementation because LeakCanary should only run in debug builds.\n  debugImplementation 'com.squareup.leakcanary:leakcanary-android:2.5'\n}\n```\n\n只需要这样简单配置，就能接入LeakCanary内存泄漏分析，到底是怎样做到的？\n\n我们将这个问题分成两个问题：\n\n1. 如何**自动**进行初始化的；\n2. 如何检测到内存泄漏的。\n\n\n\n## 如何自动进行初始化的\n\n这部分，我们可以分成两部分去理解——**自动**和**初始化**。\n\n### 自动\n\n这一切还要从`ActivityThread`说起。`ActivityThread`中，执行了一些应用启动的初始化工作，在`ActivityThread`源码中，我们可以看到其内部类`class H extends Handler`的`handleMessage`方法中，有很多与应用相关的一些基本操作，比如**BIND_APPLICATION**, **EXIT_APPLICATION**, **CREATE_SERVICE**, **BIND_SERVICE**等，其中需要我们关注的是**BIND_APPLICATION**。\n\n```java\npublic void handleMessage(Message msg) {\n            ....\n            switch (msg.what) {\n                case BIND_APPLICATION:\n                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, \"bindApplication\");\n                    AppBindData data = (AppBindData)msg.obj;\n                    handleBindApplication(data);\n                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);\n                    break;\n                ....\n            }\n  ....\n}\n```\n\n我们可以看到，其中调用了`handleBindApplication`方法。进入这个方法查看。\n\n```java\n@UnsupportedAppUsage\nprivate void handleBindApplication(AppBindData data) {\n  ....\n  Application app;\n  final StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites();\n  final StrictMode.ThreadPolicy writesAllowedPolicy = StrictMode.getThreadPolicy();\n  try {\n    // If the app is being launched for full backup or restore, bring it up in\n    // a restricted environment with the base application class.\n    app = data.info.makeApplication(data.restrictedBackupMode, null);\n    // Propagate autofill compat state\n    app.setAutofillOptions(data.autofillOptions);\n    // Propagate Content Capture options\n    app.setContentCaptureOptions(data.contentCaptureOptions);\n    mInitialApplication = app;\n    // don't bring up providers in restricted mode; they may depend on the\n    // app's custom Application class\n    if (!data.restrictedBackupMode) {\n      if (!ArrayUtils.isEmpty(data.providers)) {\n        installContentProviders(app, data.providers);\n      }\n    }\n    // Do this after providers, since instrumentation tests generally start their\n    // test thread at this point, and we don't want that racing.\n    try {\n      mInstrumentation.onCreate(data.instrumentationArgs);\n    }\n    catch (Exception e) {\n      throw new RuntimeException(\n        \"Exception thrown in onCreate() of \"\n        + data.instrumentationName + \": \" + e.toString(), e);\n    }\n    try {\n      mInstrumentation.callApplicationOnCreate(app);\n    } catch (Exception e) {\n      if (!mInstrumentation.onException(app, e)) {\n        throw new RuntimeException(\n          \"Unable to create application \" + app.getClass().getName()\n          + \": \" + e.toString(), e);\n      }\n    }\n  } finally {\n    // If the app targets < O-MR1, or doesn't change the thread policy\n    // during startup, clobber the policy to maintain behavior of b/36951662\n    if (data.appInfo.targetSdkVersion < Build.VERSION_CODES.O_MR1\n        || StrictMode.getThreadPolicy().equals(writesAllowedPolicy)) {\n      StrictMode.setThreadPolicy(savedPolicy);\n    }\n  }\n  ....\n}\n```\n\n从这个方法中，我们可以找到这样一段代码，需要重点关注的是，`ContentProvider`的初始化是先于`Application.onCreate`的，且是被`ActivityThread`**自动**执行的。\n\n接下来再看LeakCanary源码。找到[**AppWatcherInstaller.kt**](https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher-android/src/main/java/leakcanary/internal/AppWatcherInstaller.kt)这个类。\n\n```kotlin\n/**\n * Content providers are loaded before the application class is created. [AppWatcherInstaller] is\n * used to install [leakcanary.AppWatcher] on application start.\n */\ninternal sealed class AppWatcherInstaller : ContentProvider() {\n\n  /**\n   * [MainProcess] automatically sets up the LeakCanary code that runs in the main app process.\n   */\n  internal class MainProcess : AppWatcherInstaller()\n\n  /**\n   * When using the `leakcanary-android-process` artifact instead of `leakcanary-android`,\n   * [LeakCanaryProcess] automatically sets up the LeakCanary code\n   */\n  internal class LeakCanaryProcess : AppWatcherInstaller()\n\n  override fun onCreate(): Boolean {\n    val application = context!!.applicationContext as Application\n    AppWatcher.manualInstall(application)\n    return true\n  }\n\n  override fun query(\n    uri: Uri,\n    strings: Array<String>?,\n    s: String?,\n    strings1: Array<String>?,\n    s1: String?\n  ): Cursor? {\n    return null\n  }\n\n  override fun getType(uri: Uri): String? {\n    return null\n  }\n\n  override fun insert(\n    uri: Uri,\n    contentValues: ContentValues?\n  ): Uri? {\n    return null\n  }\n\n  override fun delete(\n    uri: Uri,\n    s: String?,\n    strings: Array<String>?\n  ): Int {\n    return 0\n  }\n\n  override fun update(\n    uri: Uri,\n    contentValues: ContentValues?,\n    s: String?,\n    strings: Array<String>?\n  ): Int {\n    return 0\n  }\n}\n```\n\n我们可以看到，这个类是一个`ContentProvider`的子类，其query, insert等方法根本没有实际作用，有实际作用的只有`onCreate`方法，在这个方法中，执行了`AppWatcher`的install工作。\n\n这里我们就可以看出来，LeakCanary就是利用`ContentProvider`的`onCreate`方法自动执行的特性，来自动“安装”这个类库的。\n\n### 初始化\n\n通过追踪`AppWatcher.manualInstall(application)`这句代码，我们可以追踪到[**InternalLeakCanary.kt**](https://github.com/square/leakcanary/blob/main/leakcanary-android-core/src/main/java/leakcanary/internal/InternalLeakCanary.kt)的`install`方法，如下：\n\n```kotlin\nfun install(application: Application) {\n  checkMainThread()\n  if (this::application.isInitialized) {\n    return\n  }\n  InternalAppWatcher.application = application\n  if (isDebuggableBuild) {\n    SharkLog.logger = DefaultCanaryLog()\n  }\n\n  val configProvider = { AppWatcher.config }\n  ActivityDestroyWatcher.install(application, objectWatcher, configProvider)\n  FragmentDestroyWatcher.install(application, objectWatcher, configProvider)\n  onAppWatcherInstalled(application)\n}\n```\n\n我们可以看到，先后执行了`ActivityDestroyWatcher.install`,`FragmentDestroyWatcher.install`和`onAppWatcherInstalled(application)`方法。\n\n其中在`onAppWatcherInstalled`创建了LeakCanary图标的快捷方式，用于方便查看内存泄漏的路径信息。最终实现的具体过程可以查看[**InternalLeakCanary.kt**](https://github.com/square/leakcanary/blob/main/leakcanary-android-core/src/main/java/leakcanary/internal/InternalLeakCanary.kt)的`addDynamicShortcut`方法。\n\n其他的两段代码——`ActivityDestroyWatcher.install`和`FragmentDestroyWatcher.install`，分别对应着两个类——`ActivityDestroyWatcher`和`FragmentDestroyWatcher`。这两个类相对来说比较简单，主要工作就是执行了`application.registerActivityLifecycleCallbacks`这段代码，目的是为了监听每个Activity的onDestroy事件。这也是判断该Activity是否泄漏的开端。\n\n以`ActivityDestroyWatcher`为例，其ActivityLifecycleCallback中代码如下：\n\n```kotlin\nprivate val lifecycleCallbacks =\n    object : Application.ActivityLifecycleCallbacks by noOpDelegate() {\n      override fun onActivityDestroyed(activity: Activity) {\n        if (configProvider().watchActivities) {\n          objectWatcher.watch(\n              activity, \"${activity::class.java.name} received Activity#onDestroy() callback\"\n          )\n        }\n      }\n    }\n```\n\n我们可以看到，这其中，最终是`objectWatcher`来进行内存泄漏监控的。\n\n\n\n## 如何检测到内存泄漏的\n\n这里涉及到两个关键的类：**[`ObjectWatcher`](https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher/src/main/java/leakcanary/ObjectWatcher.kt)**和**[`KeyedWeakReference`](https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher/src/main/java/leakcanary/KeyedWeakReference.kt)**。\n\n`KeyedWeakReference`是`WeakReference`的子类，添加了额外的属性，代码十分简单，如下：\n\n```kotlin\nclass KeyedWeakReference(\n  referent: Any,\n  val key: String,\n  val description: String,\n  val watchUptimeMillis: Long,\n  referenceQueue: ReferenceQueue<Any>\n) : WeakReference<Any>(\n    referent, referenceQueue\n) {\n  /**\n   * Time at which the associated object ([referent]) was considered retained, or -1 if it hasn't\n   * been yet.\n   */\n  @Volatile\n  var retainedUptimeMillis = -1L\n\n  companion object {\n    @Volatile\n    @JvmStatic var heapDumpUptimeMillis = 0L\n  }\n}\n```\n\n接下来我们看`ObjectWatcher`中的`watchObject`方法。\n\n```kotlin\n  /**\n   * Watches the provided [watchedObject].\n   *\n   * @param description Describes why the object is watched.\n   */\n  @Synchronized fun watch(\n    watchedObject: Any,\n    description: String\n  ) {\n    if (!isEnabled()) {\n      return\n    }\n    removeWeaklyReachableObjects()\n    val key = UUID.randomUUID()\n        .toString()\n    val watchUptimeMillis = clock.uptimeMillis()\n    val reference =\n      KeyedWeakReference(watchedObject, key, description, watchUptimeMillis, queue)\n    SharkLog.d {\n      \"Watching \" +\n          (if (watchedObject is Class<*>) watchedObject.toString() else \"instance of ${watchedObject.javaClass.name}\") +\n          (if (description.isNotEmpty()) \" ($description)\" else \"\") +\n          \" with key $key\"\n    }\n\n    watchedObjects[key] = reference\n    checkRetainedExecutor.execute {\n      moveToRetained(key)\n    }\n  }\n```\n\n这里分为三步：\n\n1. 执行`removeWeaklyReachableObjects()`方法，这个方法之后讲到；\n2. 生成一个`KeyedWeakReference`对象，并将这个对象添加到`watchedObjects`去；\n3. 定时执行`moveToRetained`方法。\n\n- 我们先看第二步，生成`KeyedWeakReference`对象时候，传入了一个一个`ReferenceQueue`对象，这是检测对象是否被回收的关键。假如一个对象O，被弱引用WR持有的时候，同时这个弱引用WR在构造时候传入了一个`ReferenceQueue`对象Q，则这个对象O被回收时候，WR将会被添加到Q中去，这样，通过检测Q中有没有值，便可以知道O有没有被回收掉。这也就是第一步做的事。\n\n- 接下来我们查看`removeWeaklyReachableObjects`方法中做了什么。\n\n```kotlin\nprivate fun removeWeaklyReachableObjects() {\n  // WeakReferences are enqueued as soon as the object to which they point to becomes weakly\n  // reachable. This is before finalization or garbage collection has actually happened.\n  var ref: KeyedWeakReference?\n  do {\n    ref = queue.poll() as KeyedWeakReference?\n    if (ref != null) {\n      watchedObjects.remove(ref.key)\n    }\n  } while (ref != null)\n}\n```\n\n在这个方法中，从queue中取值，取出来ref，则说明被ref修饰的对象已经被回收了，则将这个弱引用ref从`watchedObjects`清除掉。\n\n- 接下来到了第三步，这一步实际上是一个定时5秒(LeakCanary默认)去将watchedObjects中残留的引用，移入到`retainedObjects`中去。我们来看其中代码：\n\n```kotlin\n@Synchronized private fun moveToRetained(key: String) {\n  removeWeaklyReachableObjects()\n  val retainedRef = watchedObjects[key]\n  if (retainedRef != null) {\n    retainedRef.retainedUptimeMillis = clock.uptimeMillis()\n    onObjectRetainedListeners.forEach { it.onObjectRetained() }\n  }\n}\n```\n\n执行这个任务的Executor实际实现在[**InternalAppWatcher.kt**](https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher-android/src/main/java/leakcanary/internal/InternalAppWatcher.kt)中，代码如下：\n\n```kotlin\nprivate val checkRetainedExecutor = Executor {\n  mainHandler.postDelayed(it, AppWatcher.config.watchDurationMillis)\n}\n```\n\n我们发现，在`moveToRetained`中，还是先执行了`removeWeaklyReachableObjects`这一方法。目的是再次清除已经被回收的对象。如果经过这一步，仍然有引用留在watchedObjects中，则可以认为，这些对象泄漏了。\n\n```kotlin\n/**\n   * Returns the objects that are currently considered retained. Useful for logging purposes.\n   * Be careful with those objects and release them ASAP as you may creating longer lived leaks\n   * then the one that are already there.\n   */\nval retainedObjects: List<Any>\n@Synchronized get() {\n  removeWeaklyReachableObjects()\n  val instances = mutableListOf<Any>()\n  for (weakReference in watchedObjects.values) {\n    if (weakReference.retainedUptimeMillis != -1L) {\n      val instance = weakReference.get()\n      if (instance != null) {\n        instances.add(instance)\n      }\n    }\n  }\n  return instances\n}\n```\n\n\n\n## 总结\n\n不要在发行版本中使用LeakCanary，因为一系列初始化动作，可能会导致应用启动较慢。如果要用，请使用LeakCanary-Object-Watcher，或者直接使用Buggly这样的成熟框架。","source":"_posts/2022-09-17-LeakCanary原理分析.md","raw":"---\nlayout: post\ntitle: LeakCanary原理分析\nauthor: boybeak\ncategory: 源码分析\ntags: Android\ndate: 2022-09-17 06:00:00\n---\n\n\n```groovy\ndependencies {\n  // debugImplementation because LeakCanary should only run in debug builds.\n  debugImplementation 'com.squareup.leakcanary:leakcanary-android:2.5'\n}\n```\n\n只需要这样简单配置，就能接入LeakCanary内存泄漏分析，到底是怎样做到的？\n\n我们将这个问题分成两个问题：\n\n1. 如何**自动**进行初始化的；\n2. 如何检测到内存泄漏的。\n\n\n\n## 如何自动进行初始化的\n\n这部分，我们可以分成两部分去理解——**自动**和**初始化**。\n\n### 自动\n\n这一切还要从`ActivityThread`说起。`ActivityThread`中，执行了一些应用启动的初始化工作，在`ActivityThread`源码中，我们可以看到其内部类`class H extends Handler`的`handleMessage`方法中，有很多与应用相关的一些基本操作，比如**BIND_APPLICATION**, **EXIT_APPLICATION**, **CREATE_SERVICE**, **BIND_SERVICE**等，其中需要我们关注的是**BIND_APPLICATION**。\n\n```java\npublic void handleMessage(Message msg) {\n            ....\n            switch (msg.what) {\n                case BIND_APPLICATION:\n                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, \"bindApplication\");\n                    AppBindData data = (AppBindData)msg.obj;\n                    handleBindApplication(data);\n                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);\n                    break;\n                ....\n            }\n  ....\n}\n```\n\n我们可以看到，其中调用了`handleBindApplication`方法。进入这个方法查看。\n\n```java\n@UnsupportedAppUsage\nprivate void handleBindApplication(AppBindData data) {\n  ....\n  Application app;\n  final StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites();\n  final StrictMode.ThreadPolicy writesAllowedPolicy = StrictMode.getThreadPolicy();\n  try {\n    // If the app is being launched for full backup or restore, bring it up in\n    // a restricted environment with the base application class.\n    app = data.info.makeApplication(data.restrictedBackupMode, null);\n    // Propagate autofill compat state\n    app.setAutofillOptions(data.autofillOptions);\n    // Propagate Content Capture options\n    app.setContentCaptureOptions(data.contentCaptureOptions);\n    mInitialApplication = app;\n    // don't bring up providers in restricted mode; they may depend on the\n    // app's custom Application class\n    if (!data.restrictedBackupMode) {\n      if (!ArrayUtils.isEmpty(data.providers)) {\n        installContentProviders(app, data.providers);\n      }\n    }\n    // Do this after providers, since instrumentation tests generally start their\n    // test thread at this point, and we don't want that racing.\n    try {\n      mInstrumentation.onCreate(data.instrumentationArgs);\n    }\n    catch (Exception e) {\n      throw new RuntimeException(\n        \"Exception thrown in onCreate() of \"\n        + data.instrumentationName + \": \" + e.toString(), e);\n    }\n    try {\n      mInstrumentation.callApplicationOnCreate(app);\n    } catch (Exception e) {\n      if (!mInstrumentation.onException(app, e)) {\n        throw new RuntimeException(\n          \"Unable to create application \" + app.getClass().getName()\n          + \": \" + e.toString(), e);\n      }\n    }\n  } finally {\n    // If the app targets < O-MR1, or doesn't change the thread policy\n    // during startup, clobber the policy to maintain behavior of b/36951662\n    if (data.appInfo.targetSdkVersion < Build.VERSION_CODES.O_MR1\n        || StrictMode.getThreadPolicy().equals(writesAllowedPolicy)) {\n      StrictMode.setThreadPolicy(savedPolicy);\n    }\n  }\n  ....\n}\n```\n\n从这个方法中，我们可以找到这样一段代码，需要重点关注的是，`ContentProvider`的初始化是先于`Application.onCreate`的，且是被`ActivityThread`**自动**执行的。\n\n接下来再看LeakCanary源码。找到[**AppWatcherInstaller.kt**](https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher-android/src/main/java/leakcanary/internal/AppWatcherInstaller.kt)这个类。\n\n```kotlin\n/**\n * Content providers are loaded before the application class is created. [AppWatcherInstaller] is\n * used to install [leakcanary.AppWatcher] on application start.\n */\ninternal sealed class AppWatcherInstaller : ContentProvider() {\n\n  /**\n   * [MainProcess] automatically sets up the LeakCanary code that runs in the main app process.\n   */\n  internal class MainProcess : AppWatcherInstaller()\n\n  /**\n   * When using the `leakcanary-android-process` artifact instead of `leakcanary-android`,\n   * [LeakCanaryProcess] automatically sets up the LeakCanary code\n   */\n  internal class LeakCanaryProcess : AppWatcherInstaller()\n\n  override fun onCreate(): Boolean {\n    val application = context!!.applicationContext as Application\n    AppWatcher.manualInstall(application)\n    return true\n  }\n\n  override fun query(\n    uri: Uri,\n    strings: Array<String>?,\n    s: String?,\n    strings1: Array<String>?,\n    s1: String?\n  ): Cursor? {\n    return null\n  }\n\n  override fun getType(uri: Uri): String? {\n    return null\n  }\n\n  override fun insert(\n    uri: Uri,\n    contentValues: ContentValues?\n  ): Uri? {\n    return null\n  }\n\n  override fun delete(\n    uri: Uri,\n    s: String?,\n    strings: Array<String>?\n  ): Int {\n    return 0\n  }\n\n  override fun update(\n    uri: Uri,\n    contentValues: ContentValues?,\n    s: String?,\n    strings: Array<String>?\n  ): Int {\n    return 0\n  }\n}\n```\n\n我们可以看到，这个类是一个`ContentProvider`的子类，其query, insert等方法根本没有实际作用，有实际作用的只有`onCreate`方法，在这个方法中，执行了`AppWatcher`的install工作。\n\n这里我们就可以看出来，LeakCanary就是利用`ContentProvider`的`onCreate`方法自动执行的特性，来自动“安装”这个类库的。\n\n### 初始化\n\n通过追踪`AppWatcher.manualInstall(application)`这句代码，我们可以追踪到[**InternalLeakCanary.kt**](https://github.com/square/leakcanary/blob/main/leakcanary-android-core/src/main/java/leakcanary/internal/InternalLeakCanary.kt)的`install`方法，如下：\n\n```kotlin\nfun install(application: Application) {\n  checkMainThread()\n  if (this::application.isInitialized) {\n    return\n  }\n  InternalAppWatcher.application = application\n  if (isDebuggableBuild) {\n    SharkLog.logger = DefaultCanaryLog()\n  }\n\n  val configProvider = { AppWatcher.config }\n  ActivityDestroyWatcher.install(application, objectWatcher, configProvider)\n  FragmentDestroyWatcher.install(application, objectWatcher, configProvider)\n  onAppWatcherInstalled(application)\n}\n```\n\n我们可以看到，先后执行了`ActivityDestroyWatcher.install`,`FragmentDestroyWatcher.install`和`onAppWatcherInstalled(application)`方法。\n\n其中在`onAppWatcherInstalled`创建了LeakCanary图标的快捷方式，用于方便查看内存泄漏的路径信息。最终实现的具体过程可以查看[**InternalLeakCanary.kt**](https://github.com/square/leakcanary/blob/main/leakcanary-android-core/src/main/java/leakcanary/internal/InternalLeakCanary.kt)的`addDynamicShortcut`方法。\n\n其他的两段代码——`ActivityDestroyWatcher.install`和`FragmentDestroyWatcher.install`，分别对应着两个类——`ActivityDestroyWatcher`和`FragmentDestroyWatcher`。这两个类相对来说比较简单，主要工作就是执行了`application.registerActivityLifecycleCallbacks`这段代码，目的是为了监听每个Activity的onDestroy事件。这也是判断该Activity是否泄漏的开端。\n\n以`ActivityDestroyWatcher`为例，其ActivityLifecycleCallback中代码如下：\n\n```kotlin\nprivate val lifecycleCallbacks =\n    object : Application.ActivityLifecycleCallbacks by noOpDelegate() {\n      override fun onActivityDestroyed(activity: Activity) {\n        if (configProvider().watchActivities) {\n          objectWatcher.watch(\n              activity, \"${activity::class.java.name} received Activity#onDestroy() callback\"\n          )\n        }\n      }\n    }\n```\n\n我们可以看到，这其中，最终是`objectWatcher`来进行内存泄漏监控的。\n\n\n\n## 如何检测到内存泄漏的\n\n这里涉及到两个关键的类：**[`ObjectWatcher`](https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher/src/main/java/leakcanary/ObjectWatcher.kt)**和**[`KeyedWeakReference`](https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher/src/main/java/leakcanary/KeyedWeakReference.kt)**。\n\n`KeyedWeakReference`是`WeakReference`的子类，添加了额外的属性，代码十分简单，如下：\n\n```kotlin\nclass KeyedWeakReference(\n  referent: Any,\n  val key: String,\n  val description: String,\n  val watchUptimeMillis: Long,\n  referenceQueue: ReferenceQueue<Any>\n) : WeakReference<Any>(\n    referent, referenceQueue\n) {\n  /**\n   * Time at which the associated object ([referent]) was considered retained, or -1 if it hasn't\n   * been yet.\n   */\n  @Volatile\n  var retainedUptimeMillis = -1L\n\n  companion object {\n    @Volatile\n    @JvmStatic var heapDumpUptimeMillis = 0L\n  }\n}\n```\n\n接下来我们看`ObjectWatcher`中的`watchObject`方法。\n\n```kotlin\n  /**\n   * Watches the provided [watchedObject].\n   *\n   * @param description Describes why the object is watched.\n   */\n  @Synchronized fun watch(\n    watchedObject: Any,\n    description: String\n  ) {\n    if (!isEnabled()) {\n      return\n    }\n    removeWeaklyReachableObjects()\n    val key = UUID.randomUUID()\n        .toString()\n    val watchUptimeMillis = clock.uptimeMillis()\n    val reference =\n      KeyedWeakReference(watchedObject, key, description, watchUptimeMillis, queue)\n    SharkLog.d {\n      \"Watching \" +\n          (if (watchedObject is Class<*>) watchedObject.toString() else \"instance of ${watchedObject.javaClass.name}\") +\n          (if (description.isNotEmpty()) \" ($description)\" else \"\") +\n          \" with key $key\"\n    }\n\n    watchedObjects[key] = reference\n    checkRetainedExecutor.execute {\n      moveToRetained(key)\n    }\n  }\n```\n\n这里分为三步：\n\n1. 执行`removeWeaklyReachableObjects()`方法，这个方法之后讲到；\n2. 生成一个`KeyedWeakReference`对象，并将这个对象添加到`watchedObjects`去；\n3. 定时执行`moveToRetained`方法。\n\n- 我们先看第二步，生成`KeyedWeakReference`对象时候，传入了一个一个`ReferenceQueue`对象，这是检测对象是否被回收的关键。假如一个对象O，被弱引用WR持有的时候，同时这个弱引用WR在构造时候传入了一个`ReferenceQueue`对象Q，则这个对象O被回收时候，WR将会被添加到Q中去，这样，通过检测Q中有没有值，便可以知道O有没有被回收掉。这也就是第一步做的事。\n\n- 接下来我们查看`removeWeaklyReachableObjects`方法中做了什么。\n\n```kotlin\nprivate fun removeWeaklyReachableObjects() {\n  // WeakReferences are enqueued as soon as the object to which they point to becomes weakly\n  // reachable. This is before finalization or garbage collection has actually happened.\n  var ref: KeyedWeakReference?\n  do {\n    ref = queue.poll() as KeyedWeakReference?\n    if (ref != null) {\n      watchedObjects.remove(ref.key)\n    }\n  } while (ref != null)\n}\n```\n\n在这个方法中，从queue中取值，取出来ref，则说明被ref修饰的对象已经被回收了，则将这个弱引用ref从`watchedObjects`清除掉。\n\n- 接下来到了第三步，这一步实际上是一个定时5秒(LeakCanary默认)去将watchedObjects中残留的引用，移入到`retainedObjects`中去。我们来看其中代码：\n\n```kotlin\n@Synchronized private fun moveToRetained(key: String) {\n  removeWeaklyReachableObjects()\n  val retainedRef = watchedObjects[key]\n  if (retainedRef != null) {\n    retainedRef.retainedUptimeMillis = clock.uptimeMillis()\n    onObjectRetainedListeners.forEach { it.onObjectRetained() }\n  }\n}\n```\n\n执行这个任务的Executor实际实现在[**InternalAppWatcher.kt**](https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher-android/src/main/java/leakcanary/internal/InternalAppWatcher.kt)中，代码如下：\n\n```kotlin\nprivate val checkRetainedExecutor = Executor {\n  mainHandler.postDelayed(it, AppWatcher.config.watchDurationMillis)\n}\n```\n\n我们发现，在`moveToRetained`中，还是先执行了`removeWeaklyReachableObjects`这一方法。目的是再次清除已经被回收的对象。如果经过这一步，仍然有引用留在watchedObjects中，则可以认为，这些对象泄漏了。\n\n```kotlin\n/**\n   * Returns the objects that are currently considered retained. Useful for logging purposes.\n   * Be careful with those objects and release them ASAP as you may creating longer lived leaks\n   * then the one that are already there.\n   */\nval retainedObjects: List<Any>\n@Synchronized get() {\n  removeWeaklyReachableObjects()\n  val instances = mutableListOf<Any>()\n  for (weakReference in watchedObjects.values) {\n    if (weakReference.retainedUptimeMillis != -1L) {\n      val instance = weakReference.get()\n      if (instance != null) {\n        instances.add(instance)\n      }\n    }\n  }\n  return instances\n}\n```\n\n\n\n## 总结\n\n不要在发行版本中使用LeakCanary，因为一系列初始化动作，可能会导致应用启动较慢。如果要用，请使用LeakCanary-Object-Watcher，或者直接使用Buggly这样的成熟框架。","slug":"2022-09-17-LeakCanary原理分析","published":1,"updated":"2024-11-13T13:39:45.949Z","_id":"cm1ltr0fx0007bji0e0sf7r88","comments":1,"photos":[],"content":"<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">dependencies <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// debugImplementation because LeakCanary should only run in debug builds.</span>\n  debugImplementation <span class=\"token string\">'com.squareup.leakcanary:leakcanary-android:2.5'</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>只需要这样简单配置，就能接入LeakCanary内存泄漏分析，到底是怎样做到的？</p>\n<p>我们将这个问题分成两个问题：</p>\n<ol>\n<li>如何<strong>自动</strong>进行初始化的；</li>\n<li>如何检测到内存泄漏的。</li>\n</ol>\n<h2 id=\"如何自动进行初始化的\"><a href=\"#如何自动进行初始化的\" class=\"headerlink\" title=\"如何自动进行初始化的\"></a>如何自动进行初始化的</h2><p>这部分，我们可以分成两部分去理解——<strong>自动</strong>和<strong>初始化</strong>。</p>\n<h3 id=\"自动\"><a href=\"#自动\" class=\"headerlink\" title=\"自动\"></a>自动</h3><p>这一切还要从<code>ActivityThread</code>说起。<code>ActivityThread</code>中，执行了一些应用启动的初始化工作，在<code>ActivityThread</code>源码中，我们可以看到其内部类<code>class H extends Handler</code>的<code>handleMessage</code>方法中，有很多与应用相关的一些基本操作，比如<strong>BIND_APPLICATION</strong>, <strong>EXIT_APPLICATION</strong>, <strong>CREATE_SERVICE</strong>, <strong>BIND_SERVICE</strong>等，其中需要我们关注的是<strong>BIND_APPLICATION</strong>。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n            <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>what<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token keyword\">case</span> <span class=\"token constant\">BIND_APPLICATION</span><span class=\"token operator\">:</span>\n                    <span class=\"token class-name\">Trace</span><span class=\"token punctuation\">.</span><span class=\"token function\">traceBegin</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Trace</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TRACE_TAG_ACTIVITY_MANAGER</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"bindApplication\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token class-name\">AppBindData</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">AppBindData</span><span class=\"token punctuation\">)</span>msg<span class=\"token punctuation\">.</span>obj<span class=\"token punctuation\">;</span>\n                    <span class=\"token function\">handleBindApplication</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token class-name\">Trace</span><span class=\"token punctuation\">.</span><span class=\"token function\">traceEnd</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Trace</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TRACE_TAG_ACTIVITY_MANAGER</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n            <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，其中调用了<code>handleBindApplication</code>方法。进入这个方法查看。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@UnsupportedAppUsage</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleBindApplication</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AppBindData</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token class-name\">Application</span> app<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">final</span> <span class=\"token class-name\">StrictMode<span class=\"token punctuation\">.</span>ThreadPolicy</span> savedPolicy <span class=\"token operator\">=</span> <span class=\"token class-name\">StrictMode</span><span class=\"token punctuation\">.</span><span class=\"token function\">allowThreadDiskWrites</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">final</span> <span class=\"token class-name\">StrictMode<span class=\"token punctuation\">.</span>ThreadPolicy</span> writesAllowedPolicy <span class=\"token operator\">=</span> <span class=\"token class-name\">StrictMode</span><span class=\"token punctuation\">.</span><span class=\"token function\">getThreadPolicy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// If the app is being launched for full backup or restore, bring it up in</span>\n    <span class=\"token comment\">// a restricted environment with the base application class.</span>\n    app <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">.</span><span class=\"token function\">makeApplication</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>restrictedBackupMode<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Propagate autofill compat state</span>\n    app<span class=\"token punctuation\">.</span><span class=\"token function\">setAutofillOptions</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>autofillOptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Propagate Content Capture options</span>\n    app<span class=\"token punctuation\">.</span><span class=\"token function\">setContentCaptureOptions</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>contentCaptureOptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mInitialApplication <span class=\"token operator\">=</span> app<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// don't bring up providers in restricted mode; they may depend on the</span>\n    <span class=\"token comment\">// app's custom Application class</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>data<span class=\"token punctuation\">.</span>restrictedBackupMode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token class-name\">ArrayUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>providers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">installContentProviders</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span>providers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// Do this after providers, since instrumentation tests generally start their</span>\n    <span class=\"token comment\">// test thread at this point, and we don't want that racing.</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n      mInstrumentation<span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>instrumentationArgs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"Exception thrown in onCreate() of \"</span>\n        <span class=\"token operator\">+</span> data<span class=\"token punctuation\">.</span>instrumentationName <span class=\"token operator\">+</span> <span class=\"token string\">\": \"</span> <span class=\"token operator\">+</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n      mInstrumentation<span class=\"token punctuation\">.</span><span class=\"token function\">callApplicationOnCreate</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mInstrumentation<span class=\"token punctuation\">.</span><span class=\"token function\">onException</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>\n          <span class=\"token string\">\"Unable to create application \"</span> <span class=\"token operator\">+</span> app<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token operator\">+</span> <span class=\"token string\">\": \"</span> <span class=\"token operator\">+</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// If the app targets &lt; O-MR1, or doesn't change the thread policy</span>\n    <span class=\"token comment\">// during startup, clobber the policy to maintain behavior of b/36951662</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>appInfo<span class=\"token punctuation\">.</span>targetSdkVersion <span class=\"token operator\">&lt;</span> <span class=\"token class-name\">Build</span><span class=\"token punctuation\">.</span><span class=\"token constant\">VERSION_CODES</span><span class=\"token punctuation\">.</span><span class=\"token constant\">O_MR1</span>\n        <span class=\"token operator\">||</span> <span class=\"token class-name\">StrictMode</span><span class=\"token punctuation\">.</span><span class=\"token function\">getThreadPolicy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>writesAllowedPolicy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token class-name\">StrictMode</span><span class=\"token punctuation\">.</span><span class=\"token function\">setThreadPolicy</span><span class=\"token punctuation\">(</span>savedPolicy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>从这个方法中，我们可以找到这样一段代码，需要重点关注的是，<code>ContentProvider</code>的初始化是先于<code>Application.onCreate</code>的，且是被<code>ActivityThread</code><strong>自动</strong>执行的。</p>\n<p>接下来再看LeakCanary源码。找到<a href=\"https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher-android/src/main/java/leakcanary/internal/AppWatcherInstaller.kt\"><strong>AppWatcherInstaller.kt</strong></a>这个类。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">/**\n * Content providers are loaded before the application class is created. [AppWatcherInstaller] is\n * used to install [leakcanary.AppWatcher] on application start.\n */</span>\n<span class=\"token keyword\">internal</span> <span class=\"token keyword\">sealed</span> <span class=\"token keyword\">class</span> AppWatcherInstaller <span class=\"token operator\">:</span> <span class=\"token function\">ContentProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\n  <span class=\"token comment\">/**\n   * [MainProcess] automatically sets up the LeakCanary code that runs in the main app process.\n   */</span>\n  <span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> MainProcess <span class=\"token operator\">:</span> <span class=\"token function\">AppWatcherInstaller</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">/**\n   * When using the `leakcanary-android-process` artifact instead of `leakcanary-android`,\n   * [LeakCanaryProcess] automatically sets up the LeakCanary code\n   */</span>\n  <span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> LeakCanaryProcess <span class=\"token operator\">:</span> <span class=\"token function\">AppWatcherInstaller</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Boolean <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">val</span> application <span class=\"token operator\">=</span> context<span class=\"token operator\">!!</span><span class=\"token punctuation\">.</span>applicationContext <span class=\"token keyword\">as</span> Application\n    AppWatcher<span class=\"token punctuation\">.</span><span class=\"token function\">manualInstall</span><span class=\"token punctuation\">(</span>application<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">query</span><span class=\"token punctuation\">(</span>\n    uri<span class=\"token operator\">:</span> Uri<span class=\"token punctuation\">,</span>\n    strings<span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span>\n    s<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span>\n    strings1<span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span>\n    s1<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Cursor<span class=\"token operator\">?</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">getType</span><span class=\"token punctuation\">(</span>uri<span class=\"token operator\">:</span> Uri<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> String<span class=\"token operator\">?</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">insert</span><span class=\"token punctuation\">(</span>\n    uri<span class=\"token operator\">:</span> Uri<span class=\"token punctuation\">,</span>\n    contentValues<span class=\"token operator\">:</span> ContentValues<span class=\"token operator\">?</span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Uri<span class=\"token operator\">?</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>\n    uri<span class=\"token operator\">:</span> Uri<span class=\"token punctuation\">,</span>\n    s<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span>\n    strings<span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token operator\">?</span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span>\n    uri<span class=\"token operator\">:</span> Uri<span class=\"token punctuation\">,</span>\n    contentValues<span class=\"token operator\">:</span> ContentValues<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span>\n    s<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span>\n    strings<span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token operator\">?</span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，这个类是一个<code>ContentProvider</code>的子类，其query, insert等方法根本没有实际作用，有实际作用的只有<code>onCreate</code>方法，在这个方法中，执行了<code>AppWatcher</code>的install工作。</p>\n<p>这里我们就可以看出来，LeakCanary就是利用<code>ContentProvider</code>的<code>onCreate</code>方法自动执行的特性，来自动“安装”这个类库的。</p>\n<h3 id=\"初始化\"><a href=\"#初始化\" class=\"headerlink\" title=\"初始化\"></a>初始化</h3><p>通过追踪<code>AppWatcher.manualInstall(application)</code>这句代码，我们可以追踪到<a href=\"https://github.com/square/leakcanary/blob/main/leakcanary-android-core/src/main/java/leakcanary/internal/InternalLeakCanary.kt\"><strong>InternalLeakCanary.kt</strong></a>的<code>install</code>方法，如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">install</span><span class=\"token punctuation\">(</span>application<span class=\"token operator\">:</span> Application<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">checkMainThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token operator\">::</span>application<span class=\"token punctuation\">.</span>isInitialized<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">&#125;</span>\n  InternalAppWatcher<span class=\"token punctuation\">.</span>application <span class=\"token operator\">=</span> application\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isDebuggableBuild<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    SharkLog<span class=\"token punctuation\">.</span>logger <span class=\"token operator\">=</span> <span class=\"token function\">DefaultCanaryLog</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">val</span> configProvider <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> AppWatcher<span class=\"token punctuation\">.</span>config <span class=\"token punctuation\">&#125;</span>\n  ActivityDestroyWatcher<span class=\"token punctuation\">.</span><span class=\"token function\">install</span><span class=\"token punctuation\">(</span>application<span class=\"token punctuation\">,</span> objectWatcher<span class=\"token punctuation\">,</span> configProvider<span class=\"token punctuation\">)</span>\n  FragmentDestroyWatcher<span class=\"token punctuation\">.</span><span class=\"token function\">install</span><span class=\"token punctuation\">(</span>application<span class=\"token punctuation\">,</span> objectWatcher<span class=\"token punctuation\">,</span> configProvider<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">onAppWatcherInstalled</span><span class=\"token punctuation\">(</span>application<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，先后执行了<code>ActivityDestroyWatcher.install</code>,<code>FragmentDestroyWatcher.install</code>和<code>onAppWatcherInstalled(application)</code>方法。</p>\n<p>其中在<code>onAppWatcherInstalled</code>创建了LeakCanary图标的快捷方式，用于方便查看内存泄漏的路径信息。最终实现的具体过程可以查看<a href=\"https://github.com/square/leakcanary/blob/main/leakcanary-android-core/src/main/java/leakcanary/internal/InternalLeakCanary.kt\"><strong>InternalLeakCanary.kt</strong></a>的<code>addDynamicShortcut</code>方法。</p>\n<p>其他的两段代码——<code>ActivityDestroyWatcher.install</code>和<code>FragmentDestroyWatcher.install</code>，分别对应着两个类——<code>ActivityDestroyWatcher</code>和<code>FragmentDestroyWatcher</code>。这两个类相对来说比较简单，主要工作就是执行了<code>application.registerActivityLifecycleCallbacks</code>这段代码，目的是为了监听每个Activity的onDestroy事件。这也是判断该Activity是否泄漏的开端。</p>\n<p>以<code>ActivityDestroyWatcher</code>为例，其ActivityLifecycleCallback中代码如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> lifecycleCallbacks <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> Application<span class=\"token punctuation\">.</span>ActivityLifecycleCallbacks <span class=\"token keyword\">by</span> <span class=\"token function\">noOpDelegate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onActivityDestroyed</span><span class=\"token punctuation\">(</span>activity<span class=\"token operator\">:</span> Activity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">configProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>watchActivities<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n          objectWatcher<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>\n              activity<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token expression\">activity<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">.</span>name</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\"> received Activity#onDestroy() callback\"</span></span>\n          <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，这其中，最终是<code>objectWatcher</code>来进行内存泄漏监控的。</p>\n<h2 id=\"如何检测到内存泄漏的\"><a href=\"#如何检测到内存泄漏的\" class=\"headerlink\" title=\"如何检测到内存泄漏的\"></a>如何检测到内存泄漏的</h2><p>这里涉及到两个关键的类：**<a href=\"https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher/src/main/java/leakcanary/ObjectWatcher.kt\"><code>ObjectWatcher</code></a><strong>和</strong><a href=\"https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher/src/main/java/leakcanary/KeyedWeakReference.kt\"><code>KeyedWeakReference</code></a>**。</p>\n<p><code>KeyedWeakReference</code>是<code>WeakReference</code>的子类，添加了额外的属性，代码十分简单，如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">KeyedWeakReference</span><span class=\"token punctuation\">(</span>\n  referent<span class=\"token operator\">:</span> Any<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">val</span> key<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">val</span> description<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">val</span> watchUptimeMillis<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">,</span>\n  referenceQueue<span class=\"token operator\">:</span> ReferenceQueue<span class=\"token operator\">&lt;</span>Any<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> WeakReference<span class=\"token operator\">&lt;</span>Any<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n    referent<span class=\"token punctuation\">,</span> referenceQueue\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">/**\n   * Time at which the associated object ([referent]) was considered retained, or -1 if it hasn't\n   * been yet.\n   */</span>\n  <span class=\"token annotation builtin\">@Volatile</span>\n  <span class=\"token keyword\">var</span> retainedUptimeMillis <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1L</span>\n\n  <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token annotation builtin\">@Volatile</span>\n    <span class=\"token annotation builtin\">@JvmStatic</span> <span class=\"token keyword\">var</span> heapDumpUptimeMillis <span class=\"token operator\">=</span> <span class=\"token number\">0L</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>接下来我们看<code>ObjectWatcher</code>中的<code>watchObject</code>方法。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">/**\n * Watches the provided [watchedObject].\n *\n * @param description Describes why the object is watched.\n */</span>\n<span class=\"token annotation builtin\">@Synchronized</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>\n  watchedObject<span class=\"token operator\">:</span> Any<span class=\"token punctuation\">,</span>\n  description<span class=\"token operator\">:</span> String\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token function\">removeWeaklyReachableObjects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> key <span class=\"token operator\">=</span> UUID<span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> watchUptimeMillis <span class=\"token operator\">=</span> clock<span class=\"token punctuation\">.</span><span class=\"token function\">uptimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> reference <span class=\"token operator\">=</span>\n    <span class=\"token function\">KeyedWeakReference</span><span class=\"token punctuation\">(</span>watchedObject<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> description<span class=\"token punctuation\">,</span> watchUptimeMillis<span class=\"token punctuation\">,</span> queue<span class=\"token punctuation\">)</span>\n  SharkLog<span class=\"token punctuation\">.</span><span class=\"token function\">d</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token string-literal singleline\"><span class=\"token string\">\"Watching \"</span></span> <span class=\"token operator\">+</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>watchedObject <span class=\"token keyword\">is</span> Class<span class=\"token operator\">&lt;</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> watchedObject<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"instance of </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token expression\">watchedObject<span class=\"token punctuation\">.</span>javaClass<span class=\"token punctuation\">.</span>name</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>description<span class=\"token punctuation\">.</span><span class=\"token function\">isNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\" (</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">description</span></span><span class=\"token string\">)\"</span></span> <span class=\"token keyword\">else</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>\n        <span class=\"token string-literal singleline\"><span class=\"token string\">\" with key </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">key</span></span><span class=\"token string\">\"</span></span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  watchedObjects<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> reference\n  checkRetainedExecutor<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token function\">moveToRetained</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里分为三步：</p>\n<ol>\n<li>执行<code>removeWeaklyReachableObjects()</code>方法，这个方法之后讲到；</li>\n<li>生成一个<code>KeyedWeakReference</code>对象，并将这个对象添加到<code>watchedObjects</code>去；</li>\n<li>定时执行<code>moveToRetained</code>方法。</li>\n</ol>\n<ul>\n<li><p>我们先看第二步，生成<code>KeyedWeakReference</code>对象时候，传入了一个一个<code>ReferenceQueue</code>对象，这是检测对象是否被回收的关键。假如一个对象O，被弱引用WR持有的时候，同时这个弱引用WR在构造时候传入了一个<code>ReferenceQueue</code>对象Q，则这个对象O被回收时候，WR将会被添加到Q中去，这样，通过检测Q中有没有值，便可以知道O有没有被回收掉。这也就是第一步做的事。</p>\n</li>\n<li><p>接下来我们查看<code>removeWeaklyReachableObjects</code>方法中做了什么。</p>\n</li>\n</ul>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">removeWeaklyReachableObjects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// WeakReferences are enqueued as soon as the object to which they point to becomes weakly</span>\n  <span class=\"token comment\">// reachable. This is before finalization or garbage collection has actually happened.</span>\n  <span class=\"token keyword\">var</span> ref<span class=\"token operator\">:</span> KeyedWeakReference<span class=\"token operator\">?</span>\n  <span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span>\n    ref <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">.</span><span class=\"token function\">poll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> KeyedWeakReference<span class=\"token operator\">?</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ref <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      watchedObjects<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>ref <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在这个方法中，从queue中取值，取出来ref，则说明被ref修饰的对象已经被回收了，则将这个弱引用ref从<code>watchedObjects</code>清除掉。</p>\n<ul>\n<li>接下来到了第三步，这一步实际上是一个定时5秒(LeakCanary默认)去将watchedObjects中残留的引用，移入到<code>retainedObjects</code>中去。我们来看其中代码：</li>\n</ul>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Synchronized</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">moveToRetained</span><span class=\"token punctuation\">(</span>key<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">removeWeaklyReachableObjects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> retainedRef <span class=\"token operator\">=</span> watchedObjects<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>retainedRef <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    retainedRef<span class=\"token punctuation\">.</span>retainedUptimeMillis <span class=\"token operator\">=</span> clock<span class=\"token punctuation\">.</span><span class=\"token function\">uptimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    onObjectRetainedListeners<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span> <span class=\"token punctuation\">&#123;</span> it<span class=\"token punctuation\">.</span><span class=\"token function\">onObjectRetained</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>执行这个任务的Executor实际实现在<a href=\"https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher-android/src/main/java/leakcanary/internal/InternalAppWatcher.kt\"><strong>InternalAppWatcher.kt</strong></a>中，代码如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> checkRetainedExecutor <span class=\"token operator\">=</span> Executor <span class=\"token punctuation\">&#123;</span>\n  mainHandler<span class=\"token punctuation\">.</span><span class=\"token function\">postDelayed</span><span class=\"token punctuation\">(</span>it<span class=\"token punctuation\">,</span> AppWatcher<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>watchDurationMillis<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们发现，在<code>moveToRetained</code>中，还是先执行了<code>removeWeaklyReachableObjects</code>这一方法。目的是再次清除已经被回收的对象。如果经过这一步，仍然有引用留在watchedObjects中，则可以认为，这些对象泄漏了。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">/**\n   * Returns the objects that are currently considered retained. Useful for logging purposes.\n   * Be careful with those objects and release them ASAP as you may creating longer lived leaks\n   * then the one that are already there.\n   */</span>\n<span class=\"token keyword\">val</span> retainedObjects<span class=\"token operator\">:</span> List<span class=\"token operator\">&lt;</span>Any<span class=\"token operator\">></span>\n<span class=\"token annotation builtin\">@Synchronized</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">removeWeaklyReachableObjects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> instances <span class=\"token operator\">=</span> mutableListOf<span class=\"token operator\">&lt;</span>Any<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>weakReference <span class=\"token keyword\">in</span> watchedObjects<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>weakReference<span class=\"token punctuation\">.</span>retainedUptimeMillis <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1L</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">val</span> instance <span class=\"token operator\">=</span> weakReference<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instance <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        instances<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">return</span> instances\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n\n\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>不要在发行版本中使用LeakCanary，因为一系列初始化动作，可能会导致应用启动较慢。如果要用，请使用LeakCanary-Object-Watcher，或者直接使用Buggly这样的成熟框架。</p>\n","excerpt":"","more":"<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">dependencies <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// debugImplementation because LeakCanary should only run in debug builds.</span>\n  debugImplementation <span class=\"token string\">'com.squareup.leakcanary:leakcanary-android:2.5'</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>只需要这样简单配置，就能接入LeakCanary内存泄漏分析，到底是怎样做到的？</p>\n<p>我们将这个问题分成两个问题：</p>\n<ol>\n<li>如何<strong>自动</strong>进行初始化的；</li>\n<li>如何检测到内存泄漏的。</li>\n</ol>\n<h2 id=\"如何自动进行初始化的\"><a href=\"#如何自动进行初始化的\" class=\"headerlink\" title=\"如何自动进行初始化的\"></a>如何自动进行初始化的</h2><p>这部分，我们可以分成两部分去理解——<strong>自动</strong>和<strong>初始化</strong>。</p>\n<h3 id=\"自动\"><a href=\"#自动\" class=\"headerlink\" title=\"自动\"></a>自动</h3><p>这一切还要从<code>ActivityThread</code>说起。<code>ActivityThread</code>中，执行了一些应用启动的初始化工作，在<code>ActivityThread</code>源码中，我们可以看到其内部类<code>class H extends Handler</code>的<code>handleMessage</code>方法中，有很多与应用相关的一些基本操作，比如<strong>BIND_APPLICATION</strong>, <strong>EXIT_APPLICATION</strong>, <strong>CREATE_SERVICE</strong>, <strong>BIND_SERVICE</strong>等，其中需要我们关注的是<strong>BIND_APPLICATION</strong>。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n            <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>what<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token keyword\">case</span> <span class=\"token constant\">BIND_APPLICATION</span><span class=\"token operator\">:</span>\n                    <span class=\"token class-name\">Trace</span><span class=\"token punctuation\">.</span><span class=\"token function\">traceBegin</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Trace</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TRACE_TAG_ACTIVITY_MANAGER</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"bindApplication\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token class-name\">AppBindData</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">AppBindData</span><span class=\"token punctuation\">)</span>msg<span class=\"token punctuation\">.</span>obj<span class=\"token punctuation\">;</span>\n                    <span class=\"token function\">handleBindApplication</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token class-name\">Trace</span><span class=\"token punctuation\">.</span><span class=\"token function\">traceEnd</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Trace</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TRACE_TAG_ACTIVITY_MANAGER</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n            <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，其中调用了<code>handleBindApplication</code>方法。进入这个方法查看。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@UnsupportedAppUsage</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleBindApplication</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AppBindData</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token class-name\">Application</span> app<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">final</span> <span class=\"token class-name\">StrictMode<span class=\"token punctuation\">.</span>ThreadPolicy</span> savedPolicy <span class=\"token operator\">=</span> <span class=\"token class-name\">StrictMode</span><span class=\"token punctuation\">.</span><span class=\"token function\">allowThreadDiskWrites</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">final</span> <span class=\"token class-name\">StrictMode<span class=\"token punctuation\">.</span>ThreadPolicy</span> writesAllowedPolicy <span class=\"token operator\">=</span> <span class=\"token class-name\">StrictMode</span><span class=\"token punctuation\">.</span><span class=\"token function\">getThreadPolicy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// If the app is being launched for full backup or restore, bring it up in</span>\n    <span class=\"token comment\">// a restricted environment with the base application class.</span>\n    app <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">.</span><span class=\"token function\">makeApplication</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>restrictedBackupMode<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Propagate autofill compat state</span>\n    app<span class=\"token punctuation\">.</span><span class=\"token function\">setAutofillOptions</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>autofillOptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Propagate Content Capture options</span>\n    app<span class=\"token punctuation\">.</span><span class=\"token function\">setContentCaptureOptions</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>contentCaptureOptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mInitialApplication <span class=\"token operator\">=</span> app<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// don't bring up providers in restricted mode; they may depend on the</span>\n    <span class=\"token comment\">// app's custom Application class</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>data<span class=\"token punctuation\">.</span>restrictedBackupMode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token class-name\">ArrayUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>providers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">installContentProviders</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span>providers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// Do this after providers, since instrumentation tests generally start their</span>\n    <span class=\"token comment\">// test thread at this point, and we don't want that racing.</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n      mInstrumentation<span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>instrumentationArgs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"Exception thrown in onCreate() of \"</span>\n        <span class=\"token operator\">+</span> data<span class=\"token punctuation\">.</span>instrumentationName <span class=\"token operator\">+</span> <span class=\"token string\">\": \"</span> <span class=\"token operator\">+</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n      mInstrumentation<span class=\"token punctuation\">.</span><span class=\"token function\">callApplicationOnCreate</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mInstrumentation<span class=\"token punctuation\">.</span><span class=\"token function\">onException</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>\n          <span class=\"token string\">\"Unable to create application \"</span> <span class=\"token operator\">+</span> app<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token operator\">+</span> <span class=\"token string\">\": \"</span> <span class=\"token operator\">+</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// If the app targets &lt; O-MR1, or doesn't change the thread policy</span>\n    <span class=\"token comment\">// during startup, clobber the policy to maintain behavior of b/36951662</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>appInfo<span class=\"token punctuation\">.</span>targetSdkVersion <span class=\"token operator\">&lt;</span> <span class=\"token class-name\">Build</span><span class=\"token punctuation\">.</span><span class=\"token constant\">VERSION_CODES</span><span class=\"token punctuation\">.</span><span class=\"token constant\">O_MR1</span>\n        <span class=\"token operator\">||</span> <span class=\"token class-name\">StrictMode</span><span class=\"token punctuation\">.</span><span class=\"token function\">getThreadPolicy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>writesAllowedPolicy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token class-name\">StrictMode</span><span class=\"token punctuation\">.</span><span class=\"token function\">setThreadPolicy</span><span class=\"token punctuation\">(</span>savedPolicy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>从这个方法中，我们可以找到这样一段代码，需要重点关注的是，<code>ContentProvider</code>的初始化是先于<code>Application.onCreate</code>的，且是被<code>ActivityThread</code><strong>自动</strong>执行的。</p>\n<p>接下来再看LeakCanary源码。找到<a href=\"https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher-android/src/main/java/leakcanary/internal/AppWatcherInstaller.kt\"><strong>AppWatcherInstaller.kt</strong></a>这个类。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">/**\n * Content providers are loaded before the application class is created. [AppWatcherInstaller] is\n * used to install [leakcanary.AppWatcher] on application start.\n */</span>\n<span class=\"token keyword\">internal</span> <span class=\"token keyword\">sealed</span> <span class=\"token keyword\">class</span> AppWatcherInstaller <span class=\"token operator\">:</span> <span class=\"token function\">ContentProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\n  <span class=\"token comment\">/**\n   * [MainProcess] automatically sets up the LeakCanary code that runs in the main app process.\n   */</span>\n  <span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> MainProcess <span class=\"token operator\">:</span> <span class=\"token function\">AppWatcherInstaller</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">/**\n   * When using the `leakcanary-android-process` artifact instead of `leakcanary-android`,\n   * [LeakCanaryProcess] automatically sets up the LeakCanary code\n   */</span>\n  <span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> LeakCanaryProcess <span class=\"token operator\">:</span> <span class=\"token function\">AppWatcherInstaller</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Boolean <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">val</span> application <span class=\"token operator\">=</span> context<span class=\"token operator\">!!</span><span class=\"token punctuation\">.</span>applicationContext <span class=\"token keyword\">as</span> Application\n    AppWatcher<span class=\"token punctuation\">.</span><span class=\"token function\">manualInstall</span><span class=\"token punctuation\">(</span>application<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">query</span><span class=\"token punctuation\">(</span>\n    uri<span class=\"token operator\">:</span> Uri<span class=\"token punctuation\">,</span>\n    strings<span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span>\n    s<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span>\n    strings1<span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span>\n    s1<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Cursor<span class=\"token operator\">?</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">getType</span><span class=\"token punctuation\">(</span>uri<span class=\"token operator\">:</span> Uri<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> String<span class=\"token operator\">?</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">insert</span><span class=\"token punctuation\">(</span>\n    uri<span class=\"token operator\">:</span> Uri<span class=\"token punctuation\">,</span>\n    contentValues<span class=\"token operator\">:</span> ContentValues<span class=\"token operator\">?</span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Uri<span class=\"token operator\">?</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>\n    uri<span class=\"token operator\">:</span> Uri<span class=\"token punctuation\">,</span>\n    s<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span>\n    strings<span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token operator\">?</span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span>\n    uri<span class=\"token operator\">:</span> Uri<span class=\"token punctuation\">,</span>\n    contentValues<span class=\"token operator\">:</span> ContentValues<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span>\n    s<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span>\n    strings<span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token operator\">?</span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，这个类是一个<code>ContentProvider</code>的子类，其query, insert等方法根本没有实际作用，有实际作用的只有<code>onCreate</code>方法，在这个方法中，执行了<code>AppWatcher</code>的install工作。</p>\n<p>这里我们就可以看出来，LeakCanary就是利用<code>ContentProvider</code>的<code>onCreate</code>方法自动执行的特性，来自动“安装”这个类库的。</p>\n<h3 id=\"初始化\"><a href=\"#初始化\" class=\"headerlink\" title=\"初始化\"></a>初始化</h3><p>通过追踪<code>AppWatcher.manualInstall(application)</code>这句代码，我们可以追踪到<a href=\"https://github.com/square/leakcanary/blob/main/leakcanary-android-core/src/main/java/leakcanary/internal/InternalLeakCanary.kt\"><strong>InternalLeakCanary.kt</strong></a>的<code>install</code>方法，如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">install</span><span class=\"token punctuation\">(</span>application<span class=\"token operator\">:</span> Application<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">checkMainThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token operator\">::</span>application<span class=\"token punctuation\">.</span>isInitialized<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">&#125;</span>\n  InternalAppWatcher<span class=\"token punctuation\">.</span>application <span class=\"token operator\">=</span> application\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isDebuggableBuild<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    SharkLog<span class=\"token punctuation\">.</span>logger <span class=\"token operator\">=</span> <span class=\"token function\">DefaultCanaryLog</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">val</span> configProvider <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> AppWatcher<span class=\"token punctuation\">.</span>config <span class=\"token punctuation\">&#125;</span>\n  ActivityDestroyWatcher<span class=\"token punctuation\">.</span><span class=\"token function\">install</span><span class=\"token punctuation\">(</span>application<span class=\"token punctuation\">,</span> objectWatcher<span class=\"token punctuation\">,</span> configProvider<span class=\"token punctuation\">)</span>\n  FragmentDestroyWatcher<span class=\"token punctuation\">.</span><span class=\"token function\">install</span><span class=\"token punctuation\">(</span>application<span class=\"token punctuation\">,</span> objectWatcher<span class=\"token punctuation\">,</span> configProvider<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">onAppWatcherInstalled</span><span class=\"token punctuation\">(</span>application<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，先后执行了<code>ActivityDestroyWatcher.install</code>,<code>FragmentDestroyWatcher.install</code>和<code>onAppWatcherInstalled(application)</code>方法。</p>\n<p>其中在<code>onAppWatcherInstalled</code>创建了LeakCanary图标的快捷方式，用于方便查看内存泄漏的路径信息。最终实现的具体过程可以查看<a href=\"https://github.com/square/leakcanary/blob/main/leakcanary-android-core/src/main/java/leakcanary/internal/InternalLeakCanary.kt\"><strong>InternalLeakCanary.kt</strong></a>的<code>addDynamicShortcut</code>方法。</p>\n<p>其他的两段代码——<code>ActivityDestroyWatcher.install</code>和<code>FragmentDestroyWatcher.install</code>，分别对应着两个类——<code>ActivityDestroyWatcher</code>和<code>FragmentDestroyWatcher</code>。这两个类相对来说比较简单，主要工作就是执行了<code>application.registerActivityLifecycleCallbacks</code>这段代码，目的是为了监听每个Activity的onDestroy事件。这也是判断该Activity是否泄漏的开端。</p>\n<p>以<code>ActivityDestroyWatcher</code>为例，其ActivityLifecycleCallback中代码如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> lifecycleCallbacks <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> Application<span class=\"token punctuation\">.</span>ActivityLifecycleCallbacks <span class=\"token keyword\">by</span> <span class=\"token function\">noOpDelegate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onActivityDestroyed</span><span class=\"token punctuation\">(</span>activity<span class=\"token operator\">:</span> Activity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">configProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>watchActivities<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n          objectWatcher<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>\n              activity<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token expression\">activity<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">.</span>name</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\"> received Activity#onDestroy() callback\"</span></span>\n          <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，这其中，最终是<code>objectWatcher</code>来进行内存泄漏监控的。</p>\n<h2 id=\"如何检测到内存泄漏的\"><a href=\"#如何检测到内存泄漏的\" class=\"headerlink\" title=\"如何检测到内存泄漏的\"></a>如何检测到内存泄漏的</h2><p>这里涉及到两个关键的类：**<a href=\"https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher/src/main/java/leakcanary/ObjectWatcher.kt\"><code>ObjectWatcher</code></a><strong>和</strong><a href=\"https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher/src/main/java/leakcanary/KeyedWeakReference.kt\"><code>KeyedWeakReference</code></a>**。</p>\n<p><code>KeyedWeakReference</code>是<code>WeakReference</code>的子类，添加了额外的属性，代码十分简单，如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">KeyedWeakReference</span><span class=\"token punctuation\">(</span>\n  referent<span class=\"token operator\">:</span> Any<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">val</span> key<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">val</span> description<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">val</span> watchUptimeMillis<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">,</span>\n  referenceQueue<span class=\"token operator\">:</span> ReferenceQueue<span class=\"token operator\">&lt;</span>Any<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> WeakReference<span class=\"token operator\">&lt;</span>Any<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n    referent<span class=\"token punctuation\">,</span> referenceQueue\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">/**\n   * Time at which the associated object ([referent]) was considered retained, or -1 if it hasn't\n   * been yet.\n   */</span>\n  <span class=\"token annotation builtin\">@Volatile</span>\n  <span class=\"token keyword\">var</span> retainedUptimeMillis <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1L</span>\n\n  <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token annotation builtin\">@Volatile</span>\n    <span class=\"token annotation builtin\">@JvmStatic</span> <span class=\"token keyword\">var</span> heapDumpUptimeMillis <span class=\"token operator\">=</span> <span class=\"token number\">0L</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>接下来我们看<code>ObjectWatcher</code>中的<code>watchObject</code>方法。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">/**\n * Watches the provided [watchedObject].\n *\n * @param description Describes why the object is watched.\n */</span>\n<span class=\"token annotation builtin\">@Synchronized</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>\n  watchedObject<span class=\"token operator\">:</span> Any<span class=\"token punctuation\">,</span>\n  description<span class=\"token operator\">:</span> String\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token function\">removeWeaklyReachableObjects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> key <span class=\"token operator\">=</span> UUID<span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> watchUptimeMillis <span class=\"token operator\">=</span> clock<span class=\"token punctuation\">.</span><span class=\"token function\">uptimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> reference <span class=\"token operator\">=</span>\n    <span class=\"token function\">KeyedWeakReference</span><span class=\"token punctuation\">(</span>watchedObject<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> description<span class=\"token punctuation\">,</span> watchUptimeMillis<span class=\"token punctuation\">,</span> queue<span class=\"token punctuation\">)</span>\n  SharkLog<span class=\"token punctuation\">.</span><span class=\"token function\">d</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token string-literal singleline\"><span class=\"token string\">\"Watching \"</span></span> <span class=\"token operator\">+</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>watchedObject <span class=\"token keyword\">is</span> Class<span class=\"token operator\">&lt;</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> watchedObject<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"instance of </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token expression\">watchedObject<span class=\"token punctuation\">.</span>javaClass<span class=\"token punctuation\">.</span>name</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>description<span class=\"token punctuation\">.</span><span class=\"token function\">isNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\" (</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">description</span></span><span class=\"token string\">)\"</span></span> <span class=\"token keyword\">else</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>\n        <span class=\"token string-literal singleline\"><span class=\"token string\">\" with key </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">key</span></span><span class=\"token string\">\"</span></span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  watchedObjects<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> reference\n  checkRetainedExecutor<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token function\">moveToRetained</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里分为三步：</p>\n<ol>\n<li>执行<code>removeWeaklyReachableObjects()</code>方法，这个方法之后讲到；</li>\n<li>生成一个<code>KeyedWeakReference</code>对象，并将这个对象添加到<code>watchedObjects</code>去；</li>\n<li>定时执行<code>moveToRetained</code>方法。</li>\n</ol>\n<ul>\n<li><p>我们先看第二步，生成<code>KeyedWeakReference</code>对象时候，传入了一个一个<code>ReferenceQueue</code>对象，这是检测对象是否被回收的关键。假如一个对象O，被弱引用WR持有的时候，同时这个弱引用WR在构造时候传入了一个<code>ReferenceQueue</code>对象Q，则这个对象O被回收时候，WR将会被添加到Q中去，这样，通过检测Q中有没有值，便可以知道O有没有被回收掉。这也就是第一步做的事。</p>\n</li>\n<li><p>接下来我们查看<code>removeWeaklyReachableObjects</code>方法中做了什么。</p>\n</li>\n</ul>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">removeWeaklyReachableObjects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// WeakReferences are enqueued as soon as the object to which they point to becomes weakly</span>\n  <span class=\"token comment\">// reachable. This is before finalization or garbage collection has actually happened.</span>\n  <span class=\"token keyword\">var</span> ref<span class=\"token operator\">:</span> KeyedWeakReference<span class=\"token operator\">?</span>\n  <span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span>\n    ref <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">.</span><span class=\"token function\">poll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> KeyedWeakReference<span class=\"token operator\">?</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ref <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      watchedObjects<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>ref <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在这个方法中，从queue中取值，取出来ref，则说明被ref修饰的对象已经被回收了，则将这个弱引用ref从<code>watchedObjects</code>清除掉。</p>\n<ul>\n<li>接下来到了第三步，这一步实际上是一个定时5秒(LeakCanary默认)去将watchedObjects中残留的引用，移入到<code>retainedObjects</code>中去。我们来看其中代码：</li>\n</ul>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Synchronized</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">moveToRetained</span><span class=\"token punctuation\">(</span>key<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">removeWeaklyReachableObjects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> retainedRef <span class=\"token operator\">=</span> watchedObjects<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>retainedRef <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    retainedRef<span class=\"token punctuation\">.</span>retainedUptimeMillis <span class=\"token operator\">=</span> clock<span class=\"token punctuation\">.</span><span class=\"token function\">uptimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    onObjectRetainedListeners<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span> <span class=\"token punctuation\">&#123;</span> it<span class=\"token punctuation\">.</span><span class=\"token function\">onObjectRetained</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>执行这个任务的Executor实际实现在<a href=\"https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher-android/src/main/java/leakcanary/internal/InternalAppWatcher.kt\"><strong>InternalAppWatcher.kt</strong></a>中，代码如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> checkRetainedExecutor <span class=\"token operator\">=</span> Executor <span class=\"token punctuation\">&#123;</span>\n  mainHandler<span class=\"token punctuation\">.</span><span class=\"token function\">postDelayed</span><span class=\"token punctuation\">(</span>it<span class=\"token punctuation\">,</span> AppWatcher<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>watchDurationMillis<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们发现，在<code>moveToRetained</code>中，还是先执行了<code>removeWeaklyReachableObjects</code>这一方法。目的是再次清除已经被回收的对象。如果经过这一步，仍然有引用留在watchedObjects中，则可以认为，这些对象泄漏了。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">/**\n   * Returns the objects that are currently considered retained. Useful for logging purposes.\n   * Be careful with those objects and release them ASAP as you may creating longer lived leaks\n   * then the one that are already there.\n   */</span>\n<span class=\"token keyword\">val</span> retainedObjects<span class=\"token operator\">:</span> List<span class=\"token operator\">&lt;</span>Any<span class=\"token operator\">></span>\n<span class=\"token annotation builtin\">@Synchronized</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">removeWeaklyReachableObjects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> instances <span class=\"token operator\">=</span> mutableListOf<span class=\"token operator\">&lt;</span>Any<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>weakReference <span class=\"token keyword\">in</span> watchedObjects<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>weakReference<span class=\"token punctuation\">.</span>retainedUptimeMillis <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1L</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">val</span> instance <span class=\"token operator\">=</span> weakReference<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instance <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        instances<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">return</span> instances\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n\n\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>不要在发行版本中使用LeakCanary，因为一系列初始化动作，可能会导致应用启动较慢。如果要用，请使用LeakCanary-Object-Watcher，或者直接使用Buggly这样的成熟框架。</p>\n"},{"layout":"post","title":"Glide源码分析与自我实现(三)——APT的使用与GIF的优化","author":"boybeak","date":"2022-09-16T19:00:00.000Z","_content":"\n\n项目Demo地址：[GifHelper](https://github.com/boybeak/GifHelper)\n\n**什么是APT？**\n\n**APT**是**Annotation Processing Tool**的简称，即**编译时注解处理器**。它是一个javac的工具，在编译时，通过注解，按照规则自动生成相关代码的工具。\n\n**APT与Glide什么关系？**\n\n我们通常通过在build.gradle加入这样一段代码来引入Glide库。\n\n```groovy\nrepositories {\n  google()\n  jcenter()\n}\n\ndependencies {\n  implementation 'com.github.bumptech.glide:glide:4.11.0'\n  annotationProcessor 'com.github.bumptech.glide:compiler:4.11.0'\n}\n```\n\n这里有一个`annotationProcessor`，这就是对Glide提供的APT进行引用。我们查看Glide的源码结构，可以看到一个名为*annotation*的文件夹，这里就是与APT有关的部分。\n\n![Glide Struct](/images/glide_struct.jpg)\n\n接下来我们先通过GIF优化，看一看Glide的APT能实现的神奇效果，在这之后，再来分析Glide是如何通过APT实现的。\n\n> **注意：**如果使用kotlin需要先加入`apply plugin: 'kotlin-kapt'`插件，并且将`annotationProcessor`改成`kapt`。\n\n## GIF优化\n\n**为什么要优化GIF？**\n\n有人可能会有疑问，Glide相比其他图片加载框架的优势之一，就是支持GIF，为什么还要做优化呢？\n\n先看两个截图来对比优化前后的CPU和内存使用情况。\n\n![优化前](/images/gif_before_optimization.png)\n\n![优化后](/images/gif_after_optimization.png)\n\n我们可以看出，优化后，CPU和内存状况都好了很多，那么我们是怎么做的呢？这就需要用到谷歌官方的两个库——[giflib](https://android.googlesource.com/platform/external/giflib/+/refs/heads/master)和[FrameSequence](https://android.googlesource.com/platform/frameworks/ex/+/refs/heads/master/framesequence/)，这两个库需要我们自己编译成.so文件，具体可以参考示例项目[GifHelper](https://github.com/boybeak/GifHelper)。\n\n我们查看GifHolder中的代码。\n\n```kotlin\nclass GifHolder(v: View) : AbsHolder<GifItem>(v) {\n\t...\n  private val gifIV = view<ImageView>(R.id.gifIV)\n  override fun onBind(item: GifItem, position: Int, absAdapter: AnyAdapter) {\n    if (item.useGifX) {\n      // 优化后的加载方式\n    \tGlideApp.with(itemView).asGifX().load(item.source()).into(gifIV)\n    } else {\n      // 优化前的加载方式\n      Glide.with(itemView).asGif().load(item.source()).into(gifIV)\n    }\n    ....\n  }\n}\n```\n\n我们可以看到，加载后有这样一条语句：`GlideApp.with(itemView).asGifX().load(item.source()).into(gifIV)`，也许你会懵逼，哪里有GlideApp？哪里有asGifX()方法？我引入Glide后怎么没有看到这两个东西？这就涉及到了APT的内容了。想要看Glide官方文档的可以看[这里](http://bumptech.github.io/glide/doc/configuration.html#glidemodule)。\n\n一切的起因，要从**@GlideModule**这个注解说起，我们打开demo中的MyAppGlideModule类，可以看到这个类有一个@GlideModule注解。\n\n```kotlin\n@GlideModule\nclass MyAppGlideModule : AppGlideModule() {\n  override fun registerComponents(context: Context, glide: Glide, registry: Registry) {\n    super.registerComponents(context, glide, registry)\n    registry.append(Registry.BUCKET_GIF, InputStream::class.java,\n                    FrameSequenceDrawable::class.java, GifDecoder(glide.bitmapPool))\n  }\n}\n```\n\n我们再点开这个注解的源码，如下：\n\n```java\n@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.CLASS)\npublic @interface GlideModule {\n  /**\n   * Returns the name of the class that will be used as a replacement for {@code\n   * com.bumptech.glide.Glide} in Applications that depend on Glide's generated code.\n   */\n  String glideName() default \"GlideApp\";\n}\n```\n\n我们现在看到“GlideApp”了，是glideName这个注解属性的默认值。我们来逐条分析一下这个注解类的相关信息：\n\n- `@Target(ElementType.TYPE)`：指明这个注解的作用对象——只对类生效；\n- `@Retention(RetentionPolicy.CLASS)`：指明了这个注解的作用阶段——编译时记录在class文件中；\n- `public @interface GlideModule`：这是一个注解接口，接口名**GlideModule**；\n- `String glideName() default \"GlideApp\"`：这个注解接口需要一个名为*glideName*的属性，属性默认值为“GlideApp”。\n\n>RetentionPolicy：\n>\n>- **SOURCE**：这样的注解会被编译器擦除，只在编码阶段生效，目的是为了提示开发者，比如**@IntDef**、**@StringDef**、**@Visibility**、**@NonNull**；\n>- **CLASS**：记录在class文件中，编译时对编译器可见，运行时对VM不可见，这是RetentionPolicy的默认值，比如**@NotNull**;\n>- **RUNTIME**：记录在class文件中，在运行时需要反射获取其属性值，比如**@Column**。\n\n就是这个**@GlideModule**属性，为我们生成了GlideApp类，这其中的生成过程，我们稍后再说，先把Gif优化的流程说完。\n\n添加**@GlideModule**后，再次编译看，是否有了GlideApp这个类了。\n\n我们再来看*MyAppGlideModule*中的代码，`registry.append`方法，这是为Glide添加一种解析类型。\n\n```java\n/* \n* @param bucket 要添加的类型id.\n* @param dataClass 要从什么数据进行解析。 ({@link java.io.InputStream}, {@link\n*     java.io.FileDescriptor} etc).\n* @param resourceClass 要解析成什么数据。 ({@link android.graphics.Bitmap},\n*     {@link com.bumptech.glide.load.resource.gif.GifDrawable} etc).\n* @param decoder 用什么解码器进行解析 {@link ResourceDecoder}。\n*/\n@NonNull\npublic <Data, TResource> Registry append(\n  @NonNull String bucket,\n  @NonNull Class<Data> dataClass,\n  @NonNull Class<TResource> resourceClass,\n  @NonNull ResourceDecoder<Data, TResource> decoder) {\n  decoderRegistry.append(bucket, decoder, dataClass, resourceClass);\n  return this;\n}\n```\n\n\n\n接下来就要引入谷歌官方的两个类库了，[FrameSquence](https://android.googlesource.com/platform/frameworks/ex/+/android-9.0.0_r16/framesequence/)和[giflib](https://android.googlesource.com/platform/external/giflib/+/android-9.0.0_r16)。大家可以根据需要下载对应版本的库，不过这两个库的版本最好要对应。\n\n下载后需要编译，项目结构参考[GifHelper](https://github.com/boybeak/GifHelper)项目中的framesequence/src/main/jni文件夹。注意，需要将FrameSequence_gif.h中的include部分进行修改。\n\n```diff\n- #include \"config.h\"\n- #include \"gif_lib.h\"\n改成\n+ #include \"giflib/config.h\"\n+ #include \"giflib/gif_lib.h\"\n```\n\n然后执行ndk-build，则会在jni同级的目录下，生成一个libs文件夹，.so文件就在这里。\n\n接下来需要去自定义GifDecoder.java了，直接上代码：\n\n```kotlin\nclass GifDecoder(private val bmpPool: BitmapPool) : ResourceDecoder<InputStream, FrameSequenceDrawable> {\n\n    private val headerParser = DefaultImageHeaderParser()\n\n    override fun handles(source: InputStream, options: Options): Boolean {\n        return !(options.get(GifOptions.DISABLE_ANIMATION) ?: true)\n            && headerParser.getType(source) == ImageHeaderParser.ImageType.GIF\n    }\n\n    override fun decode(\n        source: InputStream,\n        width: Int,\n        height: Int,\n        options: Options\n    ): Resource<FrameSequenceDrawable>? {\n        val fs = FrameSequence.decodeStream(source)\n        val fsd = FrameSequenceDrawable(fs, object : FrameSequenceDrawable.BitmapProvider {\n            override fun acquireBitmap(minWidth: Int, minHeight: Int): Bitmap {\n                return bmpPool.get(minWidth, minHeight, Bitmap.Config.ARGB_8888)\n            }\n\n            override fun releaseBitmap(bitmap: Bitmap?) {\n                bmpPool.put(bitmap)\n            }\n        })\n        return GifResource(fsd)\n    }\n}\n```\n\n这个类里只需要实现两个方法：`handles`和`decode`：\n\n- handles：能否解析该输入源，能则返回true；\n- decode：如果handles返回true，则执行此方法，返回一个Resource对象包裹住目标类型对象。\n\n我们通过Glide自带的*ImageHeaderParser*来检测该输入流是否是gif图像的输入流，如果是且可以执行动画，则进行decode操作。\n\n我们着重看decode方法，这里需要重点看的是，在构建*FrameSequenceDrawable*时候，传入了一个*BitmapProvider*对象，这就是提高Gif效率的关键，在这个*BitmapProvider*里面，我们通过BitmapPool，去寻找可用尺寸的Bitmap，通过**池化**的方式，减小了内存开销，增加里Bitmap利用率。\n\n接下来看，如何添加`asGifX`方法。我们都知道，传统的Glide调用方式如下图：\n\n`Glide.with(itemView).asGif().load(item.source()).into(gifIV)`\n\n```mermaid\ngraph LR;\nA[Glide] -->|\"with(xxx)\"| B[RequestManager] -->|\"asGif\"| C[RequestBuilder];\n```\n\n而新的方式却不同，如下图：\n\n`GlideApp.with(itemView).asGifX().load(item.source()).into(gifIV)`\n\n```mermaid\ngraph LR;\nA[GlideApp] -->|\"with(xxx)\"| B[GlideRequests]  -->|asGifX| C[GlideRequest];\n```\n\n这其中的*GlideRequest*和*GlideRequest*，同样都是生成的类，其中GlideRequests继承自RequestManager，GlideRequest继承自RequestBuilder。\n\n这两个类的生成，同样是**@GlideModule**的作用，但是`asGifX`这个方法是什么时候定义的呢？我们去查看`asGifX`这个方法的代码：\n\n```java\n/**\n* @see GifExtension#asGifX(RequestBuilder)\n*/\n@NonNull\n@CheckResult\npublic GlideRequest<FrameSequenceDrawable> asGifX() {\n  return (GlideRequest<FrameSequenceDrawable>) GifExtension.asGifX(this.as(FrameSequenceDrawable.class));\n}\n```\n\n我们看到实际上这个类的具体实现，是依靠GifExtension类，我们去看这个类的代码：\n\n```java\n@GlideExtension\npublic class GifExtension {\n    @NonNull\n    @GlideType(FrameSequenceDrawable.class)\n    public static RequestBuilder<FrameSequenceDrawable> asGifX(RequestBuilder<FrameSequenceDrawable> requestBuilder) {\n        return requestBuilder.apply(RequestOptions\n                .decodeTypeOf(FrameSequenceDrawable.class)\n                .lock());\n    }\n    private GifExtension(){}\n}\n```\n\n这个类需要我们自己实现，并且需要标记**@GlideExtension**注解，又是注解的功劳。\n\n到此为止，Gif优化的主流程就全部讲完了，接下来就要看这两个注解——**@GlideModule**和**@GlideExtension**到底做了什么？\n\n\n\n## @GlideModule和@GlideExtension\n\n源码在Glide项目的annotation/compiler内，这种APT项目的入口文件标记在src/main/resources/META-INF/gradle内，这其中有一个incremental.annotation.processors文件，我们查看其内容：\n\n```\ncom.bumptech.glide.annotation.compiler.GlideAnnotationProcessor,aggregating\n```\n\n可以得知，程序入口在GlideAnnotationProcessor这个类，查看这个类的源码，我只提取了关键部分：\n\n```java\npublic final class GlideAnnotationProcessor extends AbstractProcessor {\n  ...\n  private LibraryModuleProcessor libraryModuleProcessor;\n  private AppModuleProcessor appModuleProcessor;\n  private boolean isGeneratedAppGlideModuleWritten;\n  private ExtensionProcessor extensionProcessor;\n  ...\n  @Override\n  public Set<String> getSupportedAnnotationTypes() {\n    Set<String> result = new HashSet<>();\n    result.addAll(libraryModuleProcessor.getSupportedAnnotationTypes());\n    result.addAll(extensionProcessor.getSupportedAnnotationTypes());\n    return result;\n  }\n  @Override\n  public boolean process(Set<? extends TypeElement> set, RoundEnvironment env) {\n    processorUtil.process();\n    boolean newModulesWritten = libraryModuleProcessor.processModules(env);\n    boolean newExtensionWritten = extensionProcessor.processExtensions(env);\n    appModuleProcessor.processModules(set, env);\n\n    if (newExtensionWritten || newModulesWritten) {\n      if (isGeneratedAppGlideModuleWritten) {\n        throw new IllegalStateException(\"Cannot process annotations after writing AppGlideModule\");\n      }\n      return false;\n    }\n\n    if (!isGeneratedAppGlideModuleWritten) {\n      isGeneratedAppGlideModuleWritten = appModuleProcessor.maybeWriteAppModule();\n    }\n    return false;\n  }\n}\n```\n\n- `getSupportedAnnotationTypes`方法中标记了，支持哪些注解的解析，其中`libraryModuleProcessor.getSupportedAnnotationTypes()`中返回了**@GlideModule**，`extensionProcessor.getSupportedAnnotationTypes()`中返回了**@GlideExtension**。\n- process方法中开始了对注解的处理。\n\n注解的处理，需要你对[**javapoet**](https://github.com/square/javapoet)有一点点了解，如果暂时不想去了解，你只需要知道，这个类库是通过字符串和占位符来生成Java代码的工具类库，因为接下来的生成代码工作，Glide就是通过这个类库来实现的。\n\n具体的生成过程不再赘述，从入口类*GlideAnnotationProcessor*追踪下去，就能看到。\n\n\n\n## 为什么优化能提高效率？\n\nGlide默认Gif加载方案，是通过GifDrawable来实现的，而GifDrawable是通过GifFrameLoader来加载帧数据的。具体代码分析可以看参考文章，我这里简单来说一下原因：\n\n- 默认方案是串行执行的，比如在加载显示第N帧，这一帧显示完毕，再去解析第N+1帧，当播放第N+1帧的时间窗口到了以后，如果已经解析完毕，则能正常显示，如果不能解析完毕，则会卡顿了；\n- GifFrameLoader内部是用了一个mainLooper的handler来进行流程控制，具体可以看GifFrameLoader里的代码，这种方式本身在时间上就不是准时的，与应用内其他各种系统共享mainLooper，如果其他事件执行占用时间较长，也会影响这里的效率了。\n\n我们再来说说优化方案，优化的原因也简单说一下：\n\n- 优化方案是**并行+双缓冲**执行的，在显示第N帧的BitmapA同时，会有一个后台线程在解析第N+1帧的BitmapB，当需要显示第N+1帧BitmapB的时候，两帧的Bitmap交换，BitmapA则进入后台线程去解析第N+2帧了；\n- 在native去解析数据，效率更高；\n- 通过BitmapPool提高了内存利用率。\n\n借用参考文章里的一张图\n\n![Gif](/images/gif.webp)\n\n## 参考文章\n\n[Glide加载Gif的卡顿优化思路分析](https://juejin.im/post/6854573219425288199)","source":"_posts/2022-09-17-Glide源码分析与自我实现3.md","raw":"---\nlayout: post\ntitle: Glide源码分析与自我实现(三)——APT的使用与GIF的优化\nauthor: boybeak\ncategory: 源码分析\ntags: Android\ndate: 2022-09-17 03:00:00\n---\n\n\n项目Demo地址：[GifHelper](https://github.com/boybeak/GifHelper)\n\n**什么是APT？**\n\n**APT**是**Annotation Processing Tool**的简称，即**编译时注解处理器**。它是一个javac的工具，在编译时，通过注解，按照规则自动生成相关代码的工具。\n\n**APT与Glide什么关系？**\n\n我们通常通过在build.gradle加入这样一段代码来引入Glide库。\n\n```groovy\nrepositories {\n  google()\n  jcenter()\n}\n\ndependencies {\n  implementation 'com.github.bumptech.glide:glide:4.11.0'\n  annotationProcessor 'com.github.bumptech.glide:compiler:4.11.0'\n}\n```\n\n这里有一个`annotationProcessor`，这就是对Glide提供的APT进行引用。我们查看Glide的源码结构，可以看到一个名为*annotation*的文件夹，这里就是与APT有关的部分。\n\n![Glide Struct](/images/glide_struct.jpg)\n\n接下来我们先通过GIF优化，看一看Glide的APT能实现的神奇效果，在这之后，再来分析Glide是如何通过APT实现的。\n\n> **注意：**如果使用kotlin需要先加入`apply plugin: 'kotlin-kapt'`插件，并且将`annotationProcessor`改成`kapt`。\n\n## GIF优化\n\n**为什么要优化GIF？**\n\n有人可能会有疑问，Glide相比其他图片加载框架的优势之一，就是支持GIF，为什么还要做优化呢？\n\n先看两个截图来对比优化前后的CPU和内存使用情况。\n\n![优化前](/images/gif_before_optimization.png)\n\n![优化后](/images/gif_after_optimization.png)\n\n我们可以看出，优化后，CPU和内存状况都好了很多，那么我们是怎么做的呢？这就需要用到谷歌官方的两个库——[giflib](https://android.googlesource.com/platform/external/giflib/+/refs/heads/master)和[FrameSequence](https://android.googlesource.com/platform/frameworks/ex/+/refs/heads/master/framesequence/)，这两个库需要我们自己编译成.so文件，具体可以参考示例项目[GifHelper](https://github.com/boybeak/GifHelper)。\n\n我们查看GifHolder中的代码。\n\n```kotlin\nclass GifHolder(v: View) : AbsHolder<GifItem>(v) {\n\t...\n  private val gifIV = view<ImageView>(R.id.gifIV)\n  override fun onBind(item: GifItem, position: Int, absAdapter: AnyAdapter) {\n    if (item.useGifX) {\n      // 优化后的加载方式\n    \tGlideApp.with(itemView).asGifX().load(item.source()).into(gifIV)\n    } else {\n      // 优化前的加载方式\n      Glide.with(itemView).asGif().load(item.source()).into(gifIV)\n    }\n    ....\n  }\n}\n```\n\n我们可以看到，加载后有这样一条语句：`GlideApp.with(itemView).asGifX().load(item.source()).into(gifIV)`，也许你会懵逼，哪里有GlideApp？哪里有asGifX()方法？我引入Glide后怎么没有看到这两个东西？这就涉及到了APT的内容了。想要看Glide官方文档的可以看[这里](http://bumptech.github.io/glide/doc/configuration.html#glidemodule)。\n\n一切的起因，要从**@GlideModule**这个注解说起，我们打开demo中的MyAppGlideModule类，可以看到这个类有一个@GlideModule注解。\n\n```kotlin\n@GlideModule\nclass MyAppGlideModule : AppGlideModule() {\n  override fun registerComponents(context: Context, glide: Glide, registry: Registry) {\n    super.registerComponents(context, glide, registry)\n    registry.append(Registry.BUCKET_GIF, InputStream::class.java,\n                    FrameSequenceDrawable::class.java, GifDecoder(glide.bitmapPool))\n  }\n}\n```\n\n我们再点开这个注解的源码，如下：\n\n```java\n@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.CLASS)\npublic @interface GlideModule {\n  /**\n   * Returns the name of the class that will be used as a replacement for {@code\n   * com.bumptech.glide.Glide} in Applications that depend on Glide's generated code.\n   */\n  String glideName() default \"GlideApp\";\n}\n```\n\n我们现在看到“GlideApp”了，是glideName这个注解属性的默认值。我们来逐条分析一下这个注解类的相关信息：\n\n- `@Target(ElementType.TYPE)`：指明这个注解的作用对象——只对类生效；\n- `@Retention(RetentionPolicy.CLASS)`：指明了这个注解的作用阶段——编译时记录在class文件中；\n- `public @interface GlideModule`：这是一个注解接口，接口名**GlideModule**；\n- `String glideName() default \"GlideApp\"`：这个注解接口需要一个名为*glideName*的属性，属性默认值为“GlideApp”。\n\n>RetentionPolicy：\n>\n>- **SOURCE**：这样的注解会被编译器擦除，只在编码阶段生效，目的是为了提示开发者，比如**@IntDef**、**@StringDef**、**@Visibility**、**@NonNull**；\n>- **CLASS**：记录在class文件中，编译时对编译器可见，运行时对VM不可见，这是RetentionPolicy的默认值，比如**@NotNull**;\n>- **RUNTIME**：记录在class文件中，在运行时需要反射获取其属性值，比如**@Column**。\n\n就是这个**@GlideModule**属性，为我们生成了GlideApp类，这其中的生成过程，我们稍后再说，先把Gif优化的流程说完。\n\n添加**@GlideModule**后，再次编译看，是否有了GlideApp这个类了。\n\n我们再来看*MyAppGlideModule*中的代码，`registry.append`方法，这是为Glide添加一种解析类型。\n\n```java\n/* \n* @param bucket 要添加的类型id.\n* @param dataClass 要从什么数据进行解析。 ({@link java.io.InputStream}, {@link\n*     java.io.FileDescriptor} etc).\n* @param resourceClass 要解析成什么数据。 ({@link android.graphics.Bitmap},\n*     {@link com.bumptech.glide.load.resource.gif.GifDrawable} etc).\n* @param decoder 用什么解码器进行解析 {@link ResourceDecoder}。\n*/\n@NonNull\npublic <Data, TResource> Registry append(\n  @NonNull String bucket,\n  @NonNull Class<Data> dataClass,\n  @NonNull Class<TResource> resourceClass,\n  @NonNull ResourceDecoder<Data, TResource> decoder) {\n  decoderRegistry.append(bucket, decoder, dataClass, resourceClass);\n  return this;\n}\n```\n\n\n\n接下来就要引入谷歌官方的两个类库了，[FrameSquence](https://android.googlesource.com/platform/frameworks/ex/+/android-9.0.0_r16/framesequence/)和[giflib](https://android.googlesource.com/platform/external/giflib/+/android-9.0.0_r16)。大家可以根据需要下载对应版本的库，不过这两个库的版本最好要对应。\n\n下载后需要编译，项目结构参考[GifHelper](https://github.com/boybeak/GifHelper)项目中的framesequence/src/main/jni文件夹。注意，需要将FrameSequence_gif.h中的include部分进行修改。\n\n```diff\n- #include \"config.h\"\n- #include \"gif_lib.h\"\n改成\n+ #include \"giflib/config.h\"\n+ #include \"giflib/gif_lib.h\"\n```\n\n然后执行ndk-build，则会在jni同级的目录下，生成一个libs文件夹，.so文件就在这里。\n\n接下来需要去自定义GifDecoder.java了，直接上代码：\n\n```kotlin\nclass GifDecoder(private val bmpPool: BitmapPool) : ResourceDecoder<InputStream, FrameSequenceDrawable> {\n\n    private val headerParser = DefaultImageHeaderParser()\n\n    override fun handles(source: InputStream, options: Options): Boolean {\n        return !(options.get(GifOptions.DISABLE_ANIMATION) ?: true)\n            && headerParser.getType(source) == ImageHeaderParser.ImageType.GIF\n    }\n\n    override fun decode(\n        source: InputStream,\n        width: Int,\n        height: Int,\n        options: Options\n    ): Resource<FrameSequenceDrawable>? {\n        val fs = FrameSequence.decodeStream(source)\n        val fsd = FrameSequenceDrawable(fs, object : FrameSequenceDrawable.BitmapProvider {\n            override fun acquireBitmap(minWidth: Int, minHeight: Int): Bitmap {\n                return bmpPool.get(minWidth, minHeight, Bitmap.Config.ARGB_8888)\n            }\n\n            override fun releaseBitmap(bitmap: Bitmap?) {\n                bmpPool.put(bitmap)\n            }\n        })\n        return GifResource(fsd)\n    }\n}\n```\n\n这个类里只需要实现两个方法：`handles`和`decode`：\n\n- handles：能否解析该输入源，能则返回true；\n- decode：如果handles返回true，则执行此方法，返回一个Resource对象包裹住目标类型对象。\n\n我们通过Glide自带的*ImageHeaderParser*来检测该输入流是否是gif图像的输入流，如果是且可以执行动画，则进行decode操作。\n\n我们着重看decode方法，这里需要重点看的是，在构建*FrameSequenceDrawable*时候，传入了一个*BitmapProvider*对象，这就是提高Gif效率的关键，在这个*BitmapProvider*里面，我们通过BitmapPool，去寻找可用尺寸的Bitmap，通过**池化**的方式，减小了内存开销，增加里Bitmap利用率。\n\n接下来看，如何添加`asGifX`方法。我们都知道，传统的Glide调用方式如下图：\n\n`Glide.with(itemView).asGif().load(item.source()).into(gifIV)`\n\n```mermaid\ngraph LR;\nA[Glide] -->|\"with(xxx)\"| B[RequestManager] -->|\"asGif\"| C[RequestBuilder];\n```\n\n而新的方式却不同，如下图：\n\n`GlideApp.with(itemView).asGifX().load(item.source()).into(gifIV)`\n\n```mermaid\ngraph LR;\nA[GlideApp] -->|\"with(xxx)\"| B[GlideRequests]  -->|asGifX| C[GlideRequest];\n```\n\n这其中的*GlideRequest*和*GlideRequest*，同样都是生成的类，其中GlideRequests继承自RequestManager，GlideRequest继承自RequestBuilder。\n\n这两个类的生成，同样是**@GlideModule**的作用，但是`asGifX`这个方法是什么时候定义的呢？我们去查看`asGifX`这个方法的代码：\n\n```java\n/**\n* @see GifExtension#asGifX(RequestBuilder)\n*/\n@NonNull\n@CheckResult\npublic GlideRequest<FrameSequenceDrawable> asGifX() {\n  return (GlideRequest<FrameSequenceDrawable>) GifExtension.asGifX(this.as(FrameSequenceDrawable.class));\n}\n```\n\n我们看到实际上这个类的具体实现，是依靠GifExtension类，我们去看这个类的代码：\n\n```java\n@GlideExtension\npublic class GifExtension {\n    @NonNull\n    @GlideType(FrameSequenceDrawable.class)\n    public static RequestBuilder<FrameSequenceDrawable> asGifX(RequestBuilder<FrameSequenceDrawable> requestBuilder) {\n        return requestBuilder.apply(RequestOptions\n                .decodeTypeOf(FrameSequenceDrawable.class)\n                .lock());\n    }\n    private GifExtension(){}\n}\n```\n\n这个类需要我们自己实现，并且需要标记**@GlideExtension**注解，又是注解的功劳。\n\n到此为止，Gif优化的主流程就全部讲完了，接下来就要看这两个注解——**@GlideModule**和**@GlideExtension**到底做了什么？\n\n\n\n## @GlideModule和@GlideExtension\n\n源码在Glide项目的annotation/compiler内，这种APT项目的入口文件标记在src/main/resources/META-INF/gradle内，这其中有一个incremental.annotation.processors文件，我们查看其内容：\n\n```\ncom.bumptech.glide.annotation.compiler.GlideAnnotationProcessor,aggregating\n```\n\n可以得知，程序入口在GlideAnnotationProcessor这个类，查看这个类的源码，我只提取了关键部分：\n\n```java\npublic final class GlideAnnotationProcessor extends AbstractProcessor {\n  ...\n  private LibraryModuleProcessor libraryModuleProcessor;\n  private AppModuleProcessor appModuleProcessor;\n  private boolean isGeneratedAppGlideModuleWritten;\n  private ExtensionProcessor extensionProcessor;\n  ...\n  @Override\n  public Set<String> getSupportedAnnotationTypes() {\n    Set<String> result = new HashSet<>();\n    result.addAll(libraryModuleProcessor.getSupportedAnnotationTypes());\n    result.addAll(extensionProcessor.getSupportedAnnotationTypes());\n    return result;\n  }\n  @Override\n  public boolean process(Set<? extends TypeElement> set, RoundEnvironment env) {\n    processorUtil.process();\n    boolean newModulesWritten = libraryModuleProcessor.processModules(env);\n    boolean newExtensionWritten = extensionProcessor.processExtensions(env);\n    appModuleProcessor.processModules(set, env);\n\n    if (newExtensionWritten || newModulesWritten) {\n      if (isGeneratedAppGlideModuleWritten) {\n        throw new IllegalStateException(\"Cannot process annotations after writing AppGlideModule\");\n      }\n      return false;\n    }\n\n    if (!isGeneratedAppGlideModuleWritten) {\n      isGeneratedAppGlideModuleWritten = appModuleProcessor.maybeWriteAppModule();\n    }\n    return false;\n  }\n}\n```\n\n- `getSupportedAnnotationTypes`方法中标记了，支持哪些注解的解析，其中`libraryModuleProcessor.getSupportedAnnotationTypes()`中返回了**@GlideModule**，`extensionProcessor.getSupportedAnnotationTypes()`中返回了**@GlideExtension**。\n- process方法中开始了对注解的处理。\n\n注解的处理，需要你对[**javapoet**](https://github.com/square/javapoet)有一点点了解，如果暂时不想去了解，你只需要知道，这个类库是通过字符串和占位符来生成Java代码的工具类库，因为接下来的生成代码工作，Glide就是通过这个类库来实现的。\n\n具体的生成过程不再赘述，从入口类*GlideAnnotationProcessor*追踪下去，就能看到。\n\n\n\n## 为什么优化能提高效率？\n\nGlide默认Gif加载方案，是通过GifDrawable来实现的，而GifDrawable是通过GifFrameLoader来加载帧数据的。具体代码分析可以看参考文章，我这里简单来说一下原因：\n\n- 默认方案是串行执行的，比如在加载显示第N帧，这一帧显示完毕，再去解析第N+1帧，当播放第N+1帧的时间窗口到了以后，如果已经解析完毕，则能正常显示，如果不能解析完毕，则会卡顿了；\n- GifFrameLoader内部是用了一个mainLooper的handler来进行流程控制，具体可以看GifFrameLoader里的代码，这种方式本身在时间上就不是准时的，与应用内其他各种系统共享mainLooper，如果其他事件执行占用时间较长，也会影响这里的效率了。\n\n我们再来说说优化方案，优化的原因也简单说一下：\n\n- 优化方案是**并行+双缓冲**执行的，在显示第N帧的BitmapA同时，会有一个后台线程在解析第N+1帧的BitmapB，当需要显示第N+1帧BitmapB的时候，两帧的Bitmap交换，BitmapA则进入后台线程去解析第N+2帧了；\n- 在native去解析数据，效率更高；\n- 通过BitmapPool提高了内存利用率。\n\n借用参考文章里的一张图\n\n![Gif](/images/gif.webp)\n\n## 参考文章\n\n[Glide加载Gif的卡顿优化思路分析](https://juejin.im/post/6854573219425288199)","slug":"2022-09-17-Glide源码分析与自我实现3","published":1,"updated":"2024-11-13T13:39:20.779Z","_id":"cm1ltr0fy000bbji0bbpg5es7","comments":1,"photos":["/images/glide_struct.jpg","/images/gif_before_optimization.png","/images/gif_after_optimization.png","/images/gif.webp"],"content":"<p>项目Demo地址：<a href=\"https://github.com/boybeak/GifHelper\">GifHelper</a></p>\n<p><strong>什么是APT？</strong></p>\n<p><strong>APT</strong>是<strong>Annotation Processing Tool</strong>的简称，即<strong>编译时注解处理器</strong>。它是一个javac的工具，在编译时，通过注解，按照规则自动生成相关代码的工具。</p>\n<p><strong>APT与Glide什么关系？</strong></p>\n<p>我们通常通过在build.gradle加入这样一段代码来引入Glide库。</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">repositories <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">google</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">jcenter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\ndependencies <span class=\"token punctuation\">&#123;</span>\n  implementation <span class=\"token string\">'com.github.bumptech.glide:glide:4.11.0'</span>\n  annotationProcessor <span class=\"token string\">'com.github.bumptech.glide:compiler:4.11.0'</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里有一个<code>annotationProcessor</code>，这就是对Glide提供的APT进行引用。我们查看Glide的源码结构，可以看到一个名为<em>annotation</em>的文件夹，这里就是与APT有关的部分。</p>\n<p><img src=\"/images/glide_struct.jpg\" alt=\"Glide Struct\"></p>\n<p>接下来我们先通过GIF优化，看一看Glide的APT能实现的神奇效果，在这之后，再来分析Glide是如何通过APT实现的。</p>\n<blockquote>\n<p><strong>注意：</strong>如果使用kotlin需要先加入<code>apply plugin: &#39;kotlin-kapt&#39;</code>插件，并且将<code>annotationProcessor</code>改成<code>kapt</code>。</p>\n</blockquote>\n<h2 id=\"GIF优化\"><a href=\"#GIF优化\" class=\"headerlink\" title=\"GIF优化\"></a>GIF优化</h2><p><strong>为什么要优化GIF？</strong></p>\n<p>有人可能会有疑问，Glide相比其他图片加载框架的优势之一，就是支持GIF，为什么还要做优化呢？</p>\n<p>先看两个截图来对比优化前后的CPU和内存使用情况。</p>\n<p><img src=\"/images/gif_before_optimization.png\" alt=\"优化前\"></p>\n<p><img src=\"/images/gif_after_optimization.png\" alt=\"优化后\"></p>\n<p>我们可以看出，优化后，CPU和内存状况都好了很多，那么我们是怎么做的呢？这就需要用到谷歌官方的两个库——<a href=\"https://android.googlesource.com/platform/external/giflib/+/refs/heads/master\">giflib</a>和<a href=\"https://android.googlesource.com/platform/frameworks/ex/+/refs/heads/master/framesequence/\">FrameSequence</a>，这两个库需要我们自己编译成.so文件，具体可以参考示例项目<a href=\"https://github.com/boybeak/GifHelper\">GifHelper</a>。</p>\n<p>我们查看GifHolder中的代码。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">GifHolder</span><span class=\"token punctuation\">(</span>v<span class=\"token operator\">:</span> View<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> AbsHolder<span class=\"token operator\">&lt;</span>GifItem<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> gifIV <span class=\"token operator\">=</span> view<span class=\"token operator\">&lt;</span>ImageView<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>R<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">.</span>gifIV<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onBind</span><span class=\"token punctuation\">(</span>item<span class=\"token operator\">:</span> GifItem<span class=\"token punctuation\">,</span> position<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> absAdapter<span class=\"token operator\">:</span> AnyAdapter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span>useGifX<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token comment\">// 优化后的加载方式</span>\n    \tGlideApp<span class=\"token punctuation\">.</span><span class=\"token function\">with</span><span class=\"token punctuation\">(</span>itemView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">asGifX</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span><span class=\"token function\">source</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span>gifIV<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token comment\">// 优化前的加载方式</span>\n      Glide<span class=\"token punctuation\">.</span><span class=\"token function\">with</span><span class=\"token punctuation\">(</span>itemView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">asGif</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span><span class=\"token function\">source</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span>gifIV<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token operator\">..</span><span class=\"token operator\">..</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，加载后有这样一条语句：<code>GlideApp.with(itemView).asGifX().load(item.source()).into(gifIV)</code>，也许你会懵逼，哪里有GlideApp？哪里有asGifX()方法？我引入Glide后怎么没有看到这两个东西？这就涉及到了APT的内容了。想要看Glide官方文档的可以看<a href=\"http://bumptech.github.io/glide/doc/configuration.html#glidemodule\">这里</a>。</p>\n<p>一切的起因，要从**@GlideModule**这个注解说起，我们打开demo中的MyAppGlideModule类，可以看到这个类有一个@GlideModule注解。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@GlideModule</span>\n<span class=\"token keyword\">class</span> MyAppGlideModule <span class=\"token operator\">:</span> <span class=\"token function\">AppGlideModule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">registerComponents</span><span class=\"token punctuation\">(</span>context<span class=\"token operator\">:</span> Context<span class=\"token punctuation\">,</span> glide<span class=\"token operator\">:</span> Glide<span class=\"token punctuation\">,</span> registry<span class=\"token operator\">:</span> Registry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">registerComponents</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> glide<span class=\"token punctuation\">,</span> registry<span class=\"token punctuation\">)</span>\n    registry<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>Registry<span class=\"token punctuation\">.</span>BUCKET_GIF<span class=\"token punctuation\">,</span> InputStream<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">,</span>\n                    FrameSequenceDrawable<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">,</span> <span class=\"token function\">GifDecoder</span><span class=\"token punctuation\">(</span>glide<span class=\"token punctuation\">.</span>bitmapPool<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们再点开这个注解的源码，如下：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Target</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ElementType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TYPE</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Retention</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RetentionPolicy</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CLASS</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token annotation punctuation\">@interface</span> <span class=\"token class-name\">GlideModule</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">/**\n   * Returns the name of the class that will be used as a replacement for &#123;@code\n   * com.bumptech.glide.Glide&#125; in Applications that depend on Glide's generated code.\n   */</span>\n  <span class=\"token class-name\">String</span> <span class=\"token function\">glideName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">default</span> <span class=\"token string\">\"GlideApp\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们现在看到“GlideApp”了，是glideName这个注解属性的默认值。我们来逐条分析一下这个注解类的相关信息：</p>\n<ul>\n<li><code>@Target(ElementType.TYPE)</code>：指明这个注解的作用对象——只对类生效；</li>\n<li><code>@Retention(RetentionPolicy.CLASS)</code>：指明了这个注解的作用阶段——编译时记录在class文件中；</li>\n<li><code>public @interface GlideModule</code>：这是一个注解接口，接口名<strong>GlideModule</strong>；</li>\n<li><code>String glideName() default &quot;GlideApp&quot;</code>：这个注解接口需要一个名为<em>glideName</em>的属性，属性默认值为“GlideApp”。</li>\n</ul>\n<blockquote>\n<p>RetentionPolicy：</p>\n<ul>\n<li><strong>SOURCE</strong>：这样的注解会被编译器擦除，只在编码阶段生效，目的是为了提示开发者，比如**@IntDef<strong>、</strong>@StringDef<strong>、</strong>@Visibility<strong>、</strong>@NonNull**；</li>\n<li><strong>CLASS</strong>：记录在class文件中，编译时对编译器可见，运行时对VM不可见，这是RetentionPolicy的默认值，比如**@NotNull**;</li>\n<li><strong>RUNTIME</strong>：记录在class文件中，在运行时需要反射获取其属性值，比如**@Column**。</li>\n</ul>\n</blockquote>\n<p>就是这个**@GlideModule**属性，为我们生成了GlideApp类，这其中的生成过程，我们稍后再说，先把Gif优化的流程说完。</p>\n<p>添加**@GlideModule**后，再次编译看，是否有了GlideApp这个类了。</p>\n<p>我们再来看<em>MyAppGlideModule</em>中的代码，<code>registry.append</code>方法，这是为Glide添加一种解析类型。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">/* \n* @param bucket 要添加的类型id.\n* @param dataClass 要从什么数据进行解析。 (&#123;@link java.io.InputStream&#125;, &#123;@link\n*     java.io.FileDescriptor&#125; etc).\n* @param resourceClass 要解析成什么数据。 (&#123;@link android.graphics.Bitmap&#125;,\n*     &#123;@link com.bumptech.glide.load.resource.gif.GifDrawable&#125; etc).\n* @param decoder 用什么解码器进行解析 &#123;@link ResourceDecoder&#125;。\n*/</span>\n<span class=\"token annotation punctuation\">@NonNull</span>\n<span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Data</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TResource</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">Registry</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>\n  <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">String</span> bucket<span class=\"token punctuation\">,</span>\n  <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Data</span><span class=\"token punctuation\">></span></span> dataClass<span class=\"token punctuation\">,</span>\n  <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TResource</span><span class=\"token punctuation\">></span></span> resourceClass<span class=\"token punctuation\">,</span>\n  <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">ResourceDecoder</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Data</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TResource</span><span class=\"token punctuation\">></span></span> decoder<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  decoderRegistry<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">,</span> decoder<span class=\"token punctuation\">,</span> dataClass<span class=\"token punctuation\">,</span> resourceClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n\n\n<p>接下来就要引入谷歌官方的两个类库了，<a href=\"https://android.googlesource.com/platform/frameworks/ex/+/android-9.0.0_r16/framesequence/\">FrameSquence</a>和<a href=\"https://android.googlesource.com/platform/external/giflib/+/android-9.0.0_r16\">giflib</a>。大家可以根据需要下载对应版本的库，不过这两个库的版本最好要对应。</p>\n<p>下载后需要编译，项目结构参考<a href=\"https://github.com/boybeak/GifHelper\">GifHelper</a>项目中的framesequence&#x2F;src&#x2F;main&#x2F;jni文件夹。注意，需要将FrameSequence_gif.h中的include部分进行修改。</p>\n<pre class=\"language-diff\" data-language=\"diff\"><code class=\"language-diff\"><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span><span class=\"token line\"> #include \"config.h\"\n</span><span class=\"token prefix deleted\">-</span><span class=\"token line\"> #include \"gif_lib.h\"\n</span></span>改成\n<span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\"> #include \"giflib/config.h\"\n</span><span class=\"token prefix inserted\">+</span><span class=\"token line\"> #include \"giflib/gif_lib.h\"</span></span></code></pre>\n\n<p>然后执行ndk-build，则会在jni同级的目录下，生成一个libs文件夹，.so文件就在这里。</p>\n<p>接下来需要去自定义GifDecoder.java了，直接上代码：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">GifDecoder</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> bmpPool<span class=\"token operator\">:</span> BitmapPool<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> ResourceDecoder<span class=\"token operator\">&lt;</span>InputStream<span class=\"token punctuation\">,</span> FrameSequenceDrawable<span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> headerParser <span class=\"token operator\">=</span> <span class=\"token function\">DefaultImageHeaderParser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">handles</span><span class=\"token punctuation\">(</span>source<span class=\"token operator\">:</span> InputStream<span class=\"token punctuation\">,</span> options<span class=\"token operator\">:</span> Options<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Boolean <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>GifOptions<span class=\"token punctuation\">.</span>DISABLE_ANIMATION<span class=\"token punctuation\">)</span> <span class=\"token operator\">?:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">&amp;&amp;</span> headerParser<span class=\"token punctuation\">.</span><span class=\"token function\">getType</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> ImageHeaderParser<span class=\"token punctuation\">.</span>ImageType<span class=\"token punctuation\">.</span>GIF\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>\n        source<span class=\"token operator\">:</span> InputStream<span class=\"token punctuation\">,</span>\n        width<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        height<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        options<span class=\"token operator\">:</span> Options\n    <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Resource<span class=\"token operator\">&lt;</span>FrameSequenceDrawable<span class=\"token operator\">></span><span class=\"token operator\">?</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">val</span> fs <span class=\"token operator\">=</span> FrameSequence<span class=\"token punctuation\">.</span><span class=\"token function\">decodeStream</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> fsd <span class=\"token operator\">=</span> <span class=\"token function\">FrameSequenceDrawable</span><span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">,</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> FrameSequenceDrawable<span class=\"token punctuation\">.</span><span class=\"token function\">BitmapProvider</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">acquireBitmap</span><span class=\"token punctuation\">(</span>minWidth<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> minHeight<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Bitmap <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token keyword\">return</span> bmpPool<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>minWidth<span class=\"token punctuation\">,</span> minHeight<span class=\"token punctuation\">,</span> Bitmap<span class=\"token punctuation\">.</span>Config<span class=\"token punctuation\">.</span>ARGB_8888<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#125;</span>\n\n            <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">releaseBitmap</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">:</span> Bitmap<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                bmpPool<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">GifResource</span><span class=\"token punctuation\">(</span>fsd<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这个类里只需要实现两个方法：<code>handles</code>和<code>decode</code>：</p>\n<ul>\n<li>handles：能否解析该输入源，能则返回true；</li>\n<li>decode：如果handles返回true，则执行此方法，返回一个Resource对象包裹住目标类型对象。</li>\n</ul>\n<p>我们通过Glide自带的<em>ImageHeaderParser</em>来检测该输入流是否是gif图像的输入流，如果是且可以执行动画，则进行decode操作。</p>\n<p>我们着重看decode方法，这里需要重点看的是，在构建<em>FrameSequenceDrawable</em>时候，传入了一个<em>BitmapProvider</em>对象，这就是提高Gif效率的关键，在这个<em>BitmapProvider</em>里面，我们通过BitmapPool，去寻找可用尺寸的Bitmap，通过<strong>池化</strong>的方式，减小了内存开销，增加里Bitmap利用率。</p>\n<p>接下来看，如何添加<code>asGifX</code>方法。我们都知道，传统的Glide调用方式如下图：</p>\n<p><code>Glide.with(itemView).asGif().load(item.source()).into(gifIV)</code></p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> LR<span class=\"token punctuation\">;</span>\nA<span class=\"token text string\">[Glide]</span> <span class=\"token arrow operator\">--></span><span class=\"token label property\">|\"with(xxx)\"|</span> B<span class=\"token text string\">[RequestManager]</span> <span class=\"token arrow operator\">--></span><span class=\"token label property\">|\"asGif\"|</span> C<span class=\"token text string\">[RequestBuilder]</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>而新的方式却不同，如下图：</p>\n<p><code>GlideApp.with(itemView).asGifX().load(item.source()).into(gifIV)</code></p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> LR<span class=\"token punctuation\">;</span>\nA<span class=\"token text string\">[GlideApp]</span> <span class=\"token arrow operator\">--></span><span class=\"token label property\">|\"with(xxx)\"|</span> B<span class=\"token text string\">[GlideRequests]</span>  <span class=\"token arrow operator\">--></span><span class=\"token label property\">|asGifX|</span> C<span class=\"token text string\">[GlideRequest]</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>这其中的<em>GlideRequest</em>和<em>GlideRequest</em>，同样都是生成的类，其中GlideRequests继承自RequestManager，GlideRequest继承自RequestBuilder。</p>\n<p>这两个类的生成，同样是**@GlideModule**的作用，但是<code>asGifX</code>这个方法是什么时候定义的呢？我们去查看<code>asGifX</code>这个方法的代码：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">/**\n* @see GifExtension#asGifX(RequestBuilder)\n*/</span>\n<span class=\"token annotation punctuation\">@NonNull</span>\n<span class=\"token annotation punctuation\">@CheckResult</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">GlideRequest</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">FrameSequenceDrawable</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">asGifX</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">GlideRequest</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">FrameSequenceDrawable</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">GifExtension</span><span class=\"token punctuation\">.</span><span class=\"token function\">asGifX</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">as</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">FrameSequenceDrawable</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们看到实际上这个类的具体实现，是依靠GifExtension类，我们去看这个类的代码：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@GlideExtension</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GifExtension</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token annotation punctuation\">@NonNull</span>\n    <span class=\"token annotation punctuation\">@GlideType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">FrameSequenceDrawable</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">RequestBuilder</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">FrameSequenceDrawable</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">asGifX</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RequestBuilder</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">FrameSequenceDrawable</span><span class=\"token punctuation\">></span></span> requestBuilder<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> requestBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RequestOptions</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">decodeTypeOf</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">FrameSequenceDrawable</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">GifExtension</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这个类需要我们自己实现，并且需要标记**@GlideExtension**注解，又是注解的功劳。</p>\n<p>到此为止，Gif优化的主流程就全部讲完了，接下来就要看这两个注解——**@GlideModule<strong>和</strong>@GlideExtension**到底做了什么？</p>\n<h2 id=\"GlideModule和-GlideExtension\"><a href=\"#GlideModule和-GlideExtension\" class=\"headerlink\" title=\"@GlideModule和@GlideExtension\"></a>@GlideModule和@GlideExtension</h2><p>源码在Glide项目的annotation&#x2F;compiler内，这种APT项目的入口文件标记在src&#x2F;main&#x2F;resources&#x2F;META-INF&#x2F;gradle内，这其中有一个incremental.annotation.processors文件，我们查看其内容：</p>\n<pre class=\"language-none\"><code class=\"language-none\">com.bumptech.glide.annotation.compiler.GlideAnnotationProcessor,aggregating</code></pre>\n\n<p>可以得知，程序入口在GlideAnnotationProcessor这个类，查看这个类的源码，我只提取了关键部分：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GlideAnnotationProcessor</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractProcessor</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">LibraryModuleProcessor</span> libraryModuleProcessor<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">AppModuleProcessor</span> appModuleProcessor<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> isGeneratedAppGlideModuleWritten<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">ExtensionProcessor</span> extensionProcessor<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getSupportedAnnotationTypes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    result<span class=\"token punctuation\">.</span><span class=\"token function\">addAll</span><span class=\"token punctuation\">(</span>libraryModuleProcessor<span class=\"token punctuation\">.</span><span class=\"token function\">getSupportedAnnotationTypes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    result<span class=\"token punctuation\">.</span><span class=\"token function\">addAll</span><span class=\"token punctuation\">(</span>extensionProcessor<span class=\"token punctuation\">.</span><span class=\"token function\">getSupportedAnnotationTypes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">TypeElement</span><span class=\"token punctuation\">></span></span> set<span class=\"token punctuation\">,</span> <span class=\"token class-name\">RoundEnvironment</span> env<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    processorUtil<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">boolean</span> newModulesWritten <span class=\"token operator\">=</span> libraryModuleProcessor<span class=\"token punctuation\">.</span><span class=\"token function\">processModules</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">boolean</span> newExtensionWritten <span class=\"token operator\">=</span> extensionProcessor<span class=\"token punctuation\">.</span><span class=\"token function\">processExtensions</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    appModuleProcessor<span class=\"token punctuation\">.</span><span class=\"token function\">processModules</span><span class=\"token punctuation\">(</span>set<span class=\"token punctuation\">,</span> env<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newExtensionWritten <span class=\"token operator\">||</span> newModulesWritten<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isGeneratedAppGlideModuleWritten<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot process annotations after writing AppGlideModule\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isGeneratedAppGlideModuleWritten<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      isGeneratedAppGlideModuleWritten <span class=\"token operator\">=</span> appModuleProcessor<span class=\"token punctuation\">.</span><span class=\"token function\">maybeWriteAppModule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<ul>\n<li><code>getSupportedAnnotationTypes</code>方法中标记了，支持哪些注解的解析，其中<code>libraryModuleProcessor.getSupportedAnnotationTypes()</code>中返回了**@GlideModule<strong>，<code>extensionProcessor.getSupportedAnnotationTypes()</code>中返回了</strong>@GlideExtension**。</li>\n<li>process方法中开始了对注解的处理。</li>\n</ul>\n<p>注解的处理，需要你对<a href=\"https://github.com/square/javapoet\"><strong>javapoet</strong></a>有一点点了解，如果暂时不想去了解，你只需要知道，这个类库是通过字符串和占位符来生成Java代码的工具类库，因为接下来的生成代码工作，Glide就是通过这个类库来实现的。</p>\n<p>具体的生成过程不再赘述，从入口类<em>GlideAnnotationProcessor</em>追踪下去，就能看到。</p>\n<h2 id=\"为什么优化能提高效率？\"><a href=\"#为什么优化能提高效率？\" class=\"headerlink\" title=\"为什么优化能提高效率？\"></a>为什么优化能提高效率？</h2><p>Glide默认Gif加载方案，是通过GifDrawable来实现的，而GifDrawable是通过GifFrameLoader来加载帧数据的。具体代码分析可以看参考文章，我这里简单来说一下原因：</p>\n<ul>\n<li>默认方案是串行执行的，比如在加载显示第N帧，这一帧显示完毕，再去解析第N+1帧，当播放第N+1帧的时间窗口到了以后，如果已经解析完毕，则能正常显示，如果不能解析完毕，则会卡顿了；</li>\n<li>GifFrameLoader内部是用了一个mainLooper的handler来进行流程控制，具体可以看GifFrameLoader里的代码，这种方式本身在时间上就不是准时的，与应用内其他各种系统共享mainLooper，如果其他事件执行占用时间较长，也会影响这里的效率了。</li>\n</ul>\n<p>我们再来说说优化方案，优化的原因也简单说一下：</p>\n<ul>\n<li>优化方案是<strong>并行+双缓冲</strong>执行的，在显示第N帧的BitmapA同时，会有一个后台线程在解析第N+1帧的BitmapB，当需要显示第N+1帧BitmapB的时候，两帧的Bitmap交换，BitmapA则进入后台线程去解析第N+2帧了；</li>\n<li>在native去解析数据，效率更高；</li>\n<li>通过BitmapPool提高了内存利用率。</li>\n</ul>\n<p>借用参考文章里的一张图</p>\n<p><img src=\"/images/gif.webp\" alt=\"Gif\"></p>\n<h2 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h2><p><a href=\"https://juejin.im/post/6854573219425288199\">Glide加载Gif的卡顿优化思路分析</a></p>\n","excerpt":"","more":"<p>项目Demo地址：<a href=\"https://github.com/boybeak/GifHelper\">GifHelper</a></p>\n<p><strong>什么是APT？</strong></p>\n<p><strong>APT</strong>是<strong>Annotation Processing Tool</strong>的简称，即<strong>编译时注解处理器</strong>。它是一个javac的工具，在编译时，通过注解，按照规则自动生成相关代码的工具。</p>\n<p><strong>APT与Glide什么关系？</strong></p>\n<p>我们通常通过在build.gradle加入这样一段代码来引入Glide库。</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">repositories <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">google</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">jcenter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\ndependencies <span class=\"token punctuation\">&#123;</span>\n  implementation <span class=\"token string\">'com.github.bumptech.glide:glide:4.11.0'</span>\n  annotationProcessor <span class=\"token string\">'com.github.bumptech.glide:compiler:4.11.0'</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里有一个<code>annotationProcessor</code>，这就是对Glide提供的APT进行引用。我们查看Glide的源码结构，可以看到一个名为<em>annotation</em>的文件夹，这里就是与APT有关的部分。</p>\n<p><img src=\"/images/glide_struct.jpg\" alt=\"Glide Struct\"></p>\n<p>接下来我们先通过GIF优化，看一看Glide的APT能实现的神奇效果，在这之后，再来分析Glide是如何通过APT实现的。</p>\n<blockquote>\n<p><strong>注意：</strong>如果使用kotlin需要先加入<code>apply plugin: &#39;kotlin-kapt&#39;</code>插件，并且将<code>annotationProcessor</code>改成<code>kapt</code>。</p>\n</blockquote>\n<h2 id=\"GIF优化\"><a href=\"#GIF优化\" class=\"headerlink\" title=\"GIF优化\"></a>GIF优化</h2><p><strong>为什么要优化GIF？</strong></p>\n<p>有人可能会有疑问，Glide相比其他图片加载框架的优势之一，就是支持GIF，为什么还要做优化呢？</p>\n<p>先看两个截图来对比优化前后的CPU和内存使用情况。</p>\n<p><img src=\"/images/gif_before_optimization.png\" alt=\"优化前\"></p>\n<p><img src=\"/images/gif_after_optimization.png\" alt=\"优化后\"></p>\n<p>我们可以看出，优化后，CPU和内存状况都好了很多，那么我们是怎么做的呢？这就需要用到谷歌官方的两个库——<a href=\"https://android.googlesource.com/platform/external/giflib/+/refs/heads/master\">giflib</a>和<a href=\"https://android.googlesource.com/platform/frameworks/ex/+/refs/heads/master/framesequence/\">FrameSequence</a>，这两个库需要我们自己编译成.so文件，具体可以参考示例项目<a href=\"https://github.com/boybeak/GifHelper\">GifHelper</a>。</p>\n<p>我们查看GifHolder中的代码。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">GifHolder</span><span class=\"token punctuation\">(</span>v<span class=\"token operator\">:</span> View<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> AbsHolder<span class=\"token operator\">&lt;</span>GifItem<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> gifIV <span class=\"token operator\">=</span> view<span class=\"token operator\">&lt;</span>ImageView<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>R<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">.</span>gifIV<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onBind</span><span class=\"token punctuation\">(</span>item<span class=\"token operator\">:</span> GifItem<span class=\"token punctuation\">,</span> position<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> absAdapter<span class=\"token operator\">:</span> AnyAdapter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span>useGifX<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token comment\">// 优化后的加载方式</span>\n    \tGlideApp<span class=\"token punctuation\">.</span><span class=\"token function\">with</span><span class=\"token punctuation\">(</span>itemView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">asGifX</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span><span class=\"token function\">source</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span>gifIV<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token comment\">// 优化前的加载方式</span>\n      Glide<span class=\"token punctuation\">.</span><span class=\"token function\">with</span><span class=\"token punctuation\">(</span>itemView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">asGif</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span><span class=\"token function\">source</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span>gifIV<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token operator\">..</span><span class=\"token operator\">..</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们可以看到，加载后有这样一条语句：<code>GlideApp.with(itemView).asGifX().load(item.source()).into(gifIV)</code>，也许你会懵逼，哪里有GlideApp？哪里有asGifX()方法？我引入Glide后怎么没有看到这两个东西？这就涉及到了APT的内容了。想要看Glide官方文档的可以看<a href=\"http://bumptech.github.io/glide/doc/configuration.html#glidemodule\">这里</a>。</p>\n<p>一切的起因，要从**@GlideModule**这个注解说起，我们打开demo中的MyAppGlideModule类，可以看到这个类有一个@GlideModule注解。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@GlideModule</span>\n<span class=\"token keyword\">class</span> MyAppGlideModule <span class=\"token operator\">:</span> <span class=\"token function\">AppGlideModule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">registerComponents</span><span class=\"token punctuation\">(</span>context<span class=\"token operator\">:</span> Context<span class=\"token punctuation\">,</span> glide<span class=\"token operator\">:</span> Glide<span class=\"token punctuation\">,</span> registry<span class=\"token operator\">:</span> Registry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">registerComponents</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> glide<span class=\"token punctuation\">,</span> registry<span class=\"token punctuation\">)</span>\n    registry<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>Registry<span class=\"token punctuation\">.</span>BUCKET_GIF<span class=\"token punctuation\">,</span> InputStream<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">,</span>\n                    FrameSequenceDrawable<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">,</span> <span class=\"token function\">GifDecoder</span><span class=\"token punctuation\">(</span>glide<span class=\"token punctuation\">.</span>bitmapPool<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们再点开这个注解的源码，如下：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Target</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ElementType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TYPE</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Retention</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RetentionPolicy</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CLASS</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token annotation punctuation\">@interface</span> <span class=\"token class-name\">GlideModule</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">/**\n   * Returns the name of the class that will be used as a replacement for &#123;@code\n   * com.bumptech.glide.Glide&#125; in Applications that depend on Glide's generated code.\n   */</span>\n  <span class=\"token class-name\">String</span> <span class=\"token function\">glideName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">default</span> <span class=\"token string\">\"GlideApp\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们现在看到“GlideApp”了，是glideName这个注解属性的默认值。我们来逐条分析一下这个注解类的相关信息：</p>\n<ul>\n<li><code>@Target(ElementType.TYPE)</code>：指明这个注解的作用对象——只对类生效；</li>\n<li><code>@Retention(RetentionPolicy.CLASS)</code>：指明了这个注解的作用阶段——编译时记录在class文件中；</li>\n<li><code>public @interface GlideModule</code>：这是一个注解接口，接口名<strong>GlideModule</strong>；</li>\n<li><code>String glideName() default &quot;GlideApp&quot;</code>：这个注解接口需要一个名为<em>glideName</em>的属性，属性默认值为“GlideApp”。</li>\n</ul>\n<blockquote>\n<p>RetentionPolicy：</p>\n<ul>\n<li><strong>SOURCE</strong>：这样的注解会被编译器擦除，只在编码阶段生效，目的是为了提示开发者，比如**@IntDef<strong>、</strong>@StringDef<strong>、</strong>@Visibility<strong>、</strong>@NonNull**；</li>\n<li><strong>CLASS</strong>：记录在class文件中，编译时对编译器可见，运行时对VM不可见，这是RetentionPolicy的默认值，比如**@NotNull**;</li>\n<li><strong>RUNTIME</strong>：记录在class文件中，在运行时需要反射获取其属性值，比如**@Column**。</li>\n</ul>\n</blockquote>\n<p>就是这个**@GlideModule**属性，为我们生成了GlideApp类，这其中的生成过程，我们稍后再说，先把Gif优化的流程说完。</p>\n<p>添加**@GlideModule**后，再次编译看，是否有了GlideApp这个类了。</p>\n<p>我们再来看<em>MyAppGlideModule</em>中的代码，<code>registry.append</code>方法，这是为Glide添加一种解析类型。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">/* \n* @param bucket 要添加的类型id.\n* @param dataClass 要从什么数据进行解析。 (&#123;@link java.io.InputStream&#125;, &#123;@link\n*     java.io.FileDescriptor&#125; etc).\n* @param resourceClass 要解析成什么数据。 (&#123;@link android.graphics.Bitmap&#125;,\n*     &#123;@link com.bumptech.glide.load.resource.gif.GifDrawable&#125; etc).\n* @param decoder 用什么解码器进行解析 &#123;@link ResourceDecoder&#125;。\n*/</span>\n<span class=\"token annotation punctuation\">@NonNull</span>\n<span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Data</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TResource</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">Registry</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>\n  <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">String</span> bucket<span class=\"token punctuation\">,</span>\n  <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Data</span><span class=\"token punctuation\">></span></span> dataClass<span class=\"token punctuation\">,</span>\n  <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TResource</span><span class=\"token punctuation\">></span></span> resourceClass<span class=\"token punctuation\">,</span>\n  <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">ResourceDecoder</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Data</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TResource</span><span class=\"token punctuation\">></span></span> decoder<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  decoderRegistry<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">,</span> decoder<span class=\"token punctuation\">,</span> dataClass<span class=\"token punctuation\">,</span> resourceClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n\n\n<p>接下来就要引入谷歌官方的两个类库了，<a href=\"https://android.googlesource.com/platform/frameworks/ex/+/android-9.0.0_r16/framesequence/\">FrameSquence</a>和<a href=\"https://android.googlesource.com/platform/external/giflib/+/android-9.0.0_r16\">giflib</a>。大家可以根据需要下载对应版本的库，不过这两个库的版本最好要对应。</p>\n<p>下载后需要编译，项目结构参考<a href=\"https://github.com/boybeak/GifHelper\">GifHelper</a>项目中的framesequence&#x2F;src&#x2F;main&#x2F;jni文件夹。注意，需要将FrameSequence_gif.h中的include部分进行修改。</p>\n<pre class=\"language-diff\" data-language=\"diff\"><code class=\"language-diff\"><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span><span class=\"token line\"> #include \"config.h\"\n</span><span class=\"token prefix deleted\">-</span><span class=\"token line\"> #include \"gif_lib.h\"\n</span></span>改成\n<span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\"> #include \"giflib/config.h\"\n</span><span class=\"token prefix inserted\">+</span><span class=\"token line\"> #include \"giflib/gif_lib.h\"</span></span></code></pre>\n\n<p>然后执行ndk-build，则会在jni同级的目录下，生成一个libs文件夹，.so文件就在这里。</p>\n<p>接下来需要去自定义GifDecoder.java了，直接上代码：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">GifDecoder</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> bmpPool<span class=\"token operator\">:</span> BitmapPool<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> ResourceDecoder<span class=\"token operator\">&lt;</span>InputStream<span class=\"token punctuation\">,</span> FrameSequenceDrawable<span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> headerParser <span class=\"token operator\">=</span> <span class=\"token function\">DefaultImageHeaderParser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">handles</span><span class=\"token punctuation\">(</span>source<span class=\"token operator\">:</span> InputStream<span class=\"token punctuation\">,</span> options<span class=\"token operator\">:</span> Options<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Boolean <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>GifOptions<span class=\"token punctuation\">.</span>DISABLE_ANIMATION<span class=\"token punctuation\">)</span> <span class=\"token operator\">?:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">&amp;&amp;</span> headerParser<span class=\"token punctuation\">.</span><span class=\"token function\">getType</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> ImageHeaderParser<span class=\"token punctuation\">.</span>ImageType<span class=\"token punctuation\">.</span>GIF\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>\n        source<span class=\"token operator\">:</span> InputStream<span class=\"token punctuation\">,</span>\n        width<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        height<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        options<span class=\"token operator\">:</span> Options\n    <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Resource<span class=\"token operator\">&lt;</span>FrameSequenceDrawable<span class=\"token operator\">></span><span class=\"token operator\">?</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">val</span> fs <span class=\"token operator\">=</span> FrameSequence<span class=\"token punctuation\">.</span><span class=\"token function\">decodeStream</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> fsd <span class=\"token operator\">=</span> <span class=\"token function\">FrameSequenceDrawable</span><span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">,</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> FrameSequenceDrawable<span class=\"token punctuation\">.</span><span class=\"token function\">BitmapProvider</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">acquireBitmap</span><span class=\"token punctuation\">(</span>minWidth<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> minHeight<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Bitmap <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token keyword\">return</span> bmpPool<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>minWidth<span class=\"token punctuation\">,</span> minHeight<span class=\"token punctuation\">,</span> Bitmap<span class=\"token punctuation\">.</span>Config<span class=\"token punctuation\">.</span>ARGB_8888<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#125;</span>\n\n            <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">releaseBitmap</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">:</span> Bitmap<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                bmpPool<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">GifResource</span><span class=\"token punctuation\">(</span>fsd<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这个类里只需要实现两个方法：<code>handles</code>和<code>decode</code>：</p>\n<ul>\n<li>handles：能否解析该输入源，能则返回true；</li>\n<li>decode：如果handles返回true，则执行此方法，返回一个Resource对象包裹住目标类型对象。</li>\n</ul>\n<p>我们通过Glide自带的<em>ImageHeaderParser</em>来检测该输入流是否是gif图像的输入流，如果是且可以执行动画，则进行decode操作。</p>\n<p>我们着重看decode方法，这里需要重点看的是，在构建<em>FrameSequenceDrawable</em>时候，传入了一个<em>BitmapProvider</em>对象，这就是提高Gif效率的关键，在这个<em>BitmapProvider</em>里面，我们通过BitmapPool，去寻找可用尺寸的Bitmap，通过<strong>池化</strong>的方式，减小了内存开销，增加里Bitmap利用率。</p>\n<p>接下来看，如何添加<code>asGifX</code>方法。我们都知道，传统的Glide调用方式如下图：</p>\n<p><code>Glide.with(itemView).asGif().load(item.source()).into(gifIV)</code></p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> LR<span class=\"token punctuation\">;</span>\nA<span class=\"token text string\">[Glide]</span> <span class=\"token arrow operator\">--></span><span class=\"token label property\">|\"with(xxx)\"|</span> B<span class=\"token text string\">[RequestManager]</span> <span class=\"token arrow operator\">--></span><span class=\"token label property\">|\"asGif\"|</span> C<span class=\"token text string\">[RequestBuilder]</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>而新的方式却不同，如下图：</p>\n<p><code>GlideApp.with(itemView).asGifX().load(item.source()).into(gifIV)</code></p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> LR<span class=\"token punctuation\">;</span>\nA<span class=\"token text string\">[GlideApp]</span> <span class=\"token arrow operator\">--></span><span class=\"token label property\">|\"with(xxx)\"|</span> B<span class=\"token text string\">[GlideRequests]</span>  <span class=\"token arrow operator\">--></span><span class=\"token label property\">|asGifX|</span> C<span class=\"token text string\">[GlideRequest]</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>这其中的<em>GlideRequest</em>和<em>GlideRequest</em>，同样都是生成的类，其中GlideRequests继承自RequestManager，GlideRequest继承自RequestBuilder。</p>\n<p>这两个类的生成，同样是**@GlideModule**的作用，但是<code>asGifX</code>这个方法是什么时候定义的呢？我们去查看<code>asGifX</code>这个方法的代码：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">/**\n* @see GifExtension#asGifX(RequestBuilder)\n*/</span>\n<span class=\"token annotation punctuation\">@NonNull</span>\n<span class=\"token annotation punctuation\">@CheckResult</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">GlideRequest</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">FrameSequenceDrawable</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">asGifX</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">GlideRequest</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">FrameSequenceDrawable</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">GifExtension</span><span class=\"token punctuation\">.</span><span class=\"token function\">asGifX</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">as</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">FrameSequenceDrawable</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们看到实际上这个类的具体实现，是依靠GifExtension类，我们去看这个类的代码：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@GlideExtension</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GifExtension</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token annotation punctuation\">@NonNull</span>\n    <span class=\"token annotation punctuation\">@GlideType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">FrameSequenceDrawable</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">RequestBuilder</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">FrameSequenceDrawable</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">asGifX</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RequestBuilder</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">FrameSequenceDrawable</span><span class=\"token punctuation\">></span></span> requestBuilder<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> requestBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RequestOptions</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">decodeTypeOf</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">FrameSequenceDrawable</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">GifExtension</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这个类需要我们自己实现，并且需要标记**@GlideExtension**注解，又是注解的功劳。</p>\n<p>到此为止，Gif优化的主流程就全部讲完了，接下来就要看这两个注解——**@GlideModule<strong>和</strong>@GlideExtension**到底做了什么？</p>\n<h2 id=\"GlideModule和-GlideExtension\"><a href=\"#GlideModule和-GlideExtension\" class=\"headerlink\" title=\"@GlideModule和@GlideExtension\"></a>@GlideModule和@GlideExtension</h2><p>源码在Glide项目的annotation&#x2F;compiler内，这种APT项目的入口文件标记在src&#x2F;main&#x2F;resources&#x2F;META-INF&#x2F;gradle内，这其中有一个incremental.annotation.processors文件，我们查看其内容：</p>\n<pre class=\"language-none\"><code class=\"language-none\">com.bumptech.glide.annotation.compiler.GlideAnnotationProcessor,aggregating</code></pre>\n\n<p>可以得知，程序入口在GlideAnnotationProcessor这个类，查看这个类的源码，我只提取了关键部分：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GlideAnnotationProcessor</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractProcessor</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">LibraryModuleProcessor</span> libraryModuleProcessor<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">AppModuleProcessor</span> appModuleProcessor<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> isGeneratedAppGlideModuleWritten<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">ExtensionProcessor</span> extensionProcessor<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getSupportedAnnotationTypes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    result<span class=\"token punctuation\">.</span><span class=\"token function\">addAll</span><span class=\"token punctuation\">(</span>libraryModuleProcessor<span class=\"token punctuation\">.</span><span class=\"token function\">getSupportedAnnotationTypes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    result<span class=\"token punctuation\">.</span><span class=\"token function\">addAll</span><span class=\"token punctuation\">(</span>extensionProcessor<span class=\"token punctuation\">.</span><span class=\"token function\">getSupportedAnnotationTypes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">TypeElement</span><span class=\"token punctuation\">></span></span> set<span class=\"token punctuation\">,</span> <span class=\"token class-name\">RoundEnvironment</span> env<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    processorUtil<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">boolean</span> newModulesWritten <span class=\"token operator\">=</span> libraryModuleProcessor<span class=\"token punctuation\">.</span><span class=\"token function\">processModules</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">boolean</span> newExtensionWritten <span class=\"token operator\">=</span> extensionProcessor<span class=\"token punctuation\">.</span><span class=\"token function\">processExtensions</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    appModuleProcessor<span class=\"token punctuation\">.</span><span class=\"token function\">processModules</span><span class=\"token punctuation\">(</span>set<span class=\"token punctuation\">,</span> env<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newExtensionWritten <span class=\"token operator\">||</span> newModulesWritten<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isGeneratedAppGlideModuleWritten<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot process annotations after writing AppGlideModule\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isGeneratedAppGlideModuleWritten<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      isGeneratedAppGlideModuleWritten <span class=\"token operator\">=</span> appModuleProcessor<span class=\"token punctuation\">.</span><span class=\"token function\">maybeWriteAppModule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<ul>\n<li><code>getSupportedAnnotationTypes</code>方法中标记了，支持哪些注解的解析，其中<code>libraryModuleProcessor.getSupportedAnnotationTypes()</code>中返回了**@GlideModule<strong>，<code>extensionProcessor.getSupportedAnnotationTypes()</code>中返回了</strong>@GlideExtension**。</li>\n<li>process方法中开始了对注解的处理。</li>\n</ul>\n<p>注解的处理，需要你对<a href=\"https://github.com/square/javapoet\"><strong>javapoet</strong></a>有一点点了解，如果暂时不想去了解，你只需要知道，这个类库是通过字符串和占位符来生成Java代码的工具类库，因为接下来的生成代码工作，Glide就是通过这个类库来实现的。</p>\n<p>具体的生成过程不再赘述，从入口类<em>GlideAnnotationProcessor</em>追踪下去，就能看到。</p>\n<h2 id=\"为什么优化能提高效率？\"><a href=\"#为什么优化能提高效率？\" class=\"headerlink\" title=\"为什么优化能提高效率？\"></a>为什么优化能提高效率？</h2><p>Glide默认Gif加载方案，是通过GifDrawable来实现的，而GifDrawable是通过GifFrameLoader来加载帧数据的。具体代码分析可以看参考文章，我这里简单来说一下原因：</p>\n<ul>\n<li>默认方案是串行执行的，比如在加载显示第N帧，这一帧显示完毕，再去解析第N+1帧，当播放第N+1帧的时间窗口到了以后，如果已经解析完毕，则能正常显示，如果不能解析完毕，则会卡顿了；</li>\n<li>GifFrameLoader内部是用了一个mainLooper的handler来进行流程控制，具体可以看GifFrameLoader里的代码，这种方式本身在时间上就不是准时的，与应用内其他各种系统共享mainLooper，如果其他事件执行占用时间较长，也会影响这里的效率了。</li>\n</ul>\n<p>我们再来说说优化方案，优化的原因也简单说一下：</p>\n<ul>\n<li>优化方案是<strong>并行+双缓冲</strong>执行的，在显示第N帧的BitmapA同时，会有一个后台线程在解析第N+1帧的BitmapB，当需要显示第N+1帧BitmapB的时候，两帧的Bitmap交换，BitmapA则进入后台线程去解析第N+2帧了；</li>\n<li>在native去解析数据，效率更高；</li>\n<li>通过BitmapPool提高了内存利用率。</li>\n</ul>\n<p>借用参考文章里的一张图</p>\n<p><img src=\"/images/gif.webp\" alt=\"Gif\"></p>\n<h2 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h2><p><a href=\"https://juejin.im/post/6854573219425288199\">Glide加载Gif的卡顿优化思路分析</a></p>\n"},{"layout":"post","title":"LiveEventBus源码分析","author":"boybeak","date":"2022-09-16T23:00:00.000Z","_content":"\n\n> 不再分析了，理解了LiveData后，不难理解这个框架。\n\n阅读本文前，请先阅读[《Jetpack之LiveData源码分析》]({{site.base_url}}/源码分析系列/LiveEventBus源码分析.md)。因为**LiveEventBus**是基于**LiveData**构建的。\n\n源码地址：[LiveEventBus](https://github.com/JeremyLiao/LiveEventBus)\n\n典型用法如下：\n\n```java\n// 监听消息\nLiveEventBus\n\t.get(\"some_key\", String.class)\n\t.observe(this, new Observer<String>() {\n\t    @Override\n\t    public void onChanged(@Nullable String s) {\n\t    }\n\t});\n```\n\n```java\n// 发送消息\nLiveEventBus\n\t.get(\"some_key\")\n\t.post(some_value);\n```\n\n其实，这三个方法就是最核心的，get、observe和post。通过get获取一个Observable对象，通过observe进行监听，通过post发送消息。我们就从这三个方法入手去分析其源码。\n\n\n\n## get方法分析\n\n跟踪get方法，不难发现，是由*LiveEventBusCore*单例提供的with()方法返回的*Observable*，*LiveEventBusCore*中有一个名为bus的Map<String, LiveEvent<Object>>的成员变量，就是在这个变量中，以key - value的形式，保存了*Obserable*对象。observe方法与post方法都是由*Obserable*提供的。*Observable*是一个接口，它有一个唯一的实现类：**LiveEvent**。也就是说，observe方法与post方法的具体实现，都是由*LiveEvent*类提供。\n\n主要代码如下：\n\n##LiveEvent \n\n```java\nprivate class LiveEvent<T> implements Observable<T> {\n  @NonNull\n  private final String key;\n  private final LifecycleLiveData<T> liveData;\t// 继承自MutableLiveData，实现生命周期感知\n  private final Map<Observer, ObserverWrapper<T>> observerMap = new HashMap<>(); // 存储ObserverWrapper对象\n  private final Handler mainHandler = new Handler(Looper.getMainLooper()); // 便于切换到主线程\n  \n  /**\n  * 进程内发送消息\n  *\n  * @param value 发送的消息\n  */\n  @Override\n  public void post(T value) {\n    if (ThreadUtils.isMainThread()) {\n      postInternal(value);\n    } else {\n      mainHandler.post(new PostValueTask(value));\n    }\n  }\n  \n  /**\n  * 注册一个Observer，生命周期感知，自动取消订阅\n  *\n  * @param owner    LifecycleOwner\n  * @param observer 观察者\n  */\n  @Override\n  public void observe(@NonNull final LifecycleOwner owner, @NonNull final Observer<T> observer) {\n    if (ThreadUtils.isMainThread()) {\n      observeInternal(owner, observer);\n    } else {\n      mainHandler.post(new Runnable() {\n        @Override\n        public void run() {\n          observeInternal(owner, observer);\n        }\n      });\n    }\n  }\n  \n}\n```\n\n*LiveEvent*中通过一个成员变量`Map<Observer, ObserverWrapper<T>> observerMap`来存储*ObserverWrapper*。\n\n*ObserverWrapper*是**LiveData**库中的*Observer*类的子类，","source":"_posts/2022-09-17-LiveEventBus源码分析.md","raw":"---\nlayout: post\ntitle: LiveEventBus源码分析\nauthor: boybeak\ncategory: 源码分析\ntags: Android\ndate: 2022-09-17 07:00:00\n---\n\n\n> 不再分析了，理解了LiveData后，不难理解这个框架。\n\n阅读本文前，请先阅读[《Jetpack之LiveData源码分析》]({{site.base_url}}/源码分析系列/LiveEventBus源码分析.md)。因为**LiveEventBus**是基于**LiveData**构建的。\n\n源码地址：[LiveEventBus](https://github.com/JeremyLiao/LiveEventBus)\n\n典型用法如下：\n\n```java\n// 监听消息\nLiveEventBus\n\t.get(\"some_key\", String.class)\n\t.observe(this, new Observer<String>() {\n\t    @Override\n\t    public void onChanged(@Nullable String s) {\n\t    }\n\t});\n```\n\n```java\n// 发送消息\nLiveEventBus\n\t.get(\"some_key\")\n\t.post(some_value);\n```\n\n其实，这三个方法就是最核心的，get、observe和post。通过get获取一个Observable对象，通过observe进行监听，通过post发送消息。我们就从这三个方法入手去分析其源码。\n\n\n\n## get方法分析\n\n跟踪get方法，不难发现，是由*LiveEventBusCore*单例提供的with()方法返回的*Observable*，*LiveEventBusCore*中有一个名为bus的Map<String, LiveEvent<Object>>的成员变量，就是在这个变量中，以key - value的形式，保存了*Obserable*对象。observe方法与post方法都是由*Obserable*提供的。*Observable*是一个接口，它有一个唯一的实现类：**LiveEvent**。也就是说，observe方法与post方法的具体实现，都是由*LiveEvent*类提供。\n\n主要代码如下：\n\n##LiveEvent \n\n```java\nprivate class LiveEvent<T> implements Observable<T> {\n  @NonNull\n  private final String key;\n  private final LifecycleLiveData<T> liveData;\t// 继承自MutableLiveData，实现生命周期感知\n  private final Map<Observer, ObserverWrapper<T>> observerMap = new HashMap<>(); // 存储ObserverWrapper对象\n  private final Handler mainHandler = new Handler(Looper.getMainLooper()); // 便于切换到主线程\n  \n  /**\n  * 进程内发送消息\n  *\n  * @param value 发送的消息\n  */\n  @Override\n  public void post(T value) {\n    if (ThreadUtils.isMainThread()) {\n      postInternal(value);\n    } else {\n      mainHandler.post(new PostValueTask(value));\n    }\n  }\n  \n  /**\n  * 注册一个Observer，生命周期感知，自动取消订阅\n  *\n  * @param owner    LifecycleOwner\n  * @param observer 观察者\n  */\n  @Override\n  public void observe(@NonNull final LifecycleOwner owner, @NonNull final Observer<T> observer) {\n    if (ThreadUtils.isMainThread()) {\n      observeInternal(owner, observer);\n    } else {\n      mainHandler.post(new Runnable() {\n        @Override\n        public void run() {\n          observeInternal(owner, observer);\n        }\n      });\n    }\n  }\n  \n}\n```\n\n*LiveEvent*中通过一个成员变量`Map<Observer, ObserverWrapper<T>> observerMap`来存储*ObserverWrapper*。\n\n*ObserverWrapper*是**LiveData**库中的*Observer*类的子类，","slug":"2022-09-17-LiveEventBus源码分析","published":1,"updated":"2024-11-13T13:39:56.122Z","_id":"cm1ltr0fy000dbji0gi4hgvqq","comments":1,"photos":[],"content":"<blockquote>\n<p>不再分析了，理解了LiveData后，不难理解这个框架。</p>\n</blockquote>\n<p>阅读本文前，请先阅读[《Jetpack之LiveData源码分析》](&#x2F;源码分析系列&#x2F;LiveEventBus源码分析.md)。因为<strong>LiveEventBus</strong>是基于<strong>LiveData</strong>构建的。</p>\n<p>源码地址：<a href=\"https://github.com/JeremyLiao/LiveEventBus\">LiveEventBus</a></p>\n<p>典型用法如下：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">// 监听消息</span>\n<span class=\"token class-name\">LiveEventBus</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"some_key\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t    <span class=\"token annotation punctuation\">@Override</span>\n\t    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onChanged</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">String</span> s<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t    <span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">// 发送消息</span>\n<span class=\"token class-name\">LiveEventBus</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"some_key\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>some_value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>其实，这三个方法就是最核心的，get、observe和post。通过get获取一个Observable对象，通过observe进行监听，通过post发送消息。我们就从这三个方法入手去分析其源码。</p>\n<h2 id=\"get方法分析\"><a href=\"#get方法分析\" class=\"headerlink\" title=\"get方法分析\"></a>get方法分析</h2><p>跟踪get方法，不难发现，是由<em>LiveEventBusCore</em>单例提供的with()方法返回的<em>Observable</em>，<em>LiveEventBusCore</em>中有一个名为bus的Map&lt;String, LiveEvent<Object>&gt;的成员变量，就是在这个变量中，以key - value的形式，保存了<em>Obserable</em>对象。observe方法与post方法都是由<em>Obserable</em>提供的。<em>Observable</em>是一个接口，它有一个唯一的实现类：<strong>LiveEvent</strong>。也就是说，observe方法与post方法的具体实现，都是由<em>LiveEvent</em>类提供。</p>\n<p>主要代码如下：</p>\n<p>##LiveEvent </p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LiveEvent</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Observable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token annotation punctuation\">@NonNull</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> key<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">LifecycleLiveData</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> liveData<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 继承自MutableLiveData，实现生命周期感知</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Observer</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ObserverWrapper</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> observerMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 存储ObserverWrapper对象</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Handler</span> mainHandler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">getMainLooper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 便于切换到主线程</span>\n  \n  <span class=\"token comment\">/**\n  * 进程内发送消息\n  *\n  * @param value 发送的消息\n  */</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ThreadUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isMainThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">postInternal</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n      mainHandler<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">PostValueTask</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  \n  <span class=\"token comment\">/**\n  * 注册一个Observer，生命周期感知，自动取消订阅\n  *\n  * @param owner    LifecycleOwner\n  * @param observer 观察者\n  */</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ThreadUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isMainThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">observeInternal</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">,</span> observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n      mainHandler<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n          <span class=\"token function\">observeInternal</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">,</span> observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  \n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p><em>LiveEvent</em>中通过一个成员变量<code>Map&lt;Observer, ObserverWrapper&lt;T&gt;&gt; observerMap</code>来存储<em>ObserverWrapper</em>。</p>\n<p><em>ObserverWrapper</em>是<strong>LiveData</strong>库中的<em>Observer</em>类的子类，</p>\n","excerpt":"","more":"<blockquote>\n<p>不再分析了，理解了LiveData后，不难理解这个框架。</p>\n</blockquote>\n<p>阅读本文前，请先阅读[《Jetpack之LiveData源码分析》](&#x2F;源码分析系列&#x2F;LiveEventBus源码分析.md)。因为<strong>LiveEventBus</strong>是基于<strong>LiveData</strong>构建的。</p>\n<p>源码地址：<a href=\"https://github.com/JeremyLiao/LiveEventBus\">LiveEventBus</a></p>\n<p>典型用法如下：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">// 监听消息</span>\n<span class=\"token class-name\">LiveEventBus</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"some_key\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t    <span class=\"token annotation punctuation\">@Override</span>\n\t    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onChanged</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">String</span> s<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t    <span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">// 发送消息</span>\n<span class=\"token class-name\">LiveEventBus</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"some_key\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>some_value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>其实，这三个方法就是最核心的，get、observe和post。通过get获取一个Observable对象，通过observe进行监听，通过post发送消息。我们就从这三个方法入手去分析其源码。</p>\n<h2 id=\"get方法分析\"><a href=\"#get方法分析\" class=\"headerlink\" title=\"get方法分析\"></a>get方法分析</h2><p>跟踪get方法，不难发现，是由<em>LiveEventBusCore</em>单例提供的with()方法返回的<em>Observable</em>，<em>LiveEventBusCore</em>中有一个名为bus的Map&lt;String, LiveEvent<Object>&gt;的成员变量，就是在这个变量中，以key - value的形式，保存了<em>Obserable</em>对象。observe方法与post方法都是由<em>Obserable</em>提供的。<em>Observable</em>是一个接口，它有一个唯一的实现类：<strong>LiveEvent</strong>。也就是说，observe方法与post方法的具体实现，都是由<em>LiveEvent</em>类提供。</p>\n<p>主要代码如下：</p>\n<p>##LiveEvent </p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LiveEvent</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Observable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token annotation punctuation\">@NonNull</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> key<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">LifecycleLiveData</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> liveData<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 继承自MutableLiveData，实现生命周期感知</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Observer</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ObserverWrapper</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> observerMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 存储ObserverWrapper对象</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Handler</span> mainHandler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">getMainLooper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 便于切换到主线程</span>\n  \n  <span class=\"token comment\">/**\n  * 进程内发送消息\n  *\n  * @param value 发送的消息\n  */</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ThreadUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isMainThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">postInternal</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n      mainHandler<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">PostValueTask</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  \n  <span class=\"token comment\">/**\n  * 注册一个Observer，生命周期感知，自动取消订阅\n  *\n  * @param owner    LifecycleOwner\n  * @param observer 观察者\n  */</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ThreadUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isMainThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">observeInternal</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">,</span> observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n      mainHandler<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n          <span class=\"token function\">observeInternal</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">,</span> observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  \n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p><em>LiveEvent</em>中通过一个成员变量<code>Map&lt;Observer, ObserverWrapper&lt;T&gt;&gt; observerMap</code>来存储<em>ObserverWrapper</em>。</p>\n<p><em>ObserverWrapper</em>是<strong>LiveData</strong>库中的<em>Observer</em>类的子类，</p>\n"},{"layout":"post","title":"IRouter——自己手撸一个路由框架","author":"boybeak","date":"2022-09-17T00:00:00.000Z","_content":"\n\n现在最流行的路由框架应该是阿里的ARouter，这几乎是组件化应用的必备了。但是ARouter用起来稍微有一点不爽，不爽在以下两点：\n\n1. 没有一个规范化的api式的调用方式：项目大了，调用路由的方法分布在项目各处，难以查找；\n2. 对startActivityForResult支持不够友好：按照传统方式，在onActivityResult中处理，比较分散。\n\n基于以上问题，闲来无事，手撸一个自己的路由框架[IRouter](https://github.com/boybeak/Routerfit)，基本使用方式如下：\n\n```kotlin\ninterface IRouterService {\n    @RouteTo(\"topic/detail\")\n    fun topicDetail(@Key(\"topic\") topic: Topic): Navigator\n}\n\nval iRouter = IRouter.Builder()\n    .isDebug(BuildConfig.DEBUG)\n    .errorActivity(ErrorActivity::class.java)\n    .build()\n    .create(IRouterService::class.java)\n\niRouter.topicDetail(topic).startActivity(this@MainActivity)\n\n// OR\n\niRouter.topicDetail(topic).startActivityForResult(this, 100) { requestCode, resultCode, data ->\n}\n```\n\n具体的配置方式请参考[IRouter](https://github.com/boybeak/Routerfit)，本文主要是解析源码。\n\n如此调用方式，很像是Retrofit的方式，打开一个activity就像请求一个api一样。从这里可以体现出解决了上述的两个痛点：\n\n1. 类似API的调用方式，集中管理路由路径；\n2. startActivityForResult中添加回调，哪里调用，就在哪里处理结果，结构紧凑。\n\n下面进入源码解析。\n\n与[ARouter源码分析](https://boybeak.github.io/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97/ARouter%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html)这篇文章一样，我们分析时候要按照时态去分析这个框架在**运行时**和**编译时**做的事情。\n\n## 运行时\n\n其实从上述调用的方式，有过热门开源框架源码阅读经验的，都能猜出个大概。\n\n先从**IRouter**这个类创建*IRouterService*实例说起。使用过Retrofit的同学都知道，创建一个接口类，通过注解标注方法，不用提供具体的实现流程，就能完成网络请求。其实这并不难，这是通过动态代理实现的。我们来看IRouter.create的代码：\n\n```java\npublic <T> T create(Class<T> tClass) {\n  return (T) Proxy.newProxyInstance(tClass.getClassLoader(), new Class[]{tClass},\n    new InvocationHandler() {\n        @Override\n        public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n            return parseMethod(method, args);\n        }\n    });\n}\n```\n\n通过动态代理，我们创建了一个*IRouterService*的实现类，这个类在调用相关方法的时候，比如*topicDetail*这个方法，都会经由*InvocationHandler*的*invoke*方法来代理完成。\n\n接下来，从invoke中调用了parseMethod方法，这个方法比较简单，主要是用于解析方法注解和参数注解，取出其中的值，比如跳转路径path和参数的key - value键值对，**通过path查询出相对应的Activity的class**，这些值最终汇总起来，返回一个Navigator对象，这个就是真正要执行跳转的地方。\n\n上面提到*通过path查询出Activity对应的class*，既然要查询，肯定要事先存储后才能被查询到。这就涉及到**编译时**做的工作了。\n\n\n\n## 编译时\n\n### 一、APT部分\n\n其实读过其他一些开源框架的人对这部分一定不会陌生。\n\n这部分工作与ARouter类似，就是通过**@RoutePath**注解标记目标Activity，然后再通过注解处理器来获取到path - activity.class的对应关系，将这个对应关系，生成成一个类，我们查看一个生成的类的示例如下：\n\n```java\npackage com.github.boybeak.irouter.loader;\n\nimport com.github.boybeak.irouter.core.BaseLoader;\nimport java.lang.Override;\nimport java.lang.String;\n\npublic class V2ex$Topic$Loader extends BaseLoader {\n  @Override\n  public String getHeader() {\n    return \"topic\";\n  }\n\n  @Override\n  public void loadIntoMap() {\n    load(\"detail\", com.v2ex.activity.TopicActivity.class);\n  }\n}\n```\n\n这些所有生成的类在一个包名`com.github.boybeak.irouter.loader`底下，这很重要，因为我们要在接下来的过程，通过这个包名去筛选生成的loader类。\n\n理解这部分，需要对APT(注解处理器)和java poet比较了解。\n\n\n\n### 二、ASM部分\n\n不太了解ASM的，可以通过这篇文章[ASM库介绍与使用](https://boybeak.github.io/android/ASM.html)来了解，简单来说，ASM就是一款修改class文件的工具。能用来动态生成class文件，也可以修改已经存在的class文件。\n\n有这样的利器，我们能做的事就太多了。\n\n这部分，其实我就是参考了ARouter的做法，改成了自己的一些逻辑。\n\n接下来我们要编写的是一个gradle plugin，我们主要是利用其中的**Transform**工具，官方解释在[这里](https://developer.android.com/reference/tools/gradle-api/7.0/com/android/build/api/transform/Transform)，其作用就是在编译时，会挨个遍历我们的源码、类库、jar包等。附上一个教程[Gradle 学习之 Android 插件的 Transform API](https://juejin.cn/post/6844903891138674696)。\n\nPath - activity.class的对应关系是通过**LoaderManager**来查询的，我们看一下这个类的代码：\n\n```java\npublic final class LoaderManager {\n    private static final LoaderManager sManager = new LoaderManager();\n\n    public static LoaderManager getInstance() {\n        return sManager;\n    }\n\n    private final Map<String, DelegateLoader> loadersMap = new HashMap<>();\n    private boolean isInitialized = false;\n\n    private LoaderManager() {\n        init();\n    }\n\n    private void init() {\n        if (isInitialized) {\n            return;\n        }\n        load();\n        isInitialized = true;\n    }\n\n    private void load() {\n    }\n\n    private void loadInto(BaseLoader loader) {\n        String header = loader.getHeader();\n        obtainLoader(header).mergeOtherLoaders(loader);\n    }\n\n    private DelegateLoader obtainLoader(String header) {\n        DelegateLoader delegateLoader = loadersMap.get(header);\n        if (delegateLoader == null) {\n            delegateLoader = new DelegateLoader(header);\n            loadersMap.put(header, delegateLoader);\n        }\n        return delegateLoader;\n    }\n\n    public Class<?> get(String path) {\n        String[] segments = path.split(\"/\");\n        final String header = segments[0];\n        final String tail = segments[1];\n        return loadersMap.get(header).getTargetClass(tail);\n    }\n\n}\n```\n\n我们需要注意其中的一个方法——`load`，我们看到，这个类在构建方法里调用了init方法，init里又调用了load方法，但是这个load方法却是留白的。这样调用有什么用呢？\n\n其实这个留白方法是我们为ASM留的一个修改的入口。\n\n```groovy\napply plugin: 'i-router-register'\n```\n\n在app.gradle中，使用这个插件，我们的transform就能顺利运行起来发挥作用了。\n\n我们需要查看一下RegisterTransform的代码了：\n\n```java\npublic class RegisterTransform extends Transform {\n  @Override\n  public void transform(TransformInvocation transformInvocation) throws TransformException, InterruptedException, IOException {\n    super.transform(transformInvocation);\n\n    scanner.scan(transformInvocation, (loaderManagerJar, loaderManagerEntryName, loaders) -> {\n      Asm.getInstance().generateCode(loaderManagerJar, loaderManagerEntryName, loaders);\n    });\n  }\n}\n```\n\n这里使用了Scanner来扫描TransformInvocation类，Scanner是我们自定义的类，主要作用就是通过包名和类名，查找我们的loader类和LoaderManager所在的jar包。我们查看其scan方法：\n\n```java\nfor (TransformInput input : transformInvocation.getInputs()) {\n  for (JarInput jarInput : input.getJarInputs()) {\n    // 这里处理第三方类库，引用的module和jar文件\n  }\n  for (DirectoryInput directoryInput : input.getDirectoryInputs()) {\n    // 这里处理应用了这个plugin的module的相关class文件\n  }\n}\nonScanFinish.onScanFinish(loaderManagerJar, loaderManagerEntryName, loaderClzList);\n```\n\n通过回调，我们将查找到的loader类和LoaderManager所在jar返回给transform，并交由我们的asm工具来处理。\n\n```java\npublic class ASM {\n  private static class HackMethodVisitor extends MethodVisitor {\n\n    private List<String> loaders = null;\n\n    public HackMethodVisitor(int api, MethodVisitor methodVisitor, List<String> loaders) {\n      super(api, methodVisitor);\n      this.loaders = loaders;\n    }\n\n    @Override\n    public void visitInsn(int opcode) {\n      for (String loader : loaders) {\n        mv.visitVarInsn(Opcodes.ALOAD, 0);\n        mv.visitTypeInsn(Opcodes.NEW, loader);\n        mv.visitInsn(Opcodes.DUP);\n        mv.visitMethodInsn(Opcodes.INVOKESPECIAL, loader, \"<init>\", \"()V\", false);\n        mv.visitMethodInsn(Opcodes.INVOKESPECIAL, \"com/github/boybeak/irouter/core/LoaderManager\", \"loadInto\", \"(Lcom/github/boybeak/irouter/core/BaseLoader;)V\", false);\n      }\n\n      super.visitInsn(opcode);\n    }\n  }\n}\n```\n\n主要的修改逻辑就在HackMethodVisitor这个类中，注意其中的visitInsn方法，这就是ASM真正发挥作用的地方，这里的逻辑就是为loadInto方法添加加载loader的代码。\n\n以demo中的v2ex为例，修改后的代码load代码如下：\n\n![LoaderManager](/images/jd_loader_manager.jpg)\n\n\n\n## 最后一点细节\n\n到目前为止，主要的流程已经结束了，接下来是一些细节部分。\n\n- LoaderManager在加载loader的时候，会针对path做归并，比如同为app/main和app/user被归并为一组，这样在使用的时候，可以按组做实际载入。\n- 用于跳转的Navigator是有缓存的，用来减少查询次数，因为path - activity.class的对应关系并不是动态变化的，如果缓存中有已经用过的，则清空其intent的参数部分重复利用即可。\n- 对于startActivityForResult的集中调用，可以参考我的另外一个开源项目——[Starter](https://github.com/boybeak/Starter)中的SAFR项目。这里在FragmentActivity中，通过一个fragment去代理了startActivityForResult的过程，从而拦截了回调结果；类似的，在非FragmentActivity中，通过了一个全透明的代理了此过程，这里学习了**Glide**通过一个fragment来探测生命周期的方式。\n\n## 总结\n\n通过这样一个自己动手的过程，我们熟悉了的编写APT和gradle plugin的过程，学会了ASM的基本用法。\n\n在这个项目中，学习了很多其他优秀开源项目的经验，比如：\n\n- 主流程是参考了ARouter，但是去掉了应用启动时候，从codeDir找到apk来解析路由路径的过程；\n- 集中的api式调用，参考了Retrofit的动态代理；\n- 通过Fragment拦截startActivityForResult的结果，参考了Glide向宿主activity添加无UI的Fragment的方式。\n\n因此，多读源码可以开拓思维，当自己想开发自己的工具框架时候，就可以信手拈来。","source":"_posts/2022-09-17-手撸一个路由框架IRouter.md","raw":"---\nlayout: post\ntitle: IRouter——自己手撸一个路由框架\nauthor: boybeak\ncategory: 源码分析\ntags: Android\ndate: 2022-09-17 08:00:00\n---\n\n\n现在最流行的路由框架应该是阿里的ARouter，这几乎是组件化应用的必备了。但是ARouter用起来稍微有一点不爽，不爽在以下两点：\n\n1. 没有一个规范化的api式的调用方式：项目大了，调用路由的方法分布在项目各处，难以查找；\n2. 对startActivityForResult支持不够友好：按照传统方式，在onActivityResult中处理，比较分散。\n\n基于以上问题，闲来无事，手撸一个自己的路由框架[IRouter](https://github.com/boybeak/Routerfit)，基本使用方式如下：\n\n```kotlin\ninterface IRouterService {\n    @RouteTo(\"topic/detail\")\n    fun topicDetail(@Key(\"topic\") topic: Topic): Navigator\n}\n\nval iRouter = IRouter.Builder()\n    .isDebug(BuildConfig.DEBUG)\n    .errorActivity(ErrorActivity::class.java)\n    .build()\n    .create(IRouterService::class.java)\n\niRouter.topicDetail(topic).startActivity(this@MainActivity)\n\n// OR\n\niRouter.topicDetail(topic).startActivityForResult(this, 100) { requestCode, resultCode, data ->\n}\n```\n\n具体的配置方式请参考[IRouter](https://github.com/boybeak/Routerfit)，本文主要是解析源码。\n\n如此调用方式，很像是Retrofit的方式，打开一个activity就像请求一个api一样。从这里可以体现出解决了上述的两个痛点：\n\n1. 类似API的调用方式，集中管理路由路径；\n2. startActivityForResult中添加回调，哪里调用，就在哪里处理结果，结构紧凑。\n\n下面进入源码解析。\n\n与[ARouter源码分析](https://boybeak.github.io/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97/ARouter%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html)这篇文章一样，我们分析时候要按照时态去分析这个框架在**运行时**和**编译时**做的事情。\n\n## 运行时\n\n其实从上述调用的方式，有过热门开源框架源码阅读经验的，都能猜出个大概。\n\n先从**IRouter**这个类创建*IRouterService*实例说起。使用过Retrofit的同学都知道，创建一个接口类，通过注解标注方法，不用提供具体的实现流程，就能完成网络请求。其实这并不难，这是通过动态代理实现的。我们来看IRouter.create的代码：\n\n```java\npublic <T> T create(Class<T> tClass) {\n  return (T) Proxy.newProxyInstance(tClass.getClassLoader(), new Class[]{tClass},\n    new InvocationHandler() {\n        @Override\n        public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n            return parseMethod(method, args);\n        }\n    });\n}\n```\n\n通过动态代理，我们创建了一个*IRouterService*的实现类，这个类在调用相关方法的时候，比如*topicDetail*这个方法，都会经由*InvocationHandler*的*invoke*方法来代理完成。\n\n接下来，从invoke中调用了parseMethod方法，这个方法比较简单，主要是用于解析方法注解和参数注解，取出其中的值，比如跳转路径path和参数的key - value键值对，**通过path查询出相对应的Activity的class**，这些值最终汇总起来，返回一个Navigator对象，这个就是真正要执行跳转的地方。\n\n上面提到*通过path查询出Activity对应的class*，既然要查询，肯定要事先存储后才能被查询到。这就涉及到**编译时**做的工作了。\n\n\n\n## 编译时\n\n### 一、APT部分\n\n其实读过其他一些开源框架的人对这部分一定不会陌生。\n\n这部分工作与ARouter类似，就是通过**@RoutePath**注解标记目标Activity，然后再通过注解处理器来获取到path - activity.class的对应关系，将这个对应关系，生成成一个类，我们查看一个生成的类的示例如下：\n\n```java\npackage com.github.boybeak.irouter.loader;\n\nimport com.github.boybeak.irouter.core.BaseLoader;\nimport java.lang.Override;\nimport java.lang.String;\n\npublic class V2ex$Topic$Loader extends BaseLoader {\n  @Override\n  public String getHeader() {\n    return \"topic\";\n  }\n\n  @Override\n  public void loadIntoMap() {\n    load(\"detail\", com.v2ex.activity.TopicActivity.class);\n  }\n}\n```\n\n这些所有生成的类在一个包名`com.github.boybeak.irouter.loader`底下，这很重要，因为我们要在接下来的过程，通过这个包名去筛选生成的loader类。\n\n理解这部分，需要对APT(注解处理器)和java poet比较了解。\n\n\n\n### 二、ASM部分\n\n不太了解ASM的，可以通过这篇文章[ASM库介绍与使用](https://boybeak.github.io/android/ASM.html)来了解，简单来说，ASM就是一款修改class文件的工具。能用来动态生成class文件，也可以修改已经存在的class文件。\n\n有这样的利器，我们能做的事就太多了。\n\n这部分，其实我就是参考了ARouter的做法，改成了自己的一些逻辑。\n\n接下来我们要编写的是一个gradle plugin，我们主要是利用其中的**Transform**工具，官方解释在[这里](https://developer.android.com/reference/tools/gradle-api/7.0/com/android/build/api/transform/Transform)，其作用就是在编译时，会挨个遍历我们的源码、类库、jar包等。附上一个教程[Gradle 学习之 Android 插件的 Transform API](https://juejin.cn/post/6844903891138674696)。\n\nPath - activity.class的对应关系是通过**LoaderManager**来查询的，我们看一下这个类的代码：\n\n```java\npublic final class LoaderManager {\n    private static final LoaderManager sManager = new LoaderManager();\n\n    public static LoaderManager getInstance() {\n        return sManager;\n    }\n\n    private final Map<String, DelegateLoader> loadersMap = new HashMap<>();\n    private boolean isInitialized = false;\n\n    private LoaderManager() {\n        init();\n    }\n\n    private void init() {\n        if (isInitialized) {\n            return;\n        }\n        load();\n        isInitialized = true;\n    }\n\n    private void load() {\n    }\n\n    private void loadInto(BaseLoader loader) {\n        String header = loader.getHeader();\n        obtainLoader(header).mergeOtherLoaders(loader);\n    }\n\n    private DelegateLoader obtainLoader(String header) {\n        DelegateLoader delegateLoader = loadersMap.get(header);\n        if (delegateLoader == null) {\n            delegateLoader = new DelegateLoader(header);\n            loadersMap.put(header, delegateLoader);\n        }\n        return delegateLoader;\n    }\n\n    public Class<?> get(String path) {\n        String[] segments = path.split(\"/\");\n        final String header = segments[0];\n        final String tail = segments[1];\n        return loadersMap.get(header).getTargetClass(tail);\n    }\n\n}\n```\n\n我们需要注意其中的一个方法——`load`，我们看到，这个类在构建方法里调用了init方法，init里又调用了load方法，但是这个load方法却是留白的。这样调用有什么用呢？\n\n其实这个留白方法是我们为ASM留的一个修改的入口。\n\n```groovy\napply plugin: 'i-router-register'\n```\n\n在app.gradle中，使用这个插件，我们的transform就能顺利运行起来发挥作用了。\n\n我们需要查看一下RegisterTransform的代码了：\n\n```java\npublic class RegisterTransform extends Transform {\n  @Override\n  public void transform(TransformInvocation transformInvocation) throws TransformException, InterruptedException, IOException {\n    super.transform(transformInvocation);\n\n    scanner.scan(transformInvocation, (loaderManagerJar, loaderManagerEntryName, loaders) -> {\n      Asm.getInstance().generateCode(loaderManagerJar, loaderManagerEntryName, loaders);\n    });\n  }\n}\n```\n\n这里使用了Scanner来扫描TransformInvocation类，Scanner是我们自定义的类，主要作用就是通过包名和类名，查找我们的loader类和LoaderManager所在的jar包。我们查看其scan方法：\n\n```java\nfor (TransformInput input : transformInvocation.getInputs()) {\n  for (JarInput jarInput : input.getJarInputs()) {\n    // 这里处理第三方类库，引用的module和jar文件\n  }\n  for (DirectoryInput directoryInput : input.getDirectoryInputs()) {\n    // 这里处理应用了这个plugin的module的相关class文件\n  }\n}\nonScanFinish.onScanFinish(loaderManagerJar, loaderManagerEntryName, loaderClzList);\n```\n\n通过回调，我们将查找到的loader类和LoaderManager所在jar返回给transform，并交由我们的asm工具来处理。\n\n```java\npublic class ASM {\n  private static class HackMethodVisitor extends MethodVisitor {\n\n    private List<String> loaders = null;\n\n    public HackMethodVisitor(int api, MethodVisitor methodVisitor, List<String> loaders) {\n      super(api, methodVisitor);\n      this.loaders = loaders;\n    }\n\n    @Override\n    public void visitInsn(int opcode) {\n      for (String loader : loaders) {\n        mv.visitVarInsn(Opcodes.ALOAD, 0);\n        mv.visitTypeInsn(Opcodes.NEW, loader);\n        mv.visitInsn(Opcodes.DUP);\n        mv.visitMethodInsn(Opcodes.INVOKESPECIAL, loader, \"<init>\", \"()V\", false);\n        mv.visitMethodInsn(Opcodes.INVOKESPECIAL, \"com/github/boybeak/irouter/core/LoaderManager\", \"loadInto\", \"(Lcom/github/boybeak/irouter/core/BaseLoader;)V\", false);\n      }\n\n      super.visitInsn(opcode);\n    }\n  }\n}\n```\n\n主要的修改逻辑就在HackMethodVisitor这个类中，注意其中的visitInsn方法，这就是ASM真正发挥作用的地方，这里的逻辑就是为loadInto方法添加加载loader的代码。\n\n以demo中的v2ex为例，修改后的代码load代码如下：\n\n![LoaderManager](/images/jd_loader_manager.jpg)\n\n\n\n## 最后一点细节\n\n到目前为止，主要的流程已经结束了，接下来是一些细节部分。\n\n- LoaderManager在加载loader的时候，会针对path做归并，比如同为app/main和app/user被归并为一组，这样在使用的时候，可以按组做实际载入。\n- 用于跳转的Navigator是有缓存的，用来减少查询次数，因为path - activity.class的对应关系并不是动态变化的，如果缓存中有已经用过的，则清空其intent的参数部分重复利用即可。\n- 对于startActivityForResult的集中调用，可以参考我的另外一个开源项目——[Starter](https://github.com/boybeak/Starter)中的SAFR项目。这里在FragmentActivity中，通过一个fragment去代理了startActivityForResult的过程，从而拦截了回调结果；类似的，在非FragmentActivity中，通过了一个全透明的代理了此过程，这里学习了**Glide**通过一个fragment来探测生命周期的方式。\n\n## 总结\n\n通过这样一个自己动手的过程，我们熟悉了的编写APT和gradle plugin的过程，学会了ASM的基本用法。\n\n在这个项目中，学习了很多其他优秀开源项目的经验，比如：\n\n- 主流程是参考了ARouter，但是去掉了应用启动时候，从codeDir找到apk来解析路由路径的过程；\n- 集中的api式调用，参考了Retrofit的动态代理；\n- 通过Fragment拦截startActivityForResult的结果，参考了Glide向宿主activity添加无UI的Fragment的方式。\n\n因此，多读源码可以开拓思维，当自己想开发自己的工具框架时候，就可以信手拈来。","slug":"2022-09-17-手撸一个路由框架IRouter","published":1,"updated":"2024-11-13T13:40:08.741Z","_id":"cm1ltr0fz000ibji02cwr643p","comments":1,"photos":["/images/jd_loader_manager.jpg"],"content":"<p>现在最流行的路由框架应该是阿里的ARouter，这几乎是组件化应用的必备了。但是ARouter用起来稍微有一点不爽，不爽在以下两点：</p>\n<ol>\n<li>没有一个规范化的api式的调用方式：项目大了，调用路由的方法分布在项目各处，难以查找；</li>\n<li>对startActivityForResult支持不够友好：按照传统方式，在onActivityResult中处理，比较分散。</li>\n</ol>\n<p>基于以上问题，闲来无事，手撸一个自己的路由框架<a href=\"https://github.com/boybeak/Routerfit\">IRouter</a>，基本使用方式如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">interface</span> IRouterService <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token annotation builtin\">@RouteTo</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"topic/detail\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">topicDetail</span><span class=\"token punctuation\">(</span><span class=\"token annotation builtin\">@Key</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"topic\"</span></span><span class=\"token punctuation\">)</span> topic<span class=\"token operator\">:</span> Topic<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Navigator\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">val</span> iRouter <span class=\"token operator\">=</span> IRouter<span class=\"token punctuation\">.</span><span class=\"token function\">Builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">isDebug</span><span class=\"token punctuation\">(</span>BuildConfig<span class=\"token punctuation\">.</span>DEBUG<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">errorActivity</span><span class=\"token punctuation\">(</span>ErrorActivity<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>IRouterService<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span>\n\niRouter<span class=\"token punctuation\">.</span><span class=\"token function\">topicDetail</span><span class=\"token punctuation\">(</span>topic<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">startActivity</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token label symbol\">@MainActivity</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// OR</span>\n\niRouter<span class=\"token punctuation\">.</span><span class=\"token function\">topicDetail</span><span class=\"token punctuation\">(</span>topic<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">startActivityForResult</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> requestCode<span class=\"token punctuation\">,</span> resultCode<span class=\"token punctuation\">,</span> <span class=\"token keyword\">data</span> <span class=\"token operator\">-></span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>具体的配置方式请参考<a href=\"https://github.com/boybeak/Routerfit\">IRouter</a>，本文主要是解析源码。</p>\n<p>如此调用方式，很像是Retrofit的方式，打开一个activity就像请求一个api一样。从这里可以体现出解决了上述的两个痛点：</p>\n<ol>\n<li>类似API的调用方式，集中管理路由路径；</li>\n<li>startActivityForResult中添加回调，哪里调用，就在哪里处理结果，结构紧凑。</li>\n</ol>\n<p>下面进入源码解析。</p>\n<p>与<a href=\"https://boybeak.github.io/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97/ARouter%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html\">ARouter源码分析</a>这篇文章一样，我们分析时候要按照时态去分析这个框架在<strong>运行时</strong>和<strong>编译时</strong>做的事情。</p>\n<h2 id=\"运行时\"><a href=\"#运行时\" class=\"headerlink\" title=\"运行时\"></a>运行时</h2><p>其实从上述调用的方式，有过热门开源框架源码阅读经验的，都能猜出个大概。</p>\n<p>先从<strong>IRouter</strong>这个类创建<em>IRouterService</em>实例说起。使用过Retrofit的同学都知道，创建一个接口类，通过注解标注方法，不用提供具体的实现流程，就能完成网络请求。其实这并不难，这是通过动态代理实现的。我们来看IRouter.create的代码：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">T</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> tClass<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">.</span><span class=\"token function\">newProxyInstance</span><span class=\"token punctuation\">(</span>tClass<span class=\"token punctuation\">.</span><span class=\"token function\">getClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span>tClass<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvocationHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> proxy<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Method</span> method<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Throwable</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">parseMethod</span><span class=\"token punctuation\">(</span>method<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>通过动态代理，我们创建了一个<em>IRouterService</em>的实现类，这个类在调用相关方法的时候，比如<em>topicDetail</em>这个方法，都会经由<em>InvocationHandler</em>的<em>invoke</em>方法来代理完成。</p>\n<p>接下来，从invoke中调用了parseMethod方法，这个方法比较简单，主要是用于解析方法注解和参数注解，取出其中的值，比如跳转路径path和参数的key - value键值对，<strong>通过path查询出相对应的Activity的class</strong>，这些值最终汇总起来，返回一个Navigator对象，这个就是真正要执行跳转的地方。</p>\n<p>上面提到<em>通过path查询出Activity对应的class</em>，既然要查询，肯定要事先存储后才能被查询到。这就涉及到<strong>编译时</strong>做的工作了。</p>\n<h2 id=\"编译时\"><a href=\"#编译时\" class=\"headerlink\" title=\"编译时\"></a>编译时</h2><h3 id=\"一、APT部分\"><a href=\"#一、APT部分\" class=\"headerlink\" title=\"一、APT部分\"></a>一、APT部分</h3><p>其实读过其他一些开源框架的人对这部分一定不会陌生。</p>\n<p>这部分工作与ARouter类似，就是通过**@RoutePath**注解标记目标Activity，然后再通过注解处理器来获取到path - activity.class的对应关系，将这个对应关系，生成成一个类，我们查看一个生成的类的示例如下：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>github<span class=\"token punctuation\">.</span>boybeak<span class=\"token punctuation\">.</span>irouter<span class=\"token punctuation\">.</span>loader</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>github<span class=\"token punctuation\">.</span>boybeak<span class=\"token punctuation\">.</span>irouter<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">BaseLoader</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Override</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">String</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">V2ex</span>$<span class=\"token class-name\">Topic</span>$<span class=\"token class-name\">Loader</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseLoader</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">loadIntoMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"detail\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>v2ex<span class=\"token punctuation\">.</span>activity<span class=\"token punctuation\">.</span></span>TopicActivity</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这些所有生成的类在一个包名<code>com.github.boybeak.irouter.loader</code>底下，这很重要，因为我们要在接下来的过程，通过这个包名去筛选生成的loader类。</p>\n<p>理解这部分，需要对APT(注解处理器)和java poet比较了解。</p>\n<h3 id=\"二、ASM部分\"><a href=\"#二、ASM部分\" class=\"headerlink\" title=\"二、ASM部分\"></a>二、ASM部分</h3><p>不太了解ASM的，可以通过这篇文章<a href=\"https://boybeak.github.io/android/ASM.html\">ASM库介绍与使用</a>来了解，简单来说，ASM就是一款修改class文件的工具。能用来动态生成class文件，也可以修改已经存在的class文件。</p>\n<p>有这样的利器，我们能做的事就太多了。</p>\n<p>这部分，其实我就是参考了ARouter的做法，改成了自己的一些逻辑。</p>\n<p>接下来我们要编写的是一个gradle plugin，我们主要是利用其中的<strong>Transform</strong>工具，官方解释在<a href=\"https://developer.android.com/reference/tools/gradle-api/7.0/com/android/build/api/transform/Transform\">这里</a>，其作用就是在编译时，会挨个遍历我们的源码、类库、jar包等。附上一个教程<a href=\"https://juejin.cn/post/6844903891138674696\">Gradle 学习之 Android 插件的 Transform API</a>。</p>\n<p>Path - activity.class的对应关系是通过<strong>LoaderManager</strong>来查询的，我们看一下这个类的代码：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LoaderManager</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">LoaderManager</span> sManager <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LoaderManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">LoaderManager</span> <span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> sManager<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">DelegateLoader</span><span class=\"token punctuation\">></span></span> loadersMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> isInitialized <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LoaderManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isInitialized<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        isInitialized <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">loadInto</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BaseLoader</span> loader<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">String</span> header <span class=\"token operator\">=</span> loader<span class=\"token punctuation\">.</span><span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">obtainLoader</span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mergeOtherLoaders</span><span class=\"token punctuation\">(</span>loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">DelegateLoader</span> <span class=\"token function\">obtainLoader</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> header<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">DelegateLoader</span> delegateLoader <span class=\"token operator\">=</span> loadersMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>delegateLoader <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            delegateLoader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DelegateLoader</span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            loadersMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">,</span> delegateLoader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token keyword\">return</span> delegateLoader<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> segments <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> header <span class=\"token operator\">=</span> segments<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> tail <span class=\"token operator\">=</span> segments<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> loadersMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTargetClass</span><span class=\"token punctuation\">(</span>tail<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们需要注意其中的一个方法——<code>load</code>，我们看到，这个类在构建方法里调用了init方法，init里又调用了load方法，但是这个load方法却是留白的。这样调用有什么用呢？</p>\n<p>其实这个留白方法是我们为ASM留的一个修改的入口。</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">apply plugin<span class=\"token punctuation\">:</span> <span class=\"token string\">'i-router-register'</span></code></pre>\n\n<p>在app.gradle中，使用这个插件，我们的transform就能顺利运行起来发挥作用了。</p>\n<p>我们需要查看一下RegisterTransform的代码了：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RegisterTransform</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Transform</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">transform</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TransformInvocation</span> transformInvocation<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">TransformException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InterruptedException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">transform</span><span class=\"token punctuation\">(</span>transformInvocation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    scanner<span class=\"token punctuation\">.</span><span class=\"token function\">scan</span><span class=\"token punctuation\">(</span>transformInvocation<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>loaderManagerJar<span class=\"token punctuation\">,</span> loaderManagerEntryName<span class=\"token punctuation\">,</span> loaders<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token class-name\">Asm</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">generateCode</span><span class=\"token punctuation\">(</span>loaderManagerJar<span class=\"token punctuation\">,</span> loaderManagerEntryName<span class=\"token punctuation\">,</span> loaders<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里使用了Scanner来扫描TransformInvocation类，Scanner是我们自定义的类，主要作用就是通过包名和类名，查找我们的loader类和LoaderManager所在的jar包。我们查看其scan方法：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">TransformInput</span> input <span class=\"token operator\">:</span> transformInvocation<span class=\"token punctuation\">.</span><span class=\"token function\">getInputs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">JarInput</span> jarInput <span class=\"token operator\">:</span> input<span class=\"token punctuation\">.</span><span class=\"token function\">getJarInputs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 这里处理第三方类库，引用的module和jar文件</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">DirectoryInput</span> directoryInput <span class=\"token operator\">:</span> input<span class=\"token punctuation\">.</span><span class=\"token function\">getDirectoryInputs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 这里处理应用了这个plugin的module的相关class文件</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\nonScanFinish<span class=\"token punctuation\">.</span><span class=\"token function\">onScanFinish</span><span class=\"token punctuation\">(</span>loaderManagerJar<span class=\"token punctuation\">,</span> loaderManagerEntryName<span class=\"token punctuation\">,</span> loaderClzList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>通过回调，我们将查找到的loader类和LoaderManager所在jar返回给transform，并交由我们的asm工具来处理。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ASM</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HackMethodVisitor</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">MethodVisitor</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> loaders <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">HackMethodVisitor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> api<span class=\"token punctuation\">,</span> <span class=\"token class-name\">MethodVisitor</span> methodVisitor<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> loaders<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>api<span class=\"token punctuation\">,</span> methodVisitor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>loaders <span class=\"token operator\">=</span> loaders<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">visitInsn</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> opcode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> loader <span class=\"token operator\">:</span> loaders<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitVarInsn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ALOAD</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitTypeInsn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NEW</span><span class=\"token punctuation\">,</span> loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitInsn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">DUP</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INVOKESPECIAL</span><span class=\"token punctuation\">,</span> loader<span class=\"token punctuation\">,</span> <span class=\"token string\">\"&lt;init>\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"()V\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INVOKESPECIAL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"com/github/boybeak/irouter/core/LoaderManager\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"loadInto\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"(Lcom/github/boybeak/irouter/core/BaseLoader;)V\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n\n      <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">visitInsn</span><span class=\"token punctuation\">(</span>opcode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>主要的修改逻辑就在HackMethodVisitor这个类中，注意其中的visitInsn方法，这就是ASM真正发挥作用的地方，这里的逻辑就是为loadInto方法添加加载loader的代码。</p>\n<p>以demo中的v2ex为例，修改后的代码load代码如下：</p>\n<p><img src=\"/images/jd_loader_manager.jpg\" alt=\"LoaderManager\"></p>\n<h2 id=\"最后一点细节\"><a href=\"#最后一点细节\" class=\"headerlink\" title=\"最后一点细节\"></a>最后一点细节</h2><p>到目前为止，主要的流程已经结束了，接下来是一些细节部分。</p>\n<ul>\n<li>LoaderManager在加载loader的时候，会针对path做归并，比如同为app&#x2F;main和app&#x2F;user被归并为一组，这样在使用的时候，可以按组做实际载入。</li>\n<li>用于跳转的Navigator是有缓存的，用来减少查询次数，因为path - activity.class的对应关系并不是动态变化的，如果缓存中有已经用过的，则清空其intent的参数部分重复利用即可。</li>\n<li>对于startActivityForResult的集中调用，可以参考我的另外一个开源项目——<a href=\"https://github.com/boybeak/Starter\">Starter</a>中的SAFR项目。这里在FragmentActivity中，通过一个fragment去代理了startActivityForResult的过程，从而拦截了回调结果；类似的，在非FragmentActivity中，通过了一个全透明的代理了此过程，这里学习了<strong>Glide</strong>通过一个fragment来探测生命周期的方式。</li>\n</ul>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>通过这样一个自己动手的过程，我们熟悉了的编写APT和gradle plugin的过程，学会了ASM的基本用法。</p>\n<p>在这个项目中，学习了很多其他优秀开源项目的经验，比如：</p>\n<ul>\n<li>主流程是参考了ARouter，但是去掉了应用启动时候，从codeDir找到apk来解析路由路径的过程；</li>\n<li>集中的api式调用，参考了Retrofit的动态代理；</li>\n<li>通过Fragment拦截startActivityForResult的结果，参考了Glide向宿主activity添加无UI的Fragment的方式。</li>\n</ul>\n<p>因此，多读源码可以开拓思维，当自己想开发自己的工具框架时候，就可以信手拈来。</p>\n","excerpt":"","more":"<p>现在最流行的路由框架应该是阿里的ARouter，这几乎是组件化应用的必备了。但是ARouter用起来稍微有一点不爽，不爽在以下两点：</p>\n<ol>\n<li>没有一个规范化的api式的调用方式：项目大了，调用路由的方法分布在项目各处，难以查找；</li>\n<li>对startActivityForResult支持不够友好：按照传统方式，在onActivityResult中处理，比较分散。</li>\n</ol>\n<p>基于以上问题，闲来无事，手撸一个自己的路由框架<a href=\"https://github.com/boybeak/Routerfit\">IRouter</a>，基本使用方式如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">interface</span> IRouterService <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token annotation builtin\">@RouteTo</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"topic/detail\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">topicDetail</span><span class=\"token punctuation\">(</span><span class=\"token annotation builtin\">@Key</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"topic\"</span></span><span class=\"token punctuation\">)</span> topic<span class=\"token operator\">:</span> Topic<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Navigator\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">val</span> iRouter <span class=\"token operator\">=</span> IRouter<span class=\"token punctuation\">.</span><span class=\"token function\">Builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">isDebug</span><span class=\"token punctuation\">(</span>BuildConfig<span class=\"token punctuation\">.</span>DEBUG<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">errorActivity</span><span class=\"token punctuation\">(</span>ErrorActivity<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>IRouterService<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span>\n\niRouter<span class=\"token punctuation\">.</span><span class=\"token function\">topicDetail</span><span class=\"token punctuation\">(</span>topic<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">startActivity</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token label symbol\">@MainActivity</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// OR</span>\n\niRouter<span class=\"token punctuation\">.</span><span class=\"token function\">topicDetail</span><span class=\"token punctuation\">(</span>topic<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">startActivityForResult</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> requestCode<span class=\"token punctuation\">,</span> resultCode<span class=\"token punctuation\">,</span> <span class=\"token keyword\">data</span> <span class=\"token operator\">-></span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>具体的配置方式请参考<a href=\"https://github.com/boybeak/Routerfit\">IRouter</a>，本文主要是解析源码。</p>\n<p>如此调用方式，很像是Retrofit的方式，打开一个activity就像请求一个api一样。从这里可以体现出解决了上述的两个痛点：</p>\n<ol>\n<li>类似API的调用方式，集中管理路由路径；</li>\n<li>startActivityForResult中添加回调，哪里调用，就在哪里处理结果，结构紧凑。</li>\n</ol>\n<p>下面进入源码解析。</p>\n<p>与<a href=\"https://boybeak.github.io/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97/ARouter%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html\">ARouter源码分析</a>这篇文章一样，我们分析时候要按照时态去分析这个框架在<strong>运行时</strong>和<strong>编译时</strong>做的事情。</p>\n<h2 id=\"运行时\"><a href=\"#运行时\" class=\"headerlink\" title=\"运行时\"></a>运行时</h2><p>其实从上述调用的方式，有过热门开源框架源码阅读经验的，都能猜出个大概。</p>\n<p>先从<strong>IRouter</strong>这个类创建<em>IRouterService</em>实例说起。使用过Retrofit的同学都知道，创建一个接口类，通过注解标注方法，不用提供具体的实现流程，就能完成网络请求。其实这并不难，这是通过动态代理实现的。我们来看IRouter.create的代码：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">T</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> tClass<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">.</span><span class=\"token function\">newProxyInstance</span><span class=\"token punctuation\">(</span>tClass<span class=\"token punctuation\">.</span><span class=\"token function\">getClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span>tClass<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvocationHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> proxy<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Method</span> method<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Throwable</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">parseMethod</span><span class=\"token punctuation\">(</span>method<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>通过动态代理，我们创建了一个<em>IRouterService</em>的实现类，这个类在调用相关方法的时候，比如<em>topicDetail</em>这个方法，都会经由<em>InvocationHandler</em>的<em>invoke</em>方法来代理完成。</p>\n<p>接下来，从invoke中调用了parseMethod方法，这个方法比较简单，主要是用于解析方法注解和参数注解，取出其中的值，比如跳转路径path和参数的key - value键值对，<strong>通过path查询出相对应的Activity的class</strong>，这些值最终汇总起来，返回一个Navigator对象，这个就是真正要执行跳转的地方。</p>\n<p>上面提到<em>通过path查询出Activity对应的class</em>，既然要查询，肯定要事先存储后才能被查询到。这就涉及到<strong>编译时</strong>做的工作了。</p>\n<h2 id=\"编译时\"><a href=\"#编译时\" class=\"headerlink\" title=\"编译时\"></a>编译时</h2><h3 id=\"一、APT部分\"><a href=\"#一、APT部分\" class=\"headerlink\" title=\"一、APT部分\"></a>一、APT部分</h3><p>其实读过其他一些开源框架的人对这部分一定不会陌生。</p>\n<p>这部分工作与ARouter类似，就是通过**@RoutePath**注解标记目标Activity，然后再通过注解处理器来获取到path - activity.class的对应关系，将这个对应关系，生成成一个类，我们查看一个生成的类的示例如下：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>github<span class=\"token punctuation\">.</span>boybeak<span class=\"token punctuation\">.</span>irouter<span class=\"token punctuation\">.</span>loader</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>github<span class=\"token punctuation\">.</span>boybeak<span class=\"token punctuation\">.</span>irouter<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">BaseLoader</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Override</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">String</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">V2ex</span>$<span class=\"token class-name\">Topic</span>$<span class=\"token class-name\">Loader</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseLoader</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">loadIntoMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"detail\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>v2ex<span class=\"token punctuation\">.</span>activity<span class=\"token punctuation\">.</span></span>TopicActivity</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这些所有生成的类在一个包名<code>com.github.boybeak.irouter.loader</code>底下，这很重要，因为我们要在接下来的过程，通过这个包名去筛选生成的loader类。</p>\n<p>理解这部分，需要对APT(注解处理器)和java poet比较了解。</p>\n<h3 id=\"二、ASM部分\"><a href=\"#二、ASM部分\" class=\"headerlink\" title=\"二、ASM部分\"></a>二、ASM部分</h3><p>不太了解ASM的，可以通过这篇文章<a href=\"https://boybeak.github.io/android/ASM.html\">ASM库介绍与使用</a>来了解，简单来说，ASM就是一款修改class文件的工具。能用来动态生成class文件，也可以修改已经存在的class文件。</p>\n<p>有这样的利器，我们能做的事就太多了。</p>\n<p>这部分，其实我就是参考了ARouter的做法，改成了自己的一些逻辑。</p>\n<p>接下来我们要编写的是一个gradle plugin，我们主要是利用其中的<strong>Transform</strong>工具，官方解释在<a href=\"https://developer.android.com/reference/tools/gradle-api/7.0/com/android/build/api/transform/Transform\">这里</a>，其作用就是在编译时，会挨个遍历我们的源码、类库、jar包等。附上一个教程<a href=\"https://juejin.cn/post/6844903891138674696\">Gradle 学习之 Android 插件的 Transform API</a>。</p>\n<p>Path - activity.class的对应关系是通过<strong>LoaderManager</strong>来查询的，我们看一下这个类的代码：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LoaderManager</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">LoaderManager</span> sManager <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LoaderManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">LoaderManager</span> <span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> sManager<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">DelegateLoader</span><span class=\"token punctuation\">></span></span> loadersMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> isInitialized <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LoaderManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isInitialized<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        isInitialized <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">loadInto</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BaseLoader</span> loader<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">String</span> header <span class=\"token operator\">=</span> loader<span class=\"token punctuation\">.</span><span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">obtainLoader</span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mergeOtherLoaders</span><span class=\"token punctuation\">(</span>loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">DelegateLoader</span> <span class=\"token function\">obtainLoader</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> header<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">DelegateLoader</span> delegateLoader <span class=\"token operator\">=</span> loadersMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>delegateLoader <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            delegateLoader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DelegateLoader</span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            loadersMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">,</span> delegateLoader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token keyword\">return</span> delegateLoader<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> segments <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> header <span class=\"token operator\">=</span> segments<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> tail <span class=\"token operator\">=</span> segments<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> loadersMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTargetClass</span><span class=\"token punctuation\">(</span>tail<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们需要注意其中的一个方法——<code>load</code>，我们看到，这个类在构建方法里调用了init方法，init里又调用了load方法，但是这个load方法却是留白的。这样调用有什么用呢？</p>\n<p>其实这个留白方法是我们为ASM留的一个修改的入口。</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">apply plugin<span class=\"token punctuation\">:</span> <span class=\"token string\">'i-router-register'</span></code></pre>\n\n<p>在app.gradle中，使用这个插件，我们的transform就能顺利运行起来发挥作用了。</p>\n<p>我们需要查看一下RegisterTransform的代码了：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RegisterTransform</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Transform</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">transform</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TransformInvocation</span> transformInvocation<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">TransformException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InterruptedException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">transform</span><span class=\"token punctuation\">(</span>transformInvocation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    scanner<span class=\"token punctuation\">.</span><span class=\"token function\">scan</span><span class=\"token punctuation\">(</span>transformInvocation<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>loaderManagerJar<span class=\"token punctuation\">,</span> loaderManagerEntryName<span class=\"token punctuation\">,</span> loaders<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token class-name\">Asm</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">generateCode</span><span class=\"token punctuation\">(</span>loaderManagerJar<span class=\"token punctuation\">,</span> loaderManagerEntryName<span class=\"token punctuation\">,</span> loaders<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里使用了Scanner来扫描TransformInvocation类，Scanner是我们自定义的类，主要作用就是通过包名和类名，查找我们的loader类和LoaderManager所在的jar包。我们查看其scan方法：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">TransformInput</span> input <span class=\"token operator\">:</span> transformInvocation<span class=\"token punctuation\">.</span><span class=\"token function\">getInputs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">JarInput</span> jarInput <span class=\"token operator\">:</span> input<span class=\"token punctuation\">.</span><span class=\"token function\">getJarInputs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 这里处理第三方类库，引用的module和jar文件</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">DirectoryInput</span> directoryInput <span class=\"token operator\">:</span> input<span class=\"token punctuation\">.</span><span class=\"token function\">getDirectoryInputs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 这里处理应用了这个plugin的module的相关class文件</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\nonScanFinish<span class=\"token punctuation\">.</span><span class=\"token function\">onScanFinish</span><span class=\"token punctuation\">(</span>loaderManagerJar<span class=\"token punctuation\">,</span> loaderManagerEntryName<span class=\"token punctuation\">,</span> loaderClzList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>通过回调，我们将查找到的loader类和LoaderManager所在jar返回给transform，并交由我们的asm工具来处理。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ASM</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HackMethodVisitor</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">MethodVisitor</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> loaders <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">HackMethodVisitor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> api<span class=\"token punctuation\">,</span> <span class=\"token class-name\">MethodVisitor</span> methodVisitor<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> loaders<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>api<span class=\"token punctuation\">,</span> methodVisitor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>loaders <span class=\"token operator\">=</span> loaders<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">visitInsn</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> opcode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> loader <span class=\"token operator\">:</span> loaders<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitVarInsn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ALOAD</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitTypeInsn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NEW</span><span class=\"token punctuation\">,</span> loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitInsn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">DUP</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INVOKESPECIAL</span><span class=\"token punctuation\">,</span> loader<span class=\"token punctuation\">,</span> <span class=\"token string\">\"&lt;init>\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"()V\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INVOKESPECIAL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"com/github/boybeak/irouter/core/LoaderManager\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"loadInto\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"(Lcom/github/boybeak/irouter/core/BaseLoader;)V\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">&#125;</span>\n\n      <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">visitInsn</span><span class=\"token punctuation\">(</span>opcode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>主要的修改逻辑就在HackMethodVisitor这个类中，注意其中的visitInsn方法，这就是ASM真正发挥作用的地方，这里的逻辑就是为loadInto方法添加加载loader的代码。</p>\n<p>以demo中的v2ex为例，修改后的代码load代码如下：</p>\n<p><img src=\"/images/jd_loader_manager.jpg\" alt=\"LoaderManager\"></p>\n<h2 id=\"最后一点细节\"><a href=\"#最后一点细节\" class=\"headerlink\" title=\"最后一点细节\"></a>最后一点细节</h2><p>到目前为止，主要的流程已经结束了，接下来是一些细节部分。</p>\n<ul>\n<li>LoaderManager在加载loader的时候，会针对path做归并，比如同为app&#x2F;main和app&#x2F;user被归并为一组，这样在使用的时候，可以按组做实际载入。</li>\n<li>用于跳转的Navigator是有缓存的，用来减少查询次数，因为path - activity.class的对应关系并不是动态变化的，如果缓存中有已经用过的，则清空其intent的参数部分重复利用即可。</li>\n<li>对于startActivityForResult的集中调用，可以参考我的另外一个开源项目——<a href=\"https://github.com/boybeak/Starter\">Starter</a>中的SAFR项目。这里在FragmentActivity中，通过一个fragment去代理了startActivityForResult的过程，从而拦截了回调结果；类似的，在非FragmentActivity中，通过了一个全透明的代理了此过程，这里学习了<strong>Glide</strong>通过一个fragment来探测生命周期的方式。</li>\n</ul>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>通过这样一个自己动手的过程，我们熟悉了的编写APT和gradle plugin的过程，学会了ASM的基本用法。</p>\n<p>在这个项目中，学习了很多其他优秀开源项目的经验，比如：</p>\n<ul>\n<li>主流程是参考了ARouter，但是去掉了应用启动时候，从codeDir找到apk来解析路由路径的过程；</li>\n<li>集中的api式调用，参考了Retrofit的动态代理；</li>\n<li>通过Fragment拦截startActivityForResult的结果，参考了Glide向宿主activity添加无UI的Fragment的方式。</li>\n</ul>\n<p>因此，多读源码可以开拓思维，当自己想开发自己的工具框架时候，就可以信手拈来。</p>\n"},{"layout":"post","title":"AMS启动流程","author":"boybeak","date":"2022-09-18T17:00:00.000Z","_content":"\n\nAMS是ActivityManagerService的简称，看名字，似乎是Activity的manager，实际上，它管理的可不只是Activity。\n\n## 系统启动流程\n\n```mermaid\ngraph TD;\n    style A fill:#fff\n    style F fill:#5befb9\n    Z{{Boot ROM}} --> A([Boot Loader]);\n    A --> B(Kernel);\n    B --> C(\"init(pid=1)/C++ Framework Native\");\n    C --> D(Zygote/Android Runtime);\n    D --> E(System Server/Java Framework);\n    E --> F(Apps);\n```\n\n> **面试题：一个应用启动，为什么不从init进程或者SystemServer进程fork，而是从Zygote进程fork。**\n>\n> *Zygote作为一个孵化器，可以提前加载一些资源，这样fork时给予[Copy-on-Write](https://zhuanlan.zhihu.com/p/48147304)机制创建的其他进程能够直接利用这些资源，而不用重新加载。比如system_server就可以直接使用Zygote中的JNI函数、共享库、常用的类以及主题资源。*\n>\n> *SystemServer相比Zygote多运行了AMS、WMS等服务，这些对于一个应用程序来说是不需要的，另外fork对多线程不友好，仅会将发起调用的线程拷贝到子进程，这可能会导致死锁，而SystemServer中肯定是有很多多线程的。*\n>\n> **如何导致死锁的？**\n>\n> 在POSIX标准中，fork行为是这样的：赋值整个用户空间的数据（通常使用copy-on-write的策略，所以可以实现速度很快）以及所有系统对象，然后仅复制当前线程到子进程。这里：所有父进程中别的线程，到了子进程都是突然蒸发掉的。\n>\n> 对于锁来说，从OS看，每个锁都有一个所有者，即最后依次lock它的线程。假设这样一个环境，在fork之前，有一个子线程lock了某个锁，获得了对锁的所有权，fork以后，在子进程中，所有的额外线程都人间蒸发了，而锁却被正常赋值了，在子进程看来，这个锁没有主人，所以没有任何人可以对它解锁，当子进程中的某个线程想lock这个锁时候，不再有任何手段可以解开了，程序发生死锁。\n\n## Zygote集成启动\n\n```mermaid\ngraph TD;\n    A[\"init.cpp - main()\"] --> B[解析init.zygote.rc];\n    B --> C[\"启动main类型服务 do_class_start()\"];\n    C --> D[\"启动zygote服务 start()\"];\n    D --> E[\"创建Zygote进程 fork()\"];\n    E --> |execv|F[\"app_main.cpp - main()\"];\n```\n\n\n\n## System Server进程启动\n\n```mermaid\ngraph TD;\n    A[\"app_main.cpp - main()\"] --> B[\"AndroidRuntime.start()\"];\n    B --> C[\"startVM()\"];\n    C --> D[\"startReg()\"];\n    D --> E[\"ZygoteInit.main()\"];\n    E --> F[\"registerZygoteSocket()\"];\n    F --> G[\"preload\"];\n    G --> H[\"startSystemServer\"];\n    H --> I[\"runSelectLoop\"];\n```\n\n[SystemServer.java](https://android.googlesource.com/platform/frameworks/base/+/refs/heads/master/services/java/com/android/server/SystemServer.java)\n\n\n\n## AMS启动流程\n\n[ActivityManagerService.java](https://android.googlesource.com/platform/frameworks/base/+/master/services/core/java/com/android/server/am/ActivityManagerService.java)\n\n在SystemServer的`startBootstrapServices`方法中，开始了AMS的启动。\n\n### AMS启动过程中做了哪些事？\n\n与`adb shell dumpsys`相关的一些process服务，比如`meminfo`、`gfxinfo`、`dbinfo`等，具体请参考`setSystemProcess`方法。\n\n## Activity启动流程\n\nActivityStactSupervisor\n\n```mermaid\nflowchart LR;\nA[ActivityStactSupervisor] --> B[mHomeStack];\nA --> C[mFocusedStack];\nsubgraph ActivityStack[\"ActivityStack\"]\n  subgraph TaskRecord\n    AR1[ActivityRecord]\n    AR2[ActivityRecord]\n    AR3[ActivityRecord]\n  end\n  subgraph TaskRecord2\n    AR4[ActivityRecord]\n    AR5[ActivityRecord]\n    AR6[ActivityRecord]\n  end\nend\nB --> ActivityStack;\nC --> ActivityStack;\n```\n\nActivity启动简图\n\n\n\n> 面试题：Zygote为什么不采用Binder机制进行IPC通信。\n>\n> Binder机制中存在Binder线程池，是多线程的，如果Zygote采用Binder的话，就存在了上面说的fork多线程死锁问题了。其实严格来说，Binder机制不一定要多线程，所谓的Binder线程只不过是在循环读取Binder驱动消息而已，只注册一个Binder线程也是可以工作的，比如ServiceManager，实际上Zygote尽管没有采用Binder机制，它也不是单线程的，但它在fork前主动停止了其他线程，fork后重新启动了。\n\n```mermaid\ngraph TD;\n  A([Launcher]) --> B{\"SystemServer - AMS<br>(app是否启动)\"};\n  B --> |否, 请求创建app进程|C[Zygote];\n  B -.-> |\"是, 1. ActivityManager.getService()\"|D(App):::app;\n  C -->|fork| D\n  D -->|\"2. mgr.attachApplication(mAppThread, startSeq)\"| B;\n\tclassDef app fill:#5befb9\n```\n\nActivity启动细节图\n\n**Launcher到AMS阶段**\n\n```mermaid\nsequenceDiagram\n\tparticipant A as Launcher\n\tparticipant B as Activity\n\tparticipant C as Instrumentation\n\tparticipant D as IActivityManager\n\tparticipant E as AMS\n\t\n\tA ->> B: startActivity\n\tB --> B: startActivityForResult\n\tB ->> C: execStartActivity\n\tC ->> D: startActivity\n\tD ->> E: startActivity\n```\n\n**AMS到ApplicationThread阶段**\n\n```mermaid\nsequenceDiagram\n\tparticipant A as AMS\n\tparticipant B as ActivityStart\n\tparticipant C as ActivityStackSupervisor\n\tparticipant D as ActivityStack\n\tparticipant E as ApplicationThread\n\tA ->> A: startActivityStarter\n\tA ->> B: startActivityMyWait\n\tB ->> B: startActivityLocked\n\tB ->> B: startActivity\n\tB ->> B: startActivityUnchecked\n\tB ->> C: startSpecificActivityLocked\n```\n\n**ApplicationThread到Activity**\n\n","source":"_posts/2022-09-19-AMS启动流程.md","raw":"---\nlayout: post\ntitle: AMS启动流程\nauthor: boybeak\ncategory: Android技巧\ntags: Android\ndate: 2022-09-19 01:00:00\n---\n\n\nAMS是ActivityManagerService的简称，看名字，似乎是Activity的manager，实际上，它管理的可不只是Activity。\n\n## 系统启动流程\n\n```mermaid\ngraph TD;\n    style A fill:#fff\n    style F fill:#5befb9\n    Z{{Boot ROM}} --> A([Boot Loader]);\n    A --> B(Kernel);\n    B --> C(\"init(pid=1)/C++ Framework Native\");\n    C --> D(Zygote/Android Runtime);\n    D --> E(System Server/Java Framework);\n    E --> F(Apps);\n```\n\n> **面试题：一个应用启动，为什么不从init进程或者SystemServer进程fork，而是从Zygote进程fork。**\n>\n> *Zygote作为一个孵化器，可以提前加载一些资源，这样fork时给予[Copy-on-Write](https://zhuanlan.zhihu.com/p/48147304)机制创建的其他进程能够直接利用这些资源，而不用重新加载。比如system_server就可以直接使用Zygote中的JNI函数、共享库、常用的类以及主题资源。*\n>\n> *SystemServer相比Zygote多运行了AMS、WMS等服务，这些对于一个应用程序来说是不需要的，另外fork对多线程不友好，仅会将发起调用的线程拷贝到子进程，这可能会导致死锁，而SystemServer中肯定是有很多多线程的。*\n>\n> **如何导致死锁的？**\n>\n> 在POSIX标准中，fork行为是这样的：赋值整个用户空间的数据（通常使用copy-on-write的策略，所以可以实现速度很快）以及所有系统对象，然后仅复制当前线程到子进程。这里：所有父进程中别的线程，到了子进程都是突然蒸发掉的。\n>\n> 对于锁来说，从OS看，每个锁都有一个所有者，即最后依次lock它的线程。假设这样一个环境，在fork之前，有一个子线程lock了某个锁，获得了对锁的所有权，fork以后，在子进程中，所有的额外线程都人间蒸发了，而锁却被正常赋值了，在子进程看来，这个锁没有主人，所以没有任何人可以对它解锁，当子进程中的某个线程想lock这个锁时候，不再有任何手段可以解开了，程序发生死锁。\n\n## Zygote集成启动\n\n```mermaid\ngraph TD;\n    A[\"init.cpp - main()\"] --> B[解析init.zygote.rc];\n    B --> C[\"启动main类型服务 do_class_start()\"];\n    C --> D[\"启动zygote服务 start()\"];\n    D --> E[\"创建Zygote进程 fork()\"];\n    E --> |execv|F[\"app_main.cpp - main()\"];\n```\n\n\n\n## System Server进程启动\n\n```mermaid\ngraph TD;\n    A[\"app_main.cpp - main()\"] --> B[\"AndroidRuntime.start()\"];\n    B --> C[\"startVM()\"];\n    C --> D[\"startReg()\"];\n    D --> E[\"ZygoteInit.main()\"];\n    E --> F[\"registerZygoteSocket()\"];\n    F --> G[\"preload\"];\n    G --> H[\"startSystemServer\"];\n    H --> I[\"runSelectLoop\"];\n```\n\n[SystemServer.java](https://android.googlesource.com/platform/frameworks/base/+/refs/heads/master/services/java/com/android/server/SystemServer.java)\n\n\n\n## AMS启动流程\n\n[ActivityManagerService.java](https://android.googlesource.com/platform/frameworks/base/+/master/services/core/java/com/android/server/am/ActivityManagerService.java)\n\n在SystemServer的`startBootstrapServices`方法中，开始了AMS的启动。\n\n### AMS启动过程中做了哪些事？\n\n与`adb shell dumpsys`相关的一些process服务，比如`meminfo`、`gfxinfo`、`dbinfo`等，具体请参考`setSystemProcess`方法。\n\n## Activity启动流程\n\nActivityStactSupervisor\n\n```mermaid\nflowchart LR;\nA[ActivityStactSupervisor] --> B[mHomeStack];\nA --> C[mFocusedStack];\nsubgraph ActivityStack[\"ActivityStack\"]\n  subgraph TaskRecord\n    AR1[ActivityRecord]\n    AR2[ActivityRecord]\n    AR3[ActivityRecord]\n  end\n  subgraph TaskRecord2\n    AR4[ActivityRecord]\n    AR5[ActivityRecord]\n    AR6[ActivityRecord]\n  end\nend\nB --> ActivityStack;\nC --> ActivityStack;\n```\n\nActivity启动简图\n\n\n\n> 面试题：Zygote为什么不采用Binder机制进行IPC通信。\n>\n> Binder机制中存在Binder线程池，是多线程的，如果Zygote采用Binder的话，就存在了上面说的fork多线程死锁问题了。其实严格来说，Binder机制不一定要多线程，所谓的Binder线程只不过是在循环读取Binder驱动消息而已，只注册一个Binder线程也是可以工作的，比如ServiceManager，实际上Zygote尽管没有采用Binder机制，它也不是单线程的，但它在fork前主动停止了其他线程，fork后重新启动了。\n\n```mermaid\ngraph TD;\n  A([Launcher]) --> B{\"SystemServer - AMS<br>(app是否启动)\"};\n  B --> |否, 请求创建app进程|C[Zygote];\n  B -.-> |\"是, 1. ActivityManager.getService()\"|D(App):::app;\n  C -->|fork| D\n  D -->|\"2. mgr.attachApplication(mAppThread, startSeq)\"| B;\n\tclassDef app fill:#5befb9\n```\n\nActivity启动细节图\n\n**Launcher到AMS阶段**\n\n```mermaid\nsequenceDiagram\n\tparticipant A as Launcher\n\tparticipant B as Activity\n\tparticipant C as Instrumentation\n\tparticipant D as IActivityManager\n\tparticipant E as AMS\n\t\n\tA ->> B: startActivity\n\tB --> B: startActivityForResult\n\tB ->> C: execStartActivity\n\tC ->> D: startActivity\n\tD ->> E: startActivity\n```\n\n**AMS到ApplicationThread阶段**\n\n```mermaid\nsequenceDiagram\n\tparticipant A as AMS\n\tparticipant B as ActivityStart\n\tparticipant C as ActivityStackSupervisor\n\tparticipant D as ActivityStack\n\tparticipant E as ApplicationThread\n\tA ->> A: startActivityStarter\n\tA ->> B: startActivityMyWait\n\tB ->> B: startActivityLocked\n\tB ->> B: startActivity\n\tB ->> B: startActivityUnchecked\n\tB ->> C: startSpecificActivityLocked\n```\n\n**ApplicationThread到Activity**\n\n","slug":"2022-09-19-AMS启动流程","published":1,"updated":"2024-11-13T13:40:38.620Z","_id":"cm1ltr0fz000lbji02d5n7ybx","comments":1,"photos":[],"content":"<p>AMS是ActivityManagerService的简称，看名字，似乎是Activity的manager，实际上，它管理的可不只是Activity。</p>\n<h2 id=\"系统启动流程\"><a href=\"#系统启动流程\" class=\"headerlink\" title=\"系统启动流程\"></a>系统启动流程</h2><pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">style</span> A <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#fff</span>\n    <span class=\"token keyword\">style</span> F <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#5befb9</span>\n    Z<span class=\"token text string\">&#123;&#123;Boot ROM&#125;&#125;</span> <span class=\"token arrow operator\">--></span> A<span class=\"token text string\">([Boot Loader])</span><span class=\"token punctuation\">;</span>\n    A <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">(Kernel)</span><span class=\"token punctuation\">;</span>\n    B <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">(\"init(pid=1)/C++ Framework Native\")</span><span class=\"token punctuation\">;</span>\n    C <span class=\"token arrow operator\">--></span> D<span class=\"token text string\">(Zygote/Android Runtime)</span><span class=\"token punctuation\">;</span>\n    D <span class=\"token arrow operator\">--></span> E<span class=\"token text string\">(System Server/Java Framework)</span><span class=\"token punctuation\">;</span>\n    E <span class=\"token arrow operator\">--></span> F<span class=\"token text string\">(Apps)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<blockquote>\n<p><strong>面试题：一个应用启动，为什么不从init进程或者SystemServer进程fork，而是从Zygote进程fork。</strong></p>\n<p><em>Zygote作为一个孵化器，可以提前加载一些资源，这样fork时给予<a href=\"https://zhuanlan.zhihu.com/p/48147304\">Copy-on-Write</a>机制创建的其他进程能够直接利用这些资源，而不用重新加载。比如system_server就可以直接使用Zygote中的JNI函数、共享库、常用的类以及主题资源。</em></p>\n<p><em>SystemServer相比Zygote多运行了AMS、WMS等服务，这些对于一个应用程序来说是不需要的，另外fork对多线程不友好，仅会将发起调用的线程拷贝到子进程，这可能会导致死锁，而SystemServer中肯定是有很多多线程的。</em></p>\n<p><strong>如何导致死锁的？</strong></p>\n<p>在POSIX标准中，fork行为是这样的：赋值整个用户空间的数据（通常使用copy-on-write的策略，所以可以实现速度很快）以及所有系统对象，然后仅复制当前线程到子进程。这里：所有父进程中别的线程，到了子进程都是突然蒸发掉的。</p>\n<p>对于锁来说，从OS看，每个锁都有一个所有者，即最后依次lock它的线程。假设这样一个环境，在fork之前，有一个子线程lock了某个锁，获得了对锁的所有权，fork以后，在子进程中，所有的额外线程都人间蒸发了，而锁却被正常赋值了，在子进程看来，这个锁没有主人，所以没有任何人可以对它解锁，当子进程中的某个线程想lock这个锁时候，不再有任何手段可以解开了，程序发生死锁。</p>\n</blockquote>\n<h2 id=\"Zygote集成启动\"><a href=\"#Zygote集成启动\" class=\"headerlink\" title=\"Zygote集成启动\"></a>Zygote集成启动</h2><pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\n    A<span class=\"token text string\">[\"init.cpp - main()\"]</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">[解析init.zygote.rc]</span><span class=\"token punctuation\">;</span>\n    B <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">[\"启动main类型服务 do_class_start()\"]</span><span class=\"token punctuation\">;</span>\n    C <span class=\"token arrow operator\">--></span> D<span class=\"token text string\">[\"启动zygote服务 start()\"]</span><span class=\"token punctuation\">;</span>\n    D <span class=\"token arrow operator\">--></span> E<span class=\"token text string\">[\"创建Zygote进程 fork()\"]</span><span class=\"token punctuation\">;</span>\n    E <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|execv|</span>F<span class=\"token text string\">[\"app_main.cpp - main()\"]</span><span class=\"token punctuation\">;</span></code></pre>\n\n\n\n<h2 id=\"System-Server进程启动\"><a href=\"#System-Server进程启动\" class=\"headerlink\" title=\"System Server进程启动\"></a>System Server进程启动</h2><pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\n    A<span class=\"token text string\">[\"app_main.cpp - main()\"]</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">[\"AndroidRuntime.start()\"]</span><span class=\"token punctuation\">;</span>\n    B <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">[\"startVM()\"]</span><span class=\"token punctuation\">;</span>\n    C <span class=\"token arrow operator\">--></span> D<span class=\"token text string\">[\"startReg()\"]</span><span class=\"token punctuation\">;</span>\n    D <span class=\"token arrow operator\">--></span> E<span class=\"token text string\">[\"ZygoteInit.main()\"]</span><span class=\"token punctuation\">;</span>\n    E <span class=\"token arrow operator\">--></span> F<span class=\"token text string\">[\"registerZygoteSocket()\"]</span><span class=\"token punctuation\">;</span>\n    F <span class=\"token arrow operator\">--></span> G<span class=\"token text string\">[\"preload\"]</span><span class=\"token punctuation\">;</span>\n    G <span class=\"token arrow operator\">--></span> H<span class=\"token text string\">[\"startSystemServer\"]</span><span class=\"token punctuation\">;</span>\n    H <span class=\"token arrow operator\">--></span> I<span class=\"token text string\">[\"runSelectLoop\"]</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p><a href=\"https://android.googlesource.com/platform/frameworks/base/+/refs/heads/master/services/java/com/android/server/SystemServer.java\">SystemServer.java</a></p>\n<h2 id=\"AMS启动流程\"><a href=\"#AMS启动流程\" class=\"headerlink\" title=\"AMS启动流程\"></a>AMS启动流程</h2><p><a href=\"https://android.googlesource.com/platform/frameworks/base/+/master/services/core/java/com/android/server/am/ActivityManagerService.java\">ActivityManagerService.java</a></p>\n<p>在SystemServer的<code>startBootstrapServices</code>方法中，开始了AMS的启动。</p>\n<h3 id=\"AMS启动过程中做了哪些事？\"><a href=\"#AMS启动过程中做了哪些事？\" class=\"headerlink\" title=\"AMS启动过程中做了哪些事？\"></a>AMS启动过程中做了哪些事？</h3><p>与<code>adb shell dumpsys</code>相关的一些process服务，比如<code>meminfo</code>、<code>gfxinfo</code>、<code>dbinfo</code>等，具体请参考<code>setSystemProcess</code>方法。</p>\n<h2 id=\"Activity启动流程\"><a href=\"#Activity启动流程\" class=\"headerlink\" title=\"Activity启动流程\"></a>Activity启动流程</h2><p>ActivityStactSupervisor</p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">flowchart</span> LR<span class=\"token punctuation\">;</span>\nA<span class=\"token text string\">[ActivityStactSupervisor]</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">[mHomeStack]</span><span class=\"token punctuation\">;</span>\nA <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">[mFocusedStack]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> ActivityStack<span class=\"token text string\">[\"ActivityStack\"]</span>\n  <span class=\"token keyword\">subgraph</span> TaskRecord\n    AR1<span class=\"token text string\">[ActivityRecord]</span>\n    AR2<span class=\"token text string\">[ActivityRecord]</span>\n    AR3<span class=\"token text string\">[ActivityRecord]</span>\n  <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">subgraph</span> TaskRecord2\n    AR4<span class=\"token text string\">[ActivityRecord]</span>\n    AR5<span class=\"token text string\">[ActivityRecord]</span>\n    AR6<span class=\"token text string\">[ActivityRecord]</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\nB <span class=\"token arrow operator\">--></span> ActivityStack<span class=\"token punctuation\">;</span>\nC <span class=\"token arrow operator\">--></span> ActivityStack<span class=\"token punctuation\">;</span></code></pre>\n\n<p>Activity启动简图</p>\n<blockquote>\n<p>面试题：Zygote为什么不采用Binder机制进行IPC通信。</p>\n<p>Binder机制中存在Binder线程池，是多线程的，如果Zygote采用Binder的话，就存在了上面说的fork多线程死锁问题了。其实严格来说，Binder机制不一定要多线程，所谓的Binder线程只不过是在循环读取Binder驱动消息而已，只注册一个Binder线程也是可以工作的，比如ServiceManager，实际上Zygote尽管没有采用Binder机制，它也不是单线程的，但它在fork前主动停止了其他线程，fork后重新启动了。</p>\n</blockquote>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\n  A<span class=\"token text string\">([Launcher])</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">&#123;\"SystemServer - AMS&lt;br>(app是否启动)\"&#125;</span><span class=\"token punctuation\">;</span>\n  B <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|否, 请求创建app进程|</span>C<span class=\"token text string\">[Zygote]</span><span class=\"token punctuation\">;</span>\n  B <span class=\"token arrow operator\">-.-></span> <span class=\"token label property\">|\"是, 1. ActivityManager.getService()\"|</span>D<span class=\"token text string\">(App)</span><span class=\"token operator\">:::</span>app<span class=\"token punctuation\">;</span>\n  C <span class=\"token arrow operator\">--></span><span class=\"token label property\">|fork|</span> D\n  D <span class=\"token arrow operator\">--></span><span class=\"token label property\">|\"2. mgr.attachApplication(mAppThread, startSeq)\"|</span> B<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">classDef</span> app <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#5befb9</span></code></pre>\n\n<p>Activity启动细节图</p>\n<p><strong>Launcher到AMS阶段</strong></p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">sequenceDiagram</span>\n\t<span class=\"token keyword\">participant</span> A as Launcher\n\t<span class=\"token keyword\">participant</span> B as Activity\n\t<span class=\"token keyword\">participant</span> C as Instrumentation\n\t<span class=\"token keyword\">participant</span> D as IActivityManager\n\t<span class=\"token keyword\">participant</span> E as AMS\n\t\n\tA <span class=\"token arrow operator\">->></span> B<span class=\"token operator\">:</span> startActivity\n\tB <span class=\"token arrow operator\">--></span> B<span class=\"token operator\">:</span> startActivityForResult\n\tB <span class=\"token arrow operator\">->></span> C<span class=\"token operator\">:</span> execStartActivity\n\tC <span class=\"token arrow operator\">->></span> D<span class=\"token operator\">:</span> startActivity\n\tD <span class=\"token arrow operator\">->></span> E<span class=\"token operator\">:</span> startActivity</code></pre>\n\n<p><strong>AMS到ApplicationThread阶段</strong></p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">sequenceDiagram</span>\n\t<span class=\"token keyword\">participant</span> A as AMS\n\t<span class=\"token keyword\">participant</span> B as ActivityStart\n\t<span class=\"token keyword\">participant</span> C as ActivityStackSupervisor\n\t<span class=\"token keyword\">participant</span> D as ActivityStack\n\t<span class=\"token keyword\">participant</span> E as ApplicationThread\n\tA <span class=\"token arrow operator\">->></span> A<span class=\"token operator\">:</span> startActivityStarter\n\tA <span class=\"token arrow operator\">->></span> B<span class=\"token operator\">:</span> startActivityMyWait\n\tB <span class=\"token arrow operator\">->></span> B<span class=\"token operator\">:</span> startActivityLocked\n\tB <span class=\"token arrow operator\">->></span> B<span class=\"token operator\">:</span> startActivity\n\tB <span class=\"token arrow operator\">->></span> B<span class=\"token operator\">:</span> startActivityUnchecked\n\tB <span class=\"token arrow operator\">->></span> C<span class=\"token operator\">:</span> startSpecificActivityLocked</code></pre>\n\n<p><strong>ApplicationThread到Activity</strong></p>\n","excerpt":"","more":"<p>AMS是ActivityManagerService的简称，看名字，似乎是Activity的manager，实际上，它管理的可不只是Activity。</p>\n<h2 id=\"系统启动流程\"><a href=\"#系统启动流程\" class=\"headerlink\" title=\"系统启动流程\"></a>系统启动流程</h2><pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">style</span> A <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#fff</span>\n    <span class=\"token keyword\">style</span> F <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#5befb9</span>\n    Z<span class=\"token text string\">&#123;&#123;Boot ROM&#125;&#125;</span> <span class=\"token arrow operator\">--></span> A<span class=\"token text string\">([Boot Loader])</span><span class=\"token punctuation\">;</span>\n    A <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">(Kernel)</span><span class=\"token punctuation\">;</span>\n    B <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">(\"init(pid=1)/C++ Framework Native\")</span><span class=\"token punctuation\">;</span>\n    C <span class=\"token arrow operator\">--></span> D<span class=\"token text string\">(Zygote/Android Runtime)</span><span class=\"token punctuation\">;</span>\n    D <span class=\"token arrow operator\">--></span> E<span class=\"token text string\">(System Server/Java Framework)</span><span class=\"token punctuation\">;</span>\n    E <span class=\"token arrow operator\">--></span> F<span class=\"token text string\">(Apps)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<blockquote>\n<p><strong>面试题：一个应用启动，为什么不从init进程或者SystemServer进程fork，而是从Zygote进程fork。</strong></p>\n<p><em>Zygote作为一个孵化器，可以提前加载一些资源，这样fork时给予<a href=\"https://zhuanlan.zhihu.com/p/48147304\">Copy-on-Write</a>机制创建的其他进程能够直接利用这些资源，而不用重新加载。比如system_server就可以直接使用Zygote中的JNI函数、共享库、常用的类以及主题资源。</em></p>\n<p><em>SystemServer相比Zygote多运行了AMS、WMS等服务，这些对于一个应用程序来说是不需要的，另外fork对多线程不友好，仅会将发起调用的线程拷贝到子进程，这可能会导致死锁，而SystemServer中肯定是有很多多线程的。</em></p>\n<p><strong>如何导致死锁的？</strong></p>\n<p>在POSIX标准中，fork行为是这样的：赋值整个用户空间的数据（通常使用copy-on-write的策略，所以可以实现速度很快）以及所有系统对象，然后仅复制当前线程到子进程。这里：所有父进程中别的线程，到了子进程都是突然蒸发掉的。</p>\n<p>对于锁来说，从OS看，每个锁都有一个所有者，即最后依次lock它的线程。假设这样一个环境，在fork之前，有一个子线程lock了某个锁，获得了对锁的所有权，fork以后，在子进程中，所有的额外线程都人间蒸发了，而锁却被正常赋值了，在子进程看来，这个锁没有主人，所以没有任何人可以对它解锁，当子进程中的某个线程想lock这个锁时候，不再有任何手段可以解开了，程序发生死锁。</p>\n</blockquote>\n<h2 id=\"Zygote集成启动\"><a href=\"#Zygote集成启动\" class=\"headerlink\" title=\"Zygote集成启动\"></a>Zygote集成启动</h2><pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\n    A<span class=\"token text string\">[\"init.cpp - main()\"]</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">[解析init.zygote.rc]</span><span class=\"token punctuation\">;</span>\n    B <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">[\"启动main类型服务 do_class_start()\"]</span><span class=\"token punctuation\">;</span>\n    C <span class=\"token arrow operator\">--></span> D<span class=\"token text string\">[\"启动zygote服务 start()\"]</span><span class=\"token punctuation\">;</span>\n    D <span class=\"token arrow operator\">--></span> E<span class=\"token text string\">[\"创建Zygote进程 fork()\"]</span><span class=\"token punctuation\">;</span>\n    E <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|execv|</span>F<span class=\"token text string\">[\"app_main.cpp - main()\"]</span><span class=\"token punctuation\">;</span></code></pre>\n\n\n\n<h2 id=\"System-Server进程启动\"><a href=\"#System-Server进程启动\" class=\"headerlink\" title=\"System Server进程启动\"></a>System Server进程启动</h2><pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\n    A<span class=\"token text string\">[\"app_main.cpp - main()\"]</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">[\"AndroidRuntime.start()\"]</span><span class=\"token punctuation\">;</span>\n    B <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">[\"startVM()\"]</span><span class=\"token punctuation\">;</span>\n    C <span class=\"token arrow operator\">--></span> D<span class=\"token text string\">[\"startReg()\"]</span><span class=\"token punctuation\">;</span>\n    D <span class=\"token arrow operator\">--></span> E<span class=\"token text string\">[\"ZygoteInit.main()\"]</span><span class=\"token punctuation\">;</span>\n    E <span class=\"token arrow operator\">--></span> F<span class=\"token text string\">[\"registerZygoteSocket()\"]</span><span class=\"token punctuation\">;</span>\n    F <span class=\"token arrow operator\">--></span> G<span class=\"token text string\">[\"preload\"]</span><span class=\"token punctuation\">;</span>\n    G <span class=\"token arrow operator\">--></span> H<span class=\"token text string\">[\"startSystemServer\"]</span><span class=\"token punctuation\">;</span>\n    H <span class=\"token arrow operator\">--></span> I<span class=\"token text string\">[\"runSelectLoop\"]</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p><a href=\"https://android.googlesource.com/platform/frameworks/base/+/refs/heads/master/services/java/com/android/server/SystemServer.java\">SystemServer.java</a></p>\n<h2 id=\"AMS启动流程\"><a href=\"#AMS启动流程\" class=\"headerlink\" title=\"AMS启动流程\"></a>AMS启动流程</h2><p><a href=\"https://android.googlesource.com/platform/frameworks/base/+/master/services/core/java/com/android/server/am/ActivityManagerService.java\">ActivityManagerService.java</a></p>\n<p>在SystemServer的<code>startBootstrapServices</code>方法中，开始了AMS的启动。</p>\n<h3 id=\"AMS启动过程中做了哪些事？\"><a href=\"#AMS启动过程中做了哪些事？\" class=\"headerlink\" title=\"AMS启动过程中做了哪些事？\"></a>AMS启动过程中做了哪些事？</h3><p>与<code>adb shell dumpsys</code>相关的一些process服务，比如<code>meminfo</code>、<code>gfxinfo</code>、<code>dbinfo</code>等，具体请参考<code>setSystemProcess</code>方法。</p>\n<h2 id=\"Activity启动流程\"><a href=\"#Activity启动流程\" class=\"headerlink\" title=\"Activity启动流程\"></a>Activity启动流程</h2><p>ActivityStactSupervisor</p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">flowchart</span> LR<span class=\"token punctuation\">;</span>\nA<span class=\"token text string\">[ActivityStactSupervisor]</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">[mHomeStack]</span><span class=\"token punctuation\">;</span>\nA <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">[mFocusedStack]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> ActivityStack<span class=\"token text string\">[\"ActivityStack\"]</span>\n  <span class=\"token keyword\">subgraph</span> TaskRecord\n    AR1<span class=\"token text string\">[ActivityRecord]</span>\n    AR2<span class=\"token text string\">[ActivityRecord]</span>\n    AR3<span class=\"token text string\">[ActivityRecord]</span>\n  <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">subgraph</span> TaskRecord2\n    AR4<span class=\"token text string\">[ActivityRecord]</span>\n    AR5<span class=\"token text string\">[ActivityRecord]</span>\n    AR6<span class=\"token text string\">[ActivityRecord]</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\nB <span class=\"token arrow operator\">--></span> ActivityStack<span class=\"token punctuation\">;</span>\nC <span class=\"token arrow operator\">--></span> ActivityStack<span class=\"token punctuation\">;</span></code></pre>\n\n<p>Activity启动简图</p>\n<blockquote>\n<p>面试题：Zygote为什么不采用Binder机制进行IPC通信。</p>\n<p>Binder机制中存在Binder线程池，是多线程的，如果Zygote采用Binder的话，就存在了上面说的fork多线程死锁问题了。其实严格来说，Binder机制不一定要多线程，所谓的Binder线程只不过是在循环读取Binder驱动消息而已，只注册一个Binder线程也是可以工作的，比如ServiceManager，实际上Zygote尽管没有采用Binder机制，它也不是单线程的，但它在fork前主动停止了其他线程，fork后重新启动了。</p>\n</blockquote>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\n  A<span class=\"token text string\">([Launcher])</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">&#123;\"SystemServer - AMS&lt;br>(app是否启动)\"&#125;</span><span class=\"token punctuation\">;</span>\n  B <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|否, 请求创建app进程|</span>C<span class=\"token text string\">[Zygote]</span><span class=\"token punctuation\">;</span>\n  B <span class=\"token arrow operator\">-.-></span> <span class=\"token label property\">|\"是, 1. ActivityManager.getService()\"|</span>D<span class=\"token text string\">(App)</span><span class=\"token operator\">:::</span>app<span class=\"token punctuation\">;</span>\n  C <span class=\"token arrow operator\">--></span><span class=\"token label property\">|fork|</span> D\n  D <span class=\"token arrow operator\">--></span><span class=\"token label property\">|\"2. mgr.attachApplication(mAppThread, startSeq)\"|</span> B<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">classDef</span> app <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#5befb9</span></code></pre>\n\n<p>Activity启动细节图</p>\n<p><strong>Launcher到AMS阶段</strong></p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">sequenceDiagram</span>\n\t<span class=\"token keyword\">participant</span> A as Launcher\n\t<span class=\"token keyword\">participant</span> B as Activity\n\t<span class=\"token keyword\">participant</span> C as Instrumentation\n\t<span class=\"token keyword\">participant</span> D as IActivityManager\n\t<span class=\"token keyword\">participant</span> E as AMS\n\t\n\tA <span class=\"token arrow operator\">->></span> B<span class=\"token operator\">:</span> startActivity\n\tB <span class=\"token arrow operator\">--></span> B<span class=\"token operator\">:</span> startActivityForResult\n\tB <span class=\"token arrow operator\">->></span> C<span class=\"token operator\">:</span> execStartActivity\n\tC <span class=\"token arrow operator\">->></span> D<span class=\"token operator\">:</span> startActivity\n\tD <span class=\"token arrow operator\">->></span> E<span class=\"token operator\">:</span> startActivity</code></pre>\n\n<p><strong>AMS到ApplicationThread阶段</strong></p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">sequenceDiagram</span>\n\t<span class=\"token keyword\">participant</span> A as AMS\n\t<span class=\"token keyword\">participant</span> B as ActivityStart\n\t<span class=\"token keyword\">participant</span> C as ActivityStackSupervisor\n\t<span class=\"token keyword\">participant</span> D as ActivityStack\n\t<span class=\"token keyword\">participant</span> E as ApplicationThread\n\tA <span class=\"token arrow operator\">->></span> A<span class=\"token operator\">:</span> startActivityStarter\n\tA <span class=\"token arrow operator\">->></span> B<span class=\"token operator\">:</span> startActivityMyWait\n\tB <span class=\"token arrow operator\">->></span> B<span class=\"token operator\">:</span> startActivityLocked\n\tB <span class=\"token arrow operator\">->></span> B<span class=\"token operator\">:</span> startActivity\n\tB <span class=\"token arrow operator\">->></span> B<span class=\"token operator\">:</span> startActivityUnchecked\n\tB <span class=\"token arrow operator\">->></span> C<span class=\"token operator\">:</span> startSpecificActivityLocked</code></pre>\n\n<p><strong>ApplicationThread到Activity</strong></p>\n"},{"layout":"post","title":"ASM库介绍与使用","author":"boybeak","date":"2022-09-18T20:00:00.000Z","_content":"\n\n\n> [原文](https://www.jianshu.com/p/905be2a9a700)\n\n前面几篇文章介绍了 .class 文件的结构、JVM 如何加载 .class 文件、JVM 中如何执行方法的调用和访问者模式，其实前面几篇文章都是为这篇文章做铺垫的，如果不知道 .class 文件结构、也不知道在 JVM 中 .class 文件中的方法是如何被执行的，这篇文章中的有些部分可能会看不懂，所以推荐先看下前面几篇文章。\n 这篇文章主要介绍 ASM 库的结构、主要的 API，并且通过两个示例说明如何通过 ASM 修改 .class 文件中的方法和属性。\n\n\n\n![img](/images/ezgif-6-73b502b11e16.jpg)\n\ncatalog.png\n\n### 一. ASM 的结构\n\nASM 库是一款基于 Java 字节码层面的代码分析和修改工具。ASM 可以直接生产二进制的 class 文件，也可以在类被加载入 JVM 之前动态修改类行为。\n ASM 库的结构如下所示：\n\n\n\n![img](/images/4179925-d4f950ec94a12cde.webp)\n\nasm_arch.png\n\n- Core：为其他包提供基础的读、写、转化Java字节码和定义的API，并且可以生成Java字节码和实现大部分字节码的转换，在 [访问者模式和 ASM](https://www.jianshu.com/p/e4b8cb0b3204) 中介绍的几个重要的类就在 Core API 中：ClassReader、ClassVisitor 和 ClassWriter 类.\n- Tree：提供了 Java 字节码在内存中的表现\n- Commons：提供了一些常用的简化字节码生成、转换的类和适配器\n- Util：包含一些帮助类和简单的字节码修改类，有利于在开发或者测试中使用\n- XML：提供一个适配器将XML和SAX-comliant转化成字节码结构，可以允许使用XSLT去定义字节码转化\n\n### 二. Core API 介绍\n\n#### 2.1 ClassVisitor 抽象类\n\n如下所示，在 ClassVisitor 中提供了和类结构同名的一些方法，这些方法会对类中相应的部分进行操作，而且是有顺序的：visit [ visitSource ] [ visitOuterClass ] ( visitAnnotation | visitAttribute )* (visitInnerClass | visitField | visitMethod )* visitEnd\n\n\n\n```java\npublic abstract class ClassVisitor {\n\n        ......\n\n    public void visit(int version, int access, String name, String signature, String superName, String[] interfaces);\n    public void visitSource(String source, String debug);\n    public void visitOuterClass(String owner, String name, String desc);\n    public AnnotationVisitor visitAnnotation(String desc, boolean visible);\n    public AnnotationVisitor visitTypeAnnotation(int typeRef, TypePath typePath, String desc, boolean visible);\n    public void visitAttribute(Attribute attr);\n    public void visitInnerClass(String name, String outerName, String innerName, int access);\n    public FieldVisitor visitField(int access, String name, String desc, String signature, Object value);\n    public MethodVisitor visitMethod(int access, String name, String desc, String signature, String[] exceptions);\n    public void visitEnd();\n}\n```\n\n1. void visit(int version, int access, String name, String signature, String superName, String[] interfaces)\n    该方法是当扫描类时第一个调用的方法，主要用于类声明使用。下面是对方法中各个参数的示意：visit( 类版本 , 修饰符 , 类名 , 泛型信息 , 继承的父类 , 实现的接口)\n2. AnnotationVisitor visitAnnotation(String desc, boolean visible)\n    该方法是当扫描器扫描到类注解声明时进行调用。下面是对方法中各个参数的示意：visitAnnotation(注解类型 , 注解是否可以在 JVM 中可见)。\n3. FieldVisitor visitField(int access, String name, String desc, String signature, Object value)\n    该方法是当扫描器扫描到类中字段时进行调用。下面是对方法中各个参数的示意：visitField(修饰符 , 字段名 , 字段类型 , 泛型描述 , 默认值)\n4. MethodVisitor visitMethod(int access, String name, String desc, String signature, String[] exceptions)\n    该方法是当扫描器扫描到类的方法时进行调用。下面是对方法中各个参数的示意：visitMethod(修饰符 , 方法名 , 方法签名 , 泛型信息 , 抛出的异常)\n5. void visitEnd()\n    该方法是当扫描器完成类扫描时才会调用，如果想在类中追加某些方法\n\n#### 2.2 ClassReader 类\n\n这个类会将 .class 文件读入到 ClassReader 中的字节数组中，它的 accept 方法接受一个 ClassVisitor 实现类，并按照顺序调用 ClassVisitor 中的方法\n\n#### 2.3 ClassWriter 类\n\nClassWriter 是一个 ClassVisitor 的子类，是和 ClassReader 对应的类，ClassReader 是将 .class 文件读入到一个字节数组中，ClassWriter 是将修改后的类的字节码内容以字节数组的形式输出。\n\n#### 2.4 MethodVisitor & AdviceAdapter\n\nMethodVisitor 是一个抽象类，当 ASM 的 ClassReader 读取到 Method 时就转入 MethodVisitor 接口处理。\n AdviceAdapter 是 MethodVisitor 的子类，使用 AdviceAdapter 可以更方便的修改方法的字节码。\n AdviceAdapter 的方法如下所示：\n\n\n\n![img](/images/4179925-f5a428b729962860.webp)\n\nAdviceAdapter.png\n\n其中比较重要的几个方法如下：\n\n1. void visitCode()：表示 ASM 开始扫描这个方法\n2. void onMethodEnter()：进入这个方法\n3. void onMethodExit()：即将从这个方法出去\n4. void onVisitEnd()：表示方法扫码完毕\n\n#### 2.5 FieldVisitor 抽象类\n\nFieldVisitor 是一个抽象类，当 ASM 的 ClassReader 读取到 Field 时就转入 FieldVisitor 接口处理。和分析 MethodVisitor 的方法一样，也可以查看源码注释进行学习，这里不再详细介绍\n\n#### 2.6 操作流程\n\n1. 需要创建一个 ClassReader 对象，将 .class 文件的内容读入到一个字节数组中\n2. 然后需要一个 ClassWriter 的对象将操作之后的字节码的字节数组回写\n3. 需要事件过滤器 ClassVisitor。在调用 ClassVisitor 的某些方法时会产生一个新的 XXXVisitor 对象，当我们需要修改对应的内容时只要实现自己的 XXXVisitor 并返回就可以了\n\n### 三. 示例\n\n#### 3.1 修改类中方法的字节码\n\n假如现在我们有一个 HelloWorld 类，如下\n\n\n\n```java\npackage com.lijiankun24.asmpractice.demo;\n\npublic class HelloWorld {\n\n    public void sayHello() {\n        try {\n            Thread.sleep(2 * 1000);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n    }\n}\n```\n\n通过 `javac HelloWorld.java` 和 `javap -verbose HelloWorld.class` 可以查看到 sayName() 方法的字节码如下所示：\n\n\n\n```cpp\n  public void sayHello();\n    descriptor: ()V\n    flags: ACC_PUBLIC\n    Code:\n      stack=2, locals=2, args_size=1\n         0: ldc2_w        #2                  // long 2000l\n         3: invokestatic  #4                  // Method java/lang/Thread.sleep:(J)V\n         6: goto          14\n         9: astore_1\n        10: aload_1\n        11: invokevirtual #6                  // Method java/lang/InterruptedException.printStackTrace:()V\n        14: return\n      Exception table:\n         from    to  target type\n             0     6     9   Class java/lang/InterruptedException\n      LineNumberTable:\n        line 5: 0\n        line 8: 6\n        line 6: 9\n        line 7: 10\n        line 9: 14\n      StackMapTable: number_of_entries = 2\n        frame_type = 73 /* same_locals_1_stack_item */\n          stack = [ class java/lang/InterruptedException ]\n        frame_type = 4 /* same */\n```\n\n我们通过 ASM 修改 HelloWorld.class 字节码文件，实现统计方法执行时间的功能\n\n\n\n```java\npublic class CostTime {\n\n    public static void main(String[] args) {\n        redefinePersonClass();\n    }\n\n    private static void redefinePersonClass() {\n        String className = \"com.lijiankun24.asmpractice.demo.HelloWorld\";\n        try {\n            InputStream inputStream = new FileInputStream(\"/Users/lijiankun/Desktop/HelloWorld.class\");\n            ClassReader reader = new ClassReader(inputStream);                               // 1. 创建 ClassReader 读入 .class 文件到内存中\n            ClassWriter writer = new ClassWriter(reader, ClassWriter.COMPUTE_MAXS);                 // 2. 创建 ClassWriter 对象，将操作之后的字节码的字节数组回写\n            ClassVisitor change = new ChangeVisitor(writer);                                        // 3. 创建自定义的 ClassVisitor 对象\n            reader.accept(change, ClassReader.EXPAND_FRAMES);                                       // 4. 将 ClassVisitor 对象传入 ClassReader 中\n\n            Class clazz = new MyClassLoader().defineClass(className, writer.toByteArray());\n            Object personObj = clazz.newInstance();\n            Method nameMethod = clazz.getDeclaredMethod(\"sayHello\", null);\n            nameMethod.invoke(personObj, null);\n            System.out.println(\"Success!\");\n            byte[] code = writer.toByteArray();                                                               // 获取修改后的 class 文件对应的字节数组\n            try {\n                FileOutputStream fos = new FileOutputStream(\"/Users/lijiankun/Desktop/HelloWorld2.class\");    // 将二进制流写到本地磁盘上\n                fos.write(code);\n                fos.close();\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n        } catch (Exception e) {\n            e.printStackTrace();\n            System.out.println(\"Failure!\");\n        }\n    }\n\n    static class ChangeVisitor extends ClassVisitor {\n\n        ChangeVisitor(ClassVisitor classVisitor) {\n            super(Opcodes.ASM5, classVisitor);\n        }\n\n        @Override\n        public MethodVisitor visitMethod(int access, String name, String desc, String signature, String[] exceptions) {\n            MethodVisitor methodVisitor = super.visitMethod(access, name, desc, signature, exceptions);\n            if (name.equals(\"<init>\")) {\n                return methodVisitor;\n            }\n            return new ChangeAdapter(Opcodes.ASM4, methodVisitor, access, name, desc);\n        }\n    }\n\n    static class ChangeAdapter extends AdviceAdapter {\n        private int startTimeId = -1;\n\n        private String methodName = null;\n\n        ChangeAdapter(int api, MethodVisitor mv, int access, String name, String desc) {\n            super(api, mv, access, name, desc);\n            methodName = name;\n        }\n\n        @Override\n        protected void onMethodEnter() {\n            super.onMethodEnter();\n            startTimeId = newLocal(Type.LONG_TYPE);\n            mv.visitMethodInsn(INVOKESTATIC, \"java/lang/System\", \"currentTimeMillis\", \"()J\", false);\n            mv.visitIntInsn(LSTORE, startTimeId);\n        }\n\n        @Override\n        protected void onMethodExit(int opcode) {\n            super.onMethodExit(opcode);\n            int durationId = newLocal(Type.LONG_TYPE);\n            mv.visitMethodInsn(INVOKESTATIC, \"java/lang/System\", \"currentTimeMillis\", \"()J\", false);\n            mv.visitVarInsn(LLOAD, startTimeId);\n            mv.visitInsn(LSUB);\n            mv.visitVarInsn(LSTORE, durationId);\n            mv.visitFieldInsn(GETSTATIC, \"java/lang/System\", \"out\", \"Ljava/io/PrintStream;\");\n            mv.visitTypeInsn(NEW, \"java/lang/StringBuilder\");\n            mv.visitInsn(DUP);\n            mv.visitMethodInsn(INVOKESPECIAL, \"java/lang/StringBuilder\", \"<init>\", \"()V\", false);\n            mv.visitLdcInsn(\"The cost time of \" + methodName + \" is \");\n            mv.visitMethodInsn(INVOKEVIRTUAL, \"java/lang/StringBuilder\", \"append\", \"(Ljava/lang/String;)Ljava/lang/StringBuilder;\", false);\n            mv.visitVarInsn(LLOAD, durationId);\n            mv.visitMethodInsn(INVOKEVIRTUAL, \"java/lang/StringBuilder\", \"append\", \"(J)Ljava/lang/StringBuilder;\", false);\n            mv.visitMethodInsn(INVOKEVIRTUAL, \"java/lang/StringBuilder\", \"toString\", \"()Ljava/lang/String;\", false);\n            mv.visitMethodInsn(INVOKEVIRTUAL, \"java/io/PrintStream\", \"println\", \"(Ljava/lang/String;)V\", false);\n        }\n    }\n}\n```\n\n执行结果如下图所示\n\n\n\n![img](/images/4179925-32ee7bd0974a4679.webp)\n\nClass.png\n\n反编译 HelloWorld2.class 文件的内容如下所示\n\n\n\n![img](/images/4179925-af582100631d7eec.webp)\n\nClass1.png\n\n#### 3.2 修改类中属性的字节码\n\n这一节中我们将展示一下如何使用 Core API 对类中的属性进行操作。\n\n假如说，现在有一个 Person.java 类如下所示：\n\n\n\n```java\npublic class Person {\n    public String name;\n    public int sex;\n}\n```\n\n我们想为这个类，添加一个 ‘public int age’ 的属性该怎么添加呢？我们会面对两个问题：\n\n1. 该调用 ASM 的哪个 API 添加属性呢？\n2. 在何时写添加属性的代码？\n\n接下来，我们就一一解决上面的两个问题？\n\n##### 3.2.1 添加属性的 API\n\n按照我们分析的上述的 2.6 操作流程叙述，需要以下三个步骤：\n\n1. 需要创建一个 ClassReader 对象，将 .class 文件的内容读入到一个字节数组中\n2. 然后需要一个 ClassWriter 的对象将操作之后的字节码的字节数组回写\n3. 需要创建一个事件过滤器 ClassVisitor。事件过滤器中的某些方法可以产生一个新的XXXVisitor对象，当我们需要修改对应的内容时只要实现自己的XXXVisitor并返回就可以了\n\n在上面三个步骤中，可以操作的就是 ClassVisitor 了。ClassVisitor 接口提供了和类结构同名的一些方法，这些方法可以对相应的类结构进行操作。\n\n在使用 ClassVisitor 添加类属性的时候，只需要添加一句话就可以了：\n\n\n\n```java\nclassVisitor.visitField(Opcodes.ACC_PUBLIC, \"age\", Type.getDescriptor(int.class), null, null);\n```\n\n![img](/images/4179925-8c703df0b005aae7.webp)\n\nvisitField.png\n\n##### 3.2.2 添加属性的时机\n\n我们先暂且在 ClassVisitor 的 visitEnd() 方法中写入上面的代码，如下所示\n\n\n\n```java\npublic class Transform extends ClassVisitor {  \n\n    public Transform(ClassVisitor cv) {  \n        super(cv);  \n    }  \n\n    @Override  \n    public void visitEnd() {  \n        cv.visitField(Opcodes.ACC_PUBLIC, \"age\", Type.getDescriptor(int.class), null, null);  \n    }  \n}\n```\n\n我们写如下的测试类，测试一下\n\n\n\n```java\npublic class FieldPractice {\n\n    public static void main(String[] args) {\n        addAgeField();\n    }\n\n    private static void addAgeField() {\n        try {\n            InputStream inputStream = new FileInputStream(\"/Users/lijiankun/Desktop/Person.class\");\n            ClassReader reader = new ClassReader(inputStream);\n\n            ClassWriter writer = new ClassWriter(ClassWriter.COMPUTE_MAXS);\n\n            ClassVisitor visitor = new Transform(writer);\n            reader.accept(visitor, ClassReader.SKIP_DEBUG);\n\n            byte[] classFile = writer.toByteArray();\n            MyClassLoader classLoader = new MyClassLoader();\n            Class clazz = classLoader.defineClass(\"Person\", classFile);\n            Object obj = clazz.newInstance();\n\n            System.out.println(clazz.getDeclaredField(\"name\").get(obj)); //----(1)\n            System.out.println(clazz.getDeclaredField(\"age\").get(obj));  //----(2)\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n}\n```\n\n其输出入下所示：\n\n\n\n![img](/images/4179925-a718d240e05a2198.webp)\n\nvisitFieldResult.png\n\n那如果我们尝试在 ClassVisitor#visitField() 方法中添加属性可以吗？我们可以修改 Transform 测试一下：\n\n\n\n```java\npublic class Transform extends ClassVisitor {\n\n    Transform(ClassVisitor classVisitor) {\n        super(Opcodes.ASM5, classVisitor);\n    }\n\n    @Override\n    public FieldVisitor visitField(int access, String name, String desc, String signature, Object value) {\n        cv.visitField(Opcodes.ACC_PUBLIC, \"age\", Type.getDescriptor(int.class), null, null);\n        return super.visitField(access, name, desc, signature, value);\n    }\n}\n```\n\n还是使用上面的测试代码测试一下，会有如下的测试结果\n\n\n\n![img](/images/4179925-e2e730e41623be28.webp)\n\nvisitFieldError.png\n\n在 Person 类中有重复的属性，为什么会报这个错误呢？\n\n分析 ClassVisitor#visitField() 方法可得知，只要访问类中的一个属性，visitField() 方法就会被调用一次，在 Person 类中有两个属性，所以 visitField() 方法就会被调用两次，也就添加了两次 ‘public int age’ 属性，就报了上述的错误，而 visitEnd() 方法只有在最后才会被调用且只调用一次，所以在 visitEnd() 方法中是添加属性的最佳时机\n\n#### 3.3 ASMifier\n\n可能有人会问，我刚开始学，上面例子中那些 ASM 的代码我还不会写，怎么办呢？ASM 官方为我们提供了 [ASMifier](https://asm.ow2.io/#Q10)，可以帮助我们生成这些晦涩难懂的 ASM 代码。\n\n比如，我想通过 ASM 实现统计一个方法的执行时间，该怎么做呢？一般会有如下的代码：\n\n\n\n```csharp\npackage com.lijiankun24.classpractice;\n\npublic class Demo {\n\n    public void costTime() {\n        long startTime = System.currentTimeMillis();\n        // ......\n        long duration = System.currentTimeMillis() - startTime;\n        System.out.println(\"The cost time of this method is \" + duration + \" ms\");\n    }\n}\n```\n\n那上面这段代码对应的 ASM 代码是什么呢？我们可以通过以下两个步骤，使用 ASMifier 自动生成：\n\n1. 通过 `javac` 编译该 `Demo.java` 文件生成对应的 `Demo.class` 文件，如下所示\n\n\n\n```css\njavac Demo.java\n```\n\n1. 通过 ASMifier 自动生成对应的 ASM 代码。首先需要在[ASM官网](https://asm.ow2.io/#Q10) 下载 `asm-all.jar` 库，我下载的是最新的 `asm-all-5.2.jar`，然后使用如下命令，即可生成\n\n\n\n```java\njava -classpath asm-all-5.2.jar org.objectweb.asm.util.ASMifier Demo.class\n```\n\n截图如下：\n\n\n\n![img](/images/4179925-0cc8712718f08ea0.webp)\n\nDemoDump.png\n\n[深入字节码 -- 玩转 ASM-Bytecode 原 荐](https://my.oschina.net/ta8210/blog/163550)\n [美团热更方案ASM实践](http://www.easemob.com/news/729)\n\n\n\n43人点赞\n\n\n\n[Java 相关]()\n\n\n\n\n\n作者：lijiankun24\n链接：https://www.jianshu.com/p/905be2a9a700\n来源：简书\n著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。\n","source":"_posts/2022-09-19-ASM.md","raw":"---\nlayout: post\ntitle: ASM库介绍与使用\nauthor: boybeak\ncategory: Android技巧\ntags: Android\ndate: 2022-09-19 04:00:00\n---\n\n\n\n> [原文](https://www.jianshu.com/p/905be2a9a700)\n\n前面几篇文章介绍了 .class 文件的结构、JVM 如何加载 .class 文件、JVM 中如何执行方法的调用和访问者模式，其实前面几篇文章都是为这篇文章做铺垫的，如果不知道 .class 文件结构、也不知道在 JVM 中 .class 文件中的方法是如何被执行的，这篇文章中的有些部分可能会看不懂，所以推荐先看下前面几篇文章。\n 这篇文章主要介绍 ASM 库的结构、主要的 API，并且通过两个示例说明如何通过 ASM 修改 .class 文件中的方法和属性。\n\n\n\n![img](/images/ezgif-6-73b502b11e16.jpg)\n\ncatalog.png\n\n### 一. ASM 的结构\n\nASM 库是一款基于 Java 字节码层面的代码分析和修改工具。ASM 可以直接生产二进制的 class 文件，也可以在类被加载入 JVM 之前动态修改类行为。\n ASM 库的结构如下所示：\n\n\n\n![img](/images/4179925-d4f950ec94a12cde.webp)\n\nasm_arch.png\n\n- Core：为其他包提供基础的读、写、转化Java字节码和定义的API，并且可以生成Java字节码和实现大部分字节码的转换，在 [访问者模式和 ASM](https://www.jianshu.com/p/e4b8cb0b3204) 中介绍的几个重要的类就在 Core API 中：ClassReader、ClassVisitor 和 ClassWriter 类.\n- Tree：提供了 Java 字节码在内存中的表现\n- Commons：提供了一些常用的简化字节码生成、转换的类和适配器\n- Util：包含一些帮助类和简单的字节码修改类，有利于在开发或者测试中使用\n- XML：提供一个适配器将XML和SAX-comliant转化成字节码结构，可以允许使用XSLT去定义字节码转化\n\n### 二. Core API 介绍\n\n#### 2.1 ClassVisitor 抽象类\n\n如下所示，在 ClassVisitor 中提供了和类结构同名的一些方法，这些方法会对类中相应的部分进行操作，而且是有顺序的：visit [ visitSource ] [ visitOuterClass ] ( visitAnnotation | visitAttribute )* (visitInnerClass | visitField | visitMethod )* visitEnd\n\n\n\n```java\npublic abstract class ClassVisitor {\n\n        ......\n\n    public void visit(int version, int access, String name, String signature, String superName, String[] interfaces);\n    public void visitSource(String source, String debug);\n    public void visitOuterClass(String owner, String name, String desc);\n    public AnnotationVisitor visitAnnotation(String desc, boolean visible);\n    public AnnotationVisitor visitTypeAnnotation(int typeRef, TypePath typePath, String desc, boolean visible);\n    public void visitAttribute(Attribute attr);\n    public void visitInnerClass(String name, String outerName, String innerName, int access);\n    public FieldVisitor visitField(int access, String name, String desc, String signature, Object value);\n    public MethodVisitor visitMethod(int access, String name, String desc, String signature, String[] exceptions);\n    public void visitEnd();\n}\n```\n\n1. void visit(int version, int access, String name, String signature, String superName, String[] interfaces)\n    该方法是当扫描类时第一个调用的方法，主要用于类声明使用。下面是对方法中各个参数的示意：visit( 类版本 , 修饰符 , 类名 , 泛型信息 , 继承的父类 , 实现的接口)\n2. AnnotationVisitor visitAnnotation(String desc, boolean visible)\n    该方法是当扫描器扫描到类注解声明时进行调用。下面是对方法中各个参数的示意：visitAnnotation(注解类型 , 注解是否可以在 JVM 中可见)。\n3. FieldVisitor visitField(int access, String name, String desc, String signature, Object value)\n    该方法是当扫描器扫描到类中字段时进行调用。下面是对方法中各个参数的示意：visitField(修饰符 , 字段名 , 字段类型 , 泛型描述 , 默认值)\n4. MethodVisitor visitMethod(int access, String name, String desc, String signature, String[] exceptions)\n    该方法是当扫描器扫描到类的方法时进行调用。下面是对方法中各个参数的示意：visitMethod(修饰符 , 方法名 , 方法签名 , 泛型信息 , 抛出的异常)\n5. void visitEnd()\n    该方法是当扫描器完成类扫描时才会调用，如果想在类中追加某些方法\n\n#### 2.2 ClassReader 类\n\n这个类会将 .class 文件读入到 ClassReader 中的字节数组中，它的 accept 方法接受一个 ClassVisitor 实现类，并按照顺序调用 ClassVisitor 中的方法\n\n#### 2.3 ClassWriter 类\n\nClassWriter 是一个 ClassVisitor 的子类，是和 ClassReader 对应的类，ClassReader 是将 .class 文件读入到一个字节数组中，ClassWriter 是将修改后的类的字节码内容以字节数组的形式输出。\n\n#### 2.4 MethodVisitor & AdviceAdapter\n\nMethodVisitor 是一个抽象类，当 ASM 的 ClassReader 读取到 Method 时就转入 MethodVisitor 接口处理。\n AdviceAdapter 是 MethodVisitor 的子类，使用 AdviceAdapter 可以更方便的修改方法的字节码。\n AdviceAdapter 的方法如下所示：\n\n\n\n![img](/images/4179925-f5a428b729962860.webp)\n\nAdviceAdapter.png\n\n其中比较重要的几个方法如下：\n\n1. void visitCode()：表示 ASM 开始扫描这个方法\n2. void onMethodEnter()：进入这个方法\n3. void onMethodExit()：即将从这个方法出去\n4. void onVisitEnd()：表示方法扫码完毕\n\n#### 2.5 FieldVisitor 抽象类\n\nFieldVisitor 是一个抽象类，当 ASM 的 ClassReader 读取到 Field 时就转入 FieldVisitor 接口处理。和分析 MethodVisitor 的方法一样，也可以查看源码注释进行学习，这里不再详细介绍\n\n#### 2.6 操作流程\n\n1. 需要创建一个 ClassReader 对象，将 .class 文件的内容读入到一个字节数组中\n2. 然后需要一个 ClassWriter 的对象将操作之后的字节码的字节数组回写\n3. 需要事件过滤器 ClassVisitor。在调用 ClassVisitor 的某些方法时会产生一个新的 XXXVisitor 对象，当我们需要修改对应的内容时只要实现自己的 XXXVisitor 并返回就可以了\n\n### 三. 示例\n\n#### 3.1 修改类中方法的字节码\n\n假如现在我们有一个 HelloWorld 类，如下\n\n\n\n```java\npackage com.lijiankun24.asmpractice.demo;\n\npublic class HelloWorld {\n\n    public void sayHello() {\n        try {\n            Thread.sleep(2 * 1000);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n    }\n}\n```\n\n通过 `javac HelloWorld.java` 和 `javap -verbose HelloWorld.class` 可以查看到 sayName() 方法的字节码如下所示：\n\n\n\n```cpp\n  public void sayHello();\n    descriptor: ()V\n    flags: ACC_PUBLIC\n    Code:\n      stack=2, locals=2, args_size=1\n         0: ldc2_w        #2                  // long 2000l\n         3: invokestatic  #4                  // Method java/lang/Thread.sleep:(J)V\n         6: goto          14\n         9: astore_1\n        10: aload_1\n        11: invokevirtual #6                  // Method java/lang/InterruptedException.printStackTrace:()V\n        14: return\n      Exception table:\n         from    to  target type\n             0     6     9   Class java/lang/InterruptedException\n      LineNumberTable:\n        line 5: 0\n        line 8: 6\n        line 6: 9\n        line 7: 10\n        line 9: 14\n      StackMapTable: number_of_entries = 2\n        frame_type = 73 /* same_locals_1_stack_item */\n          stack = [ class java/lang/InterruptedException ]\n        frame_type = 4 /* same */\n```\n\n我们通过 ASM 修改 HelloWorld.class 字节码文件，实现统计方法执行时间的功能\n\n\n\n```java\npublic class CostTime {\n\n    public static void main(String[] args) {\n        redefinePersonClass();\n    }\n\n    private static void redefinePersonClass() {\n        String className = \"com.lijiankun24.asmpractice.demo.HelloWorld\";\n        try {\n            InputStream inputStream = new FileInputStream(\"/Users/lijiankun/Desktop/HelloWorld.class\");\n            ClassReader reader = new ClassReader(inputStream);                               // 1. 创建 ClassReader 读入 .class 文件到内存中\n            ClassWriter writer = new ClassWriter(reader, ClassWriter.COMPUTE_MAXS);                 // 2. 创建 ClassWriter 对象，将操作之后的字节码的字节数组回写\n            ClassVisitor change = new ChangeVisitor(writer);                                        // 3. 创建自定义的 ClassVisitor 对象\n            reader.accept(change, ClassReader.EXPAND_FRAMES);                                       // 4. 将 ClassVisitor 对象传入 ClassReader 中\n\n            Class clazz = new MyClassLoader().defineClass(className, writer.toByteArray());\n            Object personObj = clazz.newInstance();\n            Method nameMethod = clazz.getDeclaredMethod(\"sayHello\", null);\n            nameMethod.invoke(personObj, null);\n            System.out.println(\"Success!\");\n            byte[] code = writer.toByteArray();                                                               // 获取修改后的 class 文件对应的字节数组\n            try {\n                FileOutputStream fos = new FileOutputStream(\"/Users/lijiankun/Desktop/HelloWorld2.class\");    // 将二进制流写到本地磁盘上\n                fos.write(code);\n                fos.close();\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n        } catch (Exception e) {\n            e.printStackTrace();\n            System.out.println(\"Failure!\");\n        }\n    }\n\n    static class ChangeVisitor extends ClassVisitor {\n\n        ChangeVisitor(ClassVisitor classVisitor) {\n            super(Opcodes.ASM5, classVisitor);\n        }\n\n        @Override\n        public MethodVisitor visitMethod(int access, String name, String desc, String signature, String[] exceptions) {\n            MethodVisitor methodVisitor = super.visitMethod(access, name, desc, signature, exceptions);\n            if (name.equals(\"<init>\")) {\n                return methodVisitor;\n            }\n            return new ChangeAdapter(Opcodes.ASM4, methodVisitor, access, name, desc);\n        }\n    }\n\n    static class ChangeAdapter extends AdviceAdapter {\n        private int startTimeId = -1;\n\n        private String methodName = null;\n\n        ChangeAdapter(int api, MethodVisitor mv, int access, String name, String desc) {\n            super(api, mv, access, name, desc);\n            methodName = name;\n        }\n\n        @Override\n        protected void onMethodEnter() {\n            super.onMethodEnter();\n            startTimeId = newLocal(Type.LONG_TYPE);\n            mv.visitMethodInsn(INVOKESTATIC, \"java/lang/System\", \"currentTimeMillis\", \"()J\", false);\n            mv.visitIntInsn(LSTORE, startTimeId);\n        }\n\n        @Override\n        protected void onMethodExit(int opcode) {\n            super.onMethodExit(opcode);\n            int durationId = newLocal(Type.LONG_TYPE);\n            mv.visitMethodInsn(INVOKESTATIC, \"java/lang/System\", \"currentTimeMillis\", \"()J\", false);\n            mv.visitVarInsn(LLOAD, startTimeId);\n            mv.visitInsn(LSUB);\n            mv.visitVarInsn(LSTORE, durationId);\n            mv.visitFieldInsn(GETSTATIC, \"java/lang/System\", \"out\", \"Ljava/io/PrintStream;\");\n            mv.visitTypeInsn(NEW, \"java/lang/StringBuilder\");\n            mv.visitInsn(DUP);\n            mv.visitMethodInsn(INVOKESPECIAL, \"java/lang/StringBuilder\", \"<init>\", \"()V\", false);\n            mv.visitLdcInsn(\"The cost time of \" + methodName + \" is \");\n            mv.visitMethodInsn(INVOKEVIRTUAL, \"java/lang/StringBuilder\", \"append\", \"(Ljava/lang/String;)Ljava/lang/StringBuilder;\", false);\n            mv.visitVarInsn(LLOAD, durationId);\n            mv.visitMethodInsn(INVOKEVIRTUAL, \"java/lang/StringBuilder\", \"append\", \"(J)Ljava/lang/StringBuilder;\", false);\n            mv.visitMethodInsn(INVOKEVIRTUAL, \"java/lang/StringBuilder\", \"toString\", \"()Ljava/lang/String;\", false);\n            mv.visitMethodInsn(INVOKEVIRTUAL, \"java/io/PrintStream\", \"println\", \"(Ljava/lang/String;)V\", false);\n        }\n    }\n}\n```\n\n执行结果如下图所示\n\n\n\n![img](/images/4179925-32ee7bd0974a4679.webp)\n\nClass.png\n\n反编译 HelloWorld2.class 文件的内容如下所示\n\n\n\n![img](/images/4179925-af582100631d7eec.webp)\n\nClass1.png\n\n#### 3.2 修改类中属性的字节码\n\n这一节中我们将展示一下如何使用 Core API 对类中的属性进行操作。\n\n假如说，现在有一个 Person.java 类如下所示：\n\n\n\n```java\npublic class Person {\n    public String name;\n    public int sex;\n}\n```\n\n我们想为这个类，添加一个 ‘public int age’ 的属性该怎么添加呢？我们会面对两个问题：\n\n1. 该调用 ASM 的哪个 API 添加属性呢？\n2. 在何时写添加属性的代码？\n\n接下来，我们就一一解决上面的两个问题？\n\n##### 3.2.1 添加属性的 API\n\n按照我们分析的上述的 2.6 操作流程叙述，需要以下三个步骤：\n\n1. 需要创建一个 ClassReader 对象，将 .class 文件的内容读入到一个字节数组中\n2. 然后需要一个 ClassWriter 的对象将操作之后的字节码的字节数组回写\n3. 需要创建一个事件过滤器 ClassVisitor。事件过滤器中的某些方法可以产生一个新的XXXVisitor对象，当我们需要修改对应的内容时只要实现自己的XXXVisitor并返回就可以了\n\n在上面三个步骤中，可以操作的就是 ClassVisitor 了。ClassVisitor 接口提供了和类结构同名的一些方法，这些方法可以对相应的类结构进行操作。\n\n在使用 ClassVisitor 添加类属性的时候，只需要添加一句话就可以了：\n\n\n\n```java\nclassVisitor.visitField(Opcodes.ACC_PUBLIC, \"age\", Type.getDescriptor(int.class), null, null);\n```\n\n![img](/images/4179925-8c703df0b005aae7.webp)\n\nvisitField.png\n\n##### 3.2.2 添加属性的时机\n\n我们先暂且在 ClassVisitor 的 visitEnd() 方法中写入上面的代码，如下所示\n\n\n\n```java\npublic class Transform extends ClassVisitor {  \n\n    public Transform(ClassVisitor cv) {  \n        super(cv);  \n    }  \n\n    @Override  \n    public void visitEnd() {  \n        cv.visitField(Opcodes.ACC_PUBLIC, \"age\", Type.getDescriptor(int.class), null, null);  \n    }  \n}\n```\n\n我们写如下的测试类，测试一下\n\n\n\n```java\npublic class FieldPractice {\n\n    public static void main(String[] args) {\n        addAgeField();\n    }\n\n    private static void addAgeField() {\n        try {\n            InputStream inputStream = new FileInputStream(\"/Users/lijiankun/Desktop/Person.class\");\n            ClassReader reader = new ClassReader(inputStream);\n\n            ClassWriter writer = new ClassWriter(ClassWriter.COMPUTE_MAXS);\n\n            ClassVisitor visitor = new Transform(writer);\n            reader.accept(visitor, ClassReader.SKIP_DEBUG);\n\n            byte[] classFile = writer.toByteArray();\n            MyClassLoader classLoader = new MyClassLoader();\n            Class clazz = classLoader.defineClass(\"Person\", classFile);\n            Object obj = clazz.newInstance();\n\n            System.out.println(clazz.getDeclaredField(\"name\").get(obj)); //----(1)\n            System.out.println(clazz.getDeclaredField(\"age\").get(obj));  //----(2)\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n}\n```\n\n其输出入下所示：\n\n\n\n![img](/images/4179925-a718d240e05a2198.webp)\n\nvisitFieldResult.png\n\n那如果我们尝试在 ClassVisitor#visitField() 方法中添加属性可以吗？我们可以修改 Transform 测试一下：\n\n\n\n```java\npublic class Transform extends ClassVisitor {\n\n    Transform(ClassVisitor classVisitor) {\n        super(Opcodes.ASM5, classVisitor);\n    }\n\n    @Override\n    public FieldVisitor visitField(int access, String name, String desc, String signature, Object value) {\n        cv.visitField(Opcodes.ACC_PUBLIC, \"age\", Type.getDescriptor(int.class), null, null);\n        return super.visitField(access, name, desc, signature, value);\n    }\n}\n```\n\n还是使用上面的测试代码测试一下，会有如下的测试结果\n\n\n\n![img](/images/4179925-e2e730e41623be28.webp)\n\nvisitFieldError.png\n\n在 Person 类中有重复的属性，为什么会报这个错误呢？\n\n分析 ClassVisitor#visitField() 方法可得知，只要访问类中的一个属性，visitField() 方法就会被调用一次，在 Person 类中有两个属性，所以 visitField() 方法就会被调用两次，也就添加了两次 ‘public int age’ 属性，就报了上述的错误，而 visitEnd() 方法只有在最后才会被调用且只调用一次，所以在 visitEnd() 方法中是添加属性的最佳时机\n\n#### 3.3 ASMifier\n\n可能有人会问，我刚开始学，上面例子中那些 ASM 的代码我还不会写，怎么办呢？ASM 官方为我们提供了 [ASMifier](https://asm.ow2.io/#Q10)，可以帮助我们生成这些晦涩难懂的 ASM 代码。\n\n比如，我想通过 ASM 实现统计一个方法的执行时间，该怎么做呢？一般会有如下的代码：\n\n\n\n```csharp\npackage com.lijiankun24.classpractice;\n\npublic class Demo {\n\n    public void costTime() {\n        long startTime = System.currentTimeMillis();\n        // ......\n        long duration = System.currentTimeMillis() - startTime;\n        System.out.println(\"The cost time of this method is \" + duration + \" ms\");\n    }\n}\n```\n\n那上面这段代码对应的 ASM 代码是什么呢？我们可以通过以下两个步骤，使用 ASMifier 自动生成：\n\n1. 通过 `javac` 编译该 `Demo.java` 文件生成对应的 `Demo.class` 文件，如下所示\n\n\n\n```css\njavac Demo.java\n```\n\n1. 通过 ASMifier 自动生成对应的 ASM 代码。首先需要在[ASM官网](https://asm.ow2.io/#Q10) 下载 `asm-all.jar` 库，我下载的是最新的 `asm-all-5.2.jar`，然后使用如下命令，即可生成\n\n\n\n```java\njava -classpath asm-all-5.2.jar org.objectweb.asm.util.ASMifier Demo.class\n```\n\n截图如下：\n\n\n\n![img](/images/4179925-0cc8712718f08ea0.webp)\n\nDemoDump.png\n\n[深入字节码 -- 玩转 ASM-Bytecode 原 荐](https://my.oschina.net/ta8210/blog/163550)\n [美团热更方案ASM实践](http://www.easemob.com/news/729)\n\n\n\n43人点赞\n\n\n\n[Java 相关]()\n\n\n\n\n\n作者：lijiankun24\n链接：https://www.jianshu.com/p/905be2a9a700\n来源：简书\n著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。\n","slug":"2022-09-19-ASM","published":1,"updated":"2024-11-13T13:41:03.298Z","_id":"cm1ltr0fz000obji0bcvf8gbb","comments":1,"photos":["/images/ezgif-6-73b502b11e16.jpg","/images/4179925-d4f950ec94a12cde.webp","/images/4179925-f5a428b729962860.webp","/images/4179925-32ee7bd0974a4679.webp","/images/4179925-af582100631d7eec.webp","/images/4179925-8c703df0b005aae7.webp","/images/4179925-a718d240e05a2198.webp","/images/4179925-e2e730e41623be28.webp","/images/4179925-0cc8712718f08ea0.webp"],"content":"<blockquote>\n<p><a href=\"https://www.jianshu.com/p/905be2a9a700\">原文</a></p>\n</blockquote>\n<p>前面几篇文章介绍了 .class 文件的结构、JVM 如何加载 .class 文件、JVM 中如何执行方法的调用和访问者模式，其实前面几篇文章都是为这篇文章做铺垫的，如果不知道 .class 文件结构、也不知道在 JVM 中 .class 文件中的方法是如何被执行的，这篇文章中的有些部分可能会看不懂，所以推荐先看下前面几篇文章。<br> 这篇文章主要介绍 ASM 库的结构、主要的 API，并且通过两个示例说明如何通过 ASM 修改 .class 文件中的方法和属性。</p>\n<p><img src=\"/images/ezgif-6-73b502b11e16.jpg\" alt=\"img\"></p>\n<p>catalog.png</p>\n<h3 id=\"一-ASM-的结构\"><a href=\"#一-ASM-的结构\" class=\"headerlink\" title=\"一. ASM 的结构\"></a>一. ASM 的结构</h3><p>ASM 库是一款基于 Java 字节码层面的代码分析和修改工具。ASM 可以直接生产二进制的 class 文件，也可以在类被加载入 JVM 之前动态修改类行为。<br> ASM 库的结构如下所示：</p>\n<p><img src=\"/images/4179925-d4f950ec94a12cde.webp\" alt=\"img\"></p>\n<p>asm_arch.png</p>\n<ul>\n<li>Core：为其他包提供基础的读、写、转化Java字节码和定义的API，并且可以生成Java字节码和实现大部分字节码的转换，在 <a href=\"https://www.jianshu.com/p/e4b8cb0b3204\">访问者模式和 ASM</a> 中介绍的几个重要的类就在 Core API 中：ClassReader、ClassVisitor 和 ClassWriter 类.</li>\n<li>Tree：提供了 Java 字节码在内存中的表现</li>\n<li>Commons：提供了一些常用的简化字节码生成、转换的类和适配器</li>\n<li>Util：包含一些帮助类和简单的字节码修改类，有利于在开发或者测试中使用</li>\n<li>XML：提供一个适配器将XML和SAX-comliant转化成字节码结构，可以允许使用XSLT去定义字节码转化</li>\n</ul>\n<h3 id=\"二-Core-API-介绍\"><a href=\"#二-Core-API-介绍\" class=\"headerlink\" title=\"二. Core API 介绍\"></a>二. Core API 介绍</h3><h4 id=\"2-1-ClassVisitor-抽象类\"><a href=\"#2-1-ClassVisitor-抽象类\" class=\"headerlink\" title=\"2.1 ClassVisitor 抽象类\"></a>2.1 ClassVisitor 抽象类</h4><p>如下所示，在 ClassVisitor 中提供了和类结构同名的一些方法，这些方法会对类中相应的部分进行操作，而且是有顺序的：visit [ visitSource ] [ visitOuterClass ] ( visitAnnotation | visitAttribute )* (visitInnerClass | visitField | visitMethod )* visitEnd</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ClassVisitor</span> <span class=\"token punctuation\">&#123;</span>\n\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">visit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> version<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> access<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> signature<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> superName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> interfaces<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">visitSource</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> source<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> debug<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">visitOuterClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> owner<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AnnotationVisitor</span> <span class=\"token function\">visitAnnotation</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> visible<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AnnotationVisitor</span> <span class=\"token function\">visitTypeAnnotation</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> typeRef<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TypePath</span> typePath<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> visible<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">visitAttribute</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Attribute</span> attr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">visitInnerClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> outerName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> innerName<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> access<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">FieldVisitor</span> <span class=\"token function\">visitField</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> access<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> signature<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MethodVisitor</span> <span class=\"token function\">visitMethod</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> access<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> signature<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> exceptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">visitEnd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<ol>\n<li>void visit(int version, int access, String name, String signature, String superName, String[] interfaces)<br> 该方法是当扫描类时第一个调用的方法，主要用于类声明使用。下面是对方法中各个参数的示意：visit( 类版本 , 修饰符 , 类名 , 泛型信息 , 继承的父类 , 实现的接口)</li>\n<li>AnnotationVisitor visitAnnotation(String desc, boolean visible)<br> 该方法是当扫描器扫描到类注解声明时进行调用。下面是对方法中各个参数的示意：visitAnnotation(注解类型 , 注解是否可以在 JVM 中可见)。</li>\n<li>FieldVisitor visitField(int access, String name, String desc, String signature, Object value)<br> 该方法是当扫描器扫描到类中字段时进行调用。下面是对方法中各个参数的示意：visitField(修饰符 , 字段名 , 字段类型 , 泛型描述 , 默认值)</li>\n<li>MethodVisitor visitMethod(int access, String name, String desc, String signature, String[] exceptions)<br> 该方法是当扫描器扫描到类的方法时进行调用。下面是对方法中各个参数的示意：visitMethod(修饰符 , 方法名 , 方法签名 , 泛型信息 , 抛出的异常)</li>\n<li>void visitEnd()<br> 该方法是当扫描器完成类扫描时才会调用，如果想在类中追加某些方法</li>\n</ol>\n<h4 id=\"2-2-ClassReader-类\"><a href=\"#2-2-ClassReader-类\" class=\"headerlink\" title=\"2.2 ClassReader 类\"></a>2.2 ClassReader 类</h4><p>这个类会将 .class 文件读入到 ClassReader 中的字节数组中，它的 accept 方法接受一个 ClassVisitor 实现类，并按照顺序调用 ClassVisitor 中的方法</p>\n<h4 id=\"2-3-ClassWriter-类\"><a href=\"#2-3-ClassWriter-类\" class=\"headerlink\" title=\"2.3 ClassWriter 类\"></a>2.3 ClassWriter 类</h4><p>ClassWriter 是一个 ClassVisitor 的子类，是和 ClassReader 对应的类，ClassReader 是将 .class 文件读入到一个字节数组中，ClassWriter 是将修改后的类的字节码内容以字节数组的形式输出。</p>\n<h4 id=\"2-4-MethodVisitor-AdviceAdapter\"><a href=\"#2-4-MethodVisitor-AdviceAdapter\" class=\"headerlink\" title=\"2.4 MethodVisitor &amp; AdviceAdapter\"></a>2.4 MethodVisitor &amp; AdviceAdapter</h4><p>MethodVisitor 是一个抽象类，当 ASM 的 ClassReader 读取到 Method 时就转入 MethodVisitor 接口处理。<br> AdviceAdapter 是 MethodVisitor 的子类，使用 AdviceAdapter 可以更方便的修改方法的字节码。<br> AdviceAdapter 的方法如下所示：</p>\n<p><img src=\"/images/4179925-f5a428b729962860.webp\" alt=\"img\"></p>\n<p>AdviceAdapter.png</p>\n<p>其中比较重要的几个方法如下：</p>\n<ol>\n<li>void visitCode()：表示 ASM 开始扫描这个方法</li>\n<li>void onMethodEnter()：进入这个方法</li>\n<li>void onMethodExit()：即将从这个方法出去</li>\n<li>void onVisitEnd()：表示方法扫码完毕</li>\n</ol>\n<h4 id=\"2-5-FieldVisitor-抽象类\"><a href=\"#2-5-FieldVisitor-抽象类\" class=\"headerlink\" title=\"2.5 FieldVisitor 抽象类\"></a>2.5 FieldVisitor 抽象类</h4><p>FieldVisitor 是一个抽象类，当 ASM 的 ClassReader 读取到 Field 时就转入 FieldVisitor 接口处理。和分析 MethodVisitor 的方法一样，也可以查看源码注释进行学习，这里不再详细介绍</p>\n<h4 id=\"2-6-操作流程\"><a href=\"#2-6-操作流程\" class=\"headerlink\" title=\"2.6 操作流程\"></a>2.6 操作流程</h4><ol>\n<li>需要创建一个 ClassReader 对象，将 .class 文件的内容读入到一个字节数组中</li>\n<li>然后需要一个 ClassWriter 的对象将操作之后的字节码的字节数组回写</li>\n<li>需要事件过滤器 ClassVisitor。在调用 ClassVisitor 的某些方法时会产生一个新的 XXXVisitor 对象，当我们需要修改对应的内容时只要实现自己的 XXXVisitor 并返回就可以了</li>\n</ol>\n<h3 id=\"三-示例\"><a href=\"#三-示例\" class=\"headerlink\" title=\"三. 示例\"></a>三. 示例</h3><h4 id=\"3-1-修改类中方法的字节码\"><a href=\"#3-1-修改类中方法的字节码\" class=\"headerlink\" title=\"3.1 修改类中方法的字节码\"></a>3.1 修改类中方法的字节码</h4><p>假如现在我们有一个 HelloWorld 类，如下</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>lijiankun24<span class=\"token punctuation\">.</span>asmpractice<span class=\"token punctuation\">.</span>demo</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HelloWorld</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">sayHello</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>通过 <code>javac HelloWorld.java</code> 和 <code>javap -verbose HelloWorld.class</code> 可以查看到 sayName() 方法的字节码如下所示：</p>\n<pre class=\"language-cpp\" data-language=\"cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">sayHello</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  descriptor<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>V\n  flags<span class=\"token operator\">:</span> ACC_PUBLIC\n  Code<span class=\"token operator\">:</span>\n    stack<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> locals<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> args_size<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n       <span class=\"token number\">0</span><span class=\"token operator\">:</span> ldc2_w        #<span class=\"token number\">2</span>                  <span class=\"token comment\">// long 2000l</span>\n       <span class=\"token number\">3</span><span class=\"token operator\">:</span> invokestatic  #<span class=\"token number\">4</span>                  <span class=\"token comment\">// Method java/lang/Thread.sleep:(J)V</span>\n       <span class=\"token number\">6</span><span class=\"token operator\">:</span> <span class=\"token keyword\">goto</span>          <span class=\"token number\">14</span>\n       <span class=\"token number\">9</span><span class=\"token operator\">:</span> astore_1\n      <span class=\"token number\">10</span><span class=\"token operator\">:</span> aload_1\n      <span class=\"token number\">11</span><span class=\"token operator\">:</span> invokevirtual #<span class=\"token number\">6</span>                  <span class=\"token comment\">// Method java/lang/InterruptedException.printStackTrace:()V</span>\n      <span class=\"token number\">14</span><span class=\"token operator\">:</span> <span class=\"token keyword\">return</span>\n    Exception table<span class=\"token operator\">:</span>\n       from    to  target type\n           <span class=\"token number\">0</span>     <span class=\"token number\">6</span>     <span class=\"token number\">9</span>   Class java<span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span>InterruptedException\n    LineNumberTable<span class=\"token operator\">:</span>\n      line <span class=\"token number\">5</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n      line <span class=\"token number\">8</span><span class=\"token operator\">:</span> <span class=\"token number\">6</span>\n      line <span class=\"token number\">6</span><span class=\"token operator\">:</span> <span class=\"token number\">9</span>\n      line <span class=\"token number\">7</span><span class=\"token operator\">:</span> <span class=\"token number\">10</span>\n      line <span class=\"token number\">9</span><span class=\"token operator\">:</span> <span class=\"token number\">14</span>\n    StackMapTable<span class=\"token operator\">:</span> number_of_entries <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n      frame_type <span class=\"token operator\">=</span> <span class=\"token number\">73</span> <span class=\"token comment\">/* same_locals_1_stack_item */</span>\n        stack <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">java</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span>InterruptedException <span class=\"token punctuation\">]</span>\n      frame_type <span class=\"token operator\">=</span> <span class=\"token number\">4</span> <span class=\"token comment\">/* same */</span></code></pre>\n\n<p>我们通过 ASM 修改 HelloWorld.class 字节码文件，实现统计方法执行时间的功能</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CostTime</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">redefinePersonClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">redefinePersonClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">String</span> className <span class=\"token operator\">=</span> <span class=\"token string\">\"com.lijiankun24.asmpractice.demo.HelloWorld\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">InputStream</span> inputStream <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileInputStream</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/Users/lijiankun/Desktop/HelloWorld.class\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">ClassReader</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassReader</span><span class=\"token punctuation\">(</span>inputStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                               <span class=\"token comment\">// 1. 创建 ClassReader 读入 .class 文件到内存中</span>\n            <span class=\"token class-name\">ClassWriter</span> writer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassWriter</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ClassWriter</span><span class=\"token punctuation\">.</span><span class=\"token constant\">COMPUTE_MAXS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                 <span class=\"token comment\">// 2. 创建 ClassWriter 对象，将操作之后的字节码的字节数组回写</span>\n            <span class=\"token class-name\">ClassVisitor</span> change <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ChangeVisitor</span><span class=\"token punctuation\">(</span>writer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                                        <span class=\"token comment\">// 3. 创建自定义的 ClassVisitor 对象</span>\n            reader<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span>change<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ClassReader</span><span class=\"token punctuation\">.</span><span class=\"token constant\">EXPAND_FRAMES</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                                       <span class=\"token comment\">// 4. 将 ClassVisitor 对象传入 ClassReader 中</span>\n\n            <span class=\"token class-name\">Class</span> clazz <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">defineClass</span><span class=\"token punctuation\">(</span>className<span class=\"token punctuation\">,</span> writer<span class=\"token punctuation\">.</span><span class=\"token function\">toByteArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">Object</span> personObj <span class=\"token operator\">=</span> clazz<span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">Method</span> nameMethod <span class=\"token operator\">=</span> clazz<span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredMethod</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sayHello\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            nameMethod<span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>personObj<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Success!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> code <span class=\"token operator\">=</span> writer<span class=\"token punctuation\">.</span><span class=\"token function\">toByteArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                                                               <span class=\"token comment\">// 获取修改后的 class 文件对应的字节数组</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token class-name\">FileOutputStream</span> fos <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileOutputStream</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/Users/lijiankun/Desktop/HelloWorld2.class\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 将二进制流写到本地磁盘上</span>\n                fos<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                fos<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failure!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ChangeVisitor</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ClassVisitor</span> <span class=\"token punctuation\">&#123;</span>\n\n        <span class=\"token class-name\">ChangeVisitor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassVisitor</span> classVisitor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ASM5</span><span class=\"token punctuation\">,</span> classVisitor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">MethodVisitor</span> <span class=\"token function\">visitMethod</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> access<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> signature<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> exceptions<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">MethodVisitor</span> methodVisitor <span class=\"token operator\">=</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">visitMethod</span><span class=\"token punctuation\">(</span>access<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> desc<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">,</span> exceptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;init>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token keyword\">return</span> methodVisitor<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ChangeAdapter</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ASM4</span><span class=\"token punctuation\">,</span> methodVisitor<span class=\"token punctuation\">,</span> access<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> desc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ChangeAdapter</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AdviceAdapter</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> startTimeId <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> methodName <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">ChangeAdapter</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> api<span class=\"token punctuation\">,</span> <span class=\"token class-name\">MethodVisitor</span> mv<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> access<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>api<span class=\"token punctuation\">,</span> mv<span class=\"token punctuation\">,</span> access<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> desc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            methodName <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onMethodEnter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onMethodEnter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            startTimeId <span class=\"token operator\">=</span> <span class=\"token function\">newLocal</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Type</span><span class=\"token punctuation\">.</span><span class=\"token constant\">LONG_TYPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INVOKESTATIC</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/System\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"currentTimeMillis\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"()J\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitIntInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">LSTORE</span><span class=\"token punctuation\">,</span> startTimeId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onMethodExit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> opcode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onMethodExit</span><span class=\"token punctuation\">(</span>opcode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">int</span> durationId <span class=\"token operator\">=</span> <span class=\"token function\">newLocal</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Type</span><span class=\"token punctuation\">.</span><span class=\"token constant\">LONG_TYPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INVOKESTATIC</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/System\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"currentTimeMillis\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"()J\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitVarInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">LLOAD</span><span class=\"token punctuation\">,</span> startTimeId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">LSUB</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitVarInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">LSTORE</span><span class=\"token punctuation\">,</span> durationId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitFieldInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">GETSTATIC</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/System\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"out\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Ljava/io/PrintStream;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitTypeInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NEW</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/StringBuilder\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DUP</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INVOKESPECIAL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/StringBuilder\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"&lt;init>\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"()V\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitLdcInsn</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"The cost time of \"</span> <span class=\"token operator\">+</span> methodName <span class=\"token operator\">+</span> <span class=\"token string\">\" is \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INVOKEVIRTUAL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/StringBuilder\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"append\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"(Ljava/lang/String;)Ljava/lang/StringBuilder;\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitVarInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">LLOAD</span><span class=\"token punctuation\">,</span> durationId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INVOKEVIRTUAL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/StringBuilder\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"append\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"(J)Ljava/lang/StringBuilder;\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INVOKEVIRTUAL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/StringBuilder\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"toString\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"()Ljava/lang/String;\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INVOKEVIRTUAL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/io/PrintStream\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"println\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"(Ljava/lang/String;)V\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>执行结果如下图所示</p>\n<p><img src=\"/images/4179925-32ee7bd0974a4679.webp\" alt=\"img\"></p>\n<p>Class.png</p>\n<p>反编译 HelloWorld2.class 文件的内容如下所示</p>\n<p><img src=\"/images/4179925-af582100631d7eec.webp\" alt=\"img\"></p>\n<p>Class1.png</p>\n<h4 id=\"3-2-修改类中属性的字节码\"><a href=\"#3-2-修改类中属性的字节码\" class=\"headerlink\" title=\"3.2 修改类中属性的字节码\"></a>3.2 修改类中属性的字节码</h4><p>这一节中我们将展示一下如何使用 Core API 对类中的属性进行操作。</p>\n<p>假如说，现在有一个 Person.java 类如下所示：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Person</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> sex<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们想为这个类，添加一个 ‘public int age’ 的属性该怎么添加呢？我们会面对两个问题：</p>\n<ol>\n<li>该调用 ASM 的哪个 API 添加属性呢？</li>\n<li>在何时写添加属性的代码？</li>\n</ol>\n<p>接下来，我们就一一解决上面的两个问题？</p>\n<h5 id=\"3-2-1-添加属性的-API\"><a href=\"#3-2-1-添加属性的-API\" class=\"headerlink\" title=\"3.2.1 添加属性的 API\"></a>3.2.1 添加属性的 API</h5><p>按照我们分析的上述的 2.6 操作流程叙述，需要以下三个步骤：</p>\n<ol>\n<li>需要创建一个 ClassReader 对象，将 .class 文件的内容读入到一个字节数组中</li>\n<li>然后需要一个 ClassWriter 的对象将操作之后的字节码的字节数组回写</li>\n<li>需要创建一个事件过滤器 ClassVisitor。事件过滤器中的某些方法可以产生一个新的XXXVisitor对象，当我们需要修改对应的内容时只要实现自己的XXXVisitor并返回就可以了</li>\n</ol>\n<p>在上面三个步骤中，可以操作的就是 ClassVisitor 了。ClassVisitor 接口提供了和类结构同名的一些方法，这些方法可以对相应的类结构进行操作。</p>\n<p>在使用 ClassVisitor 添加类属性的时候，只需要添加一句话就可以了：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\">classVisitor<span class=\"token punctuation\">.</span><span class=\"token function\">visitField</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACC_PUBLIC</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"age\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Type</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p><img src=\"/images/4179925-8c703df0b005aae7.webp\" alt=\"img\"></p>\n<p>visitField.png</p>\n<h5 id=\"3-2-2-添加属性的时机\"><a href=\"#3-2-2-添加属性的时机\" class=\"headerlink\" title=\"3.2.2 添加属性的时机\"></a>3.2.2 添加属性的时机</h5><p>我们先暂且在 ClassVisitor 的 visitEnd() 方法中写入上面的代码，如下所示</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Transform</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ClassVisitor</span> <span class=\"token punctuation\">&#123;</span>  \n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Transform</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassVisitor</span> cv<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  \n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>cv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">&#125;</span>  \n\n    <span class=\"token annotation punctuation\">@Override</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">visitEnd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  \n        cv<span class=\"token punctuation\">.</span><span class=\"token function\">visitField</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACC_PUBLIC</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"age\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Type</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">&#125;</span>  \n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们写如下的测试类，测试一下</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FieldPractice</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">addAgeField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addAgeField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">InputStream</span> inputStream <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileInputStream</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/Users/lijiankun/Desktop/Person.class\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">ClassReader</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassReader</span><span class=\"token punctuation\">(</span>inputStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\">ClassWriter</span> writer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassWriter</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassWriter</span><span class=\"token punctuation\">.</span><span class=\"token constant\">COMPUTE_MAXS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\">ClassVisitor</span> visitor <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transform</span><span class=\"token punctuation\">(</span>writer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            reader<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span>visitor<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ClassReader</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SKIP_DEBUG</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> classFile <span class=\"token operator\">=</span> writer<span class=\"token punctuation\">.</span><span class=\"token function\">toByteArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">MyClassLoader</span> classLoader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">Class</span> clazz <span class=\"token operator\">=</span> classLoader<span class=\"token punctuation\">.</span><span class=\"token function\">defineClass</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Person\"</span><span class=\"token punctuation\">,</span> classFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">Object</span> obj <span class=\"token operator\">=</span> clazz<span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>clazz<span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//----(1)</span>\n            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>clazz<span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"age\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//----(2)</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>其输出入下所示：</p>\n<p><img src=\"/images/4179925-a718d240e05a2198.webp\" alt=\"img\"></p>\n<p>visitFieldResult.png</p>\n<p>那如果我们尝试在 ClassVisitor#visitField() 方法中添加属性可以吗？我们可以修改 Transform 测试一下：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Transform</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ClassVisitor</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token class-name\">Transform</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassVisitor</span> classVisitor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ASM5</span><span class=\"token punctuation\">,</span> classVisitor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">FieldVisitor</span> <span class=\"token function\">visitField</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> access<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> signature<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        cv<span class=\"token punctuation\">.</span><span class=\"token function\">visitField</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACC_PUBLIC</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"age\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Type</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">visitField</span><span class=\"token punctuation\">(</span>access<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> desc<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>还是使用上面的测试代码测试一下，会有如下的测试结果</p>\n<p><img src=\"/images/4179925-e2e730e41623be28.webp\" alt=\"img\"></p>\n<p>visitFieldError.png</p>\n<p>在 Person 类中有重复的属性，为什么会报这个错误呢？</p>\n<p>分析 ClassVisitor#visitField() 方法可得知，只要访问类中的一个属性，visitField() 方法就会被调用一次，在 Person 类中有两个属性，所以 visitField() 方法就会被调用两次，也就添加了两次 ‘public int age’ 属性，就报了上述的错误，而 visitEnd() 方法只有在最后才会被调用且只调用一次，所以在 visitEnd() 方法中是添加属性的最佳时机</p>\n<h4 id=\"3-3-ASMifier\"><a href=\"#3-3-ASMifier\" class=\"headerlink\" title=\"3.3 ASMifier\"></a>3.3 ASMifier</h4><p>可能有人会问，我刚开始学，上面例子中那些 ASM 的代码我还不会写，怎么办呢？ASM 官方为我们提供了 <a href=\"https://asm.ow2.io/#Q10\">ASMifier</a>，可以帮助我们生成这些晦涩难懂的 ASM 代码。</p>\n<p>比如，我想通过 ASM 实现统计一个方法的执行时间，该怎么做呢？一般会有如下的代码：</p>\n<pre class=\"language-csharp\" data-language=\"csharp\"><code class=\"language-csharp\">package com<span class=\"token punctuation\">.</span>lijiankun24<span class=\"token punctuation\">.</span>classpractice<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Demo</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">costTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">long</span></span> startTime <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// ......</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">long</span></span> duration <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> startTime<span class=\"token punctuation\">;</span>\n        System<span class=\"token punctuation\">.</span><span class=\"token keyword\">out</span><span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"The cost time of this method is \"</span> <span class=\"token operator\">+</span> duration <span class=\"token operator\">+</span> <span class=\"token string\">\" ms\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>那上面这段代码对应的 ASM 代码是什么呢？我们可以通过以下两个步骤，使用 ASMifier 自动生成：</p>\n<ol>\n<li>通过 <code>javac</code> 编译该 <code>Demo.java</code> 文件生成对应的 <code>Demo.class</code> 文件，如下所示</li>\n</ol>\n<pre class=\"language-css\" data-language=\"css\"><code class=\"language-css\">javac Demo.java</code></pre>\n\n<ol>\n<li>通过 ASMifier 自动生成对应的 ASM 代码。首先需要在<a href=\"https://asm.ow2.io/#Q10\">ASM官网</a> 下载 <code>asm-all.jar</code> 库，我下载的是最新的 <code>asm-all-5.2.jar</code>，然后使用如下命令，即可生成</li>\n</ol>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\">java <span class=\"token operator\">-</span>classpath asm<span class=\"token operator\">-</span>all<span class=\"token operator\">-</span><span class=\"token number\">5.2</span><span class=\"token punctuation\">.</span>jar <span class=\"token class-name\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>objectweb<span class=\"token punctuation\">.</span>asm<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span>ASMifier</span> <span class=\"token class-name\">Demo</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span></code></pre>\n\n<p>截图如下：</p>\n<p><img src=\"/images/4179925-0cc8712718f08ea0.webp\" alt=\"img\"></p>\n<p>DemoDump.png</p>\n<p><a href=\"https://my.oschina.net/ta8210/blog/163550\">深入字节码 – 玩转 ASM-Bytecode 原 荐</a><br> <a href=\"http://www.easemob.com/news/729\">美团热更方案ASM实践</a></p>\n<p>43人点赞</p>\n<p><a href=\"\">Java 相关</a></p>\n<p>作者：lijiankun24<br>链接：<a href=\"https://www.jianshu.com/p/905be2a9a700\">https://www.jianshu.com/p/905be2a9a700</a><br>来源：简书<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>\n","excerpt":"","more":"<blockquote>\n<p><a href=\"https://www.jianshu.com/p/905be2a9a700\">原文</a></p>\n</blockquote>\n<p>前面几篇文章介绍了 .class 文件的结构、JVM 如何加载 .class 文件、JVM 中如何执行方法的调用和访问者模式，其实前面几篇文章都是为这篇文章做铺垫的，如果不知道 .class 文件结构、也不知道在 JVM 中 .class 文件中的方法是如何被执行的，这篇文章中的有些部分可能会看不懂，所以推荐先看下前面几篇文章。<br> 这篇文章主要介绍 ASM 库的结构、主要的 API，并且通过两个示例说明如何通过 ASM 修改 .class 文件中的方法和属性。</p>\n<p><img src=\"/images/ezgif-6-73b502b11e16.jpg\" alt=\"img\"></p>\n<p>catalog.png</p>\n<h3 id=\"一-ASM-的结构\"><a href=\"#一-ASM-的结构\" class=\"headerlink\" title=\"一. ASM 的结构\"></a>一. ASM 的结构</h3><p>ASM 库是一款基于 Java 字节码层面的代码分析和修改工具。ASM 可以直接生产二进制的 class 文件，也可以在类被加载入 JVM 之前动态修改类行为。<br> ASM 库的结构如下所示：</p>\n<p><img src=\"/images/4179925-d4f950ec94a12cde.webp\" alt=\"img\"></p>\n<p>asm_arch.png</p>\n<ul>\n<li>Core：为其他包提供基础的读、写、转化Java字节码和定义的API，并且可以生成Java字节码和实现大部分字节码的转换，在 <a href=\"https://www.jianshu.com/p/e4b8cb0b3204\">访问者模式和 ASM</a> 中介绍的几个重要的类就在 Core API 中：ClassReader、ClassVisitor 和 ClassWriter 类.</li>\n<li>Tree：提供了 Java 字节码在内存中的表现</li>\n<li>Commons：提供了一些常用的简化字节码生成、转换的类和适配器</li>\n<li>Util：包含一些帮助类和简单的字节码修改类，有利于在开发或者测试中使用</li>\n<li>XML：提供一个适配器将XML和SAX-comliant转化成字节码结构，可以允许使用XSLT去定义字节码转化</li>\n</ul>\n<h3 id=\"二-Core-API-介绍\"><a href=\"#二-Core-API-介绍\" class=\"headerlink\" title=\"二. Core API 介绍\"></a>二. Core API 介绍</h3><h4 id=\"2-1-ClassVisitor-抽象类\"><a href=\"#2-1-ClassVisitor-抽象类\" class=\"headerlink\" title=\"2.1 ClassVisitor 抽象类\"></a>2.1 ClassVisitor 抽象类</h4><p>如下所示，在 ClassVisitor 中提供了和类结构同名的一些方法，这些方法会对类中相应的部分进行操作，而且是有顺序的：visit [ visitSource ] [ visitOuterClass ] ( visitAnnotation | visitAttribute )* (visitInnerClass | visitField | visitMethod )* visitEnd</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ClassVisitor</span> <span class=\"token punctuation\">&#123;</span>\n\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">visit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> version<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> access<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> signature<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> superName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> interfaces<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">visitSource</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> source<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> debug<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">visitOuterClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> owner<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AnnotationVisitor</span> <span class=\"token function\">visitAnnotation</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> visible<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AnnotationVisitor</span> <span class=\"token function\">visitTypeAnnotation</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> typeRef<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TypePath</span> typePath<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> visible<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">visitAttribute</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Attribute</span> attr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">visitInnerClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> outerName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> innerName<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> access<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">FieldVisitor</span> <span class=\"token function\">visitField</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> access<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> signature<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MethodVisitor</span> <span class=\"token function\">visitMethod</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> access<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> signature<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> exceptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">visitEnd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<ol>\n<li>void visit(int version, int access, String name, String signature, String superName, String[] interfaces)<br> 该方法是当扫描类时第一个调用的方法，主要用于类声明使用。下面是对方法中各个参数的示意：visit( 类版本 , 修饰符 , 类名 , 泛型信息 , 继承的父类 , 实现的接口)</li>\n<li>AnnotationVisitor visitAnnotation(String desc, boolean visible)<br> 该方法是当扫描器扫描到类注解声明时进行调用。下面是对方法中各个参数的示意：visitAnnotation(注解类型 , 注解是否可以在 JVM 中可见)。</li>\n<li>FieldVisitor visitField(int access, String name, String desc, String signature, Object value)<br> 该方法是当扫描器扫描到类中字段时进行调用。下面是对方法中各个参数的示意：visitField(修饰符 , 字段名 , 字段类型 , 泛型描述 , 默认值)</li>\n<li>MethodVisitor visitMethod(int access, String name, String desc, String signature, String[] exceptions)<br> 该方法是当扫描器扫描到类的方法时进行调用。下面是对方法中各个参数的示意：visitMethod(修饰符 , 方法名 , 方法签名 , 泛型信息 , 抛出的异常)</li>\n<li>void visitEnd()<br> 该方法是当扫描器完成类扫描时才会调用，如果想在类中追加某些方法</li>\n</ol>\n<h4 id=\"2-2-ClassReader-类\"><a href=\"#2-2-ClassReader-类\" class=\"headerlink\" title=\"2.2 ClassReader 类\"></a>2.2 ClassReader 类</h4><p>这个类会将 .class 文件读入到 ClassReader 中的字节数组中，它的 accept 方法接受一个 ClassVisitor 实现类，并按照顺序调用 ClassVisitor 中的方法</p>\n<h4 id=\"2-3-ClassWriter-类\"><a href=\"#2-3-ClassWriter-类\" class=\"headerlink\" title=\"2.3 ClassWriter 类\"></a>2.3 ClassWriter 类</h4><p>ClassWriter 是一个 ClassVisitor 的子类，是和 ClassReader 对应的类，ClassReader 是将 .class 文件读入到一个字节数组中，ClassWriter 是将修改后的类的字节码内容以字节数组的形式输出。</p>\n<h4 id=\"2-4-MethodVisitor-AdviceAdapter\"><a href=\"#2-4-MethodVisitor-AdviceAdapter\" class=\"headerlink\" title=\"2.4 MethodVisitor &amp; AdviceAdapter\"></a>2.4 MethodVisitor &amp; AdviceAdapter</h4><p>MethodVisitor 是一个抽象类，当 ASM 的 ClassReader 读取到 Method 时就转入 MethodVisitor 接口处理。<br> AdviceAdapter 是 MethodVisitor 的子类，使用 AdviceAdapter 可以更方便的修改方法的字节码。<br> AdviceAdapter 的方法如下所示：</p>\n<p><img src=\"/images/4179925-f5a428b729962860.webp\" alt=\"img\"></p>\n<p>AdviceAdapter.png</p>\n<p>其中比较重要的几个方法如下：</p>\n<ol>\n<li>void visitCode()：表示 ASM 开始扫描这个方法</li>\n<li>void onMethodEnter()：进入这个方法</li>\n<li>void onMethodExit()：即将从这个方法出去</li>\n<li>void onVisitEnd()：表示方法扫码完毕</li>\n</ol>\n<h4 id=\"2-5-FieldVisitor-抽象类\"><a href=\"#2-5-FieldVisitor-抽象类\" class=\"headerlink\" title=\"2.5 FieldVisitor 抽象类\"></a>2.5 FieldVisitor 抽象类</h4><p>FieldVisitor 是一个抽象类，当 ASM 的 ClassReader 读取到 Field 时就转入 FieldVisitor 接口处理。和分析 MethodVisitor 的方法一样，也可以查看源码注释进行学习，这里不再详细介绍</p>\n<h4 id=\"2-6-操作流程\"><a href=\"#2-6-操作流程\" class=\"headerlink\" title=\"2.6 操作流程\"></a>2.6 操作流程</h4><ol>\n<li>需要创建一个 ClassReader 对象，将 .class 文件的内容读入到一个字节数组中</li>\n<li>然后需要一个 ClassWriter 的对象将操作之后的字节码的字节数组回写</li>\n<li>需要事件过滤器 ClassVisitor。在调用 ClassVisitor 的某些方法时会产生一个新的 XXXVisitor 对象，当我们需要修改对应的内容时只要实现自己的 XXXVisitor 并返回就可以了</li>\n</ol>\n<h3 id=\"三-示例\"><a href=\"#三-示例\" class=\"headerlink\" title=\"三. 示例\"></a>三. 示例</h3><h4 id=\"3-1-修改类中方法的字节码\"><a href=\"#3-1-修改类中方法的字节码\" class=\"headerlink\" title=\"3.1 修改类中方法的字节码\"></a>3.1 修改类中方法的字节码</h4><p>假如现在我们有一个 HelloWorld 类，如下</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>lijiankun24<span class=\"token punctuation\">.</span>asmpractice<span class=\"token punctuation\">.</span>demo</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HelloWorld</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">sayHello</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>通过 <code>javac HelloWorld.java</code> 和 <code>javap -verbose HelloWorld.class</code> 可以查看到 sayName() 方法的字节码如下所示：</p>\n<pre class=\"language-cpp\" data-language=\"cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">sayHello</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  descriptor<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>V\n  flags<span class=\"token operator\">:</span> ACC_PUBLIC\n  Code<span class=\"token operator\">:</span>\n    stack<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> locals<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> args_size<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n       <span class=\"token number\">0</span><span class=\"token operator\">:</span> ldc2_w        #<span class=\"token number\">2</span>                  <span class=\"token comment\">// long 2000l</span>\n       <span class=\"token number\">3</span><span class=\"token operator\">:</span> invokestatic  #<span class=\"token number\">4</span>                  <span class=\"token comment\">// Method java/lang/Thread.sleep:(J)V</span>\n       <span class=\"token number\">6</span><span class=\"token operator\">:</span> <span class=\"token keyword\">goto</span>          <span class=\"token number\">14</span>\n       <span class=\"token number\">9</span><span class=\"token operator\">:</span> astore_1\n      <span class=\"token number\">10</span><span class=\"token operator\">:</span> aload_1\n      <span class=\"token number\">11</span><span class=\"token operator\">:</span> invokevirtual #<span class=\"token number\">6</span>                  <span class=\"token comment\">// Method java/lang/InterruptedException.printStackTrace:()V</span>\n      <span class=\"token number\">14</span><span class=\"token operator\">:</span> <span class=\"token keyword\">return</span>\n    Exception table<span class=\"token operator\">:</span>\n       from    to  target type\n           <span class=\"token number\">0</span>     <span class=\"token number\">6</span>     <span class=\"token number\">9</span>   Class java<span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span>InterruptedException\n    LineNumberTable<span class=\"token operator\">:</span>\n      line <span class=\"token number\">5</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n      line <span class=\"token number\">8</span><span class=\"token operator\">:</span> <span class=\"token number\">6</span>\n      line <span class=\"token number\">6</span><span class=\"token operator\">:</span> <span class=\"token number\">9</span>\n      line <span class=\"token number\">7</span><span class=\"token operator\">:</span> <span class=\"token number\">10</span>\n      line <span class=\"token number\">9</span><span class=\"token operator\">:</span> <span class=\"token number\">14</span>\n    StackMapTable<span class=\"token operator\">:</span> number_of_entries <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n      frame_type <span class=\"token operator\">=</span> <span class=\"token number\">73</span> <span class=\"token comment\">/* same_locals_1_stack_item */</span>\n        stack <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">java</span><span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span>InterruptedException <span class=\"token punctuation\">]</span>\n      frame_type <span class=\"token operator\">=</span> <span class=\"token number\">4</span> <span class=\"token comment\">/* same */</span></code></pre>\n\n<p>我们通过 ASM 修改 HelloWorld.class 字节码文件，实现统计方法执行时间的功能</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CostTime</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">redefinePersonClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">redefinePersonClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">String</span> className <span class=\"token operator\">=</span> <span class=\"token string\">\"com.lijiankun24.asmpractice.demo.HelloWorld\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">InputStream</span> inputStream <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileInputStream</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/Users/lijiankun/Desktop/HelloWorld.class\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">ClassReader</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassReader</span><span class=\"token punctuation\">(</span>inputStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                               <span class=\"token comment\">// 1. 创建 ClassReader 读入 .class 文件到内存中</span>\n            <span class=\"token class-name\">ClassWriter</span> writer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassWriter</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ClassWriter</span><span class=\"token punctuation\">.</span><span class=\"token constant\">COMPUTE_MAXS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                 <span class=\"token comment\">// 2. 创建 ClassWriter 对象，将操作之后的字节码的字节数组回写</span>\n            <span class=\"token class-name\">ClassVisitor</span> change <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ChangeVisitor</span><span class=\"token punctuation\">(</span>writer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                                        <span class=\"token comment\">// 3. 创建自定义的 ClassVisitor 对象</span>\n            reader<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span>change<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ClassReader</span><span class=\"token punctuation\">.</span><span class=\"token constant\">EXPAND_FRAMES</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                                       <span class=\"token comment\">// 4. 将 ClassVisitor 对象传入 ClassReader 中</span>\n\n            <span class=\"token class-name\">Class</span> clazz <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">defineClass</span><span class=\"token punctuation\">(</span>className<span class=\"token punctuation\">,</span> writer<span class=\"token punctuation\">.</span><span class=\"token function\">toByteArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">Object</span> personObj <span class=\"token operator\">=</span> clazz<span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">Method</span> nameMethod <span class=\"token operator\">=</span> clazz<span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredMethod</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sayHello\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            nameMethod<span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>personObj<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Success!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> code <span class=\"token operator\">=</span> writer<span class=\"token punctuation\">.</span><span class=\"token function\">toByteArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                                                               <span class=\"token comment\">// 获取修改后的 class 文件对应的字节数组</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token class-name\">FileOutputStream</span> fos <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileOutputStream</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/Users/lijiankun/Desktop/HelloWorld2.class\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 将二进制流写到本地磁盘上</span>\n                fos<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                fos<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failure!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ChangeVisitor</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ClassVisitor</span> <span class=\"token punctuation\">&#123;</span>\n\n        <span class=\"token class-name\">ChangeVisitor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassVisitor</span> classVisitor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ASM5</span><span class=\"token punctuation\">,</span> classVisitor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">MethodVisitor</span> <span class=\"token function\">visitMethod</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> access<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> signature<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> exceptions<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">MethodVisitor</span> methodVisitor <span class=\"token operator\">=</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">visitMethod</span><span class=\"token punctuation\">(</span>access<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> desc<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">,</span> exceptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;init>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token keyword\">return</span> methodVisitor<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ChangeAdapter</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ASM4</span><span class=\"token punctuation\">,</span> methodVisitor<span class=\"token punctuation\">,</span> access<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> desc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ChangeAdapter</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AdviceAdapter</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> startTimeId <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> methodName <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">ChangeAdapter</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> api<span class=\"token punctuation\">,</span> <span class=\"token class-name\">MethodVisitor</span> mv<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> access<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>api<span class=\"token punctuation\">,</span> mv<span class=\"token punctuation\">,</span> access<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> desc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            methodName <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onMethodEnter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onMethodEnter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            startTimeId <span class=\"token operator\">=</span> <span class=\"token function\">newLocal</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Type</span><span class=\"token punctuation\">.</span><span class=\"token constant\">LONG_TYPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INVOKESTATIC</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/System\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"currentTimeMillis\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"()J\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitIntInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">LSTORE</span><span class=\"token punctuation\">,</span> startTimeId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onMethodExit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> opcode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onMethodExit</span><span class=\"token punctuation\">(</span>opcode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">int</span> durationId <span class=\"token operator\">=</span> <span class=\"token function\">newLocal</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Type</span><span class=\"token punctuation\">.</span><span class=\"token constant\">LONG_TYPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INVOKESTATIC</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/System\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"currentTimeMillis\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"()J\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitVarInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">LLOAD</span><span class=\"token punctuation\">,</span> startTimeId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">LSUB</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitVarInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">LSTORE</span><span class=\"token punctuation\">,</span> durationId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitFieldInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">GETSTATIC</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/System\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"out\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Ljava/io/PrintStream;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitTypeInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NEW</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/StringBuilder\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DUP</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INVOKESPECIAL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/StringBuilder\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"&lt;init>\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"()V\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitLdcInsn</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"The cost time of \"</span> <span class=\"token operator\">+</span> methodName <span class=\"token operator\">+</span> <span class=\"token string\">\" is \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INVOKEVIRTUAL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/StringBuilder\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"append\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"(Ljava/lang/String;)Ljava/lang/StringBuilder;\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitVarInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">LLOAD</span><span class=\"token punctuation\">,</span> durationId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INVOKEVIRTUAL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/StringBuilder\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"append\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"(J)Ljava/lang/StringBuilder;\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INVOKEVIRTUAL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/StringBuilder\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"toString\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"()Ljava/lang/String;\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mv<span class=\"token punctuation\">.</span><span class=\"token function\">visitMethodInsn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INVOKEVIRTUAL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/io/PrintStream\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"println\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"(Ljava/lang/String;)V\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>执行结果如下图所示</p>\n<p><img src=\"/images/4179925-32ee7bd0974a4679.webp\" alt=\"img\"></p>\n<p>Class.png</p>\n<p>反编译 HelloWorld2.class 文件的内容如下所示</p>\n<p><img src=\"/images/4179925-af582100631d7eec.webp\" alt=\"img\"></p>\n<p>Class1.png</p>\n<h4 id=\"3-2-修改类中属性的字节码\"><a href=\"#3-2-修改类中属性的字节码\" class=\"headerlink\" title=\"3.2 修改类中属性的字节码\"></a>3.2 修改类中属性的字节码</h4><p>这一节中我们将展示一下如何使用 Core API 对类中的属性进行操作。</p>\n<p>假如说，现在有一个 Person.java 类如下所示：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Person</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> sex<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们想为这个类，添加一个 ‘public int age’ 的属性该怎么添加呢？我们会面对两个问题：</p>\n<ol>\n<li>该调用 ASM 的哪个 API 添加属性呢？</li>\n<li>在何时写添加属性的代码？</li>\n</ol>\n<p>接下来，我们就一一解决上面的两个问题？</p>\n<h5 id=\"3-2-1-添加属性的-API\"><a href=\"#3-2-1-添加属性的-API\" class=\"headerlink\" title=\"3.2.1 添加属性的 API\"></a>3.2.1 添加属性的 API</h5><p>按照我们分析的上述的 2.6 操作流程叙述，需要以下三个步骤：</p>\n<ol>\n<li>需要创建一个 ClassReader 对象，将 .class 文件的内容读入到一个字节数组中</li>\n<li>然后需要一个 ClassWriter 的对象将操作之后的字节码的字节数组回写</li>\n<li>需要创建一个事件过滤器 ClassVisitor。事件过滤器中的某些方法可以产生一个新的XXXVisitor对象，当我们需要修改对应的内容时只要实现自己的XXXVisitor并返回就可以了</li>\n</ol>\n<p>在上面三个步骤中，可以操作的就是 ClassVisitor 了。ClassVisitor 接口提供了和类结构同名的一些方法，这些方法可以对相应的类结构进行操作。</p>\n<p>在使用 ClassVisitor 添加类属性的时候，只需要添加一句话就可以了：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\">classVisitor<span class=\"token punctuation\">.</span><span class=\"token function\">visitField</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACC_PUBLIC</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"age\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Type</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p><img src=\"/images/4179925-8c703df0b005aae7.webp\" alt=\"img\"></p>\n<p>visitField.png</p>\n<h5 id=\"3-2-2-添加属性的时机\"><a href=\"#3-2-2-添加属性的时机\" class=\"headerlink\" title=\"3.2.2 添加属性的时机\"></a>3.2.2 添加属性的时机</h5><p>我们先暂且在 ClassVisitor 的 visitEnd() 方法中写入上面的代码，如下所示</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Transform</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ClassVisitor</span> <span class=\"token punctuation\">&#123;</span>  \n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Transform</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassVisitor</span> cv<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  \n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>cv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">&#125;</span>  \n\n    <span class=\"token annotation punctuation\">@Override</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">visitEnd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  \n        cv<span class=\"token punctuation\">.</span><span class=\"token function\">visitField</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACC_PUBLIC</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"age\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Type</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">&#125;</span>  \n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们写如下的测试类，测试一下</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FieldPractice</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">addAgeField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addAgeField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">InputStream</span> inputStream <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileInputStream</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/Users/lijiankun/Desktop/Person.class\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">ClassReader</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassReader</span><span class=\"token punctuation\">(</span>inputStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\">ClassWriter</span> writer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassWriter</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassWriter</span><span class=\"token punctuation\">.</span><span class=\"token constant\">COMPUTE_MAXS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\">ClassVisitor</span> visitor <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transform</span><span class=\"token punctuation\">(</span>writer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            reader<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span>visitor<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ClassReader</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SKIP_DEBUG</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> classFile <span class=\"token operator\">=</span> writer<span class=\"token punctuation\">.</span><span class=\"token function\">toByteArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">MyClassLoader</span> classLoader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">Class</span> clazz <span class=\"token operator\">=</span> classLoader<span class=\"token punctuation\">.</span><span class=\"token function\">defineClass</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Person\"</span><span class=\"token punctuation\">,</span> classFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">Object</span> obj <span class=\"token operator\">=</span> clazz<span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>clazz<span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//----(1)</span>\n            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>clazz<span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"age\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//----(2)</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>其输出入下所示：</p>\n<p><img src=\"/images/4179925-a718d240e05a2198.webp\" alt=\"img\"></p>\n<p>visitFieldResult.png</p>\n<p>那如果我们尝试在 ClassVisitor#visitField() 方法中添加属性可以吗？我们可以修改 Transform 测试一下：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Transform</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ClassVisitor</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token class-name\">Transform</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassVisitor</span> classVisitor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ASM5</span><span class=\"token punctuation\">,</span> classVisitor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">FieldVisitor</span> <span class=\"token function\">visitField</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> access<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> signature<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        cv<span class=\"token punctuation\">.</span><span class=\"token function\">visitField</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Opcodes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACC_PUBLIC</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"age\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Type</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">visitField</span><span class=\"token punctuation\">(</span>access<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> desc<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>还是使用上面的测试代码测试一下，会有如下的测试结果</p>\n<p><img src=\"/images/4179925-e2e730e41623be28.webp\" alt=\"img\"></p>\n<p>visitFieldError.png</p>\n<p>在 Person 类中有重复的属性，为什么会报这个错误呢？</p>\n<p>分析 ClassVisitor#visitField() 方法可得知，只要访问类中的一个属性，visitField() 方法就会被调用一次，在 Person 类中有两个属性，所以 visitField() 方法就会被调用两次，也就添加了两次 ‘public int age’ 属性，就报了上述的错误，而 visitEnd() 方法只有在最后才会被调用且只调用一次，所以在 visitEnd() 方法中是添加属性的最佳时机</p>\n<h4 id=\"3-3-ASMifier\"><a href=\"#3-3-ASMifier\" class=\"headerlink\" title=\"3.3 ASMifier\"></a>3.3 ASMifier</h4><p>可能有人会问，我刚开始学，上面例子中那些 ASM 的代码我还不会写，怎么办呢？ASM 官方为我们提供了 <a href=\"https://asm.ow2.io/#Q10\">ASMifier</a>，可以帮助我们生成这些晦涩难懂的 ASM 代码。</p>\n<p>比如，我想通过 ASM 实现统计一个方法的执行时间，该怎么做呢？一般会有如下的代码：</p>\n<pre class=\"language-csharp\" data-language=\"csharp\"><code class=\"language-csharp\">package com<span class=\"token punctuation\">.</span>lijiankun24<span class=\"token punctuation\">.</span>classpractice<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Demo</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">costTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">long</span></span> startTime <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// ......</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">long</span></span> duration <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> startTime<span class=\"token punctuation\">;</span>\n        System<span class=\"token punctuation\">.</span><span class=\"token keyword\">out</span><span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"The cost time of this method is \"</span> <span class=\"token operator\">+</span> duration <span class=\"token operator\">+</span> <span class=\"token string\">\" ms\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>那上面这段代码对应的 ASM 代码是什么呢？我们可以通过以下两个步骤，使用 ASMifier 自动生成：</p>\n<ol>\n<li>通过 <code>javac</code> 编译该 <code>Demo.java</code> 文件生成对应的 <code>Demo.class</code> 文件，如下所示</li>\n</ol>\n<pre class=\"language-css\" data-language=\"css\"><code class=\"language-css\">javac Demo.java</code></pre>\n\n<ol>\n<li>通过 ASMifier 自动生成对应的 ASM 代码。首先需要在<a href=\"https://asm.ow2.io/#Q10\">ASM官网</a> 下载 <code>asm-all.jar</code> 库，我下载的是最新的 <code>asm-all-5.2.jar</code>，然后使用如下命令，即可生成</li>\n</ol>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\">java <span class=\"token operator\">-</span>classpath asm<span class=\"token operator\">-</span>all<span class=\"token operator\">-</span><span class=\"token number\">5.2</span><span class=\"token punctuation\">.</span>jar <span class=\"token class-name\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>objectweb<span class=\"token punctuation\">.</span>asm<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span>ASMifier</span> <span class=\"token class-name\">Demo</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span></code></pre>\n\n<p>截图如下：</p>\n<p><img src=\"/images/4179925-0cc8712718f08ea0.webp\" alt=\"img\"></p>\n<p>DemoDump.png</p>\n<p><a href=\"https://my.oschina.net/ta8210/blog/163550\">深入字节码 – 玩转 ASM-Bytecode 原 荐</a><br> <a href=\"http://www.easemob.com/news/729\">美团热更方案ASM实践</a></p>\n<p>43人点赞</p>\n<p><a href=\"\">Java 相关</a></p>\n<p>作者：lijiankun24<br>链接：<a href=\"https://www.jianshu.com/p/905be2a9a700\">https://www.jianshu.com/p/905be2a9a700</a><br>来源：简书<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>\n"},{"layout":"post","title":"Apk瘦身术","author":"boybeak","date":"2022-09-18T18:00:00.000Z","_content":"\n\nApk瘦身主要从三方面入手：资源文件、源代码和第三方类库。\n\n## 一、资源文件\n\n### 1.1 删除无用资源文件\n\n#### 1.1.1 Lint工具\n\n菜单 -> Analyze -> Run Inspection by Name，然后输入Unused resources便可以执行查找无用资源文件。自己根据需要进行删除。\n\n#### 1.1.2 shrinkResources\n\n```groovy\nbuildTypes {\n  release {\n    // 不显示Log\n    buildConfigField \"boolean\", \"LOG_DEBUG\", \"false\"\n    //混淆\n    minifyEnabled true\n    // 移除无用的resource文件\n    shrinkResources true\n    proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'\n    signingConfig signingConfigs.release\n  }\n}\n```\n\n使用shrinkResources的前提是，打开混淆minifyEnabled，建议只在release版本开启，不然会使得编译速度变慢。\n\n\n\n### 1.2 图标类资源图片矢量化\n\n对于图标类资源，可以选择用vector-drawable来代替，通过AndroidStudio自带的转换工具可以将svg文件转换为vector-drawable文件。\n\n> 具体操作为，在drawable相关文件夹上右键 -> New -> Vector Assert。\n\n你也可以进行批量转换：[工具地址](https://github.com/vdmeer/svg2vector)\n\n\n\n### 1.3 非图标类资源图片适当压缩与格式选择\n\n#### 1.3.1 使用tinypng有损压缩png图片\n\n通过[Tinypng](http://tinypng.com)官网上传压缩再下载，在保持alpha通道的情况下对png图片的压缩可达到1/3以内，且肉眼基本看不出差别。\n\n#### 1.3.2 使用jpg格式\n\n对于非透明的大图，jpg会比png的大小和内存都更有优势，虽然不是绝对的，但是通常会减少到一半不止。\n\n#### 1.3.3 使用webp格式\n\nwebp格式支持透明度，压缩比比jpg高，但是显示效果却不输于jpg。缺点是在Android端的原生支持不好，从Android4.0+开始原生支持，但是不支持透明度，从Android4.3+开始支持带有透明度的webp。如果不需要兼容到这个版本，可以直接使用。\n\n在Android studio中，在图片资源上右键可以转换为webp。详细参见[创建 WebP 图片](https://developer.android.com/studio/write/convert-webp)。\n\n#### 1.3.4 适当的压缩和尺寸\n\n无论以上哪种格式图片，都可以通过选择合适的尺寸和适当的提高压缩率的方式，来进一步减少文件大小，进而减小apk文件的体积。\n\n#### 1.3.5 帧动画尽可能使用lottie\n\n[Lottie](https://github.com/airbnb/lottie-android)是Aribnb开源的动画库，通过json文件来进行展示动画，动画文件可以通过Adobe AE来制作。\n\n \n\n### 1.4 有限国际化\n\n```groovy\nandroid {\n  defaultConfig {\n    resConfigs \"zh\"\n  }\n}\n```\n\n### 1.5 第三方库中大尺寸的无用资源同名替换\n\n如果在第三方类库中，存在用不到的图片资源文件，可以通过1x1像素的同名图片进行替换。\n\n\n\n### 1.6 使用AndResGuard\n\n[AndResGuard](https://github.com/shwenzhang/AndResGuard)，在gradle文件中就可以直接使用，非常方便。\n\n\n\n## 二、源代码\n\n### 2.1 开启混淆\n\n这是基本操作了，无需多言。\n\n### 2.2 手动修改开源代码\n\n将开源代码中我们不需要的类或者方法等删除掉，但是这需要对开源代码非常了解，而且确保版本兼容性，将来开源库升级或者随着我们产品需求变更对开源库的要求也改变了，都会影响对开源库的修改，不建议使用。\n\n## 三、第三方类库\n\n### 3.1 动态库\n\n#### 3.1.1 删除非必要平台so库\n\n```groovy\nndk {\n  //设置支持的so库架构\n  abiFilters \"armeabi-v7a\"\n}\n```\n\n基本上，对于手机来说，支持armeabi-v7a就足够了。\n\n#### 3.1.2 动态加载so库\n\n如果不是一启动应用就需要初始化的so库，完全可以在需要的时候再下载这个so文件，再通过以下代码进行加载。\n\n```java\nstatic {\n  System.loadLibrary(\"path/to/lib.so\");\n}\n```\n\n\n\n## 其他\n\n### 插件化\n\n将不需要在启动就加载的功能模块，通过插件化，在用户使用的时候再从服务器加载。\n\n### 删除class文件的debug items\n\n不建议使用，这种做法，事倍功半。\n\n","source":"_posts/2022-09-19-Apk瘦身术.md","raw":"---\nlayout: post\ntitle: Apk瘦身术\nauthor: boybeak\ncategory: Android技巧\ntags: Android\ndate: 2022-09-19 02:00:00\n---\n\n\nApk瘦身主要从三方面入手：资源文件、源代码和第三方类库。\n\n## 一、资源文件\n\n### 1.1 删除无用资源文件\n\n#### 1.1.1 Lint工具\n\n菜单 -> Analyze -> Run Inspection by Name，然后输入Unused resources便可以执行查找无用资源文件。自己根据需要进行删除。\n\n#### 1.1.2 shrinkResources\n\n```groovy\nbuildTypes {\n  release {\n    // 不显示Log\n    buildConfigField \"boolean\", \"LOG_DEBUG\", \"false\"\n    //混淆\n    minifyEnabled true\n    // 移除无用的resource文件\n    shrinkResources true\n    proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'\n    signingConfig signingConfigs.release\n  }\n}\n```\n\n使用shrinkResources的前提是，打开混淆minifyEnabled，建议只在release版本开启，不然会使得编译速度变慢。\n\n\n\n### 1.2 图标类资源图片矢量化\n\n对于图标类资源，可以选择用vector-drawable来代替，通过AndroidStudio自带的转换工具可以将svg文件转换为vector-drawable文件。\n\n> 具体操作为，在drawable相关文件夹上右键 -> New -> Vector Assert。\n\n你也可以进行批量转换：[工具地址](https://github.com/vdmeer/svg2vector)\n\n\n\n### 1.3 非图标类资源图片适当压缩与格式选择\n\n#### 1.3.1 使用tinypng有损压缩png图片\n\n通过[Tinypng](http://tinypng.com)官网上传压缩再下载，在保持alpha通道的情况下对png图片的压缩可达到1/3以内，且肉眼基本看不出差别。\n\n#### 1.3.2 使用jpg格式\n\n对于非透明的大图，jpg会比png的大小和内存都更有优势，虽然不是绝对的，但是通常会减少到一半不止。\n\n#### 1.3.3 使用webp格式\n\nwebp格式支持透明度，压缩比比jpg高，但是显示效果却不输于jpg。缺点是在Android端的原生支持不好，从Android4.0+开始原生支持，但是不支持透明度，从Android4.3+开始支持带有透明度的webp。如果不需要兼容到这个版本，可以直接使用。\n\n在Android studio中，在图片资源上右键可以转换为webp。详细参见[创建 WebP 图片](https://developer.android.com/studio/write/convert-webp)。\n\n#### 1.3.4 适当的压缩和尺寸\n\n无论以上哪种格式图片，都可以通过选择合适的尺寸和适当的提高压缩率的方式，来进一步减少文件大小，进而减小apk文件的体积。\n\n#### 1.3.5 帧动画尽可能使用lottie\n\n[Lottie](https://github.com/airbnb/lottie-android)是Aribnb开源的动画库，通过json文件来进行展示动画，动画文件可以通过Adobe AE来制作。\n\n \n\n### 1.4 有限国际化\n\n```groovy\nandroid {\n  defaultConfig {\n    resConfigs \"zh\"\n  }\n}\n```\n\n### 1.5 第三方库中大尺寸的无用资源同名替换\n\n如果在第三方类库中，存在用不到的图片资源文件，可以通过1x1像素的同名图片进行替换。\n\n\n\n### 1.6 使用AndResGuard\n\n[AndResGuard](https://github.com/shwenzhang/AndResGuard)，在gradle文件中就可以直接使用，非常方便。\n\n\n\n## 二、源代码\n\n### 2.1 开启混淆\n\n这是基本操作了，无需多言。\n\n### 2.2 手动修改开源代码\n\n将开源代码中我们不需要的类或者方法等删除掉，但是这需要对开源代码非常了解，而且确保版本兼容性，将来开源库升级或者随着我们产品需求变更对开源库的要求也改变了，都会影响对开源库的修改，不建议使用。\n\n## 三、第三方类库\n\n### 3.1 动态库\n\n#### 3.1.1 删除非必要平台so库\n\n```groovy\nndk {\n  //设置支持的so库架构\n  abiFilters \"armeabi-v7a\"\n}\n```\n\n基本上，对于手机来说，支持armeabi-v7a就足够了。\n\n#### 3.1.2 动态加载so库\n\n如果不是一启动应用就需要初始化的so库，完全可以在需要的时候再下载这个so文件，再通过以下代码进行加载。\n\n```java\nstatic {\n  System.loadLibrary(\"path/to/lib.so\");\n}\n```\n\n\n\n## 其他\n\n### 插件化\n\n将不需要在启动就加载的功能模块，通过插件化，在用户使用的时候再从服务器加载。\n\n### 删除class文件的debug items\n\n不建议使用，这种做法，事倍功半。\n\n","slug":"2022-09-19-Apk瘦身术","published":1,"updated":"2024-11-13T13:40:49.640Z","_id":"cm1ltr0g0000sbji0d9chbfwy","comments":1,"photos":[],"content":"<p>Apk瘦身主要从三方面入手：资源文件、源代码和第三方类库。</p>\n<h2 id=\"一、资源文件\"><a href=\"#一、资源文件\" class=\"headerlink\" title=\"一、资源文件\"></a>一、资源文件</h2><h3 id=\"1-1-删除无用资源文件\"><a href=\"#1-1-删除无用资源文件\" class=\"headerlink\" title=\"1.1 删除无用资源文件\"></a>1.1 删除无用资源文件</h3><h4 id=\"1-1-1-Lint工具\"><a href=\"#1-1-1-Lint工具\" class=\"headerlink\" title=\"1.1.1 Lint工具\"></a>1.1.1 Lint工具</h4><p>菜单 -&gt; Analyze -&gt; Run Inspection by Name，然后输入Unused resources便可以执行查找无用资源文件。自己根据需要进行删除。</p>\n<h4 id=\"1-1-2-shrinkResources\"><a href=\"#1-1-2-shrinkResources\" class=\"headerlink\" title=\"1.1.2 shrinkResources\"></a>1.1.2 shrinkResources</h4><pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">buildTypes <span class=\"token punctuation\">&#123;</span>\n  release <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 不显示Log</span>\n    buildConfigField <span class=\"token interpolation-string\"><span class=\"token string\">\"boolean\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"LOG_DEBUG\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"false\"</span></span>\n    <span class=\"token comment\">//混淆</span>\n    minifyEnabled <span class=\"token boolean\">true</span>\n    <span class=\"token comment\">// 移除无用的resource文件</span>\n    shrinkResources <span class=\"token boolean\">true</span>\n    proguardFiles <span class=\"token function\">getDefaultProguardFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'proguard-android.txt'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'proguard-rules.pro'</span>\n    signingConfig signingConfigs<span class=\"token punctuation\">.</span>release\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>使用shrinkResources的前提是，打开混淆minifyEnabled，建议只在release版本开启，不然会使得编译速度变慢。</p>\n<h3 id=\"1-2-图标类资源图片矢量化\"><a href=\"#1-2-图标类资源图片矢量化\" class=\"headerlink\" title=\"1.2 图标类资源图片矢量化\"></a>1.2 图标类资源图片矢量化</h3><p>对于图标类资源，可以选择用vector-drawable来代替，通过AndroidStudio自带的转换工具可以将svg文件转换为vector-drawable文件。</p>\n<blockquote>\n<p>具体操作为，在drawable相关文件夹上右键 -&gt; New -&gt; Vector Assert。</p>\n</blockquote>\n<p>你也可以进行批量转换：<a href=\"https://github.com/vdmeer/svg2vector\">工具地址</a></p>\n<h3 id=\"1-3-非图标类资源图片适当压缩与格式选择\"><a href=\"#1-3-非图标类资源图片适当压缩与格式选择\" class=\"headerlink\" title=\"1.3 非图标类资源图片适当压缩与格式选择\"></a>1.3 非图标类资源图片适当压缩与格式选择</h3><h4 id=\"1-3-1-使用tinypng有损压缩png图片\"><a href=\"#1-3-1-使用tinypng有损压缩png图片\" class=\"headerlink\" title=\"1.3.1 使用tinypng有损压缩png图片\"></a>1.3.1 使用tinypng有损压缩png图片</h4><p>通过<a href=\"http://tinypng.com/\">Tinypng</a>官网上传压缩再下载，在保持alpha通道的情况下对png图片的压缩可达到1&#x2F;3以内，且肉眼基本看不出差别。</p>\n<h4 id=\"1-3-2-使用jpg格式\"><a href=\"#1-3-2-使用jpg格式\" class=\"headerlink\" title=\"1.3.2 使用jpg格式\"></a>1.3.2 使用jpg格式</h4><p>对于非透明的大图，jpg会比png的大小和内存都更有优势，虽然不是绝对的，但是通常会减少到一半不止。</p>\n<h4 id=\"1-3-3-使用webp格式\"><a href=\"#1-3-3-使用webp格式\" class=\"headerlink\" title=\"1.3.3 使用webp格式\"></a>1.3.3 使用webp格式</h4><p>webp格式支持透明度，压缩比比jpg高，但是显示效果却不输于jpg。缺点是在Android端的原生支持不好，从Android4.0+开始原生支持，但是不支持透明度，从Android4.3+开始支持带有透明度的webp。如果不需要兼容到这个版本，可以直接使用。</p>\n<p>在Android studio中，在图片资源上右键可以转换为webp。详细参见<a href=\"https://developer.android.com/studio/write/convert-webp\">创建 WebP 图片</a>。</p>\n<h4 id=\"1-3-4-适当的压缩和尺寸\"><a href=\"#1-3-4-适当的压缩和尺寸\" class=\"headerlink\" title=\"1.3.4 适当的压缩和尺寸\"></a>1.3.4 适当的压缩和尺寸</h4><p>无论以上哪种格式图片，都可以通过选择合适的尺寸和适当的提高压缩率的方式，来进一步减少文件大小，进而减小apk文件的体积。</p>\n<h4 id=\"1-3-5-帧动画尽可能使用lottie\"><a href=\"#1-3-5-帧动画尽可能使用lottie\" class=\"headerlink\" title=\"1.3.5 帧动画尽可能使用lottie\"></a>1.3.5 帧动画尽可能使用lottie</h4><p><a href=\"https://github.com/airbnb/lottie-android\">Lottie</a>是Aribnb开源的动画库，通过json文件来进行展示动画，动画文件可以通过Adobe AE来制作。</p>\n<h3 id=\"1-4-有限国际化\"><a href=\"#1-4-有限国际化\" class=\"headerlink\" title=\"1.4 有限国际化\"></a>1.4 有限国际化</h3><pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">android <span class=\"token punctuation\">&#123;</span>\n  defaultConfig <span class=\"token punctuation\">&#123;</span>\n    resConfigs <span class=\"token interpolation-string\"><span class=\"token string\">\"zh\"</span></span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<h3 id=\"1-5-第三方库中大尺寸的无用资源同名替换\"><a href=\"#1-5-第三方库中大尺寸的无用资源同名替换\" class=\"headerlink\" title=\"1.5 第三方库中大尺寸的无用资源同名替换\"></a>1.5 第三方库中大尺寸的无用资源同名替换</h3><p>如果在第三方类库中，存在用不到的图片资源文件，可以通过1x1像素的同名图片进行替换。</p>\n<h3 id=\"1-6-使用AndResGuard\"><a href=\"#1-6-使用AndResGuard\" class=\"headerlink\" title=\"1.6 使用AndResGuard\"></a>1.6 使用AndResGuard</h3><p><a href=\"https://github.com/shwenzhang/AndResGuard\">AndResGuard</a>，在gradle文件中就可以直接使用，非常方便。</p>\n<h2 id=\"二、源代码\"><a href=\"#二、源代码\" class=\"headerlink\" title=\"二、源代码\"></a>二、源代码</h2><h3 id=\"2-1-开启混淆\"><a href=\"#2-1-开启混淆\" class=\"headerlink\" title=\"2.1 开启混淆\"></a>2.1 开启混淆</h3><p>这是基本操作了，无需多言。</p>\n<h3 id=\"2-2-手动修改开源代码\"><a href=\"#2-2-手动修改开源代码\" class=\"headerlink\" title=\"2.2 手动修改开源代码\"></a>2.2 手动修改开源代码</h3><p>将开源代码中我们不需要的类或者方法等删除掉，但是这需要对开源代码非常了解，而且确保版本兼容性，将来开源库升级或者随着我们产品需求变更对开源库的要求也改变了，都会影响对开源库的修改，不建议使用。</p>\n<h2 id=\"三、第三方类库\"><a href=\"#三、第三方类库\" class=\"headerlink\" title=\"三、第三方类库\"></a>三、第三方类库</h2><h3 id=\"3-1-动态库\"><a href=\"#3-1-动态库\" class=\"headerlink\" title=\"3.1 动态库\"></a>3.1 动态库</h3><h4 id=\"3-1-1-删除非必要平台so库\"><a href=\"#3-1-1-删除非必要平台so库\" class=\"headerlink\" title=\"3.1.1 删除非必要平台so库\"></a>3.1.1 删除非必要平台so库</h4><pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">ndk <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">//设置支持的so库架构</span>\n  abiFilters <span class=\"token interpolation-string\"><span class=\"token string\">\"armeabi-v7a\"</span></span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>基本上，对于手机来说，支持armeabi-v7a就足够了。</p>\n<h4 id=\"3-1-2-动态加载so库\"><a href=\"#3-1-2-动态加载so库\" class=\"headerlink\" title=\"3.1.2 动态加载so库\"></a>3.1.2 动态加载so库</h4><p>如果不是一启动应用就需要初始化的so库，完全可以在需要的时候再下载这个so文件，再通过以下代码进行加载。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"path/to/lib.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n\n\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><h3 id=\"插件化\"><a href=\"#插件化\" class=\"headerlink\" title=\"插件化\"></a>插件化</h3><p>将不需要在启动就加载的功能模块，通过插件化，在用户使用的时候再从服务器加载。</p>\n<h3 id=\"删除class文件的debug-items\"><a href=\"#删除class文件的debug-items\" class=\"headerlink\" title=\"删除class文件的debug items\"></a>删除class文件的debug items</h3><p>不建议使用，这种做法，事倍功半。</p>\n","excerpt":"","more":"<p>Apk瘦身主要从三方面入手：资源文件、源代码和第三方类库。</p>\n<h2 id=\"一、资源文件\"><a href=\"#一、资源文件\" class=\"headerlink\" title=\"一、资源文件\"></a>一、资源文件</h2><h3 id=\"1-1-删除无用资源文件\"><a href=\"#1-1-删除无用资源文件\" class=\"headerlink\" title=\"1.1 删除无用资源文件\"></a>1.1 删除无用资源文件</h3><h4 id=\"1-1-1-Lint工具\"><a href=\"#1-1-1-Lint工具\" class=\"headerlink\" title=\"1.1.1 Lint工具\"></a>1.1.1 Lint工具</h4><p>菜单 -&gt; Analyze -&gt; Run Inspection by Name，然后输入Unused resources便可以执行查找无用资源文件。自己根据需要进行删除。</p>\n<h4 id=\"1-1-2-shrinkResources\"><a href=\"#1-1-2-shrinkResources\" class=\"headerlink\" title=\"1.1.2 shrinkResources\"></a>1.1.2 shrinkResources</h4><pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">buildTypes <span class=\"token punctuation\">&#123;</span>\n  release <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 不显示Log</span>\n    buildConfigField <span class=\"token interpolation-string\"><span class=\"token string\">\"boolean\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"LOG_DEBUG\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"false\"</span></span>\n    <span class=\"token comment\">//混淆</span>\n    minifyEnabled <span class=\"token boolean\">true</span>\n    <span class=\"token comment\">// 移除无用的resource文件</span>\n    shrinkResources <span class=\"token boolean\">true</span>\n    proguardFiles <span class=\"token function\">getDefaultProguardFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'proguard-android.txt'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'proguard-rules.pro'</span>\n    signingConfig signingConfigs<span class=\"token punctuation\">.</span>release\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>使用shrinkResources的前提是，打开混淆minifyEnabled，建议只在release版本开启，不然会使得编译速度变慢。</p>\n<h3 id=\"1-2-图标类资源图片矢量化\"><a href=\"#1-2-图标类资源图片矢量化\" class=\"headerlink\" title=\"1.2 图标类资源图片矢量化\"></a>1.2 图标类资源图片矢量化</h3><p>对于图标类资源，可以选择用vector-drawable来代替，通过AndroidStudio自带的转换工具可以将svg文件转换为vector-drawable文件。</p>\n<blockquote>\n<p>具体操作为，在drawable相关文件夹上右键 -&gt; New -&gt; Vector Assert。</p>\n</blockquote>\n<p>你也可以进行批量转换：<a href=\"https://github.com/vdmeer/svg2vector\">工具地址</a></p>\n<h3 id=\"1-3-非图标类资源图片适当压缩与格式选择\"><a href=\"#1-3-非图标类资源图片适当压缩与格式选择\" class=\"headerlink\" title=\"1.3 非图标类资源图片适当压缩与格式选择\"></a>1.3 非图标类资源图片适当压缩与格式选择</h3><h4 id=\"1-3-1-使用tinypng有损压缩png图片\"><a href=\"#1-3-1-使用tinypng有损压缩png图片\" class=\"headerlink\" title=\"1.3.1 使用tinypng有损压缩png图片\"></a>1.3.1 使用tinypng有损压缩png图片</h4><p>通过<a href=\"http://tinypng.com/\">Tinypng</a>官网上传压缩再下载，在保持alpha通道的情况下对png图片的压缩可达到1&#x2F;3以内，且肉眼基本看不出差别。</p>\n<h4 id=\"1-3-2-使用jpg格式\"><a href=\"#1-3-2-使用jpg格式\" class=\"headerlink\" title=\"1.3.2 使用jpg格式\"></a>1.3.2 使用jpg格式</h4><p>对于非透明的大图，jpg会比png的大小和内存都更有优势，虽然不是绝对的，但是通常会减少到一半不止。</p>\n<h4 id=\"1-3-3-使用webp格式\"><a href=\"#1-3-3-使用webp格式\" class=\"headerlink\" title=\"1.3.3 使用webp格式\"></a>1.3.3 使用webp格式</h4><p>webp格式支持透明度，压缩比比jpg高，但是显示效果却不输于jpg。缺点是在Android端的原生支持不好，从Android4.0+开始原生支持，但是不支持透明度，从Android4.3+开始支持带有透明度的webp。如果不需要兼容到这个版本，可以直接使用。</p>\n<p>在Android studio中，在图片资源上右键可以转换为webp。详细参见<a href=\"https://developer.android.com/studio/write/convert-webp\">创建 WebP 图片</a>。</p>\n<h4 id=\"1-3-4-适当的压缩和尺寸\"><a href=\"#1-3-4-适当的压缩和尺寸\" class=\"headerlink\" title=\"1.3.4 适当的压缩和尺寸\"></a>1.3.4 适当的压缩和尺寸</h4><p>无论以上哪种格式图片，都可以通过选择合适的尺寸和适当的提高压缩率的方式，来进一步减少文件大小，进而减小apk文件的体积。</p>\n<h4 id=\"1-3-5-帧动画尽可能使用lottie\"><a href=\"#1-3-5-帧动画尽可能使用lottie\" class=\"headerlink\" title=\"1.3.5 帧动画尽可能使用lottie\"></a>1.3.5 帧动画尽可能使用lottie</h4><p><a href=\"https://github.com/airbnb/lottie-android\">Lottie</a>是Aribnb开源的动画库，通过json文件来进行展示动画，动画文件可以通过Adobe AE来制作。</p>\n<h3 id=\"1-4-有限国际化\"><a href=\"#1-4-有限国际化\" class=\"headerlink\" title=\"1.4 有限国际化\"></a>1.4 有限国际化</h3><pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">android <span class=\"token punctuation\">&#123;</span>\n  defaultConfig <span class=\"token punctuation\">&#123;</span>\n    resConfigs <span class=\"token interpolation-string\"><span class=\"token string\">\"zh\"</span></span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<h3 id=\"1-5-第三方库中大尺寸的无用资源同名替换\"><a href=\"#1-5-第三方库中大尺寸的无用资源同名替换\" class=\"headerlink\" title=\"1.5 第三方库中大尺寸的无用资源同名替换\"></a>1.5 第三方库中大尺寸的无用资源同名替换</h3><p>如果在第三方类库中，存在用不到的图片资源文件，可以通过1x1像素的同名图片进行替换。</p>\n<h3 id=\"1-6-使用AndResGuard\"><a href=\"#1-6-使用AndResGuard\" class=\"headerlink\" title=\"1.6 使用AndResGuard\"></a>1.6 使用AndResGuard</h3><p><a href=\"https://github.com/shwenzhang/AndResGuard\">AndResGuard</a>，在gradle文件中就可以直接使用，非常方便。</p>\n<h2 id=\"二、源代码\"><a href=\"#二、源代码\" class=\"headerlink\" title=\"二、源代码\"></a>二、源代码</h2><h3 id=\"2-1-开启混淆\"><a href=\"#2-1-开启混淆\" class=\"headerlink\" title=\"2.1 开启混淆\"></a>2.1 开启混淆</h3><p>这是基本操作了，无需多言。</p>\n<h3 id=\"2-2-手动修改开源代码\"><a href=\"#2-2-手动修改开源代码\" class=\"headerlink\" title=\"2.2 手动修改开源代码\"></a>2.2 手动修改开源代码</h3><p>将开源代码中我们不需要的类或者方法等删除掉，但是这需要对开源代码非常了解，而且确保版本兼容性，将来开源库升级或者随着我们产品需求变更对开源库的要求也改变了，都会影响对开源库的修改，不建议使用。</p>\n<h2 id=\"三、第三方类库\"><a href=\"#三、第三方类库\" class=\"headerlink\" title=\"三、第三方类库\"></a>三、第三方类库</h2><h3 id=\"3-1-动态库\"><a href=\"#3-1-动态库\" class=\"headerlink\" title=\"3.1 动态库\"></a>3.1 动态库</h3><h4 id=\"3-1-1-删除非必要平台so库\"><a href=\"#3-1-1-删除非必要平台so库\" class=\"headerlink\" title=\"3.1.1 删除非必要平台so库\"></a>3.1.1 删除非必要平台so库</h4><pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">ndk <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">//设置支持的so库架构</span>\n  abiFilters <span class=\"token interpolation-string\"><span class=\"token string\">\"armeabi-v7a\"</span></span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>基本上，对于手机来说，支持armeabi-v7a就足够了。</p>\n<h4 id=\"3-1-2-动态加载so库\"><a href=\"#3-1-2-动态加载so库\" class=\"headerlink\" title=\"3.1.2 动态加载so库\"></a>3.1.2 动态加载so库</h4><p>如果不是一启动应用就需要初始化的so库，完全可以在需要的时候再下载这个so文件，再通过以下代码进行加载。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"path/to/lib.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n\n\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><h3 id=\"插件化\"><a href=\"#插件化\" class=\"headerlink\" title=\"插件化\"></a>插件化</h3><p>将不需要在启动就加载的功能模块，通过插件化，在用户使用的时候再从服务器加载。</p>\n<h3 id=\"删除class文件的debug-items\"><a href=\"#删除class文件的debug-items\" class=\"headerlink\" title=\"删除class文件的debug items\"></a>删除class文件的debug items</h3><p>不建议使用，这种做法，事倍功半。</p>\n"},{"layout":"post","title":"Activity启动流程","author":"boybeak","date":"2022-09-18T16:00:00.000Z","_content":"\n\n原文参考：[Activity 启动流程分析(Android10)](https://zhuanlan.zhihu.com/p/150283395)\n\n```mermaid\ngraph TD;\nA(启动Activity) --> B[通过Binder调用AMS的startActivity方法] --> C[通过Intent获取到目标Activity] --> D{目标Activity是否启动} --> |是|E[通过Instrumentation创建Activity] --> F[回调Activity#attach] --> G[回调Activity#onCreate] --> H[准备显示Activity] --> I[Activity#onResume];\nD --> |否|J[通过Zygote进程fork一个App进程]:::zygote --> K[创建Application并回调Application#onCreate]:::zygote --> L[启动ActivityThread主线程消息队列]:::zygote --> E;\nF --> M[创建Window对象并设置Window.Callback接收事件]:::wms;\nG --> N[Activity#setContentView] --> O[Window#setContentView]:::wms;\nH --> P[Window#addView]:::wms;\nclassDef wms fill:#aaffff\nclassDef zygote fill:#ffaa99\n```\n\n途中浅蓝色部分为WMS关联部分，橙色部分为目标App未启动情况下的流程。\n\n## Intent 解析到 Activity\n\n调用 startActivity 之后，经过几步辗转最终会调用到 **AMS** 中，而 AMS 又会调用 ActivityStarter 来启动 Activity。\n解析 Intent 的任务将由`PackageManagerService#resolveIntent`方法来处理。\nIntent 匹配规则太负责了，我本意是想学习启动流程，所以就没深入进去看代码，就这样吧。","source":"_posts/2022-09-19-Activity启动流程.md","raw":"---\nlayout: post\ntitle: Activity启动流程\nauthor: boybeak\ncategory: Android技巧\ntags: Android\ndate: 2022-09-19 00:00:00\n---\n\n\n原文参考：[Activity 启动流程分析(Android10)](https://zhuanlan.zhihu.com/p/150283395)\n\n```mermaid\ngraph TD;\nA(启动Activity) --> B[通过Binder调用AMS的startActivity方法] --> C[通过Intent获取到目标Activity] --> D{目标Activity是否启动} --> |是|E[通过Instrumentation创建Activity] --> F[回调Activity#attach] --> G[回调Activity#onCreate] --> H[准备显示Activity] --> I[Activity#onResume];\nD --> |否|J[通过Zygote进程fork一个App进程]:::zygote --> K[创建Application并回调Application#onCreate]:::zygote --> L[启动ActivityThread主线程消息队列]:::zygote --> E;\nF --> M[创建Window对象并设置Window.Callback接收事件]:::wms;\nG --> N[Activity#setContentView] --> O[Window#setContentView]:::wms;\nH --> P[Window#addView]:::wms;\nclassDef wms fill:#aaffff\nclassDef zygote fill:#ffaa99\n```\n\n途中浅蓝色部分为WMS关联部分，橙色部分为目标App未启动情况下的流程。\n\n## Intent 解析到 Activity\n\n调用 startActivity 之后，经过几步辗转最终会调用到 **AMS** 中，而 AMS 又会调用 ActivityStarter 来启动 Activity。\n解析 Intent 的任务将由`PackageManagerService#resolveIntent`方法来处理。\nIntent 匹配规则太负责了，我本意是想学习启动流程，所以就没深入进去看代码，就这样吧。","slug":"2022-09-19-Activity启动流程","published":1,"updated":"2024-11-13T13:40:16.962Z","_id":"cm1ltr0g0000vbji0bawwhkcq","comments":1,"photos":[],"content":"<p>原文参考：<a href=\"https://zhuanlan.zhihu.com/p/150283395\">Activity 启动流程分析(Android10)</a></p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\nA<span class=\"token text string\">(启动Activity)</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">[通过Binder调用AMS的startActivity方法]</span> <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">[通过Intent获取到目标Activity]</span> <span class=\"token arrow operator\">--></span> D<span class=\"token text string\">&#123;目标Activity是否启动&#125;</span> <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|是|</span>E<span class=\"token text string\">[通过Instrumentation创建Activity]</span> <span class=\"token arrow operator\">--></span> F<span class=\"token text string\">[回调Activity#attach]</span> <span class=\"token arrow operator\">--></span> G<span class=\"token text string\">[回调Activity#onCreate]</span> <span class=\"token arrow operator\">--></span> H<span class=\"token text string\">[准备显示Activity]</span> <span class=\"token arrow operator\">--></span> I<span class=\"token text string\">[Activity#onResume]</span><span class=\"token punctuation\">;</span>\nD <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|否|</span>J<span class=\"token text string\">[通过Zygote进程fork一个App进程]</span><span class=\"token operator\">:::</span>zygote <span class=\"token arrow operator\">--></span> K<span class=\"token text string\">[创建Application并回调Application#onCreate]</span><span class=\"token operator\">:::</span>zygote <span class=\"token arrow operator\">--></span> L<span class=\"token text string\">[启动ActivityThread主线程消息队列]</span><span class=\"token operator\">:::</span>zygote <span class=\"token arrow operator\">--></span> E<span class=\"token punctuation\">;</span>\nF <span class=\"token arrow operator\">--></span> M<span class=\"token text string\">[创建Window对象并设置Window.Callback接收事件]</span><span class=\"token operator\">:::</span>wms<span class=\"token punctuation\">;</span>\nG <span class=\"token arrow operator\">--></span> N<span class=\"token text string\">[Activity#setContentView]</span> <span class=\"token arrow operator\">--></span> O<span class=\"token text string\">[Window#setContentView]</span><span class=\"token operator\">:::</span>wms<span class=\"token punctuation\">;</span>\nH <span class=\"token arrow operator\">--></span> P<span class=\"token text string\">[Window#addView]</span><span class=\"token operator\">:::</span>wms<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">classDef</span> wms <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#aaffff</span>\n<span class=\"token keyword\">classDef</span> zygote <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#ffaa99</span></code></pre>\n\n<p>途中浅蓝色部分为WMS关联部分，橙色部分为目标App未启动情况下的流程。</p>\n<h2 id=\"Intent-解析到-Activity\"><a href=\"#Intent-解析到-Activity\" class=\"headerlink\" title=\"Intent 解析到 Activity\"></a>Intent 解析到 Activity</h2><p>调用 startActivity 之后，经过几步辗转最终会调用到 <strong>AMS</strong> 中，而 AMS 又会调用 ActivityStarter 来启动 Activity。<br>解析 Intent 的任务将由<code>PackageManagerService#resolveIntent</code>方法来处理。<br>Intent 匹配规则太负责了，我本意是想学习启动流程，所以就没深入进去看代码，就这样吧。</p>\n","excerpt":"","more":"<p>原文参考：<a href=\"https://zhuanlan.zhihu.com/p/150283395\">Activity 启动流程分析(Android10)</a></p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\nA<span class=\"token text string\">(启动Activity)</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">[通过Binder调用AMS的startActivity方法]</span> <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">[通过Intent获取到目标Activity]</span> <span class=\"token arrow operator\">--></span> D<span class=\"token text string\">&#123;目标Activity是否启动&#125;</span> <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|是|</span>E<span class=\"token text string\">[通过Instrumentation创建Activity]</span> <span class=\"token arrow operator\">--></span> F<span class=\"token text string\">[回调Activity#attach]</span> <span class=\"token arrow operator\">--></span> G<span class=\"token text string\">[回调Activity#onCreate]</span> <span class=\"token arrow operator\">--></span> H<span class=\"token text string\">[准备显示Activity]</span> <span class=\"token arrow operator\">--></span> I<span class=\"token text string\">[Activity#onResume]</span><span class=\"token punctuation\">;</span>\nD <span class=\"token arrow operator\">--></span> <span class=\"token label property\">|否|</span>J<span class=\"token text string\">[通过Zygote进程fork一个App进程]</span><span class=\"token operator\">:::</span>zygote <span class=\"token arrow operator\">--></span> K<span class=\"token text string\">[创建Application并回调Application#onCreate]</span><span class=\"token operator\">:::</span>zygote <span class=\"token arrow operator\">--></span> L<span class=\"token text string\">[启动ActivityThread主线程消息队列]</span><span class=\"token operator\">:::</span>zygote <span class=\"token arrow operator\">--></span> E<span class=\"token punctuation\">;</span>\nF <span class=\"token arrow operator\">--></span> M<span class=\"token text string\">[创建Window对象并设置Window.Callback接收事件]</span><span class=\"token operator\">:::</span>wms<span class=\"token punctuation\">;</span>\nG <span class=\"token arrow operator\">--></span> N<span class=\"token text string\">[Activity#setContentView]</span> <span class=\"token arrow operator\">--></span> O<span class=\"token text string\">[Window#setContentView]</span><span class=\"token operator\">:::</span>wms<span class=\"token punctuation\">;</span>\nH <span class=\"token arrow operator\">--></span> P<span class=\"token text string\">[Window#addView]</span><span class=\"token operator\">:::</span>wms<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">classDef</span> wms <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#aaffff</span>\n<span class=\"token keyword\">classDef</span> zygote <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#ffaa99</span></code></pre>\n\n<p>途中浅蓝色部分为WMS关联部分，橙色部分为目标App未启动情况下的流程。</p>\n<h2 id=\"Intent-解析到-Activity\"><a href=\"#Intent-解析到-Activity\" class=\"headerlink\" title=\"Intent 解析到 Activity\"></a>Intent 解析到 Activity</h2><p>调用 startActivity 之后，经过几步辗转最终会调用到 <strong>AMS</strong> 中，而 AMS 又会调用 ActivityStarter 来启动 Activity。<br>解析 Intent 的任务将由<code>PackageManagerService#resolveIntent</code>方法来处理。<br>Intent 匹配规则太负责了，我本意是想学习启动流程，所以就没深入进去看代码，就这样吧。</p>\n"},{"layout":"post","title":"App保活术","author":"boybeak","date":"2022-09-18T19:00:00.000Z","_content":"\n\n**为什么要保活？**\n\n因为Android的Low memory killer机制，在系统内存不足的情况下，系统开始根据自身的一套进程回收机制结束一些进程，以便腾出内存给需要的进程。\n\n\n\n**如何判断内存不足？**\n\n判断的阈值在不同手机上是不一样的，一旦低于该阈值，系统就会杀死对应优先级的进程。\n\n在adb shell下，通过如下命令来查看阈值：\n\n```powershell\ncat /sys/module/lowmemorykiller/parameters/minfree\n```\n\n*注意: 这可能需要root手机。*\n\n返回的结果如下示例：\n\n```powershell\n18432, 23040, 27648, 32256, 55296, 80640\n```\n\n其单位为4kb，也就是内存1页大小。\n\n该值表示的是剩余内存大小，优先级为从高到低，比如当内存小于18432*4kb时，杀死对应的优先级的进程。\n\n![oom_adj](/images/process_priority.jpg)\n\n```mermaid\ngraph TD;\nstyle 关键优先级 fill:#5befb9\nstyle 高级优先级 fill:#6998c6\nstyle 低优先级 fill:#d38a49\nsubgraph 关键优先级\nA(前台进程)\nend\nA(前台进程) --> B(可见进程);\nsubgraph 高级优先级\nB --> C(服务进程);\nend\nC --> D(后台进程);\nsubgraph 低优先级\nD --> E(空进程);\nend\n```\n\n\n\n优先级从高到低依次是，`前台进程`、`可见进程`、`服务进程`、`后台进程`、`空进程`。\n\n\n\n**阈值有6个数，而进程有5种优先级，是如何对应呢？**\n\n实际上，第5个数是ContentProvider的阈值，其他的5个数与线程优先级对应。\n\n\n\n**如何判断线程的优先级？**\n\n```powershell\ncat /proc/<pid>/oom_adj\n```\n\n> 其中的<pid>应替换为对应的**进程ID**，从logcat中可以查看对应的pid。\n\n![oom_adj](/images/oom_adj.png)\n\n取值范围绿色代表比较安全，红色代表比较容易被杀死，白色代表为系统进程。\n\n\n\n## 1像素保活\n\n监听锁屏广播，当屏幕关闭，偷偷创建一个1像素的activity，当屏幕开启，关闭掉这个1像素activity。\n\n关键代码如下:\n\n`ScreenObserverService.java`\n\n```java\n//创建后台service，监听屏幕事件。\nIntentFilter filter = new IntentFilter(Intent.ACTION_SCREEN_ON);\nfilter.addAction(Intent.ACTION_SCREEN_OFF);\nregisterReceiver(theReceiver, filter);\n//别忘了在service结束时候，注销掉这个receiver。\n```\n\n`OnePixelActivity.java`\n\n```java\nWindow window = getWindow();\nwindow.setGravity(Gravity.START | Gravity.TOP);\nWindowManager.LayoutParams params = window.getAttributes();\nparams.width = 1;\nparams.height = 1;\nparams.x = 0;\nparams.y = 0;\nwindow.setAttributes(params);\n```\n\n别忘了在Manifest文件中，为这个activity设置一个透明主题。\n\n```xml\n<activity android:name=\".onepixel.OnePixelActivity\"\n            android:excludeFromRecents=\"true\"\n            android:taskAffinity=\"com.github.boybeak.livestock.onepixel\"\n            android:theme=\"@style/OnePixelTheme\"\n            />\n```\n\n> android:excludeFromRecents=\"true\" //不会出现在任务管理器中\n>\n> android:taskAffinity=\"xxxx\"\t\t\t\t//在新的任务栈中创建，不会将其他界面带到前台，配合启动OnePixelActivity时候的Intent.FLAG_ACTIVITY_NEW_TASK使用.\n\n> **注意**：经过实验，这个方案在真机上已经大概率失效了。\n>\n> 1. 收到锁屏广播会有1~3秒延迟；\n> 2. 当OnePixelActivity设置了`excludeFromRecents=\"true\"`后，在锁屏下是启动不起来的；\n> 3. 屏幕重新点亮的广播会有十几秒延迟。\n>\n> 我在一架5T上实验的，其他机型不保证。\n\n## 前台服务\n\n这一方案就是利用一个前台服务，配合Notification，来达到保活。弊端就是，当你的应用没有Notification需求的时候，对于一些敏感用户来说，这就容易引起方案。如下图。\n\n![forground_service](/images/forground_service.png)\n\n所以当你的应用是音乐类播放器，可以将这个通知作为音乐播放控制来使用，但是如果你的应用没有这样的需求，就会引起敏感用户注意，反而有可能被手动杀死甚至卸载。在Android8.0以前，可以通过如下方案消除这个无意义的敏感通知。\n\n```java\npublic class OuterService extends Service {\n  @Override\n  public void onCreate() {\n    startForground(1, new Notification());\n    startService(new Intent(this, InnerService.class));\n  }\n  \n  public static class InnerService extends Service {\n    @Override\n    public void onCreate() {\n      startForground(1, new Notification());\n      stopSelf();\n    }\n  }\n  \n}\n```\n\n这是利用系统漏洞来消除的这个通知，但是在Android8.0以后，同一个ID下，不允许重复创建前台服务，所以使用该方法需要判断版本。\n\n\n\n## 系统广播拉活\n\n**系统拉活**\n\n比如开机广播，电量变化，信号变化，网络变化等。但是在Android7.0后增加了限制，在Android8.0后限制更加严格。所以，这类保活方案已经不可靠了。\n\n> Oreo: https://developer.android.google.cn/about/versions/oreo/background.html#Broadcasts\n>\n> Pie: https://developer.android.google.cn/guide/components/broadcast-exceptions.html\n\n**用户拉活**\n\n大厂的多个APP之间可以互相之间拉活。 \n\n\n\n## Service系统机制拉活\n\n根据Service的onStartCommand方法的返回值，系统会执行不同的拉活方案。一般按照默认返回[START_STICKY](https://developer.android.com/reference/android/app/Service#START_STICKY)就可以。\n\n优点是使用成本低，缺点是不稳定。\n\n\n\n## 账户同步拉活\n\n优点：非常稳定。\n\n\n\n## JobScheduler拉活\n\n\n\n## 双进程守护\n\n\n\n## WorkManager\n\n\n\n## 厂商推送\n\n\n\n## 播放无声音乐\n\n\n\n## 白名单\n\n## Github\n\n[示例代码Livestock](https://github.com/boybeak/Livestock)\n\n## 参考文章\n\n[解读Android进程优先级ADJ算法](http://gityuan.com/2018/05/19/android-process-adj/)\n\n[创建自定义账号类型](https://developer.android.com/training/id-auth/custom_auth)\n\n","source":"_posts/2022-09-19-App保活术.md","raw":"---\nlayout: post\ntitle: App保活术\nauthor: boybeak\ncategory: Android技巧\ntags: Android\ndate: 2022-09-19 03:00:00\n---\n\n\n**为什么要保活？**\n\n因为Android的Low memory killer机制，在系统内存不足的情况下，系统开始根据自身的一套进程回收机制结束一些进程，以便腾出内存给需要的进程。\n\n\n\n**如何判断内存不足？**\n\n判断的阈值在不同手机上是不一样的，一旦低于该阈值，系统就会杀死对应优先级的进程。\n\n在adb shell下，通过如下命令来查看阈值：\n\n```powershell\ncat /sys/module/lowmemorykiller/parameters/minfree\n```\n\n*注意: 这可能需要root手机。*\n\n返回的结果如下示例：\n\n```powershell\n18432, 23040, 27648, 32256, 55296, 80640\n```\n\n其单位为4kb，也就是内存1页大小。\n\n该值表示的是剩余内存大小，优先级为从高到低，比如当内存小于18432*4kb时，杀死对应的优先级的进程。\n\n![oom_adj](/images/process_priority.jpg)\n\n```mermaid\ngraph TD;\nstyle 关键优先级 fill:#5befb9\nstyle 高级优先级 fill:#6998c6\nstyle 低优先级 fill:#d38a49\nsubgraph 关键优先级\nA(前台进程)\nend\nA(前台进程) --> B(可见进程);\nsubgraph 高级优先级\nB --> C(服务进程);\nend\nC --> D(后台进程);\nsubgraph 低优先级\nD --> E(空进程);\nend\n```\n\n\n\n优先级从高到低依次是，`前台进程`、`可见进程`、`服务进程`、`后台进程`、`空进程`。\n\n\n\n**阈值有6个数，而进程有5种优先级，是如何对应呢？**\n\n实际上，第5个数是ContentProvider的阈值，其他的5个数与线程优先级对应。\n\n\n\n**如何判断线程的优先级？**\n\n```powershell\ncat /proc/<pid>/oom_adj\n```\n\n> 其中的<pid>应替换为对应的**进程ID**，从logcat中可以查看对应的pid。\n\n![oom_adj](/images/oom_adj.png)\n\n取值范围绿色代表比较安全，红色代表比较容易被杀死，白色代表为系统进程。\n\n\n\n## 1像素保活\n\n监听锁屏广播，当屏幕关闭，偷偷创建一个1像素的activity，当屏幕开启，关闭掉这个1像素activity。\n\n关键代码如下:\n\n`ScreenObserverService.java`\n\n```java\n//创建后台service，监听屏幕事件。\nIntentFilter filter = new IntentFilter(Intent.ACTION_SCREEN_ON);\nfilter.addAction(Intent.ACTION_SCREEN_OFF);\nregisterReceiver(theReceiver, filter);\n//别忘了在service结束时候，注销掉这个receiver。\n```\n\n`OnePixelActivity.java`\n\n```java\nWindow window = getWindow();\nwindow.setGravity(Gravity.START | Gravity.TOP);\nWindowManager.LayoutParams params = window.getAttributes();\nparams.width = 1;\nparams.height = 1;\nparams.x = 0;\nparams.y = 0;\nwindow.setAttributes(params);\n```\n\n别忘了在Manifest文件中，为这个activity设置一个透明主题。\n\n```xml\n<activity android:name=\".onepixel.OnePixelActivity\"\n            android:excludeFromRecents=\"true\"\n            android:taskAffinity=\"com.github.boybeak.livestock.onepixel\"\n            android:theme=\"@style/OnePixelTheme\"\n            />\n```\n\n> android:excludeFromRecents=\"true\" //不会出现在任务管理器中\n>\n> android:taskAffinity=\"xxxx\"\t\t\t\t//在新的任务栈中创建，不会将其他界面带到前台，配合启动OnePixelActivity时候的Intent.FLAG_ACTIVITY_NEW_TASK使用.\n\n> **注意**：经过实验，这个方案在真机上已经大概率失效了。\n>\n> 1. 收到锁屏广播会有1~3秒延迟；\n> 2. 当OnePixelActivity设置了`excludeFromRecents=\"true\"`后，在锁屏下是启动不起来的；\n> 3. 屏幕重新点亮的广播会有十几秒延迟。\n>\n> 我在一架5T上实验的，其他机型不保证。\n\n## 前台服务\n\n这一方案就是利用一个前台服务，配合Notification，来达到保活。弊端就是，当你的应用没有Notification需求的时候，对于一些敏感用户来说，这就容易引起方案。如下图。\n\n![forground_service](/images/forground_service.png)\n\n所以当你的应用是音乐类播放器，可以将这个通知作为音乐播放控制来使用，但是如果你的应用没有这样的需求，就会引起敏感用户注意，反而有可能被手动杀死甚至卸载。在Android8.0以前，可以通过如下方案消除这个无意义的敏感通知。\n\n```java\npublic class OuterService extends Service {\n  @Override\n  public void onCreate() {\n    startForground(1, new Notification());\n    startService(new Intent(this, InnerService.class));\n  }\n  \n  public static class InnerService extends Service {\n    @Override\n    public void onCreate() {\n      startForground(1, new Notification());\n      stopSelf();\n    }\n  }\n  \n}\n```\n\n这是利用系统漏洞来消除的这个通知，但是在Android8.0以后，同一个ID下，不允许重复创建前台服务，所以使用该方法需要判断版本。\n\n\n\n## 系统广播拉活\n\n**系统拉活**\n\n比如开机广播，电量变化，信号变化，网络变化等。但是在Android7.0后增加了限制，在Android8.0后限制更加严格。所以，这类保活方案已经不可靠了。\n\n> Oreo: https://developer.android.google.cn/about/versions/oreo/background.html#Broadcasts\n>\n> Pie: https://developer.android.google.cn/guide/components/broadcast-exceptions.html\n\n**用户拉活**\n\n大厂的多个APP之间可以互相之间拉活。 \n\n\n\n## Service系统机制拉活\n\n根据Service的onStartCommand方法的返回值，系统会执行不同的拉活方案。一般按照默认返回[START_STICKY](https://developer.android.com/reference/android/app/Service#START_STICKY)就可以。\n\n优点是使用成本低，缺点是不稳定。\n\n\n\n## 账户同步拉活\n\n优点：非常稳定。\n\n\n\n## JobScheduler拉活\n\n\n\n## 双进程守护\n\n\n\n## WorkManager\n\n\n\n## 厂商推送\n\n\n\n## 播放无声音乐\n\n\n\n## 白名单\n\n## Github\n\n[示例代码Livestock](https://github.com/boybeak/Livestock)\n\n## 参考文章\n\n[解读Android进程优先级ADJ算法](http://gityuan.com/2018/05/19/android-process-adj/)\n\n[创建自定义账号类型](https://developer.android.com/training/id-auth/custom_auth)\n\n","slug":"2022-09-19-App保活术","published":1,"updated":"2024-11-13T13:40:56.523Z","_id":"cm1ltr0g0000ybji0eluh1e86","comments":1,"photos":["/images/process_priority.jpg","/images/oom_adj.png","/images/forground_service.png"],"content":"<p><strong>为什么要保活？</strong></p>\n<p>因为Android的Low memory killer机制，在系统内存不足的情况下，系统开始根据自身的一套进程回收机制结束一些进程，以便腾出内存给需要的进程。</p>\n<p><strong>如何判断内存不足？</strong></p>\n<p>判断的阈值在不同手机上是不一样的，一旦低于该阈值，系统就会杀死对应优先级的进程。</p>\n<p>在adb shell下，通过如下命令来查看阈值：</p>\n<pre class=\"language-powershell\" data-language=\"powershell\"><code class=\"language-powershell\"><span class=\"token function\">cat</span> <span class=\"token operator\">/</span>sys/module/lowmemorykiller/parameters/minfree</code></pre>\n\n<p><em>注意: 这可能需要root手机。</em></p>\n<p>返回的结果如下示例：</p>\n<pre class=\"language-powershell\" data-language=\"powershell\"><code class=\"language-powershell\">18432<span class=\"token punctuation\">,</span> 23040<span class=\"token punctuation\">,</span> 27648<span class=\"token punctuation\">,</span> 32256<span class=\"token punctuation\">,</span> 55296<span class=\"token punctuation\">,</span> 80640</code></pre>\n\n<p>其单位为4kb，也就是内存1页大小。</p>\n<p>该值表示的是剩余内存大小，优先级为从高到低，比如当内存小于18432*4kb时，杀死对应的优先级的进程。</p>\n<p><img src=\"/images/process_priority.jpg\" alt=\"oom_adj\"></p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">style</span> 关键优先级 fill<span class=\"token operator\">:</span>#5befb9\n<span class=\"token keyword\">style</span> 高级优先级 fill<span class=\"token operator\">:</span>#6998c6\n<span class=\"token keyword\">style</span> 低优先级 fill<span class=\"token operator\">:</span>#d38a49\n<span class=\"token keyword\">subgraph</span> 关键优先级\nA<span class=\"token text string\">(前台进程)</span>\n<span class=\"token keyword\">end</span>\nA<span class=\"token text string\">(前台进程)</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">(可见进程)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> 高级优先级\nB <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">(服务进程)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span>\nC <span class=\"token arrow operator\">--></span> D<span class=\"token text string\">(后台进程)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> 低优先级\nD <span class=\"token arrow operator\">--></span> E<span class=\"token text string\">(空进程)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span></code></pre>\n\n\n\n<p>优先级从高到低依次是，<code>前台进程</code>、<code>可见进程</code>、<code>服务进程</code>、<code>后台进程</code>、<code>空进程</code>。</p>\n<p><strong>阈值有6个数，而进程有5种优先级，是如何对应呢？</strong></p>\n<p>实际上，第5个数是ContentProvider的阈值，其他的5个数与线程优先级对应。</p>\n<p><strong>如何判断线程的优先级？</strong></p>\n<pre class=\"language-powershell\" data-language=\"powershell\"><code class=\"language-powershell\"><span class=\"token function\">cat</span> <span class=\"token operator\">/</span>proc/&lt;pid><span class=\"token operator\">/</span>oom_adj</code></pre>\n\n<blockquote>\n<p>其中的<pid>应替换为对应的<strong>进程ID</strong>，从logcat中可以查看对应的pid。</p>\n</blockquote>\n<p><img src=\"/images/oom_adj.png\" alt=\"oom_adj\"></p>\n<p>取值范围绿色代表比较安全，红色代表比较容易被杀死，白色代表为系统进程。</p>\n<h2 id=\"1像素保活\"><a href=\"#1像素保活\" class=\"headerlink\" title=\"1像素保活\"></a>1像素保活</h2><p>监听锁屏广播，当屏幕关闭，偷偷创建一个1像素的activity，当屏幕开启，关闭掉这个1像素activity。</p>\n<p>关键代码如下:</p>\n<p><code>ScreenObserverService.java</code></p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">//创建后台service，监听屏幕事件。</span>\n<span class=\"token class-name\">IntentFilter</span> filter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IntentFilter</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Intent</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTION_SCREEN_ON</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nfilter<span class=\"token punctuation\">.</span><span class=\"token function\">addAction</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Intent</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTION_SCREEN_OFF</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">registerReceiver</span><span class=\"token punctuation\">(</span>theReceiver<span class=\"token punctuation\">,</span> filter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//别忘了在service结束时候，注销掉这个receiver。</span></code></pre>\n\n<p><code>OnePixelActivity.java</code></p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token class-name\">Window</span> window <span class=\"token operator\">=</span> <span class=\"token function\">getWindow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nwindow<span class=\"token punctuation\">.</span><span class=\"token function\">setGravity</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Gravity</span><span class=\"token punctuation\">.</span><span class=\"token constant\">START</span> <span class=\"token operator\">|</span> <span class=\"token class-name\">Gravity</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TOP</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">WindowManager<span class=\"token punctuation\">.</span>LayoutParams</span> params <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span><span class=\"token function\">getAttributes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nparams<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\nparams<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\nparams<span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\nparams<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\nwindow<span class=\"token punctuation\">.</span><span class=\"token function\">setAttributes</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>别忘了在Manifest文件中，为这个activity设置一个透明主题。</p>\n<pre class=\"language-markup\" data-language=\"markup\"><code class=\"language-markup\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>activity</span> <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>.onepixel.OnePixelActivity<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>excludeFromRecents</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>taskAffinity</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>com.github.boybeak.livestock.onepixel<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>theme</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@style/OnePixelTheme<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token punctuation\">/></span></span></code></pre>\n\n<blockquote>\n<p>android:excludeFromRecents&#x3D;”true” &#x2F;&#x2F;不会出现在任务管理器中</p>\n<p>android:taskAffinity&#x3D;”xxxx”\t\t\t\t&#x2F;&#x2F;在新的任务栈中创建，不会将其他界面带到前台，配合启动OnePixelActivity时候的Intent.FLAG_ACTIVITY_NEW_TASK使用.</p>\n</blockquote>\n<blockquote>\n<p><strong>注意</strong>：经过实验，这个方案在真机上已经大概率失效了。</p>\n<ol>\n<li>收到锁屏广播会有1~3秒延迟；</li>\n<li>当OnePixelActivity设置了<code>excludeFromRecents=&quot;true&quot;</code>后，在锁屏下是启动不起来的；</li>\n<li>屏幕重新点亮的广播会有十几秒延迟。</li>\n</ol>\n<p>我在一架5T上实验的，其他机型不保证。</p>\n</blockquote>\n<h2 id=\"前台服务\"><a href=\"#前台服务\" class=\"headerlink\" title=\"前台服务\"></a>前台服务</h2><p>这一方案就是利用一个前台服务，配合Notification，来达到保活。弊端就是，当你的应用没有Notification需求的时候，对于一些敏感用户来说，这就容易引起方案。如下图。</p>\n<p><img src=\"/images/forground_service.png\" alt=\"forground_service\"></p>\n<p>所以当你的应用是音乐类播放器，可以将这个通知作为音乐播放控制来使用，但是如果你的应用没有这样的需求，就会引起敏感用户注意，反而有可能被手动杀死甚至卸载。在Android8.0以前，可以通过如下方案消除这个无意义的敏感通知。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OuterService</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Service</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token function\">startForground</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Notification</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">startService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Intent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InnerService</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  \n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">InnerService</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Service</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">startForground</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Notification</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">stopSelf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  \n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这是利用系统漏洞来消除的这个通知，但是在Android8.0以后，同一个ID下，不允许重复创建前台服务，所以使用该方法需要判断版本。</p>\n<h2 id=\"系统广播拉活\"><a href=\"#系统广播拉活\" class=\"headerlink\" title=\"系统广播拉活\"></a>系统广播拉活</h2><p><strong>系统拉活</strong></p>\n<p>比如开机广播，电量变化，信号变化，网络变化等。但是在Android7.0后增加了限制，在Android8.0后限制更加严格。所以，这类保活方案已经不可靠了。</p>\n<blockquote>\n<p>Oreo: <a href=\"https://developer.android.google.cn/about/versions/oreo/background.html#Broadcasts\">https://developer.android.google.cn/about/versions/oreo/background.html#Broadcasts</a></p>\n<p>Pie: <a href=\"https://developer.android.google.cn/guide/components/broadcast-exceptions.html\">https://developer.android.google.cn/guide/components/broadcast-exceptions.html</a></p>\n</blockquote>\n<p><strong>用户拉活</strong></p>\n<p>大厂的多个APP之间可以互相之间拉活。 </p>\n<h2 id=\"Service系统机制拉活\"><a href=\"#Service系统机制拉活\" class=\"headerlink\" title=\"Service系统机制拉活\"></a>Service系统机制拉活</h2><p>根据Service的onStartCommand方法的返回值，系统会执行不同的拉活方案。一般按照默认返回<a href=\"https://developer.android.com/reference/android/app/Service#START_STICKY\">START_STICKY</a>就可以。</p>\n<p>优点是使用成本低，缺点是不稳定。</p>\n<h2 id=\"账户同步拉活\"><a href=\"#账户同步拉活\" class=\"headerlink\" title=\"账户同步拉活\"></a>账户同步拉活</h2><p>优点：非常稳定。</p>\n<h2 id=\"JobScheduler拉活\"><a href=\"#JobScheduler拉活\" class=\"headerlink\" title=\"JobScheduler拉活\"></a>JobScheduler拉活</h2><h2 id=\"双进程守护\"><a href=\"#双进程守护\" class=\"headerlink\" title=\"双进程守护\"></a>双进程守护</h2><h2 id=\"WorkManager\"><a href=\"#WorkManager\" class=\"headerlink\" title=\"WorkManager\"></a>WorkManager</h2><h2 id=\"厂商推送\"><a href=\"#厂商推送\" class=\"headerlink\" title=\"厂商推送\"></a>厂商推送</h2><h2 id=\"播放无声音乐\"><a href=\"#播放无声音乐\" class=\"headerlink\" title=\"播放无声音乐\"></a>播放无声音乐</h2><h2 id=\"白名单\"><a href=\"#白名单\" class=\"headerlink\" title=\"白名单\"></a>白名单</h2><h2 id=\"Github\"><a href=\"#Github\" class=\"headerlink\" title=\"Github\"></a>Github</h2><p><a href=\"https://github.com/boybeak/Livestock\">示例代码Livestock</a></p>\n<h2 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h2><p><a href=\"http://gityuan.com/2018/05/19/android-process-adj/\">解读Android进程优先级ADJ算法</a></p>\n<p><a href=\"https://developer.android.com/training/id-auth/custom_auth\">创建自定义账号类型</a></p>\n","excerpt":"","more":"<p><strong>为什么要保活？</strong></p>\n<p>因为Android的Low memory killer机制，在系统内存不足的情况下，系统开始根据自身的一套进程回收机制结束一些进程，以便腾出内存给需要的进程。</p>\n<p><strong>如何判断内存不足？</strong></p>\n<p>判断的阈值在不同手机上是不一样的，一旦低于该阈值，系统就会杀死对应优先级的进程。</p>\n<p>在adb shell下，通过如下命令来查看阈值：</p>\n<pre class=\"language-powershell\" data-language=\"powershell\"><code class=\"language-powershell\"><span class=\"token function\">cat</span> <span class=\"token operator\">/</span>sys/module/lowmemorykiller/parameters/minfree</code></pre>\n\n<p><em>注意: 这可能需要root手机。</em></p>\n<p>返回的结果如下示例：</p>\n<pre class=\"language-powershell\" data-language=\"powershell\"><code class=\"language-powershell\">18432<span class=\"token punctuation\">,</span> 23040<span class=\"token punctuation\">,</span> 27648<span class=\"token punctuation\">,</span> 32256<span class=\"token punctuation\">,</span> 55296<span class=\"token punctuation\">,</span> 80640</code></pre>\n\n<p>其单位为4kb，也就是内存1页大小。</p>\n<p>该值表示的是剩余内存大小，优先级为从高到低，比如当内存小于18432*4kb时，杀死对应的优先级的进程。</p>\n<p><img src=\"/images/process_priority.jpg\" alt=\"oom_adj\"></p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> TD<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">style</span> 关键优先级 fill<span class=\"token operator\">:</span>#5befb9\n<span class=\"token keyword\">style</span> 高级优先级 fill<span class=\"token operator\">:</span>#6998c6\n<span class=\"token keyword\">style</span> 低优先级 fill<span class=\"token operator\">:</span>#d38a49\n<span class=\"token keyword\">subgraph</span> 关键优先级\nA<span class=\"token text string\">(前台进程)</span>\n<span class=\"token keyword\">end</span>\nA<span class=\"token text string\">(前台进程)</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">(可见进程)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> 高级优先级\nB <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">(服务进程)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span>\nC <span class=\"token arrow operator\">--></span> D<span class=\"token text string\">(后台进程)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> 低优先级\nD <span class=\"token arrow operator\">--></span> E<span class=\"token text string\">(空进程)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span></code></pre>\n\n\n\n<p>优先级从高到低依次是，<code>前台进程</code>、<code>可见进程</code>、<code>服务进程</code>、<code>后台进程</code>、<code>空进程</code>。</p>\n<p><strong>阈值有6个数，而进程有5种优先级，是如何对应呢？</strong></p>\n<p>实际上，第5个数是ContentProvider的阈值，其他的5个数与线程优先级对应。</p>\n<p><strong>如何判断线程的优先级？</strong></p>\n<pre class=\"language-powershell\" data-language=\"powershell\"><code class=\"language-powershell\"><span class=\"token function\">cat</span> <span class=\"token operator\">/</span>proc/&lt;pid><span class=\"token operator\">/</span>oom_adj</code></pre>\n\n<blockquote>\n<p>其中的<pid>应替换为对应的<strong>进程ID</strong>，从logcat中可以查看对应的pid。</p>\n</blockquote>\n<p><img src=\"/images/oom_adj.png\" alt=\"oom_adj\"></p>\n<p>取值范围绿色代表比较安全，红色代表比较容易被杀死，白色代表为系统进程。</p>\n<h2 id=\"1像素保活\"><a href=\"#1像素保活\" class=\"headerlink\" title=\"1像素保活\"></a>1像素保活</h2><p>监听锁屏广播，当屏幕关闭，偷偷创建一个1像素的activity，当屏幕开启，关闭掉这个1像素activity。</p>\n<p>关键代码如下:</p>\n<p><code>ScreenObserverService.java</code></p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">//创建后台service，监听屏幕事件。</span>\n<span class=\"token class-name\">IntentFilter</span> filter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IntentFilter</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Intent</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTION_SCREEN_ON</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nfilter<span class=\"token punctuation\">.</span><span class=\"token function\">addAction</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Intent</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTION_SCREEN_OFF</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">registerReceiver</span><span class=\"token punctuation\">(</span>theReceiver<span class=\"token punctuation\">,</span> filter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//别忘了在service结束时候，注销掉这个receiver。</span></code></pre>\n\n<p><code>OnePixelActivity.java</code></p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token class-name\">Window</span> window <span class=\"token operator\">=</span> <span class=\"token function\">getWindow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nwindow<span class=\"token punctuation\">.</span><span class=\"token function\">setGravity</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Gravity</span><span class=\"token punctuation\">.</span><span class=\"token constant\">START</span> <span class=\"token operator\">|</span> <span class=\"token class-name\">Gravity</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TOP</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">WindowManager<span class=\"token punctuation\">.</span>LayoutParams</span> params <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span><span class=\"token function\">getAttributes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nparams<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\nparams<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\nparams<span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\nparams<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\nwindow<span class=\"token punctuation\">.</span><span class=\"token function\">setAttributes</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>别忘了在Manifest文件中，为这个activity设置一个透明主题。</p>\n<pre class=\"language-markup\" data-language=\"markup\"><code class=\"language-markup\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>activity</span> <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>.onepixel.OnePixelActivity<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>excludeFromRecents</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>taskAffinity</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>com.github.boybeak.livestock.onepixel<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>theme</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@style/OnePixelTheme<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token punctuation\">/></span></span></code></pre>\n\n<blockquote>\n<p>android:excludeFromRecents&#x3D;”true” &#x2F;&#x2F;不会出现在任务管理器中</p>\n<p>android:taskAffinity&#x3D;”xxxx”\t\t\t\t&#x2F;&#x2F;在新的任务栈中创建，不会将其他界面带到前台，配合启动OnePixelActivity时候的Intent.FLAG_ACTIVITY_NEW_TASK使用.</p>\n</blockquote>\n<blockquote>\n<p><strong>注意</strong>：经过实验，这个方案在真机上已经大概率失效了。</p>\n<ol>\n<li>收到锁屏广播会有1~3秒延迟；</li>\n<li>当OnePixelActivity设置了<code>excludeFromRecents=&quot;true&quot;</code>后，在锁屏下是启动不起来的；</li>\n<li>屏幕重新点亮的广播会有十几秒延迟。</li>\n</ol>\n<p>我在一架5T上实验的，其他机型不保证。</p>\n</blockquote>\n<h2 id=\"前台服务\"><a href=\"#前台服务\" class=\"headerlink\" title=\"前台服务\"></a>前台服务</h2><p>这一方案就是利用一个前台服务，配合Notification，来达到保活。弊端就是，当你的应用没有Notification需求的时候，对于一些敏感用户来说，这就容易引起方案。如下图。</p>\n<p><img src=\"/images/forground_service.png\" alt=\"forground_service\"></p>\n<p>所以当你的应用是音乐类播放器，可以将这个通知作为音乐播放控制来使用，但是如果你的应用没有这样的需求，就会引起敏感用户注意，反而有可能被手动杀死甚至卸载。在Android8.0以前，可以通过如下方案消除这个无意义的敏感通知。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OuterService</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Service</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token function\">startForground</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Notification</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">startService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Intent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InnerService</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  \n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">InnerService</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Service</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">startForground</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Notification</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">stopSelf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  \n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这是利用系统漏洞来消除的这个通知，但是在Android8.0以后，同一个ID下，不允许重复创建前台服务，所以使用该方法需要判断版本。</p>\n<h2 id=\"系统广播拉活\"><a href=\"#系统广播拉活\" class=\"headerlink\" title=\"系统广播拉活\"></a>系统广播拉活</h2><p><strong>系统拉活</strong></p>\n<p>比如开机广播，电量变化，信号变化，网络变化等。但是在Android7.0后增加了限制，在Android8.0后限制更加严格。所以，这类保活方案已经不可靠了。</p>\n<blockquote>\n<p>Oreo: <a href=\"https://developer.android.google.cn/about/versions/oreo/background.html#Broadcasts\">https://developer.android.google.cn/about/versions/oreo/background.html#Broadcasts</a></p>\n<p>Pie: <a href=\"https://developer.android.google.cn/guide/components/broadcast-exceptions.html\">https://developer.android.google.cn/guide/components/broadcast-exceptions.html</a></p>\n</blockquote>\n<p><strong>用户拉活</strong></p>\n<p>大厂的多个APP之间可以互相之间拉活。 </p>\n<h2 id=\"Service系统机制拉活\"><a href=\"#Service系统机制拉活\" class=\"headerlink\" title=\"Service系统机制拉活\"></a>Service系统机制拉活</h2><p>根据Service的onStartCommand方法的返回值，系统会执行不同的拉活方案。一般按照默认返回<a href=\"https://developer.android.com/reference/android/app/Service#START_STICKY\">START_STICKY</a>就可以。</p>\n<p>优点是使用成本低，缺点是不稳定。</p>\n<h2 id=\"账户同步拉活\"><a href=\"#账户同步拉活\" class=\"headerlink\" title=\"账户同步拉活\"></a>账户同步拉活</h2><p>优点：非常稳定。</p>\n<h2 id=\"JobScheduler拉活\"><a href=\"#JobScheduler拉活\" class=\"headerlink\" title=\"JobScheduler拉活\"></a>JobScheduler拉活</h2><h2 id=\"双进程守护\"><a href=\"#双进程守护\" class=\"headerlink\" title=\"双进程守护\"></a>双进程守护</h2><h2 id=\"WorkManager\"><a href=\"#WorkManager\" class=\"headerlink\" title=\"WorkManager\"></a>WorkManager</h2><h2 id=\"厂商推送\"><a href=\"#厂商推送\" class=\"headerlink\" title=\"厂商推送\"></a>厂商推送</h2><h2 id=\"播放无声音乐\"><a href=\"#播放无声音乐\" class=\"headerlink\" title=\"播放无声音乐\"></a>播放无声音乐</h2><h2 id=\"白名单\"><a href=\"#白名单\" class=\"headerlink\" title=\"白名单\"></a>白名单</h2><h2 id=\"Github\"><a href=\"#Github\" class=\"headerlink\" title=\"Github\"></a>Github</h2><p><a href=\"https://github.com/boybeak/Livestock\">示例代码Livestock</a></p>\n<h2 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h2><p><a href=\"http://gityuan.com/2018/05/19/android-process-adj/\">解读Android进程优先级ADJ算法</a></p>\n<p><a href=\"https://developer.android.com/training/id-auth/custom_auth\">创建自定义账号类型</a></p>\n"},{"layout":"post","title":"Jetpack之LiveData源码分析","author":"boybeak","date":"2022-09-16T21:00:00.000Z","_content":"\n\n在阅读这篇文章前，需要先对[Lifecycle](https://boybeak.github.io/2021/03/12/2022-09-17-Jetpack%E4%B9%8BLifecycle%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/)有所了解。\n\nLifecycle是LiveData的根基，先有了生命周期的管理，才能进行安全不泄漏的数据观察。\n\n先要引入LiveData：\n\n```groovy\nimplementation \"androidx.lifecycle:lifecycle-viewmodel-ktx:2.2.0\"\n\ndef activity_version = \"1.1.0\"\n// Kotlin，引入这个扩展，可以使用by viewModels()方法\nimplementation \"androidx.activity:activity-ktx:$activity_version\"\n```\n\n典型的用法如下：\n\n```kotlin\nclass MainActivity : AppCompatActivity() {\n\n    private val vm by viewModels<MainVM>()\n\n    override fun onCreate(savedInstanceState: Bundle?) {\n        super.onCreate(savedInstanceState)\n        setContentView(R.layout.activity_main)\n\n        vm.data.observe(this) {\n            Toast.makeText(this@MainActivity, it, Toast.LENGTH_SHORT).show()\n        }\n\n        vm.start()\n\n    }\n}\n```\n\n```kotlin\nclass MainVM : ViewModel() {\n\n    val data = MutableLiveData<String>()\n\n    fun start() {\n        data.value = \"start\"\n        Thread {\n            Thread.sleep(2000)\n            data.postValue(\"run after 2000ms\")\n        }.start()\n    }\n\n}\n```\n\n从这两段代码中，我们就可以看出典型的用法，主要是在三个方法上，*observe*、*setValue*和*postValue*。我们就从这三个方法入手去探究LiveData的工作机制。\n\n## observe方法\n\n```java\n// LiveData.java\n\n@MainThread\npublic void observe(@NonNull LifecycleOwner owner, @NonNull Observer<? super T> observer) {\n  assertMainThread(\"observe\");\n  if (owner.getLifecycle().getCurrentState() == DESTROYED) {\n    // ignore\n    return;\n  }\n  LifecycleBoundObserver wrapper = new LifecycleBoundObserver(owner, observer);\n  ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper);\n  if (existing != null && !existing.isAttachedTo(owner)) {\n    throw new IllegalArgumentException(\"Cannot add the same observer\"\n                                       + \" with different lifecycles\");\n  }\n  if (existing != null) {\n    return;\n  }\n  owner.getLifecycle().addObserver(wrapper);\n}\n```\n\n1. 只允许在主线程中监听数据变化，并且如果*LifecycleOwner*已经处于**DESTROYED**状态，则忽略这次监听请求。\n2. 以*LifecycleOwner*和*Observer*创建一个*LifecycleBoundObserver*对象，这个对象继承了*ObserverWrapper*类，同时实现了*LifecycleEventObserver*接口，看到这个接口，我们便明白了*LiveData*能够生命周期安全的监听数据变化的原因了。\n3. 这个*LifecycleBoundObserver*对象需要存储在一个*SafeIterableMap*当中去，在存储时候，会通过observer判断是否已经存在一个*ObserverWrapper*对象existing，如果已经存在则分为两种：a. 如果existing没有attach在owner上，则说明，existing已经attach在另外一个*LifecycleOwner*上了，这是不允许的，此时需要抛出异常；b. 如果没有attach在另外一个*LifecycleOwner*上，则说明此时监听的就是当前的owner上，则不需要再次添加监听，直接返回。如果existing不存在，则向owner.getLifecycle()添加监听。\n\n\n\n## setValue和postValue方法\n\n在子线程中更新数据，需要调用postValue方法，实际上，这个方法就是通过一个MainHandler去post一个*Runnable*的方式切换到主线程中执行setValue方法。所以，我们重点看setValue方法即可。\n\n```java\n// LiveData.java\n\n@MainThread\nprotected void setValue(T value) {\n  assertMainThread(\"setValue\");\n  mVersion++;\n  mData = value;\n  dispatchingValue(null);\n}\n```\n\n这里需要注意到的是`mVersion++`这句话，*LiveData*就是通过版本号来记录新的值的。继续看dispatchingValue方法。\n\n\n\n### dispatchingValue\n\n```java\n@SuppressWarnings(\"WeakerAccess\") /* synthetic access */\nvoid dispatchingValue(@Nullable ObserverWrapper initiator) {\n  if (mDispatchingValue) {\t\t\t\t// ①\n    mDispatchInvalidated = true;\n    return;\n  }\n  mDispatchingValue = true;\n  do {\n    mDispatchInvalidated = false;\t// ②\n    if (initiator != null) {\n      considerNotify(initiator);\n      initiator = null;\n    } else {\n      for (Iterator<Map.Entry<Observer<? super T>, ObserverWrapper>> iterator =\n           mObservers.iteratorWithAdditions(); iterator.hasNext(); ) {\n        considerNotify(iterator.next().getValue());\n        if (mDispatchInvalidated) { // ③\n          break;\n        }\n      }\n    }\n  } while (mDispatchInvalidated);\n  mDispatchingValue = false;\n}\n```\n\n在这里，涉及到两个方法，1. 第一个dispatchingValue —— 用来分发控制数据更新流程；2. considerNotify具体执行数据更新操作。\n\n这个方法是双信号量控制分发流程，**mDispatchingValue**和**mDispatchInvalidated**，之所以这样设计，按照我的理解，是考虑到了dispatchingValue方法多线程重入的问题，但是依我看来，这样做没必要，因为这个方法的几处调用，都是在主线程上，不可能出现第一次调用没有执行完，就又被调用一次的可能，也可能是设计者考虑到未来的扩展或者在这个库涉及之初有多线程调用的情况才这样写的，先按照有重入可能来分析。\n\n我们先要弄清这两个信号量的作用：mDispatchingValue表示是否正在执行分发数据更新的操作，mDispatchInvalidated表示是否中断正在进行的分发，开始新一轮分发。\n\n这个方法是根据传入的参数，有两个执行流程，一个是执行具体某个ObserverWrapper的数据更新操作，另外一个就是批量更新所有observer的数据操作。我们以setValue触发的dispatchingValue(null)批量更新操作为例进行分析。\n\n注意我在上段代码中的序号①②③注释，我们分步骤进行分析：\n\n> 假设，此时我们有两个observer。\n>\n> 初始状态 **mDispatchingValue = false, mDispatchInvalidated = false**\n>\n> 当**第一次**调用开始后，会顺利通过①处判断，然后进入do - while循环，并且在②处先将mDispatchInvalidated信号量置为false，所以，一般情况下，这个while循环只会执行一次；\n>\n> \n>\n> 信号量：**mDispatchingValue = true, mDispatchInvalidated = false**\n>\n> 由于initiator参数为null，所以会进入到else分支中的for循环中，这里需要注意的是，每一次for循环结束时候，都判断一次mDispatchInvalidated信号量，也就是注释③处；\n>\n> 假设我们执行了第一个observer后，dispatchingValue方法进行了**第二次**调用，由于此时mDispatchingValue信号量为true，所以会进入①处if条件判断语句，将mDispatchInvalidated信号量置为true并且直接return了；\n>\n> \n>\n> 信号量：**mDispatchingValue = true, mDispatchInvalidated = true**\n>\n> 此时，第一次调用的for循环体就会因为mDispatchInvalidated变成了true，而退出for循环，while循环开始判断条件，同样因为mDispatchInvalidated为true，回再次执行while循环，执行新值更新；\n>\n> 最后退出dispatchingValue方法后，两个信号量都置为false。\n\n这样做的目的，或许是为了及时抛弃旧值通知，开始新值通知。\n\n\n\n### considerNotify\n\n```java\n\n\n@SuppressWarnings(\"unchecked\")\nprivate void considerNotify(ObserverWrapper observer) {\n  if (!observer.mActive) {\n    return;\n  }\n  // Check latest state b4 dispatch. Maybe it changed state but we didn't get the event yet.\n  //\n  // we still first check observer.active to keep it as the entrance for events. So even if\n  // the observer moved to an active state, if we've not received that event, we better not\n  // notify for a more predictable notification order.\n  if (!observer.shouldBeActive()) {\n    observer.activeStateChanged(false);\n    return;\n  }\n  if (observer.mLastVersion >= mVersion) {\n    return;\n  }\n  observer.mLastVersion = mVersion;\n  observer.mObserver.onChanged((T) mData);\n}\n```\n\n这个方法是具体执行通知观察者值变化的地方。\n\n那么LiveData是如何判断新值和旧值的呢？\n\n在setValue方法中，有一个`mVersion++`语句，每次设置新值都会触发这个mVersion的自增，然后在considerNotify方法中，去校验observer是否处于active状态以及新值版本号与observer中的版本号，如果observer**应当**处于非active状态而仍然处于active状态(**因为状态可能由于handler机制并没有及时变更**)，则进行状态变更并返回，并且如果`observer.mLastVersion >= mVersion`，则直接返回，因为此时observer已经更新过此值。**也就是说，只有observer处于active状态且当前mVersion > observer.mVersion的时候，才去通知observer更新值**。\n\n接下来，着重看一下*LifecycleBoundObserver*和*ObserverWrapper*这个两个类。\n\n\n\n## LifecycleBoundObserver和ObserverWrapper\n\n*ObserverWrapper*是*Observer*的抽象包装类，代码很简单：\n\n```java\nprivate abstract class ObserverWrapper {\n  final Observer<? super T> mObserver;\n  boolean mActive;\n  int mLastVersion = START_VERSION;\n\n  ObserverWrapper(Observer<? super T> observer) {\n    mObserver = observer;\n  }\n\n  abstract boolean shouldBeActive();\n\n  boolean isAttachedTo(LifecycleOwner owner) {\n    return false;\n  }\n\n  void detachObserver() {\n  }\n\n  void activeStateChanged(boolean newActive) {\n    if (newActive == mActive) {\n      return;\n    }\n    // immediately set active state, so we'd never dispatch anything to inactive\n    // owner\n    mActive = newActive;\n    boolean wasInactive = LiveData.this.mActiveCount == 0;\n    LiveData.this.mActiveCount += mActive ? 1 : -1;\n    if (wasInactive && mActive) {\n      onActive();\n    }\n    if (LiveData.this.mActiveCount == 0 && !mActive) {\n      onInactive();\n    }\n    if (mActive) {\n      dispatchingValue(this);\n    }\n  }\n}\n```\n\n在activeStateChanged方法中，先判断是否是状态的改变，如果`newActive == mActive`说明激活状态未改变，则直接返回；然后判断按照激活的observer数目和mActive状态，来判断LiveData的状态，并调用其空回调函数；最后如果mActive为true，则进行针对这个*ObserverWrapper*的事件分发。\n\n*ObserverWrapper*有两个子类，*LifecycleBoundObserver*和*AlwaysActiveObserver*，*AlwaysActiveObserver*是与生命周期无关的observer，需要谨慎使用，在适当的时候，通过removeObserver来删除，我们重点看*LifecycleBoundObserver*。\n\n*LifecycleBoundObserver*同时实现了*LifecycleEventObserver*，这就使得这个类具备了生命周期关联性。\n\n```java\nclass LifecycleBoundObserver extends ObserverWrapper implements LifecycleEventObserver {\n  @NonNull\n  final LifecycleOwner mOwner;\n\n  LifecycleBoundObserver(@NonNull LifecycleOwner owner, Observer<? super T> observer) {\n    super(observer);\n    mOwner = owner;\n  }\n\n  @Override\n  boolean shouldBeActive() {\n    return mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED);\n  }\n\n  @Override\n  public void onStateChanged(@NonNull LifecycleOwner source,\n                             @NonNull Lifecycle.Event event) {\n    if (mOwner.getLifecycle().getCurrentState() == DESTROYED) {\n      removeObserver(mObserver);\n      return;\n    }\n    activeStateChanged(shouldBeActive());\n  }\n\n  @Override\n  boolean isAttachedTo(LifecycleOwner owner) {\n    return mOwner == owner;\n  }\n\n  @Override\n  void detachObserver() {\n    mOwner.getLifecycle().removeObserver(this);\n  }\n}\n```\n\n在onStateChanged方法中，当生命周期处于**DESTROYED**状态时候，则删除这个observer。除此以外，当mOwner的生命周期处于**STARTED**之后的状态，则认为`shouldBeActive`，当生命周期函数onStateChanged被触发时候，将设置是否active。\n\n\n\n## 总结\n\n通过LiveData的这些特性，我们可以实现Activity - Fragment, Fragment - Fragment的通信，另外也可以做应用的事件总线，比如**LiveEventBus**。","source":"_posts/2022-09-17-Jetpack之LiveData源码分析.md","raw":"---\nlayout: post\ntitle: Jetpack之LiveData源码分析\nauthor: boybeak\ncategory: 源码分析\ntags: Android\ndate: 2022-09-17 05:00:00\n---\n\n\n在阅读这篇文章前，需要先对[Lifecycle](https://boybeak.github.io/2021/03/12/2022-09-17-Jetpack%E4%B9%8BLifecycle%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/)有所了解。\n\nLifecycle是LiveData的根基，先有了生命周期的管理，才能进行安全不泄漏的数据观察。\n\n先要引入LiveData：\n\n```groovy\nimplementation \"androidx.lifecycle:lifecycle-viewmodel-ktx:2.2.0\"\n\ndef activity_version = \"1.1.0\"\n// Kotlin，引入这个扩展，可以使用by viewModels()方法\nimplementation \"androidx.activity:activity-ktx:$activity_version\"\n```\n\n典型的用法如下：\n\n```kotlin\nclass MainActivity : AppCompatActivity() {\n\n    private val vm by viewModels<MainVM>()\n\n    override fun onCreate(savedInstanceState: Bundle?) {\n        super.onCreate(savedInstanceState)\n        setContentView(R.layout.activity_main)\n\n        vm.data.observe(this) {\n            Toast.makeText(this@MainActivity, it, Toast.LENGTH_SHORT).show()\n        }\n\n        vm.start()\n\n    }\n}\n```\n\n```kotlin\nclass MainVM : ViewModel() {\n\n    val data = MutableLiveData<String>()\n\n    fun start() {\n        data.value = \"start\"\n        Thread {\n            Thread.sleep(2000)\n            data.postValue(\"run after 2000ms\")\n        }.start()\n    }\n\n}\n```\n\n从这两段代码中，我们就可以看出典型的用法，主要是在三个方法上，*observe*、*setValue*和*postValue*。我们就从这三个方法入手去探究LiveData的工作机制。\n\n## observe方法\n\n```java\n// LiveData.java\n\n@MainThread\npublic void observe(@NonNull LifecycleOwner owner, @NonNull Observer<? super T> observer) {\n  assertMainThread(\"observe\");\n  if (owner.getLifecycle().getCurrentState() == DESTROYED) {\n    // ignore\n    return;\n  }\n  LifecycleBoundObserver wrapper = new LifecycleBoundObserver(owner, observer);\n  ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper);\n  if (existing != null && !existing.isAttachedTo(owner)) {\n    throw new IllegalArgumentException(\"Cannot add the same observer\"\n                                       + \" with different lifecycles\");\n  }\n  if (existing != null) {\n    return;\n  }\n  owner.getLifecycle().addObserver(wrapper);\n}\n```\n\n1. 只允许在主线程中监听数据变化，并且如果*LifecycleOwner*已经处于**DESTROYED**状态，则忽略这次监听请求。\n2. 以*LifecycleOwner*和*Observer*创建一个*LifecycleBoundObserver*对象，这个对象继承了*ObserverWrapper*类，同时实现了*LifecycleEventObserver*接口，看到这个接口，我们便明白了*LiveData*能够生命周期安全的监听数据变化的原因了。\n3. 这个*LifecycleBoundObserver*对象需要存储在一个*SafeIterableMap*当中去，在存储时候，会通过observer判断是否已经存在一个*ObserverWrapper*对象existing，如果已经存在则分为两种：a. 如果existing没有attach在owner上，则说明，existing已经attach在另外一个*LifecycleOwner*上了，这是不允许的，此时需要抛出异常；b. 如果没有attach在另外一个*LifecycleOwner*上，则说明此时监听的就是当前的owner上，则不需要再次添加监听，直接返回。如果existing不存在，则向owner.getLifecycle()添加监听。\n\n\n\n## setValue和postValue方法\n\n在子线程中更新数据，需要调用postValue方法，实际上，这个方法就是通过一个MainHandler去post一个*Runnable*的方式切换到主线程中执行setValue方法。所以，我们重点看setValue方法即可。\n\n```java\n// LiveData.java\n\n@MainThread\nprotected void setValue(T value) {\n  assertMainThread(\"setValue\");\n  mVersion++;\n  mData = value;\n  dispatchingValue(null);\n}\n```\n\n这里需要注意到的是`mVersion++`这句话，*LiveData*就是通过版本号来记录新的值的。继续看dispatchingValue方法。\n\n\n\n### dispatchingValue\n\n```java\n@SuppressWarnings(\"WeakerAccess\") /* synthetic access */\nvoid dispatchingValue(@Nullable ObserverWrapper initiator) {\n  if (mDispatchingValue) {\t\t\t\t// ①\n    mDispatchInvalidated = true;\n    return;\n  }\n  mDispatchingValue = true;\n  do {\n    mDispatchInvalidated = false;\t// ②\n    if (initiator != null) {\n      considerNotify(initiator);\n      initiator = null;\n    } else {\n      for (Iterator<Map.Entry<Observer<? super T>, ObserverWrapper>> iterator =\n           mObservers.iteratorWithAdditions(); iterator.hasNext(); ) {\n        considerNotify(iterator.next().getValue());\n        if (mDispatchInvalidated) { // ③\n          break;\n        }\n      }\n    }\n  } while (mDispatchInvalidated);\n  mDispatchingValue = false;\n}\n```\n\n在这里，涉及到两个方法，1. 第一个dispatchingValue —— 用来分发控制数据更新流程；2. considerNotify具体执行数据更新操作。\n\n这个方法是双信号量控制分发流程，**mDispatchingValue**和**mDispatchInvalidated**，之所以这样设计，按照我的理解，是考虑到了dispatchingValue方法多线程重入的问题，但是依我看来，这样做没必要，因为这个方法的几处调用，都是在主线程上，不可能出现第一次调用没有执行完，就又被调用一次的可能，也可能是设计者考虑到未来的扩展或者在这个库涉及之初有多线程调用的情况才这样写的，先按照有重入可能来分析。\n\n我们先要弄清这两个信号量的作用：mDispatchingValue表示是否正在执行分发数据更新的操作，mDispatchInvalidated表示是否中断正在进行的分发，开始新一轮分发。\n\n这个方法是根据传入的参数，有两个执行流程，一个是执行具体某个ObserverWrapper的数据更新操作，另外一个就是批量更新所有observer的数据操作。我们以setValue触发的dispatchingValue(null)批量更新操作为例进行分析。\n\n注意我在上段代码中的序号①②③注释，我们分步骤进行分析：\n\n> 假设，此时我们有两个observer。\n>\n> 初始状态 **mDispatchingValue = false, mDispatchInvalidated = false**\n>\n> 当**第一次**调用开始后，会顺利通过①处判断，然后进入do - while循环，并且在②处先将mDispatchInvalidated信号量置为false，所以，一般情况下，这个while循环只会执行一次；\n>\n> \n>\n> 信号量：**mDispatchingValue = true, mDispatchInvalidated = false**\n>\n> 由于initiator参数为null，所以会进入到else分支中的for循环中，这里需要注意的是，每一次for循环结束时候，都判断一次mDispatchInvalidated信号量，也就是注释③处；\n>\n> 假设我们执行了第一个observer后，dispatchingValue方法进行了**第二次**调用，由于此时mDispatchingValue信号量为true，所以会进入①处if条件判断语句，将mDispatchInvalidated信号量置为true并且直接return了；\n>\n> \n>\n> 信号量：**mDispatchingValue = true, mDispatchInvalidated = true**\n>\n> 此时，第一次调用的for循环体就会因为mDispatchInvalidated变成了true，而退出for循环，while循环开始判断条件，同样因为mDispatchInvalidated为true，回再次执行while循环，执行新值更新；\n>\n> 最后退出dispatchingValue方法后，两个信号量都置为false。\n\n这样做的目的，或许是为了及时抛弃旧值通知，开始新值通知。\n\n\n\n### considerNotify\n\n```java\n\n\n@SuppressWarnings(\"unchecked\")\nprivate void considerNotify(ObserverWrapper observer) {\n  if (!observer.mActive) {\n    return;\n  }\n  // Check latest state b4 dispatch. Maybe it changed state but we didn't get the event yet.\n  //\n  // we still first check observer.active to keep it as the entrance for events. So even if\n  // the observer moved to an active state, if we've not received that event, we better not\n  // notify for a more predictable notification order.\n  if (!observer.shouldBeActive()) {\n    observer.activeStateChanged(false);\n    return;\n  }\n  if (observer.mLastVersion >= mVersion) {\n    return;\n  }\n  observer.mLastVersion = mVersion;\n  observer.mObserver.onChanged((T) mData);\n}\n```\n\n这个方法是具体执行通知观察者值变化的地方。\n\n那么LiveData是如何判断新值和旧值的呢？\n\n在setValue方法中，有一个`mVersion++`语句，每次设置新值都会触发这个mVersion的自增，然后在considerNotify方法中，去校验observer是否处于active状态以及新值版本号与observer中的版本号，如果observer**应当**处于非active状态而仍然处于active状态(**因为状态可能由于handler机制并没有及时变更**)，则进行状态变更并返回，并且如果`observer.mLastVersion >= mVersion`，则直接返回，因为此时observer已经更新过此值。**也就是说，只有observer处于active状态且当前mVersion > observer.mVersion的时候，才去通知observer更新值**。\n\n接下来，着重看一下*LifecycleBoundObserver*和*ObserverWrapper*这个两个类。\n\n\n\n## LifecycleBoundObserver和ObserverWrapper\n\n*ObserverWrapper*是*Observer*的抽象包装类，代码很简单：\n\n```java\nprivate abstract class ObserverWrapper {\n  final Observer<? super T> mObserver;\n  boolean mActive;\n  int mLastVersion = START_VERSION;\n\n  ObserverWrapper(Observer<? super T> observer) {\n    mObserver = observer;\n  }\n\n  abstract boolean shouldBeActive();\n\n  boolean isAttachedTo(LifecycleOwner owner) {\n    return false;\n  }\n\n  void detachObserver() {\n  }\n\n  void activeStateChanged(boolean newActive) {\n    if (newActive == mActive) {\n      return;\n    }\n    // immediately set active state, so we'd never dispatch anything to inactive\n    // owner\n    mActive = newActive;\n    boolean wasInactive = LiveData.this.mActiveCount == 0;\n    LiveData.this.mActiveCount += mActive ? 1 : -1;\n    if (wasInactive && mActive) {\n      onActive();\n    }\n    if (LiveData.this.mActiveCount == 0 && !mActive) {\n      onInactive();\n    }\n    if (mActive) {\n      dispatchingValue(this);\n    }\n  }\n}\n```\n\n在activeStateChanged方法中，先判断是否是状态的改变，如果`newActive == mActive`说明激活状态未改变，则直接返回；然后判断按照激活的observer数目和mActive状态，来判断LiveData的状态，并调用其空回调函数；最后如果mActive为true，则进行针对这个*ObserverWrapper*的事件分发。\n\n*ObserverWrapper*有两个子类，*LifecycleBoundObserver*和*AlwaysActiveObserver*，*AlwaysActiveObserver*是与生命周期无关的observer，需要谨慎使用，在适当的时候，通过removeObserver来删除，我们重点看*LifecycleBoundObserver*。\n\n*LifecycleBoundObserver*同时实现了*LifecycleEventObserver*，这就使得这个类具备了生命周期关联性。\n\n```java\nclass LifecycleBoundObserver extends ObserverWrapper implements LifecycleEventObserver {\n  @NonNull\n  final LifecycleOwner mOwner;\n\n  LifecycleBoundObserver(@NonNull LifecycleOwner owner, Observer<? super T> observer) {\n    super(observer);\n    mOwner = owner;\n  }\n\n  @Override\n  boolean shouldBeActive() {\n    return mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED);\n  }\n\n  @Override\n  public void onStateChanged(@NonNull LifecycleOwner source,\n                             @NonNull Lifecycle.Event event) {\n    if (mOwner.getLifecycle().getCurrentState() == DESTROYED) {\n      removeObserver(mObserver);\n      return;\n    }\n    activeStateChanged(shouldBeActive());\n  }\n\n  @Override\n  boolean isAttachedTo(LifecycleOwner owner) {\n    return mOwner == owner;\n  }\n\n  @Override\n  void detachObserver() {\n    mOwner.getLifecycle().removeObserver(this);\n  }\n}\n```\n\n在onStateChanged方法中，当生命周期处于**DESTROYED**状态时候，则删除这个observer。除此以外，当mOwner的生命周期处于**STARTED**之后的状态，则认为`shouldBeActive`，当生命周期函数onStateChanged被触发时候，将设置是否active。\n\n\n\n## 总结\n\n通过LiveData的这些特性，我们可以实现Activity - Fragment, Fragment - Fragment的通信，另外也可以做应用的事件总线，比如**LiveEventBus**。","slug":"2022-09-17-Jetpack之LiveData源码分析","published":1,"updated":"2024-11-13T13:39:36.076Z","_id":"cm1ltr0g10012bji051ska1yp","comments":1,"photos":[],"content":"<p>在阅读这篇文章前，需要先对<a href=\"https://boybeak.github.io/2021/03/12/2022-09-17-Jetpack%E4%B9%8BLifecycle%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/\">Lifecycle</a>有所了解。</p>\n<p>Lifecycle是LiveData的根基，先有了生命周期的管理，才能进行安全不泄漏的数据观察。</p>\n<p>先要引入LiveData：</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">implementation <span class=\"token interpolation-string\"><span class=\"token string\">\"androidx.lifecycle:lifecycle-viewmodel-ktx:2.2.0\"</span></span>\n\n<span class=\"token keyword\">def</span> activity_version <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"1.1.0\"</span></span>\n<span class=\"token comment\">// Kotlin，引入这个扩展，可以使用by viewModels()方法</span>\nimplementation <span class=\"token interpolation-string\"><span class=\"token string\">\"androidx.activity:activity-ktx:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">activity_version</span></span><span class=\"token string\">\"</span></span></code></pre>\n\n<p>典型的用法如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> MainActivity <span class=\"token operator\">:</span> <span class=\"token function\">AppCompatActivity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> vm <span class=\"token keyword\">by</span> viewModels<span class=\"token operator\">&lt;</span>MainVM<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token operator\">:</span> Bundle<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">setContentView</span><span class=\"token punctuation\">(</span>R<span class=\"token punctuation\">.</span>layout<span class=\"token punctuation\">.</span>activity_main<span class=\"token punctuation\">)</span>\n\n        vm<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            Toast<span class=\"token punctuation\">.</span><span class=\"token function\">makeText</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token label symbol\">@MainActivity</span><span class=\"token punctuation\">,</span> it<span class=\"token punctuation\">,</span> Toast<span class=\"token punctuation\">.</span>LENGTH_SHORT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        vm<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> MainVM <span class=\"token operator\">:</span> <span class=\"token function\">ViewModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">val</span> <span class=\"token keyword\">data</span> <span class=\"token operator\">=</span> MutableLiveData<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"start\"</span></span>\n        Thread <span class=\"token punctuation\">&#123;</span>\n            Thread<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span><span class=\"token function\">postValue</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"run after 2000ms\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>从这两段代码中，我们就可以看出典型的用法，主要是在三个方法上，<em>observe</em>、<em>setValue</em>和<em>postValue</em>。我们就从这三个方法入手去探究LiveData的工作机制。</p>\n<h2 id=\"observe方法\"><a href=\"#observe方法\" class=\"headerlink\" title=\"observe方法\"></a>observe方法</h2><pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">// LiveData.java</span>\n\n<span class=\"token annotation punctuation\">@MainThread</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">assertMainThread</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"observe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token constant\">DESTROYED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// ignore</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token class-name\">LifecycleBoundObserver</span> wrapper <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LifecycleBoundObserver</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">,</span> observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">ObserverWrapper</span> existing <span class=\"token operator\">=</span> mObservers<span class=\"token punctuation\">.</span><span class=\"token function\">putIfAbsent</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">,</span> wrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existing <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>existing<span class=\"token punctuation\">.</span><span class=\"token function\">isAttachedTo</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot add the same observer\"</span>\n                                       <span class=\"token operator\">+</span> <span class=\"token string\">\" with different lifecycles\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existing <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  owner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addObserver</span><span class=\"token punctuation\">(</span>wrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<ol>\n<li>只允许在主线程中监听数据变化，并且如果<em>LifecycleOwner</em>已经处于<strong>DESTROYED</strong>状态，则忽略这次监听请求。</li>\n<li>以<em>LifecycleOwner</em>和<em>Observer</em>创建一个<em>LifecycleBoundObserver</em>对象，这个对象继承了<em>ObserverWrapper</em>类，同时实现了<em>LifecycleEventObserver</em>接口，看到这个接口，我们便明白了<em>LiveData</em>能够生命周期安全的监听数据变化的原因了。</li>\n<li>这个<em>LifecycleBoundObserver</em>对象需要存储在一个<em>SafeIterableMap</em>当中去，在存储时候，会通过observer判断是否已经存在一个<em>ObserverWrapper</em>对象existing，如果已经存在则分为两种：a. 如果existing没有attach在owner上，则说明，existing已经attach在另外一个<em>LifecycleOwner</em>上了，这是不允许的，此时需要抛出异常；b. 如果没有attach在另外一个<em>LifecycleOwner</em>上，则说明此时监听的就是当前的owner上，则不需要再次添加监听，直接返回。如果existing不存在，则向owner.getLifecycle()添加监听。</li>\n</ol>\n<h2 id=\"setValue和postValue方法\"><a href=\"#setValue和postValue方法\" class=\"headerlink\" title=\"setValue和postValue方法\"></a>setValue和postValue方法</h2><p>在子线程中更新数据，需要调用postValue方法，实际上，这个方法就是通过一个MainHandler去post一个<em>Runnable</em>的方式切换到主线程中执行setValue方法。所以，我们重点看setValue方法即可。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">// LiveData.java</span>\n\n<span class=\"token annotation punctuation\">@MainThread</span>\n<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">assertMainThread</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"setValue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  mVersion<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n  mData <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">dispatchingValue</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里需要注意到的是<code>mVersion++</code>这句话，<em>LiveData</em>就是通过版本号来记录新的值的。继续看dispatchingValue方法。</p>\n<h3 id=\"dispatchingValue\"><a href=\"#dispatchingValue\" class=\"headerlink\" title=\"dispatchingValue\"></a>dispatchingValue</h3><pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WeakerAccess\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">/* synthetic access */</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">dispatchingValue</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">ObserverWrapper</span> initiator<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mDispatchingValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\t\t\t\t<span class=\"token comment\">// ①</span>\n    mDispatchInvalidated <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  mDispatchingValue <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span>\n    mDispatchInvalidated <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// ②</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>initiator <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">considerNotify</span><span class=\"token punctuation\">(</span>initiator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      initiator <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Observer</span><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ObserverWrapper</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> iterator <span class=\"token operator\">=</span>\n           mObservers<span class=\"token punctuation\">.</span><span class=\"token function\">iteratorWithAdditions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> iterator<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">considerNotify</span><span class=\"token punctuation\">(</span>iterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mDispatchInvalidated<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// ③</span>\n          <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>mDispatchInvalidated<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  mDispatchingValue <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在这里，涉及到两个方法，1. 第一个dispatchingValue —— 用来分发控制数据更新流程；2. considerNotify具体执行数据更新操作。</p>\n<p>这个方法是双信号量控制分发流程，<strong>mDispatchingValue</strong>和<strong>mDispatchInvalidated</strong>，之所以这样设计，按照我的理解，是考虑到了dispatchingValue方法多线程重入的问题，但是依我看来，这样做没必要，因为这个方法的几处调用，都是在主线程上，不可能出现第一次调用没有执行完，就又被调用一次的可能，也可能是设计者考虑到未来的扩展或者在这个库涉及之初有多线程调用的情况才这样写的，先按照有重入可能来分析。</p>\n<p>我们先要弄清这两个信号量的作用：mDispatchingValue表示是否正在执行分发数据更新的操作，mDispatchInvalidated表示是否中断正在进行的分发，开始新一轮分发。</p>\n<p>这个方法是根据传入的参数，有两个执行流程，一个是执行具体某个ObserverWrapper的数据更新操作，另外一个就是批量更新所有observer的数据操作。我们以setValue触发的dispatchingValue(null)批量更新操作为例进行分析。</p>\n<p>注意我在上段代码中的序号①②③注释，我们分步骤进行分析：</p>\n<blockquote>\n<p>假设，此时我们有两个observer。</p>\n<p>初始状态 <strong>mDispatchingValue &#x3D; false, mDispatchInvalidated &#x3D; false</strong></p>\n<p>当<strong>第一次</strong>调用开始后，会顺利通过①处判断，然后进入do - while循环，并且在②处先将mDispatchInvalidated信号量置为false，所以，一般情况下，这个while循环只会执行一次；</p>\n<p>信号量：<strong>mDispatchingValue &#x3D; true, mDispatchInvalidated &#x3D; false</strong></p>\n<p>由于initiator参数为null，所以会进入到else分支中的for循环中，这里需要注意的是，每一次for循环结束时候，都判断一次mDispatchInvalidated信号量，也就是注释③处；</p>\n<p>假设我们执行了第一个observer后，dispatchingValue方法进行了<strong>第二次</strong>调用，由于此时mDispatchingValue信号量为true，所以会进入①处if条件判断语句，将mDispatchInvalidated信号量置为true并且直接return了；</p>\n<p>信号量：<strong>mDispatchingValue &#x3D; true, mDispatchInvalidated &#x3D; true</strong></p>\n<p>此时，第一次调用的for循环体就会因为mDispatchInvalidated变成了true，而退出for循环，while循环开始判断条件，同样因为mDispatchInvalidated为true，回再次执行while循环，执行新值更新；</p>\n<p>最后退出dispatchingValue方法后，两个信号量都置为false。</p>\n</blockquote>\n<p>这样做的目的，或许是为了及时抛弃旧值通知，开始新值通知。</p>\n<h3 id=\"considerNotify\"><a href=\"#considerNotify\" class=\"headerlink\" title=\"considerNotify\"></a>considerNotify</h3><pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\">\n\n<span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">considerNotify</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ObserverWrapper</span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>observer<span class=\"token punctuation\">.</span>mActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// Check latest state b4 dispatch. Maybe it changed state but we didn't get the event yet.</span>\n  <span class=\"token comment\">//</span>\n  <span class=\"token comment\">// we still first check observer.active to keep it as the entrance for events. So even if</span>\n  <span class=\"token comment\">// the observer moved to an active state, if we've not received that event, we better not</span>\n  <span class=\"token comment\">// notify for a more predictable notification order.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>observer<span class=\"token punctuation\">.</span><span class=\"token function\">shouldBeActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    observer<span class=\"token punctuation\">.</span><span class=\"token function\">activeStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">.</span>mLastVersion <span class=\"token operator\">>=</span> mVersion<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  observer<span class=\"token punctuation\">.</span>mLastVersion <span class=\"token operator\">=</span> mVersion<span class=\"token punctuation\">;</span>\n  observer<span class=\"token punctuation\">.</span>mObserver<span class=\"token punctuation\">.</span><span class=\"token function\">onChanged</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> mData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这个方法是具体执行通知观察者值变化的地方。</p>\n<p>那么LiveData是如何判断新值和旧值的呢？</p>\n<p>在setValue方法中，有一个<code>mVersion++</code>语句，每次设置新值都会触发这个mVersion的自增，然后在considerNotify方法中，去校验observer是否处于active状态以及新值版本号与observer中的版本号，如果observer<strong>应当</strong>处于非active状态而仍然处于active状态(<strong>因为状态可能由于handler机制并没有及时变更</strong>)，则进行状态变更并返回，并且如果<code>observer.mLastVersion &gt;= mVersion</code>，则直接返回，因为此时observer已经更新过此值。<strong>也就是说，只有observer处于active状态且当前mVersion &gt; observer.mVersion的时候，才去通知observer更新值</strong>。</p>\n<p>接下来，着重看一下<em>LifecycleBoundObserver</em>和<em>ObserverWrapper</em>这个两个类。</p>\n<h2 id=\"LifecycleBoundObserver和ObserverWrapper\"><a href=\"#LifecycleBoundObserver和ObserverWrapper\" class=\"headerlink\" title=\"LifecycleBoundObserver和ObserverWrapper\"></a>LifecycleBoundObserver和ObserverWrapper</h2><p><em>ObserverWrapper</em>是<em>Observer</em>的抽象包装类，代码很简单：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ObserverWrapper</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">final</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> mObserver<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">boolean</span> mActive<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> mLastVersion <span class=\"token operator\">=</span> <span class=\"token constant\">START_VERSION</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">ObserverWrapper</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    mObserver <span class=\"token operator\">=</span> observer<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">shouldBeActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">boolean</span> <span class=\"token function\">isAttachedTo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">void</span> <span class=\"token function\">detachObserver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">void</span> <span class=\"token function\">activeStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> newActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newActive <span class=\"token operator\">==</span> mActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// immediately set active state, so we'd never dispatch anything to inactive</span>\n    <span class=\"token comment\">// owner</span>\n    mActive <span class=\"token operator\">=</span> newActive<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">boolean</span> wasInactive <span class=\"token operator\">=</span> <span class=\"token class-name\">LiveData</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mActiveCount <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">LiveData</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mActiveCount <span class=\"token operator\">+=</span> mActive <span class=\"token operator\">?</span> <span class=\"token number\">1</span> <span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>wasInactive <span class=\"token operator\">&amp;&amp;</span> mActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">onActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">LiveData</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mActiveCount <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>mActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">onInactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">dispatchingValue</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在activeStateChanged方法中，先判断是否是状态的改变，如果<code>newActive == mActive</code>说明激活状态未改变，则直接返回；然后判断按照激活的observer数目和mActive状态，来判断LiveData的状态，并调用其空回调函数；最后如果mActive为true，则进行针对这个<em>ObserverWrapper</em>的事件分发。</p>\n<p><em>ObserverWrapper</em>有两个子类，<em>LifecycleBoundObserver</em>和<em>AlwaysActiveObserver</em>，<em>AlwaysActiveObserver</em>是与生命周期无关的observer，需要谨慎使用，在适当的时候，通过removeObserver来删除，我们重点看<em>LifecycleBoundObserver</em>。</p>\n<p><em>LifecycleBoundObserver</em>同时实现了<em>LifecycleEventObserver</em>，这就使得这个类具备了生命周期关联性。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">LifecycleBoundObserver</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ObserverWrapper</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">LifecycleEventObserver</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token annotation punctuation\">@NonNull</span>\n  <span class=\"token keyword\">final</span> <span class=\"token class-name\">LifecycleOwner</span> mOwner<span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">LifecycleBoundObserver</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mOwner <span class=\"token operator\">=</span> owner<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">boolean</span> <span class=\"token function\">shouldBeActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> mOwner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isAtLeast</span><span class=\"token punctuation\">(</span><span class=\"token constant\">STARTED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">LifecycleOwner</span> source<span class=\"token punctuation\">,</span>\n                             <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span> event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mOwner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token constant\">DESTROYED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">removeObserver</span><span class=\"token punctuation\">(</span>mObserver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token function\">activeStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token function\">shouldBeActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">boolean</span> <span class=\"token function\">isAttachedTo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> mOwner <span class=\"token operator\">==</span> owner<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">void</span> <span class=\"token function\">detachObserver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    mOwner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">removeObserver</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在onStateChanged方法中，当生命周期处于<strong>DESTROYED</strong>状态时候，则删除这个observer。除此以外，当mOwner的生命周期处于<strong>STARTED</strong>之后的状态，则认为<code>shouldBeActive</code>，当生命周期函数onStateChanged被触发时候，将设置是否active。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>通过LiveData的这些特性，我们可以实现Activity - Fragment, Fragment - Fragment的通信，另外也可以做应用的事件总线，比如<strong>LiveEventBus</strong>。</p>\n","excerpt":"","more":"<p>在阅读这篇文章前，需要先对<a href=\"https://boybeak.github.io/2021/03/12/2022-09-17-Jetpack%E4%B9%8BLifecycle%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/\">Lifecycle</a>有所了解。</p>\n<p>Lifecycle是LiveData的根基，先有了生命周期的管理，才能进行安全不泄漏的数据观察。</p>\n<p>先要引入LiveData：</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">implementation <span class=\"token interpolation-string\"><span class=\"token string\">\"androidx.lifecycle:lifecycle-viewmodel-ktx:2.2.0\"</span></span>\n\n<span class=\"token keyword\">def</span> activity_version <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"1.1.0\"</span></span>\n<span class=\"token comment\">// Kotlin，引入这个扩展，可以使用by viewModels()方法</span>\nimplementation <span class=\"token interpolation-string\"><span class=\"token string\">\"androidx.activity:activity-ktx:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">activity_version</span></span><span class=\"token string\">\"</span></span></code></pre>\n\n<p>典型的用法如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> MainActivity <span class=\"token operator\">:</span> <span class=\"token function\">AppCompatActivity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> vm <span class=\"token keyword\">by</span> viewModels<span class=\"token operator\">&lt;</span>MainVM<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token operator\">:</span> Bundle<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">setContentView</span><span class=\"token punctuation\">(</span>R<span class=\"token punctuation\">.</span>layout<span class=\"token punctuation\">.</span>activity_main<span class=\"token punctuation\">)</span>\n\n        vm<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            Toast<span class=\"token punctuation\">.</span><span class=\"token function\">makeText</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token label symbol\">@MainActivity</span><span class=\"token punctuation\">,</span> it<span class=\"token punctuation\">,</span> Toast<span class=\"token punctuation\">.</span>LENGTH_SHORT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        vm<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> MainVM <span class=\"token operator\">:</span> <span class=\"token function\">ViewModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">val</span> <span class=\"token keyword\">data</span> <span class=\"token operator\">=</span> MutableLiveData<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"start\"</span></span>\n        Thread <span class=\"token punctuation\">&#123;</span>\n            Thread<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span><span class=\"token function\">postValue</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"run after 2000ms\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>从这两段代码中，我们就可以看出典型的用法，主要是在三个方法上，<em>observe</em>、<em>setValue</em>和<em>postValue</em>。我们就从这三个方法入手去探究LiveData的工作机制。</p>\n<h2 id=\"observe方法\"><a href=\"#observe方法\" class=\"headerlink\" title=\"observe方法\"></a>observe方法</h2><pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">// LiveData.java</span>\n\n<span class=\"token annotation punctuation\">@MainThread</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">assertMainThread</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"observe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token constant\">DESTROYED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// ignore</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token class-name\">LifecycleBoundObserver</span> wrapper <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LifecycleBoundObserver</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">,</span> observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">ObserverWrapper</span> existing <span class=\"token operator\">=</span> mObservers<span class=\"token punctuation\">.</span><span class=\"token function\">putIfAbsent</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">,</span> wrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existing <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>existing<span class=\"token punctuation\">.</span><span class=\"token function\">isAttachedTo</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot add the same observer\"</span>\n                                       <span class=\"token operator\">+</span> <span class=\"token string\">\" with different lifecycles\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existing <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  owner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addObserver</span><span class=\"token punctuation\">(</span>wrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<ol>\n<li>只允许在主线程中监听数据变化，并且如果<em>LifecycleOwner</em>已经处于<strong>DESTROYED</strong>状态，则忽略这次监听请求。</li>\n<li>以<em>LifecycleOwner</em>和<em>Observer</em>创建一个<em>LifecycleBoundObserver</em>对象，这个对象继承了<em>ObserverWrapper</em>类，同时实现了<em>LifecycleEventObserver</em>接口，看到这个接口，我们便明白了<em>LiveData</em>能够生命周期安全的监听数据变化的原因了。</li>\n<li>这个<em>LifecycleBoundObserver</em>对象需要存储在一个<em>SafeIterableMap</em>当中去，在存储时候，会通过observer判断是否已经存在一个<em>ObserverWrapper</em>对象existing，如果已经存在则分为两种：a. 如果existing没有attach在owner上，则说明，existing已经attach在另外一个<em>LifecycleOwner</em>上了，这是不允许的，此时需要抛出异常；b. 如果没有attach在另外一个<em>LifecycleOwner</em>上，则说明此时监听的就是当前的owner上，则不需要再次添加监听，直接返回。如果existing不存在，则向owner.getLifecycle()添加监听。</li>\n</ol>\n<h2 id=\"setValue和postValue方法\"><a href=\"#setValue和postValue方法\" class=\"headerlink\" title=\"setValue和postValue方法\"></a>setValue和postValue方法</h2><p>在子线程中更新数据，需要调用postValue方法，实际上，这个方法就是通过一个MainHandler去post一个<em>Runnable</em>的方式切换到主线程中执行setValue方法。所以，我们重点看setValue方法即可。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token comment\">// LiveData.java</span>\n\n<span class=\"token annotation punctuation\">@MainThread</span>\n<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">assertMainThread</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"setValue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  mVersion<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n  mData <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">dispatchingValue</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这里需要注意到的是<code>mVersion++</code>这句话，<em>LiveData</em>就是通过版本号来记录新的值的。继续看dispatchingValue方法。</p>\n<h3 id=\"dispatchingValue\"><a href=\"#dispatchingValue\" class=\"headerlink\" title=\"dispatchingValue\"></a>dispatchingValue</h3><pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WeakerAccess\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">/* synthetic access */</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">dispatchingValue</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">ObserverWrapper</span> initiator<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mDispatchingValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\t\t\t\t<span class=\"token comment\">// ①</span>\n    mDispatchInvalidated <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  mDispatchingValue <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span>\n    mDispatchInvalidated <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// ②</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>initiator <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">considerNotify</span><span class=\"token punctuation\">(</span>initiator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      initiator <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Observer</span><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ObserverWrapper</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> iterator <span class=\"token operator\">=</span>\n           mObservers<span class=\"token punctuation\">.</span><span class=\"token function\">iteratorWithAdditions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> iterator<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">considerNotify</span><span class=\"token punctuation\">(</span>iterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mDispatchInvalidated<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// ③</span>\n          <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>mDispatchInvalidated<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  mDispatchingValue <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在这里，涉及到两个方法，1. 第一个dispatchingValue —— 用来分发控制数据更新流程；2. considerNotify具体执行数据更新操作。</p>\n<p>这个方法是双信号量控制分发流程，<strong>mDispatchingValue</strong>和<strong>mDispatchInvalidated</strong>，之所以这样设计，按照我的理解，是考虑到了dispatchingValue方法多线程重入的问题，但是依我看来，这样做没必要，因为这个方法的几处调用，都是在主线程上，不可能出现第一次调用没有执行完，就又被调用一次的可能，也可能是设计者考虑到未来的扩展或者在这个库涉及之初有多线程调用的情况才这样写的，先按照有重入可能来分析。</p>\n<p>我们先要弄清这两个信号量的作用：mDispatchingValue表示是否正在执行分发数据更新的操作，mDispatchInvalidated表示是否中断正在进行的分发，开始新一轮分发。</p>\n<p>这个方法是根据传入的参数，有两个执行流程，一个是执行具体某个ObserverWrapper的数据更新操作，另外一个就是批量更新所有observer的数据操作。我们以setValue触发的dispatchingValue(null)批量更新操作为例进行分析。</p>\n<p>注意我在上段代码中的序号①②③注释，我们分步骤进行分析：</p>\n<blockquote>\n<p>假设，此时我们有两个observer。</p>\n<p>初始状态 <strong>mDispatchingValue &#x3D; false, mDispatchInvalidated &#x3D; false</strong></p>\n<p>当<strong>第一次</strong>调用开始后，会顺利通过①处判断，然后进入do - while循环，并且在②处先将mDispatchInvalidated信号量置为false，所以，一般情况下，这个while循环只会执行一次；</p>\n<p>信号量：<strong>mDispatchingValue &#x3D; true, mDispatchInvalidated &#x3D; false</strong></p>\n<p>由于initiator参数为null，所以会进入到else分支中的for循环中，这里需要注意的是，每一次for循环结束时候，都判断一次mDispatchInvalidated信号量，也就是注释③处；</p>\n<p>假设我们执行了第一个observer后，dispatchingValue方法进行了<strong>第二次</strong>调用，由于此时mDispatchingValue信号量为true，所以会进入①处if条件判断语句，将mDispatchInvalidated信号量置为true并且直接return了；</p>\n<p>信号量：<strong>mDispatchingValue &#x3D; true, mDispatchInvalidated &#x3D; true</strong></p>\n<p>此时，第一次调用的for循环体就会因为mDispatchInvalidated变成了true，而退出for循环，while循环开始判断条件，同样因为mDispatchInvalidated为true，回再次执行while循环，执行新值更新；</p>\n<p>最后退出dispatchingValue方法后，两个信号量都置为false。</p>\n</blockquote>\n<p>这样做的目的，或许是为了及时抛弃旧值通知，开始新值通知。</p>\n<h3 id=\"considerNotify\"><a href=\"#considerNotify\" class=\"headerlink\" title=\"considerNotify\"></a>considerNotify</h3><pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\">\n\n<span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">considerNotify</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ObserverWrapper</span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>observer<span class=\"token punctuation\">.</span>mActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// Check latest state b4 dispatch. Maybe it changed state but we didn't get the event yet.</span>\n  <span class=\"token comment\">//</span>\n  <span class=\"token comment\">// we still first check observer.active to keep it as the entrance for events. So even if</span>\n  <span class=\"token comment\">// the observer moved to an active state, if we've not received that event, we better not</span>\n  <span class=\"token comment\">// notify for a more predictable notification order.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>observer<span class=\"token punctuation\">.</span><span class=\"token function\">shouldBeActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    observer<span class=\"token punctuation\">.</span><span class=\"token function\">activeStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">.</span>mLastVersion <span class=\"token operator\">>=</span> mVersion<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  observer<span class=\"token punctuation\">.</span>mLastVersion <span class=\"token operator\">=</span> mVersion<span class=\"token punctuation\">;</span>\n  observer<span class=\"token punctuation\">.</span>mObserver<span class=\"token punctuation\">.</span><span class=\"token function\">onChanged</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> mData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这个方法是具体执行通知观察者值变化的地方。</p>\n<p>那么LiveData是如何判断新值和旧值的呢？</p>\n<p>在setValue方法中，有一个<code>mVersion++</code>语句，每次设置新值都会触发这个mVersion的自增，然后在considerNotify方法中，去校验observer是否处于active状态以及新值版本号与observer中的版本号，如果observer<strong>应当</strong>处于非active状态而仍然处于active状态(<strong>因为状态可能由于handler机制并没有及时变更</strong>)，则进行状态变更并返回，并且如果<code>observer.mLastVersion &gt;= mVersion</code>，则直接返回，因为此时observer已经更新过此值。<strong>也就是说，只有observer处于active状态且当前mVersion &gt; observer.mVersion的时候，才去通知observer更新值</strong>。</p>\n<p>接下来，着重看一下<em>LifecycleBoundObserver</em>和<em>ObserverWrapper</em>这个两个类。</p>\n<h2 id=\"LifecycleBoundObserver和ObserverWrapper\"><a href=\"#LifecycleBoundObserver和ObserverWrapper\" class=\"headerlink\" title=\"LifecycleBoundObserver和ObserverWrapper\"></a>LifecycleBoundObserver和ObserverWrapper</h2><p><em>ObserverWrapper</em>是<em>Observer</em>的抽象包装类，代码很简单：</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ObserverWrapper</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">final</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> mObserver<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">boolean</span> mActive<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> mLastVersion <span class=\"token operator\">=</span> <span class=\"token constant\">START_VERSION</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">ObserverWrapper</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    mObserver <span class=\"token operator\">=</span> observer<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">shouldBeActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">boolean</span> <span class=\"token function\">isAttachedTo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">void</span> <span class=\"token function\">detachObserver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">void</span> <span class=\"token function\">activeStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> newActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newActive <span class=\"token operator\">==</span> mActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// immediately set active state, so we'd never dispatch anything to inactive</span>\n    <span class=\"token comment\">// owner</span>\n    mActive <span class=\"token operator\">=</span> newActive<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">boolean</span> wasInactive <span class=\"token operator\">=</span> <span class=\"token class-name\">LiveData</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mActiveCount <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">LiveData</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mActiveCount <span class=\"token operator\">+=</span> mActive <span class=\"token operator\">?</span> <span class=\"token number\">1</span> <span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>wasInactive <span class=\"token operator\">&amp;&amp;</span> mActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">onActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">LiveData</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mActiveCount <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>mActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">onInactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">dispatchingValue</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在activeStateChanged方法中，先判断是否是状态的改变，如果<code>newActive == mActive</code>说明激活状态未改变，则直接返回；然后判断按照激活的observer数目和mActive状态，来判断LiveData的状态，并调用其空回调函数；最后如果mActive为true，则进行针对这个<em>ObserverWrapper</em>的事件分发。</p>\n<p><em>ObserverWrapper</em>有两个子类，<em>LifecycleBoundObserver</em>和<em>AlwaysActiveObserver</em>，<em>AlwaysActiveObserver</em>是与生命周期无关的observer，需要谨慎使用，在适当的时候，通过removeObserver来删除，我们重点看<em>LifecycleBoundObserver</em>。</p>\n<p><em>LifecycleBoundObserver</em>同时实现了<em>LifecycleEventObserver</em>，这就使得这个类具备了生命周期关联性。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">LifecycleBoundObserver</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ObserverWrapper</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">LifecycleEventObserver</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token annotation punctuation\">@NonNull</span>\n  <span class=\"token keyword\">final</span> <span class=\"token class-name\">LifecycleOwner</span> mOwner<span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">LifecycleBoundObserver</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mOwner <span class=\"token operator\">=</span> owner<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">boolean</span> <span class=\"token function\">shouldBeActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> mOwner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isAtLeast</span><span class=\"token punctuation\">(</span><span class=\"token constant\">STARTED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">LifecycleOwner</span> source<span class=\"token punctuation\">,</span>\n                             <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span> event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mOwner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token constant\">DESTROYED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">removeObserver</span><span class=\"token punctuation\">(</span>mObserver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token function\">activeStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token function\">shouldBeActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">boolean</span> <span class=\"token function\">isAttachedTo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> mOwner <span class=\"token operator\">==</span> owner<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">void</span> <span class=\"token function\">detachObserver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    mOwner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">removeObserver</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在onStateChanged方法中，当生命周期处于<strong>DESTROYED</strong>状态时候，则删除这个observer。除此以外，当mOwner的生命周期处于<strong>STARTED</strong>之后的状态，则认为<code>shouldBeActive</code>，当生命周期函数onStateChanged被触发时候，将设置是否active。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>通过LiveData的这些特性，我们可以实现Activity - Fragment, Fragment - Fragment的通信，另外也可以做应用的事件总线，比如<strong>LiveEventBus</strong>。</p>\n"},{"layout":"post","title":"Binder机制分析","author":"boybeak","date":"2022-09-18T21:00:00.000Z","_content":"\n\n参考文章：[写给 Android 应用工程师的 Binder 原理剖析](https://zhuanlan.zhihu.com/p/35519585)\n\n实验代码：[TheBinder](https://github.com/boybeak/TheBinder)\n\nBinder机制可以说是Android的核心。提到Binder，可能会让你想到，通过bindService与`Service`进行通信(也可能是跨进程的通信)，实际上，Android中Binder的使用可以说是无处不在的，包括Activity跳转，详情可以参考[AMS启动流程](https://boybeak.github.io/android/AMS%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.html)。\n\n## 为什么要用Binder?\n\n在Linux系统中，跨进程通信(IPC)方式有很多种，包括Socket、管道、共享内存等。可以Android为何最后选择Binder作为核心的跨进程通信的手段呢？\n\n这需要从两方面去分析——**性能**和**安全性**。\n\n### 1. 性能\n\n首先说说性能上的优势。Socket 作为一款通用接口，其传输效率低，开销大，主要用在跨网络的进程间通信和本机上进程间的低速通信。消息队列和管道采用存储-转发方式，即数据先从发送方缓存区拷贝到内核开辟的缓存区中，然后再从内核缓存区拷贝到接收方缓存区，至少有两次拷贝过程。共享内存虽然无需拷贝，但控制复杂，难以使用。Binder 只需要一次数据拷贝，性能上仅次于共享内存。\n\n### 2. 安全性\n\n另一方面就是安全性。Android 作为一个开放性的平台，市场上有各类海量的应用供用户选择安装，因此安全性对于 Android 平台而言极其重要。作为用户当然不希望我们下载的 APP 偷偷读取我的通信录，上传我的隐私数据，后台偷跑流量、消耗手机电量。传统的 IPC 没有任何安全措施，完全依赖上层协议来确保。首先传统的 IPC 接收方无法获得对方可靠的进程用户ID/进程ID（UID/PID），从而无法鉴别对方身份。Android 为每个安装好的 APP 分配了自己的 UID，故而进程的 UID 是鉴别进程身份的重要标志。传统的 IPC 只能由用户在数据包中填入 UID/PID，但这样不可靠，容易被恶意程序利用。可靠的身份标识只有由 IPC 机制在内核中添加。其次传统的 IPC 访问接入点是开放的，只要知道这些接入点的程序都可以和对端建立连接，不管怎样都无法阻止恶意程序通过猜测接收方地址获得连接。同时 Binder 既支持实名 Binder，又支持匿名 Binder，安全性高。\n\n基于上述原因，Android 需要建立一套新的 IPC 机制来满足系统对稳定性、传输性能和安全性方面的要求，这就是 Binder。\n\n用一张表格来总结与对比各种IPC方式。\n\n| IPC方式              | 性能(内存拷贝次数) | 安全性                             |\n| -------------------- | ------------------ | ---------------------------------- |\n| Binder               | 1                  | 通过UID/PID来保证                  |\n| 共享内存             | 0                  | 操作非常复杂，难以保证             |\n| Socket/管道/消息队列 | 2                  | 依靠上层协议做身份识别，非常不可靠 |\n\n\n\n\n\n## 传统IPC是什么样的？\n\n先要了解一些基本概念——**进程隔离**、**用户空间**、**内核空间**、**用户态**、**内核态**。\n\n![IPC](/images/traditional_ipc.jpg)\n\n上图展示了 Liunx 中跨进程通信涉及到的一些基本概念：\n\n- 进程隔离\n- 进程空间划分：用户空间(User Space)/内核空间(Kernel Space)\n- 系统调用：用户态/内核态\n\n\n\n### 进程隔离\n\n顾名思义，就是进程之间内存是不共享的。进程间要进行数据交换，就得采用**进程间通信(IPC)**机制。\n\n\n\n### 进程空间划分：用户空间(User Space)/内核空间(Kernel Space)\n\n现在操作系统都是采用的虚拟存储器，对于 32 位系统而言，它的寻址空间（虚拟存储空间）就是 2 的 32 次方，也就是 4GB。操作系统的核心是内核，独立于普通的应用程序，可以访问受保护的内存空间，也可以访问底层硬件设备的权限。为了保护用户进程不能直接操作内核，保证内核的安全，操作系统从逻辑上将虚拟空间划分为用户空间（User Space）和内核空间（Kernel Space）。针对 Linux 操作系统而言，将最高的 1GB 字节供内核使用，称为内核空间；较低的 3GB 字节供各进程使用，称为用户空间。\n\n> 简单的说就是，内核空间（Kernel）是系统内核运行的空间，用户空间（User Space）是用户程序运行的空间。为了保证安全性，它们之间是隔离的。\n\n![linux memory](/images/linux_memory.png)\n\n\n\n### 系统调用：用户态/内核态\n\n虽然从逻辑上进行了用户空间和内核空间的划分，但不可避免的用户空间需要访问内核资源，比如文件操作、访问网络等等。为了突破隔离限制，就需要借助**系统调用**来实现。系统调用是用户空间访问内核空间的唯一方式，保证了所有的资源访问都是在内核的控制下进行的，避免了用户程序对系统资源的越权访问，提升了系统安全性和稳定性。\n\nLinux 使用两级保护机制：0 级供系统内核使用，3 级供用户程序使用。\n\n当一个任务（进程）执行系统调用而陷入内核代码中执行时，称进程处于**内核运行态（内核态）**。此时处理器处于特权级最高的（0级）内核代码中执行。当进程处于内核态时，执行的内核代码会使用当前进程的内核栈。每个进程都有自己的内核栈。\n\n当进程在执行用户自己的代码的时候，我们称其处于**用户运行态（用户态）**。此时处理器在特权级最低的（3级）用户代码中运行。\n\n系统调用主要通过如下两个函数来实现：\n\n```\ncopy_from_user() //将数据从用户空间拷贝到内核空间\ncopy_to_user() //将数据从内核空间拷贝到用户空间\n```\n\n\n\n### Linux下传统IPC通信\n\n![linux ipc](/images/linux_ipc.jpg)\n\n**数据发送进程**：开辟用户空间缓存区 -> 系统调用，进入内核态 -> 开辟内核空间缓存区 ->通过`copy_from_user()`将数据拷贝到内核空间缓存区。\n\n**数据接收进程**：开辟用户空间缓存区 -> 调用`copytouser()`将数据从内核缓存区拷贝到用户空间缓存区。\n\n这样，两个进程就完成了依次进程间通信。\n\n这种传统的 IPC 通信方式有两个问题：\n\n1. 性能低下，一次数据传递需要经历：内存缓存区 --> 内核缓存区 --> 内存缓存区，需要 2 次数据拷贝；\n2. 接收数据的缓存区由数据接收进程提供，但是接收进程并不知道需要多大的空间来存放将要传递过来的数据，因此只能开辟尽可能大的内存空间或者先调用 API 接收消息头来获取消息体的大小，这两种做法不是浪费空间就是浪费时间。\n\n\n\n## Binder跨进程通信原理\n\n正如前面所说，跨进程通信是需要内核空间做支持的。传统的 IPC 机制如管道、Socket 都是内核的一部分，因此通过内核支持来实现进程间通信自然是没问题的。但是 Binder 并不是 Linux 系统内核的一部分，那怎么办呢？这就得益于 Linux 的**动态内核可加载模块**（Loadable Kernel Module，LKM）的机制；模块是具有独立功能的程序，它可以被单独编译，但是不能独立运行。它在运行时被链接到内核作为内核的一部分运行。这样，Android 系统就可以通过动态添加一个内核模块运行在内核空间，用户进程之间通过这个内核模块作为桥梁来实现通信。\n\n> 在 Android 系统中，这个运行在内核空间，负责各个用户进程通过 Binder 实现通信的内核模块就叫 **Binder 驱动**（Binder Dirver）。\n\n那么在 Android 系统中用户进程之间是如何通过这个内核模块（Binder 驱动）来实现通信的呢？难道是和前面说的传统 IPC 机制一样，先将数据从发送方进程拷贝到内核缓存区，然后再将数据从内核缓存区拷贝到接收方进程，通过两次拷贝来实现吗？显然不是，否则也不会有开篇所说的 Binder 在性能方面的优势了。\n\n这就不得不通道 Linux 下的另一个概念：**内存映射**。\n\nBinder IPC 机制中涉及到的内存映射通过 mmap() 来实现，mmap() 是操作系统中一种内存映射的方法。内存映射简单的讲就是将用户空间的一块内存区域映射到内核空间。映射关系建立后，用户对这块内存区域的修改可以直接反应到内核空间；反之内核空间对这段区域的修改也能直接反应到用户空间。\n\n内存映射能减少数据拷贝次数，实现用户空间和内核空间的高效互动。两个空间各自的修改能直接反映在映射的内存区域，从而被对方空间及时感知。也正因为如此，内存映射能够提供对进程间通信的支持。\n\n\n\n### Binder IPC实现原理\n\nBinder IPC 正是基于内存映射（mmap）来实现的，但是 mmap() 通常是用在有物理介质的文件系统上的。\n\n比如进程中的用户区域是不能直接和物理设备打交道的，如果想要把磁盘上的数据读取到进程的用户区域，需要两次拷贝（磁盘-->内核空间-->用户空间）；通常在这种场景下 mmap() 就能发挥作用，通过在物理介质和用户空间之间建立映射，减少数据的拷贝次数，用内存读写取代I/O读写，提高文件读取效率。\n\n而 Binder 并不存在物理介质，因此 Binder 驱动使用 mmap() 并不是为了在物理介质和用户空间之间建立映射，而是用来在内核空间创建数据接收的缓存空间。\n\n一次完整的 Binder IPC 通信过程通常是这样：\n\n1. 首先 Binder 驱动在内核空间创建一个数据接收缓存区；\n2. 接着在内核空间开辟一块内核缓存区，建立**内核缓存区**和**内核中数据接收缓存区**之间的映射关系，以及**内核中数据接收缓存区**和**接收进程用户空间地址**的映射关系；\n3. 发送方进程通过系统调用 copy*from*user() 将数据 copy 到内核中的**内核缓存区**，由于内核缓存区和接收进程的用户空间存在内存映射，因此也就相当于把数据发送到了接收进程的用户空间，这样便完成了一次进程间的通信。\n\n如下图：\n\n![binder](/images/binder.jpg)\n\n注意图中两个红色虚线。我们从图中可以看到，内核空间开辟了两个缓存区——**内核缓存区**和**数据接收缓存区**，这两个缓存区之间存在内存映射，然后**数据接收缓存区**与**数据接收进程的用户空间缓存区**同样有内存映射。当数据发送进程通过`copy_from_user()`将数据拷贝到**内核缓存区**的时候，存在映射关系的数据接收进程用户空间缓存区也就收到了数据。\n\n\n\n## Binder通信模型\n\n跨进程通讯至少包含两个进程，我们将数据发送进程称为**Client**，把数据接收方称为**Server**。\n\n### Client/Server/ServiceManager/驱动\n\n前面我们介绍过，Binder 是基于 C/S 架构的。由一系列的组件组成，包括 Client、Server、ServiceManager、Binder 驱动。其中 Client、Server、Service Manager 运行在用户空间，Binder 驱动运行在内核空间。其中 Service Manager 和 Binder 驱动由系统提供，而 Client、Server 由应用程序来实现。Client、Server 和 ServiceManager 均是通过系统调用 open、mmap 和 ioctl 来访问设备文件 /dev/binder，从而实现与 Binder 驱动的交互来间接的实现跨进程通信。\n\n![img](/images/android_binder.jpg)\n\n[Android Binder 设计与实现](https://link.zhihu.com/?target=http%3A//blog.csdn.net/universus/article/details/6211589)*一文中对 Client、Server、ServiceManager、Binder 驱动有很详细的描述，以下是部分摘录：*\n\n> **Binder 驱动**\n> Binder 驱动就如同路由器一样，是整个通信的核心；驱动负责进程之间 Binder 通信的建立，Binder 在进程之间的传递，Binder 引用计数管理，数据包在进程之间的传递和交互等一系列底层支持。\n>\n> **ServiceManager 与实名 Binder**\n> ServiceManager 和 DNS 类似，作用是将字符形式的 Binder 名字转化成 Client 中对该 Binder 的引用，使得 Client 能够通过 Binder 的名字获得对 Binder 实体的引用。注册了名字的 Binder 叫实名 Binder，就像网站一样除了除了有 IP 地址意外还有自己的网址。Server 创建了 Binder，并为它起一个字符形式，可读易记得名字，将这个 Binder 实体连同名字一起以数据包的形式通过 Binder 驱动发送给 ServiceManager ，通知 ServiceManager 注册一个名为“张三”的 Binder，它位于某个 Server 中。驱动为这个穿越进程边界的 Binder 创建位于内核中的实体节点以及 ServiceManager 对实体的引用，将名字以及新建的引用打包传给 ServiceManager。ServiceManger 收到数据后从中取出名字和引用填入查找表。\n>\n> 细心的读者可能会发现，ServierManager 是一个进程，Server 是另一个进程，Server 向 ServiceManager 中注册 Binder 必然涉及到进程间通信。当前实现进程间通信又要用到进程间通信，这就好像蛋可以孵出鸡的前提却是要先找只鸡下蛋！Binder 的实现比较巧妙，就是预先创造一只鸡来下蛋。ServiceManager 和其他进程同样采用 Bidner 通信，ServiceManager 是 Server 端，有自己的 Binder 实体，其他进程都是 Client，需要通过这个 Binder 的引用来实现 Binder 的注册，查询和获取。ServiceManager 提供的 Binder 比较特殊，它没有名字也不需要注册。当一个进程使用 BINDER*SET*CONTEXT_MGR 命令将自己注册成 ServiceManager 时 Binder 驱动会自动为它创建 Binder 实体（**这就是那只预先造好的那只鸡**）。其次这个 Binder 实体的引用在所有 Client 中都固定为 0 而无需通过其它手段获得。也就是说，一个 Server 想要向 ServiceManager 注册自己的 Binder 就必须通过这个 0 号引用和 ServiceManager 的 Binder 通信。类比互联网，0 号引用就好比是域名服务器的地址，你必须预先动态或者手工配置好。要注意的是，这里说的 Client 是相对于 ServiceManager 而言的，一个进程或者应用程序可能是提供服务的 Server，但对于 ServiceManager 来说它仍然是个 Client。\n>\n> **Client 获得实名 Binder 的引用**\n> Server 向 ServiceManager 中注册了 Binder 以后， Client 就能通过名字获得 Binder 的引用了。Client 也利用保留的 0 号引用向 ServiceManager 请求访问某个 Binder: 我申请访问名字叫张三的 Binder 引用。ServiceManager 收到这个请求后从请求数据包中取出 Binder 名称，在查找表里找到对应的条目，取出对应的 Binder 引用作为回复发送给发起请求的 Client。从面向对象的角度看，Server 中的 Binder 实体现在有两个引用：一个位于 ServiceManager 中，一个位于发起请求的 Client 中。如果接下来有更多的 Client 请求该 Binder，系统中就会有更多的引用指向该 Binder ，就像 Java 中一个对象有多个引用一样。\n\n\n\n### Binder通信过程\n\n至此，我们大致能总结出 Binder 通信过程：\n\n1. 首先，一个进程使用 BINDER*SET*CONTEXT_MGR 命令通过 Binder 驱动将自己注册成为 ServiceManager；\n2. Server 通过驱动向 ServiceManager 中注册 Binder（Server 中的 Binder 实体），表明可以对外提供服务。驱动为这个 Binder 创建位于内核中的实体节点以及 ServiceManager 对实体的引用，将名字以及新建的引用打包传给 ServiceManager，ServiceManger 将其填入查找表。\n3. Client 通过名字，在 Binder 驱动的帮助下从 ServiceManager 中获取到对 Binder 实体的引用，通过这个引用就能实现和 Server 进程的通信。\n\n我们看到整个通信过程都需要 Binder 驱动的接入。下图能更加直观的展现整个通信过程(为了进一步抽象通信过程以及呈现上的方便，下图我们忽略了 Binder 实体及其引用的概念)：\n\n![img](/images/client_server_service_manager.jpg)\n\n\n\n### Binder 通信中的代理模式\n\n我们已经解释清楚 Client、Server 借助 Binder 驱动完成跨进程通信的实现机制了，但是还有个问题会让我们困惑。A 进程想要 B 进程中某个对象（object）是如何实现的呢？毕竟它们分属不同的进程，A 进程 没法直接使用 B 进程中的 object。\n\n前面我们介绍过跨进程通信的过程都有 Binder 驱动的参与，因此在数据流经 Binder 驱动的时候驱动会对数据做一层转换。当 A 进程想要获取 B 进程中的 object 时，驱动并不会真的把 object 返回给 A，而是返回了一个跟 object 看起来一模一样的代理对象 objectProxy，这个 objectProxy 具有和 object 一摸一样的方法，但是这些方法并没有 B 进程中 object 对象那些方法的能力，这些方法只需要把把请求参数交给驱动即可。对于 A 进程来说和直接调用 object 中的方法是一样的。\n\n当 Binder 驱动接收到 A 进程的消息后，发现这是个 objectProxy 就去查询自己维护的表单，一查发现这是 B 进程 object 的代理对象。于是就会去通知 B 进程调用 object 的方法，并要求 B 进程把返回结果发给自己。当驱动拿到 B 进程的返回结果后就会转发给 A 进程，一次通信就完成了。\n\n![img](/images/binder_data_trans.jpg)\n\n\n\n### Binder的完整定义\n\n现在我们可以对 Binder 做个更加全面的定义了：\n\n- 从进程间通信的角度看，Binder 是一种进程间通信的机制；\n- 从 Server 进程的角度看，Binder 指的是 Server 中的 Binder 实体对象；\n- 从 Client 进程的角度看，Binder 指的是对 Binder 代理对象，是 Binder 实体对象的一个远程代理\n- 从传输过程的角度看，Binder 是一个可以跨进程传输的对象；Binder 驱动会对这个跨越进程边界的对象对一点点特殊处理，自动完成代理对象和本地对象之间的转换。\n\n\n\n## 实现Binder跨进程通信\n\n一般Android上，使用**AIDL(Android Interface Definition Language)**来实现跨进程通信协议。AIDL主要是对接口进行描述的，包括定义Server为Client提供那些操作服务。通过AIDL文件，Android Studio在编译时候，会自动产生接口类以及代理类。\n\n除了通过AIDL的方式，我们还可以自己手动编写接口类和代理类。\n\n代码请参考[TheBinder](https://github.com/boybeak/TheBinder)，这里展示了两种方式实现Binder IPC。\n\n代码中涉及到了一些Java类。\n\n- **IBinder** : IBinder 是一个接口，代表了一种跨进程通信的能力。只要实现了这个借口，这个对象就能跨进程传输。\n- **IInterface** : IInterface 代表的就是 Server 进程对象具备什么样的能力（能提供哪些方法，其实对应的就是 AIDL 文件中定义的接口）\n- **Binder** : Java 层的 Binder 类，代表的其实就是 Binder 本地对象。BinderProxy 类是 Binder 类的一个内部类，它代表远程进程的 Binder 对象的本地代理；这两个类都继承自 IBinder, 因而都具有跨进程传输的能力；实际上，在跨越进程的时候，Binder 驱动会自动完成这两个对象的转换。\n- **Stub** : AIDL 的时候，编译工具会给我们生成一个名为 Stub 的静态内部类；这个类继承了 Binder, 说明它是一个 Binder 本地对象，它实现了 IInterface 接口，表明它具有 Server 承诺给 Client 的能力；Stub 是一个抽象类，具体的 IInterface 的相关实现需要开发者自己实现。\n\n\n\n## 自己实现\n\n代码请参考[TheBinder](https://github.com/boybeak/TheBinder)\n\n代码中有两个module: **withAIDL**和**noAIDL**，分别演示了使用AIDL的方式和不使用ADIL的方式进行Binder IPC。\n\n**NoAIDL**相比**WithAIDL**有一个优点，就是可以在对应的`IInterface`文件中，添加一些自定义的代码，比如添加log代码；由于AIDL的方式是自动生成的代码，所以这些自定义代码是没法添加到对应的`IInterface`文件中。\n\n我们重点关注**noAIDL**\n\n```kotlin\n//INoAIDL.kt\ninterface INoAIDL : IInterface {\n  fun sayHi(name: String)\n  fun showObjN(objN: ObjN): ObjN?\n\n  companion object {\n    private val TAG = INoAIDL::class.java.simpleName\n    private val DESCRIPTOR = INoAIDL::class.java.name\n\n    abstract class Stub : Binder(), INoAIDL {...}\n    class Proxy(private val remote: IBinder) : INoAIDL {...}\n  }\n}\n```\n\n`INoAIDL.kt`文件的大体结构如上代码，我们可以看到，在这个`IInterface`类中：\n\n- 定义两个Server端承诺的服务——`sayHi`和`showObjN`；\n- 两个静态类——一个Stub类和一个Proxy类。\n\n**Stub类**\n\n```kotlin\nabstract class Stub : Binder(), INoAIDL {\n\n  companion object {\n    const val TRANSACTION_sayHi = IBinder.FIRST_CALL_TRANSACTION + 0\n    const val TRANSACTION_showObjN = IBinder.FIRST_CALL_TRANSACTION + 1\n\n    fun asInterface(binder: IBinder?): INoAIDL? {\n      if (binder == null) {\n        return null\n      }\n      val iin = binder.queryLocalInterface(DESCRIPTOR)\n      if (iin != null && iin is INoAIDL) {\n        Log.v(TAG, \"Client and Server in the same Process\")\n        return iin\n      }\n      Log.v(TAG, \"Client and Server in different Processes\")\n      return Proxy(binder)\n    }\n  }\n\n  init {\n    attachInterface(this, DESCRIPTOR)\n  }\n\n  final override fun attachInterface(owner: IInterface?, descriptor: String?) {\n    super.attachInterface(owner, descriptor)\n  }\n\n  override fun onTransact(code: Int, data: Parcel, reply: Parcel?, flags: Int): Boolean {\n    val descriptor = DESCRIPTOR\n    return when(code) {\n      INTERFACE_TRANSACTION -> {\n        reply?.writeString(descriptor)\n        true\n      }\n      TRANSACTION_sayHi -> {\n        data.enforceInterface(descriptor)\n        val name = data.readString() ?: \"\"\n        sayHi(name)\n        reply?.writeNoException()\n        true\n      }\n      TRANSACTION_showObjN -> {\n        data.enforceInterface(descriptor)\n        var objN: ObjN? = null\n        if (0 != data.readInt()) {\n          objN = ObjN.CREATOR.createFromParcel(data)\n        }\n        val _result = showObjN(objN!!)\n        reply?.writeNoException()\n        if (_result != null) {\n          reply?.writeInt(1)\n          _result.writeToParcel(reply, Parcelable.PARCELABLE_WRITE_RETURN_VALUE)\n        } else {\n          reply?.writeInt(0)\n        }\n        true\n      }\n      else -> {\n        super.onTransact(code, data, reply, flags)\n      }\n    }\n  }\n\n  override fun asBinder(): IBinder {\n    return this\n  }\n}\n```\n\n在Manifest文件中我们定义对应Service\n\n```xml\n<service\n  android:name=\".NoAIDLService\"\n  android:enabled=\"true\"\n  android:exported=\"true\"\n  />\n  <!--android:process=\":noAIDL\"-->\n\t<!--把上述属性设置到service中，则是在不同进程中运行-->\n```\n\n我们重点关注`asInterface`方法，在这个方法中，有一个代码片段：\n\n```kotlin\nval iin = binder.queryLocalInterface(DESCRIPTOR)\nif (iin != null && iin is INoAIDL) {\n\tLog.v(TAG, \"Client and Server in the same Process\")\n  return iin\n}\nLog.v(TAG, \"Client and Server in different Processes\")\nreturn Proxy(binder)\n```\n\n通过这样的代码来进行Client和Server是否在不同进程的判断。\n\n- 相同进程：返回`queryLocalInterface`出来的对象，这个对象是在`Stub`构造方法中通过`attachInterface`方法传入的。\n- 不同进程：构造一个`Proxy`类返回。\n\nMainActivity去bind一个Service，Service返回一个Binder。我们打印一下日志。\n\n```kotlin\nclass NoAIDLService : Service() {\n  override fun onBind(intent: Intent): IBinder {\n    return binder.also {\n      Log.v(TAG, \"onBind=$it\")\n    }\n  }\n}\n```\n\n```kotlin\nprivate var noAIDL: INoAIDL? = null\nprivate val noConnection = object : ServiceConnection {\n  override fun onServiceConnected(name: ComponentName?, service: IBinder?) {\n    service ?: return\n    Log.v(TAG, \"onServiceConnected service=$service\")\n    noAIDL = INoAIDL.Companion.Stub.asInterface(service)\n    Toast.makeText(this@MainActivity, \"connected to NoAIDLService\", Toast.LENGTH_SHORT).show()\n    Log.v(TAG, \"onServiceConnected noAIDL=${noAIDL}\")\n  }\n}\n\n```\n\n当Client与Server在相同进程，有如下日志：\n\n```\n// NoAIDLService\nonBind=com.github.boybeak.noaidl.NoAIDLService$binder$1@84abbdc\n\n// MainActivity\nonServiceConnected service=com.github.boybeak.noaidl.NoAIDLService$binder$1@84abbdc\nnoAIDL=com.github.boybeak.noaidl.NoAIDLService$binder$1@84abbdc\n```\n\n当Client与Server在不同进程，有如下日志：\n\n```\n// NoAIDLService\nonBind=com.github.boybeak.noaidl.NoAIDLService$binder$1@2d32060\n\n// MainActivity\nonServiceConnected service=android.os.BinderProxy@99b42f6\nnoAIDL=com.github.boybeak.noaidl.INoAIDL$Companion$Proxy@67e8964\n```\n\n我们看到，当Client与Server在相同进程时候，Service的`onBind`方法返回的是什么，MainActivity接收到的就是什么；而当Client与Server在不同进程的时候，则返回的是Binder驱动传递给我们的对象，通过这个对象，我们创造一个 Proxy代理对象。\n\n\n\n我们接下来重点关注`showObjN`方法。\n\n```kotlin\nprivate val binder = object : INoAIDL.Companion.Stub() {\n  override fun showObjN(objN: ObjN): ObjN? {\n    Log.v(TAG, \"showObjN objN=$objN\")\n    return objN\n  }\n}\n```\n\n这个方法中，直接返回传入的参数。\n\n调用的地方这样来写：\n\n```kotlin\nfun showObjN(v: View) {\n  if (noAIDL == null) {\n    Toast.makeText(this, \"Click NOAIDL button first\", Toast.LENGTH_SHORT).show()\n    return\n  }\n  val objN = ObjN()\n  Log.v(TAG, \"showObjN objN=$objN\")\n  val returnObjN = noAIDL?.showObjN(objN)\n  Log.v(TAG, \"showObjN returnObjW=$returnObjN\")\n}\n```\n\n我们来看打印的`objN`日志。\n\n**相同进程情况下：**\n\n```\n// Client进程\ncom.github.boybeak.binder V/MainActivity: showObjN objN=com.github.boybeak.noaidl.ObjN@4c7d499\ncom.github.boybeak.binder V/MainActivity: showObjN returnObjW=com.github.boybeak.noaidl.ObjN@4c7d499\n\n// Server进程\ncom.github.boybeak.binder V/NoAIDLService: showObjN objN=com.github.boybeak.noaidl.ObjN@4c7d499\n```\n\n\n\n**不同进程情况下：**\n\n```\n// Client进程\ncom.github.boybeak.binder V/MainActivity: showObjN objN=com.github.boybeak.noaidl.ObjN@5ab3a61\ncom.github.boybeak.binder V/MainActivity: showObjN returnObjW=com.github.boybeak.noaidl.ObjN@db79986\n\n// Server进程\ncom.github.boybeak.binder V/NoAIDLService: showObjN objN=com.github.boybeak.noaidl.ObjN@1c5381d\n```\n\n\n\n我们可以看到，在相同进程情况下，就是普通的函数调用；在不同进程情况下，Client传入的参数，Server接收到的参数，Client接收到的返回结果，全是不同的对象，这是因为，通过Proxy对象，在跨进程通信时候，将Parcelable对象进行了序列化和反序列化。\n\n\n\n本文是在阅读[**写给 Android 应用工程师的 Binder 原理剖析**](https://zhuanlan.zhihu.com/p/35519585)一文后，加上自己的理解与实验完成，其中部分段落直接复制了原文，因为我觉得，那部分原文已经足够容易理解且没有冗余的文字，感谢原作者[**张磊**](https://www.zhihu.com/people/BaronZ88)，同时附上原文参考资料：\n\n- [Android Binder 设计与实现 - 设计篇](https://link.zhihu.com/?target=http%3A//blog.csdn.net/universus/article/details/6211589)\n- [Android 进程间通信（IPC）机制 Binder 简要介绍和学习计划](https://link.zhihu.com/?target=http%3A//blog.csdn.net/luoshengyang/article/details/6618363)、[《Android 系统源代码情景分析》](https://link.zhihu.com/?target=http%3A//item.jd.com/12248208.html)\n- [Binder 学习指南](https://link.zhihu.com/?target=http%3A//weishu.me/2016/01/12/binder-index-for-newer/)\n- [Binder 系列文章](https://link.zhihu.com/?target=http%3A//gityuan.com/2015/10/31/binder-prepare/)\n- [Android 图文详解 Binder 跨进程通信原理](https://link.zhihu.com/?target=https%3A//blog.csdn.net/carson_ho/article/details/73560642)\n- [Android 深入浅出之 Binder 机制](https://link.zhihu.com/?target=http%3A//www.cnblogs.com/innost/archive/2011/01/09/1931456.html)\n- [用户空间与内核空间](https://link.zhihu.com/?target=http%3A//www.cnblogs.com/Anker/p/3269106.html)\n- [认真分析 mmap ：是什么 为什么 怎么用](https://link.zhihu.com/?target=https%3A//www.cnblogs.com/huxiao-tee/p/4660352.html)\n\n","source":"_posts/2022-09-19-Binder机制分析.md","raw":"---\nlayout: post\ntitle: Binder机制分析\nauthor: boybeak\ncategory: Android技巧\ntags: Android\ndate: 2022-09-19 05:00:00\n---\n\n\n参考文章：[写给 Android 应用工程师的 Binder 原理剖析](https://zhuanlan.zhihu.com/p/35519585)\n\n实验代码：[TheBinder](https://github.com/boybeak/TheBinder)\n\nBinder机制可以说是Android的核心。提到Binder，可能会让你想到，通过bindService与`Service`进行通信(也可能是跨进程的通信)，实际上，Android中Binder的使用可以说是无处不在的，包括Activity跳转，详情可以参考[AMS启动流程](https://boybeak.github.io/android/AMS%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.html)。\n\n## 为什么要用Binder?\n\n在Linux系统中，跨进程通信(IPC)方式有很多种，包括Socket、管道、共享内存等。可以Android为何最后选择Binder作为核心的跨进程通信的手段呢？\n\n这需要从两方面去分析——**性能**和**安全性**。\n\n### 1. 性能\n\n首先说说性能上的优势。Socket 作为一款通用接口，其传输效率低，开销大，主要用在跨网络的进程间通信和本机上进程间的低速通信。消息队列和管道采用存储-转发方式，即数据先从发送方缓存区拷贝到内核开辟的缓存区中，然后再从内核缓存区拷贝到接收方缓存区，至少有两次拷贝过程。共享内存虽然无需拷贝，但控制复杂，难以使用。Binder 只需要一次数据拷贝，性能上仅次于共享内存。\n\n### 2. 安全性\n\n另一方面就是安全性。Android 作为一个开放性的平台，市场上有各类海量的应用供用户选择安装，因此安全性对于 Android 平台而言极其重要。作为用户当然不希望我们下载的 APP 偷偷读取我的通信录，上传我的隐私数据，后台偷跑流量、消耗手机电量。传统的 IPC 没有任何安全措施，完全依赖上层协议来确保。首先传统的 IPC 接收方无法获得对方可靠的进程用户ID/进程ID（UID/PID），从而无法鉴别对方身份。Android 为每个安装好的 APP 分配了自己的 UID，故而进程的 UID 是鉴别进程身份的重要标志。传统的 IPC 只能由用户在数据包中填入 UID/PID，但这样不可靠，容易被恶意程序利用。可靠的身份标识只有由 IPC 机制在内核中添加。其次传统的 IPC 访问接入点是开放的，只要知道这些接入点的程序都可以和对端建立连接，不管怎样都无法阻止恶意程序通过猜测接收方地址获得连接。同时 Binder 既支持实名 Binder，又支持匿名 Binder，安全性高。\n\n基于上述原因，Android 需要建立一套新的 IPC 机制来满足系统对稳定性、传输性能和安全性方面的要求，这就是 Binder。\n\n用一张表格来总结与对比各种IPC方式。\n\n| IPC方式              | 性能(内存拷贝次数) | 安全性                             |\n| -------------------- | ------------------ | ---------------------------------- |\n| Binder               | 1                  | 通过UID/PID来保证                  |\n| 共享内存             | 0                  | 操作非常复杂，难以保证             |\n| Socket/管道/消息队列 | 2                  | 依靠上层协议做身份识别，非常不可靠 |\n\n\n\n\n\n## 传统IPC是什么样的？\n\n先要了解一些基本概念——**进程隔离**、**用户空间**、**内核空间**、**用户态**、**内核态**。\n\n![IPC](/images/traditional_ipc.jpg)\n\n上图展示了 Liunx 中跨进程通信涉及到的一些基本概念：\n\n- 进程隔离\n- 进程空间划分：用户空间(User Space)/内核空间(Kernel Space)\n- 系统调用：用户态/内核态\n\n\n\n### 进程隔离\n\n顾名思义，就是进程之间内存是不共享的。进程间要进行数据交换，就得采用**进程间通信(IPC)**机制。\n\n\n\n### 进程空间划分：用户空间(User Space)/内核空间(Kernel Space)\n\n现在操作系统都是采用的虚拟存储器，对于 32 位系统而言，它的寻址空间（虚拟存储空间）就是 2 的 32 次方，也就是 4GB。操作系统的核心是内核，独立于普通的应用程序，可以访问受保护的内存空间，也可以访问底层硬件设备的权限。为了保护用户进程不能直接操作内核，保证内核的安全，操作系统从逻辑上将虚拟空间划分为用户空间（User Space）和内核空间（Kernel Space）。针对 Linux 操作系统而言，将最高的 1GB 字节供内核使用，称为内核空间；较低的 3GB 字节供各进程使用，称为用户空间。\n\n> 简单的说就是，内核空间（Kernel）是系统内核运行的空间，用户空间（User Space）是用户程序运行的空间。为了保证安全性，它们之间是隔离的。\n\n![linux memory](/images/linux_memory.png)\n\n\n\n### 系统调用：用户态/内核态\n\n虽然从逻辑上进行了用户空间和内核空间的划分，但不可避免的用户空间需要访问内核资源，比如文件操作、访问网络等等。为了突破隔离限制，就需要借助**系统调用**来实现。系统调用是用户空间访问内核空间的唯一方式，保证了所有的资源访问都是在内核的控制下进行的，避免了用户程序对系统资源的越权访问，提升了系统安全性和稳定性。\n\nLinux 使用两级保护机制：0 级供系统内核使用，3 级供用户程序使用。\n\n当一个任务（进程）执行系统调用而陷入内核代码中执行时，称进程处于**内核运行态（内核态）**。此时处理器处于特权级最高的（0级）内核代码中执行。当进程处于内核态时，执行的内核代码会使用当前进程的内核栈。每个进程都有自己的内核栈。\n\n当进程在执行用户自己的代码的时候，我们称其处于**用户运行态（用户态）**。此时处理器在特权级最低的（3级）用户代码中运行。\n\n系统调用主要通过如下两个函数来实现：\n\n```\ncopy_from_user() //将数据从用户空间拷贝到内核空间\ncopy_to_user() //将数据从内核空间拷贝到用户空间\n```\n\n\n\n### Linux下传统IPC通信\n\n![linux ipc](/images/linux_ipc.jpg)\n\n**数据发送进程**：开辟用户空间缓存区 -> 系统调用，进入内核态 -> 开辟内核空间缓存区 ->通过`copy_from_user()`将数据拷贝到内核空间缓存区。\n\n**数据接收进程**：开辟用户空间缓存区 -> 调用`copytouser()`将数据从内核缓存区拷贝到用户空间缓存区。\n\n这样，两个进程就完成了依次进程间通信。\n\n这种传统的 IPC 通信方式有两个问题：\n\n1. 性能低下，一次数据传递需要经历：内存缓存区 --> 内核缓存区 --> 内存缓存区，需要 2 次数据拷贝；\n2. 接收数据的缓存区由数据接收进程提供，但是接收进程并不知道需要多大的空间来存放将要传递过来的数据，因此只能开辟尽可能大的内存空间或者先调用 API 接收消息头来获取消息体的大小，这两种做法不是浪费空间就是浪费时间。\n\n\n\n## Binder跨进程通信原理\n\n正如前面所说，跨进程通信是需要内核空间做支持的。传统的 IPC 机制如管道、Socket 都是内核的一部分，因此通过内核支持来实现进程间通信自然是没问题的。但是 Binder 并不是 Linux 系统内核的一部分，那怎么办呢？这就得益于 Linux 的**动态内核可加载模块**（Loadable Kernel Module，LKM）的机制；模块是具有独立功能的程序，它可以被单独编译，但是不能独立运行。它在运行时被链接到内核作为内核的一部分运行。这样，Android 系统就可以通过动态添加一个内核模块运行在内核空间，用户进程之间通过这个内核模块作为桥梁来实现通信。\n\n> 在 Android 系统中，这个运行在内核空间，负责各个用户进程通过 Binder 实现通信的内核模块就叫 **Binder 驱动**（Binder Dirver）。\n\n那么在 Android 系统中用户进程之间是如何通过这个内核模块（Binder 驱动）来实现通信的呢？难道是和前面说的传统 IPC 机制一样，先将数据从发送方进程拷贝到内核缓存区，然后再将数据从内核缓存区拷贝到接收方进程，通过两次拷贝来实现吗？显然不是，否则也不会有开篇所说的 Binder 在性能方面的优势了。\n\n这就不得不通道 Linux 下的另一个概念：**内存映射**。\n\nBinder IPC 机制中涉及到的内存映射通过 mmap() 来实现，mmap() 是操作系统中一种内存映射的方法。内存映射简单的讲就是将用户空间的一块内存区域映射到内核空间。映射关系建立后，用户对这块内存区域的修改可以直接反应到内核空间；反之内核空间对这段区域的修改也能直接反应到用户空间。\n\n内存映射能减少数据拷贝次数，实现用户空间和内核空间的高效互动。两个空间各自的修改能直接反映在映射的内存区域，从而被对方空间及时感知。也正因为如此，内存映射能够提供对进程间通信的支持。\n\n\n\n### Binder IPC实现原理\n\nBinder IPC 正是基于内存映射（mmap）来实现的，但是 mmap() 通常是用在有物理介质的文件系统上的。\n\n比如进程中的用户区域是不能直接和物理设备打交道的，如果想要把磁盘上的数据读取到进程的用户区域，需要两次拷贝（磁盘-->内核空间-->用户空间）；通常在这种场景下 mmap() 就能发挥作用，通过在物理介质和用户空间之间建立映射，减少数据的拷贝次数，用内存读写取代I/O读写，提高文件读取效率。\n\n而 Binder 并不存在物理介质，因此 Binder 驱动使用 mmap() 并不是为了在物理介质和用户空间之间建立映射，而是用来在内核空间创建数据接收的缓存空间。\n\n一次完整的 Binder IPC 通信过程通常是这样：\n\n1. 首先 Binder 驱动在内核空间创建一个数据接收缓存区；\n2. 接着在内核空间开辟一块内核缓存区，建立**内核缓存区**和**内核中数据接收缓存区**之间的映射关系，以及**内核中数据接收缓存区**和**接收进程用户空间地址**的映射关系；\n3. 发送方进程通过系统调用 copy*from*user() 将数据 copy 到内核中的**内核缓存区**，由于内核缓存区和接收进程的用户空间存在内存映射，因此也就相当于把数据发送到了接收进程的用户空间，这样便完成了一次进程间的通信。\n\n如下图：\n\n![binder](/images/binder.jpg)\n\n注意图中两个红色虚线。我们从图中可以看到，内核空间开辟了两个缓存区——**内核缓存区**和**数据接收缓存区**，这两个缓存区之间存在内存映射，然后**数据接收缓存区**与**数据接收进程的用户空间缓存区**同样有内存映射。当数据发送进程通过`copy_from_user()`将数据拷贝到**内核缓存区**的时候，存在映射关系的数据接收进程用户空间缓存区也就收到了数据。\n\n\n\n## Binder通信模型\n\n跨进程通讯至少包含两个进程，我们将数据发送进程称为**Client**，把数据接收方称为**Server**。\n\n### Client/Server/ServiceManager/驱动\n\n前面我们介绍过，Binder 是基于 C/S 架构的。由一系列的组件组成，包括 Client、Server、ServiceManager、Binder 驱动。其中 Client、Server、Service Manager 运行在用户空间，Binder 驱动运行在内核空间。其中 Service Manager 和 Binder 驱动由系统提供，而 Client、Server 由应用程序来实现。Client、Server 和 ServiceManager 均是通过系统调用 open、mmap 和 ioctl 来访问设备文件 /dev/binder，从而实现与 Binder 驱动的交互来间接的实现跨进程通信。\n\n![img](/images/android_binder.jpg)\n\n[Android Binder 设计与实现](https://link.zhihu.com/?target=http%3A//blog.csdn.net/universus/article/details/6211589)*一文中对 Client、Server、ServiceManager、Binder 驱动有很详细的描述，以下是部分摘录：*\n\n> **Binder 驱动**\n> Binder 驱动就如同路由器一样，是整个通信的核心；驱动负责进程之间 Binder 通信的建立，Binder 在进程之间的传递，Binder 引用计数管理，数据包在进程之间的传递和交互等一系列底层支持。\n>\n> **ServiceManager 与实名 Binder**\n> ServiceManager 和 DNS 类似，作用是将字符形式的 Binder 名字转化成 Client 中对该 Binder 的引用，使得 Client 能够通过 Binder 的名字获得对 Binder 实体的引用。注册了名字的 Binder 叫实名 Binder，就像网站一样除了除了有 IP 地址意外还有自己的网址。Server 创建了 Binder，并为它起一个字符形式，可读易记得名字，将这个 Binder 实体连同名字一起以数据包的形式通过 Binder 驱动发送给 ServiceManager ，通知 ServiceManager 注册一个名为“张三”的 Binder，它位于某个 Server 中。驱动为这个穿越进程边界的 Binder 创建位于内核中的实体节点以及 ServiceManager 对实体的引用，将名字以及新建的引用打包传给 ServiceManager。ServiceManger 收到数据后从中取出名字和引用填入查找表。\n>\n> 细心的读者可能会发现，ServierManager 是一个进程，Server 是另一个进程，Server 向 ServiceManager 中注册 Binder 必然涉及到进程间通信。当前实现进程间通信又要用到进程间通信，这就好像蛋可以孵出鸡的前提却是要先找只鸡下蛋！Binder 的实现比较巧妙，就是预先创造一只鸡来下蛋。ServiceManager 和其他进程同样采用 Bidner 通信，ServiceManager 是 Server 端，有自己的 Binder 实体，其他进程都是 Client，需要通过这个 Binder 的引用来实现 Binder 的注册，查询和获取。ServiceManager 提供的 Binder 比较特殊，它没有名字也不需要注册。当一个进程使用 BINDER*SET*CONTEXT_MGR 命令将自己注册成 ServiceManager 时 Binder 驱动会自动为它创建 Binder 实体（**这就是那只预先造好的那只鸡**）。其次这个 Binder 实体的引用在所有 Client 中都固定为 0 而无需通过其它手段获得。也就是说，一个 Server 想要向 ServiceManager 注册自己的 Binder 就必须通过这个 0 号引用和 ServiceManager 的 Binder 通信。类比互联网，0 号引用就好比是域名服务器的地址，你必须预先动态或者手工配置好。要注意的是，这里说的 Client 是相对于 ServiceManager 而言的，一个进程或者应用程序可能是提供服务的 Server，但对于 ServiceManager 来说它仍然是个 Client。\n>\n> **Client 获得实名 Binder 的引用**\n> Server 向 ServiceManager 中注册了 Binder 以后， Client 就能通过名字获得 Binder 的引用了。Client 也利用保留的 0 号引用向 ServiceManager 请求访问某个 Binder: 我申请访问名字叫张三的 Binder 引用。ServiceManager 收到这个请求后从请求数据包中取出 Binder 名称，在查找表里找到对应的条目，取出对应的 Binder 引用作为回复发送给发起请求的 Client。从面向对象的角度看，Server 中的 Binder 实体现在有两个引用：一个位于 ServiceManager 中，一个位于发起请求的 Client 中。如果接下来有更多的 Client 请求该 Binder，系统中就会有更多的引用指向该 Binder ，就像 Java 中一个对象有多个引用一样。\n\n\n\n### Binder通信过程\n\n至此，我们大致能总结出 Binder 通信过程：\n\n1. 首先，一个进程使用 BINDER*SET*CONTEXT_MGR 命令通过 Binder 驱动将自己注册成为 ServiceManager；\n2. Server 通过驱动向 ServiceManager 中注册 Binder（Server 中的 Binder 实体），表明可以对外提供服务。驱动为这个 Binder 创建位于内核中的实体节点以及 ServiceManager 对实体的引用，将名字以及新建的引用打包传给 ServiceManager，ServiceManger 将其填入查找表。\n3. Client 通过名字，在 Binder 驱动的帮助下从 ServiceManager 中获取到对 Binder 实体的引用，通过这个引用就能实现和 Server 进程的通信。\n\n我们看到整个通信过程都需要 Binder 驱动的接入。下图能更加直观的展现整个通信过程(为了进一步抽象通信过程以及呈现上的方便，下图我们忽略了 Binder 实体及其引用的概念)：\n\n![img](/images/client_server_service_manager.jpg)\n\n\n\n### Binder 通信中的代理模式\n\n我们已经解释清楚 Client、Server 借助 Binder 驱动完成跨进程通信的实现机制了，但是还有个问题会让我们困惑。A 进程想要 B 进程中某个对象（object）是如何实现的呢？毕竟它们分属不同的进程，A 进程 没法直接使用 B 进程中的 object。\n\n前面我们介绍过跨进程通信的过程都有 Binder 驱动的参与，因此在数据流经 Binder 驱动的时候驱动会对数据做一层转换。当 A 进程想要获取 B 进程中的 object 时，驱动并不会真的把 object 返回给 A，而是返回了一个跟 object 看起来一模一样的代理对象 objectProxy，这个 objectProxy 具有和 object 一摸一样的方法，但是这些方法并没有 B 进程中 object 对象那些方法的能力，这些方法只需要把把请求参数交给驱动即可。对于 A 进程来说和直接调用 object 中的方法是一样的。\n\n当 Binder 驱动接收到 A 进程的消息后，发现这是个 objectProxy 就去查询自己维护的表单，一查发现这是 B 进程 object 的代理对象。于是就会去通知 B 进程调用 object 的方法，并要求 B 进程把返回结果发给自己。当驱动拿到 B 进程的返回结果后就会转发给 A 进程，一次通信就完成了。\n\n![img](/images/binder_data_trans.jpg)\n\n\n\n### Binder的完整定义\n\n现在我们可以对 Binder 做个更加全面的定义了：\n\n- 从进程间通信的角度看，Binder 是一种进程间通信的机制；\n- 从 Server 进程的角度看，Binder 指的是 Server 中的 Binder 实体对象；\n- 从 Client 进程的角度看，Binder 指的是对 Binder 代理对象，是 Binder 实体对象的一个远程代理\n- 从传输过程的角度看，Binder 是一个可以跨进程传输的对象；Binder 驱动会对这个跨越进程边界的对象对一点点特殊处理，自动完成代理对象和本地对象之间的转换。\n\n\n\n## 实现Binder跨进程通信\n\n一般Android上，使用**AIDL(Android Interface Definition Language)**来实现跨进程通信协议。AIDL主要是对接口进行描述的，包括定义Server为Client提供那些操作服务。通过AIDL文件，Android Studio在编译时候，会自动产生接口类以及代理类。\n\n除了通过AIDL的方式，我们还可以自己手动编写接口类和代理类。\n\n代码请参考[TheBinder](https://github.com/boybeak/TheBinder)，这里展示了两种方式实现Binder IPC。\n\n代码中涉及到了一些Java类。\n\n- **IBinder** : IBinder 是一个接口，代表了一种跨进程通信的能力。只要实现了这个借口，这个对象就能跨进程传输。\n- **IInterface** : IInterface 代表的就是 Server 进程对象具备什么样的能力（能提供哪些方法，其实对应的就是 AIDL 文件中定义的接口）\n- **Binder** : Java 层的 Binder 类，代表的其实就是 Binder 本地对象。BinderProxy 类是 Binder 类的一个内部类，它代表远程进程的 Binder 对象的本地代理；这两个类都继承自 IBinder, 因而都具有跨进程传输的能力；实际上，在跨越进程的时候，Binder 驱动会自动完成这两个对象的转换。\n- **Stub** : AIDL 的时候，编译工具会给我们生成一个名为 Stub 的静态内部类；这个类继承了 Binder, 说明它是一个 Binder 本地对象，它实现了 IInterface 接口，表明它具有 Server 承诺给 Client 的能力；Stub 是一个抽象类，具体的 IInterface 的相关实现需要开发者自己实现。\n\n\n\n## 自己实现\n\n代码请参考[TheBinder](https://github.com/boybeak/TheBinder)\n\n代码中有两个module: **withAIDL**和**noAIDL**，分别演示了使用AIDL的方式和不使用ADIL的方式进行Binder IPC。\n\n**NoAIDL**相比**WithAIDL**有一个优点，就是可以在对应的`IInterface`文件中，添加一些自定义的代码，比如添加log代码；由于AIDL的方式是自动生成的代码，所以这些自定义代码是没法添加到对应的`IInterface`文件中。\n\n我们重点关注**noAIDL**\n\n```kotlin\n//INoAIDL.kt\ninterface INoAIDL : IInterface {\n  fun sayHi(name: String)\n  fun showObjN(objN: ObjN): ObjN?\n\n  companion object {\n    private val TAG = INoAIDL::class.java.simpleName\n    private val DESCRIPTOR = INoAIDL::class.java.name\n\n    abstract class Stub : Binder(), INoAIDL {...}\n    class Proxy(private val remote: IBinder) : INoAIDL {...}\n  }\n}\n```\n\n`INoAIDL.kt`文件的大体结构如上代码，我们可以看到，在这个`IInterface`类中：\n\n- 定义两个Server端承诺的服务——`sayHi`和`showObjN`；\n- 两个静态类——一个Stub类和一个Proxy类。\n\n**Stub类**\n\n```kotlin\nabstract class Stub : Binder(), INoAIDL {\n\n  companion object {\n    const val TRANSACTION_sayHi = IBinder.FIRST_CALL_TRANSACTION + 0\n    const val TRANSACTION_showObjN = IBinder.FIRST_CALL_TRANSACTION + 1\n\n    fun asInterface(binder: IBinder?): INoAIDL? {\n      if (binder == null) {\n        return null\n      }\n      val iin = binder.queryLocalInterface(DESCRIPTOR)\n      if (iin != null && iin is INoAIDL) {\n        Log.v(TAG, \"Client and Server in the same Process\")\n        return iin\n      }\n      Log.v(TAG, \"Client and Server in different Processes\")\n      return Proxy(binder)\n    }\n  }\n\n  init {\n    attachInterface(this, DESCRIPTOR)\n  }\n\n  final override fun attachInterface(owner: IInterface?, descriptor: String?) {\n    super.attachInterface(owner, descriptor)\n  }\n\n  override fun onTransact(code: Int, data: Parcel, reply: Parcel?, flags: Int): Boolean {\n    val descriptor = DESCRIPTOR\n    return when(code) {\n      INTERFACE_TRANSACTION -> {\n        reply?.writeString(descriptor)\n        true\n      }\n      TRANSACTION_sayHi -> {\n        data.enforceInterface(descriptor)\n        val name = data.readString() ?: \"\"\n        sayHi(name)\n        reply?.writeNoException()\n        true\n      }\n      TRANSACTION_showObjN -> {\n        data.enforceInterface(descriptor)\n        var objN: ObjN? = null\n        if (0 != data.readInt()) {\n          objN = ObjN.CREATOR.createFromParcel(data)\n        }\n        val _result = showObjN(objN!!)\n        reply?.writeNoException()\n        if (_result != null) {\n          reply?.writeInt(1)\n          _result.writeToParcel(reply, Parcelable.PARCELABLE_WRITE_RETURN_VALUE)\n        } else {\n          reply?.writeInt(0)\n        }\n        true\n      }\n      else -> {\n        super.onTransact(code, data, reply, flags)\n      }\n    }\n  }\n\n  override fun asBinder(): IBinder {\n    return this\n  }\n}\n```\n\n在Manifest文件中我们定义对应Service\n\n```xml\n<service\n  android:name=\".NoAIDLService\"\n  android:enabled=\"true\"\n  android:exported=\"true\"\n  />\n  <!--android:process=\":noAIDL\"-->\n\t<!--把上述属性设置到service中，则是在不同进程中运行-->\n```\n\n我们重点关注`asInterface`方法，在这个方法中，有一个代码片段：\n\n```kotlin\nval iin = binder.queryLocalInterface(DESCRIPTOR)\nif (iin != null && iin is INoAIDL) {\n\tLog.v(TAG, \"Client and Server in the same Process\")\n  return iin\n}\nLog.v(TAG, \"Client and Server in different Processes\")\nreturn Proxy(binder)\n```\n\n通过这样的代码来进行Client和Server是否在不同进程的判断。\n\n- 相同进程：返回`queryLocalInterface`出来的对象，这个对象是在`Stub`构造方法中通过`attachInterface`方法传入的。\n- 不同进程：构造一个`Proxy`类返回。\n\nMainActivity去bind一个Service，Service返回一个Binder。我们打印一下日志。\n\n```kotlin\nclass NoAIDLService : Service() {\n  override fun onBind(intent: Intent): IBinder {\n    return binder.also {\n      Log.v(TAG, \"onBind=$it\")\n    }\n  }\n}\n```\n\n```kotlin\nprivate var noAIDL: INoAIDL? = null\nprivate val noConnection = object : ServiceConnection {\n  override fun onServiceConnected(name: ComponentName?, service: IBinder?) {\n    service ?: return\n    Log.v(TAG, \"onServiceConnected service=$service\")\n    noAIDL = INoAIDL.Companion.Stub.asInterface(service)\n    Toast.makeText(this@MainActivity, \"connected to NoAIDLService\", Toast.LENGTH_SHORT).show()\n    Log.v(TAG, \"onServiceConnected noAIDL=${noAIDL}\")\n  }\n}\n\n```\n\n当Client与Server在相同进程，有如下日志：\n\n```\n// NoAIDLService\nonBind=com.github.boybeak.noaidl.NoAIDLService$binder$1@84abbdc\n\n// MainActivity\nonServiceConnected service=com.github.boybeak.noaidl.NoAIDLService$binder$1@84abbdc\nnoAIDL=com.github.boybeak.noaidl.NoAIDLService$binder$1@84abbdc\n```\n\n当Client与Server在不同进程，有如下日志：\n\n```\n// NoAIDLService\nonBind=com.github.boybeak.noaidl.NoAIDLService$binder$1@2d32060\n\n// MainActivity\nonServiceConnected service=android.os.BinderProxy@99b42f6\nnoAIDL=com.github.boybeak.noaidl.INoAIDL$Companion$Proxy@67e8964\n```\n\n我们看到，当Client与Server在相同进程时候，Service的`onBind`方法返回的是什么，MainActivity接收到的就是什么；而当Client与Server在不同进程的时候，则返回的是Binder驱动传递给我们的对象，通过这个对象，我们创造一个 Proxy代理对象。\n\n\n\n我们接下来重点关注`showObjN`方法。\n\n```kotlin\nprivate val binder = object : INoAIDL.Companion.Stub() {\n  override fun showObjN(objN: ObjN): ObjN? {\n    Log.v(TAG, \"showObjN objN=$objN\")\n    return objN\n  }\n}\n```\n\n这个方法中，直接返回传入的参数。\n\n调用的地方这样来写：\n\n```kotlin\nfun showObjN(v: View) {\n  if (noAIDL == null) {\n    Toast.makeText(this, \"Click NOAIDL button first\", Toast.LENGTH_SHORT).show()\n    return\n  }\n  val objN = ObjN()\n  Log.v(TAG, \"showObjN objN=$objN\")\n  val returnObjN = noAIDL?.showObjN(objN)\n  Log.v(TAG, \"showObjN returnObjW=$returnObjN\")\n}\n```\n\n我们来看打印的`objN`日志。\n\n**相同进程情况下：**\n\n```\n// Client进程\ncom.github.boybeak.binder V/MainActivity: showObjN objN=com.github.boybeak.noaidl.ObjN@4c7d499\ncom.github.boybeak.binder V/MainActivity: showObjN returnObjW=com.github.boybeak.noaidl.ObjN@4c7d499\n\n// Server进程\ncom.github.boybeak.binder V/NoAIDLService: showObjN objN=com.github.boybeak.noaidl.ObjN@4c7d499\n```\n\n\n\n**不同进程情况下：**\n\n```\n// Client进程\ncom.github.boybeak.binder V/MainActivity: showObjN objN=com.github.boybeak.noaidl.ObjN@5ab3a61\ncom.github.boybeak.binder V/MainActivity: showObjN returnObjW=com.github.boybeak.noaidl.ObjN@db79986\n\n// Server进程\ncom.github.boybeak.binder V/NoAIDLService: showObjN objN=com.github.boybeak.noaidl.ObjN@1c5381d\n```\n\n\n\n我们可以看到，在相同进程情况下，就是普通的函数调用；在不同进程情况下，Client传入的参数，Server接收到的参数，Client接收到的返回结果，全是不同的对象，这是因为，通过Proxy对象，在跨进程通信时候，将Parcelable对象进行了序列化和反序列化。\n\n\n\n本文是在阅读[**写给 Android 应用工程师的 Binder 原理剖析**](https://zhuanlan.zhihu.com/p/35519585)一文后，加上自己的理解与实验完成，其中部分段落直接复制了原文，因为我觉得，那部分原文已经足够容易理解且没有冗余的文字，感谢原作者[**张磊**](https://www.zhihu.com/people/BaronZ88)，同时附上原文参考资料：\n\n- [Android Binder 设计与实现 - 设计篇](https://link.zhihu.com/?target=http%3A//blog.csdn.net/universus/article/details/6211589)\n- [Android 进程间通信（IPC）机制 Binder 简要介绍和学习计划](https://link.zhihu.com/?target=http%3A//blog.csdn.net/luoshengyang/article/details/6618363)、[《Android 系统源代码情景分析》](https://link.zhihu.com/?target=http%3A//item.jd.com/12248208.html)\n- [Binder 学习指南](https://link.zhihu.com/?target=http%3A//weishu.me/2016/01/12/binder-index-for-newer/)\n- [Binder 系列文章](https://link.zhihu.com/?target=http%3A//gityuan.com/2015/10/31/binder-prepare/)\n- [Android 图文详解 Binder 跨进程通信原理](https://link.zhihu.com/?target=https%3A//blog.csdn.net/carson_ho/article/details/73560642)\n- [Android 深入浅出之 Binder 机制](https://link.zhihu.com/?target=http%3A//www.cnblogs.com/innost/archive/2011/01/09/1931456.html)\n- [用户空间与内核空间](https://link.zhihu.com/?target=http%3A//www.cnblogs.com/Anker/p/3269106.html)\n- [认真分析 mmap ：是什么 为什么 怎么用](https://link.zhihu.com/?target=https%3A//www.cnblogs.com/huxiao-tee/p/4660352.html)\n\n","slug":"2022-09-19-Binder机制分析","published":1,"updated":"2024-11-13T13:41:23.589Z","_id":"cm1ltr0g10015bji0bbte3rfa","comments":1,"photos":["/images/traditional_ipc.jpg","/images/linux_memory.png","/images/linux_ipc.jpg","/images/binder.jpg","/images/android_binder.jpg","/images/client_server_service_manager.jpg","/images/binder_data_trans.jpg"],"content":"<p>参考文章：<a href=\"https://zhuanlan.zhihu.com/p/35519585\">写给 Android 应用工程师的 Binder 原理剖析</a></p>\n<p>实验代码：<a href=\"https://github.com/boybeak/TheBinder\">TheBinder</a></p>\n<p>Binder机制可以说是Android的核心。提到Binder，可能会让你想到，通过bindService与<code>Service</code>进行通信(也可能是跨进程的通信)，实际上，Android中Binder的使用可以说是无处不在的，包括Activity跳转，详情可以参考<a href=\"https://boybeak.github.io/android/AMS%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.html\">AMS启动流程</a>。</p>\n<h2 id=\"为什么要用Binder\"><a href=\"#为什么要用Binder\" class=\"headerlink\" title=\"为什么要用Binder?\"></a>为什么要用Binder?</h2><p>在Linux系统中，跨进程通信(IPC)方式有很多种，包括Socket、管道、共享内存等。可以Android为何最后选择Binder作为核心的跨进程通信的手段呢？</p>\n<p>这需要从两方面去分析——<strong>性能</strong>和<strong>安全性</strong>。</p>\n<h3 id=\"1-性能\"><a href=\"#1-性能\" class=\"headerlink\" title=\"1. 性能\"></a>1. 性能</h3><p>首先说说性能上的优势。Socket 作为一款通用接口，其传输效率低，开销大，主要用在跨网络的进程间通信和本机上进程间的低速通信。消息队列和管道采用存储-转发方式，即数据先从发送方缓存区拷贝到内核开辟的缓存区中，然后再从内核缓存区拷贝到接收方缓存区，至少有两次拷贝过程。共享内存虽然无需拷贝，但控制复杂，难以使用。Binder 只需要一次数据拷贝，性能上仅次于共享内存。</p>\n<h3 id=\"2-安全性\"><a href=\"#2-安全性\" class=\"headerlink\" title=\"2. 安全性\"></a>2. 安全性</h3><p>另一方面就是安全性。Android 作为一个开放性的平台，市场上有各类海量的应用供用户选择安装，因此安全性对于 Android 平台而言极其重要。作为用户当然不希望我们下载的 APP 偷偷读取我的通信录，上传我的隐私数据，后台偷跑流量、消耗手机电量。传统的 IPC 没有任何安全措施，完全依赖上层协议来确保。首先传统的 IPC 接收方无法获得对方可靠的进程用户ID&#x2F;进程ID（UID&#x2F;PID），从而无法鉴别对方身份。Android 为每个安装好的 APP 分配了自己的 UID，故而进程的 UID 是鉴别进程身份的重要标志。传统的 IPC 只能由用户在数据包中填入 UID&#x2F;PID，但这样不可靠，容易被恶意程序利用。可靠的身份标识只有由 IPC 机制在内核中添加。其次传统的 IPC 访问接入点是开放的，只要知道这些接入点的程序都可以和对端建立连接，不管怎样都无法阻止恶意程序通过猜测接收方地址获得连接。同时 Binder 既支持实名 Binder，又支持匿名 Binder，安全性高。</p>\n<p>基于上述原因，Android 需要建立一套新的 IPC 机制来满足系统对稳定性、传输性能和安全性方面的要求，这就是 Binder。</p>\n<p>用一张表格来总结与对比各种IPC方式。</p>\n<table>\n<thead>\n<tr>\n<th>IPC方式</th>\n<th>性能(内存拷贝次数)</th>\n<th>安全性</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Binder</td>\n<td>1</td>\n<td>通过UID&#x2F;PID来保证</td>\n</tr>\n<tr>\n<td>共享内存</td>\n<td>0</td>\n<td>操作非常复杂，难以保证</td>\n</tr>\n<tr>\n<td>Socket&#x2F;管道&#x2F;消息队列</td>\n<td>2</td>\n<td>依靠上层协议做身份识别，非常不可靠</td>\n</tr>\n</tbody></table>\n<h2 id=\"传统IPC是什么样的？\"><a href=\"#传统IPC是什么样的？\" class=\"headerlink\" title=\"传统IPC是什么样的？\"></a>传统IPC是什么样的？</h2><p>先要了解一些基本概念——<strong>进程隔离</strong>、<strong>用户空间</strong>、<strong>内核空间</strong>、<strong>用户态</strong>、<strong>内核态</strong>。</p>\n<p><img src=\"/images/traditional_ipc.jpg\" alt=\"IPC\"></p>\n<p>上图展示了 Liunx 中跨进程通信涉及到的一些基本概念：</p>\n<ul>\n<li>进程隔离</li>\n<li>进程空间划分：用户空间(User Space)&#x2F;内核空间(Kernel Space)</li>\n<li>系统调用：用户态&#x2F;内核态</li>\n</ul>\n<h3 id=\"进程隔离\"><a href=\"#进程隔离\" class=\"headerlink\" title=\"进程隔离\"></a>进程隔离</h3><p>顾名思义，就是进程之间内存是不共享的。进程间要进行数据交换，就得采用**进程间通信(IPC)**机制。</p>\n<h3 id=\"进程空间划分：用户空间-User-Space-内核空间-Kernel-Space\"><a href=\"#进程空间划分：用户空间-User-Space-内核空间-Kernel-Space\" class=\"headerlink\" title=\"进程空间划分：用户空间(User Space)&#x2F;内核空间(Kernel Space)\"></a>进程空间划分：用户空间(User Space)&#x2F;内核空间(Kernel Space)</h3><p>现在操作系统都是采用的虚拟存储器，对于 32 位系统而言，它的寻址空间（虚拟存储空间）就是 2 的 32 次方，也就是 4GB。操作系统的核心是内核，独立于普通的应用程序，可以访问受保护的内存空间，也可以访问底层硬件设备的权限。为了保护用户进程不能直接操作内核，保证内核的安全，操作系统从逻辑上将虚拟空间划分为用户空间（User Space）和内核空间（Kernel Space）。针对 Linux 操作系统而言，将最高的 1GB 字节供内核使用，称为内核空间；较低的 3GB 字节供各进程使用，称为用户空间。</p>\n<blockquote>\n<p>简单的说就是，内核空间（Kernel）是系统内核运行的空间，用户空间（User Space）是用户程序运行的空间。为了保证安全性，它们之间是隔离的。</p>\n</blockquote>\n<p><img src=\"/images/linux_memory.png\" alt=\"linux memory\"></p>\n<h3 id=\"系统调用：用户态-内核态\"><a href=\"#系统调用：用户态-内核态\" class=\"headerlink\" title=\"系统调用：用户态&#x2F;内核态\"></a>系统调用：用户态&#x2F;内核态</h3><p>虽然从逻辑上进行了用户空间和内核空间的划分，但不可避免的用户空间需要访问内核资源，比如文件操作、访问网络等等。为了突破隔离限制，就需要借助<strong>系统调用</strong>来实现。系统调用是用户空间访问内核空间的唯一方式，保证了所有的资源访问都是在内核的控制下进行的，避免了用户程序对系统资源的越权访问，提升了系统安全性和稳定性。</p>\n<p>Linux 使用两级保护机制：0 级供系统内核使用，3 级供用户程序使用。</p>\n<p>当一个任务（进程）执行系统调用而陷入内核代码中执行时，称进程处于<strong>内核运行态（内核态）</strong>。此时处理器处于特权级最高的（0级）内核代码中执行。当进程处于内核态时，执行的内核代码会使用当前进程的内核栈。每个进程都有自己的内核栈。</p>\n<p>当进程在执行用户自己的代码的时候，我们称其处于<strong>用户运行态（用户态）</strong>。此时处理器在特权级最低的（3级）用户代码中运行。</p>\n<p>系统调用主要通过如下两个函数来实现：</p>\n<pre class=\"language-none\"><code class=\"language-none\">copy_from_user() &#x2F;&#x2F;将数据从用户空间拷贝到内核空间\ncopy_to_user() &#x2F;&#x2F;将数据从内核空间拷贝到用户空间</code></pre>\n\n\n\n<h3 id=\"Linux下传统IPC通信\"><a href=\"#Linux下传统IPC通信\" class=\"headerlink\" title=\"Linux下传统IPC通信\"></a>Linux下传统IPC通信</h3><p><img src=\"/images/linux_ipc.jpg\" alt=\"linux ipc\"></p>\n<p><strong>数据发送进程</strong>：开辟用户空间缓存区 -&gt; 系统调用，进入内核态 -&gt; 开辟内核空间缓存区 -&gt;通过<code>copy_from_user()</code>将数据拷贝到内核空间缓存区。</p>\n<p><strong>数据接收进程</strong>：开辟用户空间缓存区 -&gt; 调用<code>copytouser()</code>将数据从内核缓存区拷贝到用户空间缓存区。</p>\n<p>这样，两个进程就完成了依次进程间通信。</p>\n<p>这种传统的 IPC 通信方式有两个问题：</p>\n<ol>\n<li>性能低下，一次数据传递需要经历：内存缓存区 –&gt; 内核缓存区 –&gt; 内存缓存区，需要 2 次数据拷贝；</li>\n<li>接收数据的缓存区由数据接收进程提供，但是接收进程并不知道需要多大的空间来存放将要传递过来的数据，因此只能开辟尽可能大的内存空间或者先调用 API 接收消息头来获取消息体的大小，这两种做法不是浪费空间就是浪费时间。</li>\n</ol>\n<h2 id=\"Binder跨进程通信原理\"><a href=\"#Binder跨进程通信原理\" class=\"headerlink\" title=\"Binder跨进程通信原理\"></a>Binder跨进程通信原理</h2><p>正如前面所说，跨进程通信是需要内核空间做支持的。传统的 IPC 机制如管道、Socket 都是内核的一部分，因此通过内核支持来实现进程间通信自然是没问题的。但是 Binder 并不是 Linux 系统内核的一部分，那怎么办呢？这就得益于 Linux 的<strong>动态内核可加载模块</strong>（Loadable Kernel Module，LKM）的机制；模块是具有独立功能的程序，它可以被单独编译，但是不能独立运行。它在运行时被链接到内核作为内核的一部分运行。这样，Android 系统就可以通过动态添加一个内核模块运行在内核空间，用户进程之间通过这个内核模块作为桥梁来实现通信。</p>\n<blockquote>\n<p>在 Android 系统中，这个运行在内核空间，负责各个用户进程通过 Binder 实现通信的内核模块就叫 <strong>Binder 驱动</strong>（Binder Dirver）。</p>\n</blockquote>\n<p>那么在 Android 系统中用户进程之间是如何通过这个内核模块（Binder 驱动）来实现通信的呢？难道是和前面说的传统 IPC 机制一样，先将数据从发送方进程拷贝到内核缓存区，然后再将数据从内核缓存区拷贝到接收方进程，通过两次拷贝来实现吗？显然不是，否则也不会有开篇所说的 Binder 在性能方面的优势了。</p>\n<p>这就不得不通道 Linux 下的另一个概念：<strong>内存映射</strong>。</p>\n<p>Binder IPC 机制中涉及到的内存映射通过 mmap() 来实现，mmap() 是操作系统中一种内存映射的方法。内存映射简单的讲就是将用户空间的一块内存区域映射到内核空间。映射关系建立后，用户对这块内存区域的修改可以直接反应到内核空间；反之内核空间对这段区域的修改也能直接反应到用户空间。</p>\n<p>内存映射能减少数据拷贝次数，实现用户空间和内核空间的高效互动。两个空间各自的修改能直接反映在映射的内存区域，从而被对方空间及时感知。也正因为如此，内存映射能够提供对进程间通信的支持。</p>\n<h3 id=\"Binder-IPC实现原理\"><a href=\"#Binder-IPC实现原理\" class=\"headerlink\" title=\"Binder IPC实现原理\"></a>Binder IPC实现原理</h3><p>Binder IPC 正是基于内存映射（mmap）来实现的，但是 mmap() 通常是用在有物理介质的文件系统上的。</p>\n<p>比如进程中的用户区域是不能直接和物理设备打交道的，如果想要把磁盘上的数据读取到进程的用户区域，需要两次拷贝（磁盘–&gt;内核空间–&gt;用户空间）；通常在这种场景下 mmap() 就能发挥作用，通过在物理介质和用户空间之间建立映射，减少数据的拷贝次数，用内存读写取代I&#x2F;O读写，提高文件读取效率。</p>\n<p>而 Binder 并不存在物理介质，因此 Binder 驱动使用 mmap() 并不是为了在物理介质和用户空间之间建立映射，而是用来在内核空间创建数据接收的缓存空间。</p>\n<p>一次完整的 Binder IPC 通信过程通常是这样：</p>\n<ol>\n<li>首先 Binder 驱动在内核空间创建一个数据接收缓存区；</li>\n<li>接着在内核空间开辟一块内核缓存区，建立<strong>内核缓存区</strong>和<strong>内核中数据接收缓存区</strong>之间的映射关系，以及<strong>内核中数据接收缓存区</strong>和<strong>接收进程用户空间地址</strong>的映射关系；</li>\n<li>发送方进程通过系统调用 copy<em>from</em>user() 将数据 copy 到内核中的<strong>内核缓存区</strong>，由于内核缓存区和接收进程的用户空间存在内存映射，因此也就相当于把数据发送到了接收进程的用户空间，这样便完成了一次进程间的通信。</li>\n</ol>\n<p>如下图：</p>\n<p><img src=\"/images/binder.jpg\" alt=\"binder\"></p>\n<p>注意图中两个红色虚线。我们从图中可以看到，内核空间开辟了两个缓存区——<strong>内核缓存区</strong>和<strong>数据接收缓存区</strong>，这两个缓存区之间存在内存映射，然后<strong>数据接收缓存区</strong>与<strong>数据接收进程的用户空间缓存区</strong>同样有内存映射。当数据发送进程通过<code>copy_from_user()</code>将数据拷贝到<strong>内核缓存区</strong>的时候，存在映射关系的数据接收进程用户空间缓存区也就收到了数据。</p>\n<h2 id=\"Binder通信模型\"><a href=\"#Binder通信模型\" class=\"headerlink\" title=\"Binder通信模型\"></a>Binder通信模型</h2><p>跨进程通讯至少包含两个进程，我们将数据发送进程称为<strong>Client</strong>，把数据接收方称为<strong>Server</strong>。</p>\n<h3 id=\"Client-Server-ServiceManager-驱动\"><a href=\"#Client-Server-ServiceManager-驱动\" class=\"headerlink\" title=\"Client&#x2F;Server&#x2F;ServiceManager&#x2F;驱动\"></a>Client&#x2F;Server&#x2F;ServiceManager&#x2F;驱动</h3><p>前面我们介绍过，Binder 是基于 C&#x2F;S 架构的。由一系列的组件组成，包括 Client、Server、ServiceManager、Binder 驱动。其中 Client、Server、Service Manager 运行在用户空间，Binder 驱动运行在内核空间。其中 Service Manager 和 Binder 驱动由系统提供，而 Client、Server 由应用程序来实现。Client、Server 和 ServiceManager 均是通过系统调用 open、mmap 和 ioctl 来访问设备文件 &#x2F;dev&#x2F;binder，从而实现与 Binder 驱动的交互来间接的实现跨进程通信。</p>\n<p><img src=\"/images/android_binder.jpg\" alt=\"img\"></p>\n<p><a href=\"https://link.zhihu.com/?target=http://blog.csdn.net/universus/article/details/6211589\">Android Binder 设计与实现</a><em>一文中对 Client、Server、ServiceManager、Binder 驱动有很详细的描述，以下是部分摘录：</em></p>\n<blockquote>\n<p><strong>Binder 驱动</strong><br>Binder 驱动就如同路由器一样，是整个通信的核心；驱动负责进程之间 Binder 通信的建立，Binder 在进程之间的传递，Binder 引用计数管理，数据包在进程之间的传递和交互等一系列底层支持。</p>\n<p><strong>ServiceManager 与实名 Binder</strong><br>ServiceManager 和 DNS 类似，作用是将字符形式的 Binder 名字转化成 Client 中对该 Binder 的引用，使得 Client 能够通过 Binder 的名字获得对 Binder 实体的引用。注册了名字的 Binder 叫实名 Binder，就像网站一样除了除了有 IP 地址意外还有自己的网址。Server 创建了 Binder，并为它起一个字符形式，可读易记得名字，将这个 Binder 实体连同名字一起以数据包的形式通过 Binder 驱动发送给 ServiceManager ，通知 ServiceManager 注册一个名为“张三”的 Binder，它位于某个 Server 中。驱动为这个穿越进程边界的 Binder 创建位于内核中的实体节点以及 ServiceManager 对实体的引用，将名字以及新建的引用打包传给 ServiceManager。ServiceManger 收到数据后从中取出名字和引用填入查找表。</p>\n<p>细心的读者可能会发现，ServierManager 是一个进程，Server 是另一个进程，Server 向 ServiceManager 中注册 Binder 必然涉及到进程间通信。当前实现进程间通信又要用到进程间通信，这就好像蛋可以孵出鸡的前提却是要先找只鸡下蛋！Binder 的实现比较巧妙，就是预先创造一只鸡来下蛋。ServiceManager 和其他进程同样采用 Bidner 通信，ServiceManager 是 Server 端，有自己的 Binder 实体，其他进程都是 Client，需要通过这个 Binder 的引用来实现 Binder 的注册，查询和获取。ServiceManager 提供的 Binder 比较特殊，它没有名字也不需要注册。当一个进程使用 BINDER<em>SET</em>CONTEXT_MGR 命令将自己注册成 ServiceManager 时 Binder 驱动会自动为它创建 Binder 实体（<strong>这就是那只预先造好的那只鸡</strong>）。其次这个 Binder 实体的引用在所有 Client 中都固定为 0 而无需通过其它手段获得。也就是说，一个 Server 想要向 ServiceManager 注册自己的 Binder 就必须通过这个 0 号引用和 ServiceManager 的 Binder 通信。类比互联网，0 号引用就好比是域名服务器的地址，你必须预先动态或者手工配置好。要注意的是，这里说的 Client 是相对于 ServiceManager 而言的，一个进程或者应用程序可能是提供服务的 Server，但对于 ServiceManager 来说它仍然是个 Client。</p>\n<p><strong>Client 获得实名 Binder 的引用</strong><br>Server 向 ServiceManager 中注册了 Binder 以后， Client 就能通过名字获得 Binder 的引用了。Client 也利用保留的 0 号引用向 ServiceManager 请求访问某个 Binder: 我申请访问名字叫张三的 Binder 引用。ServiceManager 收到这个请求后从请求数据包中取出 Binder 名称，在查找表里找到对应的条目，取出对应的 Binder 引用作为回复发送给发起请求的 Client。从面向对象的角度看，Server 中的 Binder 实体现在有两个引用：一个位于 ServiceManager 中，一个位于发起请求的 Client 中。如果接下来有更多的 Client 请求该 Binder，系统中就会有更多的引用指向该 Binder ，就像 Java 中一个对象有多个引用一样。</p>\n</blockquote>\n<h3 id=\"Binder通信过程\"><a href=\"#Binder通信过程\" class=\"headerlink\" title=\"Binder通信过程\"></a>Binder通信过程</h3><p>至此，我们大致能总结出 Binder 通信过程：</p>\n<ol>\n<li>首先，一个进程使用 BINDER<em>SET</em>CONTEXT_MGR 命令通过 Binder 驱动将自己注册成为 ServiceManager；</li>\n<li>Server 通过驱动向 ServiceManager 中注册 Binder（Server 中的 Binder 实体），表明可以对外提供服务。驱动为这个 Binder 创建位于内核中的实体节点以及 ServiceManager 对实体的引用，将名字以及新建的引用打包传给 ServiceManager，ServiceManger 将其填入查找表。</li>\n<li>Client 通过名字，在 Binder 驱动的帮助下从 ServiceManager 中获取到对 Binder 实体的引用，通过这个引用就能实现和 Server 进程的通信。</li>\n</ol>\n<p>我们看到整个通信过程都需要 Binder 驱动的接入。下图能更加直观的展现整个通信过程(为了进一步抽象通信过程以及呈现上的方便，下图我们忽略了 Binder 实体及其引用的概念)：</p>\n<p><img src=\"/images/client_server_service_manager.jpg\" alt=\"img\"></p>\n<h3 id=\"Binder-通信中的代理模式\"><a href=\"#Binder-通信中的代理模式\" class=\"headerlink\" title=\"Binder 通信中的代理模式\"></a>Binder 通信中的代理模式</h3><p>我们已经解释清楚 Client、Server 借助 Binder 驱动完成跨进程通信的实现机制了，但是还有个问题会让我们困惑。A 进程想要 B 进程中某个对象（object）是如何实现的呢？毕竟它们分属不同的进程，A 进程 没法直接使用 B 进程中的 object。</p>\n<p>前面我们介绍过跨进程通信的过程都有 Binder 驱动的参与，因此在数据流经 Binder 驱动的时候驱动会对数据做一层转换。当 A 进程想要获取 B 进程中的 object 时，驱动并不会真的把 object 返回给 A，而是返回了一个跟 object 看起来一模一样的代理对象 objectProxy，这个 objectProxy 具有和 object 一摸一样的方法，但是这些方法并没有 B 进程中 object 对象那些方法的能力，这些方法只需要把把请求参数交给驱动即可。对于 A 进程来说和直接调用 object 中的方法是一样的。</p>\n<p>当 Binder 驱动接收到 A 进程的消息后，发现这是个 objectProxy 就去查询自己维护的表单，一查发现这是 B 进程 object 的代理对象。于是就会去通知 B 进程调用 object 的方法，并要求 B 进程把返回结果发给自己。当驱动拿到 B 进程的返回结果后就会转发给 A 进程，一次通信就完成了。</p>\n<p><img src=\"/images/binder_data_trans.jpg\" alt=\"img\"></p>\n<h3 id=\"Binder的完整定义\"><a href=\"#Binder的完整定义\" class=\"headerlink\" title=\"Binder的完整定义\"></a>Binder的完整定义</h3><p>现在我们可以对 Binder 做个更加全面的定义了：</p>\n<ul>\n<li>从进程间通信的角度看，Binder 是一种进程间通信的机制；</li>\n<li>从 Server 进程的角度看，Binder 指的是 Server 中的 Binder 实体对象；</li>\n<li>从 Client 进程的角度看，Binder 指的是对 Binder 代理对象，是 Binder 实体对象的一个远程代理</li>\n<li>从传输过程的角度看，Binder 是一个可以跨进程传输的对象；Binder 驱动会对这个跨越进程边界的对象对一点点特殊处理，自动完成代理对象和本地对象之间的转换。</li>\n</ul>\n<h2 id=\"实现Binder跨进程通信\"><a href=\"#实现Binder跨进程通信\" class=\"headerlink\" title=\"实现Binder跨进程通信\"></a>实现Binder跨进程通信</h2><p>一般Android上，使用**AIDL(Android Interface Definition Language)**来实现跨进程通信协议。AIDL主要是对接口进行描述的，包括定义Server为Client提供那些操作服务。通过AIDL文件，Android Studio在编译时候，会自动产生接口类以及代理类。</p>\n<p>除了通过AIDL的方式，我们还可以自己手动编写接口类和代理类。</p>\n<p>代码请参考<a href=\"https://github.com/boybeak/TheBinder\">TheBinder</a>，这里展示了两种方式实现Binder IPC。</p>\n<p>代码中涉及到了一些Java类。</p>\n<ul>\n<li><strong>IBinder</strong> : IBinder 是一个接口，代表了一种跨进程通信的能力。只要实现了这个借口，这个对象就能跨进程传输。</li>\n<li><strong>IInterface</strong> : IInterface 代表的就是 Server 进程对象具备什么样的能力（能提供哪些方法，其实对应的就是 AIDL 文件中定义的接口）</li>\n<li><strong>Binder</strong> : Java 层的 Binder 类，代表的其实就是 Binder 本地对象。BinderProxy 类是 Binder 类的一个内部类，它代表远程进程的 Binder 对象的本地代理；这两个类都继承自 IBinder, 因而都具有跨进程传输的能力；实际上，在跨越进程的时候，Binder 驱动会自动完成这两个对象的转换。</li>\n<li><strong>Stub</strong> : AIDL 的时候，编译工具会给我们生成一个名为 Stub 的静态内部类；这个类继承了 Binder, 说明它是一个 Binder 本地对象，它实现了 IInterface 接口，表明它具有 Server 承诺给 Client 的能力；Stub 是一个抽象类，具体的 IInterface 的相关实现需要开发者自己实现。</li>\n</ul>\n<h2 id=\"自己实现\"><a href=\"#自己实现\" class=\"headerlink\" title=\"自己实现\"></a>自己实现</h2><p>代码请参考<a href=\"https://github.com/boybeak/TheBinder\">TheBinder</a></p>\n<p>代码中有两个module: <strong>withAIDL</strong>和<strong>noAIDL</strong>，分别演示了使用AIDL的方式和不使用ADIL的方式进行Binder IPC。</p>\n<p><strong>NoAIDL</strong>相比<strong>WithAIDL</strong>有一个优点，就是可以在对应的<code>IInterface</code>文件中，添加一些自定义的代码，比如添加log代码；由于AIDL的方式是自动生成的代码，所以这些自定义代码是没法添加到对应的<code>IInterface</code>文件中。</p>\n<p>我们重点关注<strong>noAIDL</strong></p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">//INoAIDL.kt</span>\n<span class=\"token keyword\">interface</span> INoAIDL <span class=\"token operator\">:</span> IInterface <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">fun</span> <span class=\"token function\">sayHi</span><span class=\"token punctuation\">(</span>name<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">fun</span> <span class=\"token function\">showObjN</span><span class=\"token punctuation\">(</span>objN<span class=\"token operator\">:</span> ObjN<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ObjN<span class=\"token operator\">?</span>\n\n  <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> TAG <span class=\"token operator\">=</span> INoAIDL<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">.</span>simpleName\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> DESCRIPTOR <span class=\"token operator\">=</span> INoAIDL<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">.</span>name\n\n    <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> Stub <span class=\"token operator\">:</span> <span class=\"token function\">Binder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> INoAIDL <span class=\"token punctuation\">&#123;</span><span class=\"token operator\">..</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">class</span> <span class=\"token function\">Proxy</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> remote<span class=\"token operator\">:</span> IBinder<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> INoAIDL <span class=\"token punctuation\">&#123;</span><span class=\"token operator\">..</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p><code>INoAIDL.kt</code>文件的大体结构如上代码，我们可以看到，在这个<code>IInterface</code>类中：</p>\n<ul>\n<li>定义两个Server端承诺的服务——<code>sayHi</code>和<code>showObjN</code>；</li>\n<li>两个静态类——一个Stub类和一个Proxy类。</li>\n</ul>\n<p><strong>Stub类</strong></p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> Stub <span class=\"token operator\">:</span> <span class=\"token function\">Binder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> INoAIDL <span class=\"token punctuation\">&#123;</span>\n\n  <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">val</span> TRANSACTION_sayHi <span class=\"token operator\">=</span> IBinder<span class=\"token punctuation\">.</span>FIRST_CALL_TRANSACTION <span class=\"token operator\">+</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">val</span> TRANSACTION_showObjN <span class=\"token operator\">=</span> IBinder<span class=\"token punctuation\">.</span>FIRST_CALL_TRANSACTION <span class=\"token operator\">+</span> <span class=\"token number\">1</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">asInterface</span><span class=\"token punctuation\">(</span>binder<span class=\"token operator\">:</span> IBinder<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> INoAIDL<span class=\"token operator\">?</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>binder <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n      <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token keyword\">val</span> iin <span class=\"token operator\">=</span> binder<span class=\"token punctuation\">.</span><span class=\"token function\">queryLocalInterface</span><span class=\"token punctuation\">(</span>DESCRIPTOR<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>iin <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> iin <span class=\"token keyword\">is</span> INoAIDL<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        Log<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"Client and Server in the same Process\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> iin\n      <span class=\"token punctuation\">&#125;</span>\n      Log<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"Client and Server in different Processes\"</span></span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">Proxy</span><span class=\"token punctuation\">(</span>binder<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">init</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token function\">attachInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> DESCRIPTOR<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">final</span> <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">attachInterface</span><span class=\"token punctuation\">(</span>owner<span class=\"token operator\">:</span> IInterface<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> descriptor<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">attachInterface</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">,</span> descriptor<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onTransact</span><span class=\"token punctuation\">(</span>code<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> <span class=\"token keyword\">data</span><span class=\"token operator\">:</span> Parcel<span class=\"token punctuation\">,</span> reply<span class=\"token operator\">:</span> Parcel<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> flags<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Boolean <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">val</span> descriptor <span class=\"token operator\">=</span> DESCRIPTOR\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">when</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      INTERFACE_TRANSACTION <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n        reply<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeString</span><span class=\"token punctuation\">(</span>descriptor<span class=\"token punctuation\">)</span>\n        <span class=\"token boolean\">true</span>\n      <span class=\"token punctuation\">&#125;</span>\n      TRANSACTION_sayHi <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span><span class=\"token function\">enforceInterface</span><span class=\"token punctuation\">(</span>descriptor<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> name <span class=\"token operator\">=</span> <span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span><span class=\"token function\">readString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?:</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"\"</span></span>\n        <span class=\"token function\">sayHi</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span>\n        reply<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeNoException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token boolean\">true</span>\n      <span class=\"token punctuation\">&#125;</span>\n      TRANSACTION_showObjN <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span><span class=\"token function\">enforceInterface</span><span class=\"token punctuation\">(</span>descriptor<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">var</span> objN<span class=\"token operator\">:</span> ObjN<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span><span class=\"token function\">readInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n          objN <span class=\"token operator\">=</span> ObjN<span class=\"token punctuation\">.</span>CREATOR<span class=\"token punctuation\">.</span><span class=\"token function\">createFromParcel</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">data</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token keyword\">val</span> _result <span class=\"token operator\">=</span> <span class=\"token function\">showObjN</span><span class=\"token punctuation\">(</span>objN<span class=\"token operator\">!!</span><span class=\"token punctuation\">)</span>\n        reply<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeNoException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_result <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n          reply<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n          _result<span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>reply<span class=\"token punctuation\">,</span> Parcelable<span class=\"token punctuation\">.</span>PARCELABLE_WRITE_RETURN_VALUE<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n          reply<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token boolean\">true</span>\n      <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token keyword\">else</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onTransact</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">,</span> <span class=\"token keyword\">data</span><span class=\"token punctuation\">,</span> reply<span class=\"token punctuation\">,</span> flags<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">asBinder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> IBinder <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在Manifest文件中我们定义对应Service</p>\n<pre class=\"language-markup\" data-language=\"markup\"><code class=\"language-markup\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>service</span>\n  <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>.NoAIDLService<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>enabled</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>exported</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token punctuation\">/></span></span>\n  <span class=\"token comment\">&lt;!--android:process=\":noAIDL\"--></span>\n\t<span class=\"token comment\">&lt;!--把上述属性设置到service中，则是在不同进程中运行--></span></code></pre>\n\n<p>我们重点关注<code>asInterface</code>方法，在这个方法中，有一个代码片段：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> iin <span class=\"token operator\">=</span> binder<span class=\"token punctuation\">.</span><span class=\"token function\">queryLocalInterface</span><span class=\"token punctuation\">(</span>DESCRIPTOR<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>iin <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> iin <span class=\"token keyword\">is</span> INoAIDL<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\tLog<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"Client and Server in the same Process\"</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> iin\n<span class=\"token punctuation\">&#125;</span>\nLog<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"Client and Server in different Processes\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">return</span> <span class=\"token function\">Proxy</span><span class=\"token punctuation\">(</span>binder<span class=\"token punctuation\">)</span></code></pre>\n\n<p>通过这样的代码来进行Client和Server是否在不同进程的判断。</p>\n<ul>\n<li>相同进程：返回<code>queryLocalInterface</code>出来的对象，这个对象是在<code>Stub</code>构造方法中通过<code>attachInterface</code>方法传入的。</li>\n<li>不同进程：构造一个<code>Proxy</code>类返回。</li>\n</ul>\n<p>MainActivity去bind一个Service，Service返回一个Binder。我们打印一下日志。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> NoAIDLService <span class=\"token operator\">:</span> <span class=\"token function\">Service</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onBind</span><span class=\"token punctuation\">(</span>intent<span class=\"token operator\">:</span> Intent<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> IBinder <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> binder<span class=\"token punctuation\">.</span><span class=\"token function\">also</span> <span class=\"token punctuation\">&#123;</span>\n      Log<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"onBind=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">it</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> noAIDL<span class=\"token operator\">:</span> INoAIDL<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> noConnection <span class=\"token operator\">=</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> ServiceConnection <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onServiceConnected</span><span class=\"token punctuation\">(</span>name<span class=\"token operator\">:</span> ComponentName<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> service<span class=\"token operator\">:</span> IBinder<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    service <span class=\"token operator\">?:</span> <span class=\"token keyword\">return</span>\n    Log<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"onServiceConnected service=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">service</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n    noAIDL <span class=\"token operator\">=</span> INoAIDL<span class=\"token punctuation\">.</span>Companion<span class=\"token punctuation\">.</span>Stub<span class=\"token punctuation\">.</span><span class=\"token function\">asInterface</span><span class=\"token punctuation\">(</span>service<span class=\"token punctuation\">)</span>\n    Toast<span class=\"token punctuation\">.</span><span class=\"token function\">makeText</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token label symbol\">@MainActivity</span><span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"connected to NoAIDLService\"</span></span><span class=\"token punctuation\">,</span> Toast<span class=\"token punctuation\">.</span>LENGTH_SHORT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    Log<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"onServiceConnected noAIDL=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token expression\">noAIDL</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n</code></pre>\n\n<p>当Client与Server在相同进程，有如下日志：</p>\n<pre class=\"language-none\"><code class=\"language-none\">&#x2F;&#x2F; NoAIDLService\nonBind&#x3D;com.github.boybeak.noaidl.NoAIDLService$binder$1@84abbdc\n\n&#x2F;&#x2F; MainActivity\nonServiceConnected service&#x3D;com.github.boybeak.noaidl.NoAIDLService$binder$1@84abbdc\nnoAIDL&#x3D;com.github.boybeak.noaidl.NoAIDLService$binder$1@84abbdc</code></pre>\n\n<p>当Client与Server在不同进程，有如下日志：</p>\n<pre class=\"language-none\"><code class=\"language-none\">&#x2F;&#x2F; NoAIDLService\nonBind&#x3D;com.github.boybeak.noaidl.NoAIDLService$binder$1@2d32060\n\n&#x2F;&#x2F; MainActivity\nonServiceConnected service&#x3D;android.os.BinderProxy@99b42f6\nnoAIDL&#x3D;com.github.boybeak.noaidl.INoAIDL$Companion$Proxy@67e8964</code></pre>\n\n<p>我们看到，当Client与Server在相同进程时候，Service的<code>onBind</code>方法返回的是什么，MainActivity接收到的就是什么；而当Client与Server在不同进程的时候，则返回的是Binder驱动传递给我们的对象，通过这个对象，我们创造一个 Proxy代理对象。</p>\n<p>我们接下来重点关注<code>showObjN</code>方法。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> binder <span class=\"token operator\">=</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> INoAIDL<span class=\"token punctuation\">.</span>Companion<span class=\"token punctuation\">.</span><span class=\"token function\">Stub</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">showObjN</span><span class=\"token punctuation\">(</span>objN<span class=\"token operator\">:</span> ObjN<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ObjN<span class=\"token operator\">?</span> <span class=\"token punctuation\">&#123;</span>\n    Log<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"showObjN objN=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">objN</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> objN\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这个方法中，直接返回传入的参数。</p>\n<p>调用的地方这样来写：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">showObjN</span><span class=\"token punctuation\">(</span>v<span class=\"token operator\">:</span> View<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>noAIDL <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    Toast<span class=\"token punctuation\">.</span><span class=\"token function\">makeText</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"Click NOAIDL button first\"</span></span><span class=\"token punctuation\">,</span> Toast<span class=\"token punctuation\">.</span>LENGTH_SHORT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">val</span> objN <span class=\"token operator\">=</span> <span class=\"token function\">ObjN</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  Log<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"showObjN objN=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">objN</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> returnObjN <span class=\"token operator\">=</span> noAIDL<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">showObjN</span><span class=\"token punctuation\">(</span>objN<span class=\"token punctuation\">)</span>\n  Log<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"showObjN returnObjW=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">returnObjN</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们来看打印的<code>objN</code>日志。</p>\n<p><strong>相同进程情况下：</strong></p>\n<pre class=\"language-none\"><code class=\"language-none\">&#x2F;&#x2F; Client进程\ncom.github.boybeak.binder V&#x2F;MainActivity: showObjN objN&#x3D;com.github.boybeak.noaidl.ObjN@4c7d499\ncom.github.boybeak.binder V&#x2F;MainActivity: showObjN returnObjW&#x3D;com.github.boybeak.noaidl.ObjN@4c7d499\n\n&#x2F;&#x2F; Server进程\ncom.github.boybeak.binder V&#x2F;NoAIDLService: showObjN objN&#x3D;com.github.boybeak.noaidl.ObjN@4c7d499</code></pre>\n\n\n\n<p><strong>不同进程情况下：</strong></p>\n<pre class=\"language-none\"><code class=\"language-none\">&#x2F;&#x2F; Client进程\ncom.github.boybeak.binder V&#x2F;MainActivity: showObjN objN&#x3D;com.github.boybeak.noaidl.ObjN@5ab3a61\ncom.github.boybeak.binder V&#x2F;MainActivity: showObjN returnObjW&#x3D;com.github.boybeak.noaidl.ObjN@db79986\n\n&#x2F;&#x2F; Server进程\ncom.github.boybeak.binder V&#x2F;NoAIDLService: showObjN objN&#x3D;com.github.boybeak.noaidl.ObjN@1c5381d</code></pre>\n\n\n\n<p>我们可以看到，在相同进程情况下，就是普通的函数调用；在不同进程情况下，Client传入的参数，Server接收到的参数，Client接收到的返回结果，全是不同的对象，这是因为，通过Proxy对象，在跨进程通信时候，将Parcelable对象进行了序列化和反序列化。</p>\n<p>本文是在阅读<a href=\"https://zhuanlan.zhihu.com/p/35519585\"><strong>写给 Android 应用工程师的 Binder 原理剖析</strong></a>一文后，加上自己的理解与实验完成，其中部分段落直接复制了原文，因为我觉得，那部分原文已经足够容易理解且没有冗余的文字，感谢原作者<a href=\"https://www.zhihu.com/people/BaronZ88\"><strong>张磊</strong></a>，同时附上原文参考资料：</p>\n<ul>\n<li><a href=\"https://link.zhihu.com/?target=http://blog.csdn.net/universus/article/details/6211589\">Android Binder 设计与实现 - 设计篇</a></li>\n<li><a href=\"https://link.zhihu.com/?target=http://blog.csdn.net/luoshengyang/article/details/6618363\">Android 进程间通信（IPC）机制 Binder 简要介绍和学习计划</a>、<a href=\"https://link.zhihu.com/?target=http://item.jd.com/12248208.html\">《Android 系统源代码情景分析》</a></li>\n<li><a href=\"https://link.zhihu.com/?target=http://weishu.me/2016/01/12/binder-index-for-newer/\">Binder 学习指南</a></li>\n<li><a href=\"https://link.zhihu.com/?target=http://gityuan.com/2015/10/31/binder-prepare/\">Binder 系列文章</a></li>\n<li><a href=\"https://link.zhihu.com/?target=https://blog.csdn.net/carson_ho/article/details/73560642\">Android 图文详解 Binder 跨进程通信原理</a></li>\n<li><a href=\"https://link.zhihu.com/?target=http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html\">Android 深入浅出之 Binder 机制</a></li>\n<li><a href=\"https://link.zhihu.com/?target=http://www.cnblogs.com/Anker/p/3269106.html\">用户空间与内核空间</a></li>\n<li><a href=\"https://link.zhihu.com/?target=https://www.cnblogs.com/huxiao-tee/p/4660352.html\">认真分析 mmap ：是什么 为什么 怎么用</a></li>\n</ul>\n","excerpt":"","more":"<p>参考文章：<a href=\"https://zhuanlan.zhihu.com/p/35519585\">写给 Android 应用工程师的 Binder 原理剖析</a></p>\n<p>实验代码：<a href=\"https://github.com/boybeak/TheBinder\">TheBinder</a></p>\n<p>Binder机制可以说是Android的核心。提到Binder，可能会让你想到，通过bindService与<code>Service</code>进行通信(也可能是跨进程的通信)，实际上，Android中Binder的使用可以说是无处不在的，包括Activity跳转，详情可以参考<a href=\"https://boybeak.github.io/android/AMS%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.html\">AMS启动流程</a>。</p>\n<h2 id=\"为什么要用Binder\"><a href=\"#为什么要用Binder\" class=\"headerlink\" title=\"为什么要用Binder?\"></a>为什么要用Binder?</h2><p>在Linux系统中，跨进程通信(IPC)方式有很多种，包括Socket、管道、共享内存等。可以Android为何最后选择Binder作为核心的跨进程通信的手段呢？</p>\n<p>这需要从两方面去分析——<strong>性能</strong>和<strong>安全性</strong>。</p>\n<h3 id=\"1-性能\"><a href=\"#1-性能\" class=\"headerlink\" title=\"1. 性能\"></a>1. 性能</h3><p>首先说说性能上的优势。Socket 作为一款通用接口，其传输效率低，开销大，主要用在跨网络的进程间通信和本机上进程间的低速通信。消息队列和管道采用存储-转发方式，即数据先从发送方缓存区拷贝到内核开辟的缓存区中，然后再从内核缓存区拷贝到接收方缓存区，至少有两次拷贝过程。共享内存虽然无需拷贝，但控制复杂，难以使用。Binder 只需要一次数据拷贝，性能上仅次于共享内存。</p>\n<h3 id=\"2-安全性\"><a href=\"#2-安全性\" class=\"headerlink\" title=\"2. 安全性\"></a>2. 安全性</h3><p>另一方面就是安全性。Android 作为一个开放性的平台，市场上有各类海量的应用供用户选择安装，因此安全性对于 Android 平台而言极其重要。作为用户当然不希望我们下载的 APP 偷偷读取我的通信录，上传我的隐私数据，后台偷跑流量、消耗手机电量。传统的 IPC 没有任何安全措施，完全依赖上层协议来确保。首先传统的 IPC 接收方无法获得对方可靠的进程用户ID&#x2F;进程ID（UID&#x2F;PID），从而无法鉴别对方身份。Android 为每个安装好的 APP 分配了自己的 UID，故而进程的 UID 是鉴别进程身份的重要标志。传统的 IPC 只能由用户在数据包中填入 UID&#x2F;PID，但这样不可靠，容易被恶意程序利用。可靠的身份标识只有由 IPC 机制在内核中添加。其次传统的 IPC 访问接入点是开放的，只要知道这些接入点的程序都可以和对端建立连接，不管怎样都无法阻止恶意程序通过猜测接收方地址获得连接。同时 Binder 既支持实名 Binder，又支持匿名 Binder，安全性高。</p>\n<p>基于上述原因，Android 需要建立一套新的 IPC 机制来满足系统对稳定性、传输性能和安全性方面的要求，这就是 Binder。</p>\n<p>用一张表格来总结与对比各种IPC方式。</p>\n<table>\n<thead>\n<tr>\n<th>IPC方式</th>\n<th>性能(内存拷贝次数)</th>\n<th>安全性</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Binder</td>\n<td>1</td>\n<td>通过UID&#x2F;PID来保证</td>\n</tr>\n<tr>\n<td>共享内存</td>\n<td>0</td>\n<td>操作非常复杂，难以保证</td>\n</tr>\n<tr>\n<td>Socket&#x2F;管道&#x2F;消息队列</td>\n<td>2</td>\n<td>依靠上层协议做身份识别，非常不可靠</td>\n</tr>\n</tbody></table>\n<h2 id=\"传统IPC是什么样的？\"><a href=\"#传统IPC是什么样的？\" class=\"headerlink\" title=\"传统IPC是什么样的？\"></a>传统IPC是什么样的？</h2><p>先要了解一些基本概念——<strong>进程隔离</strong>、<strong>用户空间</strong>、<strong>内核空间</strong>、<strong>用户态</strong>、<strong>内核态</strong>。</p>\n<p><img src=\"/images/traditional_ipc.jpg\" alt=\"IPC\"></p>\n<p>上图展示了 Liunx 中跨进程通信涉及到的一些基本概念：</p>\n<ul>\n<li>进程隔离</li>\n<li>进程空间划分：用户空间(User Space)&#x2F;内核空间(Kernel Space)</li>\n<li>系统调用：用户态&#x2F;内核态</li>\n</ul>\n<h3 id=\"进程隔离\"><a href=\"#进程隔离\" class=\"headerlink\" title=\"进程隔离\"></a>进程隔离</h3><p>顾名思义，就是进程之间内存是不共享的。进程间要进行数据交换，就得采用**进程间通信(IPC)**机制。</p>\n<h3 id=\"进程空间划分：用户空间-User-Space-内核空间-Kernel-Space\"><a href=\"#进程空间划分：用户空间-User-Space-内核空间-Kernel-Space\" class=\"headerlink\" title=\"进程空间划分：用户空间(User Space)&#x2F;内核空间(Kernel Space)\"></a>进程空间划分：用户空间(User Space)&#x2F;内核空间(Kernel Space)</h3><p>现在操作系统都是采用的虚拟存储器，对于 32 位系统而言，它的寻址空间（虚拟存储空间）就是 2 的 32 次方，也就是 4GB。操作系统的核心是内核，独立于普通的应用程序，可以访问受保护的内存空间，也可以访问底层硬件设备的权限。为了保护用户进程不能直接操作内核，保证内核的安全，操作系统从逻辑上将虚拟空间划分为用户空间（User Space）和内核空间（Kernel Space）。针对 Linux 操作系统而言，将最高的 1GB 字节供内核使用，称为内核空间；较低的 3GB 字节供各进程使用，称为用户空间。</p>\n<blockquote>\n<p>简单的说就是，内核空间（Kernel）是系统内核运行的空间，用户空间（User Space）是用户程序运行的空间。为了保证安全性，它们之间是隔离的。</p>\n</blockquote>\n<p><img src=\"/images/linux_memory.png\" alt=\"linux memory\"></p>\n<h3 id=\"系统调用：用户态-内核态\"><a href=\"#系统调用：用户态-内核态\" class=\"headerlink\" title=\"系统调用：用户态&#x2F;内核态\"></a>系统调用：用户态&#x2F;内核态</h3><p>虽然从逻辑上进行了用户空间和内核空间的划分，但不可避免的用户空间需要访问内核资源，比如文件操作、访问网络等等。为了突破隔离限制，就需要借助<strong>系统调用</strong>来实现。系统调用是用户空间访问内核空间的唯一方式，保证了所有的资源访问都是在内核的控制下进行的，避免了用户程序对系统资源的越权访问，提升了系统安全性和稳定性。</p>\n<p>Linux 使用两级保护机制：0 级供系统内核使用，3 级供用户程序使用。</p>\n<p>当一个任务（进程）执行系统调用而陷入内核代码中执行时，称进程处于<strong>内核运行态（内核态）</strong>。此时处理器处于特权级最高的（0级）内核代码中执行。当进程处于内核态时，执行的内核代码会使用当前进程的内核栈。每个进程都有自己的内核栈。</p>\n<p>当进程在执行用户自己的代码的时候，我们称其处于<strong>用户运行态（用户态）</strong>。此时处理器在特权级最低的（3级）用户代码中运行。</p>\n<p>系统调用主要通过如下两个函数来实现：</p>\n<pre class=\"language-none\"><code class=\"language-none\">copy_from_user() &#x2F;&#x2F;将数据从用户空间拷贝到内核空间\ncopy_to_user() &#x2F;&#x2F;将数据从内核空间拷贝到用户空间</code></pre>\n\n\n\n<h3 id=\"Linux下传统IPC通信\"><a href=\"#Linux下传统IPC通信\" class=\"headerlink\" title=\"Linux下传统IPC通信\"></a>Linux下传统IPC通信</h3><p><img src=\"/images/linux_ipc.jpg\" alt=\"linux ipc\"></p>\n<p><strong>数据发送进程</strong>：开辟用户空间缓存区 -&gt; 系统调用，进入内核态 -&gt; 开辟内核空间缓存区 -&gt;通过<code>copy_from_user()</code>将数据拷贝到内核空间缓存区。</p>\n<p><strong>数据接收进程</strong>：开辟用户空间缓存区 -&gt; 调用<code>copytouser()</code>将数据从内核缓存区拷贝到用户空间缓存区。</p>\n<p>这样，两个进程就完成了依次进程间通信。</p>\n<p>这种传统的 IPC 通信方式有两个问题：</p>\n<ol>\n<li>性能低下，一次数据传递需要经历：内存缓存区 –&gt; 内核缓存区 –&gt; 内存缓存区，需要 2 次数据拷贝；</li>\n<li>接收数据的缓存区由数据接收进程提供，但是接收进程并不知道需要多大的空间来存放将要传递过来的数据，因此只能开辟尽可能大的内存空间或者先调用 API 接收消息头来获取消息体的大小，这两种做法不是浪费空间就是浪费时间。</li>\n</ol>\n<h2 id=\"Binder跨进程通信原理\"><a href=\"#Binder跨进程通信原理\" class=\"headerlink\" title=\"Binder跨进程通信原理\"></a>Binder跨进程通信原理</h2><p>正如前面所说，跨进程通信是需要内核空间做支持的。传统的 IPC 机制如管道、Socket 都是内核的一部分，因此通过内核支持来实现进程间通信自然是没问题的。但是 Binder 并不是 Linux 系统内核的一部分，那怎么办呢？这就得益于 Linux 的<strong>动态内核可加载模块</strong>（Loadable Kernel Module，LKM）的机制；模块是具有独立功能的程序，它可以被单独编译，但是不能独立运行。它在运行时被链接到内核作为内核的一部分运行。这样，Android 系统就可以通过动态添加一个内核模块运行在内核空间，用户进程之间通过这个内核模块作为桥梁来实现通信。</p>\n<blockquote>\n<p>在 Android 系统中，这个运行在内核空间，负责各个用户进程通过 Binder 实现通信的内核模块就叫 <strong>Binder 驱动</strong>（Binder Dirver）。</p>\n</blockquote>\n<p>那么在 Android 系统中用户进程之间是如何通过这个内核模块（Binder 驱动）来实现通信的呢？难道是和前面说的传统 IPC 机制一样，先将数据从发送方进程拷贝到内核缓存区，然后再将数据从内核缓存区拷贝到接收方进程，通过两次拷贝来实现吗？显然不是，否则也不会有开篇所说的 Binder 在性能方面的优势了。</p>\n<p>这就不得不通道 Linux 下的另一个概念：<strong>内存映射</strong>。</p>\n<p>Binder IPC 机制中涉及到的内存映射通过 mmap() 来实现，mmap() 是操作系统中一种内存映射的方法。内存映射简单的讲就是将用户空间的一块内存区域映射到内核空间。映射关系建立后，用户对这块内存区域的修改可以直接反应到内核空间；反之内核空间对这段区域的修改也能直接反应到用户空间。</p>\n<p>内存映射能减少数据拷贝次数，实现用户空间和内核空间的高效互动。两个空间各自的修改能直接反映在映射的内存区域，从而被对方空间及时感知。也正因为如此，内存映射能够提供对进程间通信的支持。</p>\n<h3 id=\"Binder-IPC实现原理\"><a href=\"#Binder-IPC实现原理\" class=\"headerlink\" title=\"Binder IPC实现原理\"></a>Binder IPC实现原理</h3><p>Binder IPC 正是基于内存映射（mmap）来实现的，但是 mmap() 通常是用在有物理介质的文件系统上的。</p>\n<p>比如进程中的用户区域是不能直接和物理设备打交道的，如果想要把磁盘上的数据读取到进程的用户区域，需要两次拷贝（磁盘–&gt;内核空间–&gt;用户空间）；通常在这种场景下 mmap() 就能发挥作用，通过在物理介质和用户空间之间建立映射，减少数据的拷贝次数，用内存读写取代I&#x2F;O读写，提高文件读取效率。</p>\n<p>而 Binder 并不存在物理介质，因此 Binder 驱动使用 mmap() 并不是为了在物理介质和用户空间之间建立映射，而是用来在内核空间创建数据接收的缓存空间。</p>\n<p>一次完整的 Binder IPC 通信过程通常是这样：</p>\n<ol>\n<li>首先 Binder 驱动在内核空间创建一个数据接收缓存区；</li>\n<li>接着在内核空间开辟一块内核缓存区，建立<strong>内核缓存区</strong>和<strong>内核中数据接收缓存区</strong>之间的映射关系，以及<strong>内核中数据接收缓存区</strong>和<strong>接收进程用户空间地址</strong>的映射关系；</li>\n<li>发送方进程通过系统调用 copy<em>from</em>user() 将数据 copy 到内核中的<strong>内核缓存区</strong>，由于内核缓存区和接收进程的用户空间存在内存映射，因此也就相当于把数据发送到了接收进程的用户空间，这样便完成了一次进程间的通信。</li>\n</ol>\n<p>如下图：</p>\n<p><img src=\"/images/binder.jpg\" alt=\"binder\"></p>\n<p>注意图中两个红色虚线。我们从图中可以看到，内核空间开辟了两个缓存区——<strong>内核缓存区</strong>和<strong>数据接收缓存区</strong>，这两个缓存区之间存在内存映射，然后<strong>数据接收缓存区</strong>与<strong>数据接收进程的用户空间缓存区</strong>同样有内存映射。当数据发送进程通过<code>copy_from_user()</code>将数据拷贝到<strong>内核缓存区</strong>的时候，存在映射关系的数据接收进程用户空间缓存区也就收到了数据。</p>\n<h2 id=\"Binder通信模型\"><a href=\"#Binder通信模型\" class=\"headerlink\" title=\"Binder通信模型\"></a>Binder通信模型</h2><p>跨进程通讯至少包含两个进程，我们将数据发送进程称为<strong>Client</strong>，把数据接收方称为<strong>Server</strong>。</p>\n<h3 id=\"Client-Server-ServiceManager-驱动\"><a href=\"#Client-Server-ServiceManager-驱动\" class=\"headerlink\" title=\"Client&#x2F;Server&#x2F;ServiceManager&#x2F;驱动\"></a>Client&#x2F;Server&#x2F;ServiceManager&#x2F;驱动</h3><p>前面我们介绍过，Binder 是基于 C&#x2F;S 架构的。由一系列的组件组成，包括 Client、Server、ServiceManager、Binder 驱动。其中 Client、Server、Service Manager 运行在用户空间，Binder 驱动运行在内核空间。其中 Service Manager 和 Binder 驱动由系统提供，而 Client、Server 由应用程序来实现。Client、Server 和 ServiceManager 均是通过系统调用 open、mmap 和 ioctl 来访问设备文件 &#x2F;dev&#x2F;binder，从而实现与 Binder 驱动的交互来间接的实现跨进程通信。</p>\n<p><img src=\"/images/android_binder.jpg\" alt=\"img\"></p>\n<p><a href=\"https://link.zhihu.com/?target=http://blog.csdn.net/universus/article/details/6211589\">Android Binder 设计与实现</a><em>一文中对 Client、Server、ServiceManager、Binder 驱动有很详细的描述，以下是部分摘录：</em></p>\n<blockquote>\n<p><strong>Binder 驱动</strong><br>Binder 驱动就如同路由器一样，是整个通信的核心；驱动负责进程之间 Binder 通信的建立，Binder 在进程之间的传递，Binder 引用计数管理，数据包在进程之间的传递和交互等一系列底层支持。</p>\n<p><strong>ServiceManager 与实名 Binder</strong><br>ServiceManager 和 DNS 类似，作用是将字符形式的 Binder 名字转化成 Client 中对该 Binder 的引用，使得 Client 能够通过 Binder 的名字获得对 Binder 实体的引用。注册了名字的 Binder 叫实名 Binder，就像网站一样除了除了有 IP 地址意外还有自己的网址。Server 创建了 Binder，并为它起一个字符形式，可读易记得名字，将这个 Binder 实体连同名字一起以数据包的形式通过 Binder 驱动发送给 ServiceManager ，通知 ServiceManager 注册一个名为“张三”的 Binder，它位于某个 Server 中。驱动为这个穿越进程边界的 Binder 创建位于内核中的实体节点以及 ServiceManager 对实体的引用，将名字以及新建的引用打包传给 ServiceManager。ServiceManger 收到数据后从中取出名字和引用填入查找表。</p>\n<p>细心的读者可能会发现，ServierManager 是一个进程，Server 是另一个进程，Server 向 ServiceManager 中注册 Binder 必然涉及到进程间通信。当前实现进程间通信又要用到进程间通信，这就好像蛋可以孵出鸡的前提却是要先找只鸡下蛋！Binder 的实现比较巧妙，就是预先创造一只鸡来下蛋。ServiceManager 和其他进程同样采用 Bidner 通信，ServiceManager 是 Server 端，有自己的 Binder 实体，其他进程都是 Client，需要通过这个 Binder 的引用来实现 Binder 的注册，查询和获取。ServiceManager 提供的 Binder 比较特殊，它没有名字也不需要注册。当一个进程使用 BINDER<em>SET</em>CONTEXT_MGR 命令将自己注册成 ServiceManager 时 Binder 驱动会自动为它创建 Binder 实体（<strong>这就是那只预先造好的那只鸡</strong>）。其次这个 Binder 实体的引用在所有 Client 中都固定为 0 而无需通过其它手段获得。也就是说，一个 Server 想要向 ServiceManager 注册自己的 Binder 就必须通过这个 0 号引用和 ServiceManager 的 Binder 通信。类比互联网，0 号引用就好比是域名服务器的地址，你必须预先动态或者手工配置好。要注意的是，这里说的 Client 是相对于 ServiceManager 而言的，一个进程或者应用程序可能是提供服务的 Server，但对于 ServiceManager 来说它仍然是个 Client。</p>\n<p><strong>Client 获得实名 Binder 的引用</strong><br>Server 向 ServiceManager 中注册了 Binder 以后， Client 就能通过名字获得 Binder 的引用了。Client 也利用保留的 0 号引用向 ServiceManager 请求访问某个 Binder: 我申请访问名字叫张三的 Binder 引用。ServiceManager 收到这个请求后从请求数据包中取出 Binder 名称，在查找表里找到对应的条目，取出对应的 Binder 引用作为回复发送给发起请求的 Client。从面向对象的角度看，Server 中的 Binder 实体现在有两个引用：一个位于 ServiceManager 中，一个位于发起请求的 Client 中。如果接下来有更多的 Client 请求该 Binder，系统中就会有更多的引用指向该 Binder ，就像 Java 中一个对象有多个引用一样。</p>\n</blockquote>\n<h3 id=\"Binder通信过程\"><a href=\"#Binder通信过程\" class=\"headerlink\" title=\"Binder通信过程\"></a>Binder通信过程</h3><p>至此，我们大致能总结出 Binder 通信过程：</p>\n<ol>\n<li>首先，一个进程使用 BINDER<em>SET</em>CONTEXT_MGR 命令通过 Binder 驱动将自己注册成为 ServiceManager；</li>\n<li>Server 通过驱动向 ServiceManager 中注册 Binder（Server 中的 Binder 实体），表明可以对外提供服务。驱动为这个 Binder 创建位于内核中的实体节点以及 ServiceManager 对实体的引用，将名字以及新建的引用打包传给 ServiceManager，ServiceManger 将其填入查找表。</li>\n<li>Client 通过名字，在 Binder 驱动的帮助下从 ServiceManager 中获取到对 Binder 实体的引用，通过这个引用就能实现和 Server 进程的通信。</li>\n</ol>\n<p>我们看到整个通信过程都需要 Binder 驱动的接入。下图能更加直观的展现整个通信过程(为了进一步抽象通信过程以及呈现上的方便，下图我们忽略了 Binder 实体及其引用的概念)：</p>\n<p><img src=\"/images/client_server_service_manager.jpg\" alt=\"img\"></p>\n<h3 id=\"Binder-通信中的代理模式\"><a href=\"#Binder-通信中的代理模式\" class=\"headerlink\" title=\"Binder 通信中的代理模式\"></a>Binder 通信中的代理模式</h3><p>我们已经解释清楚 Client、Server 借助 Binder 驱动完成跨进程通信的实现机制了，但是还有个问题会让我们困惑。A 进程想要 B 进程中某个对象（object）是如何实现的呢？毕竟它们分属不同的进程，A 进程 没法直接使用 B 进程中的 object。</p>\n<p>前面我们介绍过跨进程通信的过程都有 Binder 驱动的参与，因此在数据流经 Binder 驱动的时候驱动会对数据做一层转换。当 A 进程想要获取 B 进程中的 object 时，驱动并不会真的把 object 返回给 A，而是返回了一个跟 object 看起来一模一样的代理对象 objectProxy，这个 objectProxy 具有和 object 一摸一样的方法，但是这些方法并没有 B 进程中 object 对象那些方法的能力，这些方法只需要把把请求参数交给驱动即可。对于 A 进程来说和直接调用 object 中的方法是一样的。</p>\n<p>当 Binder 驱动接收到 A 进程的消息后，发现这是个 objectProxy 就去查询自己维护的表单，一查发现这是 B 进程 object 的代理对象。于是就会去通知 B 进程调用 object 的方法，并要求 B 进程把返回结果发给自己。当驱动拿到 B 进程的返回结果后就会转发给 A 进程，一次通信就完成了。</p>\n<p><img src=\"/images/binder_data_trans.jpg\" alt=\"img\"></p>\n<h3 id=\"Binder的完整定义\"><a href=\"#Binder的完整定义\" class=\"headerlink\" title=\"Binder的完整定义\"></a>Binder的完整定义</h3><p>现在我们可以对 Binder 做个更加全面的定义了：</p>\n<ul>\n<li>从进程间通信的角度看，Binder 是一种进程间通信的机制；</li>\n<li>从 Server 进程的角度看，Binder 指的是 Server 中的 Binder 实体对象；</li>\n<li>从 Client 进程的角度看，Binder 指的是对 Binder 代理对象，是 Binder 实体对象的一个远程代理</li>\n<li>从传输过程的角度看，Binder 是一个可以跨进程传输的对象；Binder 驱动会对这个跨越进程边界的对象对一点点特殊处理，自动完成代理对象和本地对象之间的转换。</li>\n</ul>\n<h2 id=\"实现Binder跨进程通信\"><a href=\"#实现Binder跨进程通信\" class=\"headerlink\" title=\"实现Binder跨进程通信\"></a>实现Binder跨进程通信</h2><p>一般Android上，使用**AIDL(Android Interface Definition Language)**来实现跨进程通信协议。AIDL主要是对接口进行描述的，包括定义Server为Client提供那些操作服务。通过AIDL文件，Android Studio在编译时候，会自动产生接口类以及代理类。</p>\n<p>除了通过AIDL的方式，我们还可以自己手动编写接口类和代理类。</p>\n<p>代码请参考<a href=\"https://github.com/boybeak/TheBinder\">TheBinder</a>，这里展示了两种方式实现Binder IPC。</p>\n<p>代码中涉及到了一些Java类。</p>\n<ul>\n<li><strong>IBinder</strong> : IBinder 是一个接口，代表了一种跨进程通信的能力。只要实现了这个借口，这个对象就能跨进程传输。</li>\n<li><strong>IInterface</strong> : IInterface 代表的就是 Server 进程对象具备什么样的能力（能提供哪些方法，其实对应的就是 AIDL 文件中定义的接口）</li>\n<li><strong>Binder</strong> : Java 层的 Binder 类，代表的其实就是 Binder 本地对象。BinderProxy 类是 Binder 类的一个内部类，它代表远程进程的 Binder 对象的本地代理；这两个类都继承自 IBinder, 因而都具有跨进程传输的能力；实际上，在跨越进程的时候，Binder 驱动会自动完成这两个对象的转换。</li>\n<li><strong>Stub</strong> : AIDL 的时候，编译工具会给我们生成一个名为 Stub 的静态内部类；这个类继承了 Binder, 说明它是一个 Binder 本地对象，它实现了 IInterface 接口，表明它具有 Server 承诺给 Client 的能力；Stub 是一个抽象类，具体的 IInterface 的相关实现需要开发者自己实现。</li>\n</ul>\n<h2 id=\"自己实现\"><a href=\"#自己实现\" class=\"headerlink\" title=\"自己实现\"></a>自己实现</h2><p>代码请参考<a href=\"https://github.com/boybeak/TheBinder\">TheBinder</a></p>\n<p>代码中有两个module: <strong>withAIDL</strong>和<strong>noAIDL</strong>，分别演示了使用AIDL的方式和不使用ADIL的方式进行Binder IPC。</p>\n<p><strong>NoAIDL</strong>相比<strong>WithAIDL</strong>有一个优点，就是可以在对应的<code>IInterface</code>文件中，添加一些自定义的代码，比如添加log代码；由于AIDL的方式是自动生成的代码，所以这些自定义代码是没法添加到对应的<code>IInterface</code>文件中。</p>\n<p>我们重点关注<strong>noAIDL</strong></p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">//INoAIDL.kt</span>\n<span class=\"token keyword\">interface</span> INoAIDL <span class=\"token operator\">:</span> IInterface <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">fun</span> <span class=\"token function\">sayHi</span><span class=\"token punctuation\">(</span>name<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">fun</span> <span class=\"token function\">showObjN</span><span class=\"token punctuation\">(</span>objN<span class=\"token operator\">:</span> ObjN<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ObjN<span class=\"token operator\">?</span>\n\n  <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> TAG <span class=\"token operator\">=</span> INoAIDL<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">.</span>simpleName\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> DESCRIPTOR <span class=\"token operator\">=</span> INoAIDL<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">.</span>name\n\n    <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> Stub <span class=\"token operator\">:</span> <span class=\"token function\">Binder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> INoAIDL <span class=\"token punctuation\">&#123;</span><span class=\"token operator\">..</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">class</span> <span class=\"token function\">Proxy</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> remote<span class=\"token operator\">:</span> IBinder<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> INoAIDL <span class=\"token punctuation\">&#123;</span><span class=\"token operator\">..</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p><code>INoAIDL.kt</code>文件的大体结构如上代码，我们可以看到，在这个<code>IInterface</code>类中：</p>\n<ul>\n<li>定义两个Server端承诺的服务——<code>sayHi</code>和<code>showObjN</code>；</li>\n<li>两个静态类——一个Stub类和一个Proxy类。</li>\n</ul>\n<p><strong>Stub类</strong></p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> Stub <span class=\"token operator\">:</span> <span class=\"token function\">Binder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> INoAIDL <span class=\"token punctuation\">&#123;</span>\n\n  <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">val</span> TRANSACTION_sayHi <span class=\"token operator\">=</span> IBinder<span class=\"token punctuation\">.</span>FIRST_CALL_TRANSACTION <span class=\"token operator\">+</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">val</span> TRANSACTION_showObjN <span class=\"token operator\">=</span> IBinder<span class=\"token punctuation\">.</span>FIRST_CALL_TRANSACTION <span class=\"token operator\">+</span> <span class=\"token number\">1</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">asInterface</span><span class=\"token punctuation\">(</span>binder<span class=\"token operator\">:</span> IBinder<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> INoAIDL<span class=\"token operator\">?</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>binder <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n      <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token keyword\">val</span> iin <span class=\"token operator\">=</span> binder<span class=\"token punctuation\">.</span><span class=\"token function\">queryLocalInterface</span><span class=\"token punctuation\">(</span>DESCRIPTOR<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>iin <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> iin <span class=\"token keyword\">is</span> INoAIDL<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        Log<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"Client and Server in the same Process\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> iin\n      <span class=\"token punctuation\">&#125;</span>\n      Log<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"Client and Server in different Processes\"</span></span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">Proxy</span><span class=\"token punctuation\">(</span>binder<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">init</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token function\">attachInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> DESCRIPTOR<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">final</span> <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">attachInterface</span><span class=\"token punctuation\">(</span>owner<span class=\"token operator\">:</span> IInterface<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> descriptor<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">attachInterface</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">,</span> descriptor<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onTransact</span><span class=\"token punctuation\">(</span>code<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> <span class=\"token keyword\">data</span><span class=\"token operator\">:</span> Parcel<span class=\"token punctuation\">,</span> reply<span class=\"token operator\">:</span> Parcel<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> flags<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Boolean <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">val</span> descriptor <span class=\"token operator\">=</span> DESCRIPTOR\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">when</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      INTERFACE_TRANSACTION <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n        reply<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeString</span><span class=\"token punctuation\">(</span>descriptor<span class=\"token punctuation\">)</span>\n        <span class=\"token boolean\">true</span>\n      <span class=\"token punctuation\">&#125;</span>\n      TRANSACTION_sayHi <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span><span class=\"token function\">enforceInterface</span><span class=\"token punctuation\">(</span>descriptor<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> name <span class=\"token operator\">=</span> <span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span><span class=\"token function\">readString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?:</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"\"</span></span>\n        <span class=\"token function\">sayHi</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span>\n        reply<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeNoException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token boolean\">true</span>\n      <span class=\"token punctuation\">&#125;</span>\n      TRANSACTION_showObjN <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span><span class=\"token function\">enforceInterface</span><span class=\"token punctuation\">(</span>descriptor<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">var</span> objN<span class=\"token operator\">:</span> ObjN<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span><span class=\"token function\">readInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n          objN <span class=\"token operator\">=</span> ObjN<span class=\"token punctuation\">.</span>CREATOR<span class=\"token punctuation\">.</span><span class=\"token function\">createFromParcel</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">data</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token keyword\">val</span> _result <span class=\"token operator\">=</span> <span class=\"token function\">showObjN</span><span class=\"token punctuation\">(</span>objN<span class=\"token operator\">!!</span><span class=\"token punctuation\">)</span>\n        reply<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeNoException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_result <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n          reply<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n          _result<span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>reply<span class=\"token punctuation\">,</span> Parcelable<span class=\"token punctuation\">.</span>PARCELABLE_WRITE_RETURN_VALUE<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n          reply<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token boolean\">true</span>\n      <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token keyword\">else</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onTransact</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">,</span> <span class=\"token keyword\">data</span><span class=\"token punctuation\">,</span> reply<span class=\"token punctuation\">,</span> flags<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">asBinder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> IBinder <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在Manifest文件中我们定义对应Service</p>\n<pre class=\"language-markup\" data-language=\"markup\"><code class=\"language-markup\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>service</span>\n  <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>.NoAIDLService<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>enabled</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>exported</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token punctuation\">/></span></span>\n  <span class=\"token comment\">&lt;!--android:process=\":noAIDL\"--></span>\n\t<span class=\"token comment\">&lt;!--把上述属性设置到service中，则是在不同进程中运行--></span></code></pre>\n\n<p>我们重点关注<code>asInterface</code>方法，在这个方法中，有一个代码片段：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> iin <span class=\"token operator\">=</span> binder<span class=\"token punctuation\">.</span><span class=\"token function\">queryLocalInterface</span><span class=\"token punctuation\">(</span>DESCRIPTOR<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>iin <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> iin <span class=\"token keyword\">is</span> INoAIDL<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\tLog<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"Client and Server in the same Process\"</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> iin\n<span class=\"token punctuation\">&#125;</span>\nLog<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"Client and Server in different Processes\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">return</span> <span class=\"token function\">Proxy</span><span class=\"token punctuation\">(</span>binder<span class=\"token punctuation\">)</span></code></pre>\n\n<p>通过这样的代码来进行Client和Server是否在不同进程的判断。</p>\n<ul>\n<li>相同进程：返回<code>queryLocalInterface</code>出来的对象，这个对象是在<code>Stub</code>构造方法中通过<code>attachInterface</code>方法传入的。</li>\n<li>不同进程：构造一个<code>Proxy</code>类返回。</li>\n</ul>\n<p>MainActivity去bind一个Service，Service返回一个Binder。我们打印一下日志。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> NoAIDLService <span class=\"token operator\">:</span> <span class=\"token function\">Service</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onBind</span><span class=\"token punctuation\">(</span>intent<span class=\"token operator\">:</span> Intent<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> IBinder <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> binder<span class=\"token punctuation\">.</span><span class=\"token function\">also</span> <span class=\"token punctuation\">&#123;</span>\n      Log<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"onBind=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">it</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> noAIDL<span class=\"token operator\">:</span> INoAIDL<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> noConnection <span class=\"token operator\">=</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> ServiceConnection <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onServiceConnected</span><span class=\"token punctuation\">(</span>name<span class=\"token operator\">:</span> ComponentName<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> service<span class=\"token operator\">:</span> IBinder<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    service <span class=\"token operator\">?:</span> <span class=\"token keyword\">return</span>\n    Log<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"onServiceConnected service=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">service</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n    noAIDL <span class=\"token operator\">=</span> INoAIDL<span class=\"token punctuation\">.</span>Companion<span class=\"token punctuation\">.</span>Stub<span class=\"token punctuation\">.</span><span class=\"token function\">asInterface</span><span class=\"token punctuation\">(</span>service<span class=\"token punctuation\">)</span>\n    Toast<span class=\"token punctuation\">.</span><span class=\"token function\">makeText</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token label symbol\">@MainActivity</span><span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"connected to NoAIDLService\"</span></span><span class=\"token punctuation\">,</span> Toast<span class=\"token punctuation\">.</span>LENGTH_SHORT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    Log<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"onServiceConnected noAIDL=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token expression\">noAIDL</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n</code></pre>\n\n<p>当Client与Server在相同进程，有如下日志：</p>\n<pre class=\"language-none\"><code class=\"language-none\">&#x2F;&#x2F; NoAIDLService\nonBind&#x3D;com.github.boybeak.noaidl.NoAIDLService$binder$1@84abbdc\n\n&#x2F;&#x2F; MainActivity\nonServiceConnected service&#x3D;com.github.boybeak.noaidl.NoAIDLService$binder$1@84abbdc\nnoAIDL&#x3D;com.github.boybeak.noaidl.NoAIDLService$binder$1@84abbdc</code></pre>\n\n<p>当Client与Server在不同进程，有如下日志：</p>\n<pre class=\"language-none\"><code class=\"language-none\">&#x2F;&#x2F; NoAIDLService\nonBind&#x3D;com.github.boybeak.noaidl.NoAIDLService$binder$1@2d32060\n\n&#x2F;&#x2F; MainActivity\nonServiceConnected service&#x3D;android.os.BinderProxy@99b42f6\nnoAIDL&#x3D;com.github.boybeak.noaidl.INoAIDL$Companion$Proxy@67e8964</code></pre>\n\n<p>我们看到，当Client与Server在相同进程时候，Service的<code>onBind</code>方法返回的是什么，MainActivity接收到的就是什么；而当Client与Server在不同进程的时候，则返回的是Binder驱动传递给我们的对象，通过这个对象，我们创造一个 Proxy代理对象。</p>\n<p>我们接下来重点关注<code>showObjN</code>方法。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> binder <span class=\"token operator\">=</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> INoAIDL<span class=\"token punctuation\">.</span>Companion<span class=\"token punctuation\">.</span><span class=\"token function\">Stub</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">showObjN</span><span class=\"token punctuation\">(</span>objN<span class=\"token operator\">:</span> ObjN<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ObjN<span class=\"token operator\">?</span> <span class=\"token punctuation\">&#123;</span>\n    Log<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"showObjN objN=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">objN</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> objN\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这个方法中，直接返回传入的参数。</p>\n<p>调用的地方这样来写：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">showObjN</span><span class=\"token punctuation\">(</span>v<span class=\"token operator\">:</span> View<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>noAIDL <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    Toast<span class=\"token punctuation\">.</span><span class=\"token function\">makeText</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"Click NOAIDL button first\"</span></span><span class=\"token punctuation\">,</span> Toast<span class=\"token punctuation\">.</span>LENGTH_SHORT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">val</span> objN <span class=\"token operator\">=</span> <span class=\"token function\">ObjN</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  Log<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"showObjN objN=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">objN</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> returnObjN <span class=\"token operator\">=</span> noAIDL<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">showObjN</span><span class=\"token punctuation\">(</span>objN<span class=\"token punctuation\">)</span>\n  Log<span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"showObjN returnObjW=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">returnObjN</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>我们来看打印的<code>objN</code>日志。</p>\n<p><strong>相同进程情况下：</strong></p>\n<pre class=\"language-none\"><code class=\"language-none\">&#x2F;&#x2F; Client进程\ncom.github.boybeak.binder V&#x2F;MainActivity: showObjN objN&#x3D;com.github.boybeak.noaidl.ObjN@4c7d499\ncom.github.boybeak.binder V&#x2F;MainActivity: showObjN returnObjW&#x3D;com.github.boybeak.noaidl.ObjN@4c7d499\n\n&#x2F;&#x2F; Server进程\ncom.github.boybeak.binder V&#x2F;NoAIDLService: showObjN objN&#x3D;com.github.boybeak.noaidl.ObjN@4c7d499</code></pre>\n\n\n\n<p><strong>不同进程情况下：</strong></p>\n<pre class=\"language-none\"><code class=\"language-none\">&#x2F;&#x2F; Client进程\ncom.github.boybeak.binder V&#x2F;MainActivity: showObjN objN&#x3D;com.github.boybeak.noaidl.ObjN@5ab3a61\ncom.github.boybeak.binder V&#x2F;MainActivity: showObjN returnObjW&#x3D;com.github.boybeak.noaidl.ObjN@db79986\n\n&#x2F;&#x2F; Server进程\ncom.github.boybeak.binder V&#x2F;NoAIDLService: showObjN objN&#x3D;com.github.boybeak.noaidl.ObjN@1c5381d</code></pre>\n\n\n\n<p>我们可以看到，在相同进程情况下，就是普通的函数调用；在不同进程情况下，Client传入的参数，Server接收到的参数，Client接收到的返回结果，全是不同的对象，这是因为，通过Proxy对象，在跨进程通信时候，将Parcelable对象进行了序列化和反序列化。</p>\n<p>本文是在阅读<a href=\"https://zhuanlan.zhihu.com/p/35519585\"><strong>写给 Android 应用工程师的 Binder 原理剖析</strong></a>一文后，加上自己的理解与实验完成，其中部分段落直接复制了原文，因为我觉得，那部分原文已经足够容易理解且没有冗余的文字，感谢原作者<a href=\"https://www.zhihu.com/people/BaronZ88\"><strong>张磊</strong></a>，同时附上原文参考资料：</p>\n<ul>\n<li><a href=\"https://link.zhihu.com/?target=http://blog.csdn.net/universus/article/details/6211589\">Android Binder 设计与实现 - 设计篇</a></li>\n<li><a href=\"https://link.zhihu.com/?target=http://blog.csdn.net/luoshengyang/article/details/6618363\">Android 进程间通信（IPC）机制 Binder 简要介绍和学习计划</a>、<a href=\"https://link.zhihu.com/?target=http://item.jd.com/12248208.html\">《Android 系统源代码情景分析》</a></li>\n<li><a href=\"https://link.zhihu.com/?target=http://weishu.me/2016/01/12/binder-index-for-newer/\">Binder 学习指南</a></li>\n<li><a href=\"https://link.zhihu.com/?target=http://gityuan.com/2015/10/31/binder-prepare/\">Binder 系列文章</a></li>\n<li><a href=\"https://link.zhihu.com/?target=https://blog.csdn.net/carson_ho/article/details/73560642\">Android 图文详解 Binder 跨进程通信原理</a></li>\n<li><a href=\"https://link.zhihu.com/?target=http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html\">Android 深入浅出之 Binder 机制</a></li>\n<li><a href=\"https://link.zhihu.com/?target=http://www.cnblogs.com/Anker/p/3269106.html\">用户空间与内核空间</a></li>\n<li><a href=\"https://link.zhihu.com/?target=https://www.cnblogs.com/huxiao-tee/p/4660352.html\">认真分析 mmap ：是什么 为什么 怎么用</a></li>\n</ul>\n"},{"layout":"post","title":"LaunchMode","author":"boybeak","date":"2022-09-18T23:00:00.000Z","_content":"\n此文是阅读[《Android 面试黑洞——当我按下 Home 键再切回来，会发生什么？》](https://zhuanlan.zhihu.com/p/265946165)一文后的总结，视频地址[Bilibili](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/BV1CA41177Se/)、[Youtube](https://link.zhihu.com/?target=https%3A//youtu.be/r4T9zkhpmII)。\n\n演示代码：\n\n在正式讲解launchMode前，先要理解三个概念：**ActivityStack**, **TaskRecord**, **ActivityRecord**。\n\n```mermaid\ngraph LR;\nstyle TaskRecord-A fill:#aaddff;\nstyle TaskRecord-B fill:#aaddff;\nsubgraph ActivityStack\nsubgraph TaskRecord-A\nA[ActivityRecord-1]\nB[ActivityRecord-2]\nend\nsubgraph TaskRecord-B\nC[ActivityRecord-3]\nD[ActivityRecord-4]\nend\nend\n```\n\n他们的一般结构是这样的。\n\n通过adb命令可以查看当前的ActivityStack、TaskRecord和ActivityRecord的结构。\n\n```powershell\nadb shell dumpsys activity\n```\n\n结果如下(搜索`ACTIVITY MANAGER STARTER (dumpsys activity containers)`)：\n\n```powershell\n...\n\nACTIVITY MANAGER STARTER (dumpsys activity containers)\ncom.android.server.am.ActivityStackSupervisor@299f1c5 type=undefined mode=fullscreen\n  #0 ActivityDisplay={0 numStacks=2} type=undefined mode=fullscreen\n   #1 ActivityStack{694271a stackId=0 type=home mode=fullscreen visible=true translucent=false, 1 tasks} type=home mode=fullscreen\n    #0 TaskRecord{e42980e #2 I=com.android.launcher3/.Launcher U=0 StackId=0 sz=1} type=home mode=fullscreen\n     #0 ActivityRecord{5efeaf4 u0 com.android.launcher3/.Launcher t2} type=home mode=fullscreen\n   #0 ActivityStack{91ac24b stackId=1 type=standard mode=fullscreen visible=false translucent=true, 1 tasks} type=standard mode=fullscreen\n    #0 TaskRecord{583322f #72 A=com.github.boybeak.hellolaunchmode U=0 StackId=1 sz=1} type=standard mode=fullscreen\n     #0 ActivityRecord{a126ec8 u0 com.github.boybeak.hellolaunchmode/.MainActivity t72} type=standard mode=fullscreen\n\n\n...\n```\n\n我们可以看到，此时有两个ActivityStack，索引为0的ActivityStack中，有一个TaskRecord，这个TaskRecord里有一个ActivityRecord，就是我们实验App的MainActivity；索引为1的ActivityStack为我们的Home界面。\n\n\n\n## 四种launchMode的一般行为\n\nLaunchMode共有4个值可以选择：**Standard**、**SingleTop**、**SingleTask**、**SingleInstance**。接下来将分开讲这4个值的作用，实际上，由于Activity的跳转会涉及到两个Activity，比如ActivityA -> ActivityB，ActivityB的跳转行为模式，不止受到自己launchMode的影响，还会受到ActivityA的launchMode的影响。除此以外，还会有其他属性的影响，比如`taskAffinity`、`allowTaskReparenting`、[`documentLaunchMode`](https://developer.android.com/guide/topics/manifest/activity-element#dlmode)等。\n\n**Standard**\n\n这是launchMode的值。它的默认行为是：在当前TaskRecord下创建新Activity。\n\n**SingleTop**\n\nSingleTop的行为是：如果有一个同类型的Activity在当前TaskRecord的栈顶，那么就直接使用这个栈顶的Activity并调用其`onNewIntent()`方法；如果栈顶没有同类型的Activity，则在栈顶创建一个对应的Activity。\n\n**SingleTask**\n\nSingleTask的行为是：在对应`taskAffinity`的TaskRecord中，如果已经有了对应类型的Activity，则直接使用该Activity，并调用`onNewIntent()`方法，如果有其他Activity压在该Activity上，则这些Activity都将出栈，该Activity重回栈顶；如果对应`taskAffinity`的TaskRecord中没有对应类型的Activity，则创建对应类型的Activity并压入栈顶。\n\n> 这里需要注意的是`taskAffinity`对该属性的影响，如果没有为`android:launchMode=\"singleTask\"`的Activity指定`taskAffinity`，则默认值为Application的`taskAffinity`，而Application的默认`taskAffinity`为包名。\n\n**SingleInstance**\n\nSingleInstance的行为是：1，只允许有一个栈中有此Activity，并且这个栈只允许有这一个Activity；2，如果已经有一个栈中有对应的Activity，则直接使用该Activity，并调用`onNewIntent()`方法。\n\n\n\n## SingleInstance对其他三种launchMode的影响\n\n由于SingleInstance是如此的霸道，导致从一个SingleInstance的Activity启动其他类型Activity的话，会改变其他三种模式的一般行为。\n\n**SingleInstanceA -> StandardB**\n\nStandardActivityB将无法在当前栈中创建，会回到默认栈中创建。\n\n**SingleInstanceA -> SingleTopB**\n\n这个行为就很复杂了，可以按照SingleTopB有无`taskAffinity`属性分为两种情况：\n\n- 无`taskAffinity`：则直接在默认的栈中，创建新的SingleTopB或者使用已经存在的SingleTopB。\n- 有`taskAffinity`：则在指定`taskAffinity`的栈中创建创建新的SingleTopB或者使用已经存在的SingleTopB。\n\n> 这里实际上存在一个更为复杂的行为模式：**StandardA -> SingleTopB -> SingleInstanceC -> SingleTopB**。\n>\n> 如果SingleTop有`taskAffinity`属性的话，情况就可以分为两个部分：\n>\n> **StandardA -> SingleTopB**：在StandardA相同TaskRecord中创建SingleTopB的实例singleTopB1。\n>\n> **SingleInstanceC -> SingleTopB**：在指定`taskAffinity`的TaskRecord中，创建SingleTopB的实例singleTopB2。\n>\n> 也就是说，此时有两个SingleTopB对象——singleTopB1和singleTopB2，分别在两个TaskRecord中。\n\n**SingleInstanceA -> SingleTaskB**\n\n比照**SingleInstanceA -> SingleTopB**的例子，同样可以可以按照SingleTaskB有无`taskAffinity`属性分为两种情况：\n\n- 无`taskAffinity`：则直接在默认的栈中，创建新的SingleTaskB或者使用已经存在的SingleTaskB。\n- 有`taskAffinity`：则在指定`taskAffinity`的栈中创建创建新的SingleTaskB或者使用已经存在的SingleTaskB。\n\n\n\n## 总结\n\n大体了解了不同launchMode的行为逻辑，他们的用途可以简单粗暴的归结如下规律：\n\n- standard和singleTop：多用于App内部；\n- singleInstance：多用于开放给外部App来共享使用；\n- singleTask：内部交互和外部调用都会用得上。\n\n当然，不能一概而论，还是要看具体需求。\n\n看起来似乎很复杂，其实只要掌握了`adb shell dumpsys activity`这个命令工具，就能清晰的看到当前Activity的分布情况，就能分析出，你的Activity应该用什么`launchMode`，要不要设置`taskAffinity`。\n\n## 参考文献\n\n[ActivityRecord、TaskRecord、ActivityStack以及Activity启动模式详解](https://www.jianshu.com/p/94816e52cd77)\n\n","source":"_posts/2022-09-19-LaunchMode.md","raw":"---\nlayout: post\ntitle: LaunchMode\nauthor: boybeak\ncategory: Android技巧\ntags: Android\ndate: 2022-09-19 07:00:00\n---\n\n此文是阅读[《Android 面试黑洞——当我按下 Home 键再切回来，会发生什么？》](https://zhuanlan.zhihu.com/p/265946165)一文后的总结，视频地址[Bilibili](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/BV1CA41177Se/)、[Youtube](https://link.zhihu.com/?target=https%3A//youtu.be/r4T9zkhpmII)。\n\n演示代码：\n\n在正式讲解launchMode前，先要理解三个概念：**ActivityStack**, **TaskRecord**, **ActivityRecord**。\n\n```mermaid\ngraph LR;\nstyle TaskRecord-A fill:#aaddff;\nstyle TaskRecord-B fill:#aaddff;\nsubgraph ActivityStack\nsubgraph TaskRecord-A\nA[ActivityRecord-1]\nB[ActivityRecord-2]\nend\nsubgraph TaskRecord-B\nC[ActivityRecord-3]\nD[ActivityRecord-4]\nend\nend\n```\n\n他们的一般结构是这样的。\n\n通过adb命令可以查看当前的ActivityStack、TaskRecord和ActivityRecord的结构。\n\n```powershell\nadb shell dumpsys activity\n```\n\n结果如下(搜索`ACTIVITY MANAGER STARTER (dumpsys activity containers)`)：\n\n```powershell\n...\n\nACTIVITY MANAGER STARTER (dumpsys activity containers)\ncom.android.server.am.ActivityStackSupervisor@299f1c5 type=undefined mode=fullscreen\n  #0 ActivityDisplay={0 numStacks=2} type=undefined mode=fullscreen\n   #1 ActivityStack{694271a stackId=0 type=home mode=fullscreen visible=true translucent=false, 1 tasks} type=home mode=fullscreen\n    #0 TaskRecord{e42980e #2 I=com.android.launcher3/.Launcher U=0 StackId=0 sz=1} type=home mode=fullscreen\n     #0 ActivityRecord{5efeaf4 u0 com.android.launcher3/.Launcher t2} type=home mode=fullscreen\n   #0 ActivityStack{91ac24b stackId=1 type=standard mode=fullscreen visible=false translucent=true, 1 tasks} type=standard mode=fullscreen\n    #0 TaskRecord{583322f #72 A=com.github.boybeak.hellolaunchmode U=0 StackId=1 sz=1} type=standard mode=fullscreen\n     #0 ActivityRecord{a126ec8 u0 com.github.boybeak.hellolaunchmode/.MainActivity t72} type=standard mode=fullscreen\n\n\n...\n```\n\n我们可以看到，此时有两个ActivityStack，索引为0的ActivityStack中，有一个TaskRecord，这个TaskRecord里有一个ActivityRecord，就是我们实验App的MainActivity；索引为1的ActivityStack为我们的Home界面。\n\n\n\n## 四种launchMode的一般行为\n\nLaunchMode共有4个值可以选择：**Standard**、**SingleTop**、**SingleTask**、**SingleInstance**。接下来将分开讲这4个值的作用，实际上，由于Activity的跳转会涉及到两个Activity，比如ActivityA -> ActivityB，ActivityB的跳转行为模式，不止受到自己launchMode的影响，还会受到ActivityA的launchMode的影响。除此以外，还会有其他属性的影响，比如`taskAffinity`、`allowTaskReparenting`、[`documentLaunchMode`](https://developer.android.com/guide/topics/manifest/activity-element#dlmode)等。\n\n**Standard**\n\n这是launchMode的值。它的默认行为是：在当前TaskRecord下创建新Activity。\n\n**SingleTop**\n\nSingleTop的行为是：如果有一个同类型的Activity在当前TaskRecord的栈顶，那么就直接使用这个栈顶的Activity并调用其`onNewIntent()`方法；如果栈顶没有同类型的Activity，则在栈顶创建一个对应的Activity。\n\n**SingleTask**\n\nSingleTask的行为是：在对应`taskAffinity`的TaskRecord中，如果已经有了对应类型的Activity，则直接使用该Activity，并调用`onNewIntent()`方法，如果有其他Activity压在该Activity上，则这些Activity都将出栈，该Activity重回栈顶；如果对应`taskAffinity`的TaskRecord中没有对应类型的Activity，则创建对应类型的Activity并压入栈顶。\n\n> 这里需要注意的是`taskAffinity`对该属性的影响，如果没有为`android:launchMode=\"singleTask\"`的Activity指定`taskAffinity`，则默认值为Application的`taskAffinity`，而Application的默认`taskAffinity`为包名。\n\n**SingleInstance**\n\nSingleInstance的行为是：1，只允许有一个栈中有此Activity，并且这个栈只允许有这一个Activity；2，如果已经有一个栈中有对应的Activity，则直接使用该Activity，并调用`onNewIntent()`方法。\n\n\n\n## SingleInstance对其他三种launchMode的影响\n\n由于SingleInstance是如此的霸道，导致从一个SingleInstance的Activity启动其他类型Activity的话，会改变其他三种模式的一般行为。\n\n**SingleInstanceA -> StandardB**\n\nStandardActivityB将无法在当前栈中创建，会回到默认栈中创建。\n\n**SingleInstanceA -> SingleTopB**\n\n这个行为就很复杂了，可以按照SingleTopB有无`taskAffinity`属性分为两种情况：\n\n- 无`taskAffinity`：则直接在默认的栈中，创建新的SingleTopB或者使用已经存在的SingleTopB。\n- 有`taskAffinity`：则在指定`taskAffinity`的栈中创建创建新的SingleTopB或者使用已经存在的SingleTopB。\n\n> 这里实际上存在一个更为复杂的行为模式：**StandardA -> SingleTopB -> SingleInstanceC -> SingleTopB**。\n>\n> 如果SingleTop有`taskAffinity`属性的话，情况就可以分为两个部分：\n>\n> **StandardA -> SingleTopB**：在StandardA相同TaskRecord中创建SingleTopB的实例singleTopB1。\n>\n> **SingleInstanceC -> SingleTopB**：在指定`taskAffinity`的TaskRecord中，创建SingleTopB的实例singleTopB2。\n>\n> 也就是说，此时有两个SingleTopB对象——singleTopB1和singleTopB2，分别在两个TaskRecord中。\n\n**SingleInstanceA -> SingleTaskB**\n\n比照**SingleInstanceA -> SingleTopB**的例子，同样可以可以按照SingleTaskB有无`taskAffinity`属性分为两种情况：\n\n- 无`taskAffinity`：则直接在默认的栈中，创建新的SingleTaskB或者使用已经存在的SingleTaskB。\n- 有`taskAffinity`：则在指定`taskAffinity`的栈中创建创建新的SingleTaskB或者使用已经存在的SingleTaskB。\n\n\n\n## 总结\n\n大体了解了不同launchMode的行为逻辑，他们的用途可以简单粗暴的归结如下规律：\n\n- standard和singleTop：多用于App内部；\n- singleInstance：多用于开放给外部App来共享使用；\n- singleTask：内部交互和外部调用都会用得上。\n\n当然，不能一概而论，还是要看具体需求。\n\n看起来似乎很复杂，其实只要掌握了`adb shell dumpsys activity`这个命令工具，就能清晰的看到当前Activity的分布情况，就能分析出，你的Activity应该用什么`launchMode`，要不要设置`taskAffinity`。\n\n## 参考文献\n\n[ActivityRecord、TaskRecord、ActivityStack以及Activity启动模式详解](https://www.jianshu.com/p/94816e52cd77)\n\n","slug":"2022-09-19-LaunchMode","published":1,"updated":"2024-11-13T13:41:48.898Z","_id":"cm1ltr0g10019bji0hk1z5s8w","comments":1,"photos":[],"content":"<p>此文是阅读<a href=\"https://zhuanlan.zhihu.com/p/265946165\">《Android 面试黑洞——当我按下 Home 键再切回来，会发生什么？》</a>一文后的总结，视频地址<a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/BV1CA41177Se/\">Bilibili</a>、<a href=\"https://link.zhihu.com/?target=https://youtu.be/r4T9zkhpmII\">Youtube</a>。</p>\n<p>演示代码：</p>\n<p>在正式讲解launchMode前，先要理解三个概念：<strong>ActivityStack</strong>, <strong>TaskRecord</strong>, <strong>ActivityRecord</strong>。</p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> LR<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">style</span> TaskRecord-A <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#aaddff</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">style</span> TaskRecord-B <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#aaddff</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> ActivityStack\n<span class=\"token keyword\">subgraph</span> TaskRecord-A\nA<span class=\"token text string\">[ActivityRecord-1]</span>\nB<span class=\"token text string\">[ActivityRecord-2]</span>\n<span class=\"token keyword\">end</span>\n<span class=\"token keyword\">subgraph</span> TaskRecord-B\nC<span class=\"token text string\">[ActivityRecord-3]</span>\nD<span class=\"token text string\">[ActivityRecord-4]</span>\n<span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre>\n\n<p>他们的一般结构是这样的。</p>\n<p>通过adb命令可以查看当前的ActivityStack、TaskRecord和ActivityRecord的结构。</p>\n<pre class=\"language-powershell\" data-language=\"powershell\"><code class=\"language-powershell\">adb shell dumpsys activity</code></pre>\n\n<p>结果如下(搜索<code>ACTIVITY MANAGER STARTER (dumpsys activity containers)</code>)：</p>\n<pre class=\"language-powershell\" data-language=\"powershell\"><code class=\"language-powershell\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\nACTIVITY MANAGER STARTER <span class=\"token punctuation\">(</span>dumpsys activity containers<span class=\"token punctuation\">)</span>\ncom<span class=\"token punctuation\">.</span>android<span class=\"token punctuation\">.</span>server<span class=\"token punctuation\">.</span>am<span class=\"token punctuation\">.</span>ActivityStackSupervisor@299f1c5 <span class=\"token function\">type</span>=undefined mode=fullscreen\n  <span class=\"token comment\">#0 ActivityDisplay=&#123;0 numStacks=2&#125; type=undefined mode=fullscreen</span>\n   <span class=\"token comment\">#1 ActivityStack&#123;694271a stackId=0 type=home mode=fullscreen visible=true translucent=false, 1 tasks&#125; type=home mode=fullscreen</span>\n    <span class=\"token comment\">#0 TaskRecord&#123;e42980e #2 I=com.android.launcher3/.Launcher U=0 StackId=0 sz=1&#125; type=home mode=fullscreen</span>\n     <span class=\"token comment\">#0 ActivityRecord&#123;5efeaf4 u0 com.android.launcher3/.Launcher t2&#125; type=home mode=fullscreen</span>\n   <span class=\"token comment\">#0 ActivityStack&#123;91ac24b stackId=1 type=standard mode=fullscreen visible=false translucent=true, 1 tasks&#125; type=standard mode=fullscreen</span>\n    <span class=\"token comment\">#0 TaskRecord&#123;583322f #72 A=com.github.boybeak.hellolaunchmode U=0 StackId=1 sz=1&#125; type=standard mode=fullscreen</span>\n     <span class=\"token comment\">#0 ActivityRecord&#123;a126ec8 u0 com.github.boybeak.hellolaunchmode/.MainActivity t72&#125; type=standard mode=fullscreen</span>\n\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre>\n\n<p>我们可以看到，此时有两个ActivityStack，索引为0的ActivityStack中，有一个TaskRecord，这个TaskRecord里有一个ActivityRecord，就是我们实验App的MainActivity；索引为1的ActivityStack为我们的Home界面。</p>\n<h2 id=\"四种launchMode的一般行为\"><a href=\"#四种launchMode的一般行为\" class=\"headerlink\" title=\"四种launchMode的一般行为\"></a>四种launchMode的一般行为</h2><p>LaunchMode共有4个值可以选择：<strong>Standard</strong>、<strong>SingleTop</strong>、<strong>SingleTask</strong>、<strong>SingleInstance</strong>。接下来将分开讲这4个值的作用，实际上，由于Activity的跳转会涉及到两个Activity，比如ActivityA -&gt; ActivityB，ActivityB的跳转行为模式，不止受到自己launchMode的影响，还会受到ActivityA的launchMode的影响。除此以外，还会有其他属性的影响，比如<code>taskAffinity</code>、<code>allowTaskReparenting</code>、<a href=\"https://developer.android.com/guide/topics/manifest/activity-element#dlmode\"><code>documentLaunchMode</code></a>等。</p>\n<p><strong>Standard</strong></p>\n<p>这是launchMode的值。它的默认行为是：在当前TaskRecord下创建新Activity。</p>\n<p><strong>SingleTop</strong></p>\n<p>SingleTop的行为是：如果有一个同类型的Activity在当前TaskRecord的栈顶，那么就直接使用这个栈顶的Activity并调用其<code>onNewIntent()</code>方法；如果栈顶没有同类型的Activity，则在栈顶创建一个对应的Activity。</p>\n<p><strong>SingleTask</strong></p>\n<p>SingleTask的行为是：在对应<code>taskAffinity</code>的TaskRecord中，如果已经有了对应类型的Activity，则直接使用该Activity，并调用<code>onNewIntent()</code>方法，如果有其他Activity压在该Activity上，则这些Activity都将出栈，该Activity重回栈顶；如果对应<code>taskAffinity</code>的TaskRecord中没有对应类型的Activity，则创建对应类型的Activity并压入栈顶。</p>\n<blockquote>\n<p>这里需要注意的是<code>taskAffinity</code>对该属性的影响，如果没有为<code>android:launchMode=&quot;singleTask&quot;</code>的Activity指定<code>taskAffinity</code>，则默认值为Application的<code>taskAffinity</code>，而Application的默认<code>taskAffinity</code>为包名。</p>\n</blockquote>\n<p><strong>SingleInstance</strong></p>\n<p>SingleInstance的行为是：1，只允许有一个栈中有此Activity，并且这个栈只允许有这一个Activity；2，如果已经有一个栈中有对应的Activity，则直接使用该Activity，并调用<code>onNewIntent()</code>方法。</p>\n<h2 id=\"SingleInstance对其他三种launchMode的影响\"><a href=\"#SingleInstance对其他三种launchMode的影响\" class=\"headerlink\" title=\"SingleInstance对其他三种launchMode的影响\"></a>SingleInstance对其他三种launchMode的影响</h2><p>由于SingleInstance是如此的霸道，导致从一个SingleInstance的Activity启动其他类型Activity的话，会改变其他三种模式的一般行为。</p>\n<p><strong>SingleInstanceA -&gt; StandardB</strong></p>\n<p>StandardActivityB将无法在当前栈中创建，会回到默认栈中创建。</p>\n<p><strong>SingleInstanceA -&gt; SingleTopB</strong></p>\n<p>这个行为就很复杂了，可以按照SingleTopB有无<code>taskAffinity</code>属性分为两种情况：</p>\n<ul>\n<li>无<code>taskAffinity</code>：则直接在默认的栈中，创建新的SingleTopB或者使用已经存在的SingleTopB。</li>\n<li>有<code>taskAffinity</code>：则在指定<code>taskAffinity</code>的栈中创建创建新的SingleTopB或者使用已经存在的SingleTopB。</li>\n</ul>\n<blockquote>\n<p>这里实际上存在一个更为复杂的行为模式：<strong>StandardA -&gt; SingleTopB -&gt; SingleInstanceC -&gt; SingleTopB</strong>。</p>\n<p>如果SingleTop有<code>taskAffinity</code>属性的话，情况就可以分为两个部分：</p>\n<p><strong>StandardA -&gt; SingleTopB</strong>：在StandardA相同TaskRecord中创建SingleTopB的实例singleTopB1。</p>\n<p><strong>SingleInstanceC -&gt; SingleTopB</strong>：在指定<code>taskAffinity</code>的TaskRecord中，创建SingleTopB的实例singleTopB2。</p>\n<p>也就是说，此时有两个SingleTopB对象——singleTopB1和singleTopB2，分别在两个TaskRecord中。</p>\n</blockquote>\n<p><strong>SingleInstanceA -&gt; SingleTaskB</strong></p>\n<p>比照<strong>SingleInstanceA -&gt; SingleTopB</strong>的例子，同样可以可以按照SingleTaskB有无<code>taskAffinity</code>属性分为两种情况：</p>\n<ul>\n<li>无<code>taskAffinity</code>：则直接在默认的栈中，创建新的SingleTaskB或者使用已经存在的SingleTaskB。</li>\n<li>有<code>taskAffinity</code>：则在指定<code>taskAffinity</code>的栈中创建创建新的SingleTaskB或者使用已经存在的SingleTaskB。</li>\n</ul>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>大体了解了不同launchMode的行为逻辑，他们的用途可以简单粗暴的归结如下规律：</p>\n<ul>\n<li>standard和singleTop：多用于App内部；</li>\n<li>singleInstance：多用于开放给外部App来共享使用；</li>\n<li>singleTask：内部交互和外部调用都会用得上。</li>\n</ul>\n<p>当然，不能一概而论，还是要看具体需求。</p>\n<p>看起来似乎很复杂，其实只要掌握了<code>adb shell dumpsys activity</code>这个命令工具，就能清晰的看到当前Activity的分布情况，就能分析出，你的Activity应该用什么<code>launchMode</code>，要不要设置<code>taskAffinity</code>。</p>\n<h2 id=\"参考文献\"><a href=\"#参考文献\" class=\"headerlink\" title=\"参考文献\"></a>参考文献</h2><p><a href=\"https://www.jianshu.com/p/94816e52cd77\">ActivityRecord、TaskRecord、ActivityStack以及Activity启动模式详解</a></p>\n","excerpt":"","more":"<p>此文是阅读<a href=\"https://zhuanlan.zhihu.com/p/265946165\">《Android 面试黑洞——当我按下 Home 键再切回来，会发生什么？》</a>一文后的总结，视频地址<a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/BV1CA41177Se/\">Bilibili</a>、<a href=\"https://link.zhihu.com/?target=https://youtu.be/r4T9zkhpmII\">Youtube</a>。</p>\n<p>演示代码：</p>\n<p>在正式讲解launchMode前，先要理解三个概念：<strong>ActivityStack</strong>, <strong>TaskRecord</strong>, <strong>ActivityRecord</strong>。</p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> LR<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">style</span> TaskRecord-A <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#aaddff</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">style</span> TaskRecord-B <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#aaddff</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> ActivityStack\n<span class=\"token keyword\">subgraph</span> TaskRecord-A\nA<span class=\"token text string\">[ActivityRecord-1]</span>\nB<span class=\"token text string\">[ActivityRecord-2]</span>\n<span class=\"token keyword\">end</span>\n<span class=\"token keyword\">subgraph</span> TaskRecord-B\nC<span class=\"token text string\">[ActivityRecord-3]</span>\nD<span class=\"token text string\">[ActivityRecord-4]</span>\n<span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre>\n\n<p>他们的一般结构是这样的。</p>\n<p>通过adb命令可以查看当前的ActivityStack、TaskRecord和ActivityRecord的结构。</p>\n<pre class=\"language-powershell\" data-language=\"powershell\"><code class=\"language-powershell\">adb shell dumpsys activity</code></pre>\n\n<p>结果如下(搜索<code>ACTIVITY MANAGER STARTER (dumpsys activity containers)</code>)：</p>\n<pre class=\"language-powershell\" data-language=\"powershell\"><code class=\"language-powershell\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\nACTIVITY MANAGER STARTER <span class=\"token punctuation\">(</span>dumpsys activity containers<span class=\"token punctuation\">)</span>\ncom<span class=\"token punctuation\">.</span>android<span class=\"token punctuation\">.</span>server<span class=\"token punctuation\">.</span>am<span class=\"token punctuation\">.</span>ActivityStackSupervisor@299f1c5 <span class=\"token function\">type</span>=undefined mode=fullscreen\n  <span class=\"token comment\">#0 ActivityDisplay=&#123;0 numStacks=2&#125; type=undefined mode=fullscreen</span>\n   <span class=\"token comment\">#1 ActivityStack&#123;694271a stackId=0 type=home mode=fullscreen visible=true translucent=false, 1 tasks&#125; type=home mode=fullscreen</span>\n    <span class=\"token comment\">#0 TaskRecord&#123;e42980e #2 I=com.android.launcher3/.Launcher U=0 StackId=0 sz=1&#125; type=home mode=fullscreen</span>\n     <span class=\"token comment\">#0 ActivityRecord&#123;5efeaf4 u0 com.android.launcher3/.Launcher t2&#125; type=home mode=fullscreen</span>\n   <span class=\"token comment\">#0 ActivityStack&#123;91ac24b stackId=1 type=standard mode=fullscreen visible=false translucent=true, 1 tasks&#125; type=standard mode=fullscreen</span>\n    <span class=\"token comment\">#0 TaskRecord&#123;583322f #72 A=com.github.boybeak.hellolaunchmode U=0 StackId=1 sz=1&#125; type=standard mode=fullscreen</span>\n     <span class=\"token comment\">#0 ActivityRecord&#123;a126ec8 u0 com.github.boybeak.hellolaunchmode/.MainActivity t72&#125; type=standard mode=fullscreen</span>\n\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre>\n\n<p>我们可以看到，此时有两个ActivityStack，索引为0的ActivityStack中，有一个TaskRecord，这个TaskRecord里有一个ActivityRecord，就是我们实验App的MainActivity；索引为1的ActivityStack为我们的Home界面。</p>\n<h2 id=\"四种launchMode的一般行为\"><a href=\"#四种launchMode的一般行为\" class=\"headerlink\" title=\"四种launchMode的一般行为\"></a>四种launchMode的一般行为</h2><p>LaunchMode共有4个值可以选择：<strong>Standard</strong>、<strong>SingleTop</strong>、<strong>SingleTask</strong>、<strong>SingleInstance</strong>。接下来将分开讲这4个值的作用，实际上，由于Activity的跳转会涉及到两个Activity，比如ActivityA -&gt; ActivityB，ActivityB的跳转行为模式，不止受到自己launchMode的影响，还会受到ActivityA的launchMode的影响。除此以外，还会有其他属性的影响，比如<code>taskAffinity</code>、<code>allowTaskReparenting</code>、<a href=\"https://developer.android.com/guide/topics/manifest/activity-element#dlmode\"><code>documentLaunchMode</code></a>等。</p>\n<p><strong>Standard</strong></p>\n<p>这是launchMode的值。它的默认行为是：在当前TaskRecord下创建新Activity。</p>\n<p><strong>SingleTop</strong></p>\n<p>SingleTop的行为是：如果有一个同类型的Activity在当前TaskRecord的栈顶，那么就直接使用这个栈顶的Activity并调用其<code>onNewIntent()</code>方法；如果栈顶没有同类型的Activity，则在栈顶创建一个对应的Activity。</p>\n<p><strong>SingleTask</strong></p>\n<p>SingleTask的行为是：在对应<code>taskAffinity</code>的TaskRecord中，如果已经有了对应类型的Activity，则直接使用该Activity，并调用<code>onNewIntent()</code>方法，如果有其他Activity压在该Activity上，则这些Activity都将出栈，该Activity重回栈顶；如果对应<code>taskAffinity</code>的TaskRecord中没有对应类型的Activity，则创建对应类型的Activity并压入栈顶。</p>\n<blockquote>\n<p>这里需要注意的是<code>taskAffinity</code>对该属性的影响，如果没有为<code>android:launchMode=&quot;singleTask&quot;</code>的Activity指定<code>taskAffinity</code>，则默认值为Application的<code>taskAffinity</code>，而Application的默认<code>taskAffinity</code>为包名。</p>\n</blockquote>\n<p><strong>SingleInstance</strong></p>\n<p>SingleInstance的行为是：1，只允许有一个栈中有此Activity，并且这个栈只允许有这一个Activity；2，如果已经有一个栈中有对应的Activity，则直接使用该Activity，并调用<code>onNewIntent()</code>方法。</p>\n<h2 id=\"SingleInstance对其他三种launchMode的影响\"><a href=\"#SingleInstance对其他三种launchMode的影响\" class=\"headerlink\" title=\"SingleInstance对其他三种launchMode的影响\"></a>SingleInstance对其他三种launchMode的影响</h2><p>由于SingleInstance是如此的霸道，导致从一个SingleInstance的Activity启动其他类型Activity的话，会改变其他三种模式的一般行为。</p>\n<p><strong>SingleInstanceA -&gt; StandardB</strong></p>\n<p>StandardActivityB将无法在当前栈中创建，会回到默认栈中创建。</p>\n<p><strong>SingleInstanceA -&gt; SingleTopB</strong></p>\n<p>这个行为就很复杂了，可以按照SingleTopB有无<code>taskAffinity</code>属性分为两种情况：</p>\n<ul>\n<li>无<code>taskAffinity</code>：则直接在默认的栈中，创建新的SingleTopB或者使用已经存在的SingleTopB。</li>\n<li>有<code>taskAffinity</code>：则在指定<code>taskAffinity</code>的栈中创建创建新的SingleTopB或者使用已经存在的SingleTopB。</li>\n</ul>\n<blockquote>\n<p>这里实际上存在一个更为复杂的行为模式：<strong>StandardA -&gt; SingleTopB -&gt; SingleInstanceC -&gt; SingleTopB</strong>。</p>\n<p>如果SingleTop有<code>taskAffinity</code>属性的话，情况就可以分为两个部分：</p>\n<p><strong>StandardA -&gt; SingleTopB</strong>：在StandardA相同TaskRecord中创建SingleTopB的实例singleTopB1。</p>\n<p><strong>SingleInstanceC -&gt; SingleTopB</strong>：在指定<code>taskAffinity</code>的TaskRecord中，创建SingleTopB的实例singleTopB2。</p>\n<p>也就是说，此时有两个SingleTopB对象——singleTopB1和singleTopB2，分别在两个TaskRecord中。</p>\n</blockquote>\n<p><strong>SingleInstanceA -&gt; SingleTaskB</strong></p>\n<p>比照<strong>SingleInstanceA -&gt; SingleTopB</strong>的例子，同样可以可以按照SingleTaskB有无<code>taskAffinity</code>属性分为两种情况：</p>\n<ul>\n<li>无<code>taskAffinity</code>：则直接在默认的栈中，创建新的SingleTaskB或者使用已经存在的SingleTaskB。</li>\n<li>有<code>taskAffinity</code>：则在指定<code>taskAffinity</code>的栈中创建创建新的SingleTaskB或者使用已经存在的SingleTaskB。</li>\n</ul>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>大体了解了不同launchMode的行为逻辑，他们的用途可以简单粗暴的归结如下规律：</p>\n<ul>\n<li>standard和singleTop：多用于App内部；</li>\n<li>singleInstance：多用于开放给外部App来共享使用；</li>\n<li>singleTask：内部交互和外部调用都会用得上。</li>\n</ul>\n<p>当然，不能一概而论，还是要看具体需求。</p>\n<p>看起来似乎很复杂，其实只要掌握了<code>adb shell dumpsys activity</code>这个命令工具，就能清晰的看到当前Activity的分布情况，就能分析出，你的Activity应该用什么<code>launchMode</code>，要不要设置<code>taskAffinity</code>。</p>\n<h2 id=\"参考文献\"><a href=\"#参考文献\" class=\"headerlink\" title=\"参考文献\"></a>参考文献</h2><p><a href=\"https://www.jianshu.com/p/94816e52cd77\">ActivityRecord、TaskRecord、ActivityStack以及Activity启动模式详解</a></p>\n"},{"layout":"post","title":"Intent.FLAG_ACTIVITY_***解密","date":"2022-09-19T07:26:00.000Z","author":"boybeak","_content":"\n最好先看这一篇[Launch Mode]({{$site.base_url}}/android/LaunchMode.html)。\n\n我们将重点针对**FLAG_ACTIVITY_NEW_TASK**、**FLAG_ACTIVITY_CLEAR_TASK**、**FLAG_ACTIVITY_CLEAR_TOP**、**FLAG_ACTIVITY_SINGLE_TOP**四个flag进行讲解。\n\n[**FLAG_ACTIVITY_NEW_TASK**](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_NEW_TASK)：\n\n1. 通过非Activity的Context启动一个Activity时候，要使用此flag，比如：ApplicationContext、Service等；\n2. 用于Launcher类应用启动其他应用的时候；\n3. 当试图通过这个flag启动一个activity的时候，如果后台已经有一个任务栈中有运行的一个此类activity实例，将不会创建一个新的activity，而是将整个栈置于前台，并保持上次的状态。比如从另一个应用启动这种场景，或者Notification中。\n4. 如果你想使用startActivityForResult，则**千万不要**在启动的intent添加这个flag。因为onActivityResult回调方法，不会在目标activity执行finish后调用，而是在启动目标activity的时候直接调用，并且收r到resultCode = `RESULT_CANCELED`。\n\n[**FLAG_ACTIVITY_CLEAR_TOP**](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_CLEAR_TOP)：\n\n1. 如果在当前任务栈中已经有了目标类型activity，则再次通过添加了此flag的intent去启动此类型activity，会有两种情况。\n   \n   比如有如下图示结构的任务栈:\n\n```mermaid\ngraph LR;\nsubgraph Task;\nD;\nC;\nB;\nA;\nend;\n```\n\n   此时D通过一个添加了`FLAG_ACTIVITY_CLEAR_TOP`的intent去启动了B类型Activity，则C、D执行onDestroy出栈（不会执行finish，触发onDestroy），现在B在栈顶，有如下图示：\n\n```mermaid\ngraph LR;\nsubgraph Task;\nB;\nA;\nend;\n```\n\n   接下来就有两种情况了。\n\n   情况一：intent中**没有**同时设置`FLAG_ACTIVITY_SINGLE_TOP`，并且B的launchMode是默认值。\n\n   B会finish掉再re-create一个新的B'放在B的位置上。\n\n   情况二：intent中设置了`FLAG_ACTIVITY_SINGLE_TOP`或者是其他类型的launchMode。\n\n   B不会finish（调用finish方法，onDestroy会被触发）掉，而是直接调用其onNewIntent()方法。\n\n> 或许你认为情况二这与launchMode中的singleTop或者singleTask类似，实则不然，其一，singleTop没有清空压在它上边activity的能力；其二，singleTask收到taskAffinity影响。\n\n2. 与`FLAG_ACTIVITY_NEW_TASK`配合使用。如果想启动一个任务栈的root位置的activity，也就是栈低activity，同时设置这两个值，它会将整个任务栈放置于前台，并且清空其他activit，适用于从Notification启动Activity。\n\n[**FLAG_ACTIVITY_CLEAR_TASK**](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_CLEAR_TASK)：这个flag很特殊，只能于`FLAG_ACTIVITY_NEW_TASK`配合使用。要启动的目标activity的任务栈如果已经存在并且不为空，则将所有activity出栈（不会调用finish方法，onDestroy会被触发），然后创建一个目标类型activity作为这个栈的root。\n\n[**FLAG_ACTIVITY_SINGLE_TOP**](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_SINGLE_TOP)：这个flag与launchMode中的singleTop几乎一样，当要启动一个activity时候，如果栈顶就是目标类型activity，则不会创建一个新的activity，而是直接调用栈顶的这个activity的onNewIntent()方法。\n","source":"_posts/2022-09-19-Intent.FLAG_ACTIVITY_XXX到底能干啥.md","raw":"---\nlayout: post\ntitle: Intent.FLAG_ACTIVITY_***解密\ndate: 2022-09-19 15:26:00\nauthor: boybeak\ncategory: Android技巧\ntags: Android\n---\n\n最好先看这一篇[Launch Mode]({{$site.base_url}}/android/LaunchMode.html)。\n\n我们将重点针对**FLAG_ACTIVITY_NEW_TASK**、**FLAG_ACTIVITY_CLEAR_TASK**、**FLAG_ACTIVITY_CLEAR_TOP**、**FLAG_ACTIVITY_SINGLE_TOP**四个flag进行讲解。\n\n[**FLAG_ACTIVITY_NEW_TASK**](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_NEW_TASK)：\n\n1. 通过非Activity的Context启动一个Activity时候，要使用此flag，比如：ApplicationContext、Service等；\n2. 用于Launcher类应用启动其他应用的时候；\n3. 当试图通过这个flag启动一个activity的时候，如果后台已经有一个任务栈中有运行的一个此类activity实例，将不会创建一个新的activity，而是将整个栈置于前台，并保持上次的状态。比如从另一个应用启动这种场景，或者Notification中。\n4. 如果你想使用startActivityForResult，则**千万不要**在启动的intent添加这个flag。因为onActivityResult回调方法，不会在目标activity执行finish后调用，而是在启动目标activity的时候直接调用，并且收r到resultCode = `RESULT_CANCELED`。\n\n[**FLAG_ACTIVITY_CLEAR_TOP**](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_CLEAR_TOP)：\n\n1. 如果在当前任务栈中已经有了目标类型activity，则再次通过添加了此flag的intent去启动此类型activity，会有两种情况。\n   \n   比如有如下图示结构的任务栈:\n\n```mermaid\ngraph LR;\nsubgraph Task;\nD;\nC;\nB;\nA;\nend;\n```\n\n   此时D通过一个添加了`FLAG_ACTIVITY_CLEAR_TOP`的intent去启动了B类型Activity，则C、D执行onDestroy出栈（不会执行finish，触发onDestroy），现在B在栈顶，有如下图示：\n\n```mermaid\ngraph LR;\nsubgraph Task;\nB;\nA;\nend;\n```\n\n   接下来就有两种情况了。\n\n   情况一：intent中**没有**同时设置`FLAG_ACTIVITY_SINGLE_TOP`，并且B的launchMode是默认值。\n\n   B会finish掉再re-create一个新的B'放在B的位置上。\n\n   情况二：intent中设置了`FLAG_ACTIVITY_SINGLE_TOP`或者是其他类型的launchMode。\n\n   B不会finish（调用finish方法，onDestroy会被触发）掉，而是直接调用其onNewIntent()方法。\n\n> 或许你认为情况二这与launchMode中的singleTop或者singleTask类似，实则不然，其一，singleTop没有清空压在它上边activity的能力；其二，singleTask收到taskAffinity影响。\n\n2. 与`FLAG_ACTIVITY_NEW_TASK`配合使用。如果想启动一个任务栈的root位置的activity，也就是栈低activity，同时设置这两个值，它会将整个任务栈放置于前台，并且清空其他activit，适用于从Notification启动Activity。\n\n[**FLAG_ACTIVITY_CLEAR_TASK**](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_CLEAR_TASK)：这个flag很特殊，只能于`FLAG_ACTIVITY_NEW_TASK`配合使用。要启动的目标activity的任务栈如果已经存在并且不为空，则将所有activity出栈（不会调用finish方法，onDestroy会被触发），然后创建一个目标类型activity作为这个栈的root。\n\n[**FLAG_ACTIVITY_SINGLE_TOP**](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_SINGLE_TOP)：这个flag与launchMode中的singleTop几乎一样，当要启动一个activity时候，如果栈顶就是目标类型activity，则不会创建一个新的activity，而是直接调用栈顶的这个activity的onNewIntent()方法。\n","slug":"2022-09-19-Intent.FLAG_ACTIVITY_XXX到底能干啥","published":1,"updated":"2024-11-14T03:08:06.157Z","_id":"cm1ltr0g1001cbji07j9j4rg2","comments":1,"photos":[],"content":"<p>最好先看这一篇[Launch Mode](&#x2F;android&#x2F;LaunchMode.html)。</p>\n<p>我们将重点针对<strong>FLAG_ACTIVITY_NEW_TASK</strong>、<strong>FLAG_ACTIVITY_CLEAR_TASK</strong>、<strong>FLAG_ACTIVITY_CLEAR_TOP</strong>、<strong>FLAG_ACTIVITY_SINGLE_TOP</strong>四个flag进行讲解。</p>\n<p><a href=\"https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_NEW_TASK\"><strong>FLAG_ACTIVITY_NEW_TASK</strong></a>：</p>\n<ol>\n<li>通过非Activity的Context启动一个Activity时候，要使用此flag，比如：ApplicationContext、Service等；</li>\n<li>用于Launcher类应用启动其他应用的时候；</li>\n<li>当试图通过这个flag启动一个activity的时候，如果后台已经有一个任务栈中有运行的一个此类activity实例，将不会创建一个新的activity，而是将整个栈置于前台，并保持上次的状态。比如从另一个应用启动这种场景，或者Notification中。</li>\n<li>如果你想使用startActivityForResult，则<strong>千万不要</strong>在启动的intent添加这个flag。因为onActivityResult回调方法，不会在目标activity执行finish后调用，而是在启动目标activity的时候直接调用，并且收r到resultCode &#x3D; <code>RESULT_CANCELED</code>。</li>\n</ol>\n<p><a href=\"https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_CLEAR_TOP\"><strong>FLAG_ACTIVITY_CLEAR_TOP</strong></a>：</p>\n<ol>\n<li><p>如果在当前任务栈中已经有了目标类型activity，则再次通过添加了此flag的intent去启动此类型activity，会有两种情况。</p>\n<p>比如有如下图示结构的任务栈:</p>\n</li>\n</ol>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> LR<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> Task<span class=\"token punctuation\">;</span>\nD<span class=\"token punctuation\">;</span>\nC<span class=\"token punctuation\">;</span>\nB<span class=\"token punctuation\">;</span>\nA<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>   此时D通过一个添加了<code>FLAG_ACTIVITY_CLEAR_TOP</code>的intent去启动了B类型Activity，则C、D执行onDestroy出栈（不会执行finish，触发onDestroy），现在B在栈顶，有如下图示：</p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> LR<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> Task<span class=\"token punctuation\">;</span>\nB<span class=\"token punctuation\">;</span>\nA<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>   接下来就有两种情况了。</p>\n<p>   情况一：intent中<strong>没有</strong>同时设置<code>FLAG_ACTIVITY_SINGLE_TOP</code>，并且B的launchMode是默认值。</p>\n<p>   B会finish掉再re-create一个新的B’放在B的位置上。</p>\n<p>   情况二：intent中设置了<code>FLAG_ACTIVITY_SINGLE_TOP</code>或者是其他类型的launchMode。</p>\n<p>   B不会finish（调用finish方法，onDestroy会被触发）掉，而是直接调用其onNewIntent()方法。</p>\n<blockquote>\n<p>或许你认为情况二这与launchMode中的singleTop或者singleTask类似，实则不然，其一，singleTop没有清空压在它上边activity的能力；其二，singleTask收到taskAffinity影响。</p>\n</blockquote>\n<ol start=\"2\">\n<li>与<code>FLAG_ACTIVITY_NEW_TASK</code>配合使用。如果想启动一个任务栈的root位置的activity，也就是栈低activity，同时设置这两个值，它会将整个任务栈放置于前台，并且清空其他activit，适用于从Notification启动Activity。</li>\n</ol>\n<p><a href=\"https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_CLEAR_TASK\"><strong>FLAG_ACTIVITY_CLEAR_TASK</strong></a>：这个flag很特殊，只能于<code>FLAG_ACTIVITY_NEW_TASK</code>配合使用。要启动的目标activity的任务栈如果已经存在并且不为空，则将所有activity出栈（不会调用finish方法，onDestroy会被触发），然后创建一个目标类型activity作为这个栈的root。</p>\n<p><a href=\"https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_SINGLE_TOP\"><strong>FLAG_ACTIVITY_SINGLE_TOP</strong></a>：这个flag与launchMode中的singleTop几乎一样，当要启动一个activity时候，如果栈顶就是目标类型activity，则不会创建一个新的activity，而是直接调用栈顶的这个activity的onNewIntent()方法。</p>\n","excerpt":"","more":"<p>最好先看这一篇[Launch Mode](&#x2F;android&#x2F;LaunchMode.html)。</p>\n<p>我们将重点针对<strong>FLAG_ACTIVITY_NEW_TASK</strong>、<strong>FLAG_ACTIVITY_CLEAR_TASK</strong>、<strong>FLAG_ACTIVITY_CLEAR_TOP</strong>、<strong>FLAG_ACTIVITY_SINGLE_TOP</strong>四个flag进行讲解。</p>\n<p><a href=\"https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_NEW_TASK\"><strong>FLAG_ACTIVITY_NEW_TASK</strong></a>：</p>\n<ol>\n<li>通过非Activity的Context启动一个Activity时候，要使用此flag，比如：ApplicationContext、Service等；</li>\n<li>用于Launcher类应用启动其他应用的时候；</li>\n<li>当试图通过这个flag启动一个activity的时候，如果后台已经有一个任务栈中有运行的一个此类activity实例，将不会创建一个新的activity，而是将整个栈置于前台，并保持上次的状态。比如从另一个应用启动这种场景，或者Notification中。</li>\n<li>如果你想使用startActivityForResult，则<strong>千万不要</strong>在启动的intent添加这个flag。因为onActivityResult回调方法，不会在目标activity执行finish后调用，而是在启动目标activity的时候直接调用，并且收r到resultCode &#x3D; <code>RESULT_CANCELED</code>。</li>\n</ol>\n<p><a href=\"https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_CLEAR_TOP\"><strong>FLAG_ACTIVITY_CLEAR_TOP</strong></a>：</p>\n<ol>\n<li><p>如果在当前任务栈中已经有了目标类型activity，则再次通过添加了此flag的intent去启动此类型activity，会有两种情况。</p>\n<p>比如有如下图示结构的任务栈:</p>\n</li>\n</ol>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> LR<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> Task<span class=\"token punctuation\">;</span>\nD<span class=\"token punctuation\">;</span>\nC<span class=\"token punctuation\">;</span>\nB<span class=\"token punctuation\">;</span>\nA<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>   此时D通过一个添加了<code>FLAG_ACTIVITY_CLEAR_TOP</code>的intent去启动了B类型Activity，则C、D执行onDestroy出栈（不会执行finish，触发onDestroy），现在B在栈顶，有如下图示：</p>\n<pre class=\"language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> LR<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">subgraph</span> Task<span class=\"token punctuation\">;</span>\nB<span class=\"token punctuation\">;</span>\nA<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>   接下来就有两种情况了。</p>\n<p>   情况一：intent中<strong>没有</strong>同时设置<code>FLAG_ACTIVITY_SINGLE_TOP</code>，并且B的launchMode是默认值。</p>\n<p>   B会finish掉再re-create一个新的B’放在B的位置上。</p>\n<p>   情况二：intent中设置了<code>FLAG_ACTIVITY_SINGLE_TOP</code>或者是其他类型的launchMode。</p>\n<p>   B不会finish（调用finish方法，onDestroy会被触发）掉，而是直接调用其onNewIntent()方法。</p>\n<blockquote>\n<p>或许你认为情况二这与launchMode中的singleTop或者singleTask类似，实则不然，其一，singleTop没有清空压在它上边activity的能力；其二，singleTask收到taskAffinity影响。</p>\n</blockquote>\n<ol start=\"2\">\n<li>与<code>FLAG_ACTIVITY_NEW_TASK</code>配合使用。如果想启动一个任务栈的root位置的activity，也就是栈低activity，同时设置这两个值，它会将整个任务栈放置于前台，并且清空其他activit，适用于从Notification启动Activity。</li>\n</ol>\n<p><a href=\"https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_CLEAR_TASK\"><strong>FLAG_ACTIVITY_CLEAR_TASK</strong></a>：这个flag很特殊，只能于<code>FLAG_ACTIVITY_NEW_TASK</code>配合使用。要启动的目标activity的任务栈如果已经存在并且不为空，则将所有activity出栈（不会调用finish方法，onDestroy会被触发），然后创建一个目标类型activity作为这个栈的root。</p>\n<p><a href=\"https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_SINGLE_TOP\"><strong>FLAG_ACTIVITY_SINGLE_TOP</strong></a>：这个flag与launchMode中的singleTop几乎一样，当要启动一个activity时候，如果栈顶就是目标类型activity，则不会创建一个新的activity，而是直接调用栈顶的这个activity的onNewIntent()方法。</p>\n"},{"layout":"post","title":"发布Android库到MavenCentral教程","author":"boybeak","date":"2022-09-19T00:00:00.000Z","_content":"\n\nJCenter已经宣布，即将在2020年5月1日，停止新的库的提交，在2022年2月21号以前，连库的解析服务也停止，所以，把以前的库或者未来的新库替换到MavenCentral是当务之急了。\n\n我参考的教程来自以下两篇文章：\n\n[Publishing your first Android library to MavenCentral](https://proandroiddev.com/publishing-your-first-android-library-to-mavencentral-be2c51330b88)\n\n[Android库发布到Maven Central全攻略](https://xiaozhuanlan.com/topic/6174835029)\n\nDemo项目地址：\n\n[EasyPack](https://github.com/boybeak/EasyPack)\n\n建议英文能力强的直接第一篇，我是在第二篇遇到问题时候，找到了第一篇文章解决了问题，因为第二篇里用的windows环境，我用的mac环境。\n\n\n\n## 一、 [Sonatype Jira](https://issues.sonatype.org/)相关设置\n\n首先，先去[Sonatype Jira](https://issues.sonatype.org/)这个地址注册一个SonatypeJira的账号；\n\n其次，账号创建后，登录，然后在这个页面https://issues.sonatype.org/projects 点击Create创建一个issue，如下图：\n\n![create](/images/mc_create.jpg)\n\n> 这里group id最好使用你的github地址，这样比较容易验证，如果你想用自己单独的域名，需要做更多的操作。很繁琐，不建议这样做。\n\n创建以后，会有管理员处理你的这个issue，等待管理员回复你的issue，他会告诉你，要在你的github创建一个repo，repo的名字是这个issue的id，比如我的是**OSSRH-66052**。管理员回复我的如下图：\n\n![](/images/mc_replay.jpg)\n\n你创建好repo后，回复管理员就好了，等待这个issue的状态变成**RESOLVED**状态。\n\n![](/images/mc_resolved.jpg)\n\n这样，你就创建好了一个issue，用来承接对应group id下所有的库。\n\n\n\n## 二、Gradle的准备\n\n在你项目根目录下的build.gradle文件添加classpath。\n\n```groovy\nbuildscript {\n    ext {\n        kotlin_version = \"1.4.31\"\n        appcompat = \"1.2.0\"\n        dokka_version = '1.4.10.2'\n    }\n    repositories {\n        google()\n        mavenCentral()\n    }\n    dependencies {\n        classpath 'com.android.tools.build:gradle:4.1.3'\n        classpath \"org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version\"\n\n        classpath \"org.jetbrains.dokka:dokka-gradle-plugin:$dokka_version\" //新添加的这一classpath\n    }\n}\n```\n\n在你要提交的module下的build.gradle文件中，尾部追加如下代码：\n\n```groovy\next {\n    PUBLISH_ARTIFACT_ID = \"你的artifact_id，一般是module的名字\"\n}\n\napply from: '../publish.gradle'\n```\n\n在根目录下创建publish.gradle，如下：\n\n```groovy\napply plugin: 'maven-publish'\napply plugin: 'signing'\n\ntask androidSourcesJar(type: Jar) {\n    classifier = 'sources'\n    from android.sourceSets.main.java.source\n\n    exclude \"**/R.class\"\n    exclude \"**/BuildConfig.class\"\n}\n\next {\n    PUBLISH_GROUP_ID = '你的group_id'\n    PUBLISH_VERSION = '你的版本号'\n}\n\next[\"signing.keyId\"] = ''\next[\"signing.password\"] = ''\next[\"signing.secretKeyRingFile\"] = ''\next[\"ossrhUsername\"] = ''\next[\"ossrhPassword\"] = ''\n\nFile secretPropsFile = project.rootProject.file('local.properties')\nif (secretPropsFile.exists()) {\n    println \"Found secret props file, loading props\"\n    Properties p = new Properties()\n    p.load(new FileInputStream(secretPropsFile))\n    p.each { name, value ->\n        ext[name] = value\n    }\n} else {\n    println \"No props file, loading env vars\"\n}\npublishing {\n    publications {\n        release(MavenPublication) {\n            // The coordinates of the library, being set from variables that\n            // we'll set up in a moment\n            groupId PUBLISH_GROUP_ID\n            artifactId PUBLISH_ARTIFACT_ID\n            version PUBLISH_VERSION\n\n            // Two artifacts, the `aar` and the sources\n            artifact(\"$buildDir/outputs/aar/${project.getName()}-release.aar\")\n            artifact androidSourcesJar\n\n            // Self-explanatory metadata for the most part\n            pom {\n                name = PUBLISH_ARTIFACT_ID\n                description = '你的项目描述'\n                // If your project has a dedicated site, use its URL here\n                url = 'https://github.com/boybeak/EasyPack'\n                licenses {\n                    license {\n                        //协议类型，一般默认Apache License2.0的话不用改：\n                        name = 'The Apache License, Version 2.0'\n                        url = 'http://www.apache.org/licenses/LICENSE-2.0.txt'\n                    }\n                }\n                developers {\n                    developer {\n                        id = '你的sonatype用户名'\n                        name = '你的sonatype用户名'\n                        email = '你的sonatype注册邮箱'\n                    }\n                }\n                // Version control info, if you're using GitHub, follow the format as seen here\n                scm {\n                    //修改成你的Git地址：\n                    connection = 'scm:git:github.com/你的github账号/你的项目名称.git'\n                    developerConnection = 'scm:git:ssh://github.com/你的github账号/你的项目名称.git'\n                    //分支地址：\n                    url = 'https://github.com/你的github账号/你的项目名称/tree/master'\n                }\n                // A slightly hacky fix so that your POM will include any transitive dependencies\n                // that your library builds upon\n                withXml {\n                    def dependenciesNode = asNode().appendNode('dependencies')\n\n                    project.configurations.implementation.allDependencies.each {\n                        def dependencyNode = dependenciesNode.appendNode('dependency')\n                        dependencyNode.appendNode('groupId', it.group)\n                        dependencyNode.appendNode('artifactId', it.name)\n                        dependencyNode.appendNode('version', it.version)\n                    }\n                }\n            }\n        }\n    }\n    repositories {\n        // The repository to publish to, Sonatype/MavenCentral\n        maven {\n            // This is an arbitrary name, you may also use \"mavencentral\" or\n            // any other name that's descriptive for you\n            name = \"mavencentral\"\n\n            def releasesRepoUrl = \"https://oss.sonatype.org/service/local/staging/deploy/maven2/\"\n            def snapshotsRepoUrl = \"https://oss.sonatype.org/content/repositories/snapshots/\"\n            // You only need this if you want to publish snapshots, otherwise just set the URL\n            // to the release repo directly\n            url = version.endsWith('SNAPSHOT') ? snapshotsRepoUrl : releasesRepoUrl\n\n            // The username and password we've fetched earlier\n            credentials {\n                username ossrhUsername\n                password ossrhPassword\n            }\n        }\n    }\n}\nsigning {\n    sign publishing.publications\n}\n```\n\n\n\n## 三、创建GPG秘钥\n\n1. https://www.gnupg.org/download/，从这里下载并安装GPG客户端。\n\n2. 在命令行中执行命令`gpg --full-gen-key`，注意，一定要在命令行中执行命令，不能在客户端界面做。\n\n3. 加密方式选择**RSA and RSA**，长度输入**4096**，过期时间直接回车不用管，然后输入一个user ID并且提供一个邮箱，我直接用的我sonatype的用户名和邮箱。最后一步输入'O'，表示OK。\n\n4. 之后会弹出一个对话框，让输入密码。\n\n   ![密码](/images/mc_pwd.png)\n\n   ```shell\n   gpg: revocation certificate stored as '~/.gnupg/openpgp-revocs.d/XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXE478F7CC.rev'\n   public and secret key created and signed.\n   \n   pub   rsa4096 2021-03-22 [SC]\n         XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXEE478F7CC\n   uid                      boybeak <boybeak@gmail.com>\n   sub   rsa4096 2021-03-22 [E]\n   ```\n\n   \n\n   这会为你在`~/.gnupg/openpgp-revocs.d/`目录下创建一个.rev文件，记住pub的末尾8位。\n\n5. 接下来创建secring.gpg文件，命令行执行`gpg --export-secret-keys -o secring.gpg`，这会要求你输入在步骤4中设置的密码，在你用户根目录下会出现secring.gpg文件。\n\n6. 回到gpg客户端，选择我们刚生成的秘钥条目，右键，选择`Send Public Key to Key Server`。\n\n   ![](/images/mc_cer_push.png)\n\n\n\n## 四、设置local.properties\n\n```groovy\nsigning.keyId=刚才获取的秘钥后8位\nsigning.password=步骤4中设置的密码\nsigning.secretKeyRingFile=刚才生成的secring.gpg文件目录\nossrhUsername=sonatype用户名\nossrhPassword=sonatype密码\n```\n\n\n\n## 五、执行打包和上传\n\n设置完这些后，在AndroidStudio右侧的gradle tasks中找到你想提交的module，先后执行以下两个任务。\n\n![](/images/mc_build_push.jpg)\n\n上传成功后，打开[Nexus Repository Manager](https://oss.sonatype.org/)，登录你的sonatype账号，在左侧`Staging Repositories`页面找到你的group id，选中，点击上边的close，等待几分钟十几分钟后刷新状态，等其状态变为closed后，再点击Release，则所有人都用使用你的库了。\n\n![](/images/mc_publish.jpg)。","source":"_posts/2022-09-19-Mavencentral.md","raw":"---\nlayout: post\ntitle: 发布Android库到MavenCentral教程\nauthor: boybeak\ncategories: Android技巧\ntags: Android\ndate: 2022-09-19 08:00:00\n---\n\n\nJCenter已经宣布，即将在2020年5月1日，停止新的库的提交，在2022年2月21号以前，连库的解析服务也停止，所以，把以前的库或者未来的新库替换到MavenCentral是当务之急了。\n\n我参考的教程来自以下两篇文章：\n\n[Publishing your first Android library to MavenCentral](https://proandroiddev.com/publishing-your-first-android-library-to-mavencentral-be2c51330b88)\n\n[Android库发布到Maven Central全攻略](https://xiaozhuanlan.com/topic/6174835029)\n\nDemo项目地址：\n\n[EasyPack](https://github.com/boybeak/EasyPack)\n\n建议英文能力强的直接第一篇，我是在第二篇遇到问题时候，找到了第一篇文章解决了问题，因为第二篇里用的windows环境，我用的mac环境。\n\n\n\n## 一、 [Sonatype Jira](https://issues.sonatype.org/)相关设置\n\n首先，先去[Sonatype Jira](https://issues.sonatype.org/)这个地址注册一个SonatypeJira的账号；\n\n其次，账号创建后，登录，然后在这个页面https://issues.sonatype.org/projects 点击Create创建一个issue，如下图：\n\n![create](/images/mc_create.jpg)\n\n> 这里group id最好使用你的github地址，这样比较容易验证，如果你想用自己单独的域名，需要做更多的操作。很繁琐，不建议这样做。\n\n创建以后，会有管理员处理你的这个issue，等待管理员回复你的issue，他会告诉你，要在你的github创建一个repo，repo的名字是这个issue的id，比如我的是**OSSRH-66052**。管理员回复我的如下图：\n\n![](/images/mc_replay.jpg)\n\n你创建好repo后，回复管理员就好了，等待这个issue的状态变成**RESOLVED**状态。\n\n![](/images/mc_resolved.jpg)\n\n这样，你就创建好了一个issue，用来承接对应group id下所有的库。\n\n\n\n## 二、Gradle的准备\n\n在你项目根目录下的build.gradle文件添加classpath。\n\n```groovy\nbuildscript {\n    ext {\n        kotlin_version = \"1.4.31\"\n        appcompat = \"1.2.0\"\n        dokka_version = '1.4.10.2'\n    }\n    repositories {\n        google()\n        mavenCentral()\n    }\n    dependencies {\n        classpath 'com.android.tools.build:gradle:4.1.3'\n        classpath \"org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version\"\n\n        classpath \"org.jetbrains.dokka:dokka-gradle-plugin:$dokka_version\" //新添加的这一classpath\n    }\n}\n```\n\n在你要提交的module下的build.gradle文件中，尾部追加如下代码：\n\n```groovy\next {\n    PUBLISH_ARTIFACT_ID = \"你的artifact_id，一般是module的名字\"\n}\n\napply from: '../publish.gradle'\n```\n\n在根目录下创建publish.gradle，如下：\n\n```groovy\napply plugin: 'maven-publish'\napply plugin: 'signing'\n\ntask androidSourcesJar(type: Jar) {\n    classifier = 'sources'\n    from android.sourceSets.main.java.source\n\n    exclude \"**/R.class\"\n    exclude \"**/BuildConfig.class\"\n}\n\next {\n    PUBLISH_GROUP_ID = '你的group_id'\n    PUBLISH_VERSION = '你的版本号'\n}\n\next[\"signing.keyId\"] = ''\next[\"signing.password\"] = ''\next[\"signing.secretKeyRingFile\"] = ''\next[\"ossrhUsername\"] = ''\next[\"ossrhPassword\"] = ''\n\nFile secretPropsFile = project.rootProject.file('local.properties')\nif (secretPropsFile.exists()) {\n    println \"Found secret props file, loading props\"\n    Properties p = new Properties()\n    p.load(new FileInputStream(secretPropsFile))\n    p.each { name, value ->\n        ext[name] = value\n    }\n} else {\n    println \"No props file, loading env vars\"\n}\npublishing {\n    publications {\n        release(MavenPublication) {\n            // The coordinates of the library, being set from variables that\n            // we'll set up in a moment\n            groupId PUBLISH_GROUP_ID\n            artifactId PUBLISH_ARTIFACT_ID\n            version PUBLISH_VERSION\n\n            // Two artifacts, the `aar` and the sources\n            artifact(\"$buildDir/outputs/aar/${project.getName()}-release.aar\")\n            artifact androidSourcesJar\n\n            // Self-explanatory metadata for the most part\n            pom {\n                name = PUBLISH_ARTIFACT_ID\n                description = '你的项目描述'\n                // If your project has a dedicated site, use its URL here\n                url = 'https://github.com/boybeak/EasyPack'\n                licenses {\n                    license {\n                        //协议类型，一般默认Apache License2.0的话不用改：\n                        name = 'The Apache License, Version 2.0'\n                        url = 'http://www.apache.org/licenses/LICENSE-2.0.txt'\n                    }\n                }\n                developers {\n                    developer {\n                        id = '你的sonatype用户名'\n                        name = '你的sonatype用户名'\n                        email = '你的sonatype注册邮箱'\n                    }\n                }\n                // Version control info, if you're using GitHub, follow the format as seen here\n                scm {\n                    //修改成你的Git地址：\n                    connection = 'scm:git:github.com/你的github账号/你的项目名称.git'\n                    developerConnection = 'scm:git:ssh://github.com/你的github账号/你的项目名称.git'\n                    //分支地址：\n                    url = 'https://github.com/你的github账号/你的项目名称/tree/master'\n                }\n                // A slightly hacky fix so that your POM will include any transitive dependencies\n                // that your library builds upon\n                withXml {\n                    def dependenciesNode = asNode().appendNode('dependencies')\n\n                    project.configurations.implementation.allDependencies.each {\n                        def dependencyNode = dependenciesNode.appendNode('dependency')\n                        dependencyNode.appendNode('groupId', it.group)\n                        dependencyNode.appendNode('artifactId', it.name)\n                        dependencyNode.appendNode('version', it.version)\n                    }\n                }\n            }\n        }\n    }\n    repositories {\n        // The repository to publish to, Sonatype/MavenCentral\n        maven {\n            // This is an arbitrary name, you may also use \"mavencentral\" or\n            // any other name that's descriptive for you\n            name = \"mavencentral\"\n\n            def releasesRepoUrl = \"https://oss.sonatype.org/service/local/staging/deploy/maven2/\"\n            def snapshotsRepoUrl = \"https://oss.sonatype.org/content/repositories/snapshots/\"\n            // You only need this if you want to publish snapshots, otherwise just set the URL\n            // to the release repo directly\n            url = version.endsWith('SNAPSHOT') ? snapshotsRepoUrl : releasesRepoUrl\n\n            // The username and password we've fetched earlier\n            credentials {\n                username ossrhUsername\n                password ossrhPassword\n            }\n        }\n    }\n}\nsigning {\n    sign publishing.publications\n}\n```\n\n\n\n## 三、创建GPG秘钥\n\n1. https://www.gnupg.org/download/，从这里下载并安装GPG客户端。\n\n2. 在命令行中执行命令`gpg --full-gen-key`，注意，一定要在命令行中执行命令，不能在客户端界面做。\n\n3. 加密方式选择**RSA and RSA**，长度输入**4096**，过期时间直接回车不用管，然后输入一个user ID并且提供一个邮箱，我直接用的我sonatype的用户名和邮箱。最后一步输入'O'，表示OK。\n\n4. 之后会弹出一个对话框，让输入密码。\n\n   ![密码](/images/mc_pwd.png)\n\n   ```shell\n   gpg: revocation certificate stored as '~/.gnupg/openpgp-revocs.d/XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXE478F7CC.rev'\n   public and secret key created and signed.\n   \n   pub   rsa4096 2021-03-22 [SC]\n         XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXEE478F7CC\n   uid                      boybeak <boybeak@gmail.com>\n   sub   rsa4096 2021-03-22 [E]\n   ```\n\n   \n\n   这会为你在`~/.gnupg/openpgp-revocs.d/`目录下创建一个.rev文件，记住pub的末尾8位。\n\n5. 接下来创建secring.gpg文件，命令行执行`gpg --export-secret-keys -o secring.gpg`，这会要求你输入在步骤4中设置的密码，在你用户根目录下会出现secring.gpg文件。\n\n6. 回到gpg客户端，选择我们刚生成的秘钥条目，右键，选择`Send Public Key to Key Server`。\n\n   ![](/images/mc_cer_push.png)\n\n\n\n## 四、设置local.properties\n\n```groovy\nsigning.keyId=刚才获取的秘钥后8位\nsigning.password=步骤4中设置的密码\nsigning.secretKeyRingFile=刚才生成的secring.gpg文件目录\nossrhUsername=sonatype用户名\nossrhPassword=sonatype密码\n```\n\n\n\n## 五、执行打包和上传\n\n设置完这些后，在AndroidStudio右侧的gradle tasks中找到你想提交的module，先后执行以下两个任务。\n\n![](/images/mc_build_push.jpg)\n\n上传成功后，打开[Nexus Repository Manager](https://oss.sonatype.org/)，登录你的sonatype账号，在左侧`Staging Repositories`页面找到你的group id，选中，点击上边的close，等待几分钟十几分钟后刷新状态，等其状态变为closed后，再点击Release，则所有人都用使用你的库了。\n\n![](/images/mc_publish.jpg)。","slug":"2022-09-19-Mavencentral","published":1,"updated":"2024-11-13T13:41:59.370Z","_id":"cm1ltr0g2001fbji00ntj154m","comments":1,"photos":["/images/mc_create.jpg","/images/mc_replay.jpg","/images/mc_resolved.jpg","/images/mc_pwd.png","/images/mc_cer_push.png","/images/mc_build_push.jpg","/images/mc_publish.jpg"],"content":"<p>JCenter已经宣布，即将在2020年5月1日，停止新的库的提交，在2022年2月21号以前，连库的解析服务也停止，所以，把以前的库或者未来的新库替换到MavenCentral是当务之急了。</p>\n<p>我参考的教程来自以下两篇文章：</p>\n<p><a href=\"https://proandroiddev.com/publishing-your-first-android-library-to-mavencentral-be2c51330b88\">Publishing your first Android library to MavenCentral</a></p>\n<p><a href=\"https://xiaozhuanlan.com/topic/6174835029\">Android库发布到Maven Central全攻略</a></p>\n<p>Demo项目地址：</p>\n<p><a href=\"https://github.com/boybeak/EasyPack\">EasyPack</a></p>\n<p>建议英文能力强的直接第一篇，我是在第二篇遇到问题时候，找到了第一篇文章解决了问题，因为第二篇里用的windows环境，我用的mac环境。</p>\n<h2 id=\"一、-Sonatype-Jira相关设置\"><a href=\"#一、-Sonatype-Jira相关设置\" class=\"headerlink\" title=\"一、 Sonatype Jira相关设置\"></a>一、 <a href=\"https://issues.sonatype.org/\">Sonatype Jira</a>相关设置</h2><p>首先，先去<a href=\"https://issues.sonatype.org/\">Sonatype Jira</a>这个地址注册一个SonatypeJira的账号；</p>\n<p>其次，账号创建后，登录，然后在这个页面<a href=\"https://issues.sonatype.org/projects\">https://issues.sonatype.org/projects</a> 点击Create创建一个issue，如下图：</p>\n<p><img src=\"/images/mc_create.jpg\" alt=\"create\"></p>\n<blockquote>\n<p>这里group id最好使用你的github地址，这样比较容易验证，如果你想用自己单独的域名，需要做更多的操作。很繁琐，不建议这样做。</p>\n</blockquote>\n<p>创建以后，会有管理员处理你的这个issue，等待管理员回复你的issue，他会告诉你，要在你的github创建一个repo，repo的名字是这个issue的id，比如我的是<strong>OSSRH-66052</strong>。管理员回复我的如下图：</p>\n<p><img src=\"/images/mc_replay.jpg\"></p>\n<p>你创建好repo后，回复管理员就好了，等待这个issue的状态变成<strong>RESOLVED</strong>状态。</p>\n<p><img src=\"/images/mc_resolved.jpg\"></p>\n<p>这样，你就创建好了一个issue，用来承接对应group id下所有的库。</p>\n<h2 id=\"二、Gradle的准备\"><a href=\"#二、Gradle的准备\" class=\"headerlink\" title=\"二、Gradle的准备\"></a>二、Gradle的准备</h2><p>在你项目根目录下的build.gradle文件添加classpath。</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">buildscript <span class=\"token punctuation\">&#123;</span>\n    ext <span class=\"token punctuation\">&#123;</span>\n        kotlin_version <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"1.4.31\"</span></span>\n        appcompat <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"1.2.0\"</span></span>\n        dokka_version <span class=\"token operator\">=</span> <span class=\"token string\">'1.4.10.2'</span>\n    <span class=\"token punctuation\">&#125;</span>\n    repositories <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">google</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">mavenCentral</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    dependencies <span class=\"token punctuation\">&#123;</span>\n        classpath <span class=\"token string\">'com.android.tools.build:gradle:4.1.3'</span>\n        classpath <span class=\"token interpolation-string\"><span class=\"token string\">\"org.jetbrains.kotlin:kotlin-gradle-plugin:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">kotlin_version</span></span><span class=\"token string\">\"</span></span>\n\n        classpath <span class=\"token interpolation-string\"><span class=\"token string\">\"org.jetbrains.dokka:dokka-gradle-plugin:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">dokka_version</span></span><span class=\"token string\">\"</span></span> <span class=\"token comment\">//新添加的这一classpath</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在你要提交的module下的build.gradle文件中，尾部追加如下代码：</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">ext <span class=\"token punctuation\">&#123;</span>\n    PUBLISH_ARTIFACT_ID <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"你的artifact_id，一般是module的名字\"</span></span>\n<span class=\"token punctuation\">&#125;</span>\n\napply from<span class=\"token punctuation\">:</span> <span class=\"token string\">'../publish.gradle'</span></code></pre>\n\n<p>在根目录下创建publish.gradle，如下：</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">apply plugin<span class=\"token punctuation\">:</span> <span class=\"token string\">'maven-publish'</span>\napply plugin<span class=\"token punctuation\">:</span> <span class=\"token string\">'signing'</span>\n\ntask <span class=\"token function\">androidSourcesJar</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">:</span> Jar<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    classifier <span class=\"token operator\">=</span> <span class=\"token string\">'sources'</span>\n    from android<span class=\"token punctuation\">.</span>sourceSets<span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">.</span>source\n\n    exclude <span class=\"token interpolation-string\"><span class=\"token string\">\"**/R.class\"</span></span>\n    exclude <span class=\"token interpolation-string\"><span class=\"token string\">\"**/BuildConfig.class\"</span></span>\n<span class=\"token punctuation\">&#125;</span>\n\next <span class=\"token punctuation\">&#123;</span>\n    PUBLISH_GROUP_ID <span class=\"token operator\">=</span> <span class=\"token string\">'你的group_id'</span>\n    PUBLISH_VERSION <span class=\"token operator\">=</span> <span class=\"token string\">'你的版本号'</span>\n<span class=\"token punctuation\">&#125;</span>\n\next<span class=\"token punctuation\">[</span><span class=\"token interpolation-string\"><span class=\"token string\">\"signing.keyId\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\next<span class=\"token punctuation\">[</span><span class=\"token interpolation-string\"><span class=\"token string\">\"signing.password\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\next<span class=\"token punctuation\">[</span><span class=\"token interpolation-string\"><span class=\"token string\">\"signing.secretKeyRingFile\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\next<span class=\"token punctuation\">[</span><span class=\"token interpolation-string\"><span class=\"token string\">\"ossrhUsername\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\next<span class=\"token punctuation\">[</span><span class=\"token interpolation-string\"><span class=\"token string\">\"ossrhPassword\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n\nFile secretPropsFile <span class=\"token operator\">=</span> project<span class=\"token punctuation\">.</span>rootProject<span class=\"token punctuation\">.</span><span class=\"token function\">file</span><span class=\"token punctuation\">(</span><span class=\"token string\">'local.properties'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>secretPropsFile<span class=\"token punctuation\">.</span><span class=\"token function\">exists</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    println <span class=\"token interpolation-string\"><span class=\"token string\">\"Found secret props file, loading props\"</span></span>\n    Properties p <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Properties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    p<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">FileInputStream</span><span class=\"token punctuation\">(</span>secretPropsFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    p<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span> name<span class=\"token punctuation\">,</span> value <span class=\"token operator\">-></span>\n        ext<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> value\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    println <span class=\"token interpolation-string\"><span class=\"token string\">\"No props file, loading env vars\"</span></span>\n<span class=\"token punctuation\">&#125;</span>\npublishing <span class=\"token punctuation\">&#123;</span>\n    publications <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">release</span><span class=\"token punctuation\">(</span>MavenPublication<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">// The coordinates of the library, being set from variables that</span>\n            <span class=\"token comment\">// we'll set up in a moment</span>\n            groupId PUBLISH_GROUP_ID\n            artifactId PUBLISH_ARTIFACT_ID\n            version PUBLISH_VERSION\n\n            <span class=\"token comment\">// Two artifacts, the `aar` and the sources</span>\n            <span class=\"token function\">artifact</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">buildDir</span></span><span class=\"token string\">/outputs/aar/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token expression\">project<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">-release.aar\"</span></span><span class=\"token punctuation\">)</span>\n            artifact androidSourcesJar\n\n            <span class=\"token comment\">// Self-explanatory metadata for the most part</span>\n            pom <span class=\"token punctuation\">&#123;</span>\n                name <span class=\"token operator\">=</span> PUBLISH_ARTIFACT_ID\n                description <span class=\"token operator\">=</span> <span class=\"token string\">'你的项目描述'</span>\n                <span class=\"token comment\">// If your project has a dedicated site, use its URL here</span>\n                url <span class=\"token operator\">=</span> <span class=\"token string\">'https://github.com/boybeak/EasyPack'</span>\n                licenses <span class=\"token punctuation\">&#123;</span>\n                    license <span class=\"token punctuation\">&#123;</span>\n                        <span class=\"token comment\">//协议类型，一般默认Apache License2.0的话不用改：</span>\n                        name <span class=\"token operator\">=</span> <span class=\"token string\">'The Apache License, Version 2.0'</span>\n                        url <span class=\"token operator\">=</span> <span class=\"token string\">'http://www.apache.org/licenses/LICENSE-2.0.txt'</span>\n                    <span class=\"token punctuation\">&#125;</span>\n                <span class=\"token punctuation\">&#125;</span>\n                developers <span class=\"token punctuation\">&#123;</span>\n                    developer <span class=\"token punctuation\">&#123;</span>\n                        id <span class=\"token operator\">=</span> <span class=\"token string\">'你的sonatype用户名'</span>\n                        name <span class=\"token operator\">=</span> <span class=\"token string\">'你的sonatype用户名'</span>\n                        email <span class=\"token operator\">=</span> <span class=\"token string\">'你的sonatype注册邮箱'</span>\n                    <span class=\"token punctuation\">&#125;</span>\n                <span class=\"token punctuation\">&#125;</span>\n                <span class=\"token comment\">// Version control info, if you're using GitHub, follow the format as seen here</span>\n                scm <span class=\"token punctuation\">&#123;</span>\n                    <span class=\"token comment\">//修改成你的Git地址：</span>\n                    connection <span class=\"token operator\">=</span> <span class=\"token string\">'scm:git:github.com/你的github账号/你的项目名称.git'</span>\n                    developerConnection <span class=\"token operator\">=</span> <span class=\"token string\">'scm:git:ssh://github.com/你的github账号/你的项目名称.git'</span>\n                    <span class=\"token comment\">//分支地址：</span>\n                    url <span class=\"token operator\">=</span> <span class=\"token string\">'https://github.com/你的github账号/你的项目名称/tree/master'</span>\n                <span class=\"token punctuation\">&#125;</span>\n                <span class=\"token comment\">// A slightly hacky fix so that your POM will include any transitive dependencies</span>\n                <span class=\"token comment\">// that your library builds upon</span>\n                withXml <span class=\"token punctuation\">&#123;</span>\n                    <span class=\"token keyword\">def</span> dependenciesNode <span class=\"token operator\">=</span> <span class=\"token function\">asNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">appendNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dependencies'</span><span class=\"token punctuation\">)</span>\n\n                    project<span class=\"token punctuation\">.</span>configurations<span class=\"token punctuation\">.</span>implementation<span class=\"token punctuation\">.</span>allDependencies<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span>\n                        <span class=\"token keyword\">def</span> dependencyNode <span class=\"token operator\">=</span> dependenciesNode<span class=\"token punctuation\">.</span><span class=\"token function\">appendNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dependency'</span><span class=\"token punctuation\">)</span>\n                        dependencyNode<span class=\"token punctuation\">.</span><span class=\"token function\">appendNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'groupId'</span><span class=\"token punctuation\">,</span> it<span class=\"token punctuation\">.</span>group<span class=\"token punctuation\">)</span>\n                        dependencyNode<span class=\"token punctuation\">.</span><span class=\"token function\">appendNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'artifactId'</span><span class=\"token punctuation\">,</span> it<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span>\n                        dependencyNode<span class=\"token punctuation\">.</span><span class=\"token function\">appendNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'version'</span><span class=\"token punctuation\">,</span> it<span class=\"token punctuation\">.</span>version<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">&#125;</span>\n                <span class=\"token punctuation\">&#125;</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    repositories <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// The repository to publish to, Sonatype/MavenCentral</span>\n        maven <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">// This is an arbitrary name, you may also use \"mavencentral\" or</span>\n            <span class=\"token comment\">// any other name that's descriptive for you</span>\n            name <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"mavencentral\"</span></span>\n\n            <span class=\"token keyword\">def</span> releasesRepoUrl <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"https://oss.sonatype.org/service/local/staging/deploy/maven2/\"</span></span>\n            <span class=\"token keyword\">def</span> snapshotsRepoUrl <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"https://oss.sonatype.org/content/repositories/snapshots/\"</span></span>\n            <span class=\"token comment\">// You only need this if you want to publish snapshots, otherwise just set the URL</span>\n            <span class=\"token comment\">// to the release repo directly</span>\n            url <span class=\"token operator\">=</span> version<span class=\"token punctuation\">.</span><span class=\"token function\">endsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'SNAPSHOT'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> snapshotsRepoUrl <span class=\"token punctuation\">:</span> releasesRepoUrl\n\n            <span class=\"token comment\">// The username and password we've fetched earlier</span>\n            credentials <span class=\"token punctuation\">&#123;</span>\n                username ossrhUsername\n                password ossrhPassword\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\nsigning <span class=\"token punctuation\">&#123;</span>\n    sign publishing<span class=\"token punctuation\">.</span>publications\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n\n\n<h2 id=\"三、创建GPG秘钥\"><a href=\"#三、创建GPG秘钥\" class=\"headerlink\" title=\"三、创建GPG秘钥\"></a>三、创建GPG秘钥</h2><ol>\n<li><p><a href=\"https://www.gnupg.org/download/%EF%BC%8C%E4%BB%8E%E8%BF%99%E9%87%8C%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%AE%89%E8%A3%85GPG%E5%AE%A2%E6%88%B7%E7%AB%AF%E3%80%82\">https://www.gnupg.org/download/，从这里下载并安装GPG客户端。</a></p>\n</li>\n<li><p>在命令行中执行命令<code>gpg --full-gen-key</code>，注意，一定要在命令行中执行命令，不能在客户端界面做。</p>\n</li>\n<li><p>加密方式选择<strong>RSA and RSA</strong>，长度输入<strong>4096</strong>，过期时间直接回车不用管，然后输入一个user ID并且提供一个邮箱，我直接用的我sonatype的用户名和邮箱。最后一步输入’O’，表示OK。</p>\n</li>\n<li><p>之后会弹出一个对话框，让输入密码。</p>\n<p><img src=\"/images/mc_pwd.png\" alt=\"密码\"></p>\n<pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">gpg: revocation certificate stored as <span class=\"token string\">'~/.gnupg/openpgp-revocs.d/XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXE478F7CC.rev'</span>\npublic and secret key created and signed.\n\npub   rsa4096 <span class=\"token number\">2021</span>-03-22 <span class=\"token punctuation\">[</span>SC<span class=\"token punctuation\">]</span>\n      XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXEE478F7CC\nuid                      boybeak <span class=\"token operator\">&lt;</span>boybeak@gmail.com<span class=\"token operator\">></span>\nsub   rsa4096 <span class=\"token number\">2021</span>-03-22 <span class=\"token punctuation\">[</span>E<span class=\"token punctuation\">]</span></code></pre>\n\n\n\n<p>这会为你在<code>~/.gnupg/openpgp-revocs.d/</code>目录下创建一个.rev文件，记住pub的末尾8位。</p>\n</li>\n<li><p>接下来创建secring.gpg文件，命令行执行<code>gpg --export-secret-keys -o secring.gpg</code>，这会要求你输入在步骤4中设置的密码，在你用户根目录下会出现secring.gpg文件。</p>\n</li>\n<li><p>回到gpg客户端，选择我们刚生成的秘钥条目，右键，选择<code>Send Public Key to Key Server</code>。</p>\n<p><img src=\"/images/mc_cer_push.png\"></p>\n</li>\n</ol>\n<h2 id=\"四、设置local-properties\"><a href=\"#四、设置local-properties\" class=\"headerlink\" title=\"四、设置local.properties\"></a>四、设置local.properties</h2><pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">signing<span class=\"token punctuation\">.</span>keyId<span class=\"token operator\">=</span>刚才获取的秘钥后<span class=\"token number\">8</span>位\nsigning<span class=\"token punctuation\">.</span>password<span class=\"token operator\">=</span>步骤<span class=\"token number\">4</span>中设置的密码\nsigning<span class=\"token punctuation\">.</span>secretKeyRingFile<span class=\"token operator\">=</span>刚才生成的secring<span class=\"token punctuation\">.</span>gpg文件目录\nossrhUsername<span class=\"token operator\">=</span>sonatype用户名\nossrhPassword<span class=\"token operator\">=</span>sonatype密码</code></pre>\n\n\n\n<h2 id=\"五、执行打包和上传\"><a href=\"#五、执行打包和上传\" class=\"headerlink\" title=\"五、执行打包和上传\"></a>五、执行打包和上传</h2><p>设置完这些后，在AndroidStudio右侧的gradle tasks中找到你想提交的module，先后执行以下两个任务。</p>\n<p><img src=\"/images/mc_build_push.jpg\"></p>\n<p>上传成功后，打开<a href=\"https://oss.sonatype.org/\">Nexus Repository Manager</a>，登录你的sonatype账号，在左侧<code>Staging Repositories</code>页面找到你的group id，选中，点击上边的close，等待几分钟十几分钟后刷新状态，等其状态变为closed后，再点击Release，则所有人都用使用你的库了。</p>\n<p><img src=\"/images/mc_publish.jpg\">。</p>\n","excerpt":"","more":"<p>JCenter已经宣布，即将在2020年5月1日，停止新的库的提交，在2022年2月21号以前，连库的解析服务也停止，所以，把以前的库或者未来的新库替换到MavenCentral是当务之急了。</p>\n<p>我参考的教程来自以下两篇文章：</p>\n<p><a href=\"https://proandroiddev.com/publishing-your-first-android-library-to-mavencentral-be2c51330b88\">Publishing your first Android library to MavenCentral</a></p>\n<p><a href=\"https://xiaozhuanlan.com/topic/6174835029\">Android库发布到Maven Central全攻略</a></p>\n<p>Demo项目地址：</p>\n<p><a href=\"https://github.com/boybeak/EasyPack\">EasyPack</a></p>\n<p>建议英文能力强的直接第一篇，我是在第二篇遇到问题时候，找到了第一篇文章解决了问题，因为第二篇里用的windows环境，我用的mac环境。</p>\n<h2 id=\"一、-Sonatype-Jira相关设置\"><a href=\"#一、-Sonatype-Jira相关设置\" class=\"headerlink\" title=\"一、 Sonatype Jira相关设置\"></a>一、 <a href=\"https://issues.sonatype.org/\">Sonatype Jira</a>相关设置</h2><p>首先，先去<a href=\"https://issues.sonatype.org/\">Sonatype Jira</a>这个地址注册一个SonatypeJira的账号；</p>\n<p>其次，账号创建后，登录，然后在这个页面<a href=\"https://issues.sonatype.org/projects\">https://issues.sonatype.org/projects</a> 点击Create创建一个issue，如下图：</p>\n<p><img src=\"/images/mc_create.jpg\" alt=\"create\"></p>\n<blockquote>\n<p>这里group id最好使用你的github地址，这样比较容易验证，如果你想用自己单独的域名，需要做更多的操作。很繁琐，不建议这样做。</p>\n</blockquote>\n<p>创建以后，会有管理员处理你的这个issue，等待管理员回复你的issue，他会告诉你，要在你的github创建一个repo，repo的名字是这个issue的id，比如我的是<strong>OSSRH-66052</strong>。管理员回复我的如下图：</p>\n<p><img src=\"/images/mc_replay.jpg\"></p>\n<p>你创建好repo后，回复管理员就好了，等待这个issue的状态变成<strong>RESOLVED</strong>状态。</p>\n<p><img src=\"/images/mc_resolved.jpg\"></p>\n<p>这样，你就创建好了一个issue，用来承接对应group id下所有的库。</p>\n<h2 id=\"二、Gradle的准备\"><a href=\"#二、Gradle的准备\" class=\"headerlink\" title=\"二、Gradle的准备\"></a>二、Gradle的准备</h2><p>在你项目根目录下的build.gradle文件添加classpath。</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">buildscript <span class=\"token punctuation\">&#123;</span>\n    ext <span class=\"token punctuation\">&#123;</span>\n        kotlin_version <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"1.4.31\"</span></span>\n        appcompat <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"1.2.0\"</span></span>\n        dokka_version <span class=\"token operator\">=</span> <span class=\"token string\">'1.4.10.2'</span>\n    <span class=\"token punctuation\">&#125;</span>\n    repositories <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">google</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">mavenCentral</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    dependencies <span class=\"token punctuation\">&#123;</span>\n        classpath <span class=\"token string\">'com.android.tools.build:gradle:4.1.3'</span>\n        classpath <span class=\"token interpolation-string\"><span class=\"token string\">\"org.jetbrains.kotlin:kotlin-gradle-plugin:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">kotlin_version</span></span><span class=\"token string\">\"</span></span>\n\n        classpath <span class=\"token interpolation-string\"><span class=\"token string\">\"org.jetbrains.dokka:dokka-gradle-plugin:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">dokka_version</span></span><span class=\"token string\">\"</span></span> <span class=\"token comment\">//新添加的这一classpath</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在你要提交的module下的build.gradle文件中，尾部追加如下代码：</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">ext <span class=\"token punctuation\">&#123;</span>\n    PUBLISH_ARTIFACT_ID <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"你的artifact_id，一般是module的名字\"</span></span>\n<span class=\"token punctuation\">&#125;</span>\n\napply from<span class=\"token punctuation\">:</span> <span class=\"token string\">'../publish.gradle'</span></code></pre>\n\n<p>在根目录下创建publish.gradle，如下：</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">apply plugin<span class=\"token punctuation\">:</span> <span class=\"token string\">'maven-publish'</span>\napply plugin<span class=\"token punctuation\">:</span> <span class=\"token string\">'signing'</span>\n\ntask <span class=\"token function\">androidSourcesJar</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">:</span> Jar<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    classifier <span class=\"token operator\">=</span> <span class=\"token string\">'sources'</span>\n    from android<span class=\"token punctuation\">.</span>sourceSets<span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">.</span>source\n\n    exclude <span class=\"token interpolation-string\"><span class=\"token string\">\"**/R.class\"</span></span>\n    exclude <span class=\"token interpolation-string\"><span class=\"token string\">\"**/BuildConfig.class\"</span></span>\n<span class=\"token punctuation\">&#125;</span>\n\next <span class=\"token punctuation\">&#123;</span>\n    PUBLISH_GROUP_ID <span class=\"token operator\">=</span> <span class=\"token string\">'你的group_id'</span>\n    PUBLISH_VERSION <span class=\"token operator\">=</span> <span class=\"token string\">'你的版本号'</span>\n<span class=\"token punctuation\">&#125;</span>\n\next<span class=\"token punctuation\">[</span><span class=\"token interpolation-string\"><span class=\"token string\">\"signing.keyId\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\next<span class=\"token punctuation\">[</span><span class=\"token interpolation-string\"><span class=\"token string\">\"signing.password\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\next<span class=\"token punctuation\">[</span><span class=\"token interpolation-string\"><span class=\"token string\">\"signing.secretKeyRingFile\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\next<span class=\"token punctuation\">[</span><span class=\"token interpolation-string\"><span class=\"token string\">\"ossrhUsername\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\next<span class=\"token punctuation\">[</span><span class=\"token interpolation-string\"><span class=\"token string\">\"ossrhPassword\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n\nFile secretPropsFile <span class=\"token operator\">=</span> project<span class=\"token punctuation\">.</span>rootProject<span class=\"token punctuation\">.</span><span class=\"token function\">file</span><span class=\"token punctuation\">(</span><span class=\"token string\">'local.properties'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>secretPropsFile<span class=\"token punctuation\">.</span><span class=\"token function\">exists</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    println <span class=\"token interpolation-string\"><span class=\"token string\">\"Found secret props file, loading props\"</span></span>\n    Properties p <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Properties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    p<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">FileInputStream</span><span class=\"token punctuation\">(</span>secretPropsFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    p<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span> name<span class=\"token punctuation\">,</span> value <span class=\"token operator\">-></span>\n        ext<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> value\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    println <span class=\"token interpolation-string\"><span class=\"token string\">\"No props file, loading env vars\"</span></span>\n<span class=\"token punctuation\">&#125;</span>\npublishing <span class=\"token punctuation\">&#123;</span>\n    publications <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">release</span><span class=\"token punctuation\">(</span>MavenPublication<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">// The coordinates of the library, being set from variables that</span>\n            <span class=\"token comment\">// we'll set up in a moment</span>\n            groupId PUBLISH_GROUP_ID\n            artifactId PUBLISH_ARTIFACT_ID\n            version PUBLISH_VERSION\n\n            <span class=\"token comment\">// Two artifacts, the `aar` and the sources</span>\n            <span class=\"token function\">artifact</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">buildDir</span></span><span class=\"token string\">/outputs/aar/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token expression\">project<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">-release.aar\"</span></span><span class=\"token punctuation\">)</span>\n            artifact androidSourcesJar\n\n            <span class=\"token comment\">// Self-explanatory metadata for the most part</span>\n            pom <span class=\"token punctuation\">&#123;</span>\n                name <span class=\"token operator\">=</span> PUBLISH_ARTIFACT_ID\n                description <span class=\"token operator\">=</span> <span class=\"token string\">'你的项目描述'</span>\n                <span class=\"token comment\">// If your project has a dedicated site, use its URL here</span>\n                url <span class=\"token operator\">=</span> <span class=\"token string\">'https://github.com/boybeak/EasyPack'</span>\n                licenses <span class=\"token punctuation\">&#123;</span>\n                    license <span class=\"token punctuation\">&#123;</span>\n                        <span class=\"token comment\">//协议类型，一般默认Apache License2.0的话不用改：</span>\n                        name <span class=\"token operator\">=</span> <span class=\"token string\">'The Apache License, Version 2.0'</span>\n                        url <span class=\"token operator\">=</span> <span class=\"token string\">'http://www.apache.org/licenses/LICENSE-2.0.txt'</span>\n                    <span class=\"token punctuation\">&#125;</span>\n                <span class=\"token punctuation\">&#125;</span>\n                developers <span class=\"token punctuation\">&#123;</span>\n                    developer <span class=\"token punctuation\">&#123;</span>\n                        id <span class=\"token operator\">=</span> <span class=\"token string\">'你的sonatype用户名'</span>\n                        name <span class=\"token operator\">=</span> <span class=\"token string\">'你的sonatype用户名'</span>\n                        email <span class=\"token operator\">=</span> <span class=\"token string\">'你的sonatype注册邮箱'</span>\n                    <span class=\"token punctuation\">&#125;</span>\n                <span class=\"token punctuation\">&#125;</span>\n                <span class=\"token comment\">// Version control info, if you're using GitHub, follow the format as seen here</span>\n                scm <span class=\"token punctuation\">&#123;</span>\n                    <span class=\"token comment\">//修改成你的Git地址：</span>\n                    connection <span class=\"token operator\">=</span> <span class=\"token string\">'scm:git:github.com/你的github账号/你的项目名称.git'</span>\n                    developerConnection <span class=\"token operator\">=</span> <span class=\"token string\">'scm:git:ssh://github.com/你的github账号/你的项目名称.git'</span>\n                    <span class=\"token comment\">//分支地址：</span>\n                    url <span class=\"token operator\">=</span> <span class=\"token string\">'https://github.com/你的github账号/你的项目名称/tree/master'</span>\n                <span class=\"token punctuation\">&#125;</span>\n                <span class=\"token comment\">// A slightly hacky fix so that your POM will include any transitive dependencies</span>\n                <span class=\"token comment\">// that your library builds upon</span>\n                withXml <span class=\"token punctuation\">&#123;</span>\n                    <span class=\"token keyword\">def</span> dependenciesNode <span class=\"token operator\">=</span> <span class=\"token function\">asNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">appendNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dependencies'</span><span class=\"token punctuation\">)</span>\n\n                    project<span class=\"token punctuation\">.</span>configurations<span class=\"token punctuation\">.</span>implementation<span class=\"token punctuation\">.</span>allDependencies<span class=\"token punctuation\">.</span>each <span class=\"token punctuation\">&#123;</span>\n                        <span class=\"token keyword\">def</span> dependencyNode <span class=\"token operator\">=</span> dependenciesNode<span class=\"token punctuation\">.</span><span class=\"token function\">appendNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dependency'</span><span class=\"token punctuation\">)</span>\n                        dependencyNode<span class=\"token punctuation\">.</span><span class=\"token function\">appendNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'groupId'</span><span class=\"token punctuation\">,</span> it<span class=\"token punctuation\">.</span>group<span class=\"token punctuation\">)</span>\n                        dependencyNode<span class=\"token punctuation\">.</span><span class=\"token function\">appendNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'artifactId'</span><span class=\"token punctuation\">,</span> it<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span>\n                        dependencyNode<span class=\"token punctuation\">.</span><span class=\"token function\">appendNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'version'</span><span class=\"token punctuation\">,</span> it<span class=\"token punctuation\">.</span>version<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">&#125;</span>\n                <span class=\"token punctuation\">&#125;</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    repositories <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// The repository to publish to, Sonatype/MavenCentral</span>\n        maven <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">// This is an arbitrary name, you may also use \"mavencentral\" or</span>\n            <span class=\"token comment\">// any other name that's descriptive for you</span>\n            name <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"mavencentral\"</span></span>\n\n            <span class=\"token keyword\">def</span> releasesRepoUrl <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"https://oss.sonatype.org/service/local/staging/deploy/maven2/\"</span></span>\n            <span class=\"token keyword\">def</span> snapshotsRepoUrl <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"https://oss.sonatype.org/content/repositories/snapshots/\"</span></span>\n            <span class=\"token comment\">// You only need this if you want to publish snapshots, otherwise just set the URL</span>\n            <span class=\"token comment\">// to the release repo directly</span>\n            url <span class=\"token operator\">=</span> version<span class=\"token punctuation\">.</span><span class=\"token function\">endsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'SNAPSHOT'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> snapshotsRepoUrl <span class=\"token punctuation\">:</span> releasesRepoUrl\n\n            <span class=\"token comment\">// The username and password we've fetched earlier</span>\n            credentials <span class=\"token punctuation\">&#123;</span>\n                username ossrhUsername\n                password ossrhPassword\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\nsigning <span class=\"token punctuation\">&#123;</span>\n    sign publishing<span class=\"token punctuation\">.</span>publications\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n\n\n<h2 id=\"三、创建GPG秘钥\"><a href=\"#三、创建GPG秘钥\" class=\"headerlink\" title=\"三、创建GPG秘钥\"></a>三、创建GPG秘钥</h2><ol>\n<li><p><a href=\"https://www.gnupg.org/download/%EF%BC%8C%E4%BB%8E%E8%BF%99%E9%87%8C%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%AE%89%E8%A3%85GPG%E5%AE%A2%E6%88%B7%E7%AB%AF%E3%80%82\">https://www.gnupg.org/download/，从这里下载并安装GPG客户端。</a></p>\n</li>\n<li><p>在命令行中执行命令<code>gpg --full-gen-key</code>，注意，一定要在命令行中执行命令，不能在客户端界面做。</p>\n</li>\n<li><p>加密方式选择<strong>RSA and RSA</strong>，长度输入<strong>4096</strong>，过期时间直接回车不用管，然后输入一个user ID并且提供一个邮箱，我直接用的我sonatype的用户名和邮箱。最后一步输入’O’，表示OK。</p>\n</li>\n<li><p>之后会弹出一个对话框，让输入密码。</p>\n<p><img src=\"/images/mc_pwd.png\" alt=\"密码\"></p>\n<pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">gpg: revocation certificate stored as <span class=\"token string\">'~/.gnupg/openpgp-revocs.d/XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXE478F7CC.rev'</span>\npublic and secret key created and signed.\n\npub   rsa4096 <span class=\"token number\">2021</span>-03-22 <span class=\"token punctuation\">[</span>SC<span class=\"token punctuation\">]</span>\n      XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXEE478F7CC\nuid                      boybeak <span class=\"token operator\">&lt;</span>boybeak@gmail.com<span class=\"token operator\">></span>\nsub   rsa4096 <span class=\"token number\">2021</span>-03-22 <span class=\"token punctuation\">[</span>E<span class=\"token punctuation\">]</span></code></pre>\n\n\n\n<p>这会为你在<code>~/.gnupg/openpgp-revocs.d/</code>目录下创建一个.rev文件，记住pub的末尾8位。</p>\n</li>\n<li><p>接下来创建secring.gpg文件，命令行执行<code>gpg --export-secret-keys -o secring.gpg</code>，这会要求你输入在步骤4中设置的密码，在你用户根目录下会出现secring.gpg文件。</p>\n</li>\n<li><p>回到gpg客户端，选择我们刚生成的秘钥条目，右键，选择<code>Send Public Key to Key Server</code>。</p>\n<p><img src=\"/images/mc_cer_push.png\"></p>\n</li>\n</ol>\n<h2 id=\"四、设置local-properties\"><a href=\"#四、设置local-properties\" class=\"headerlink\" title=\"四、设置local.properties\"></a>四、设置local.properties</h2><pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">signing<span class=\"token punctuation\">.</span>keyId<span class=\"token operator\">=</span>刚才获取的秘钥后<span class=\"token number\">8</span>位\nsigning<span class=\"token punctuation\">.</span>password<span class=\"token operator\">=</span>步骤<span class=\"token number\">4</span>中设置的密码\nsigning<span class=\"token punctuation\">.</span>secretKeyRingFile<span class=\"token operator\">=</span>刚才生成的secring<span class=\"token punctuation\">.</span>gpg文件目录\nossrhUsername<span class=\"token operator\">=</span>sonatype用户名\nossrhPassword<span class=\"token operator\">=</span>sonatype密码</code></pre>\n\n\n\n<h2 id=\"五、执行打包和上传\"><a href=\"#五、执行打包和上传\" class=\"headerlink\" title=\"五、执行打包和上传\"></a>五、执行打包和上传</h2><p>设置完这些后，在AndroidStudio右侧的gradle tasks中找到你想提交的module，先后执行以下两个任务。</p>\n<p><img src=\"/images/mc_build_push.jpg\"></p>\n<p>上传成功后，打开<a href=\"https://oss.sonatype.org/\">Nexus Repository Manager</a>，登录你的sonatype账号，在左侧<code>Staging Repositories</code>页面找到你的group id，选中，点击上边的close，等待几分钟十几分钟后刷新状态，等其状态变为closed后，再点击Release，则所有人都用使用你的库了。</p>\n<p><img src=\"/images/mc_publish.jpg\">。</p>\n"},{"layout":"post","title":"Kotlin Native从初识到放弃","author":"boybeak","date":"2022-09-22T16:00:00.000Z","_content":"\n此贴用于记录对Kotlin Native从初识到放弃的过程，因为还不清楚这一平台的开发能力上限多高，不排除用的好，会一直用下去。\n以下Kotlin Native会用KN来代替。\n\n## 开始\n首先，下载IDEA，我这里用的是社区版，社区版已经足以应对大多数情况了。\n然后，新建一个KN的项目。\n![kotlin-native-start.jpg](/images/kotlin-native-starter.jpg)\nIDE会自动生成hello world代码，直接点运行，如果工具栏的运行按钮没有可执行的配置，那就直接在Main.kt文件上右键运行。相比直接用Clion写**C/C++**代码的运行速度，KN项目运行要慢得多，因为要先执行gradle脚本。\n即便是这样，你也很可能第一次运行不成功，在macOs上，要安装*XCode command line tools*工具，我这里直接安装了完整版的XCode。\n然后继续尝试运行，你很可能会发现，依然执行不成功，报如下错误：\n```log\nThe /usr/bin/xcrun command returned non-zero exit code: 72\n```\n这时候，你需要打开XCode，执行一系列同意操作后，进入**Preferences** -> **Locations**，选中一个版本。如下：\n![xcode-select](/images/xcode-select.jpg)\n如果你没有安装完整XCode，可以尝试`xcode select`这个命令，这里具体不做详述。\n经过这个设置后，再次尝试运行，这次终于运行成功。\n```log\n21:41:11: Executing 'runDebugExecutableNative'...\n\nStarting Gradle Daemon...\nGradle Daemon started in 3 s 569 ms\n\n> Configure project :\nKotlin Multiplatform Projects are an Alpha feature. See: https://kotlinlang.org/docs/reference/evolution/components-stability.html. To hide this message, add 'kotlin.mpp.stability.nowarn=true' to the Gradle properties.\n\nThe property 'kotlin.mpp.enableGranularSourceSetsMetadata=true' has no effect in this and future Kotlin versions, as Hierarchical Structures support is now enabled by default. It is safe to remove the property.\n\nThe property 'kotlin.native.enableDependencyPropagation=false' has no effect in this and future Kotlin versions, as Kotlin/Native dependency commonization is now enabled by default. It is safe to remove the property.\n\n\n> Task :wrapper\n\nBUILD SUCCESSFUL in 21s\n1 actionable task: 1 executed\n\n> Configure project :\nKotlin Multiplatform Projects are an Alpha feature. See: https://kotlinlang.org/docs/reference/evolution/components-stability.html. To hide this message, add 'kotlin.mpp.stability.nowarn=true' to the Gradle properties.\n\nThe property 'kotlin.mpp.enableGranularSourceSetsMetadata=true' has no effect in this and future Kotlin versions, as Hierarchical Structures support is now enabled by default. It is safe to remove the property.\n\nThe property 'kotlin.native.enableDependencyPropagation=false' has no effect in this and future Kotlin versions, as Kotlin/Native dependency commonization is now enabled by default. It is safe to remove the property.\n\n\n> Task :compileKotlinNative UP-TO-DATE\n> Task :linkDebugExecutableNative UP-TO-DATE\n\n> Task :runDebugExecutableNative\nHello, Kotlin/Native!\n\nBUILD SUCCESSFUL in 3s\n3 actionable tasks: 1 executed, 2 up-to-date\n21:41:44: Execution finished 'runDebugExecutableNative'.\n```\n请在上述输出日志中寻找`Hello, Kotlin/Native`字符串，很不起眼。\n","source":"_posts/2022-09-23-Kotlin Native.md","raw":"---\nlayout: post\ntitle: Kotlin Native从初识到放弃\nauthor: boybeak\ncategories: Kotlin Native\ntags: Kotlin\ndate: 2022-09-23 00:00:00\n---\n\n此贴用于记录对Kotlin Native从初识到放弃的过程，因为还不清楚这一平台的开发能力上限多高，不排除用的好，会一直用下去。\n以下Kotlin Native会用KN来代替。\n\n## 开始\n首先，下载IDEA，我这里用的是社区版，社区版已经足以应对大多数情况了。\n然后，新建一个KN的项目。\n![kotlin-native-start.jpg](/images/kotlin-native-starter.jpg)\nIDE会自动生成hello world代码，直接点运行，如果工具栏的运行按钮没有可执行的配置，那就直接在Main.kt文件上右键运行。相比直接用Clion写**C/C++**代码的运行速度，KN项目运行要慢得多，因为要先执行gradle脚本。\n即便是这样，你也很可能第一次运行不成功，在macOs上，要安装*XCode command line tools*工具，我这里直接安装了完整版的XCode。\n然后继续尝试运行，你很可能会发现，依然执行不成功，报如下错误：\n```log\nThe /usr/bin/xcrun command returned non-zero exit code: 72\n```\n这时候，你需要打开XCode，执行一系列同意操作后，进入**Preferences** -> **Locations**，选中一个版本。如下：\n![xcode-select](/images/xcode-select.jpg)\n如果你没有安装完整XCode，可以尝试`xcode select`这个命令，这里具体不做详述。\n经过这个设置后，再次尝试运行，这次终于运行成功。\n```log\n21:41:11: Executing 'runDebugExecutableNative'...\n\nStarting Gradle Daemon...\nGradle Daemon started in 3 s 569 ms\n\n> Configure project :\nKotlin Multiplatform Projects are an Alpha feature. See: https://kotlinlang.org/docs/reference/evolution/components-stability.html. To hide this message, add 'kotlin.mpp.stability.nowarn=true' to the Gradle properties.\n\nThe property 'kotlin.mpp.enableGranularSourceSetsMetadata=true' has no effect in this and future Kotlin versions, as Hierarchical Structures support is now enabled by default. It is safe to remove the property.\n\nThe property 'kotlin.native.enableDependencyPropagation=false' has no effect in this and future Kotlin versions, as Kotlin/Native dependency commonization is now enabled by default. It is safe to remove the property.\n\n\n> Task :wrapper\n\nBUILD SUCCESSFUL in 21s\n1 actionable task: 1 executed\n\n> Configure project :\nKotlin Multiplatform Projects are an Alpha feature. See: https://kotlinlang.org/docs/reference/evolution/components-stability.html. To hide this message, add 'kotlin.mpp.stability.nowarn=true' to the Gradle properties.\n\nThe property 'kotlin.mpp.enableGranularSourceSetsMetadata=true' has no effect in this and future Kotlin versions, as Hierarchical Structures support is now enabled by default. It is safe to remove the property.\n\nThe property 'kotlin.native.enableDependencyPropagation=false' has no effect in this and future Kotlin versions, as Kotlin/Native dependency commonization is now enabled by default. It is safe to remove the property.\n\n\n> Task :compileKotlinNative UP-TO-DATE\n> Task :linkDebugExecutableNative UP-TO-DATE\n\n> Task :runDebugExecutableNative\nHello, Kotlin/Native!\n\nBUILD SUCCESSFUL in 3s\n3 actionable tasks: 1 executed, 2 up-to-date\n21:41:44: Execution finished 'runDebugExecutableNative'.\n```\n请在上述输出日志中寻找`Hello, Kotlin/Native`字符串，很不起眼。\n","slug":"2022-09-23-Kotlin Native","published":1,"updated":"2024-11-13T13:42:30.556Z","_id":"cm1ltr0g2001ibji08pul5boh","comments":1,"photos":["/images/kotlin-native-starter.jpg","/images/xcode-select.jpg"],"content":"<p>此贴用于记录对Kotlin Native从初识到放弃的过程，因为还不清楚这一平台的开发能力上限多高，不排除用的好，会一直用下去。<br>以下Kotlin Native会用KN来代替。</p>\n<h2 id=\"开始\"><a href=\"#开始\" class=\"headerlink\" title=\"开始\"></a>开始</h2><p>首先，下载IDEA，我这里用的是社区版，社区版已经足以应对大多数情况了。<br>然后，新建一个KN的项目。<br><img src=\"/images/kotlin-native-starter.jpg\" alt=\"kotlin-native-start.jpg\"><br>IDE会自动生成hello world代码，直接点运行，如果工具栏的运行按钮没有可执行的配置，那就直接在Main.kt文件上右键运行。相比直接用Clion写**C&#x2F;C++*<em>代码的运行速度，KN项目运行要慢得多，因为要先执行gradle脚本。<br>即便是这样，你也很可能第一次运行不成功，在macOs上，要安装</em>XCode command line tools*工具，我这里直接安装了完整版的XCode。<br>然后继续尝试运行，你很可能会发现，依然执行不成功，报如下错误：</p>\n<pre class=\"language-log\" data-language=\"log\"><code class=\"language-log\">The <span class=\"token file-path string\">/usr/bin/xcrun</span> command returned non<span class=\"token operator\">-</span>zero exit code<span class=\"token operator\">:</span> <span class=\"token number\">72</span></code></pre>\n<p>这时候，你需要打开XCode，执行一系列同意操作后，进入<strong>Preferences</strong> -&gt; <strong>Locations</strong>，选中一个版本。如下：<br><img src=\"/images/xcode-select.jpg\" alt=\"xcode-select\"><br>如果你没有安装完整XCode，可以尝试<code>xcode select</code>这个命令，这里具体不做详述。<br>经过这个设置后，再次尝试运行，这次终于运行成功。</p>\n<pre class=\"language-log\" data-language=\"log\"><code class=\"language-log\"><span class=\"token time number\">21:41:11</span><span class=\"token operator\">:</span> Executing <span class=\"token string\">'runDebugExecutableNative'</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\nStarting Gradle Daemon<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\nGradle Daemon started in <span class=\"token number\">3</span> s <span class=\"token number\">569</span> ms\n\n<span class=\"token operator\">></span> Configure project <span class=\"token operator\">:</span>\nKotlin Multiplatform Projects are an Alpha feature<span class=\"token punctuation\">.</span> See<span class=\"token operator\">:</span> <span class=\"token url\">https://kotlinlang.org/docs/reference/evolution/components-stability.html</span><span class=\"token punctuation\">.</span> To hide this message<span class=\"token punctuation\">,</span> add <span class=\"token string\">'kotlin.mpp.stability.nowarn=true'</span> to the Gradle properties<span class=\"token punctuation\">.</span>\n\nThe property <span class=\"token string\">'kotlin.mpp.enableGranularSourceSetsMetadata=true'</span> has no effect in this and future Kotlin versions<span class=\"token punctuation\">,</span> as Hierarchical Structures support is now enabled by default<span class=\"token punctuation\">.</span> It is safe to remove the property<span class=\"token punctuation\">.</span>\n\nThe property <span class=\"token string\">'kotlin.native.enableDependencyPropagation=false'</span> has no effect in this and future Kotlin versions<span class=\"token punctuation\">,</span> as Kotlin<span class=\"token operator\">/</span>Native dependency commonization is now enabled by default<span class=\"token punctuation\">.</span> It is safe to remove the property<span class=\"token punctuation\">.</span>\n\n\n<span class=\"token operator\">></span> Task <span class=\"token operator\">:</span>wrapper\n\nBUILD SUCCESSFUL in <span class=\"token number\">21s</span>\n<span class=\"token number\">1</span> actionable task<span class=\"token operator\">:</span> <span class=\"token number\">1</span> executed\n\n<span class=\"token operator\">></span> Configure project <span class=\"token operator\">:</span>\nKotlin Multiplatform Projects are an Alpha feature<span class=\"token punctuation\">.</span> See<span class=\"token operator\">:</span> <span class=\"token url\">https://kotlinlang.org/docs/reference/evolution/components-stability.html</span><span class=\"token punctuation\">.</span> To hide this message<span class=\"token punctuation\">,</span> add <span class=\"token string\">'kotlin.mpp.stability.nowarn=true'</span> to the Gradle properties<span class=\"token punctuation\">.</span>\n\nThe property <span class=\"token string\">'kotlin.mpp.enableGranularSourceSetsMetadata=true'</span> has no effect in this and future Kotlin versions<span class=\"token punctuation\">,</span> as Hierarchical Structures support is now enabled by default<span class=\"token punctuation\">.</span> It is safe to remove the property<span class=\"token punctuation\">.</span>\n\nThe property <span class=\"token string\">'kotlin.native.enableDependencyPropagation=false'</span> has no effect in this and future Kotlin versions<span class=\"token punctuation\">,</span> as Kotlin<span class=\"token operator\">/</span>Native dependency commonization is now enabled by default<span class=\"token punctuation\">.</span> It is safe to remove the property<span class=\"token punctuation\">.</span>\n\n\n<span class=\"token operator\">></span> Task <span class=\"token operator\">:</span>compileKotlinNative UP<span class=\"token operator\">-</span>TO<span class=\"token operator\">-</span>DATE\n<span class=\"token operator\">></span> Task <span class=\"token operator\">:</span>linkDebugExecutableNative UP<span class=\"token operator\">-</span>TO<span class=\"token operator\">-</span>DATE\n\n<span class=\"token operator\">></span> Task <span class=\"token operator\">:</span>runDebugExecutableNative\nHello<span class=\"token punctuation\">,</span> Kotlin<span class=\"token operator\">/</span>Native<span class=\"token operator\">!</span>\n\nBUILD SUCCESSFUL in <span class=\"token number\">3s</span>\n<span class=\"token number\">3</span> actionable tasks<span class=\"token operator\">:</span> <span class=\"token number\">1</span> executed<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span> up<span class=\"token operator\">-</span>to<span class=\"token operator\">-</span>date\n<span class=\"token time number\">21:41:44</span><span class=\"token operator\">:</span> Execution finished <span class=\"token string\">'runDebugExecutableNative'</span><span class=\"token punctuation\">.</span></code></pre>\n<p>请在上述输出日志中寻找<code>Hello, Kotlin/Native</code>字符串，很不起眼。</p>\n","excerpt":"","more":"<p>此贴用于记录对Kotlin Native从初识到放弃的过程，因为还不清楚这一平台的开发能力上限多高，不排除用的好，会一直用下去。<br>以下Kotlin Native会用KN来代替。</p>\n<h2 id=\"开始\"><a href=\"#开始\" class=\"headerlink\" title=\"开始\"></a>开始</h2><p>首先，下载IDEA，我这里用的是社区版，社区版已经足以应对大多数情况了。<br>然后，新建一个KN的项目。<br><img src=\"/images/kotlin-native-starter.jpg\" alt=\"kotlin-native-start.jpg\"><br>IDE会自动生成hello world代码，直接点运行，如果工具栏的运行按钮没有可执行的配置，那就直接在Main.kt文件上右键运行。相比直接用Clion写**C&#x2F;C++*<em>代码的运行速度，KN项目运行要慢得多，因为要先执行gradle脚本。<br>即便是这样，你也很可能第一次运行不成功，在macOs上，要安装</em>XCode command line tools*工具，我这里直接安装了完整版的XCode。<br>然后继续尝试运行，你很可能会发现，依然执行不成功，报如下错误：</p>\n<pre class=\"language-log\" data-language=\"log\"><code class=\"language-log\">The <span class=\"token file-path string\">/usr/bin/xcrun</span> command returned non<span class=\"token operator\">-</span>zero exit code<span class=\"token operator\">:</span> <span class=\"token number\">72</span></code></pre>\n<p>这时候，你需要打开XCode，执行一系列同意操作后，进入<strong>Preferences</strong> -&gt; <strong>Locations</strong>，选中一个版本。如下：<br><img src=\"/images/xcode-select.jpg\" alt=\"xcode-select\"><br>如果你没有安装完整XCode，可以尝试<code>xcode select</code>这个命令，这里具体不做详述。<br>经过这个设置后，再次尝试运行，这次终于运行成功。</p>\n<pre class=\"language-log\" data-language=\"log\"><code class=\"language-log\"><span class=\"token time number\">21:41:11</span><span class=\"token operator\">:</span> Executing <span class=\"token string\">'runDebugExecutableNative'</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\nStarting Gradle Daemon<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\nGradle Daemon started in <span class=\"token number\">3</span> s <span class=\"token number\">569</span> ms\n\n<span class=\"token operator\">></span> Configure project <span class=\"token operator\">:</span>\nKotlin Multiplatform Projects are an Alpha feature<span class=\"token punctuation\">.</span> See<span class=\"token operator\">:</span> <span class=\"token url\">https://kotlinlang.org/docs/reference/evolution/components-stability.html</span><span class=\"token punctuation\">.</span> To hide this message<span class=\"token punctuation\">,</span> add <span class=\"token string\">'kotlin.mpp.stability.nowarn=true'</span> to the Gradle properties<span class=\"token punctuation\">.</span>\n\nThe property <span class=\"token string\">'kotlin.mpp.enableGranularSourceSetsMetadata=true'</span> has no effect in this and future Kotlin versions<span class=\"token punctuation\">,</span> as Hierarchical Structures support is now enabled by default<span class=\"token punctuation\">.</span> It is safe to remove the property<span class=\"token punctuation\">.</span>\n\nThe property <span class=\"token string\">'kotlin.native.enableDependencyPropagation=false'</span> has no effect in this and future Kotlin versions<span class=\"token punctuation\">,</span> as Kotlin<span class=\"token operator\">/</span>Native dependency commonization is now enabled by default<span class=\"token punctuation\">.</span> It is safe to remove the property<span class=\"token punctuation\">.</span>\n\n\n<span class=\"token operator\">></span> Task <span class=\"token operator\">:</span>wrapper\n\nBUILD SUCCESSFUL in <span class=\"token number\">21s</span>\n<span class=\"token number\">1</span> actionable task<span class=\"token operator\">:</span> <span class=\"token number\">1</span> executed\n\n<span class=\"token operator\">></span> Configure project <span class=\"token operator\">:</span>\nKotlin Multiplatform Projects are an Alpha feature<span class=\"token punctuation\">.</span> See<span class=\"token operator\">:</span> <span class=\"token url\">https://kotlinlang.org/docs/reference/evolution/components-stability.html</span><span class=\"token punctuation\">.</span> To hide this message<span class=\"token punctuation\">,</span> add <span class=\"token string\">'kotlin.mpp.stability.nowarn=true'</span> to the Gradle properties<span class=\"token punctuation\">.</span>\n\nThe property <span class=\"token string\">'kotlin.mpp.enableGranularSourceSetsMetadata=true'</span> has no effect in this and future Kotlin versions<span class=\"token punctuation\">,</span> as Hierarchical Structures support is now enabled by default<span class=\"token punctuation\">.</span> It is safe to remove the property<span class=\"token punctuation\">.</span>\n\nThe property <span class=\"token string\">'kotlin.native.enableDependencyPropagation=false'</span> has no effect in this and future Kotlin versions<span class=\"token punctuation\">,</span> as Kotlin<span class=\"token operator\">/</span>Native dependency commonization is now enabled by default<span class=\"token punctuation\">.</span> It is safe to remove the property<span class=\"token punctuation\">.</span>\n\n\n<span class=\"token operator\">></span> Task <span class=\"token operator\">:</span>compileKotlinNative UP<span class=\"token operator\">-</span>TO<span class=\"token operator\">-</span>DATE\n<span class=\"token operator\">></span> Task <span class=\"token operator\">:</span>linkDebugExecutableNative UP<span class=\"token operator\">-</span>TO<span class=\"token operator\">-</span>DATE\n\n<span class=\"token operator\">></span> Task <span class=\"token operator\">:</span>runDebugExecutableNative\nHello<span class=\"token punctuation\">,</span> Kotlin<span class=\"token operator\">/</span>Native<span class=\"token operator\">!</span>\n\nBUILD SUCCESSFUL in <span class=\"token number\">3s</span>\n<span class=\"token number\">3</span> actionable tasks<span class=\"token operator\">:</span> <span class=\"token number\">1</span> executed<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span> up<span class=\"token operator\">-</span>to<span class=\"token operator\">-</span>date\n<span class=\"token time number\">21:41:44</span><span class=\"token operator\">:</span> Execution finished <span class=\"token string\">'runDebugExecutableNative'</span><span class=\"token punctuation\">.</span></code></pre>\n<p>请在上述输出日志中寻找<code>Hello, Kotlin/Native</code>字符串，很不起眼。</p>\n"},{"layout":"post","title":"难忘的bug","author":"boybeak","date":"2022-09-21T16:00:00.000Z","_content":"\n此贴是为了记录日常开发过程中，遇到的一些让人难忘的bug。\n* MediaPlayer: surface has already been released\n* kotlin ?.的陷阱与缺陷\n\n## surface has already been released\n**场景**：MediaPlayer做跨进程的视频播放发现的，由于有无画面的后台播放场景，所以，MediaPlayer的相关操作放在独立进程的Service中，通过跨进程的调度，进行相关媒体操作，包括设置用于展示画面的Surface，Surface是一个Parcable类，所以是可以通过跨进程传输的。\n**归因**：在播放进程中，用成员变量缓存了通过`setSurface`设置的surface变量，以便于从后台恢复前台播放时候，可以直接使用，而不需要再次传入surface参数。但是这样做是不可以的，会爆出`surface has already been released`的错误。\nIPlayer.aidl如下：\n```aidl\ninterface IPlayer {\n    void setSurface(inout Surface surface);\n}\n```\n需要注意的是，此处surface的修饰符包括一个inout。这样设置，是为了适配IjkMediaPlayer切换全屏的场景。如果把这个修饰符改成`in`，则IjkMediaPlayer在通过`setSurface`多次修改surface时候，也会爆出`surface has already been released`这样的问题。\n\n## kotlin ?.的陷阱与缺陷\n`?.`是kotlin的空安全语法。相比Java的if语句判断，这样做要简洁的多，但是这里边有一种“陷阱”，这并不是kotlin本身的问题，而是使用者容易疏忽的问题。\n展示逻辑的伪代码如下：\n```\n方法A(回调) {\n    结果1 = 动作1\n    结果2 = 动作2\n    回调(结果1, 结果2)\n}\n```\n简单解释一下，一个`方法A`，带有一个Nullable的`回调`，需要执行`动作1`和`动作2`，分别返回了`结果1`和`结果2`，并且在`回调`中返回结果。\n上述逻辑用kotlin实现如下：\n```kotlin\n// 方案一\nfun action1(): Int = 1\nfun action2(): Int = 2\nfun methodA(block: ((Int, Int) -> Unit)? = null) {\n    val result1 = action1()\n    val result2 = action2()\n    block?.invoke(result1, result2)\n}\n```\n或者\n```kotlin\n// 方案二\nfun action1(): Int = 1\nfun action2(): Int = 2\nfun methodA(block: ((Int, Int) -> Unit)? = null) {\n    block?.invoke(action1(), action2())\n}\n```\n如果你选择了方案二，那么你就掉入\"陷阱\"了。\n因为方法内执行的逻辑，不应该收到回调的影响。如果在`methodA`中传入了null作为参数，或者直接调用`methodA()`，这样参数`block`就为null，那么`方案二`是不等价于`方案一`的，我只是不需要知道方法的执行结果，不是让你不执行方法。","source":"_posts/2022-09-22-难忘的bug.md","raw":"---\nlayout: post\ntitle: 难忘的bug\nauthor: boybeak\ncategories: 陷阱与缺陷\ntags: 陷阱与缺陷\ndate: 2022-09-22 00:00:00\n---\n\n此贴是为了记录日常开发过程中，遇到的一些让人难忘的bug。\n* MediaPlayer: surface has already been released\n* kotlin ?.的陷阱与缺陷\n\n## surface has already been released\n**场景**：MediaPlayer做跨进程的视频播放发现的，由于有无画面的后台播放场景，所以，MediaPlayer的相关操作放在独立进程的Service中，通过跨进程的调度，进行相关媒体操作，包括设置用于展示画面的Surface，Surface是一个Parcable类，所以是可以通过跨进程传输的。\n**归因**：在播放进程中，用成员变量缓存了通过`setSurface`设置的surface变量，以便于从后台恢复前台播放时候，可以直接使用，而不需要再次传入surface参数。但是这样做是不可以的，会爆出`surface has already been released`的错误。\nIPlayer.aidl如下：\n```aidl\ninterface IPlayer {\n    void setSurface(inout Surface surface);\n}\n```\n需要注意的是，此处surface的修饰符包括一个inout。这样设置，是为了适配IjkMediaPlayer切换全屏的场景。如果把这个修饰符改成`in`，则IjkMediaPlayer在通过`setSurface`多次修改surface时候，也会爆出`surface has already been released`这样的问题。\n\n## kotlin ?.的陷阱与缺陷\n`?.`是kotlin的空安全语法。相比Java的if语句判断，这样做要简洁的多，但是这里边有一种“陷阱”，这并不是kotlin本身的问题，而是使用者容易疏忽的问题。\n展示逻辑的伪代码如下：\n```\n方法A(回调) {\n    结果1 = 动作1\n    结果2 = 动作2\n    回调(结果1, 结果2)\n}\n```\n简单解释一下，一个`方法A`，带有一个Nullable的`回调`，需要执行`动作1`和`动作2`，分别返回了`结果1`和`结果2`，并且在`回调`中返回结果。\n上述逻辑用kotlin实现如下：\n```kotlin\n// 方案一\nfun action1(): Int = 1\nfun action2(): Int = 2\nfun methodA(block: ((Int, Int) -> Unit)? = null) {\n    val result1 = action1()\n    val result2 = action2()\n    block?.invoke(result1, result2)\n}\n```\n或者\n```kotlin\n// 方案二\nfun action1(): Int = 1\nfun action2(): Int = 2\nfun methodA(block: ((Int, Int) -> Unit)? = null) {\n    block?.invoke(action1(), action2())\n}\n```\n如果你选择了方案二，那么你就掉入\"陷阱\"了。\n因为方法内执行的逻辑，不应该收到回调的影响。如果在`methodA`中传入了null作为参数，或者直接调用`methodA()`，这样参数`block`就为null，那么`方案二`是不等价于`方案一`的，我只是不需要知道方法的执行结果，不是让你不执行方法。","slug":"2022-09-22-难忘的bug","published":1,"updated":"2024-11-13T13:42:20.297Z","_id":"cm1ltr0g2001lbji0hgrgdmci","comments":1,"photos":[],"content":"<p>此贴是为了记录日常开发过程中，遇到的一些让人难忘的bug。</p>\n<ul>\n<li>MediaPlayer: surface has already been released</li>\n<li>kotlin ?.的陷阱与缺陷</li>\n</ul>\n<h2 id=\"surface-has-already-been-released\"><a href=\"#surface-has-already-been-released\" class=\"headerlink\" title=\"surface has already been released\"></a>surface has already been released</h2><p><strong>场景</strong>：MediaPlayer做跨进程的视频播放发现的，由于有无画面的后台播放场景，所以，MediaPlayer的相关操作放在独立进程的Service中，通过跨进程的调度，进行相关媒体操作，包括设置用于展示画面的Surface，Surface是一个Parcable类，所以是可以通过跨进程传输的。<br><strong>归因</strong>：在播放进程中，用成员变量缓存了通过<code>setSurface</code>设置的surface变量，以便于从后台恢复前台播放时候，可以直接使用，而不需要再次传入surface参数。但是这样做是不可以的，会爆出<code>surface has already been released</code>的错误。<br>IPlayer.aidl如下：</p>\n<pre class=\"language-aidl\" data-language=\"aidl\"><code class=\"language-aidl\">interface IPlayer &#123;\n    void setSurface(inout Surface surface);\n&#125;</code></pre>\n<p>需要注意的是，此处surface的修饰符包括一个inout。这样设置，是为了适配IjkMediaPlayer切换全屏的场景。如果把这个修饰符改成<code>in</code>，则IjkMediaPlayer在通过<code>setSurface</code>多次修改surface时候，也会爆出<code>surface has already been released</code>这样的问题。</p>\n<h2 id=\"kotlin-的陷阱与缺陷\"><a href=\"#kotlin-的陷阱与缺陷\" class=\"headerlink\" title=\"kotlin ?.的陷阱与缺陷\"></a>kotlin ?.的陷阱与缺陷</h2><p><code>?.</code>是kotlin的空安全语法。相比Java的if语句判断，这样做要简洁的多，但是这里边有一种“陷阱”，这并不是kotlin本身的问题，而是使用者容易疏忽的问题。<br>展示逻辑的伪代码如下：</p>\n<pre class=\"language-none\"><code class=\"language-none\">方法A(回调) &#123;\n    结果1 &#x3D; 动作1\n    结果2 &#x3D; 动作2\n    回调(结果1, 结果2)\n&#125;</code></pre>\n<p>简单解释一下，一个<code>方法A</code>，带有一个Nullable的<code>回调</code>，需要执行<code>动作1</code>和<code>动作2</code>，分别返回了<code>结果1</code>和<code>结果2</code>，并且在<code>回调</code>中返回结果。<br>上述逻辑用kotlin实现如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">// 方案一</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">action1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">action2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">methodA</span><span class=\"token punctuation\">(</span>block<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Int<span class=\"token punctuation\">,</span> Int<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> Unit<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">val</span> result1 <span class=\"token operator\">=</span> <span class=\"token function\">action1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> result2 <span class=\"token operator\">=</span> <span class=\"token function\">action2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    block<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>result1<span class=\"token punctuation\">,</span> result2<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>或者</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">// 方案二</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">action1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">action2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">methodA</span><span class=\"token punctuation\">(</span>block<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Int<span class=\"token punctuation\">,</span> Int<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> Unit<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    block<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span><span class=\"token function\">action1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">action2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>如果你选择了方案二，那么你就掉入”陷阱”了。<br>因为方法内执行的逻辑，不应该收到回调的影响。如果在<code>methodA</code>中传入了null作为参数，或者直接调用<code>methodA()</code>，这样参数<code>block</code>就为null，那么<code>方案二</code>是不等价于<code>方案一</code>的，我只是不需要知道方法的执行结果，不是让你不执行方法。</p>\n","excerpt":"","more":"<p>此贴是为了记录日常开发过程中，遇到的一些让人难忘的bug。</p>\n<ul>\n<li>MediaPlayer: surface has already been released</li>\n<li>kotlin ?.的陷阱与缺陷</li>\n</ul>\n<h2 id=\"surface-has-already-been-released\"><a href=\"#surface-has-already-been-released\" class=\"headerlink\" title=\"surface has already been released\"></a>surface has already been released</h2><p><strong>场景</strong>：MediaPlayer做跨进程的视频播放发现的，由于有无画面的后台播放场景，所以，MediaPlayer的相关操作放在独立进程的Service中，通过跨进程的调度，进行相关媒体操作，包括设置用于展示画面的Surface，Surface是一个Parcable类，所以是可以通过跨进程传输的。<br><strong>归因</strong>：在播放进程中，用成员变量缓存了通过<code>setSurface</code>设置的surface变量，以便于从后台恢复前台播放时候，可以直接使用，而不需要再次传入surface参数。但是这样做是不可以的，会爆出<code>surface has already been released</code>的错误。<br>IPlayer.aidl如下：</p>\n<pre class=\"language-aidl\" data-language=\"aidl\"><code class=\"language-aidl\">interface IPlayer &#123;\n    void setSurface(inout Surface surface);\n&#125;</code></pre>\n<p>需要注意的是，此处surface的修饰符包括一个inout。这样设置，是为了适配IjkMediaPlayer切换全屏的场景。如果把这个修饰符改成<code>in</code>，则IjkMediaPlayer在通过<code>setSurface</code>多次修改surface时候，也会爆出<code>surface has already been released</code>这样的问题。</p>\n<h2 id=\"kotlin-的陷阱与缺陷\"><a href=\"#kotlin-的陷阱与缺陷\" class=\"headerlink\" title=\"kotlin ?.的陷阱与缺陷\"></a>kotlin ?.的陷阱与缺陷</h2><p><code>?.</code>是kotlin的空安全语法。相比Java的if语句判断，这样做要简洁的多，但是这里边有一种“陷阱”，这并不是kotlin本身的问题，而是使用者容易疏忽的问题。<br>展示逻辑的伪代码如下：</p>\n<pre class=\"language-none\"><code class=\"language-none\">方法A(回调) &#123;\n    结果1 &#x3D; 动作1\n    结果2 &#x3D; 动作2\n    回调(结果1, 结果2)\n&#125;</code></pre>\n<p>简单解释一下，一个<code>方法A</code>，带有一个Nullable的<code>回调</code>，需要执行<code>动作1</code>和<code>动作2</code>，分别返回了<code>结果1</code>和<code>结果2</code>，并且在<code>回调</code>中返回结果。<br>上述逻辑用kotlin实现如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">// 方案一</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">action1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">action2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">methodA</span><span class=\"token punctuation\">(</span>block<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Int<span class=\"token punctuation\">,</span> Int<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> Unit<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">val</span> result1 <span class=\"token operator\">=</span> <span class=\"token function\">action1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> result2 <span class=\"token operator\">=</span> <span class=\"token function\">action2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    block<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>result1<span class=\"token punctuation\">,</span> result2<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>或者</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">// 方案二</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">action1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">action2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">methodA</span><span class=\"token punctuation\">(</span>block<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Int<span class=\"token punctuation\">,</span> Int<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> Unit<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    block<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span><span class=\"token function\">action1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">action2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>如果你选择了方案二，那么你就掉入”陷阱”了。<br>因为方法内执行的逻辑，不应该收到回调的影响。如果在<code>methodA</code>中传入了null作为参数，或者直接调用<code>methodA()</code>，这样参数<code>block</code>就为null，那么<code>方案二</code>是不等价于<code>方案一</code>的，我只是不需要知道方法的执行结果，不是让你不执行方法。</p>\n"},{"layout":"post","title":"Android的clipToXXX","author":"boybeak","date":"2022-10-12T16:00:00.000Z","_content":"\n最近处理工作bug的过程中，有一个需求是这样的，两层view，父view包含着子view，然后子view能显示出的区域，要以父view的背景来过滤。没看懂是不是？参考下图：\n<!-- more -->\n![playground](/images/playground.jpg)\n简单说，就是子view的背景显示区域，不能超过父view的背景区域。\n\n## clipToOutline\n经过一番搜索尝试，终于查到，可以通过`clipToOutline` + `outlineProvider`来实现，说来惭愧，做了将近20年android开发，竟然到现在才知道这样的特性。\n具体代码如下：\n```xml\n<FrameLayout\n    android:id=\"@+id/togetherParent\"\n    android:layout_width=\"100dp\"\n    android:layout_height=\"100dp\"\n    android:layout_margin=\"8dp\"\n    android:background=\"@drawable/bg_parent\"\n    android:clipToOutline=\"true\"\n    android:outlineProvider=\"background\"\n    >\n    <View\n        android:id=\"@+id/togetherChild\"\n        android:layout_width=\"100dp\"\n        android:layout_height=\"100dp\"\n        android:background=\"@drawable/bg_child\"/>\n</FrameLayout>\n```\n但是以上代码只可以在API Level 31及以上使用，要增大适用版本范围，可以用以下代码，在kotlin中实现：\n```kotlin\nparent.clipToOutline = true\nparent.outlineProvider = ViewOutlineProvider.BACKGROUND\n```\nkotlin中代码，就可以实现，低至API Level 21及以上使用。\n\n除了`clipToOutline`，我还发现了其他`clipToXXX`有关的API。\n\n## clipChildren","source":"_posts/2022-10-13-clipToXXX.md","raw":"---\nlayout: post\ntitle: Android的clipToXXX\nauthor: boybeak\ncategories: Android技巧\ntags: Android\ndate: 2022-10-13 00:00:00\n---\n\n最近处理工作bug的过程中，有一个需求是这样的，两层view，父view包含着子view，然后子view能显示出的区域，要以父view的背景来过滤。没看懂是不是？参考下图：\n<!-- more -->\n![playground](/images/playground.jpg)\n简单说，就是子view的背景显示区域，不能超过父view的背景区域。\n\n## clipToOutline\n经过一番搜索尝试，终于查到，可以通过`clipToOutline` + `outlineProvider`来实现，说来惭愧，做了将近20年android开发，竟然到现在才知道这样的特性。\n具体代码如下：\n```xml\n<FrameLayout\n    android:id=\"@+id/togetherParent\"\n    android:layout_width=\"100dp\"\n    android:layout_height=\"100dp\"\n    android:layout_margin=\"8dp\"\n    android:background=\"@drawable/bg_parent\"\n    android:clipToOutline=\"true\"\n    android:outlineProvider=\"background\"\n    >\n    <View\n        android:id=\"@+id/togetherChild\"\n        android:layout_width=\"100dp\"\n        android:layout_height=\"100dp\"\n        android:background=\"@drawable/bg_child\"/>\n</FrameLayout>\n```\n但是以上代码只可以在API Level 31及以上使用，要增大适用版本范围，可以用以下代码，在kotlin中实现：\n```kotlin\nparent.clipToOutline = true\nparent.outlineProvider = ViewOutlineProvider.BACKGROUND\n```\nkotlin中代码，就可以实现，低至API Level 21及以上使用。\n\n除了`clipToOutline`，我还发现了其他`clipToXXX`有关的API。\n\n## clipChildren","slug":"2022-10-13-clipToXXX","published":1,"updated":"2024-11-13T13:42:44.699Z","_id":"cm1ltr0g2001qbji023gx8ruq","comments":1,"photos":["/images/playground.jpg"],"content":"<p>最近处理工作bug的过程中，有一个需求是这样的，两层view，父view包含着子view，然后子view能显示出的区域，要以父view的背景来过滤。没看懂是不是？参考下图：</p>\n<span id=\"more\"></span>\n<p><img src=\"/images/playground.jpg\" alt=\"playground\"><br>简单说，就是子view的背景显示区域，不能超过父view的背景区域。</p>\n<h2 id=\"clipToOutline\"><a href=\"#clipToOutline\" class=\"headerlink\" title=\"clipToOutline\"></a>clipToOutline</h2><p>经过一番搜索尝试，终于查到，可以通过<code>clipToOutline</code> + <code>outlineProvider</code>来实现，说来惭愧，做了将近20年android开发，竟然到现在才知道这样的特性。<br>具体代码如下：</p>\n<pre class=\"language-markup\" data-language=\"markup\"><code class=\"language-markup\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>FrameLayout</span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@+id/togetherParent<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_width</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>100dp<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_height</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>100dp<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_margin</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>8dp<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>background</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@drawable/bg_parent<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>clipToOutline</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>outlineProvider</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>background<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>View</span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@+id/togetherChild<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_width</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>100dp<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_height</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>100dp<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>background</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@drawable/bg_child<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>FrameLayout</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>但是以上代码只可以在API Level 31及以上使用，要增大适用版本范围，可以用以下代码，在kotlin中实现：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\">parent<span class=\"token punctuation\">.</span>clipToOutline <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\nparent<span class=\"token punctuation\">.</span>outlineProvider <span class=\"token operator\">=</span> ViewOutlineProvider<span class=\"token punctuation\">.</span>BACKGROUND</code></pre>\n<p>kotlin中代码，就可以实现，低至API Level 21及以上使用。</p>\n<p>除了<code>clipToOutline</code>，我还发现了其他<code>clipToXXX</code>有关的API。</p>\n<h2 id=\"clipChildren\"><a href=\"#clipChildren\" class=\"headerlink\" title=\"clipChildren\"></a>clipChildren</h2>","excerpt":"<p>最近处理工作bug的过程中，有一个需求是这样的，两层view，父view包含着子view，然后子view能显示出的区域，要以父view的背景来过滤。没看懂是不是？参考下图：</p>","more":"<p><img src=\"/images/playground.jpg\" alt=\"playground\"><br>简单说，就是子view的背景显示区域，不能超过父view的背景区域。</p>\n<h2 id=\"clipToOutline\"><a href=\"#clipToOutline\" class=\"headerlink\" title=\"clipToOutline\"></a>clipToOutline</h2><p>经过一番搜索尝试，终于查到，可以通过<code>clipToOutline</code> + <code>outlineProvider</code>来实现，说来惭愧，做了将近20年android开发，竟然到现在才知道这样的特性。<br>具体代码如下：</p>\n<pre class=\"language-markup\" data-language=\"markup\"><code class=\"language-markup\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>FrameLayout</span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@+id/togetherParent<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_width</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>100dp<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_height</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>100dp<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_margin</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>8dp<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>background</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@drawable/bg_parent<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>clipToOutline</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>outlineProvider</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>background<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>View</span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@+id/togetherChild<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_width</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>100dp<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_height</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>100dp<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>background</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@drawable/bg_child<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>FrameLayout</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>但是以上代码只可以在API Level 31及以上使用，要增大适用版本范围，可以用以下代码，在kotlin中实现：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\">parent<span class=\"token punctuation\">.</span>clipToOutline <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\nparent<span class=\"token punctuation\">.</span>outlineProvider <span class=\"token operator\">=</span> ViewOutlineProvider<span class=\"token punctuation\">.</span>BACKGROUND</code></pre>\n<p>kotlin中代码，就可以实现，低至API Level 21及以上使用。</p>\n<p>除了<code>clipToOutline</code>，我还发现了其他<code>clipToXXX</code>有关的API。</p>\n<h2 id=\"clipChildren\"><a href=\"#clipChildren\" class=\"headerlink\" title=\"clipChildren\"></a>clipChildren</h2>"},{"title":"Translator","author":"boybeak","date":"2022-11-01T16:00:00.000Z","_content":"\nA simple translator app for macOS.\n<!-- more -->\n<h1>\n    <img style=\"vertical-align: bottom;\" src=\"/images/translator-logo-512.png\" width=\"48\" height=\"48\" />\n    Translator\n    <img src=\"https://img.shields.io/badge/Translator-0.1-blue\" />\n</h1>\n\nTranslator is a simple translation app based on [Tencent Machine Translation](https://cloud.tencent.com/document/product/551/15611) API. Only macOs version is available at this moment.\n\n<img src=\"/images/preview.jpg\" width=\"285\" height=\"195\" />\n\n## Releases\n","source":"_posts/2022-11-02-Translator.md","raw":"---\ntitle: Translator\nauthor: boybeak\ncategories: Translator\ntags: Translator\ndate: 2022-11-02 00:00:00\n---\n\nA simple translator app for macOS.\n<!-- more -->\n<h1>\n    <img style=\"vertical-align: bottom;\" src=\"/images/translator-logo-512.png\" width=\"48\" height=\"48\" />\n    Translator\n    <img src=\"https://img.shields.io/badge/Translator-0.1-blue\" />\n</h1>\n\nTranslator is a simple translation app based on [Tencent Machine Translation](https://cloud.tencent.com/document/product/551/15611) API. Only macOs version is available at this moment.\n\n<img src=\"/images/preview.jpg\" width=\"285\" height=\"195\" />\n\n## Releases\n","slug":"2022-11-02-Translator","published":1,"updated":"2024-11-14T03:08:35.470Z","_id":"cm1ltr0g2001tbji07vdr8e7r","comments":1,"layout":"post","photos":["/images/translator-logo-512.png","https://img.shields.io/badge/Translator-0.1-blue","/images/preview.jpg"],"content":"<p>A simple translator app for macOS.</p>\n<span id=\"more\"></span>\n<h1>\n    <img style=\"vertical-align: bottom;\" src=\"/images/translator-logo-512.png\" width=\"48\" height=\"48\" />\n    Translator\n    <img src=\"https://img.shields.io/badge/Translator-0.1-blue\" />\n</h1>\n\n<p>Translator is a simple translation app based on <a href=\"https://cloud.tencent.com/document/product/551/15611\">Tencent Machine Translation</a> API. Only macOs version is available at this moment.</p>\n<img src=\"/images/preview.jpg\" width=\"285\" height=\"195\" />\n\n<h2 id=\"Releases\"><a href=\"#Releases\" class=\"headerlink\" title=\"Releases\"></a>Releases</h2>","excerpt":"<p>A simple translator app for macOS.</p>","more":"<h1>\n    <img style=\"vertical-align: bottom;\" src=\"/images/translator-logo-512.png\" width=\"48\" height=\"48\" />\n    Translator\n    <img src=\"https://img.shields.io/badge/Translator-0.1-blue\" />\n</h1>\n\n<p>Translator is a simple translation app based on <a href=\"https://cloud.tencent.com/document/product/551/15611\">Tencent Machine Translation</a> API. Only macOs version is available at this moment.</p>\n<img src=\"/images/preview.jpg\" width=\"285\" height=\"195\" />\n\n<h2 id=\"Releases\"><a href=\"#Releases\" class=\"headerlink\" title=\"Releases\"></a>Releases</h2>"},{"title":"Jitpack托管库","date":"2023-03-04T07:31:00.000Z","_content":"\n以前只是用过别人托管在Jitpack上的库，自己的库都是托管在MavenCentral上，但是MavenCentral使用起来，相比Jitpack还是有些麻烦。经过简单尝试和学习，了解了Jitpack的使用，做一下简单记录。\n\n我第一个托管在Jitpack上的库——[J2V8Helper](https://github.com/boybeak/J2V8Helper)\n\n## Step 1: 在library module中使用maven-publish插件\n\n在库目录下的build.gradle文件中，应用maven-publish插件，修改后的build.gradle文件入下：\n\n```groovy\nplugins {\n    id 'com.android.library'\n    id 'org.jetbrains.kotlin.android'\n    id 'maven-publish'\n}\n// Other code\n```\n\n然后检查此插件是否引入成功，在AndroidStudio的右侧，Gradle面板中，library module下查看有无`publishing`的任务组。\n\n> 如果找不到，有可能是AndroidStudio配置的问题，在AndroidStudio的设置中，进入**Experimental**选项卡中，找到**Gradle**分组，找到`Only include test tasks in the Gradle task list generated during Gradle Sync`，如果勾选了，请不要勾选此选项。\n\n在library module下的build.gradle结尾，添加如下代码：\n\n```groovy\nafterEvaluate {\n    publishing {\n        publications {\n            // Creates a Maven publication called \"release\".\n            release(MavenPublication) {\n                // Applies the component for the release build variant.\n                from components.release\n\n                // You can then customize attributes of the publication as shown below.\n                groupId = 'com.github.xyz'\n                artifactId = 'abc'\n                version = '0.0.1'\n            }\n            // Creates a Maven publication called “debug”.\n            debug(MavenPublication) {\n                // Applies the component for the debug build variant.\n                from components.debug\n\n                groupId = 'com.github.xyz'\n                artifactId = 'abc'\n                version = '0.0.1'\n            }\n        }\n    }\n}\n```\n\n> 需要注意的是，此配置，在Jitpack的编译中，并不会生效，Jitpack中你的库的引用，永远都是`com.github.{你github用户名}:{此项目在gitHub上repository的名字}:{创建release的tag名字}`。此处配置，只为检查你的maven-publish是否生效。\n\n然后执行Gradle任务中的`publishReleasePublicationToMavenLocal`，待执行完毕，查看$HOME/.m2/responsitory路径下，有无你的库存在。如果成功，请执行下一步骤。\n\n## Step 2: 将代码push到github并新建release\n\n在你Github对于的repository下，新建一个tag和release。\n\n## Step 3: 在jitpack.io搜索你的库，并执行打包\n\n打开[https://jitpack.io/](https://jitpack.io/)\n\n![](/images/jitpack.png)\n\n点击Get it，然后等待编译结束，如果编译失败，会有日志记录，可以查看对应的日志来处理。\n\n需要注意的是，Jitpack默认的java版本为java8，如果你的Gradle版本比较高的话，比如我项目的Gradle版本为7.4.0，需要修改java版本，在项目的根目录下，创建一个jitpack.yml文件，增加配置脚本如下：\n\n```yml\njdk:\n  - openjdk11\n```\n\nGradle版本7.4.0对应最低编译版本为java11，则我修改为openjdk11。\n\n\n\n## 参考文章\n\n[**Publish an Android Library**](https://jitpack.io/docs/ANDROID/#create-your-release)\n\n**[使用 Maven Publish 插件]([使用 Maven Publish 插件 &nbsp;|&nbsp; Android 开发者 &nbsp;|&nbsp; Android Developers](https://developer.android.com/studio/build/maven-publish-plugin?hl=zh-cn))**\n\n**[Maven Publish Plugin](https://docs.gradle.org/current/userguide/publishing_maven.html)**\n\n**[Android发布AAR至JitPack.io](https://www.jianshu.com/p/604d56b46506)**\n\n**[Guide to publishing libraries]([Building - JitPack.io](https://jitpack.io/docs/BUILDING/))**\n\n\n","source":"_posts/2023-03-04-Jitpack托管库.md","raw":"---\ntitle: 'Jitpack托管库'\ndate: 2023-03-04 15:31\ncategories: Android技巧\ntags: Android\n---\n\n以前只是用过别人托管在Jitpack上的库，自己的库都是托管在MavenCentral上，但是MavenCentral使用起来，相比Jitpack还是有些麻烦。经过简单尝试和学习，了解了Jitpack的使用，做一下简单记录。\n\n我第一个托管在Jitpack上的库——[J2V8Helper](https://github.com/boybeak/J2V8Helper)\n\n## Step 1: 在library module中使用maven-publish插件\n\n在库目录下的build.gradle文件中，应用maven-publish插件，修改后的build.gradle文件入下：\n\n```groovy\nplugins {\n    id 'com.android.library'\n    id 'org.jetbrains.kotlin.android'\n    id 'maven-publish'\n}\n// Other code\n```\n\n然后检查此插件是否引入成功，在AndroidStudio的右侧，Gradle面板中，library module下查看有无`publishing`的任务组。\n\n> 如果找不到，有可能是AndroidStudio配置的问题，在AndroidStudio的设置中，进入**Experimental**选项卡中，找到**Gradle**分组，找到`Only include test tasks in the Gradle task list generated during Gradle Sync`，如果勾选了，请不要勾选此选项。\n\n在library module下的build.gradle结尾，添加如下代码：\n\n```groovy\nafterEvaluate {\n    publishing {\n        publications {\n            // Creates a Maven publication called \"release\".\n            release(MavenPublication) {\n                // Applies the component for the release build variant.\n                from components.release\n\n                // You can then customize attributes of the publication as shown below.\n                groupId = 'com.github.xyz'\n                artifactId = 'abc'\n                version = '0.0.1'\n            }\n            // Creates a Maven publication called “debug”.\n            debug(MavenPublication) {\n                // Applies the component for the debug build variant.\n                from components.debug\n\n                groupId = 'com.github.xyz'\n                artifactId = 'abc'\n                version = '0.0.1'\n            }\n        }\n    }\n}\n```\n\n> 需要注意的是，此配置，在Jitpack的编译中，并不会生效，Jitpack中你的库的引用，永远都是`com.github.{你github用户名}:{此项目在gitHub上repository的名字}:{创建release的tag名字}`。此处配置，只为检查你的maven-publish是否生效。\n\n然后执行Gradle任务中的`publishReleasePublicationToMavenLocal`，待执行完毕，查看$HOME/.m2/responsitory路径下，有无你的库存在。如果成功，请执行下一步骤。\n\n## Step 2: 将代码push到github并新建release\n\n在你Github对于的repository下，新建一个tag和release。\n\n## Step 3: 在jitpack.io搜索你的库，并执行打包\n\n打开[https://jitpack.io/](https://jitpack.io/)\n\n![](/images/jitpack.png)\n\n点击Get it，然后等待编译结束，如果编译失败，会有日志记录，可以查看对应的日志来处理。\n\n需要注意的是，Jitpack默认的java版本为java8，如果你的Gradle版本比较高的话，比如我项目的Gradle版本为7.4.0，需要修改java版本，在项目的根目录下，创建一个jitpack.yml文件，增加配置脚本如下：\n\n```yml\njdk:\n  - openjdk11\n```\n\nGradle版本7.4.0对应最低编译版本为java11，则我修改为openjdk11。\n\n\n\n## 参考文章\n\n[**Publish an Android Library**](https://jitpack.io/docs/ANDROID/#create-your-release)\n\n**[使用 Maven Publish 插件]([使用 Maven Publish 插件 &nbsp;|&nbsp; Android 开发者 &nbsp;|&nbsp; Android Developers](https://developer.android.com/studio/build/maven-publish-plugin?hl=zh-cn))**\n\n**[Maven Publish Plugin](https://docs.gradle.org/current/userguide/publishing_maven.html)**\n\n**[Android发布AAR至JitPack.io](https://www.jianshu.com/p/604d56b46506)**\n\n**[Guide to publishing libraries]([Building - JitPack.io](https://jitpack.io/docs/BUILDING/))**\n\n\n","slug":"2023-03-04-Jitpack托管库","published":1,"updated":"2024-09-25T02:53:02.292Z","comments":1,"layout":"post","photos":["/images/jitpack.png"],"_id":"cm1ltr0g3001wbji0gs50h1yb","content":"<p>以前只是用过别人托管在Jitpack上的库，自己的库都是托管在MavenCentral上，但是MavenCentral使用起来，相比Jitpack还是有些麻烦。经过简单尝试和学习，了解了Jitpack的使用，做一下简单记录。</p>\n<p>我第一个托管在Jitpack上的库——<a href=\"https://github.com/boybeak/J2V8Helper\">J2V8Helper</a></p>\n<h2 id=\"Step-1-在library-module中使用maven-publish插件\"><a href=\"#Step-1-在library-module中使用maven-publish插件\" class=\"headerlink\" title=\"Step 1: 在library module中使用maven-publish插件\"></a>Step 1: 在library module中使用maven-publish插件</h2><p>在库目录下的build.gradle文件中，应用maven-publish插件，修改后的build.gradle文件入下：</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">plugins <span class=\"token punctuation\">&#123;</span>\n    id <span class=\"token string\">'com.android.library'</span>\n    id <span class=\"token string\">'org.jetbrains.kotlin.android'</span>\n    id <span class=\"token string\">'maven-publish'</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token comment\">// Other code</span></code></pre>\n\n<p>然后检查此插件是否引入成功，在AndroidStudio的右侧，Gradle面板中，library module下查看有无<code>publishing</code>的任务组。</p>\n<blockquote>\n<p>如果找不到，有可能是AndroidStudio配置的问题，在AndroidStudio的设置中，进入<strong>Experimental</strong>选项卡中，找到<strong>Gradle</strong>分组，找到<code>Only include test tasks in the Gradle task list generated during Gradle Sync</code>，如果勾选了，请不要勾选此选项。</p>\n</blockquote>\n<p>在library module下的build.gradle结尾，添加如下代码：</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">afterEvaluate <span class=\"token punctuation\">&#123;</span>\n    publishing <span class=\"token punctuation\">&#123;</span>\n        publications <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">// Creates a Maven publication called \"release\".</span>\n            <span class=\"token function\">release</span><span class=\"token punctuation\">(</span>MavenPublication<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token comment\">// Applies the component for the release build variant.</span>\n                from components<span class=\"token punctuation\">.</span>release\n\n                <span class=\"token comment\">// You can then customize attributes of the publication as shown below.</span>\n                groupId <span class=\"token operator\">=</span> <span class=\"token string\">'com.github.xyz'</span>\n                artifactId <span class=\"token operator\">=</span> <span class=\"token string\">'abc'</span>\n                version <span class=\"token operator\">=</span> <span class=\"token string\">'0.0.1'</span>\n            <span class=\"token punctuation\">&#125;</span>\n            <span class=\"token comment\">// Creates a Maven publication called “debug”.</span>\n            <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span>MavenPublication<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token comment\">// Applies the component for the debug build variant.</span>\n                from components<span class=\"token punctuation\">.</span>debug\n\n                groupId <span class=\"token operator\">=</span> <span class=\"token string\">'com.github.xyz'</span>\n                artifactId <span class=\"token operator\">=</span> <span class=\"token string\">'abc'</span>\n                version <span class=\"token operator\">=</span> <span class=\"token string\">'0.0.1'</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<blockquote>\n<p>需要注意的是，此配置，在Jitpack的编译中，并不会生效，Jitpack中你的库的引用，永远都是<code>com.github.&#123;你github用户名&#125;:&#123;此项目在gitHub上repository的名字&#125;:&#123;创建release的tag名字&#125;</code>。此处配置，只为检查你的maven-publish是否生效。</p>\n</blockquote>\n<p>然后执行Gradle任务中的<code>publishReleasePublicationToMavenLocal</code>，待执行完毕，查看$HOME&#x2F;.m2&#x2F;responsitory路径下，有无你的库存在。如果成功，请执行下一步骤。</p>\n<h2 id=\"Step-2-将代码push到github并新建release\"><a href=\"#Step-2-将代码push到github并新建release\" class=\"headerlink\" title=\"Step 2: 将代码push到github并新建release\"></a>Step 2: 将代码push到github并新建release</h2><p>在你Github对于的repository下，新建一个tag和release。</p>\n<h2 id=\"Step-3-在jitpack-io搜索你的库，并执行打包\"><a href=\"#Step-3-在jitpack-io搜索你的库，并执行打包\" class=\"headerlink\" title=\"Step 3: 在jitpack.io搜索你的库，并执行打包\"></a>Step 3: 在jitpack.io搜索你的库，并执行打包</h2><p>打开<a href=\"https://jitpack.io/\">https://jitpack.io/</a></p>\n<p><img src=\"/images/jitpack.png\"></p>\n<p>点击Get it，然后等待编译结束，如果编译失败，会有日志记录，可以查看对应的日志来处理。</p>\n<p>需要注意的是，Jitpack默认的java版本为java8，如果你的Gradle版本比较高的话，比如我项目的Gradle版本为7.4.0，需要修改java版本，在项目的根目录下，创建一个jitpack.yml文件，增加配置脚本如下：</p>\n<pre class=\"language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">jdk</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> openjdk11</code></pre>\n\n<p>Gradle版本7.4.0对应最低编译版本为java11，则我修改为openjdk11。</p>\n<h2 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h2><p><a href=\"https://jitpack.io/docs/ANDROID/#create-your-release\"><strong>Publish an Android Library</strong></a></p>\n<p><strong>[使用 Maven Publish 插件](<a href=\"https://developer.android.com/studio/build/maven-publish-plugin?hl=zh-cn\">使用 Maven Publish 插件 &nbsp;|&nbsp; Android 开发者 &nbsp;|&nbsp; Android Developers</a>)</strong></p>\n<p><strong><a href=\"https://docs.gradle.org/current/userguide/publishing_maven.html\">Maven Publish Plugin</a></strong></p>\n<p><strong><a href=\"https://www.jianshu.com/p/604d56b46506\">Android发布AAR至JitPack.io</a></strong></p>\n<p><strong>[Guide to publishing libraries](<a href=\"https://jitpack.io/docs/BUILDING/\">Building - JitPack.io</a>)</strong></p>\n","excerpt":"","more":"<p>以前只是用过别人托管在Jitpack上的库，自己的库都是托管在MavenCentral上，但是MavenCentral使用起来，相比Jitpack还是有些麻烦。经过简单尝试和学习，了解了Jitpack的使用，做一下简单记录。</p>\n<p>我第一个托管在Jitpack上的库——<a href=\"https://github.com/boybeak/J2V8Helper\">J2V8Helper</a></p>\n<h2 id=\"Step-1-在library-module中使用maven-publish插件\"><a href=\"#Step-1-在library-module中使用maven-publish插件\" class=\"headerlink\" title=\"Step 1: 在library module中使用maven-publish插件\"></a>Step 1: 在library module中使用maven-publish插件</h2><p>在库目录下的build.gradle文件中，应用maven-publish插件，修改后的build.gradle文件入下：</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">plugins <span class=\"token punctuation\">&#123;</span>\n    id <span class=\"token string\">'com.android.library'</span>\n    id <span class=\"token string\">'org.jetbrains.kotlin.android'</span>\n    id <span class=\"token string\">'maven-publish'</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token comment\">// Other code</span></code></pre>\n\n<p>然后检查此插件是否引入成功，在AndroidStudio的右侧，Gradle面板中，library module下查看有无<code>publishing</code>的任务组。</p>\n<blockquote>\n<p>如果找不到，有可能是AndroidStudio配置的问题，在AndroidStudio的设置中，进入<strong>Experimental</strong>选项卡中，找到<strong>Gradle</strong>分组，找到<code>Only include test tasks in the Gradle task list generated during Gradle Sync</code>，如果勾选了，请不要勾选此选项。</p>\n</blockquote>\n<p>在library module下的build.gradle结尾，添加如下代码：</p>\n<pre class=\"language-groovy\" data-language=\"groovy\"><code class=\"language-groovy\">afterEvaluate <span class=\"token punctuation\">&#123;</span>\n    publishing <span class=\"token punctuation\">&#123;</span>\n        publications <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">// Creates a Maven publication called \"release\".</span>\n            <span class=\"token function\">release</span><span class=\"token punctuation\">(</span>MavenPublication<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token comment\">// Applies the component for the release build variant.</span>\n                from components<span class=\"token punctuation\">.</span>release\n\n                <span class=\"token comment\">// You can then customize attributes of the publication as shown below.</span>\n                groupId <span class=\"token operator\">=</span> <span class=\"token string\">'com.github.xyz'</span>\n                artifactId <span class=\"token operator\">=</span> <span class=\"token string\">'abc'</span>\n                version <span class=\"token operator\">=</span> <span class=\"token string\">'0.0.1'</span>\n            <span class=\"token punctuation\">&#125;</span>\n            <span class=\"token comment\">// Creates a Maven publication called “debug”.</span>\n            <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span>MavenPublication<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token comment\">// Applies the component for the debug build variant.</span>\n                from components<span class=\"token punctuation\">.</span>debug\n\n                groupId <span class=\"token operator\">=</span> <span class=\"token string\">'com.github.xyz'</span>\n                artifactId <span class=\"token operator\">=</span> <span class=\"token string\">'abc'</span>\n                version <span class=\"token operator\">=</span> <span class=\"token string\">'0.0.1'</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<blockquote>\n<p>需要注意的是，此配置，在Jitpack的编译中，并不会生效，Jitpack中你的库的引用，永远都是<code>com.github.&#123;你github用户名&#125;:&#123;此项目在gitHub上repository的名字&#125;:&#123;创建release的tag名字&#125;</code>。此处配置，只为检查你的maven-publish是否生效。</p>\n</blockquote>\n<p>然后执行Gradle任务中的<code>publishReleasePublicationToMavenLocal</code>，待执行完毕，查看$HOME&#x2F;.m2&#x2F;responsitory路径下，有无你的库存在。如果成功，请执行下一步骤。</p>\n<h2 id=\"Step-2-将代码push到github并新建release\"><a href=\"#Step-2-将代码push到github并新建release\" class=\"headerlink\" title=\"Step 2: 将代码push到github并新建release\"></a>Step 2: 将代码push到github并新建release</h2><p>在你Github对于的repository下，新建一个tag和release。</p>\n<h2 id=\"Step-3-在jitpack-io搜索你的库，并执行打包\"><a href=\"#Step-3-在jitpack-io搜索你的库，并执行打包\" class=\"headerlink\" title=\"Step 3: 在jitpack.io搜索你的库，并执行打包\"></a>Step 3: 在jitpack.io搜索你的库，并执行打包</h2><p>打开<a href=\"https://jitpack.io/\">https://jitpack.io/</a></p>\n<p><img src=\"/images/jitpack.png\"></p>\n<p>点击Get it，然后等待编译结束，如果编译失败，会有日志记录，可以查看对应的日志来处理。</p>\n<p>需要注意的是，Jitpack默认的java版本为java8，如果你的Gradle版本比较高的话，比如我项目的Gradle版本为7.4.0，需要修改java版本，在项目的根目录下，创建一个jitpack.yml文件，增加配置脚本如下：</p>\n<pre class=\"language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">jdk</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> openjdk11</code></pre>\n\n<p>Gradle版本7.4.0对应最低编译版本为java11，则我修改为openjdk11。</p>\n<h2 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h2><p><a href=\"https://jitpack.io/docs/ANDROID/#create-your-release\"><strong>Publish an Android Library</strong></a></p>\n<p><strong>[使用 Maven Publish 插件](<a href=\"https://developer.android.com/studio/build/maven-publish-plugin?hl=zh-cn\">使用 Maven Publish 插件 &nbsp;|&nbsp; Android 开发者 &nbsp;|&nbsp; Android Developers</a>)</strong></p>\n<p><strong><a href=\"https://docs.gradle.org/current/userguide/publishing_maven.html\">Maven Publish Plugin</a></strong></p>\n<p><strong><a href=\"https://www.jianshu.com/p/604d56b46506\">Android发布AAR至JitPack.io</a></strong></p>\n<p><strong>[Guide to publishing libraries](<a href=\"https://jitpack.io/docs/BUILDING/\">Building - JitPack.io</a>)</strong></p>\n"},{"title":"难忘的调试技巧","date":"2023-05-04T14:29:55.000Z","_content":"\n这里用于总结一些在工作中发现的调试技巧。\n\n## Handler是否繁忙？\n\n这一技巧来自于最近工作中，做子线程渲染时，发现有卡顿、手势操作延迟过大的情况，而渲染的子线程是一个HandlerThread，为了判断此线程是否有大量耗时操作，探索出一些技巧。\n\n##判断HandlerThread是否繁忙##\n可以通过对应的Handler执行一个post操作，在看其中执行的延迟，代码如下：\n\n```kotlin\nval handler = Handler(renderThread.looper)\nval postAt = System.currentTimeMillis()\nhandler.post {\n    val delay = System.currentTimeMillis() - postAt\n    Log.d(TAG, \"renderThread.delay=$delay\")\n}\n```\n\n在正常情况下，`delay`的值是很小的，大概率为0，但是，如果renderThread异常繁忙，则这个值会很大，说明等了很久来轮到一个需要立马执行的操作执行到，具体这个阈值怎么来定，要看你的实际场景，一般做ui渲染的话，超过17ms就可以认为是比较耗时了。\n这个操作可以定时执行用于检测是否繁忙，也可以用于在怀疑的操作后添加此行为，判断是否是之前的操作耗时过长引起了操作延迟过大。\n\n##如何找到导致繁忙的操作？##\n上述操作，一般是用于常规检测和重点怀疑，如果要做“普筛”，则需要通过代理的方式。方法如下：\n\n```kotlin\nclass DebugThread(val task: Runnable, val postDelayed: Long) :  Runnable {\n\n    private val pendingRunAt = System.currentTimeMillis() + postDelayed\n\n    override fun run() {\n        val now = System.currentTimeMillis()\n        task.run()\n        val cost = System.currentTimeMillis() - now\n        val delay = now - pendingRunAt\n        if (delay < 10 && cost > 160) {\n            Log.w(TAG, \"Oops!!!\")\n        }\n    }\n}\n```\n\n需要将所有`handler.post`与`handler.postDelayed`中的Runnable换成上面的代理类，在代理类中观察是否有耗时操作，一般`delay`比较小，说明此操作前没有耗时操作导致当前操作延迟，而`cost`值比较大，说明会引起之后操作延迟过大，可以在打印出具体的`delay`与`cost`值进行操作前后比较。\n不过这种方式的缺点是不够灵活，需要将大量的，甚至是所有的post操作进行代理。","source":"_posts/2023-05-04-难忘的调试技巧.md","raw":"---\n\ntitle: '难忘的调试技巧'\ndate: 2023-05-04 22:29:55\ncategories: Android技巧\ntags: Android\n\n---\n\n这里用于总结一些在工作中发现的调试技巧。\n\n## Handler是否繁忙？\n\n这一技巧来自于最近工作中，做子线程渲染时，发现有卡顿、手势操作延迟过大的情况，而渲染的子线程是一个HandlerThread，为了判断此线程是否有大量耗时操作，探索出一些技巧。\n\n##判断HandlerThread是否繁忙##\n可以通过对应的Handler执行一个post操作，在看其中执行的延迟，代码如下：\n\n```kotlin\nval handler = Handler(renderThread.looper)\nval postAt = System.currentTimeMillis()\nhandler.post {\n    val delay = System.currentTimeMillis() - postAt\n    Log.d(TAG, \"renderThread.delay=$delay\")\n}\n```\n\n在正常情况下，`delay`的值是很小的，大概率为0，但是，如果renderThread异常繁忙，则这个值会很大，说明等了很久来轮到一个需要立马执行的操作执行到，具体这个阈值怎么来定，要看你的实际场景，一般做ui渲染的话，超过17ms就可以认为是比较耗时了。\n这个操作可以定时执行用于检测是否繁忙，也可以用于在怀疑的操作后添加此行为，判断是否是之前的操作耗时过长引起了操作延迟过大。\n\n##如何找到导致繁忙的操作？##\n上述操作，一般是用于常规检测和重点怀疑，如果要做“普筛”，则需要通过代理的方式。方法如下：\n\n```kotlin\nclass DebugThread(val task: Runnable, val postDelayed: Long) :  Runnable {\n\n    private val pendingRunAt = System.currentTimeMillis() + postDelayed\n\n    override fun run() {\n        val now = System.currentTimeMillis()\n        task.run()\n        val cost = System.currentTimeMillis() - now\n        val delay = now - pendingRunAt\n        if (delay < 10 && cost > 160) {\n            Log.w(TAG, \"Oops!!!\")\n        }\n    }\n}\n```\n\n需要将所有`handler.post`与`handler.postDelayed`中的Runnable换成上面的代理类，在代理类中观察是否有耗时操作，一般`delay`比较小，说明此操作前没有耗时操作导致当前操作延迟，而`cost`值比较大，说明会引起之后操作延迟过大，可以在打印出具体的`delay`与`cost`值进行操作前后比较。\n不过这种方式的缺点是不够灵活，需要将大量的，甚至是所有的post操作进行代理。","slug":"2023-05-04-难忘的调试技巧","published":1,"updated":"2024-09-25T02:53:02.294Z","comments":1,"layout":"post","photos":[],"_id":"cm1ltr0g30021bji0461ielbd","content":"<p>这里用于总结一些在工作中发现的调试技巧。</p>\n<h2 id=\"Handler是否繁忙？\"><a href=\"#Handler是否繁忙？\" class=\"headerlink\" title=\"Handler是否繁忙？\"></a>Handler是否繁忙？</h2><p>这一技巧来自于最近工作中，做子线程渲染时，发现有卡顿、手势操作延迟过大的情况，而渲染的子线程是一个HandlerThread，为了判断此线程是否有大量耗时操作，探索出一些技巧。</p>\n<p>##判断HandlerThread是否繁忙##<br>可以通过对应的Handler执行一个post操作，在看其中执行的延迟，代码如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> handler <span class=\"token operator\">=</span> <span class=\"token function\">Handler</span><span class=\"token punctuation\">(</span>renderThread<span class=\"token punctuation\">.</span>looper<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> postAt <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nhandler<span class=\"token punctuation\">.</span><span class=\"token function\">post</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">val</span> delay <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> postAt\n    Log<span class=\"token punctuation\">.</span><span class=\"token function\">d</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"renderThread.delay=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">delay</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在正常情况下，<code>delay</code>的值是很小的，大概率为0，但是，如果renderThread异常繁忙，则这个值会很大，说明等了很久来轮到一个需要立马执行的操作执行到，具体这个阈值怎么来定，要看你的实际场景，一般做ui渲染的话，超过17ms就可以认为是比较耗时了。<br>这个操作可以定时执行用于检测是否繁忙，也可以用于在怀疑的操作后添加此行为，判断是否是之前的操作耗时过长引起了操作延迟过大。</p>\n<p>##如何找到导致繁忙的操作？##<br>上述操作，一般是用于常规检测和重点怀疑，如果要做“普筛”，则需要通过代理的方式。方法如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">DebugThread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> task<span class=\"token operator\">:</span> Runnable<span class=\"token punctuation\">,</span> <span class=\"token keyword\">val</span> postDelayed<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span>  Runnable <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> pendingRunAt <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> postDelayed\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">val</span> now <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        task<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> cost <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> now\n        <span class=\"token keyword\">val</span> delay <span class=\"token operator\">=</span> now <span class=\"token operator\">-</span> pendingRunAt\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>delay <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span> <span class=\"token operator\">&amp;&amp;</span> cost <span class=\"token operator\">></span> <span class=\"token number\">160</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            Log<span class=\"token punctuation\">.</span><span class=\"token function\">w</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"Oops!!!\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>需要将所有<code>handler.post</code>与<code>handler.postDelayed</code>中的Runnable换成上面的代理类，在代理类中观察是否有耗时操作，一般<code>delay</code>比较小，说明此操作前没有耗时操作导致当前操作延迟，而<code>cost</code>值比较大，说明会引起之后操作延迟过大，可以在打印出具体的<code>delay</code>与<code>cost</code>值进行操作前后比较。<br>不过这种方式的缺点是不够灵活，需要将大量的，甚至是所有的post操作进行代理。</p>\n","excerpt":"","more":"<p>这里用于总结一些在工作中发现的调试技巧。</p>\n<h2 id=\"Handler是否繁忙？\"><a href=\"#Handler是否繁忙？\" class=\"headerlink\" title=\"Handler是否繁忙？\"></a>Handler是否繁忙？</h2><p>这一技巧来自于最近工作中，做子线程渲染时，发现有卡顿、手势操作延迟过大的情况，而渲染的子线程是一个HandlerThread，为了判断此线程是否有大量耗时操作，探索出一些技巧。</p>\n<p>##判断HandlerThread是否繁忙##<br>可以通过对应的Handler执行一个post操作，在看其中执行的延迟，代码如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> handler <span class=\"token operator\">=</span> <span class=\"token function\">Handler</span><span class=\"token punctuation\">(</span>renderThread<span class=\"token punctuation\">.</span>looper<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> postAt <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nhandler<span class=\"token punctuation\">.</span><span class=\"token function\">post</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">val</span> delay <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> postAt\n    Log<span class=\"token punctuation\">.</span><span class=\"token function\">d</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"renderThread.delay=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">delay</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在正常情况下，<code>delay</code>的值是很小的，大概率为0，但是，如果renderThread异常繁忙，则这个值会很大，说明等了很久来轮到一个需要立马执行的操作执行到，具体这个阈值怎么来定，要看你的实际场景，一般做ui渲染的话，超过17ms就可以认为是比较耗时了。<br>这个操作可以定时执行用于检测是否繁忙，也可以用于在怀疑的操作后添加此行为，判断是否是之前的操作耗时过长引起了操作延迟过大。</p>\n<p>##如何找到导致繁忙的操作？##<br>上述操作，一般是用于常规检测和重点怀疑，如果要做“普筛”，则需要通过代理的方式。方法如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">DebugThread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> task<span class=\"token operator\">:</span> Runnable<span class=\"token punctuation\">,</span> <span class=\"token keyword\">val</span> postDelayed<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span>  Runnable <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> pendingRunAt <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> postDelayed\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">val</span> now <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        task<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> cost <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> now\n        <span class=\"token keyword\">val</span> delay <span class=\"token operator\">=</span> now <span class=\"token operator\">-</span> pendingRunAt\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>delay <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span> <span class=\"token operator\">&amp;&amp;</span> cost <span class=\"token operator\">></span> <span class=\"token number\">160</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            Log<span class=\"token punctuation\">.</span><span class=\"token function\">w</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"Oops!!!\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>需要将所有<code>handler.post</code>与<code>handler.postDelayed</code>中的Runnable换成上面的代理类，在代理类中观察是否有耗时操作，一般<code>delay</code>比较小，说明此操作前没有耗时操作导致当前操作延迟，而<code>cost</code>值比较大，说明会引起之后操作延迟过大，可以在打印出具体的<code>delay</code>与<code>cost</code>值进行操作前后比较。<br>不过这种方式的缺点是不够灵活，需要将大量的，甚至是所有的post操作进行代理。</p>\n"},{"title":"软键盘高度监测最佳实践","date":"2023-07-29T12:01:00.000Z","_content":"\n最近终于总结出最佳的软键盘高度监测方案了，特此分享出来。\n源码在此：[KeyboardObserver.kt](https://gist.github.com/boybeak/62ab557ace8a9763f12803b82f274df5)\n\n## 视觉效果\n\n当开启showDebug时候，可以看到这样的可视化的键盘高度监测。\n![showcase](../images/keyboard-height.gif)\n\n## 源码分析\n\n简单来说，这里说通过两个PopupWindow来实现的键盘高度测量。一个用于测量**当前屏幕状态可绘制区域的最大高度**，一个用于跟随键盘移动，进而通过高度差，算出键盘的高度。我们这里将前者称为RulerPopWin, 后者称为CursorPopWin。他们的代码分别如下：\n\n```kotlin\n// RulerPopWin\nprivate val rulerPopWin by lazy { makeRulerPopWin(activity) }\nprivate fun makeRulerPopWin(activity: Activity) = PopupWindow(activity).apply {\n    contentView = if (showDebug) {\n        TextView(activity).apply {\n            background = GradientDrawable().apply {\n                this.setStroke(1.dp, Color.LTGRAY)\n            }\n            gravity = Gravity.BOTTOM or Gravity.CENTER_HORIZONTAL\n            setTextColor(Color.RED)\n        }\n    } else {\n       View(activity)\n    }\n    setBackgroundDrawable(null)\n    width = if (showDebug) 80.dp else 1\n    height = WindowManager.LayoutParams.MATCH_PARENT\n    elevation = 0F\n\n    isFocusable = false\n    isTouchable = false\n    isOutsideTouchable = false\n}\n```\n\n```kotlin\n// CursorPopWin\nprivate val cursorPopWin by lazy { makeCursorPopWin(activity) }\nprivate fun makeCursorPopWin(activity: Activity) = PopupWindow(activity).apply {\n    contentView = if (showDebug) {\n        FrameLayout(activity).apply {\n            addView(\n                View(activity).apply {\n                    background = ColorDrawable(Color.RED)\n                },\n                FrameLayout.LayoutParams(\n                    FrameLayout.LayoutParams.MATCH_PARENT,\n                    1.dp,\n                    Gravity.BOTTOM\n                )\n            )\n        }\n    } else {\n        View(activity)\n    }\n    setBackgroundDrawable(null)\n\n    width = if (showDebug) 80.dp else 1\n    height = WindowManager.LayoutParams.MATCH_PARENT\n    elevation = 0F\n\n    softInputMode = WindowManager.LayoutParams.SOFT_INPUT_ADJUST_RESIZE\n    inputMethodMode = PopupWindow.INPUT_METHOD_NEEDED\n\n    isFocusable = false\n    isTouchable = false\n    isOutsideTouchable = false\n}\n```\n\n这两个PopupWindow，除了contentView不同以外，还有两个属性不同，cursorPopWin多了两个属性\n\n```kotlin\nsoftInputMode = WindowManager.LayoutParams.SOFT_INPUT_ADJUST_RESIZE\ninputMethodMode = PopupWindow.INPUT_METHOD_NEEDED\n```\n\n这两个属性，使得cursorPopWin高度会随着软键盘的弹出而变化。\n\n当开启监听时，为**cursorPopWin.contentView**设置一个OnLayoutChangeListener，用于监听其布局变化。\n\n```kotlin\nfun watch() {\n    if (!cursorPopWin.isShowing) {\n        cursorPopWin.showAtLocation(decorView, Gravity.BOTTOM or Gravity.END, 0, 0)\n        cursorPopWin.contentView.addOnLayoutChangeListener(cursorLayoutChangeListener)\n    }\n}\n```\n\n```kotlin\nprivate val cursorLayoutChangeListener = OnLayoutChangeListener { _, _, _, _, _, _, _, _, _ ->\n    if (rulerPopWin.isShowing) {\n        rulerPopWin.dismiss()\n    }\n    rulerPopWin.showAtLocation(decorView, Gravity.BOTTOM or Gravity.END, 0, 0)\n    rulerPopWin.contentView.addOnLayoutChangeListener(rulerLayoutChangeListener)\n}\n```\n\n在cursorLayoutChangeListener中，监听到cursotPopWin的变化后，再显示rulerPopWin。为什么要这么做呢？\n\n> 因为在实践中，软键盘的变化，触发了onLayoutChange方法，如果是在这之前就把rulerPopWin显示出来，在某些机型或者系统版本中，也会出现rulerPopWin跟随键盘改变尺寸的情况。所以要将rulerPopWin显示在键盘弹出之后。\n\n真实的键盘高度监听，实际上说在rulerLayoutChangeListener中。\n\n```kotlin\nprivate val rulerLayoutChangeListener = object : OnLayoutChangeListener {\n    override fun onLayoutChange(\n        v: View?,\n        left: Int,\n        top: Int,\n        right: Int,\n        bottom: Int,\n        oldLeft: Int,\n        oldTop: Int,\n        oldRight: Int,\n        oldBottom: Int\n    ) {\n        rulerPopWin.contentView.removeOnLayoutChangeListener(this)\n        rulerPopWin.contentView.getGlobalVisibleRect(rulerRect)\n        cursorPopWin.contentView.getGlobalVisibleRect(cursorRect)\n\n        val keyboardHeight = rulerRect.bottom - cursorRect.bottom\n\n        if (callbacks.isNotEmpty()) {\n            val cbs = ArrayList<Callback>(callbacks)\n            cbs.forEach {\n                it.onKeyboardHeightChanged(keyboardHeight)\n            }\n            cbs.clear()\n        }\n\n        if (showDebug) {\n            (v as TextView).run {\n\n                text = \"$keyboardHeight\"\n                setPadding(0, 0, 0, max(keyboardHeight - this.lineHeight, 0))\n            }\n        }\n    }\n\n}\n```\n\nOK，这就是全部关键逻辑了。\n\n## Q&A\n\n1. 为什么要通过rulerPopWin来获取高度，用其他获取屏幕高度的方法不好吗？\n   \n   > 不可以，这里rulerPopWin，实际上是测量**当前状态下**，键盘收起时的最底部。这个状态受到很多其他方面的影响，比如横竖屏切换、底部导航条的显示或者隐藏。如果通过直接获取屏幕高度的方式，并不能与状态严格对其。尤其说底部导航条的各种显示模式，导致键盘收起的0线也是变化的。\n\n2. 为什么不只用一个cursorPopWin的软键盘弹起前后进行差值计算高度呢？\n   \n   > 这样做在实践中也是不可行的。同样跟问题1中的场景类似，由于底部导航条各种显示模式的影响，导致软键盘0线是不确定的，而软键盘的弹起与收回，可能对应着不同的导航条显示模式，也就对应着不同的0线，这样计算出来的软键盘高度，很容易把导航条的高度也算进去。\n\n3. 由问题2想到，把导航条的高度减掉不就是键盘的高度了吗？\n   \n   > 这样做理论上可行，但是实践上问题会很多。首先，你要针对不同的导航条模式做不同策略；其次，不同系统的导航条的高度不同，包括说传统3键导航条还是全面屏手势；再次，目前获取导航条高度，并没有一个完美的方案，有些系统下获取到的高度，跟实际高度是不相符的。\n","source":"_posts/2023-07-29-软键盘高度监测最佳实践.md","raw":"---\ntitle: '软键盘高度监测最佳实践'\ndate: 2023-07-29 20:01:00\ncategories: Android技巧\ntags: Android\n---\n\n最近终于总结出最佳的软键盘高度监测方案了，特此分享出来。\n源码在此：[KeyboardObserver.kt](https://gist.github.com/boybeak/62ab557ace8a9763f12803b82f274df5)\n\n## 视觉效果\n\n当开启showDebug时候，可以看到这样的可视化的键盘高度监测。\n![showcase](../images/keyboard-height.gif)\n\n## 源码分析\n\n简单来说，这里说通过两个PopupWindow来实现的键盘高度测量。一个用于测量**当前屏幕状态可绘制区域的最大高度**，一个用于跟随键盘移动，进而通过高度差，算出键盘的高度。我们这里将前者称为RulerPopWin, 后者称为CursorPopWin。他们的代码分别如下：\n\n```kotlin\n// RulerPopWin\nprivate val rulerPopWin by lazy { makeRulerPopWin(activity) }\nprivate fun makeRulerPopWin(activity: Activity) = PopupWindow(activity).apply {\n    contentView = if (showDebug) {\n        TextView(activity).apply {\n            background = GradientDrawable().apply {\n                this.setStroke(1.dp, Color.LTGRAY)\n            }\n            gravity = Gravity.BOTTOM or Gravity.CENTER_HORIZONTAL\n            setTextColor(Color.RED)\n        }\n    } else {\n       View(activity)\n    }\n    setBackgroundDrawable(null)\n    width = if (showDebug) 80.dp else 1\n    height = WindowManager.LayoutParams.MATCH_PARENT\n    elevation = 0F\n\n    isFocusable = false\n    isTouchable = false\n    isOutsideTouchable = false\n}\n```\n\n```kotlin\n// CursorPopWin\nprivate val cursorPopWin by lazy { makeCursorPopWin(activity) }\nprivate fun makeCursorPopWin(activity: Activity) = PopupWindow(activity).apply {\n    contentView = if (showDebug) {\n        FrameLayout(activity).apply {\n            addView(\n                View(activity).apply {\n                    background = ColorDrawable(Color.RED)\n                },\n                FrameLayout.LayoutParams(\n                    FrameLayout.LayoutParams.MATCH_PARENT,\n                    1.dp,\n                    Gravity.BOTTOM\n                )\n            )\n        }\n    } else {\n        View(activity)\n    }\n    setBackgroundDrawable(null)\n\n    width = if (showDebug) 80.dp else 1\n    height = WindowManager.LayoutParams.MATCH_PARENT\n    elevation = 0F\n\n    softInputMode = WindowManager.LayoutParams.SOFT_INPUT_ADJUST_RESIZE\n    inputMethodMode = PopupWindow.INPUT_METHOD_NEEDED\n\n    isFocusable = false\n    isTouchable = false\n    isOutsideTouchable = false\n}\n```\n\n这两个PopupWindow，除了contentView不同以外，还有两个属性不同，cursorPopWin多了两个属性\n\n```kotlin\nsoftInputMode = WindowManager.LayoutParams.SOFT_INPUT_ADJUST_RESIZE\ninputMethodMode = PopupWindow.INPUT_METHOD_NEEDED\n```\n\n这两个属性，使得cursorPopWin高度会随着软键盘的弹出而变化。\n\n当开启监听时，为**cursorPopWin.contentView**设置一个OnLayoutChangeListener，用于监听其布局变化。\n\n```kotlin\nfun watch() {\n    if (!cursorPopWin.isShowing) {\n        cursorPopWin.showAtLocation(decorView, Gravity.BOTTOM or Gravity.END, 0, 0)\n        cursorPopWin.contentView.addOnLayoutChangeListener(cursorLayoutChangeListener)\n    }\n}\n```\n\n```kotlin\nprivate val cursorLayoutChangeListener = OnLayoutChangeListener { _, _, _, _, _, _, _, _, _ ->\n    if (rulerPopWin.isShowing) {\n        rulerPopWin.dismiss()\n    }\n    rulerPopWin.showAtLocation(decorView, Gravity.BOTTOM or Gravity.END, 0, 0)\n    rulerPopWin.contentView.addOnLayoutChangeListener(rulerLayoutChangeListener)\n}\n```\n\n在cursorLayoutChangeListener中，监听到cursotPopWin的变化后，再显示rulerPopWin。为什么要这么做呢？\n\n> 因为在实践中，软键盘的变化，触发了onLayoutChange方法，如果是在这之前就把rulerPopWin显示出来，在某些机型或者系统版本中，也会出现rulerPopWin跟随键盘改变尺寸的情况。所以要将rulerPopWin显示在键盘弹出之后。\n\n真实的键盘高度监听，实际上说在rulerLayoutChangeListener中。\n\n```kotlin\nprivate val rulerLayoutChangeListener = object : OnLayoutChangeListener {\n    override fun onLayoutChange(\n        v: View?,\n        left: Int,\n        top: Int,\n        right: Int,\n        bottom: Int,\n        oldLeft: Int,\n        oldTop: Int,\n        oldRight: Int,\n        oldBottom: Int\n    ) {\n        rulerPopWin.contentView.removeOnLayoutChangeListener(this)\n        rulerPopWin.contentView.getGlobalVisibleRect(rulerRect)\n        cursorPopWin.contentView.getGlobalVisibleRect(cursorRect)\n\n        val keyboardHeight = rulerRect.bottom - cursorRect.bottom\n\n        if (callbacks.isNotEmpty()) {\n            val cbs = ArrayList<Callback>(callbacks)\n            cbs.forEach {\n                it.onKeyboardHeightChanged(keyboardHeight)\n            }\n            cbs.clear()\n        }\n\n        if (showDebug) {\n            (v as TextView).run {\n\n                text = \"$keyboardHeight\"\n                setPadding(0, 0, 0, max(keyboardHeight - this.lineHeight, 0))\n            }\n        }\n    }\n\n}\n```\n\nOK，这就是全部关键逻辑了。\n\n## Q&A\n\n1. 为什么要通过rulerPopWin来获取高度，用其他获取屏幕高度的方法不好吗？\n   \n   > 不可以，这里rulerPopWin，实际上是测量**当前状态下**，键盘收起时的最底部。这个状态受到很多其他方面的影响，比如横竖屏切换、底部导航条的显示或者隐藏。如果通过直接获取屏幕高度的方式，并不能与状态严格对其。尤其说底部导航条的各种显示模式，导致键盘收起的0线也是变化的。\n\n2. 为什么不只用一个cursorPopWin的软键盘弹起前后进行差值计算高度呢？\n   \n   > 这样做在实践中也是不可行的。同样跟问题1中的场景类似，由于底部导航条各种显示模式的影响，导致软键盘0线是不确定的，而软键盘的弹起与收回，可能对应着不同的导航条显示模式，也就对应着不同的0线，这样计算出来的软键盘高度，很容易把导航条的高度也算进去。\n\n3. 由问题2想到，把导航条的高度减掉不就是键盘的高度了吗？\n   \n   > 这样做理论上可行，但是实践上问题会很多。首先，你要针对不同的导航条模式做不同策略；其次，不同系统的导航条的高度不同，包括说传统3键导航条还是全面屏手势；再次，目前获取导航条高度，并没有一个完美的方案，有些系统下获取到的高度，跟实际高度是不相符的。\n","slug":"2023-07-29-软键盘高度监测最佳实践","published":1,"updated":"2024-09-25T02:53:02.297Z","comments":1,"layout":"post","photos":["../images/keyboard-height.gif"],"_id":"cm1ltr0g30024bji07z2q6je4","content":"<p>最近终于总结出最佳的软键盘高度监测方案了，特此分享出来。<br>源码在此：<a href=\"https://gist.github.com/boybeak/62ab557ace8a9763f12803b82f274df5\">KeyboardObserver.kt</a></p>\n<h2 id=\"视觉效果\"><a href=\"#视觉效果\" class=\"headerlink\" title=\"视觉效果\"></a>视觉效果</h2><p>当开启showDebug时候，可以看到这样的可视化的键盘高度监测。<br><img src=\"/../images/keyboard-height.gif\" alt=\"showcase\"></p>\n<h2 id=\"源码分析\"><a href=\"#源码分析\" class=\"headerlink\" title=\"源码分析\"></a>源码分析</h2><p>简单来说，这里说通过两个PopupWindow来实现的键盘高度测量。一个用于测量<strong>当前屏幕状态可绘制区域的最大高度</strong>，一个用于跟随键盘移动，进而通过高度差，算出键盘的高度。我们这里将前者称为RulerPopWin, 后者称为CursorPopWin。他们的代码分别如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">// RulerPopWin</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> rulerPopWin <span class=\"token keyword\">by</span> lazy <span class=\"token punctuation\">&#123;</span> <span class=\"token function\">makeRulerPopWin</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">makeRulerPopWin</span><span class=\"token punctuation\">(</span>activity<span class=\"token operator\">:</span> Activity<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">PopupWindow</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">&#123;</span>\n    contentView <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>showDebug<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">TextView</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">&#123;</span>\n            background <span class=\"token operator\">=</span> <span class=\"token function\">GradientDrawable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setStroke</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">.</span>dp<span class=\"token punctuation\">,</span> Color<span class=\"token punctuation\">.</span>LTGRAY<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#125;</span>\n            gravity <span class=\"token operator\">=</span> Gravity<span class=\"token punctuation\">.</span>BOTTOM <span class=\"token operator\">or</span> Gravity<span class=\"token punctuation\">.</span>CENTER_HORIZONTAL\n            <span class=\"token function\">setTextColor</span><span class=\"token punctuation\">(</span>Color<span class=\"token punctuation\">.</span>RED<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n       <span class=\"token function\">View</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token function\">setBackgroundDrawable</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n    width <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>showDebug<span class=\"token punctuation\">)</span> <span class=\"token number\">80</span><span class=\"token punctuation\">.</span>dp <span class=\"token keyword\">else</span> <span class=\"token number\">1</span>\n    height <span class=\"token operator\">=</span> WindowManager<span class=\"token punctuation\">.</span>LayoutParams<span class=\"token punctuation\">.</span>MATCH_PARENT\n    elevation <span class=\"token operator\">=</span> <span class=\"token number\">0F</span>\n\n    isFocusable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    isTouchable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    isOutsideTouchable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">// CursorPopWin</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> cursorPopWin <span class=\"token keyword\">by</span> lazy <span class=\"token punctuation\">&#123;</span> <span class=\"token function\">makeCursorPopWin</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">makeCursorPopWin</span><span class=\"token punctuation\">(</span>activity<span class=\"token operator\">:</span> Activity<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">PopupWindow</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">&#123;</span>\n    contentView <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>showDebug<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">FrameLayout</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token function\">addView</span><span class=\"token punctuation\">(</span>\n                <span class=\"token function\">View</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">&#123;</span>\n                    background <span class=\"token operator\">=</span> <span class=\"token function\">ColorDrawable</span><span class=\"token punctuation\">(</span>Color<span class=\"token punctuation\">.</span>RED<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n                FrameLayout<span class=\"token punctuation\">.</span><span class=\"token function\">LayoutParams</span><span class=\"token punctuation\">(</span>\n                    FrameLayout<span class=\"token punctuation\">.</span>LayoutParams<span class=\"token punctuation\">.</span>MATCH_PARENT<span class=\"token punctuation\">,</span>\n                    <span class=\"token number\">1</span><span class=\"token punctuation\">.</span>dp<span class=\"token punctuation\">,</span>\n                    Gravity<span class=\"token punctuation\">.</span>BOTTOM\n                <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">View</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token function\">setBackgroundDrawable</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n\n    width <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>showDebug<span class=\"token punctuation\">)</span> <span class=\"token number\">80</span><span class=\"token punctuation\">.</span>dp <span class=\"token keyword\">else</span> <span class=\"token number\">1</span>\n    height <span class=\"token operator\">=</span> WindowManager<span class=\"token punctuation\">.</span>LayoutParams<span class=\"token punctuation\">.</span>MATCH_PARENT\n    elevation <span class=\"token operator\">=</span> <span class=\"token number\">0F</span>\n\n    softInputMode <span class=\"token operator\">=</span> WindowManager<span class=\"token punctuation\">.</span>LayoutParams<span class=\"token punctuation\">.</span>SOFT_INPUT_ADJUST_RESIZE\n    inputMethodMode <span class=\"token operator\">=</span> PopupWindow<span class=\"token punctuation\">.</span>INPUT_METHOD_NEEDED\n\n    isFocusable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    isTouchable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    isOutsideTouchable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这两个PopupWindow，除了contentView不同以外，还有两个属性不同，cursorPopWin多了两个属性</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\">softInputMode <span class=\"token operator\">=</span> WindowManager<span class=\"token punctuation\">.</span>LayoutParams<span class=\"token punctuation\">.</span>SOFT_INPUT_ADJUST_RESIZE\ninputMethodMode <span class=\"token operator\">=</span> PopupWindow<span class=\"token punctuation\">.</span>INPUT_METHOD_NEEDED</code></pre>\n\n<p>这两个属性，使得cursorPopWin高度会随着软键盘的弹出而变化。</p>\n<p>当开启监听时，为<strong>cursorPopWin.contentView</strong>设置一个OnLayoutChangeListener，用于监听其布局变化。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">watch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>cursorPopWin<span class=\"token punctuation\">.</span>isShowing<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        cursorPopWin<span class=\"token punctuation\">.</span><span class=\"token function\">showAtLocation</span><span class=\"token punctuation\">(</span>decorView<span class=\"token punctuation\">,</span> Gravity<span class=\"token punctuation\">.</span>BOTTOM <span class=\"token operator\">or</span> Gravity<span class=\"token punctuation\">.</span>END<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n        cursorPopWin<span class=\"token punctuation\">.</span>contentView<span class=\"token punctuation\">.</span><span class=\"token function\">addOnLayoutChangeListener</span><span class=\"token punctuation\">(</span>cursorLayoutChangeListener<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> cursorLayoutChangeListener <span class=\"token operator\">=</span> OnLayoutChangeListener <span class=\"token punctuation\">&#123;</span> _<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> _ <span class=\"token operator\">-></span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rulerPopWin<span class=\"token punctuation\">.</span>isShowing<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        rulerPopWin<span class=\"token punctuation\">.</span><span class=\"token function\">dismiss</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    rulerPopWin<span class=\"token punctuation\">.</span><span class=\"token function\">showAtLocation</span><span class=\"token punctuation\">(</span>decorView<span class=\"token punctuation\">,</span> Gravity<span class=\"token punctuation\">.</span>BOTTOM <span class=\"token operator\">or</span> Gravity<span class=\"token punctuation\">.</span>END<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    rulerPopWin<span class=\"token punctuation\">.</span>contentView<span class=\"token punctuation\">.</span><span class=\"token function\">addOnLayoutChangeListener</span><span class=\"token punctuation\">(</span>rulerLayoutChangeListener<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在cursorLayoutChangeListener中，监听到cursotPopWin的变化后，再显示rulerPopWin。为什么要这么做呢？</p>\n<blockquote>\n<p>因为在实践中，软键盘的变化，触发了onLayoutChange方法，如果是在这之前就把rulerPopWin显示出来，在某些机型或者系统版本中，也会出现rulerPopWin跟随键盘改变尺寸的情况。所以要将rulerPopWin显示在键盘弹出之后。</p>\n</blockquote>\n<p>真实的键盘高度监听，实际上说在rulerLayoutChangeListener中。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> rulerLayoutChangeListener <span class=\"token operator\">=</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> OnLayoutChangeListener <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onLayoutChange</span><span class=\"token punctuation\">(</span>\n        v<span class=\"token operator\">:</span> View<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span>\n        left<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        top<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        right<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        bottom<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        oldLeft<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        oldTop<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        oldRight<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        oldBottom<span class=\"token operator\">:</span> Int\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        rulerPopWin<span class=\"token punctuation\">.</span>contentView<span class=\"token punctuation\">.</span><span class=\"token function\">removeOnLayoutChangeListener</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span>\n        rulerPopWin<span class=\"token punctuation\">.</span>contentView<span class=\"token punctuation\">.</span><span class=\"token function\">getGlobalVisibleRect</span><span class=\"token punctuation\">(</span>rulerRect<span class=\"token punctuation\">)</span>\n        cursorPopWin<span class=\"token punctuation\">.</span>contentView<span class=\"token punctuation\">.</span><span class=\"token function\">getGlobalVisibleRect</span><span class=\"token punctuation\">(</span>cursorRect<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">val</span> keyboardHeight <span class=\"token operator\">=</span> rulerRect<span class=\"token punctuation\">.</span>bottom <span class=\"token operator\">-</span> cursorRect<span class=\"token punctuation\">.</span>bottom\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>callbacks<span class=\"token punctuation\">.</span><span class=\"token function\">isNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">val</span> cbs <span class=\"token operator\">=</span> ArrayList<span class=\"token operator\">&lt;</span>Callback<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>callbacks<span class=\"token punctuation\">)</span>\n            cbs<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span> <span class=\"token punctuation\">&#123;</span>\n                it<span class=\"token punctuation\">.</span><span class=\"token function\">onKeyboardHeightChanged</span><span class=\"token punctuation\">(</span>keyboardHeight<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#125;</span>\n            cbs<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>showDebug<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token punctuation\">(</span>v <span class=\"token keyword\">as</span> TextView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span> <span class=\"token punctuation\">&#123;</span>\n\n                text <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">keyboardHeight</span></span><span class=\"token string\">\"</span></span>\n                <span class=\"token function\">setPadding</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token function\">max</span><span class=\"token punctuation\">(</span>keyboardHeight <span class=\"token operator\">-</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lineHeight<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>OK，这就是全部关键逻辑了。</p>\n<h2 id=\"Q-A\"><a href=\"#Q-A\" class=\"headerlink\" title=\"Q&amp;A\"></a>Q&amp;A</h2><ol>\n<li><p>为什么要通过rulerPopWin来获取高度，用其他获取屏幕高度的方法不好吗？</p>\n<blockquote>\n<p>不可以，这里rulerPopWin，实际上是测量<strong>当前状态下</strong>，键盘收起时的最底部。这个状态受到很多其他方面的影响，比如横竖屏切换、底部导航条的显示或者隐藏。如果通过直接获取屏幕高度的方式，并不能与状态严格对其。尤其说底部导航条的各种显示模式，导致键盘收起的0线也是变化的。</p>\n</blockquote>\n</li>\n<li><p>为什么不只用一个cursorPopWin的软键盘弹起前后进行差值计算高度呢？</p>\n<blockquote>\n<p>这样做在实践中也是不可行的。同样跟问题1中的场景类似，由于底部导航条各种显示模式的影响，导致软键盘0线是不确定的，而软键盘的弹起与收回，可能对应着不同的导航条显示模式，也就对应着不同的0线，这样计算出来的软键盘高度，很容易把导航条的高度也算进去。</p>\n</blockquote>\n</li>\n<li><p>由问题2想到，把导航条的高度减掉不就是键盘的高度了吗？</p>\n<blockquote>\n<p>这样做理论上可行，但是实践上问题会很多。首先，你要针对不同的导航条模式做不同策略；其次，不同系统的导航条的高度不同，包括说传统3键导航条还是全面屏手势；再次，目前获取导航条高度，并没有一个完美的方案，有些系统下获取到的高度，跟实际高度是不相符的。</p>\n</blockquote>\n</li>\n</ol>\n","excerpt":"","more":"<p>最近终于总结出最佳的软键盘高度监测方案了，特此分享出来。<br>源码在此：<a href=\"https://gist.github.com/boybeak/62ab557ace8a9763f12803b82f274df5\">KeyboardObserver.kt</a></p>\n<h2 id=\"视觉效果\"><a href=\"#视觉效果\" class=\"headerlink\" title=\"视觉效果\"></a>视觉效果</h2><p>当开启showDebug时候，可以看到这样的可视化的键盘高度监测。<br><img src=\"/../images/keyboard-height.gif\" alt=\"showcase\"></p>\n<h2 id=\"源码分析\"><a href=\"#源码分析\" class=\"headerlink\" title=\"源码分析\"></a>源码分析</h2><p>简单来说，这里说通过两个PopupWindow来实现的键盘高度测量。一个用于测量<strong>当前屏幕状态可绘制区域的最大高度</strong>，一个用于跟随键盘移动，进而通过高度差，算出键盘的高度。我们这里将前者称为RulerPopWin, 后者称为CursorPopWin。他们的代码分别如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">// RulerPopWin</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> rulerPopWin <span class=\"token keyword\">by</span> lazy <span class=\"token punctuation\">&#123;</span> <span class=\"token function\">makeRulerPopWin</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">makeRulerPopWin</span><span class=\"token punctuation\">(</span>activity<span class=\"token operator\">:</span> Activity<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">PopupWindow</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">&#123;</span>\n    contentView <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>showDebug<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">TextView</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">&#123;</span>\n            background <span class=\"token operator\">=</span> <span class=\"token function\">GradientDrawable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setStroke</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">.</span>dp<span class=\"token punctuation\">,</span> Color<span class=\"token punctuation\">.</span>LTGRAY<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#125;</span>\n            gravity <span class=\"token operator\">=</span> Gravity<span class=\"token punctuation\">.</span>BOTTOM <span class=\"token operator\">or</span> Gravity<span class=\"token punctuation\">.</span>CENTER_HORIZONTAL\n            <span class=\"token function\">setTextColor</span><span class=\"token punctuation\">(</span>Color<span class=\"token punctuation\">.</span>RED<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n       <span class=\"token function\">View</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token function\">setBackgroundDrawable</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n    width <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>showDebug<span class=\"token punctuation\">)</span> <span class=\"token number\">80</span><span class=\"token punctuation\">.</span>dp <span class=\"token keyword\">else</span> <span class=\"token number\">1</span>\n    height <span class=\"token operator\">=</span> WindowManager<span class=\"token punctuation\">.</span>LayoutParams<span class=\"token punctuation\">.</span>MATCH_PARENT\n    elevation <span class=\"token operator\">=</span> <span class=\"token number\">0F</span>\n\n    isFocusable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    isTouchable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    isOutsideTouchable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">// CursorPopWin</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> cursorPopWin <span class=\"token keyword\">by</span> lazy <span class=\"token punctuation\">&#123;</span> <span class=\"token function\">makeCursorPopWin</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">makeCursorPopWin</span><span class=\"token punctuation\">(</span>activity<span class=\"token operator\">:</span> Activity<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">PopupWindow</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">&#123;</span>\n    contentView <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>showDebug<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">FrameLayout</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token function\">addView</span><span class=\"token punctuation\">(</span>\n                <span class=\"token function\">View</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">&#123;</span>\n                    background <span class=\"token operator\">=</span> <span class=\"token function\">ColorDrawable</span><span class=\"token punctuation\">(</span>Color<span class=\"token punctuation\">.</span>RED<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n                FrameLayout<span class=\"token punctuation\">.</span><span class=\"token function\">LayoutParams</span><span class=\"token punctuation\">(</span>\n                    FrameLayout<span class=\"token punctuation\">.</span>LayoutParams<span class=\"token punctuation\">.</span>MATCH_PARENT<span class=\"token punctuation\">,</span>\n                    <span class=\"token number\">1</span><span class=\"token punctuation\">.</span>dp<span class=\"token punctuation\">,</span>\n                    Gravity<span class=\"token punctuation\">.</span>BOTTOM\n                <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">View</span><span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token function\">setBackgroundDrawable</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n\n    width <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>showDebug<span class=\"token punctuation\">)</span> <span class=\"token number\">80</span><span class=\"token punctuation\">.</span>dp <span class=\"token keyword\">else</span> <span class=\"token number\">1</span>\n    height <span class=\"token operator\">=</span> WindowManager<span class=\"token punctuation\">.</span>LayoutParams<span class=\"token punctuation\">.</span>MATCH_PARENT\n    elevation <span class=\"token operator\">=</span> <span class=\"token number\">0F</span>\n\n    softInputMode <span class=\"token operator\">=</span> WindowManager<span class=\"token punctuation\">.</span>LayoutParams<span class=\"token punctuation\">.</span>SOFT_INPUT_ADJUST_RESIZE\n    inputMethodMode <span class=\"token operator\">=</span> PopupWindow<span class=\"token punctuation\">.</span>INPUT_METHOD_NEEDED\n\n    isFocusable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    isTouchable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    isOutsideTouchable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>这两个PopupWindow，除了contentView不同以外，还有两个属性不同，cursorPopWin多了两个属性</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\">softInputMode <span class=\"token operator\">=</span> WindowManager<span class=\"token punctuation\">.</span>LayoutParams<span class=\"token punctuation\">.</span>SOFT_INPUT_ADJUST_RESIZE\ninputMethodMode <span class=\"token operator\">=</span> PopupWindow<span class=\"token punctuation\">.</span>INPUT_METHOD_NEEDED</code></pre>\n\n<p>这两个属性，使得cursorPopWin高度会随着软键盘的弹出而变化。</p>\n<p>当开启监听时，为<strong>cursorPopWin.contentView</strong>设置一个OnLayoutChangeListener，用于监听其布局变化。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">watch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>cursorPopWin<span class=\"token punctuation\">.</span>isShowing<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        cursorPopWin<span class=\"token punctuation\">.</span><span class=\"token function\">showAtLocation</span><span class=\"token punctuation\">(</span>decorView<span class=\"token punctuation\">,</span> Gravity<span class=\"token punctuation\">.</span>BOTTOM <span class=\"token operator\">or</span> Gravity<span class=\"token punctuation\">.</span>END<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n        cursorPopWin<span class=\"token punctuation\">.</span>contentView<span class=\"token punctuation\">.</span><span class=\"token function\">addOnLayoutChangeListener</span><span class=\"token punctuation\">(</span>cursorLayoutChangeListener<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> cursorLayoutChangeListener <span class=\"token operator\">=</span> OnLayoutChangeListener <span class=\"token punctuation\">&#123;</span> _<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> _ <span class=\"token operator\">-></span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rulerPopWin<span class=\"token punctuation\">.</span>isShowing<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        rulerPopWin<span class=\"token punctuation\">.</span><span class=\"token function\">dismiss</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    rulerPopWin<span class=\"token punctuation\">.</span><span class=\"token function\">showAtLocation</span><span class=\"token punctuation\">(</span>decorView<span class=\"token punctuation\">,</span> Gravity<span class=\"token punctuation\">.</span>BOTTOM <span class=\"token operator\">or</span> Gravity<span class=\"token punctuation\">.</span>END<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    rulerPopWin<span class=\"token punctuation\">.</span>contentView<span class=\"token punctuation\">.</span><span class=\"token function\">addOnLayoutChangeListener</span><span class=\"token punctuation\">(</span>rulerLayoutChangeListener<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在cursorLayoutChangeListener中，监听到cursotPopWin的变化后，再显示rulerPopWin。为什么要这么做呢？</p>\n<blockquote>\n<p>因为在实践中，软键盘的变化，触发了onLayoutChange方法，如果是在这之前就把rulerPopWin显示出来，在某些机型或者系统版本中，也会出现rulerPopWin跟随键盘改变尺寸的情况。所以要将rulerPopWin显示在键盘弹出之后。</p>\n</blockquote>\n<p>真实的键盘高度监听，实际上说在rulerLayoutChangeListener中。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> rulerLayoutChangeListener <span class=\"token operator\">=</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> OnLayoutChangeListener <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onLayoutChange</span><span class=\"token punctuation\">(</span>\n        v<span class=\"token operator\">:</span> View<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span>\n        left<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        top<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        right<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        bottom<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        oldLeft<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        oldTop<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        oldRight<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        oldBottom<span class=\"token operator\">:</span> Int\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        rulerPopWin<span class=\"token punctuation\">.</span>contentView<span class=\"token punctuation\">.</span><span class=\"token function\">removeOnLayoutChangeListener</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span>\n        rulerPopWin<span class=\"token punctuation\">.</span>contentView<span class=\"token punctuation\">.</span><span class=\"token function\">getGlobalVisibleRect</span><span class=\"token punctuation\">(</span>rulerRect<span class=\"token punctuation\">)</span>\n        cursorPopWin<span class=\"token punctuation\">.</span>contentView<span class=\"token punctuation\">.</span><span class=\"token function\">getGlobalVisibleRect</span><span class=\"token punctuation\">(</span>cursorRect<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">val</span> keyboardHeight <span class=\"token operator\">=</span> rulerRect<span class=\"token punctuation\">.</span>bottom <span class=\"token operator\">-</span> cursorRect<span class=\"token punctuation\">.</span>bottom\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>callbacks<span class=\"token punctuation\">.</span><span class=\"token function\">isNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">val</span> cbs <span class=\"token operator\">=</span> ArrayList<span class=\"token operator\">&lt;</span>Callback<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>callbacks<span class=\"token punctuation\">)</span>\n            cbs<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span> <span class=\"token punctuation\">&#123;</span>\n                it<span class=\"token punctuation\">.</span><span class=\"token function\">onKeyboardHeightChanged</span><span class=\"token punctuation\">(</span>keyboardHeight<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#125;</span>\n            cbs<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>showDebug<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token punctuation\">(</span>v <span class=\"token keyword\">as</span> TextView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span> <span class=\"token punctuation\">&#123;</span>\n\n                text <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">keyboardHeight</span></span><span class=\"token string\">\"</span></span>\n                <span class=\"token function\">setPadding</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token function\">max</span><span class=\"token punctuation\">(</span>keyboardHeight <span class=\"token operator\">-</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lineHeight<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>OK，这就是全部关键逻辑了。</p>\n<h2 id=\"Q-A\"><a href=\"#Q-A\" class=\"headerlink\" title=\"Q&amp;A\"></a>Q&amp;A</h2><ol>\n<li><p>为什么要通过rulerPopWin来获取高度，用其他获取屏幕高度的方法不好吗？</p>\n<blockquote>\n<p>不可以，这里rulerPopWin，实际上是测量<strong>当前状态下</strong>，键盘收起时的最底部。这个状态受到很多其他方面的影响，比如横竖屏切换、底部导航条的显示或者隐藏。如果通过直接获取屏幕高度的方式，并不能与状态严格对其。尤其说底部导航条的各种显示模式，导致键盘收起的0线也是变化的。</p>\n</blockquote>\n</li>\n<li><p>为什么不只用一个cursorPopWin的软键盘弹起前后进行差值计算高度呢？</p>\n<blockquote>\n<p>这样做在实践中也是不可行的。同样跟问题1中的场景类似，由于底部导航条各种显示模式的影响，导致软键盘0线是不确定的，而软键盘的弹起与收回，可能对应着不同的导航条显示模式，也就对应着不同的0线，这样计算出来的软键盘高度，很容易把导航条的高度也算进去。</p>\n</blockquote>\n</li>\n<li><p>由问题2想到，把导航条的高度减掉不就是键盘的高度了吗？</p>\n<blockquote>\n<p>这样做理论上可行，但是实践上问题会很多。首先，你要针对不同的导航条模式做不同策略；其次，不同系统的导航条的高度不同，包括说传统3键导航条还是全面屏手势；再次，目前获取导航条高度，并没有一个完美的方案，有些系统下获取到的高度，跟实际高度是不相符的。</p>\n</blockquote>\n</li>\n</ol>\n"},{"title":"J2V8深度绑定机制分享","date":"2023-08-12T07:26:00.000Z","_content":"\n## 一、问题背景\n\n在小游戏开发中，常见的一种操作就是设置绘制属性，比如lineWidth、fillStyle这种，这在WebView方案中，因为全跑在JS环境中，没有任何问题。但是在J2V8方案中，因为绘制逻辑在JS层，绘制实现在Java层，这就导致JS层的属性设置，无法传达到Java层。\n\n本文项目地址：[v8x](https://github.com/boybeak/v8x)\n\n```javascript\nconst ctx = canvas.getContext('2d'); // 这里的ctx是Java层返回的V8Object对象\nctx.lineWidth = 10;\n...\nctx.stroke();\n```\n\n上述代码中，`ctx.lineWidth = 10;`修改后，在Java层是无法感知的。\n\n### 1.1 以往方案\n\n以往方案中，是通过JS层，为ctx对象做代理，拦截到属性变化，再通过调用J2V8的绑定方法，告知Java层，某个属性变化的了。\n\n这样做，有以下几个缺点：\n\n1. 有这种需求的类可能很多，每一个都要JS层做相应的适配，这会增加工作量和调试沟通成本；\n\n2. 并不是所有属性的变化都是Java层关心的；\n\n3. JS层并不知道Java层的属性与类的关系，容易错乱，导致通知了属性变化，却不知道是哪个对象的属性变化了；\n\n4. 后期Java层类做了变动，需要JS层做相应修改，一旦遗漏，就会产生bug；\n\n基于解决以上问题的目的，开发出新的方案——J2V8Binding。\n\n## 二、J2V8Binding\n\nJ2V8Binding的目标是，将JS层属性的变更感知，全部控制在Java层内，无需JS层参与额外代码。\n\n### 2.1 基本原理\n\n与旧方案类似的，我们仍然需要一个JS层的代理，而与旧方案不同的，新方案的代理是由Java层“生成”。\n\n```kotlin\nprivate const val CREATE_PROXY_JS = \"\"\"\nfunction v8CreateProxy(obj) {\n    return new Proxy(obj, {\n        set: function(target, key, value) {\n            // 在此拦截需要的值变化，并发送给Java层\n        }\n    })\n}\n\"\"\"\n// ... 初始化V8时 ...\nv8.executeScript(CREATE_PROXY_JS)\n```\n\n这里我们声明一段JS代码，这里用于创建JS层的代理对象。在初始化V8时，将此段JS代码注入到V8环境中，当我们需要一个JS层代理对象时，就可以执行此JS函数`v8CreateProxy`创建一个JS层的代理对象。\n\n```kotlin\nprivate fun createJSProxy(v8obj: V8Object): V8Object {\n    return v8.executeObjectFunction(\"v8CreateProxy\", V8Array(v8).apply { push(v8obj) })\n}\n```\n\n### \n\n### 2.2 封装\n\n对以上基本逻辑进行封装，有关键类**V8Binding**、**V8Manager**、**V8Field**和**V8Method**。\n\n#### 2.2.1 V8Binding\n\n一个需要绑定的类，需要实现**V8Binding**接口。\n\n```kotlin\ninterface V8Binding {\n    companion object {\n        private const val TAG = \"V8Binding\"\n    }\n    // V8Binding类的唯一id，用于将JS层对象与Java层对象进行一一对应\n    // 默认实现为该对象的hashCodeo().toString()\n    fun getBindingId(): String {  return hashCode().toString() }\n    // 获取或者创建一个与其对应的代理V8Object\n    fun getMyBinding(v8: V8): V8Object {\n        return V8Manager.obtain(v8).run {\n            if (!isBound(getBindingId())) {\n                createBinding(this@V8Binding)\n            } else {\n                getBinding(getBindingId())\n            }\n        }\n    }\n    // 没有绑定，但是仍然关心的属性，获取关心的属性名称\n    fun getCareForFieldKeys(): Array<String> { return emptyArray() }\n    // 关心的属性值变更时\n    fun onCareForFieldChanged(key: String, newValue: Any?, oldValue: Any?) {}\n\n    // 绑定的属性值由null变为非null值时触发，只针对非基本数据类型(数值与String)的属性触发\n    fun onBindingCreated(target: V8Object, fieldInfo: Key, value: V8Object): V8Binding {\n        throw NotImplementedError(\"onCreateBinding must be implement when new binding created\")\n    }\n    // 绑定的属性值由非null变为null值时触发，只针对非基本数据类型(数值与String)的属性触发\n    fun onBindingDestroyed(target: V8Object, fieldInfo: Key) {\n        throw NotImplementedError(\"onBindingDestroyed must be implement when binding destroyed\")\n    }\n    // 绑定的属性值发生变化时触发\n    fun onBindingChanged(target: V8Object, fieldInfo: Key, newValue: Any?, oldValue: Any?)\n}\n```\n\n在**getMyBinding**方法中，我们使用V8Manager来创建或者获取一个与当前对象绑定的V8Object对象。\n\n#### 2.2.2 V8Manager\n\nV8Manager是一个针对某个V8环境的管理类，主要是用于维护JS层对象与Java层的绑定关系，执行创建绑定关系、删除绑定关系，分发属性变更事件等作用，J2V8Binding的主要核心逻辑的所在。\n\n由于此处涉及到大量代码细节，故不在此罗列代码具体分析。\n\n#### 2.2.3 V8Field和V8Method\n\n这两个类是注解类，用于标记类内属性和方法。\n\n**@V8Field(binding=?)**: 标记属性，其中有一个binding属性，标记此属性是否需要绑定，如果需要绑定，则会有事件回调，默认值为false。\n\n**@V8Method(jsFuncName=?)**: 标记方法，其中有一个jsFuncName属性，用于标识对应的JS函数的名称。\n\n### 2.3 基本使用方法\n\n一个简单的示例类如下：\n\n```kotlin\nclass User : V8Binding {\n    // 不需要绑定的属性，值会传递到对应的JS对象，但该值在JS层发生变化，Java层不会知道\n    @V8Field\n    val name = \"John\"\n    // 需要绑定的属性，初始值会传递到JS对象，该值在JS层发生变化，会传递到Java层\n    @V8Field(binding = true)\n    var age = 15\n\n    // 需要绑定的V8Binding类型属性，与之对应的V8Object会传递到JS对象，\n    // 在JS层，如果变更为其他JS层内部的对象，会解绑之前的关系，与新的JS对象建立新的绑定关系\n    @V8Binding(binding = true)\n    val location: V8Binding = ...\n\n    // 在此方法中\n    override fun onBindingChanged(target: V8Object, fieldInfo: Key, newValue: Any?, oldValue: Any?){\n        when(fieldInfo.name) {\n            \"age\" -> {}\n        }\n    }\n\n    @V8Method(jsFuncName = \"js层对应的名称，默认值与当前方法名一致\")\n    fun sayHello(helloTo: String) {\n    }\n\n    fun getCareForFieldKeys(): Array<String> { return arrayOf(\"introduction\") }\n\n    fun onCareForFieldChanged(key: String, newValue: Any?, oldValue: Any?) {\n        when(key) {\n            \"introduction\" -> {}\n        }\n    }\n\n}\n```\n\n当使用这个User类的一个对象user时候，可以按照如下方式使用。\n\n```kotlin\nval v8 = V8.createRuntime()\nval user = ...\nv8.add(\"user\", user.getMyBinding(v8))\n```\n\n这里，我们在JS环境中，增加了一个user变量。\n\n然后在JS层，执行以下代码。\n\n```javascript\nuser.name = \"Smith\";    // Java层不会感知到\nuser.age = 16;        // Java层可以在onBindingChanged感知到\nuser.location = {};    // Java层可以在onBindingChanged感知到，并解绑旧location值，与新值建立绑定关系\nuser.introduction = \"Hi\";    // Java层可以在onCareForFieldChanged感知到\n```\n\n在修改`name`属性时，由于此属性是被V8Field标记binding为false，则不会通知Java层此值的修改事件。\n\n在修改`age`属性时，由于此值被V8Field标记binding为true，会通知Java层此值的修改事件。\n\n在修改`location`属性时，虽然此值为一个对象，但是被V8Field标记binding为true，会通知Java层此值的修改事件。注意：用V8Field标记的对象类型，必须为V8可以接受的数据类型或者V8Binding类型。\n\n在修改`introduction`时，虽然此值没有被V8Field标记，但是由于在getCareForFieldKeys返回的数组中，同样会有事件通知。\n\n有了这种机制，小游戏开发中，就可以很方便的感知到绘制属性的变化。\n\n### 2.4 仍然存在的问题\n\n目前仍然有一种问题是无法解决的，那就是数组中某个数据发生变化时，Java层是无法得知的。\n\n如下代码：\n\n```javascript\nconst image = ...;\nimage.pixelBytes[0] = 0; // 修改R值\nimage.pixelBytes[1] = 0; // 修改G值\nimage.pixelBytes[2] = 0; // 修改B值\nimage.pixelBytes[3] = 0; // 修改A值\n```\n\n目前这种场景较少，只在部分demo中见到直接修改图像像素数据的情况。\n\n## 三、总结\n\n以上代码片段只为展示逻辑主脉络，省略了大量细节，需要看细节部分，可以从**V8Manager**这里作为入口。源码链接：[v8x](https://github.com/boybeak/v8x)\n","source":"_posts/2023-08-12-J2V8深度绑定机制分享.md","raw":"---\ntitle: 'J2V8深度绑定机制分享'\ndate: 2023-08-12 15:26:00\ncategories: Android技巧\ntags: \n- Android\n- J2V8\n---\n\n## 一、问题背景\n\n在小游戏开发中，常见的一种操作就是设置绘制属性，比如lineWidth、fillStyle这种，这在WebView方案中，因为全跑在JS环境中，没有任何问题。但是在J2V8方案中，因为绘制逻辑在JS层，绘制实现在Java层，这就导致JS层的属性设置，无法传达到Java层。\n\n本文项目地址：[v8x](https://github.com/boybeak/v8x)\n\n```javascript\nconst ctx = canvas.getContext('2d'); // 这里的ctx是Java层返回的V8Object对象\nctx.lineWidth = 10;\n...\nctx.stroke();\n```\n\n上述代码中，`ctx.lineWidth = 10;`修改后，在Java层是无法感知的。\n\n### 1.1 以往方案\n\n以往方案中，是通过JS层，为ctx对象做代理，拦截到属性变化，再通过调用J2V8的绑定方法，告知Java层，某个属性变化的了。\n\n这样做，有以下几个缺点：\n\n1. 有这种需求的类可能很多，每一个都要JS层做相应的适配，这会增加工作量和调试沟通成本；\n\n2. 并不是所有属性的变化都是Java层关心的；\n\n3. JS层并不知道Java层的属性与类的关系，容易错乱，导致通知了属性变化，却不知道是哪个对象的属性变化了；\n\n4. 后期Java层类做了变动，需要JS层做相应修改，一旦遗漏，就会产生bug；\n\n基于解决以上问题的目的，开发出新的方案——J2V8Binding。\n\n## 二、J2V8Binding\n\nJ2V8Binding的目标是，将JS层属性的变更感知，全部控制在Java层内，无需JS层参与额外代码。\n\n### 2.1 基本原理\n\n与旧方案类似的，我们仍然需要一个JS层的代理，而与旧方案不同的，新方案的代理是由Java层“生成”。\n\n```kotlin\nprivate const val CREATE_PROXY_JS = \"\"\"\nfunction v8CreateProxy(obj) {\n    return new Proxy(obj, {\n        set: function(target, key, value) {\n            // 在此拦截需要的值变化，并发送给Java层\n        }\n    })\n}\n\"\"\"\n// ... 初始化V8时 ...\nv8.executeScript(CREATE_PROXY_JS)\n```\n\n这里我们声明一段JS代码，这里用于创建JS层的代理对象。在初始化V8时，将此段JS代码注入到V8环境中，当我们需要一个JS层代理对象时，就可以执行此JS函数`v8CreateProxy`创建一个JS层的代理对象。\n\n```kotlin\nprivate fun createJSProxy(v8obj: V8Object): V8Object {\n    return v8.executeObjectFunction(\"v8CreateProxy\", V8Array(v8).apply { push(v8obj) })\n}\n```\n\n### \n\n### 2.2 封装\n\n对以上基本逻辑进行封装，有关键类**V8Binding**、**V8Manager**、**V8Field**和**V8Method**。\n\n#### 2.2.1 V8Binding\n\n一个需要绑定的类，需要实现**V8Binding**接口。\n\n```kotlin\ninterface V8Binding {\n    companion object {\n        private const val TAG = \"V8Binding\"\n    }\n    // V8Binding类的唯一id，用于将JS层对象与Java层对象进行一一对应\n    // 默认实现为该对象的hashCodeo().toString()\n    fun getBindingId(): String {  return hashCode().toString() }\n    // 获取或者创建一个与其对应的代理V8Object\n    fun getMyBinding(v8: V8): V8Object {\n        return V8Manager.obtain(v8).run {\n            if (!isBound(getBindingId())) {\n                createBinding(this@V8Binding)\n            } else {\n                getBinding(getBindingId())\n            }\n        }\n    }\n    // 没有绑定，但是仍然关心的属性，获取关心的属性名称\n    fun getCareForFieldKeys(): Array<String> { return emptyArray() }\n    // 关心的属性值变更时\n    fun onCareForFieldChanged(key: String, newValue: Any?, oldValue: Any?) {}\n\n    // 绑定的属性值由null变为非null值时触发，只针对非基本数据类型(数值与String)的属性触发\n    fun onBindingCreated(target: V8Object, fieldInfo: Key, value: V8Object): V8Binding {\n        throw NotImplementedError(\"onCreateBinding must be implement when new binding created\")\n    }\n    // 绑定的属性值由非null变为null值时触发，只针对非基本数据类型(数值与String)的属性触发\n    fun onBindingDestroyed(target: V8Object, fieldInfo: Key) {\n        throw NotImplementedError(\"onBindingDestroyed must be implement when binding destroyed\")\n    }\n    // 绑定的属性值发生变化时触发\n    fun onBindingChanged(target: V8Object, fieldInfo: Key, newValue: Any?, oldValue: Any?)\n}\n```\n\n在**getMyBinding**方法中，我们使用V8Manager来创建或者获取一个与当前对象绑定的V8Object对象。\n\n#### 2.2.2 V8Manager\n\nV8Manager是一个针对某个V8环境的管理类，主要是用于维护JS层对象与Java层的绑定关系，执行创建绑定关系、删除绑定关系，分发属性变更事件等作用，J2V8Binding的主要核心逻辑的所在。\n\n由于此处涉及到大量代码细节，故不在此罗列代码具体分析。\n\n#### 2.2.3 V8Field和V8Method\n\n这两个类是注解类，用于标记类内属性和方法。\n\n**@V8Field(binding=?)**: 标记属性，其中有一个binding属性，标记此属性是否需要绑定，如果需要绑定，则会有事件回调，默认值为false。\n\n**@V8Method(jsFuncName=?)**: 标记方法，其中有一个jsFuncName属性，用于标识对应的JS函数的名称。\n\n### 2.3 基本使用方法\n\n一个简单的示例类如下：\n\n```kotlin\nclass User : V8Binding {\n    // 不需要绑定的属性，值会传递到对应的JS对象，但该值在JS层发生变化，Java层不会知道\n    @V8Field\n    val name = \"John\"\n    // 需要绑定的属性，初始值会传递到JS对象，该值在JS层发生变化，会传递到Java层\n    @V8Field(binding = true)\n    var age = 15\n\n    // 需要绑定的V8Binding类型属性，与之对应的V8Object会传递到JS对象，\n    // 在JS层，如果变更为其他JS层内部的对象，会解绑之前的关系，与新的JS对象建立新的绑定关系\n    @V8Binding(binding = true)\n    val location: V8Binding = ...\n\n    // 在此方法中\n    override fun onBindingChanged(target: V8Object, fieldInfo: Key, newValue: Any?, oldValue: Any?){\n        when(fieldInfo.name) {\n            \"age\" -> {}\n        }\n    }\n\n    @V8Method(jsFuncName = \"js层对应的名称，默认值与当前方法名一致\")\n    fun sayHello(helloTo: String) {\n    }\n\n    fun getCareForFieldKeys(): Array<String> { return arrayOf(\"introduction\") }\n\n    fun onCareForFieldChanged(key: String, newValue: Any?, oldValue: Any?) {\n        when(key) {\n            \"introduction\" -> {}\n        }\n    }\n\n}\n```\n\n当使用这个User类的一个对象user时候，可以按照如下方式使用。\n\n```kotlin\nval v8 = V8.createRuntime()\nval user = ...\nv8.add(\"user\", user.getMyBinding(v8))\n```\n\n这里，我们在JS环境中，增加了一个user变量。\n\n然后在JS层，执行以下代码。\n\n```javascript\nuser.name = \"Smith\";    // Java层不会感知到\nuser.age = 16;        // Java层可以在onBindingChanged感知到\nuser.location = {};    // Java层可以在onBindingChanged感知到，并解绑旧location值，与新值建立绑定关系\nuser.introduction = \"Hi\";    // Java层可以在onCareForFieldChanged感知到\n```\n\n在修改`name`属性时，由于此属性是被V8Field标记binding为false，则不会通知Java层此值的修改事件。\n\n在修改`age`属性时，由于此值被V8Field标记binding为true，会通知Java层此值的修改事件。\n\n在修改`location`属性时，虽然此值为一个对象，但是被V8Field标记binding为true，会通知Java层此值的修改事件。注意：用V8Field标记的对象类型，必须为V8可以接受的数据类型或者V8Binding类型。\n\n在修改`introduction`时，虽然此值没有被V8Field标记，但是由于在getCareForFieldKeys返回的数组中，同样会有事件通知。\n\n有了这种机制，小游戏开发中，就可以很方便的感知到绘制属性的变化。\n\n### 2.4 仍然存在的问题\n\n目前仍然有一种问题是无法解决的，那就是数组中某个数据发生变化时，Java层是无法得知的。\n\n如下代码：\n\n```javascript\nconst image = ...;\nimage.pixelBytes[0] = 0; // 修改R值\nimage.pixelBytes[1] = 0; // 修改G值\nimage.pixelBytes[2] = 0; // 修改B值\nimage.pixelBytes[3] = 0; // 修改A值\n```\n\n目前这种场景较少，只在部分demo中见到直接修改图像像素数据的情况。\n\n## 三、总结\n\n以上代码片段只为展示逻辑主脉络，省略了大量细节，需要看细节部分，可以从**V8Manager**这里作为入口。源码链接：[v8x](https://github.com/boybeak/v8x)\n","slug":"2023-08-12-J2V8深度绑定机制分享","published":1,"updated":"2024-09-25T02:53:02.298Z","comments":1,"layout":"post","photos":[],"_id":"cm1ltr0g30029bji00bu6eukv","content":"<h2 id=\"一、问题背景\"><a href=\"#一、问题背景\" class=\"headerlink\" title=\"一、问题背景\"></a>一、问题背景</h2><p>在小游戏开发中，常见的一种操作就是设置绘制属性，比如lineWidth、fillStyle这种，这在WebView方案中，因为全跑在JS环境中，没有任何问题。但是在J2V8方案中，因为绘制逻辑在JS层，绘制实现在Java层，这就导致JS层的属性设置，无法传达到Java层。</p>\n<p>本文项目地址：<a href=\"https://github.com/boybeak/v8x\">v8x</a></p>\n<pre class=\"language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> canvas<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 这里的ctx是Java层返回的V8Object对象</span>\nctx<span class=\"token punctuation\">.</span>lineWidth <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">...</span>\nctx<span class=\"token punctuation\">.</span><span class=\"token function\">stroke</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>上述代码中，<code>ctx.lineWidth = 10;</code>修改后，在Java层是无法感知的。</p>\n<h3 id=\"1-1-以往方案\"><a href=\"#1-1-以往方案\" class=\"headerlink\" title=\"1.1 以往方案\"></a>1.1 以往方案</h3><p>以往方案中，是通过JS层，为ctx对象做代理，拦截到属性变化，再通过调用J2V8的绑定方法，告知Java层，某个属性变化的了。</p>\n<p>这样做，有以下几个缺点：</p>\n<ol>\n<li><p>有这种需求的类可能很多，每一个都要JS层做相应的适配，这会增加工作量和调试沟通成本；</p>\n</li>\n<li><p>并不是所有属性的变化都是Java层关心的；</p>\n</li>\n<li><p>JS层并不知道Java层的属性与类的关系，容易错乱，导致通知了属性变化，却不知道是哪个对象的属性变化了；</p>\n</li>\n<li><p>后期Java层类做了变动，需要JS层做相应修改，一旦遗漏，就会产生bug；</p>\n</li>\n</ol>\n<p>基于解决以上问题的目的，开发出新的方案——J2V8Binding。</p>\n<h2 id=\"二、J2V8Binding\"><a href=\"#二、J2V8Binding\" class=\"headerlink\" title=\"二、J2V8Binding\"></a>二、J2V8Binding</h2><p>J2V8Binding的目标是，将JS层属性的变更感知，全部控制在Java层内，无需JS层参与额外代码。</p>\n<h3 id=\"2-1-基本原理\"><a href=\"#2-1-基本原理\" class=\"headerlink\" title=\"2.1 基本原理\"></a>2.1 基本原理</h3><p>与旧方案类似的，我们仍然需要一个JS层的代理，而与旧方案不同的，新方案的代理是由Java层“生成”。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">val</span> CREATE_PROXY_JS <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"\"</span></span>\"\nfunction <span class=\"token function\">v8CreateProxy</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> new <span class=\"token function\">Proxy</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">set</span><span class=\"token operator\">:</span> <span class=\"token function\">function</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">// 在此拦截需要的值变化，并发送给Java层</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token string-literal singleline\"><span class=\"token string\">\"\"</span></span>\"\n<span class=\"token comment\">// ... 初始化V8时 ...</span>\nv8<span class=\"token punctuation\">.</span><span class=\"token function\">executeScript</span><span class=\"token punctuation\">(</span>CREATE_PROXY_JS<span class=\"token punctuation\">)</span></code></pre>\n\n<p>这里我们声明一段JS代码，这里用于创建JS层的代理对象。在初始化V8时，将此段JS代码注入到V8环境中，当我们需要一个JS层代理对象时，就可以执行此JS函数<code>v8CreateProxy</code>创建一个JS层的代理对象。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">createJSProxy</span><span class=\"token punctuation\">(</span>v8obj<span class=\"token operator\">:</span> V8Object<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> V8Object <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> v8<span class=\"token punctuation\">.</span><span class=\"token function\">executeObjectFunction</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"v8CreateProxy\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token function\">V8Array</span><span class=\"token punctuation\">(</span>v8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>v8obj<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h3 id=\"2-2-封装\"><a href=\"#2-2-封装\" class=\"headerlink\" title=\"2.2 封装\"></a>2.2 封装</h3><p>对以上基本逻辑进行封装，有关键类<strong>V8Binding</strong>、<strong>V8Manager</strong>、<strong>V8Field</strong>和<strong>V8Method</strong>。</p>\n<h4 id=\"2-2-1-V8Binding\"><a href=\"#2-2-1-V8Binding\" class=\"headerlink\" title=\"2.2.1 V8Binding\"></a>2.2.1 V8Binding</h4><p>一个需要绑定的类，需要实现<strong>V8Binding</strong>接口。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">interface</span> V8Binding <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">val</span> TAG <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"V8Binding\"</span></span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// V8Binding类的唯一id，用于将JS层对象与Java层对象进行一一对应</span>\n    <span class=\"token comment\">// 默认实现为该对象的hashCodeo().toString()</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">getBindingId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> String <span class=\"token punctuation\">&#123;</span>  <span class=\"token keyword\">return</span> <span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 获取或者创建一个与其对应的代理V8Object</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">getMyBinding</span><span class=\"token punctuation\">(</span>v8<span class=\"token operator\">:</span> V8<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> V8Object <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> V8Manager<span class=\"token punctuation\">.</span><span class=\"token function\">obtain</span><span class=\"token punctuation\">(</span>v8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isBound</span><span class=\"token punctuation\">(</span><span class=\"token function\">getBindingId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token function\">createBinding</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token label symbol\">@V8Binding</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token function\">getBinding</span><span class=\"token punctuation\">(</span><span class=\"token function\">getBindingId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 没有绑定，但是仍然关心的属性，获取关心的属性名称</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">getCareForFieldKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> <span class=\"token function\">emptyArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 关心的属性值变更时</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">onCareForFieldChanged</span><span class=\"token punctuation\">(</span>key<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span> newValue<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> oldValue<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token comment\">// 绑定的属性值由null变为非null值时触发，只针对非基本数据类型(数值与String)的属性触发</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">onBindingCreated</span><span class=\"token punctuation\">(</span>target<span class=\"token operator\">:</span> V8Object<span class=\"token punctuation\">,</span> fieldInfo<span class=\"token operator\">:</span> Key<span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> V8Object<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> V8Binding <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token function\">NotImplementedError</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"onCreateBinding must be implement when new binding created\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 绑定的属性值由非null变为null值时触发，只针对非基本数据类型(数值与String)的属性触发</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">onBindingDestroyed</span><span class=\"token punctuation\">(</span>target<span class=\"token operator\">:</span> V8Object<span class=\"token punctuation\">,</span> fieldInfo<span class=\"token operator\">:</span> Key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token function\">NotImplementedError</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"onBindingDestroyed must be implement when binding destroyed\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 绑定的属性值发生变化时触发</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">onBindingChanged</span><span class=\"token punctuation\">(</span>target<span class=\"token operator\">:</span> V8Object<span class=\"token punctuation\">,</span> fieldInfo<span class=\"token operator\">:</span> Key<span class=\"token punctuation\">,</span> newValue<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> oldValue<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在<strong>getMyBinding</strong>方法中，我们使用V8Manager来创建或者获取一个与当前对象绑定的V8Object对象。</p>\n<h4 id=\"2-2-2-V8Manager\"><a href=\"#2-2-2-V8Manager\" class=\"headerlink\" title=\"2.2.2 V8Manager\"></a>2.2.2 V8Manager</h4><p>V8Manager是一个针对某个V8环境的管理类，主要是用于维护JS层对象与Java层的绑定关系，执行创建绑定关系、删除绑定关系，分发属性变更事件等作用，J2V8Binding的主要核心逻辑的所在。</p>\n<p>由于此处涉及到大量代码细节，故不在此罗列代码具体分析。</p>\n<h4 id=\"2-2-3-V8Field和V8Method\"><a href=\"#2-2-3-V8Field和V8Method\" class=\"headerlink\" title=\"2.2.3 V8Field和V8Method\"></a>2.2.3 V8Field和V8Method</h4><p>这两个类是注解类，用于标记类内属性和方法。</p>\n<p><strong>@V8Field(binding&#x3D;?)</strong>: 标记属性，其中有一个binding属性，标记此属性是否需要绑定，如果需要绑定，则会有事件回调，默认值为false。</p>\n<p><strong>@V8Method(jsFuncName&#x3D;?)</strong>: 标记方法，其中有一个jsFuncName属性，用于标识对应的JS函数的名称。</p>\n<h3 id=\"2-3-基本使用方法\"><a href=\"#2-3-基本使用方法\" class=\"headerlink\" title=\"2.3 基本使用方法\"></a>2.3 基本使用方法</h3><p>一个简单的示例类如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> User <span class=\"token operator\">:</span> V8Binding <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 不需要绑定的属性，值会传递到对应的JS对象，但该值在JS层发生变化，Java层不会知道</span>\n    <span class=\"token annotation builtin\">@V8Field</span>\n    <span class=\"token keyword\">val</span> name <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"John\"</span></span>\n    <span class=\"token comment\">// 需要绑定的属性，初始值会传递到JS对象，该值在JS层发生变化，会传递到Java层</span>\n    <span class=\"token annotation builtin\">@V8Field</span><span class=\"token punctuation\">(</span>binding <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">var</span> age <span class=\"token operator\">=</span> <span class=\"token number\">15</span>\n\n    <span class=\"token comment\">// 需要绑定的V8Binding类型属性，与之对应的V8Object会传递到JS对象，</span>\n    <span class=\"token comment\">// 在JS层，如果变更为其他JS层内部的对象，会解绑之前的关系，与新的JS对象建立新的绑定关系</span>\n    <span class=\"token annotation builtin\">@V8Binding</span><span class=\"token punctuation\">(</span>binding <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> location<span class=\"token operator\">:</span> V8Binding <span class=\"token operator\">=</span> <span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token comment\">// 在此方法中</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onBindingChanged</span><span class=\"token punctuation\">(</span>target<span class=\"token operator\">:</span> V8Object<span class=\"token punctuation\">,</span> fieldInfo<span class=\"token operator\">:</span> Key<span class=\"token punctuation\">,</span> newValue<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> oldValue<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">when</span><span class=\"token punctuation\">(</span>fieldInfo<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token string-literal singleline\"><span class=\"token string\">\"age\"</span></span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token annotation builtin\">@V8Method</span><span class=\"token punctuation\">(</span>jsFuncName <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"js层对应的名称，默认值与当前方法名一致\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">sayHello</span><span class=\"token punctuation\">(</span>helloTo<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">getCareForFieldKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> <span class=\"token function\">arrayOf</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"introduction\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">onCareForFieldChanged</span><span class=\"token punctuation\">(</span>key<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span> newValue<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> oldValue<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">when</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token string-literal singleline\"><span class=\"token string\">\"introduction\"</span></span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>当使用这个User类的一个对象user时候，可以按照如下方式使用。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> v8 <span class=\"token operator\">=</span> V8<span class=\"token punctuation\">.</span><span class=\"token function\">createRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> user <span class=\"token operator\">=</span> <span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\nv8<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"user\"</span></span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">.</span><span class=\"token function\">getMyBinding</span><span class=\"token punctuation\">(</span>v8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre>\n\n<p>这里，我们在JS环境中，增加了一个user变量。</p>\n<p>然后在JS层，执行以下代码。</p>\n<pre class=\"language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">user<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"Smith\"</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Java层不会感知到</span>\nuser<span class=\"token punctuation\">.</span>age <span class=\"token operator\">=</span> <span class=\"token number\">16</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// Java层可以在onBindingChanged感知到</span>\nuser<span class=\"token punctuation\">.</span>location <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Java层可以在onBindingChanged感知到，并解绑旧location值，与新值建立绑定关系</span>\nuser<span class=\"token punctuation\">.</span>introduction <span class=\"token operator\">=</span> <span class=\"token string\">\"Hi\"</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Java层可以在onCareForFieldChanged感知到</span></code></pre>\n\n<p>在修改<code>name</code>属性时，由于此属性是被V8Field标记binding为false，则不会通知Java层此值的修改事件。</p>\n<p>在修改<code>age</code>属性时，由于此值被V8Field标记binding为true，会通知Java层此值的修改事件。</p>\n<p>在修改<code>location</code>属性时，虽然此值为一个对象，但是被V8Field标记binding为true，会通知Java层此值的修改事件。注意：用V8Field标记的对象类型，必须为V8可以接受的数据类型或者V8Binding类型。</p>\n<p>在修改<code>introduction</code>时，虽然此值没有被V8Field标记，但是由于在getCareForFieldKeys返回的数组中，同样会有事件通知。</p>\n<p>有了这种机制，小游戏开发中，就可以很方便的感知到绘制属性的变化。</p>\n<h3 id=\"2-4-仍然存在的问题\"><a href=\"#2-4-仍然存在的问题\" class=\"headerlink\" title=\"2.4 仍然存在的问题\"></a>2.4 仍然存在的问题</h3><p>目前仍然有一种问题是无法解决的，那就是数组中某个数据发生变化时，Java层是无法得知的。</p>\n<p>如下代码：</p>\n<pre class=\"language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> image <span class=\"token operator\">=</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">;</span>\nimage<span class=\"token punctuation\">.</span>pixelBytes<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 修改R值</span>\nimage<span class=\"token punctuation\">.</span>pixelBytes<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 修改G值</span>\nimage<span class=\"token punctuation\">.</span>pixelBytes<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 修改B值</span>\nimage<span class=\"token punctuation\">.</span>pixelBytes<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 修改A值</span></code></pre>\n\n<p>目前这种场景较少，只在部分demo中见到直接修改图像像素数据的情况。</p>\n<h2 id=\"三、总结\"><a href=\"#三、总结\" class=\"headerlink\" title=\"三、总结\"></a>三、总结</h2><p>以上代码片段只为展示逻辑主脉络，省略了大量细节，需要看细节部分，可以从<strong>V8Manager</strong>这里作为入口。源码链接：<a href=\"https://github.com/boybeak/v8x\">v8x</a></p>\n","excerpt":"","more":"<h2 id=\"一、问题背景\"><a href=\"#一、问题背景\" class=\"headerlink\" title=\"一、问题背景\"></a>一、问题背景</h2><p>在小游戏开发中，常见的一种操作就是设置绘制属性，比如lineWidth、fillStyle这种，这在WebView方案中，因为全跑在JS环境中，没有任何问题。但是在J2V8方案中，因为绘制逻辑在JS层，绘制实现在Java层，这就导致JS层的属性设置，无法传达到Java层。</p>\n<p>本文项目地址：<a href=\"https://github.com/boybeak/v8x\">v8x</a></p>\n<pre class=\"language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> canvas<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 这里的ctx是Java层返回的V8Object对象</span>\nctx<span class=\"token punctuation\">.</span>lineWidth <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">...</span>\nctx<span class=\"token punctuation\">.</span><span class=\"token function\">stroke</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n\n<p>上述代码中，<code>ctx.lineWidth = 10;</code>修改后，在Java层是无法感知的。</p>\n<h3 id=\"1-1-以往方案\"><a href=\"#1-1-以往方案\" class=\"headerlink\" title=\"1.1 以往方案\"></a>1.1 以往方案</h3><p>以往方案中，是通过JS层，为ctx对象做代理，拦截到属性变化，再通过调用J2V8的绑定方法，告知Java层，某个属性变化的了。</p>\n<p>这样做，有以下几个缺点：</p>\n<ol>\n<li><p>有这种需求的类可能很多，每一个都要JS层做相应的适配，这会增加工作量和调试沟通成本；</p>\n</li>\n<li><p>并不是所有属性的变化都是Java层关心的；</p>\n</li>\n<li><p>JS层并不知道Java层的属性与类的关系，容易错乱，导致通知了属性变化，却不知道是哪个对象的属性变化了；</p>\n</li>\n<li><p>后期Java层类做了变动，需要JS层做相应修改，一旦遗漏，就会产生bug；</p>\n</li>\n</ol>\n<p>基于解决以上问题的目的，开发出新的方案——J2V8Binding。</p>\n<h2 id=\"二、J2V8Binding\"><a href=\"#二、J2V8Binding\" class=\"headerlink\" title=\"二、J2V8Binding\"></a>二、J2V8Binding</h2><p>J2V8Binding的目标是，将JS层属性的变更感知，全部控制在Java层内，无需JS层参与额外代码。</p>\n<h3 id=\"2-1-基本原理\"><a href=\"#2-1-基本原理\" class=\"headerlink\" title=\"2.1 基本原理\"></a>2.1 基本原理</h3><p>与旧方案类似的，我们仍然需要一个JS层的代理，而与旧方案不同的，新方案的代理是由Java层“生成”。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">val</span> CREATE_PROXY_JS <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"\"</span></span>\"\nfunction <span class=\"token function\">v8CreateProxy</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> new <span class=\"token function\">Proxy</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">set</span><span class=\"token operator\">:</span> <span class=\"token function\">function</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">// 在此拦截需要的值变化，并发送给Java层</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token string-literal singleline\"><span class=\"token string\">\"\"</span></span>\"\n<span class=\"token comment\">// ... 初始化V8时 ...</span>\nv8<span class=\"token punctuation\">.</span><span class=\"token function\">executeScript</span><span class=\"token punctuation\">(</span>CREATE_PROXY_JS<span class=\"token punctuation\">)</span></code></pre>\n\n<p>这里我们声明一段JS代码，这里用于创建JS层的代理对象。在初始化V8时，将此段JS代码注入到V8环境中，当我们需要一个JS层代理对象时，就可以执行此JS函数<code>v8CreateProxy</code>创建一个JS层的代理对象。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">createJSProxy</span><span class=\"token punctuation\">(</span>v8obj<span class=\"token operator\">:</span> V8Object<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> V8Object <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> v8<span class=\"token punctuation\">.</span><span class=\"token function\">executeObjectFunction</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"v8CreateProxy\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token function\">V8Array</span><span class=\"token punctuation\">(</span>v8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>v8obj<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h3 id=\"2-2-封装\"><a href=\"#2-2-封装\" class=\"headerlink\" title=\"2.2 封装\"></a>2.2 封装</h3><p>对以上基本逻辑进行封装，有关键类<strong>V8Binding</strong>、<strong>V8Manager</strong>、<strong>V8Field</strong>和<strong>V8Method</strong>。</p>\n<h4 id=\"2-2-1-V8Binding\"><a href=\"#2-2-1-V8Binding\" class=\"headerlink\" title=\"2.2.1 V8Binding\"></a>2.2.1 V8Binding</h4><p>一个需要绑定的类，需要实现<strong>V8Binding</strong>接口。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">interface</span> V8Binding <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">val</span> TAG <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"V8Binding\"</span></span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// V8Binding类的唯一id，用于将JS层对象与Java层对象进行一一对应</span>\n    <span class=\"token comment\">// 默认实现为该对象的hashCodeo().toString()</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">getBindingId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> String <span class=\"token punctuation\">&#123;</span>  <span class=\"token keyword\">return</span> <span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 获取或者创建一个与其对应的代理V8Object</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">getMyBinding</span><span class=\"token punctuation\">(</span>v8<span class=\"token operator\">:</span> V8<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> V8Object <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> V8Manager<span class=\"token punctuation\">.</span><span class=\"token function\">obtain</span><span class=\"token punctuation\">(</span>v8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isBound</span><span class=\"token punctuation\">(</span><span class=\"token function\">getBindingId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token function\">createBinding</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token label symbol\">@V8Binding</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token function\">getBinding</span><span class=\"token punctuation\">(</span><span class=\"token function\">getBindingId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 没有绑定，但是仍然关心的属性，获取关心的属性名称</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">getCareForFieldKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> <span class=\"token function\">emptyArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 关心的属性值变更时</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">onCareForFieldChanged</span><span class=\"token punctuation\">(</span>key<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span> newValue<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> oldValue<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token comment\">// 绑定的属性值由null变为非null值时触发，只针对非基本数据类型(数值与String)的属性触发</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">onBindingCreated</span><span class=\"token punctuation\">(</span>target<span class=\"token operator\">:</span> V8Object<span class=\"token punctuation\">,</span> fieldInfo<span class=\"token operator\">:</span> Key<span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> V8Object<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> V8Binding <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token function\">NotImplementedError</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"onCreateBinding must be implement when new binding created\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 绑定的属性值由非null变为null值时触发，只针对非基本数据类型(数值与String)的属性触发</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">onBindingDestroyed</span><span class=\"token punctuation\">(</span>target<span class=\"token operator\">:</span> V8Object<span class=\"token punctuation\">,</span> fieldInfo<span class=\"token operator\">:</span> Key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token function\">NotImplementedError</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"onBindingDestroyed must be implement when binding destroyed\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 绑定的属性值发生变化时触发</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">onBindingChanged</span><span class=\"token punctuation\">(</span>target<span class=\"token operator\">:</span> V8Object<span class=\"token punctuation\">,</span> fieldInfo<span class=\"token operator\">:</span> Key<span class=\"token punctuation\">,</span> newValue<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> oldValue<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>在<strong>getMyBinding</strong>方法中，我们使用V8Manager来创建或者获取一个与当前对象绑定的V8Object对象。</p>\n<h4 id=\"2-2-2-V8Manager\"><a href=\"#2-2-2-V8Manager\" class=\"headerlink\" title=\"2.2.2 V8Manager\"></a>2.2.2 V8Manager</h4><p>V8Manager是一个针对某个V8环境的管理类，主要是用于维护JS层对象与Java层的绑定关系，执行创建绑定关系、删除绑定关系，分发属性变更事件等作用，J2V8Binding的主要核心逻辑的所在。</p>\n<p>由于此处涉及到大量代码细节，故不在此罗列代码具体分析。</p>\n<h4 id=\"2-2-3-V8Field和V8Method\"><a href=\"#2-2-3-V8Field和V8Method\" class=\"headerlink\" title=\"2.2.3 V8Field和V8Method\"></a>2.2.3 V8Field和V8Method</h4><p>这两个类是注解类，用于标记类内属性和方法。</p>\n<p><strong>@V8Field(binding&#x3D;?)</strong>: 标记属性，其中有一个binding属性，标记此属性是否需要绑定，如果需要绑定，则会有事件回调，默认值为false。</p>\n<p><strong>@V8Method(jsFuncName&#x3D;?)</strong>: 标记方法，其中有一个jsFuncName属性，用于标识对应的JS函数的名称。</p>\n<h3 id=\"2-3-基本使用方法\"><a href=\"#2-3-基本使用方法\" class=\"headerlink\" title=\"2.3 基本使用方法\"></a>2.3 基本使用方法</h3><p>一个简单的示例类如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> User <span class=\"token operator\">:</span> V8Binding <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 不需要绑定的属性，值会传递到对应的JS对象，但该值在JS层发生变化，Java层不会知道</span>\n    <span class=\"token annotation builtin\">@V8Field</span>\n    <span class=\"token keyword\">val</span> name <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"John\"</span></span>\n    <span class=\"token comment\">// 需要绑定的属性，初始值会传递到JS对象，该值在JS层发生变化，会传递到Java层</span>\n    <span class=\"token annotation builtin\">@V8Field</span><span class=\"token punctuation\">(</span>binding <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">var</span> age <span class=\"token operator\">=</span> <span class=\"token number\">15</span>\n\n    <span class=\"token comment\">// 需要绑定的V8Binding类型属性，与之对应的V8Object会传递到JS对象，</span>\n    <span class=\"token comment\">// 在JS层，如果变更为其他JS层内部的对象，会解绑之前的关系，与新的JS对象建立新的绑定关系</span>\n    <span class=\"token annotation builtin\">@V8Binding</span><span class=\"token punctuation\">(</span>binding <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> location<span class=\"token operator\">:</span> V8Binding <span class=\"token operator\">=</span> <span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token comment\">// 在此方法中</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onBindingChanged</span><span class=\"token punctuation\">(</span>target<span class=\"token operator\">:</span> V8Object<span class=\"token punctuation\">,</span> fieldInfo<span class=\"token operator\">:</span> Key<span class=\"token punctuation\">,</span> newValue<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> oldValue<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">when</span><span class=\"token punctuation\">(</span>fieldInfo<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token string-literal singleline\"><span class=\"token string\">\"age\"</span></span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token annotation builtin\">@V8Method</span><span class=\"token punctuation\">(</span>jsFuncName <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"js层对应的名称，默认值与当前方法名一致\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">sayHello</span><span class=\"token punctuation\">(</span>helloTo<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">getCareForFieldKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> <span class=\"token function\">arrayOf</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"introduction\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">onCareForFieldChanged</span><span class=\"token punctuation\">(</span>key<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span> newValue<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> oldValue<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">when</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token string-literal singleline\"><span class=\"token string\">\"introduction\"</span></span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<p>当使用这个User类的一个对象user时候，可以按照如下方式使用。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> v8 <span class=\"token operator\">=</span> V8<span class=\"token punctuation\">.</span><span class=\"token function\">createRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> user <span class=\"token operator\">=</span> <span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\nv8<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"user\"</span></span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">.</span><span class=\"token function\">getMyBinding</span><span class=\"token punctuation\">(</span>v8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre>\n\n<p>这里，我们在JS环境中，增加了一个user变量。</p>\n<p>然后在JS层，执行以下代码。</p>\n<pre class=\"language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">user<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"Smith\"</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Java层不会感知到</span>\nuser<span class=\"token punctuation\">.</span>age <span class=\"token operator\">=</span> <span class=\"token number\">16</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// Java层可以在onBindingChanged感知到</span>\nuser<span class=\"token punctuation\">.</span>location <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Java层可以在onBindingChanged感知到，并解绑旧location值，与新值建立绑定关系</span>\nuser<span class=\"token punctuation\">.</span>introduction <span class=\"token operator\">=</span> <span class=\"token string\">\"Hi\"</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Java层可以在onCareForFieldChanged感知到</span></code></pre>\n\n<p>在修改<code>name</code>属性时，由于此属性是被V8Field标记binding为false，则不会通知Java层此值的修改事件。</p>\n<p>在修改<code>age</code>属性时，由于此值被V8Field标记binding为true，会通知Java层此值的修改事件。</p>\n<p>在修改<code>location</code>属性时，虽然此值为一个对象，但是被V8Field标记binding为true，会通知Java层此值的修改事件。注意：用V8Field标记的对象类型，必须为V8可以接受的数据类型或者V8Binding类型。</p>\n<p>在修改<code>introduction</code>时，虽然此值没有被V8Field标记，但是由于在getCareForFieldKeys返回的数组中，同样会有事件通知。</p>\n<p>有了这种机制，小游戏开发中，就可以很方便的感知到绘制属性的变化。</p>\n<h3 id=\"2-4-仍然存在的问题\"><a href=\"#2-4-仍然存在的问题\" class=\"headerlink\" title=\"2.4 仍然存在的问题\"></a>2.4 仍然存在的问题</h3><p>目前仍然有一种问题是无法解决的，那就是数组中某个数据发生变化时，Java层是无法得知的。</p>\n<p>如下代码：</p>\n<pre class=\"language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> image <span class=\"token operator\">=</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">;</span>\nimage<span class=\"token punctuation\">.</span>pixelBytes<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 修改R值</span>\nimage<span class=\"token punctuation\">.</span>pixelBytes<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 修改G值</span>\nimage<span class=\"token punctuation\">.</span>pixelBytes<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 修改B值</span>\nimage<span class=\"token punctuation\">.</span>pixelBytes<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 修改A值</span></code></pre>\n\n<p>目前这种场景较少，只在部分demo中见到直接修改图像像素数据的情况。</p>\n<h2 id=\"三、总结\"><a href=\"#三、总结\" class=\"headerlink\" title=\"三、总结\"></a>三、总结</h2><p>以上代码片段只为展示逻辑主脉络，省略了大量细节，需要看细节部分，可以从<strong>V8Manager</strong>这里作为入口。源码链接：<a href=\"https://github.com/boybeak/v8x\">v8x</a></p>\n"},{"title":"Camera无变形任意尺寸预览","date":"2023-11-12T07:26:00.000Z","_content":"\n在以往做Camera应用开发时，遇到一个问题，就是相机的预览如何做到在任意尺寸完全无变形的画面预览与视频录制。做过相机应用开发的朋友都知道，相机的预览尺寸并不是可以随意设置的，而是需要在**支持的预览尺寸**中选择一个，你的预览的view大小必须与选择的尺寸相匹配，才能保证画面不变形，但是这在实际开发中是无法应对各种各样的需求的，而且每个手机，支持的预览尺寸并不是完全一致的，而视频的大小往往是需要做到一致的，不然录制出来的视频，在其他手机上播放，就需要做大量的UI适配工作，也没有平台的统一性。\n\n最初让我有这样的想法，是想做方形的视频，如最初Ins一样，那已经是7年前了，但是当时技术有限，并没有探索出最佳的方案，当时最多可以先录制再通过ffmpeg进行裁剪，这样效率太低了，用户是不能接受的，而且预览画面需要做遮罩，录制做不到所见即所得。\n\n经过其他工作的积累，在OpenGL与Surface搭配工作这方便，点了新的技能点。终于探索出最佳的技术方案。\n\n最终示例代码可以参考我的Github: [iCamera](https://github.com/boybeak/iCamera)。\n\n## 一、技术背景\n在阅读接下来的内容前，你最好有以下技术储备：\n1. Camera1相关API的使用经验；\n2. 对Android的surface有一定了解；\n3. 对OpenGL最好有所了解；\n\n当然，如果没有以上相关的知识储备，也不妨碍定性的理解整体流程。\n\n## 二、基本思路\n在一般的Camera应用开发时，通常需要有一个预览画面的控件，一般时SurfaceView或者TextureView，然后把Surface或者SurfaceTexture设置给Camera进行预览。\n\n而在我们的方案中，这个过程，要增加一些步骤。具体的步骤如下：\n1. 从SurfaceView或者TextureView获得Surface对象，比如`holder.surface`或者`Surface(surfaceTexture)`；\n2. 由此Surface对象，我们创建EGL环境，并重新创建一个`SurfaceTexture`对象，这个新的`SurfaceTexture`对象，最后需要设置给Camera进行预览；\n3. 监听步骤2中创建的`SurfaceTexture`对象的帧数据，通过OpenGL对画面**消除形变**并进行渲染。\n\n以上就是基本思路，是不是还是一头雾水？没关系，下面进行具体实现的讲解。\n\n## 三、具体实现\n在上述的步骤中，第1步很简单，这里不再进行赘述，直接从步骤2开始。\n\n### 3.1 通过Surface创建EGL环境\n一般代码示例如下：\n```kotlin\nprivate val display: EGLDisplay by lazy { EGL14.eglGetDisplay(EGL14.EGL_DEFAULT_DISPLAY) }\nprivate var eglSurface: EGLSurface? = null\nvar eglContext: EGLContext? = null\n    private set\nprivate fun createEGL(surface: Surface) {\n    val version = IntArray(2)\n    EGL14.eglInitialize(display, version, 0, version, 1)\n\n    val attributes = intArrayOf(\n        EGL14.EGL_RED_SIZE, 8,\n        EGL14.EGL_GREEN_SIZE, 8,\n        EGL14.EGL_BLUE_SIZE, 8,\n        EGL14.EGL_ALPHA_SIZE, 8,\n        EGL14.EGL_RENDERABLE_TYPE, EGL14.EGL_OPENGL_ES2_BIT,\n        EGL14.EGL_NONE, 0,      // placeholder for recordable [@-3]\n        EGL14.EGL_NONE\n    )\n\n    val configs = arrayOfNulls<EGLConfig>(1)\n    val numConfigs = IntArray(1)\n    EGL14.eglChooseConfig(display, attributes, 0, configs, 0,\n        configs.size, numConfigs, 0)\n\n    val config = configs[0]\n\n    eglSurface = EGL14.eglCreateWindowSurface(\n        display, config, surface, intArrayOf(\n            EGL14.EGL_NONE\n        ), 0\n    )\n\n    eglContext = EGL14.eglCreateContext(\n        display, config, sharedContext ?: EGL14.EGL_NO_CONTEXT, intArrayOf(\n            EGL14.EGL_CONTEXT_CLIENT_VERSION, 2, EGL14.EGL_NONE\n        ), 0\n    )\n    EGL14.eglMakeCurrent(display, eglSurface, eglSurface, eglContext)\n}\n```\n这里需要注意的是，这个方法调用需要在一个独立的线程中，最后一句代码是与当前线程绑定，相关的OpenGL的操作，只能在对应的线程中进行。\n有了这个OpenGL环境以后，就可以创建对应的`SurfaceTexture`了，简单的代码如下：\n```kotlin\nval textureIds = IntArray(1)\nGLES20.glGenTextures(1, textureIds, 0)\nval texture = SurfaceTexture(textureIds[0])\n```\n同样的，这里的代码也要运行在之前的创建EGL环境相同的线程之下，之后便可以将这里创建的`texture`设置给camera对象用于预览。\n\n### 3.2 监听预览-消除形变-绘制画面\n给上一步中创建的`texture`设置一个画面监听。\n```kotlin\nval matrix = FloatArray(16)\ntexture.setOnFrameAvailableListener {\n    queue {\n        texture.updateTexImage()\n        texture.getTransformMatrix(matrix)\n\n        drawFrame(textureIds[0], matrix)\n    }\n}\n\nfun drawFrame(textureId: Int, matrix: FloatArray) {\n    // ....\n}\n```\n简单解释一下这里代码：\n1. 先创建一个浮点数组，用于接收预览画面的坐标数据，用于OpenGL绘制画面使用；\n2. 然后设置画面监听，这里在相机开启预览后会触发一次；\n3. 在画面监听回调中，切换到EGL线程中，调用`updateTexImage`，只有这样，画面监听回调才会持续的被执行；\n4. 最后调用`getTransformMatrix`获取画面坐标数据，为之后的画面绘制做准备。\n\n接下来，便是执行画面的绘制，在画面绘制关键的一步就是消除形变，这里需要先获得camera对象的预览尺寸，从支持的预览尺寸中，挑选最佳匹配尺寸以及消除方形问题的相关代码，这里不再赘述，只提供消除形变的关键代码。\n```kotlin\nval inputSize: Size // 相机输出的预览画面尺寸，因为要作为绘制的输入，所以称为inputSize，注意消除屏幕方向旋转的问题\nval outputSize: Size // 输出画面的尺寸\nval viewport: Rect // 计算出预览画面要消除形变，需要做的位置与尺寸变更\n\nprivate fun calculateBestViewPort() {\n    if (inputSize.isEmpty || outputSize.isEmpty) {\n        return\n    }\n\n    val scale = max(outputSize.width.toFloat() / inputSize.width, outputSize.height.toFloat() / inputSize.height)\n    val srcWidth = (inputSize.width * scale).toInt()\n    val srcHeight = (inputSize.height * scale).toInt()\n\n    val left = (outputSize.width - srcWidth) / 2\n    val top = (outputSize.height - srcHeight) / 2\n    viewport.set(left, top, left + srcWidth, top + srcHeight)\n}\n```\n在绘制画面前，执行OpenGL的`glViewport`方法，就可以消除形变了。\n```kotlin\nfun drawFrame(textureId: Int, texMatrix: FloatArray?) {\n    if (!viewport.isEmpty) {\n        GLES20.glViewport(viewport.left, viewport.top, viewport.width(), viewport.height())\n    }\n    // 绘制画面代码有大量的OpenGL操作，具体不再赘述\n}\n```\n\n## 四、总结\n到这里，主要的消除形变预览相机画面的主要逻辑流程，就基本结束了，重点是梳理思路，在具体的实践中，还是有很多细碎的问题的，就比如相机预览尺寸的选取与方向设置问题。\n\n另外，为这里只是为了说明逻辑，临时写了代码逻辑部分，实际项目中，我直接使用了[Grafika](https://github.com/google/grafika)项目中的egl包下代码，这个项目给了我很多灵感，真心推荐给各位看一下这个项目中的代码。\n\n也许同样做过消除形变的朋友，会认为为什么不直接使用`TextureView`，然后通过`setTransform`的方式消除形变呢？\n\n实际上，如果只是为了消除预览的形变，这样做是没有问题的，也是非常便捷的，但是做相机应用的开发，难免会有拍照、录像、帧数据回调(主要是扫码)相关的功能性逻辑，在这类逻辑中，通过这种方式，就无法做到**可见即所得**式的效果了，就比如拍照，你必须在拍照后，对图片做一次按照预览框尺寸`crop`的操作了，如果只是拍照还比较简单，如果是录像的话，没有录像期间切换摄像头的需求，使用`MediaRecorder`或许可以，我没有试过，但是有这样的需求，`MediaRecorder`就无法满足需求了，面对这样的需求，我之前是通过获取帧数据，然后用libYuv缩放、剪裁反转旋转帧数据等操作，最后喂给`MediaCodec`的方式，我当前的这个方案，是可以通过共享OpenGL上下文的方式，实现**所见即所得**的录像，不需要繁琐的操作帧数据了，减少了额外库的引入。\n\n对于上述录像相关的逻辑，我将用新的文章来阐述。","source":"_posts/2023-11-12-Camera无变形任意尺寸预览.md","raw":"---\ntitle: 'Camera无变形任意尺寸预览'\ndate: 2023-11-12 15:26:00\ncategories: Android技巧\ntags:\n- Android\n- Camera\n---\n\n在以往做Camera应用开发时，遇到一个问题，就是相机的预览如何做到在任意尺寸完全无变形的画面预览与视频录制。做过相机应用开发的朋友都知道，相机的预览尺寸并不是可以随意设置的，而是需要在**支持的预览尺寸**中选择一个，你的预览的view大小必须与选择的尺寸相匹配，才能保证画面不变形，但是这在实际开发中是无法应对各种各样的需求的，而且每个手机，支持的预览尺寸并不是完全一致的，而视频的大小往往是需要做到一致的，不然录制出来的视频，在其他手机上播放，就需要做大量的UI适配工作，也没有平台的统一性。\n\n最初让我有这样的想法，是想做方形的视频，如最初Ins一样，那已经是7年前了，但是当时技术有限，并没有探索出最佳的方案，当时最多可以先录制再通过ffmpeg进行裁剪，这样效率太低了，用户是不能接受的，而且预览画面需要做遮罩，录制做不到所见即所得。\n\n经过其他工作的积累，在OpenGL与Surface搭配工作这方便，点了新的技能点。终于探索出最佳的技术方案。\n\n最终示例代码可以参考我的Github: [iCamera](https://github.com/boybeak/iCamera)。\n\n## 一、技术背景\n在阅读接下来的内容前，你最好有以下技术储备：\n1. Camera1相关API的使用经验；\n2. 对Android的surface有一定了解；\n3. 对OpenGL最好有所了解；\n\n当然，如果没有以上相关的知识储备，也不妨碍定性的理解整体流程。\n\n## 二、基本思路\n在一般的Camera应用开发时，通常需要有一个预览画面的控件，一般时SurfaceView或者TextureView，然后把Surface或者SurfaceTexture设置给Camera进行预览。\n\n而在我们的方案中，这个过程，要增加一些步骤。具体的步骤如下：\n1. 从SurfaceView或者TextureView获得Surface对象，比如`holder.surface`或者`Surface(surfaceTexture)`；\n2. 由此Surface对象，我们创建EGL环境，并重新创建一个`SurfaceTexture`对象，这个新的`SurfaceTexture`对象，最后需要设置给Camera进行预览；\n3. 监听步骤2中创建的`SurfaceTexture`对象的帧数据，通过OpenGL对画面**消除形变**并进行渲染。\n\n以上就是基本思路，是不是还是一头雾水？没关系，下面进行具体实现的讲解。\n\n## 三、具体实现\n在上述的步骤中，第1步很简单，这里不再进行赘述，直接从步骤2开始。\n\n### 3.1 通过Surface创建EGL环境\n一般代码示例如下：\n```kotlin\nprivate val display: EGLDisplay by lazy { EGL14.eglGetDisplay(EGL14.EGL_DEFAULT_DISPLAY) }\nprivate var eglSurface: EGLSurface? = null\nvar eglContext: EGLContext? = null\n    private set\nprivate fun createEGL(surface: Surface) {\n    val version = IntArray(2)\n    EGL14.eglInitialize(display, version, 0, version, 1)\n\n    val attributes = intArrayOf(\n        EGL14.EGL_RED_SIZE, 8,\n        EGL14.EGL_GREEN_SIZE, 8,\n        EGL14.EGL_BLUE_SIZE, 8,\n        EGL14.EGL_ALPHA_SIZE, 8,\n        EGL14.EGL_RENDERABLE_TYPE, EGL14.EGL_OPENGL_ES2_BIT,\n        EGL14.EGL_NONE, 0,      // placeholder for recordable [@-3]\n        EGL14.EGL_NONE\n    )\n\n    val configs = arrayOfNulls<EGLConfig>(1)\n    val numConfigs = IntArray(1)\n    EGL14.eglChooseConfig(display, attributes, 0, configs, 0,\n        configs.size, numConfigs, 0)\n\n    val config = configs[0]\n\n    eglSurface = EGL14.eglCreateWindowSurface(\n        display, config, surface, intArrayOf(\n            EGL14.EGL_NONE\n        ), 0\n    )\n\n    eglContext = EGL14.eglCreateContext(\n        display, config, sharedContext ?: EGL14.EGL_NO_CONTEXT, intArrayOf(\n            EGL14.EGL_CONTEXT_CLIENT_VERSION, 2, EGL14.EGL_NONE\n        ), 0\n    )\n    EGL14.eglMakeCurrent(display, eglSurface, eglSurface, eglContext)\n}\n```\n这里需要注意的是，这个方法调用需要在一个独立的线程中，最后一句代码是与当前线程绑定，相关的OpenGL的操作，只能在对应的线程中进行。\n有了这个OpenGL环境以后，就可以创建对应的`SurfaceTexture`了，简单的代码如下：\n```kotlin\nval textureIds = IntArray(1)\nGLES20.glGenTextures(1, textureIds, 0)\nval texture = SurfaceTexture(textureIds[0])\n```\n同样的，这里的代码也要运行在之前的创建EGL环境相同的线程之下，之后便可以将这里创建的`texture`设置给camera对象用于预览。\n\n### 3.2 监听预览-消除形变-绘制画面\n给上一步中创建的`texture`设置一个画面监听。\n```kotlin\nval matrix = FloatArray(16)\ntexture.setOnFrameAvailableListener {\n    queue {\n        texture.updateTexImage()\n        texture.getTransformMatrix(matrix)\n\n        drawFrame(textureIds[0], matrix)\n    }\n}\n\nfun drawFrame(textureId: Int, matrix: FloatArray) {\n    // ....\n}\n```\n简单解释一下这里代码：\n1. 先创建一个浮点数组，用于接收预览画面的坐标数据，用于OpenGL绘制画面使用；\n2. 然后设置画面监听，这里在相机开启预览后会触发一次；\n3. 在画面监听回调中，切换到EGL线程中，调用`updateTexImage`，只有这样，画面监听回调才会持续的被执行；\n4. 最后调用`getTransformMatrix`获取画面坐标数据，为之后的画面绘制做准备。\n\n接下来，便是执行画面的绘制，在画面绘制关键的一步就是消除形变，这里需要先获得camera对象的预览尺寸，从支持的预览尺寸中，挑选最佳匹配尺寸以及消除方形问题的相关代码，这里不再赘述，只提供消除形变的关键代码。\n```kotlin\nval inputSize: Size // 相机输出的预览画面尺寸，因为要作为绘制的输入，所以称为inputSize，注意消除屏幕方向旋转的问题\nval outputSize: Size // 输出画面的尺寸\nval viewport: Rect // 计算出预览画面要消除形变，需要做的位置与尺寸变更\n\nprivate fun calculateBestViewPort() {\n    if (inputSize.isEmpty || outputSize.isEmpty) {\n        return\n    }\n\n    val scale = max(outputSize.width.toFloat() / inputSize.width, outputSize.height.toFloat() / inputSize.height)\n    val srcWidth = (inputSize.width * scale).toInt()\n    val srcHeight = (inputSize.height * scale).toInt()\n\n    val left = (outputSize.width - srcWidth) / 2\n    val top = (outputSize.height - srcHeight) / 2\n    viewport.set(left, top, left + srcWidth, top + srcHeight)\n}\n```\n在绘制画面前，执行OpenGL的`glViewport`方法，就可以消除形变了。\n```kotlin\nfun drawFrame(textureId: Int, texMatrix: FloatArray?) {\n    if (!viewport.isEmpty) {\n        GLES20.glViewport(viewport.left, viewport.top, viewport.width(), viewport.height())\n    }\n    // 绘制画面代码有大量的OpenGL操作，具体不再赘述\n}\n```\n\n## 四、总结\n到这里，主要的消除形变预览相机画面的主要逻辑流程，就基本结束了，重点是梳理思路，在具体的实践中，还是有很多细碎的问题的，就比如相机预览尺寸的选取与方向设置问题。\n\n另外，为这里只是为了说明逻辑，临时写了代码逻辑部分，实际项目中，我直接使用了[Grafika](https://github.com/google/grafika)项目中的egl包下代码，这个项目给了我很多灵感，真心推荐给各位看一下这个项目中的代码。\n\n也许同样做过消除形变的朋友，会认为为什么不直接使用`TextureView`，然后通过`setTransform`的方式消除形变呢？\n\n实际上，如果只是为了消除预览的形变，这样做是没有问题的，也是非常便捷的，但是做相机应用的开发，难免会有拍照、录像、帧数据回调(主要是扫码)相关的功能性逻辑，在这类逻辑中，通过这种方式，就无法做到**可见即所得**式的效果了，就比如拍照，你必须在拍照后，对图片做一次按照预览框尺寸`crop`的操作了，如果只是拍照还比较简单，如果是录像的话，没有录像期间切换摄像头的需求，使用`MediaRecorder`或许可以，我没有试过，但是有这样的需求，`MediaRecorder`就无法满足需求了，面对这样的需求，我之前是通过获取帧数据，然后用libYuv缩放、剪裁反转旋转帧数据等操作，最后喂给`MediaCodec`的方式，我当前的这个方案，是可以通过共享OpenGL上下文的方式，实现**所见即所得**的录像，不需要繁琐的操作帧数据了，减少了额外库的引入。\n\n对于上述录像相关的逻辑，我将用新的文章来阐述。","slug":"2023-11-12-Camera无变形任意尺寸预览","published":1,"updated":"2024-09-25T02:53:02.300Z","comments":1,"layout":"post","photos":[],"_id":"cm1ltr0g4002cbji0e6edg6t3","content":"<p>在以往做Camera应用开发时，遇到一个问题，就是相机的预览如何做到在任意尺寸完全无变形的画面预览与视频录制。做过相机应用开发的朋友都知道，相机的预览尺寸并不是可以随意设置的，而是需要在<strong>支持的预览尺寸</strong>中选择一个，你的预览的view大小必须与选择的尺寸相匹配，才能保证画面不变形，但是这在实际开发中是无法应对各种各样的需求的，而且每个手机，支持的预览尺寸并不是完全一致的，而视频的大小往往是需要做到一致的，不然录制出来的视频，在其他手机上播放，就需要做大量的UI适配工作，也没有平台的统一性。</p>\n<p>最初让我有这样的想法，是想做方形的视频，如最初Ins一样，那已经是7年前了，但是当时技术有限，并没有探索出最佳的方案，当时最多可以先录制再通过ffmpeg进行裁剪，这样效率太低了，用户是不能接受的，而且预览画面需要做遮罩，录制做不到所见即所得。</p>\n<p>经过其他工作的积累，在OpenGL与Surface搭配工作这方便，点了新的技能点。终于探索出最佳的技术方案。</p>\n<p>最终示例代码可以参考我的Github: <a href=\"https://github.com/boybeak/iCamera\">iCamera</a>。</p>\n<h2 id=\"一、技术背景\"><a href=\"#一、技术背景\" class=\"headerlink\" title=\"一、技术背景\"></a>一、技术背景</h2><p>在阅读接下来的内容前，你最好有以下技术储备：</p>\n<ol>\n<li>Camera1相关API的使用经验；</li>\n<li>对Android的surface有一定了解；</li>\n<li>对OpenGL最好有所了解；</li>\n</ol>\n<p>当然，如果没有以上相关的知识储备，也不妨碍定性的理解整体流程。</p>\n<h2 id=\"二、基本思路\"><a href=\"#二、基本思路\" class=\"headerlink\" title=\"二、基本思路\"></a>二、基本思路</h2><p>在一般的Camera应用开发时，通常需要有一个预览画面的控件，一般时SurfaceView或者TextureView，然后把Surface或者SurfaceTexture设置给Camera进行预览。</p>\n<p>而在我们的方案中，这个过程，要增加一些步骤。具体的步骤如下：</p>\n<ol>\n<li>从SurfaceView或者TextureView获得Surface对象，比如<code>holder.surface</code>或者<code>Surface(surfaceTexture)</code>；</li>\n<li>由此Surface对象，我们创建EGL环境，并重新创建一个<code>SurfaceTexture</code>对象，这个新的<code>SurfaceTexture</code>对象，最后需要设置给Camera进行预览；</li>\n<li>监听步骤2中创建的<code>SurfaceTexture</code>对象的帧数据，通过OpenGL对画面<strong>消除形变</strong>并进行渲染。</li>\n</ol>\n<p>以上就是基本思路，是不是还是一头雾水？没关系，下面进行具体实现的讲解。</p>\n<h2 id=\"三、具体实现\"><a href=\"#三、具体实现\" class=\"headerlink\" title=\"三、具体实现\"></a>三、具体实现</h2><p>在上述的步骤中，第1步很简单，这里不再进行赘述，直接从步骤2开始。</p>\n<h3 id=\"3-1-通过Surface创建EGL环境\"><a href=\"#3-1-通过Surface创建EGL环境\" class=\"headerlink\" title=\"3.1 通过Surface创建EGL环境\"></a>3.1 通过Surface创建EGL环境</h3><p>一般代码示例如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> display<span class=\"token operator\">:</span> EGLDisplay <span class=\"token keyword\">by</span> lazy <span class=\"token punctuation\">&#123;</span> EGL14<span class=\"token punctuation\">.</span><span class=\"token function\">eglGetDisplay</span><span class=\"token punctuation\">(</span>EGL14<span class=\"token punctuation\">.</span>EGL_DEFAULT_DISPLAY<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> eglSurface<span class=\"token operator\">:</span> EGLSurface<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">var</span> eglContext<span class=\"token operator\">:</span> EGLContext<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">set</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">createEGL</span><span class=\"token punctuation\">(</span>surface<span class=\"token operator\">:</span> Surface<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">val</span> version <span class=\"token operator\">=</span> <span class=\"token function\">IntArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n    EGL14<span class=\"token punctuation\">.</span><span class=\"token function\">eglInitialize</span><span class=\"token punctuation\">(</span>display<span class=\"token punctuation\">,</span> version<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> version<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">val</span> attributes <span class=\"token operator\">=</span> <span class=\"token function\">intArrayOf</span><span class=\"token punctuation\">(</span>\n        EGL14<span class=\"token punctuation\">.</span>EGL_RED_SIZE<span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n        EGL14<span class=\"token punctuation\">.</span>EGL_GREEN_SIZE<span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n        EGL14<span class=\"token punctuation\">.</span>EGL_BLUE_SIZE<span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n        EGL14<span class=\"token punctuation\">.</span>EGL_ALPHA_SIZE<span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n        EGL14<span class=\"token punctuation\">.</span>EGL_RENDERABLE_TYPE<span class=\"token punctuation\">,</span> EGL14<span class=\"token punctuation\">.</span>EGL_OPENGL_ES2_BIT<span class=\"token punctuation\">,</span>\n        EGL14<span class=\"token punctuation\">.</span>EGL_NONE<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>      <span class=\"token comment\">// placeholder for recordable [@-3]</span>\n        EGL14<span class=\"token punctuation\">.</span>EGL_NONE\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">val</span> configs <span class=\"token operator\">=</span> arrayOfNulls<span class=\"token operator\">&lt;</span>EGLConfig<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> numConfigs <span class=\"token operator\">=</span> <span class=\"token function\">IntArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    EGL14<span class=\"token punctuation\">.</span><span class=\"token function\">eglChooseConfig</span><span class=\"token punctuation\">(</span>display<span class=\"token punctuation\">,</span> attributes<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> configs<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        configs<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span> numConfigs<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">val</span> config <span class=\"token operator\">=</span> configs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n\n    eglSurface <span class=\"token operator\">=</span> EGL14<span class=\"token punctuation\">.</span><span class=\"token function\">eglCreateWindowSurface</span><span class=\"token punctuation\">(</span>\n        display<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> surface<span class=\"token punctuation\">,</span> <span class=\"token function\">intArrayOf</span><span class=\"token punctuation\">(</span>\n            EGL14<span class=\"token punctuation\">.</span>EGL_NONE\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span>\n    <span class=\"token punctuation\">)</span>\n\n    eglContext <span class=\"token operator\">=</span> EGL14<span class=\"token punctuation\">.</span><span class=\"token function\">eglCreateContext</span><span class=\"token punctuation\">(</span>\n        display<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> sharedContext <span class=\"token operator\">?:</span> EGL14<span class=\"token punctuation\">.</span>EGL_NO_CONTEXT<span class=\"token punctuation\">,</span> <span class=\"token function\">intArrayOf</span><span class=\"token punctuation\">(</span>\n            EGL14<span class=\"token punctuation\">.</span>EGL_CONTEXT_CLIENT_VERSION<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> EGL14<span class=\"token punctuation\">.</span>EGL_NONE\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span>\n    <span class=\"token punctuation\">)</span>\n    EGL14<span class=\"token punctuation\">.</span><span class=\"token function\">eglMakeCurrent</span><span class=\"token punctuation\">(</span>display<span class=\"token punctuation\">,</span> eglSurface<span class=\"token punctuation\">,</span> eglSurface<span class=\"token punctuation\">,</span> eglContext<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>这里需要注意的是，这个方法调用需要在一个独立的线程中，最后一句代码是与当前线程绑定，相关的OpenGL的操作，只能在对应的线程中进行。<br>有了这个OpenGL环境以后，就可以创建对应的<code>SurfaceTexture</code>了，简单的代码如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> textureIds <span class=\"token operator\">=</span> <span class=\"token function\">IntArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\nGLES20<span class=\"token punctuation\">.</span><span class=\"token function\">glGenTextures</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> textureIds<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> texture <span class=\"token operator\">=</span> <span class=\"token function\">SurfaceTexture</span><span class=\"token punctuation\">(</span>textureIds<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre>\n<p>同样的，这里的代码也要运行在之前的创建EGL环境相同的线程之下，之后便可以将这里创建的<code>texture</code>设置给camera对象用于预览。</p>\n<h3 id=\"3-2-监听预览-消除形变-绘制画面\"><a href=\"#3-2-监听预览-消除形变-绘制画面\" class=\"headerlink\" title=\"3.2 监听预览-消除形变-绘制画面\"></a>3.2 监听预览-消除形变-绘制画面</h3><p>给上一步中创建的<code>texture</code>设置一个画面监听。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> matrix <span class=\"token operator\">=</span> <span class=\"token function\">FloatArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\ntexture<span class=\"token punctuation\">.</span><span class=\"token function\">setOnFrameAvailableListener</span> <span class=\"token punctuation\">&#123;</span>\n    queue <span class=\"token punctuation\">&#123;</span>\n        texture<span class=\"token punctuation\">.</span><span class=\"token function\">updateTexImage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        texture<span class=\"token punctuation\">.</span><span class=\"token function\">getTransformMatrix</span><span class=\"token punctuation\">(</span>matrix<span class=\"token punctuation\">)</span>\n\n        <span class=\"token function\">drawFrame</span><span class=\"token punctuation\">(</span>textureIds<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> matrix<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">fun</span> <span class=\"token function\">drawFrame</span><span class=\"token punctuation\">(</span>textureId<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> matrix<span class=\"token operator\">:</span> FloatArray<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// ....</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>简单解释一下这里代码：</p>\n<ol>\n<li>先创建一个浮点数组，用于接收预览画面的坐标数据，用于OpenGL绘制画面使用；</li>\n<li>然后设置画面监听，这里在相机开启预览后会触发一次；</li>\n<li>在画面监听回调中，切换到EGL线程中，调用<code>updateTexImage</code>，只有这样，画面监听回调才会持续的被执行；</li>\n<li>最后调用<code>getTransformMatrix</code>获取画面坐标数据，为之后的画面绘制做准备。</li>\n</ol>\n<p>接下来，便是执行画面的绘制，在画面绘制关键的一步就是消除形变，这里需要先获得camera对象的预览尺寸，从支持的预览尺寸中，挑选最佳匹配尺寸以及消除方形问题的相关代码，这里不再赘述，只提供消除形变的关键代码。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> inputSize<span class=\"token operator\">:</span> Size <span class=\"token comment\">// 相机输出的预览画面尺寸，因为要作为绘制的输入，所以称为inputSize，注意消除屏幕方向旋转的问题</span>\n<span class=\"token keyword\">val</span> outputSize<span class=\"token operator\">:</span> Size <span class=\"token comment\">// 输出画面的尺寸</span>\n<span class=\"token keyword\">val</span> viewport<span class=\"token operator\">:</span> Rect <span class=\"token comment\">// 计算出预览画面要消除形变，需要做的位置与尺寸变更</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">calculateBestViewPort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>inputSize<span class=\"token punctuation\">.</span>isEmpty <span class=\"token operator\">||</span> outputSize<span class=\"token punctuation\">.</span>isEmpty<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">val</span> scale <span class=\"token operator\">=</span> <span class=\"token function\">max</span><span class=\"token punctuation\">(</span>outputSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">.</span><span class=\"token function\">toFloat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> inputSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> outputSize<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">.</span><span class=\"token function\">toFloat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> inputSize<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> srcWidth <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>inputSize<span class=\"token punctuation\">.</span>width <span class=\"token operator\">*</span> scale<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> srcHeight <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>inputSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">*</span> scale<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">val</span> left <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>outputSize<span class=\"token punctuation\">.</span>width <span class=\"token operator\">-</span> srcWidth<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span>\n    <span class=\"token keyword\">val</span> top <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>outputSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">-</span> srcHeight<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span>\n    viewport<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>left<span class=\"token punctuation\">,</span> top<span class=\"token punctuation\">,</span> left <span class=\"token operator\">+</span> srcWidth<span class=\"token punctuation\">,</span> top <span class=\"token operator\">+</span> srcHeight<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>在绘制画面前，执行OpenGL的<code>glViewport</code>方法，就可以消除形变了。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">drawFrame</span><span class=\"token punctuation\">(</span>textureId<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> texMatrix<span class=\"token operator\">:</span> FloatArray<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>viewport<span class=\"token punctuation\">.</span>isEmpty<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        GLES20<span class=\"token punctuation\">.</span><span class=\"token function\">glViewport</span><span class=\"token punctuation\">(</span>viewport<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">,</span> viewport<span class=\"token punctuation\">.</span>top<span class=\"token punctuation\">,</span> viewport<span class=\"token punctuation\">.</span><span class=\"token function\">width</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> viewport<span class=\"token punctuation\">.</span><span class=\"token function\">height</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 绘制画面代码有大量的OpenGL操作，具体不再赘述</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<h2 id=\"四、总结\"><a href=\"#四、总结\" class=\"headerlink\" title=\"四、总结\"></a>四、总结</h2><p>到这里，主要的消除形变预览相机画面的主要逻辑流程，就基本结束了，重点是梳理思路，在具体的实践中，还是有很多细碎的问题的，就比如相机预览尺寸的选取与方向设置问题。</p>\n<p>另外，为这里只是为了说明逻辑，临时写了代码逻辑部分，实际项目中，我直接使用了<a href=\"https://github.com/google/grafika\">Grafika</a>项目中的egl包下代码，这个项目给了我很多灵感，真心推荐给各位看一下这个项目中的代码。</p>\n<p>也许同样做过消除形变的朋友，会认为为什么不直接使用<code>TextureView</code>，然后通过<code>setTransform</code>的方式消除形变呢？</p>\n<p>实际上，如果只是为了消除预览的形变，这样做是没有问题的，也是非常便捷的，但是做相机应用的开发，难免会有拍照、录像、帧数据回调(主要是扫码)相关的功能性逻辑，在这类逻辑中，通过这种方式，就无法做到<strong>可见即所得</strong>式的效果了，就比如拍照，你必须在拍照后，对图片做一次按照预览框尺寸<code>crop</code>的操作了，如果只是拍照还比较简单，如果是录像的话，没有录像期间切换摄像头的需求，使用<code>MediaRecorder</code>或许可以，我没有试过，但是有这样的需求，<code>MediaRecorder</code>就无法满足需求了，面对这样的需求，我之前是通过获取帧数据，然后用libYuv缩放、剪裁反转旋转帧数据等操作，最后喂给<code>MediaCodec</code>的方式，我当前的这个方案，是可以通过共享OpenGL上下文的方式，实现<strong>所见即所得</strong>的录像，不需要繁琐的操作帧数据了，减少了额外库的引入。</p>\n<p>对于上述录像相关的逻辑，我将用新的文章来阐述。</p>\n","excerpt":"","more":"<p>在以往做Camera应用开发时，遇到一个问题，就是相机的预览如何做到在任意尺寸完全无变形的画面预览与视频录制。做过相机应用开发的朋友都知道，相机的预览尺寸并不是可以随意设置的，而是需要在<strong>支持的预览尺寸</strong>中选择一个，你的预览的view大小必须与选择的尺寸相匹配，才能保证画面不变形，但是这在实际开发中是无法应对各种各样的需求的，而且每个手机，支持的预览尺寸并不是完全一致的，而视频的大小往往是需要做到一致的，不然录制出来的视频，在其他手机上播放，就需要做大量的UI适配工作，也没有平台的统一性。</p>\n<p>最初让我有这样的想法，是想做方形的视频，如最初Ins一样，那已经是7年前了，但是当时技术有限，并没有探索出最佳的方案，当时最多可以先录制再通过ffmpeg进行裁剪，这样效率太低了，用户是不能接受的，而且预览画面需要做遮罩，录制做不到所见即所得。</p>\n<p>经过其他工作的积累，在OpenGL与Surface搭配工作这方便，点了新的技能点。终于探索出最佳的技术方案。</p>\n<p>最终示例代码可以参考我的Github: <a href=\"https://github.com/boybeak/iCamera\">iCamera</a>。</p>\n<h2 id=\"一、技术背景\"><a href=\"#一、技术背景\" class=\"headerlink\" title=\"一、技术背景\"></a>一、技术背景</h2><p>在阅读接下来的内容前，你最好有以下技术储备：</p>\n<ol>\n<li>Camera1相关API的使用经验；</li>\n<li>对Android的surface有一定了解；</li>\n<li>对OpenGL最好有所了解；</li>\n</ol>\n<p>当然，如果没有以上相关的知识储备，也不妨碍定性的理解整体流程。</p>\n<h2 id=\"二、基本思路\"><a href=\"#二、基本思路\" class=\"headerlink\" title=\"二、基本思路\"></a>二、基本思路</h2><p>在一般的Camera应用开发时，通常需要有一个预览画面的控件，一般时SurfaceView或者TextureView，然后把Surface或者SurfaceTexture设置给Camera进行预览。</p>\n<p>而在我们的方案中，这个过程，要增加一些步骤。具体的步骤如下：</p>\n<ol>\n<li>从SurfaceView或者TextureView获得Surface对象，比如<code>holder.surface</code>或者<code>Surface(surfaceTexture)</code>；</li>\n<li>由此Surface对象，我们创建EGL环境，并重新创建一个<code>SurfaceTexture</code>对象，这个新的<code>SurfaceTexture</code>对象，最后需要设置给Camera进行预览；</li>\n<li>监听步骤2中创建的<code>SurfaceTexture</code>对象的帧数据，通过OpenGL对画面<strong>消除形变</strong>并进行渲染。</li>\n</ol>\n<p>以上就是基本思路，是不是还是一头雾水？没关系，下面进行具体实现的讲解。</p>\n<h2 id=\"三、具体实现\"><a href=\"#三、具体实现\" class=\"headerlink\" title=\"三、具体实现\"></a>三、具体实现</h2><p>在上述的步骤中，第1步很简单，这里不再进行赘述，直接从步骤2开始。</p>\n<h3 id=\"3-1-通过Surface创建EGL环境\"><a href=\"#3-1-通过Surface创建EGL环境\" class=\"headerlink\" title=\"3.1 通过Surface创建EGL环境\"></a>3.1 通过Surface创建EGL环境</h3><p>一般代码示例如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> display<span class=\"token operator\">:</span> EGLDisplay <span class=\"token keyword\">by</span> lazy <span class=\"token punctuation\">&#123;</span> EGL14<span class=\"token punctuation\">.</span><span class=\"token function\">eglGetDisplay</span><span class=\"token punctuation\">(</span>EGL14<span class=\"token punctuation\">.</span>EGL_DEFAULT_DISPLAY<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> eglSurface<span class=\"token operator\">:</span> EGLSurface<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">var</span> eglContext<span class=\"token operator\">:</span> EGLContext<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">set</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">createEGL</span><span class=\"token punctuation\">(</span>surface<span class=\"token operator\">:</span> Surface<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">val</span> version <span class=\"token operator\">=</span> <span class=\"token function\">IntArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n    EGL14<span class=\"token punctuation\">.</span><span class=\"token function\">eglInitialize</span><span class=\"token punctuation\">(</span>display<span class=\"token punctuation\">,</span> version<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> version<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">val</span> attributes <span class=\"token operator\">=</span> <span class=\"token function\">intArrayOf</span><span class=\"token punctuation\">(</span>\n        EGL14<span class=\"token punctuation\">.</span>EGL_RED_SIZE<span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n        EGL14<span class=\"token punctuation\">.</span>EGL_GREEN_SIZE<span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n        EGL14<span class=\"token punctuation\">.</span>EGL_BLUE_SIZE<span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n        EGL14<span class=\"token punctuation\">.</span>EGL_ALPHA_SIZE<span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n        EGL14<span class=\"token punctuation\">.</span>EGL_RENDERABLE_TYPE<span class=\"token punctuation\">,</span> EGL14<span class=\"token punctuation\">.</span>EGL_OPENGL_ES2_BIT<span class=\"token punctuation\">,</span>\n        EGL14<span class=\"token punctuation\">.</span>EGL_NONE<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>      <span class=\"token comment\">// placeholder for recordable [@-3]</span>\n        EGL14<span class=\"token punctuation\">.</span>EGL_NONE\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">val</span> configs <span class=\"token operator\">=</span> arrayOfNulls<span class=\"token operator\">&lt;</span>EGLConfig<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> numConfigs <span class=\"token operator\">=</span> <span class=\"token function\">IntArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    EGL14<span class=\"token punctuation\">.</span><span class=\"token function\">eglChooseConfig</span><span class=\"token punctuation\">(</span>display<span class=\"token punctuation\">,</span> attributes<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> configs<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        configs<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span> numConfigs<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">val</span> config <span class=\"token operator\">=</span> configs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n\n    eglSurface <span class=\"token operator\">=</span> EGL14<span class=\"token punctuation\">.</span><span class=\"token function\">eglCreateWindowSurface</span><span class=\"token punctuation\">(</span>\n        display<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> surface<span class=\"token punctuation\">,</span> <span class=\"token function\">intArrayOf</span><span class=\"token punctuation\">(</span>\n            EGL14<span class=\"token punctuation\">.</span>EGL_NONE\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span>\n    <span class=\"token punctuation\">)</span>\n\n    eglContext <span class=\"token operator\">=</span> EGL14<span class=\"token punctuation\">.</span><span class=\"token function\">eglCreateContext</span><span class=\"token punctuation\">(</span>\n        display<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> sharedContext <span class=\"token operator\">?:</span> EGL14<span class=\"token punctuation\">.</span>EGL_NO_CONTEXT<span class=\"token punctuation\">,</span> <span class=\"token function\">intArrayOf</span><span class=\"token punctuation\">(</span>\n            EGL14<span class=\"token punctuation\">.</span>EGL_CONTEXT_CLIENT_VERSION<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> EGL14<span class=\"token punctuation\">.</span>EGL_NONE\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span>\n    <span class=\"token punctuation\">)</span>\n    EGL14<span class=\"token punctuation\">.</span><span class=\"token function\">eglMakeCurrent</span><span class=\"token punctuation\">(</span>display<span class=\"token punctuation\">,</span> eglSurface<span class=\"token punctuation\">,</span> eglSurface<span class=\"token punctuation\">,</span> eglContext<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>这里需要注意的是，这个方法调用需要在一个独立的线程中，最后一句代码是与当前线程绑定，相关的OpenGL的操作，只能在对应的线程中进行。<br>有了这个OpenGL环境以后，就可以创建对应的<code>SurfaceTexture</code>了，简单的代码如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> textureIds <span class=\"token operator\">=</span> <span class=\"token function\">IntArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\nGLES20<span class=\"token punctuation\">.</span><span class=\"token function\">glGenTextures</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> textureIds<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> texture <span class=\"token operator\">=</span> <span class=\"token function\">SurfaceTexture</span><span class=\"token punctuation\">(</span>textureIds<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre>\n<p>同样的，这里的代码也要运行在之前的创建EGL环境相同的线程之下，之后便可以将这里创建的<code>texture</code>设置给camera对象用于预览。</p>\n<h3 id=\"3-2-监听预览-消除形变-绘制画面\"><a href=\"#3-2-监听预览-消除形变-绘制画面\" class=\"headerlink\" title=\"3.2 监听预览-消除形变-绘制画面\"></a>3.2 监听预览-消除形变-绘制画面</h3><p>给上一步中创建的<code>texture</code>设置一个画面监听。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> matrix <span class=\"token operator\">=</span> <span class=\"token function\">FloatArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\ntexture<span class=\"token punctuation\">.</span><span class=\"token function\">setOnFrameAvailableListener</span> <span class=\"token punctuation\">&#123;</span>\n    queue <span class=\"token punctuation\">&#123;</span>\n        texture<span class=\"token punctuation\">.</span><span class=\"token function\">updateTexImage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        texture<span class=\"token punctuation\">.</span><span class=\"token function\">getTransformMatrix</span><span class=\"token punctuation\">(</span>matrix<span class=\"token punctuation\">)</span>\n\n        <span class=\"token function\">drawFrame</span><span class=\"token punctuation\">(</span>textureIds<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> matrix<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">fun</span> <span class=\"token function\">drawFrame</span><span class=\"token punctuation\">(</span>textureId<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> matrix<span class=\"token operator\">:</span> FloatArray<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// ....</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>简单解释一下这里代码：</p>\n<ol>\n<li>先创建一个浮点数组，用于接收预览画面的坐标数据，用于OpenGL绘制画面使用；</li>\n<li>然后设置画面监听，这里在相机开启预览后会触发一次；</li>\n<li>在画面监听回调中，切换到EGL线程中，调用<code>updateTexImage</code>，只有这样，画面监听回调才会持续的被执行；</li>\n<li>最后调用<code>getTransformMatrix</code>获取画面坐标数据，为之后的画面绘制做准备。</li>\n</ol>\n<p>接下来，便是执行画面的绘制，在画面绘制关键的一步就是消除形变，这里需要先获得camera对象的预览尺寸，从支持的预览尺寸中，挑选最佳匹配尺寸以及消除方形问题的相关代码，这里不再赘述，只提供消除形变的关键代码。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> inputSize<span class=\"token operator\">:</span> Size <span class=\"token comment\">// 相机输出的预览画面尺寸，因为要作为绘制的输入，所以称为inputSize，注意消除屏幕方向旋转的问题</span>\n<span class=\"token keyword\">val</span> outputSize<span class=\"token operator\">:</span> Size <span class=\"token comment\">// 输出画面的尺寸</span>\n<span class=\"token keyword\">val</span> viewport<span class=\"token operator\">:</span> Rect <span class=\"token comment\">// 计算出预览画面要消除形变，需要做的位置与尺寸变更</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">calculateBestViewPort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>inputSize<span class=\"token punctuation\">.</span>isEmpty <span class=\"token operator\">||</span> outputSize<span class=\"token punctuation\">.</span>isEmpty<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">val</span> scale <span class=\"token operator\">=</span> <span class=\"token function\">max</span><span class=\"token punctuation\">(</span>outputSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">.</span><span class=\"token function\">toFloat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> inputSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> outputSize<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">.</span><span class=\"token function\">toFloat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> inputSize<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> srcWidth <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>inputSize<span class=\"token punctuation\">.</span>width <span class=\"token operator\">*</span> scale<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> srcHeight <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>inputSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">*</span> scale<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">val</span> left <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>outputSize<span class=\"token punctuation\">.</span>width <span class=\"token operator\">-</span> srcWidth<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span>\n    <span class=\"token keyword\">val</span> top <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>outputSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">-</span> srcHeight<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span>\n    viewport<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>left<span class=\"token punctuation\">,</span> top<span class=\"token punctuation\">,</span> left <span class=\"token operator\">+</span> srcWidth<span class=\"token punctuation\">,</span> top <span class=\"token operator\">+</span> srcHeight<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>在绘制画面前，执行OpenGL的<code>glViewport</code>方法，就可以消除形变了。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">drawFrame</span><span class=\"token punctuation\">(</span>textureId<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> texMatrix<span class=\"token operator\">:</span> FloatArray<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>viewport<span class=\"token punctuation\">.</span>isEmpty<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        GLES20<span class=\"token punctuation\">.</span><span class=\"token function\">glViewport</span><span class=\"token punctuation\">(</span>viewport<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">,</span> viewport<span class=\"token punctuation\">.</span>top<span class=\"token punctuation\">,</span> viewport<span class=\"token punctuation\">.</span><span class=\"token function\">width</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> viewport<span class=\"token punctuation\">.</span><span class=\"token function\">height</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 绘制画面代码有大量的OpenGL操作，具体不再赘述</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<h2 id=\"四、总结\"><a href=\"#四、总结\" class=\"headerlink\" title=\"四、总结\"></a>四、总结</h2><p>到这里，主要的消除形变预览相机画面的主要逻辑流程，就基本结束了，重点是梳理思路，在具体的实践中，还是有很多细碎的问题的，就比如相机预览尺寸的选取与方向设置问题。</p>\n<p>另外，为这里只是为了说明逻辑，临时写了代码逻辑部分，实际项目中，我直接使用了<a href=\"https://github.com/google/grafika\">Grafika</a>项目中的egl包下代码，这个项目给了我很多灵感，真心推荐给各位看一下这个项目中的代码。</p>\n<p>也许同样做过消除形变的朋友，会认为为什么不直接使用<code>TextureView</code>，然后通过<code>setTransform</code>的方式消除形变呢？</p>\n<p>实际上，如果只是为了消除预览的形变，这样做是没有问题的，也是非常便捷的，但是做相机应用的开发，难免会有拍照、录像、帧数据回调(主要是扫码)相关的功能性逻辑，在这类逻辑中，通过这种方式，就无法做到<strong>可见即所得</strong>式的效果了，就比如拍照，你必须在拍照后，对图片做一次按照预览框尺寸<code>crop</code>的操作了，如果只是拍照还比较简单，如果是录像的话，没有录像期间切换摄像头的需求，使用<code>MediaRecorder</code>或许可以，我没有试过，但是有这样的需求，<code>MediaRecorder</code>就无法满足需求了，面对这样的需求，我之前是通过获取帧数据，然后用libYuv缩放、剪裁反转旋转帧数据等操作，最后喂给<code>MediaCodec</code>的方式，我当前的这个方案，是可以通过共享OpenGL上下文的方式，实现<strong>所见即所得</strong>的录像，不需要繁琐的操作帧数据了，减少了额外库的引入。</p>\n<p>对于上述录像相关的逻辑，我将用新的文章来阐述。</p>\n"},{"title":"相机录像新姿势-OpenGL共享上下文+MediaCodec","date":"2023-11-20T14:43:00.000Z","_content":"\n## 一、前言\n承接上一文章[Camera无变形任意尺寸预览](https://boybeak.github.io/2023/11/12/2023-11-12-Camera%E6%97%A0%E5%8F%98%E5%BD%A2%E4%BB%BB%E6%84%8F%E5%B0%BA%E5%AF%B8%E9%A2%84%E8%A7%88/)，我们已经实现了无形变的任意尺寸的相机画面预览。接下来要完成相机的相关录像、拍照、扫码等功能，最重要也是最难的就是录像部分。\n\n最终示例代码可以参考我的Github: [iCamera](https://github.com/boybeak/iCamera)。\n\n## 二、技术要求\n我们要实现的录像功能技术要求如下：\n1. 所见即所得，预览画面什么样，最终结果就是什么样，不能经过二次裁剪与变换；\n2. 允许过程中，切换摄像头而不中断录制；\n3. 效率尽可能高，不许按下停止键后，有长时间的等待最终结果的过程；\n4. 不要引入额外的库；\n\n## 三、基本思路\n在讲解基本思路以前，我们先看一下共享OpenGL上下文，能够达到怎样的效果。\n[share_preview](https://github.com/boybeak/iCamera/assets/6696502/94bec530-4e54-4c41-9ce2-638b163fff60)\n查看视频，最上方是相机的预览画面，下方左侧为通过共享OpenGL上下文获得的共享画面，也就是说，我们可以把相机画面，共享给另外一个Surface，既然有了这个思路，那么通过共享画面进行录像，也就可以了。\n那么基本思路如下：\n1. 实现相机的OpenGL预览，保留相关上下文实例；\n2. 创建并配置MediaCodec，通过createInputSurface，创建共享画面；\n3. 以预览的OpenGL上下文与MediaCodec的surface，创建另外一个共享的OpenGL环境；\n4. MediaCodec开始编码录制；\n\n## 四、具体实现\n### 4.1 实现OpenGL画面预览\n这里我们通过已经封装好的PreviewSurface实现。\n```kotlin\nfun open(id: Int, surfaceView: SurfaceView) {\n    if (id == cameraId) {\n        return\n    }\n    if (camera != null) {\n        close()\n    }\n\n    previewSurface = PreviewSurface(surfaceView.holder.surface)\n    previewSurfaceView = surfaceView\n    previewSurface?.start { surfaceTexture ->\n        previewSurfaceTexture = surfaceTexture\n\n        val previewSize = openCameraOnly(id, surfaceTexture)\n        when(display.rotation) {\n            Surface.ROTATION_0, Surface.ROTATION_180 -> previewSurface?.setInputSize(previewSize.height, previewSize.width)\n            Surface.ROTATION_90, Surface.ROTATION_270 -> previewSurface?.setInputSize(previewSize.width, previewSize.height)\n        }\n    }\n}\n```\n`previewSurface`可以提供`SurfaceTexture`进行预览，同时也保存了OpenGL上下文。\n\n### 4.2 MediaCodec创建Surface\n我们的视频编码是通过`MediaCodec`实现的，之所以不直接用`MediaRecorder`实现，是因为`MediaRecorder`不支持录制期间翻转摄像头。\n\n一个简单的MediaCodec实现如下：\n```kotlin\nvideoCodec = MediaCodec.createEncoderByType(MIME_TYPE)\nval codecInfo = videoCodec!!.codecInfo\nval capabilities = codecInfo.getCapabilitiesForType(MIME_TYPE)\nval mediaFormat = onConfig.onConfig(capabilities.videoCapabilities).toMediaFormat(\n    MIME_TYPE\n)\nvideoCodec?.configure(mediaFormat, null, null, MediaCodec.CONFIGURE_FLAG_ENCODE)\n\nval inputSurface = videoCodec?.createInputSurface()!!\n```\n这样，我们就获得了一个用于共享的surface。\n\n### 4.3 创建共享OpenGL环境\n以前两步中获得到OpenGL上下文与共享surface，创建一个新的共享OpenGL环境，这里我们已经封装成了`SharedSurface`，只要直接调用其attach方法即可直接共享预览Surface的画面。\n```kotlin\nprivate val avEncoder = AVEncoder()\nprivate var recordSurface: SharedSurface? = null\nprivate val timeSynchronizer = object : TimeSynchronizer {\n\n    private var startAt = 0L\n\n    override fun reset() {\n        startAt = System.currentTimeMillis() * 1000\n    }\n\n    override fun getTimestamp(): Long {\n        return System.currentTimeMillis() * 1000 - startAt\n    }\n}\n\nfun startRecord(output: File) {\n    if (isRecording()) {\n        return\n    }\n    avEncoder.prepare(SimpleAudioConfigAdapter(), SimpleVideoConfigAdapter(Size(previewSurfaceView!!.width, previewSurfaceView!!.height)), timeSynchronizer) {\n        avEncoder.start(output) { inputSurface ->\n            recordSurface = SharedSurface(inputSurface)\n            recordSurface?.attach(previewSurface!!)\n        }\n    }\n}\n```\n上述代码中，`AVEncoder`为一个同时录制画面与声音的逻辑集合类，当开始录像时，会提供一个inputSurface对象，利用此对象，创建SharedSurface，就可以直接利用预览画面的共享纹理进行绘制，这些会绘制到共享surface上，MediaCodec会直接对画面进行编码。\n\n当然，这里会有很多MediaCodec相关的问题，这里的兼容性也是非常头疼的，需要处理高通/海思/联发科处理器的编码器的大量兼容性问题，但是这不是本文的重点。\n\n### 4.4 编码录制\n这部分请直接参考代码吧\n\n## 五、思路发散\n我们从录制上，可以看出，实际上连接预览与录制的，就是一个surface，只要有了surface，那我们就可以做很多操作了。比如拍照和扫码。\n\n当然，我们可以通过直接调用相机实例的接口进行拍照，只不过需要拍照后再做裁剪等操作，这里耗时不高。\n\n说一下拍照的逻辑，就是利用`ImageReader`，这种方式，就与Camera2的api差异不大了，简单代码实现如下：\n```kotlin\nprivate var photoSurface: SharedSurface? = null\nprivate val photoHandler = ...\nfun takePhoto(callback: (Bitmap) -> Unit) {\n    val imageReader = ImageReader.newInstance(previewSurfaceView!!.width, previewSurfaceView!!.height, PixelFormat.RGBA_8888, 1)\n    photoSurface = SharedSurface(imageReader.surface)\n    imageReader.setOnImageAvailableListener({\n        val image = imageReader.acquireNextImage()\n        // convert image to bitmap\n        callback.invoke(bitmap)\n    }, photoHandler)\n    photoSurface?.attach(previewSurface!!)\n}\n```\n同样的，扫码功能也类似，不过这里要借助zxing这个二维码解析库，同时做一个RGBA的转换，因为当前方案下，ImageReader只允许PixelFormat.RGBA_8888的颜色编码，好处就是，可以比较容易实现扫码预览大小的自定义，并且在预览范围内的都可以扫到，不会出现以前那种预览区域与扫码感知区域不一致的问题。\n\n既然有Surface就可以连接预览画面，那实际上就可以做到边录像，边扫码，边拍照了，只要你的手机性能足够，更多的使用方式，你可以自由去发散。\n\n## 总结\n具体的代码可以参考我的[iCamera](https://github.com/boybeak/iCamera)，但是我的代码只是做简单的逻辑演示，并不能保证在所有机型上的兼容性，了解了基本思路后，你可以在此基础上做兼容性处理。\n\n实际上我个人在生产环境的代码，做的兼容性处理要多得多。","source":"_posts/2023-11-20-相机录像新姿势-OpenGL共享上下文+MediaCodec.md","raw":"---\ntitle: 相机录像新姿势-OpenGL共享上下文+MediaCodec\ndate: 2023-11-20 22:43:00\ncategories: Android技巧\ntags:\n- Android\n- Camera\n---\n\n## 一、前言\n承接上一文章[Camera无变形任意尺寸预览](https://boybeak.github.io/2023/11/12/2023-11-12-Camera%E6%97%A0%E5%8F%98%E5%BD%A2%E4%BB%BB%E6%84%8F%E5%B0%BA%E5%AF%B8%E9%A2%84%E8%A7%88/)，我们已经实现了无形变的任意尺寸的相机画面预览。接下来要完成相机的相关录像、拍照、扫码等功能，最重要也是最难的就是录像部分。\n\n最终示例代码可以参考我的Github: [iCamera](https://github.com/boybeak/iCamera)。\n\n## 二、技术要求\n我们要实现的录像功能技术要求如下：\n1. 所见即所得，预览画面什么样，最终结果就是什么样，不能经过二次裁剪与变换；\n2. 允许过程中，切换摄像头而不中断录制；\n3. 效率尽可能高，不许按下停止键后，有长时间的等待最终结果的过程；\n4. 不要引入额外的库；\n\n## 三、基本思路\n在讲解基本思路以前，我们先看一下共享OpenGL上下文，能够达到怎样的效果。\n[share_preview](https://github.com/boybeak/iCamera/assets/6696502/94bec530-4e54-4c41-9ce2-638b163fff60)\n查看视频，最上方是相机的预览画面，下方左侧为通过共享OpenGL上下文获得的共享画面，也就是说，我们可以把相机画面，共享给另外一个Surface，既然有了这个思路，那么通过共享画面进行录像，也就可以了。\n那么基本思路如下：\n1. 实现相机的OpenGL预览，保留相关上下文实例；\n2. 创建并配置MediaCodec，通过createInputSurface，创建共享画面；\n3. 以预览的OpenGL上下文与MediaCodec的surface，创建另外一个共享的OpenGL环境；\n4. MediaCodec开始编码录制；\n\n## 四、具体实现\n### 4.1 实现OpenGL画面预览\n这里我们通过已经封装好的PreviewSurface实现。\n```kotlin\nfun open(id: Int, surfaceView: SurfaceView) {\n    if (id == cameraId) {\n        return\n    }\n    if (camera != null) {\n        close()\n    }\n\n    previewSurface = PreviewSurface(surfaceView.holder.surface)\n    previewSurfaceView = surfaceView\n    previewSurface?.start { surfaceTexture ->\n        previewSurfaceTexture = surfaceTexture\n\n        val previewSize = openCameraOnly(id, surfaceTexture)\n        when(display.rotation) {\n            Surface.ROTATION_0, Surface.ROTATION_180 -> previewSurface?.setInputSize(previewSize.height, previewSize.width)\n            Surface.ROTATION_90, Surface.ROTATION_270 -> previewSurface?.setInputSize(previewSize.width, previewSize.height)\n        }\n    }\n}\n```\n`previewSurface`可以提供`SurfaceTexture`进行预览，同时也保存了OpenGL上下文。\n\n### 4.2 MediaCodec创建Surface\n我们的视频编码是通过`MediaCodec`实现的，之所以不直接用`MediaRecorder`实现，是因为`MediaRecorder`不支持录制期间翻转摄像头。\n\n一个简单的MediaCodec实现如下：\n```kotlin\nvideoCodec = MediaCodec.createEncoderByType(MIME_TYPE)\nval codecInfo = videoCodec!!.codecInfo\nval capabilities = codecInfo.getCapabilitiesForType(MIME_TYPE)\nval mediaFormat = onConfig.onConfig(capabilities.videoCapabilities).toMediaFormat(\n    MIME_TYPE\n)\nvideoCodec?.configure(mediaFormat, null, null, MediaCodec.CONFIGURE_FLAG_ENCODE)\n\nval inputSurface = videoCodec?.createInputSurface()!!\n```\n这样，我们就获得了一个用于共享的surface。\n\n### 4.3 创建共享OpenGL环境\n以前两步中获得到OpenGL上下文与共享surface，创建一个新的共享OpenGL环境，这里我们已经封装成了`SharedSurface`，只要直接调用其attach方法即可直接共享预览Surface的画面。\n```kotlin\nprivate val avEncoder = AVEncoder()\nprivate var recordSurface: SharedSurface? = null\nprivate val timeSynchronizer = object : TimeSynchronizer {\n\n    private var startAt = 0L\n\n    override fun reset() {\n        startAt = System.currentTimeMillis() * 1000\n    }\n\n    override fun getTimestamp(): Long {\n        return System.currentTimeMillis() * 1000 - startAt\n    }\n}\n\nfun startRecord(output: File) {\n    if (isRecording()) {\n        return\n    }\n    avEncoder.prepare(SimpleAudioConfigAdapter(), SimpleVideoConfigAdapter(Size(previewSurfaceView!!.width, previewSurfaceView!!.height)), timeSynchronizer) {\n        avEncoder.start(output) { inputSurface ->\n            recordSurface = SharedSurface(inputSurface)\n            recordSurface?.attach(previewSurface!!)\n        }\n    }\n}\n```\n上述代码中，`AVEncoder`为一个同时录制画面与声音的逻辑集合类，当开始录像时，会提供一个inputSurface对象，利用此对象，创建SharedSurface，就可以直接利用预览画面的共享纹理进行绘制，这些会绘制到共享surface上，MediaCodec会直接对画面进行编码。\n\n当然，这里会有很多MediaCodec相关的问题，这里的兼容性也是非常头疼的，需要处理高通/海思/联发科处理器的编码器的大量兼容性问题，但是这不是本文的重点。\n\n### 4.4 编码录制\n这部分请直接参考代码吧\n\n## 五、思路发散\n我们从录制上，可以看出，实际上连接预览与录制的，就是一个surface，只要有了surface，那我们就可以做很多操作了。比如拍照和扫码。\n\n当然，我们可以通过直接调用相机实例的接口进行拍照，只不过需要拍照后再做裁剪等操作，这里耗时不高。\n\n说一下拍照的逻辑，就是利用`ImageReader`，这种方式，就与Camera2的api差异不大了，简单代码实现如下：\n```kotlin\nprivate var photoSurface: SharedSurface? = null\nprivate val photoHandler = ...\nfun takePhoto(callback: (Bitmap) -> Unit) {\n    val imageReader = ImageReader.newInstance(previewSurfaceView!!.width, previewSurfaceView!!.height, PixelFormat.RGBA_8888, 1)\n    photoSurface = SharedSurface(imageReader.surface)\n    imageReader.setOnImageAvailableListener({\n        val image = imageReader.acquireNextImage()\n        // convert image to bitmap\n        callback.invoke(bitmap)\n    }, photoHandler)\n    photoSurface?.attach(previewSurface!!)\n}\n```\n同样的，扫码功能也类似，不过这里要借助zxing这个二维码解析库，同时做一个RGBA的转换，因为当前方案下，ImageReader只允许PixelFormat.RGBA_8888的颜色编码，好处就是，可以比较容易实现扫码预览大小的自定义，并且在预览范围内的都可以扫到，不会出现以前那种预览区域与扫码感知区域不一致的问题。\n\n既然有Surface就可以连接预览画面，那实际上就可以做到边录像，边扫码，边拍照了，只要你的手机性能足够，更多的使用方式，你可以自由去发散。\n\n## 总结\n具体的代码可以参考我的[iCamera](https://github.com/boybeak/iCamera)，但是我的代码只是做简单的逻辑演示，并不能保证在所有机型上的兼容性，了解了基本思路后，你可以在此基础上做兼容性处理。\n\n实际上我个人在生产环境的代码，做的兼容性处理要多得多。","slug":"2023-11-20-相机录像新姿势-OpenGL共享上下文+MediaCodec","published":1,"updated":"2024-09-25T02:53:02.304Z","comments":1,"layout":"post","photos":[],"_id":"cm1ltr0g4002gbji0e8q2hlkv","content":"<h2 id=\"一、前言\"><a href=\"#一、前言\" class=\"headerlink\" title=\"一、前言\"></a>一、前言</h2><p>承接上一文章<a href=\"https://boybeak.github.io/2023/11/12/2023-11-12-Camera%E6%97%A0%E5%8F%98%E5%BD%A2%E4%BB%BB%E6%84%8F%E5%B0%BA%E5%AF%B8%E9%A2%84%E8%A7%88/\">Camera无变形任意尺寸预览</a>，我们已经实现了无形变的任意尺寸的相机画面预览。接下来要完成相机的相关录像、拍照、扫码等功能，最重要也是最难的就是录像部分。</p>\n<p>最终示例代码可以参考我的Github: <a href=\"https://github.com/boybeak/iCamera\">iCamera</a>。</p>\n<h2 id=\"二、技术要求\"><a href=\"#二、技术要求\" class=\"headerlink\" title=\"二、技术要求\"></a>二、技术要求</h2><p>我们要实现的录像功能技术要求如下：</p>\n<ol>\n<li>所见即所得，预览画面什么样，最终结果就是什么样，不能经过二次裁剪与变换；</li>\n<li>允许过程中，切换摄像头而不中断录制；</li>\n<li>效率尽可能高，不许按下停止键后，有长时间的等待最终结果的过程；</li>\n<li>不要引入额外的库；</li>\n</ol>\n<h2 id=\"三、基本思路\"><a href=\"#三、基本思路\" class=\"headerlink\" title=\"三、基本思路\"></a>三、基本思路</h2><p>在讲解基本思路以前，我们先看一下共享OpenGL上下文，能够达到怎样的效果。<br><a href=\"https://github.com/boybeak/iCamera/assets/6696502/94bec530-4e54-4c41-9ce2-638b163fff60\">share_preview</a><br>查看视频，最上方是相机的预览画面，下方左侧为通过共享OpenGL上下文获得的共享画面，也就是说，我们可以把相机画面，共享给另外一个Surface，既然有了这个思路，那么通过共享画面进行录像，也就可以了。<br>那么基本思路如下：</p>\n<ol>\n<li>实现相机的OpenGL预览，保留相关上下文实例；</li>\n<li>创建并配置MediaCodec，通过createInputSurface，创建共享画面；</li>\n<li>以预览的OpenGL上下文与MediaCodec的surface，创建另外一个共享的OpenGL环境；</li>\n<li>MediaCodec开始编码录制；</li>\n</ol>\n<h2 id=\"四、具体实现\"><a href=\"#四、具体实现\" class=\"headerlink\" title=\"四、具体实现\"></a>四、具体实现</h2><h3 id=\"4-1-实现OpenGL画面预览\"><a href=\"#4-1-实现OpenGL画面预览\" class=\"headerlink\" title=\"4.1 实现OpenGL画面预览\"></a>4.1 实现OpenGL画面预览</h3><p>这里我们通过已经封装好的PreviewSurface实现。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> surfaceView<span class=\"token operator\">:</span> SurfaceView<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>id <span class=\"token operator\">==</span> cameraId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>camera <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    previewSurface <span class=\"token operator\">=</span> <span class=\"token function\">PreviewSurface</span><span class=\"token punctuation\">(</span>surfaceView<span class=\"token punctuation\">.</span>holder<span class=\"token punctuation\">.</span>surface<span class=\"token punctuation\">)</span>\n    previewSurfaceView <span class=\"token operator\">=</span> surfaceView\n    previewSurface<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span> <span class=\"token punctuation\">&#123;</span> surfaceTexture <span class=\"token operator\">-></span>\n        previewSurfaceTexture <span class=\"token operator\">=</span> surfaceTexture\n\n        <span class=\"token keyword\">val</span> previewSize <span class=\"token operator\">=</span> <span class=\"token function\">openCameraOnly</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> surfaceTexture<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">when</span><span class=\"token punctuation\">(</span>display<span class=\"token punctuation\">.</span>rotation<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            Surface<span class=\"token punctuation\">.</span>ROTATION_0<span class=\"token punctuation\">,</span> Surface<span class=\"token punctuation\">.</span>ROTATION_180 <span class=\"token operator\">-></span> previewSurface<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">setInputSize</span><span class=\"token punctuation\">(</span>previewSize<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">,</span> previewSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span>\n            Surface<span class=\"token punctuation\">.</span>ROTATION_90<span class=\"token punctuation\">,</span> Surface<span class=\"token punctuation\">.</span>ROTATION_270 <span class=\"token operator\">-></span> previewSurface<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">setInputSize</span><span class=\"token punctuation\">(</span>previewSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> previewSize<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p><code>previewSurface</code>可以提供<code>SurfaceTexture</code>进行预览，同时也保存了OpenGL上下文。</p>\n<h3 id=\"4-2-MediaCodec创建Surface\"><a href=\"#4-2-MediaCodec创建Surface\" class=\"headerlink\" title=\"4.2 MediaCodec创建Surface\"></a>4.2 MediaCodec创建Surface</h3><p>我们的视频编码是通过<code>MediaCodec</code>实现的，之所以不直接用<code>MediaRecorder</code>实现，是因为<code>MediaRecorder</code>不支持录制期间翻转摄像头。</p>\n<p>一个简单的MediaCodec实现如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\">videoCodec <span class=\"token operator\">=</span> MediaCodec<span class=\"token punctuation\">.</span><span class=\"token function\">createEncoderByType</span><span class=\"token punctuation\">(</span>MIME_TYPE<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> codecInfo <span class=\"token operator\">=</span> videoCodec<span class=\"token operator\">!!</span><span class=\"token punctuation\">.</span>codecInfo\n<span class=\"token keyword\">val</span> capabilities <span class=\"token operator\">=</span> codecInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getCapabilitiesForType</span><span class=\"token punctuation\">(</span>MIME_TYPE<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> mediaFormat <span class=\"token operator\">=</span> onConfig<span class=\"token punctuation\">.</span><span class=\"token function\">onConfig</span><span class=\"token punctuation\">(</span>capabilities<span class=\"token punctuation\">.</span>videoCapabilities<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toMediaFormat</span><span class=\"token punctuation\">(</span>\n    MIME_TYPE\n<span class=\"token punctuation\">)</span>\nvideoCodec<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>mediaFormat<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> MediaCodec<span class=\"token punctuation\">.</span>CONFIGURE_FLAG_ENCODE<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">val</span> inputSurface <span class=\"token operator\">=</span> videoCodec<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">createInputSurface</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!!</span></code></pre>\n<p>这样，我们就获得了一个用于共享的surface。</p>\n<h3 id=\"4-3-创建共享OpenGL环境\"><a href=\"#4-3-创建共享OpenGL环境\" class=\"headerlink\" title=\"4.3 创建共享OpenGL环境\"></a>4.3 创建共享OpenGL环境</h3><p>以前两步中获得到OpenGL上下文与共享surface，创建一个新的共享OpenGL环境，这里我们已经封装成了<code>SharedSurface</code>，只要直接调用其attach方法即可直接共享预览Surface的画面。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> avEncoder <span class=\"token operator\">=</span> <span class=\"token function\">AVEncoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> recordSurface<span class=\"token operator\">:</span> SharedSurface<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> timeSynchronizer <span class=\"token operator\">=</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> TimeSynchronizer <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> startAt <span class=\"token operator\">=</span> <span class=\"token number\">0L</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">reset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        startAt <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">getTimestamp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Long <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span> <span class=\"token operator\">-</span> startAt\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">fun</span> <span class=\"token function\">startRecord</span><span class=\"token punctuation\">(</span>output<span class=\"token operator\">:</span> File<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isRecording</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">&#125;</span>\n    avEncoder<span class=\"token punctuation\">.</span><span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token function\">SimpleAudioConfigAdapter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">SimpleVideoConfigAdapter</span><span class=\"token punctuation\">(</span><span class=\"token function\">Size</span><span class=\"token punctuation\">(</span>previewSurfaceView<span class=\"token operator\">!!</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> previewSurfaceView<span class=\"token operator\">!!</span><span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> timeSynchronizer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        avEncoder<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> inputSurface <span class=\"token operator\">-></span>\n            recordSurface <span class=\"token operator\">=</span> <span class=\"token function\">SharedSurface</span><span class=\"token punctuation\">(</span>inputSurface<span class=\"token punctuation\">)</span>\n            recordSurface<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>previewSurface<span class=\"token operator\">!!</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>上述代码中，<code>AVEncoder</code>为一个同时录制画面与声音的逻辑集合类，当开始录像时，会提供一个inputSurface对象，利用此对象，创建SharedSurface，就可以直接利用预览画面的共享纹理进行绘制，这些会绘制到共享surface上，MediaCodec会直接对画面进行编码。</p>\n<p>当然，这里会有很多MediaCodec相关的问题，这里的兼容性也是非常头疼的，需要处理高通&#x2F;海思&#x2F;联发科处理器的编码器的大量兼容性问题，但是这不是本文的重点。</p>\n<h3 id=\"4-4-编码录制\"><a href=\"#4-4-编码录制\" class=\"headerlink\" title=\"4.4 编码录制\"></a>4.4 编码录制</h3><p>这部分请直接参考代码吧</p>\n<h2 id=\"五、思路发散\"><a href=\"#五、思路发散\" class=\"headerlink\" title=\"五、思路发散\"></a>五、思路发散</h2><p>我们从录制上，可以看出，实际上连接预览与录制的，就是一个surface，只要有了surface，那我们就可以做很多操作了。比如拍照和扫码。</p>\n<p>当然，我们可以通过直接调用相机实例的接口进行拍照，只不过需要拍照后再做裁剪等操作，这里耗时不高。</p>\n<p>说一下拍照的逻辑，就是利用<code>ImageReader</code>，这种方式，就与Camera2的api差异不大了，简单代码实现如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> photoSurface<span class=\"token operator\">:</span> SharedSurface<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> photoHandler <span class=\"token operator\">=</span> <span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">takePhoto</span><span class=\"token punctuation\">(</span>callback<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>Bitmap<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> Unit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">val</span> imageReader <span class=\"token operator\">=</span> ImageReader<span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span>previewSurfaceView<span class=\"token operator\">!!</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> previewSurfaceView<span class=\"token operator\">!!</span><span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">,</span> PixelFormat<span class=\"token punctuation\">.</span>RGBA_8888<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    photoSurface <span class=\"token operator\">=</span> <span class=\"token function\">SharedSurface</span><span class=\"token punctuation\">(</span>imageReader<span class=\"token punctuation\">.</span>surface<span class=\"token punctuation\">)</span>\n    imageReader<span class=\"token punctuation\">.</span><span class=\"token function\">setOnImageAvailableListener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">val</span> image <span class=\"token operator\">=</span> imageReader<span class=\"token punctuation\">.</span><span class=\"token function\">acquireNextImage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// convert image to bitmap</span>\n        callback<span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> photoHandler<span class=\"token punctuation\">)</span>\n    photoSurface<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>previewSurface<span class=\"token operator\">!!</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>同样的，扫码功能也类似，不过这里要借助zxing这个二维码解析库，同时做一个RGBA的转换，因为当前方案下，ImageReader只允许PixelFormat.RGBA_8888的颜色编码，好处就是，可以比较容易实现扫码预览大小的自定义，并且在预览范围内的都可以扫到，不会出现以前那种预览区域与扫码感知区域不一致的问题。</p>\n<p>既然有Surface就可以连接预览画面，那实际上就可以做到边录像，边扫码，边拍照了，只要你的手机性能足够，更多的使用方式，你可以自由去发散。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>具体的代码可以参考我的<a href=\"https://github.com/boybeak/iCamera\">iCamera</a>，但是我的代码只是做简单的逻辑演示，并不能保证在所有机型上的兼容性，了解了基本思路后，你可以在此基础上做兼容性处理。</p>\n<p>实际上我个人在生产环境的代码，做的兼容性处理要多得多。</p>\n","excerpt":"","more":"<h2 id=\"一、前言\"><a href=\"#一、前言\" class=\"headerlink\" title=\"一、前言\"></a>一、前言</h2><p>承接上一文章<a href=\"https://boybeak.github.io/2023/11/12/2023-11-12-Camera%E6%97%A0%E5%8F%98%E5%BD%A2%E4%BB%BB%E6%84%8F%E5%B0%BA%E5%AF%B8%E9%A2%84%E8%A7%88/\">Camera无变形任意尺寸预览</a>，我们已经实现了无形变的任意尺寸的相机画面预览。接下来要完成相机的相关录像、拍照、扫码等功能，最重要也是最难的就是录像部分。</p>\n<p>最终示例代码可以参考我的Github: <a href=\"https://github.com/boybeak/iCamera\">iCamera</a>。</p>\n<h2 id=\"二、技术要求\"><a href=\"#二、技术要求\" class=\"headerlink\" title=\"二、技术要求\"></a>二、技术要求</h2><p>我们要实现的录像功能技术要求如下：</p>\n<ol>\n<li>所见即所得，预览画面什么样，最终结果就是什么样，不能经过二次裁剪与变换；</li>\n<li>允许过程中，切换摄像头而不中断录制；</li>\n<li>效率尽可能高，不许按下停止键后，有长时间的等待最终结果的过程；</li>\n<li>不要引入额外的库；</li>\n</ol>\n<h2 id=\"三、基本思路\"><a href=\"#三、基本思路\" class=\"headerlink\" title=\"三、基本思路\"></a>三、基本思路</h2><p>在讲解基本思路以前，我们先看一下共享OpenGL上下文，能够达到怎样的效果。<br><a href=\"https://github.com/boybeak/iCamera/assets/6696502/94bec530-4e54-4c41-9ce2-638b163fff60\">share_preview</a><br>查看视频，最上方是相机的预览画面，下方左侧为通过共享OpenGL上下文获得的共享画面，也就是说，我们可以把相机画面，共享给另外一个Surface，既然有了这个思路，那么通过共享画面进行录像，也就可以了。<br>那么基本思路如下：</p>\n<ol>\n<li>实现相机的OpenGL预览，保留相关上下文实例；</li>\n<li>创建并配置MediaCodec，通过createInputSurface，创建共享画面；</li>\n<li>以预览的OpenGL上下文与MediaCodec的surface，创建另外一个共享的OpenGL环境；</li>\n<li>MediaCodec开始编码录制；</li>\n</ol>\n<h2 id=\"四、具体实现\"><a href=\"#四、具体实现\" class=\"headerlink\" title=\"四、具体实现\"></a>四、具体实现</h2><h3 id=\"4-1-实现OpenGL画面预览\"><a href=\"#4-1-实现OpenGL画面预览\" class=\"headerlink\" title=\"4.1 实现OpenGL画面预览\"></a>4.1 实现OpenGL画面预览</h3><p>这里我们通过已经封装好的PreviewSurface实现。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> surfaceView<span class=\"token operator\">:</span> SurfaceView<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>id <span class=\"token operator\">==</span> cameraId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>camera <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    previewSurface <span class=\"token operator\">=</span> <span class=\"token function\">PreviewSurface</span><span class=\"token punctuation\">(</span>surfaceView<span class=\"token punctuation\">.</span>holder<span class=\"token punctuation\">.</span>surface<span class=\"token punctuation\">)</span>\n    previewSurfaceView <span class=\"token operator\">=</span> surfaceView\n    previewSurface<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span> <span class=\"token punctuation\">&#123;</span> surfaceTexture <span class=\"token operator\">-></span>\n        previewSurfaceTexture <span class=\"token operator\">=</span> surfaceTexture\n\n        <span class=\"token keyword\">val</span> previewSize <span class=\"token operator\">=</span> <span class=\"token function\">openCameraOnly</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> surfaceTexture<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">when</span><span class=\"token punctuation\">(</span>display<span class=\"token punctuation\">.</span>rotation<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            Surface<span class=\"token punctuation\">.</span>ROTATION_0<span class=\"token punctuation\">,</span> Surface<span class=\"token punctuation\">.</span>ROTATION_180 <span class=\"token operator\">-></span> previewSurface<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">setInputSize</span><span class=\"token punctuation\">(</span>previewSize<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">,</span> previewSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span>\n            Surface<span class=\"token punctuation\">.</span>ROTATION_90<span class=\"token punctuation\">,</span> Surface<span class=\"token punctuation\">.</span>ROTATION_270 <span class=\"token operator\">-></span> previewSurface<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">setInputSize</span><span class=\"token punctuation\">(</span>previewSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> previewSize<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p><code>previewSurface</code>可以提供<code>SurfaceTexture</code>进行预览，同时也保存了OpenGL上下文。</p>\n<h3 id=\"4-2-MediaCodec创建Surface\"><a href=\"#4-2-MediaCodec创建Surface\" class=\"headerlink\" title=\"4.2 MediaCodec创建Surface\"></a>4.2 MediaCodec创建Surface</h3><p>我们的视频编码是通过<code>MediaCodec</code>实现的，之所以不直接用<code>MediaRecorder</code>实现，是因为<code>MediaRecorder</code>不支持录制期间翻转摄像头。</p>\n<p>一个简单的MediaCodec实现如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\">videoCodec <span class=\"token operator\">=</span> MediaCodec<span class=\"token punctuation\">.</span><span class=\"token function\">createEncoderByType</span><span class=\"token punctuation\">(</span>MIME_TYPE<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> codecInfo <span class=\"token operator\">=</span> videoCodec<span class=\"token operator\">!!</span><span class=\"token punctuation\">.</span>codecInfo\n<span class=\"token keyword\">val</span> capabilities <span class=\"token operator\">=</span> codecInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getCapabilitiesForType</span><span class=\"token punctuation\">(</span>MIME_TYPE<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> mediaFormat <span class=\"token operator\">=</span> onConfig<span class=\"token punctuation\">.</span><span class=\"token function\">onConfig</span><span class=\"token punctuation\">(</span>capabilities<span class=\"token punctuation\">.</span>videoCapabilities<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toMediaFormat</span><span class=\"token punctuation\">(</span>\n    MIME_TYPE\n<span class=\"token punctuation\">)</span>\nvideoCodec<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>mediaFormat<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> MediaCodec<span class=\"token punctuation\">.</span>CONFIGURE_FLAG_ENCODE<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">val</span> inputSurface <span class=\"token operator\">=</span> videoCodec<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">createInputSurface</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!!</span></code></pre>\n<p>这样，我们就获得了一个用于共享的surface。</p>\n<h3 id=\"4-3-创建共享OpenGL环境\"><a href=\"#4-3-创建共享OpenGL环境\" class=\"headerlink\" title=\"4.3 创建共享OpenGL环境\"></a>4.3 创建共享OpenGL环境</h3><p>以前两步中获得到OpenGL上下文与共享surface，创建一个新的共享OpenGL环境，这里我们已经封装成了<code>SharedSurface</code>，只要直接调用其attach方法即可直接共享预览Surface的画面。</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> avEncoder <span class=\"token operator\">=</span> <span class=\"token function\">AVEncoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> recordSurface<span class=\"token operator\">:</span> SharedSurface<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> timeSynchronizer <span class=\"token operator\">=</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> TimeSynchronizer <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> startAt <span class=\"token operator\">=</span> <span class=\"token number\">0L</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">reset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        startAt <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">getTimestamp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Long <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span> <span class=\"token operator\">-</span> startAt\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">fun</span> <span class=\"token function\">startRecord</span><span class=\"token punctuation\">(</span>output<span class=\"token operator\">:</span> File<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isRecording</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">&#125;</span>\n    avEncoder<span class=\"token punctuation\">.</span><span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token function\">SimpleAudioConfigAdapter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">SimpleVideoConfigAdapter</span><span class=\"token punctuation\">(</span><span class=\"token function\">Size</span><span class=\"token punctuation\">(</span>previewSurfaceView<span class=\"token operator\">!!</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> previewSurfaceView<span class=\"token operator\">!!</span><span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> timeSynchronizer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        avEncoder<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> inputSurface <span class=\"token operator\">-></span>\n            recordSurface <span class=\"token operator\">=</span> <span class=\"token function\">SharedSurface</span><span class=\"token punctuation\">(</span>inputSurface<span class=\"token punctuation\">)</span>\n            recordSurface<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>previewSurface<span class=\"token operator\">!!</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>上述代码中，<code>AVEncoder</code>为一个同时录制画面与声音的逻辑集合类，当开始录像时，会提供一个inputSurface对象，利用此对象，创建SharedSurface，就可以直接利用预览画面的共享纹理进行绘制，这些会绘制到共享surface上，MediaCodec会直接对画面进行编码。</p>\n<p>当然，这里会有很多MediaCodec相关的问题，这里的兼容性也是非常头疼的，需要处理高通&#x2F;海思&#x2F;联发科处理器的编码器的大量兼容性问题，但是这不是本文的重点。</p>\n<h3 id=\"4-4-编码录制\"><a href=\"#4-4-编码录制\" class=\"headerlink\" title=\"4.4 编码录制\"></a>4.4 编码录制</h3><p>这部分请直接参考代码吧</p>\n<h2 id=\"五、思路发散\"><a href=\"#五、思路发散\" class=\"headerlink\" title=\"五、思路发散\"></a>五、思路发散</h2><p>我们从录制上，可以看出，实际上连接预览与录制的，就是一个surface，只要有了surface，那我们就可以做很多操作了。比如拍照和扫码。</p>\n<p>当然，我们可以通过直接调用相机实例的接口进行拍照，只不过需要拍照后再做裁剪等操作，这里耗时不高。</p>\n<p>说一下拍照的逻辑，就是利用<code>ImageReader</code>，这种方式，就与Camera2的api差异不大了，简单代码实现如下：</p>\n<pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> photoSurface<span class=\"token operator\">:</span> SharedSurface<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> photoHandler <span class=\"token operator\">=</span> <span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">takePhoto</span><span class=\"token punctuation\">(</span>callback<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>Bitmap<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> Unit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">val</span> imageReader <span class=\"token operator\">=</span> ImageReader<span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span>previewSurfaceView<span class=\"token operator\">!!</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> previewSurfaceView<span class=\"token operator\">!!</span><span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">,</span> PixelFormat<span class=\"token punctuation\">.</span>RGBA_8888<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    photoSurface <span class=\"token operator\">=</span> <span class=\"token function\">SharedSurface</span><span class=\"token punctuation\">(</span>imageReader<span class=\"token punctuation\">.</span>surface<span class=\"token punctuation\">)</span>\n    imageReader<span class=\"token punctuation\">.</span><span class=\"token function\">setOnImageAvailableListener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">val</span> image <span class=\"token operator\">=</span> imageReader<span class=\"token punctuation\">.</span><span class=\"token function\">acquireNextImage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// convert image to bitmap</span>\n        callback<span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> photoHandler<span class=\"token punctuation\">)</span>\n    photoSurface<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>previewSurface<span class=\"token operator\">!!</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>同样的，扫码功能也类似，不过这里要借助zxing这个二维码解析库，同时做一个RGBA的转换，因为当前方案下，ImageReader只允许PixelFormat.RGBA_8888的颜色编码，好处就是，可以比较容易实现扫码预览大小的自定义，并且在预览范围内的都可以扫到，不会出现以前那种预览区域与扫码感知区域不一致的问题。</p>\n<p>既然有Surface就可以连接预览画面，那实际上就可以做到边录像，边扫码，边拍照了，只要你的手机性能足够，更多的使用方式，你可以自由去发散。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>具体的代码可以参考我的<a href=\"https://github.com/boybeak/iCamera\">iCamera</a>，但是我的代码只是做简单的逻辑演示，并不能保证在所有机型上的兼容性，了解了基本思路后，你可以在此基础上做兼容性处理。</p>\n<p>实际上我个人在生产环境的代码，做的兼容性处理要多得多。</p>\n"},{"title":"macOS项目中引入c静态库","date":"2024-04-26T14:43:00.000Z","_content":"\n最近在写一款多平台的文件传输工具，Android平台已经写的差不多了，现在正在写macOS端，为了多端共享同一套底层协议代码，通讯协议部分，使用了c语言开发，对于Android通过jni调用c的相关代码，我已经驾轻就熟了，但是在macOS项目里，添加静态库并成功调试，我还是有一些懵逼。好在通过ChatGPT的各种帮助，还是跌跌撞撞的调通了。为了防止遗忘，记录一下过程。\n\n相关的c/swift代码，均以示例项目作为演示，目的是说明过程。\n\n## 一、C语言库\n\nc库的相关代码结构如下：\n```css\ndemo\n├── bc\n│   ├── bc.h\n│   ├── bc.c\n│   └── build/libbc.a\n│   └── CMakeLists.txt\n├── main.c\n│── CMakeLists.txt\n\n```\n根目录的main.c与CMakeLists.txt不重要，重要的是bc文件夹下。\nbc.h为头文件，bc.c为代码文件，其内容比较简单，定义了一个名为getNumber的函数，函数返回值为42，build为编译生成文件夹，主要是为了生成libbc.a，bc目录下的CMakeLists.txt内容如下：\n```txt\ncmake_minimum_required(VERSION 3.5)\nproject(bc VERSION 0.0.1)\n\n# 添加库\nadd_library(\n    bc STATIC \n    bc.c bc.h\n)\n\n# 将库的目录添加到include路径\ntarget_include_directories(bc PUBLIC ${CMAKE_CURRENT_SOURCE_DIR})\n```\n这里主要关注`add_library`这个指令中的，`STATIC`关键字，有这个关键字，在编译时，才会被编译成静态库。\n在bc目录下，执行相关的指令，生成静态库文件。\n```bash\nmkdir build\ncd build\ncmake ..\nmake\n```\n执行完相关指令以后，在build目录下，会多一个libbc.a文件。\n\n## 二、macOS swiftUI项目\nmacOS的演示项目名称为TestA，其基本目录结构如下：\n```css\nTestA\n├── TestA\n│   ├── main.swift\n│   ├── TestA-Bridging-Header.h\n│   └── ...\n├── TestA.xcodeproj\n|── include/bc.h\n└── libbc.a\n```\nTestA为项目根目录，其内部的TestA为同名Target目录。在根目录下，你可以看到一个libbc.a文件，实际上这个文件本身并不存在于该路径下，而是在上一段中提到的build目录下，当然，你也可以把文件本身拷贝到该目录下。\n\n### 2.1 添加libbc.a\n在根目录上，右键->Add Files to \"TestA\"，然后选择libbc.a，这样libbc.a就会显示在根目录下了。\n左键点击项目根目录，弹出配置选项卡，点击**Build Settings**选项卡，在Filter中，输入\"Other Linker Flags\"，找到该配置项，然后增加配置值`-lbc`（这里的“bc”应该是你的库文件名去掉前缀“lib”和后缀“.a”，因为我的库名称叫bc，生成的文件上libbc.a，所以值为-lbc，如果你的库名称为xyz，则应该配置为-lxyz），这里需要注意，该配置项下有Debug和Release两个，都要配置，下同。\n\n### 2.2 引入头文件\n在根目录下，创建include目录，将头文件bc.h拷贝进来。然后在刚才的**Build Settings**选项卡中，搜索\"Header Search Paths\"，并设置值为`$(SRCROOT)/include`，注意，如果include下有子目录，同样需要添加到该配置中。添加了该配置后，在接下来的TestA-Bridging-Header.h中，才能引入相关头文件。\n\n### 2.3 TestA-Bridging-Header.h\n注意，是TestA-Bridging-Header.h，不是TestA-Bridge-Header.h。因为是桥接文件，所以好几次，我都想当然的认为是`Bridge`了，导致很多次配置都失败了。\n文件内容如下：\n```h\n#ifndef TestA_Bridging_Header_h\n#define TestA_Bridging_Header_h\n\n#include \"bc.h\"\n\n#endif\n```\n在此文件中，可以使用bc.h文件了。\n\n此时，在Swfit代码中还不能使用TestA-Bridge-Header.h中引入头文件的相关函数，需要设置Objective-C Bridging Header，同样在**Build Settings**中搜索\"Objective-C Bridging Header\"，设置值为`TestA/TestA-Bridging-Header.h`。\n\n## 三、运行\n在Swift代码的UI配置文件中，使用c语言中的`getNumber`方法。\n```swift\nimport SwiftUI\n\nstruct ContentView: View {\n    var body: some View {\n        VStack {\n            Image(systemName: \"globe\")\n                .imageScale(.large)\n                .foregroundStyle(.tint)\n            Text(\"Hello, world!\\(getNumber())\")\n        }\n        .padding()\n    }\n}\n```\n将该数字显示在Text中，效果如下：\n![getNumber](../images/getNumber.png)","source":"_posts/2024-04-26-MacOS项目中引入c静态库.md","raw":"---\ntitle: macOS项目中引入c静态库\ndate: 2024-04-26 22:43:00\ncategories: 独立开发笔记\ntags:\n- macOS\n- 静态库\n---\n\n最近在写一款多平台的文件传输工具，Android平台已经写的差不多了，现在正在写macOS端，为了多端共享同一套底层协议代码，通讯协议部分，使用了c语言开发，对于Android通过jni调用c的相关代码，我已经驾轻就熟了，但是在macOS项目里，添加静态库并成功调试，我还是有一些懵逼。好在通过ChatGPT的各种帮助，还是跌跌撞撞的调通了。为了防止遗忘，记录一下过程。\n\n相关的c/swift代码，均以示例项目作为演示，目的是说明过程。\n\n## 一、C语言库\n\nc库的相关代码结构如下：\n```css\ndemo\n├── bc\n│   ├── bc.h\n│   ├── bc.c\n│   └── build/libbc.a\n│   └── CMakeLists.txt\n├── main.c\n│── CMakeLists.txt\n\n```\n根目录的main.c与CMakeLists.txt不重要，重要的是bc文件夹下。\nbc.h为头文件，bc.c为代码文件，其内容比较简单，定义了一个名为getNumber的函数，函数返回值为42，build为编译生成文件夹，主要是为了生成libbc.a，bc目录下的CMakeLists.txt内容如下：\n```txt\ncmake_minimum_required(VERSION 3.5)\nproject(bc VERSION 0.0.1)\n\n# 添加库\nadd_library(\n    bc STATIC \n    bc.c bc.h\n)\n\n# 将库的目录添加到include路径\ntarget_include_directories(bc PUBLIC ${CMAKE_CURRENT_SOURCE_DIR})\n```\n这里主要关注`add_library`这个指令中的，`STATIC`关键字，有这个关键字，在编译时，才会被编译成静态库。\n在bc目录下，执行相关的指令，生成静态库文件。\n```bash\nmkdir build\ncd build\ncmake ..\nmake\n```\n执行完相关指令以后，在build目录下，会多一个libbc.a文件。\n\n## 二、macOS swiftUI项目\nmacOS的演示项目名称为TestA，其基本目录结构如下：\n```css\nTestA\n├── TestA\n│   ├── main.swift\n│   ├── TestA-Bridging-Header.h\n│   └── ...\n├── TestA.xcodeproj\n|── include/bc.h\n└── libbc.a\n```\nTestA为项目根目录，其内部的TestA为同名Target目录。在根目录下，你可以看到一个libbc.a文件，实际上这个文件本身并不存在于该路径下，而是在上一段中提到的build目录下，当然，你也可以把文件本身拷贝到该目录下。\n\n### 2.1 添加libbc.a\n在根目录上，右键->Add Files to \"TestA\"，然后选择libbc.a，这样libbc.a就会显示在根目录下了。\n左键点击项目根目录，弹出配置选项卡，点击**Build Settings**选项卡，在Filter中，输入\"Other Linker Flags\"，找到该配置项，然后增加配置值`-lbc`（这里的“bc”应该是你的库文件名去掉前缀“lib”和后缀“.a”，因为我的库名称叫bc，生成的文件上libbc.a，所以值为-lbc，如果你的库名称为xyz，则应该配置为-lxyz），这里需要注意，该配置项下有Debug和Release两个，都要配置，下同。\n\n### 2.2 引入头文件\n在根目录下，创建include目录，将头文件bc.h拷贝进来。然后在刚才的**Build Settings**选项卡中，搜索\"Header Search Paths\"，并设置值为`$(SRCROOT)/include`，注意，如果include下有子目录，同样需要添加到该配置中。添加了该配置后，在接下来的TestA-Bridging-Header.h中，才能引入相关头文件。\n\n### 2.3 TestA-Bridging-Header.h\n注意，是TestA-Bridging-Header.h，不是TestA-Bridge-Header.h。因为是桥接文件，所以好几次，我都想当然的认为是`Bridge`了，导致很多次配置都失败了。\n文件内容如下：\n```h\n#ifndef TestA_Bridging_Header_h\n#define TestA_Bridging_Header_h\n\n#include \"bc.h\"\n\n#endif\n```\n在此文件中，可以使用bc.h文件了。\n\n此时，在Swfit代码中还不能使用TestA-Bridge-Header.h中引入头文件的相关函数，需要设置Objective-C Bridging Header，同样在**Build Settings**中搜索\"Objective-C Bridging Header\"，设置值为`TestA/TestA-Bridging-Header.h`。\n\n## 三、运行\n在Swift代码的UI配置文件中，使用c语言中的`getNumber`方法。\n```swift\nimport SwiftUI\n\nstruct ContentView: View {\n    var body: some View {\n        VStack {\n            Image(systemName: \"globe\")\n                .imageScale(.large)\n                .foregroundStyle(.tint)\n            Text(\"Hello, world!\\(getNumber())\")\n        }\n        .padding()\n    }\n}\n```\n将该数字显示在Text中，效果如下：\n![getNumber](../images/getNumber.png)","slug":"2024-04-26-MacOS项目中引入c静态库","published":1,"updated":"2024-09-25T02:53:02.307Z","comments":1,"layout":"post","photos":["../images/getNumber.png"],"_id":"cm1ltr0g4002jbji0f4xj0zjo","content":"<p>最近在写一款多平台的文件传输工具，Android平台已经写的差不多了，现在正在写macOS端，为了多端共享同一套底层协议代码，通讯协议部分，使用了c语言开发，对于Android通过jni调用c的相关代码，我已经驾轻就熟了，但是在macOS项目里，添加静态库并成功调试，我还是有一些懵逼。好在通过ChatGPT的各种帮助，还是跌跌撞撞的调通了。为了防止遗忘，记录一下过程。</p>\n<p>相关的c&#x2F;swift代码，均以示例项目作为演示，目的是说明过程。</p>\n<h2 id=\"一、C语言库\"><a href=\"#一、C语言库\" class=\"headerlink\" title=\"一、C语言库\"></a>一、C语言库</h2><p>c库的相关代码结构如下：</p>\n<pre class=\"language-css\" data-language=\"css\"><code class=\"language-css\">demo\n├── bc\n│   ├── bc.h\n│   ├── bc.c\n│   └── build/libbc.a\n│   └── CMakeLists.txt\n├── main.c\n│── CMakeLists.txt\n</code></pre>\n<p>根目录的main.c与CMakeLists.txt不重要，重要的是bc文件夹下。<br>bc.h为头文件，bc.c为代码文件，其内容比较简单，定义了一个名为getNumber的函数，函数返回值为42，build为编译生成文件夹，主要是为了生成libbc.a，bc目录下的CMakeLists.txt内容如下：</p>\n<pre class=\"language-txt\" data-language=\"txt\"><code class=\"language-txt\">cmake_minimum_required(VERSION 3.5)\nproject(bc VERSION 0.0.1)\n\n# 添加库\nadd_library(\n    bc STATIC \n    bc.c bc.h\n)\n\n# 将库的目录添加到include路径\ntarget_include_directories(bc PUBLIC $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;)</code></pre>\n<p>这里主要关注<code>add_library</code>这个指令中的，<code>STATIC</code>关键字，有这个关键字，在编译时，才会被编译成静态库。<br>在bc目录下，执行相关的指令，生成静态库文件。</p>\n<pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> build\n<span class=\"token builtin class-name\">cd</span> build\ncmake <span class=\"token punctuation\">..</span>\n<span class=\"token function\">make</span></code></pre>\n<p>执行完相关指令以后，在build目录下，会多一个libbc.a文件。</p>\n<h2 id=\"二、macOS-swiftUI项目\"><a href=\"#二、macOS-swiftUI项目\" class=\"headerlink\" title=\"二、macOS swiftUI项目\"></a>二、macOS swiftUI项目</h2><p>macOS的演示项目名称为TestA，其基本目录结构如下：</p>\n<pre class=\"language-css\" data-language=\"css\"><code class=\"language-css\">TestA\n├── TestA\n│   ├── main.swift\n│   ├── TestA-Bridging-Header.h\n│   └── ...\n├── TestA.xcodeproj\n|── include/bc.h\n└── libbc.a</code></pre>\n<p>TestA为项目根目录，其内部的TestA为同名Target目录。在根目录下，你可以看到一个libbc.a文件，实际上这个文件本身并不存在于该路径下，而是在上一段中提到的build目录下，当然，你也可以把文件本身拷贝到该目录下。</p>\n<h3 id=\"2-1-添加libbc-a\"><a href=\"#2-1-添加libbc-a\" class=\"headerlink\" title=\"2.1 添加libbc.a\"></a>2.1 添加libbc.a</h3><p>在根目录上，右键-&gt;Add Files to “TestA”，然后选择libbc.a，这样libbc.a就会显示在根目录下了。<br>左键点击项目根目录，弹出配置选项卡，点击<strong>Build Settings</strong>选项卡，在Filter中，输入”Other Linker Flags”，找到该配置项，然后增加配置值<code>-lbc</code>（这里的“bc”应该是你的库文件名去掉前缀“lib”和后缀“.a”，因为我的库名称叫bc，生成的文件上libbc.a，所以值为-lbc，如果你的库名称为xyz，则应该配置为-lxyz），这里需要注意，该配置项下有Debug和Release两个，都要配置，下同。</p>\n<h3 id=\"2-2-引入头文件\"><a href=\"#2-2-引入头文件\" class=\"headerlink\" title=\"2.2 引入头文件\"></a>2.2 引入头文件</h3><p>在根目录下，创建include目录，将头文件bc.h拷贝进来。然后在刚才的<strong>Build Settings</strong>选项卡中，搜索”Header Search Paths”，并设置值为<code>$(SRCROOT)/include</code>，注意，如果include下有子目录，同样需要添加到该配置中。添加了该配置后，在接下来的TestA-Bridging-Header.h中，才能引入相关头文件。</p>\n<h3 id=\"2-3-TestA-Bridging-Header-h\"><a href=\"#2-3-TestA-Bridging-Header-h\" class=\"headerlink\" title=\"2.3 TestA-Bridging-Header.h\"></a>2.3 TestA-Bridging-Header.h</h3><p>注意，是TestA-Bridging-Header.h，不是TestA-Bridge-Header.h。因为是桥接文件，所以好几次，我都想当然的认为是<code>Bridge</code>了，导致很多次配置都失败了。<br>文件内容如下：</p>\n<pre class=\"language-h\" data-language=\"h\"><code class=\"language-h\">#ifndef TestA_Bridging_Header_h\n#define TestA_Bridging_Header_h\n\n#include &quot;bc.h&quot;\n\n#endif</code></pre>\n<p>在此文件中，可以使用bc.h文件了。</p>\n<p>此时，在Swfit代码中还不能使用TestA-Bridge-Header.h中引入头文件的相关函数，需要设置Objective-C Bridging Header，同样在<strong>Build Settings</strong>中搜索”Objective-C Bridging Header”，设置值为<code>TestA/TestA-Bridging-Header.h</code>。</p>\n<h2 id=\"三、运行\"><a href=\"#三、运行\" class=\"headerlink\" title=\"三、运行\"></a>三、运行</h2><p>在Swift代码的UI配置文件中，使用c语言中的<code>getNumber</code>方法。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token class-name\">SwiftUI</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">View</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">View</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">VStack</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span>systemName<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"globe\"</span></span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">imageScale</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>large<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">foregroundStyle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>tint<span class=\"token punctuation\">)</span>\n            <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Hello, world!</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\"><span class=\"token function\">getNumber</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">padding</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>将该数字显示在Text中，效果如下：<br><img src=\"/../images/getNumber.png\" alt=\"getNumber\"></p>\n","excerpt":"","more":"<p>最近在写一款多平台的文件传输工具，Android平台已经写的差不多了，现在正在写macOS端，为了多端共享同一套底层协议代码，通讯协议部分，使用了c语言开发，对于Android通过jni调用c的相关代码，我已经驾轻就熟了，但是在macOS项目里，添加静态库并成功调试，我还是有一些懵逼。好在通过ChatGPT的各种帮助，还是跌跌撞撞的调通了。为了防止遗忘，记录一下过程。</p>\n<p>相关的c&#x2F;swift代码，均以示例项目作为演示，目的是说明过程。</p>\n<h2 id=\"一、C语言库\"><a href=\"#一、C语言库\" class=\"headerlink\" title=\"一、C语言库\"></a>一、C语言库</h2><p>c库的相关代码结构如下：</p>\n<pre class=\"language-css\" data-language=\"css\"><code class=\"language-css\">demo\n├── bc\n│   ├── bc.h\n│   ├── bc.c\n│   └── build/libbc.a\n│   └── CMakeLists.txt\n├── main.c\n│── CMakeLists.txt\n</code></pre>\n<p>根目录的main.c与CMakeLists.txt不重要，重要的是bc文件夹下。<br>bc.h为头文件，bc.c为代码文件，其内容比较简单，定义了一个名为getNumber的函数，函数返回值为42，build为编译生成文件夹，主要是为了生成libbc.a，bc目录下的CMakeLists.txt内容如下：</p>\n<pre class=\"language-txt\" data-language=\"txt\"><code class=\"language-txt\">cmake_minimum_required(VERSION 3.5)\nproject(bc VERSION 0.0.1)\n\n# 添加库\nadd_library(\n    bc STATIC \n    bc.c bc.h\n)\n\n# 将库的目录添加到include路径\ntarget_include_directories(bc PUBLIC $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;)</code></pre>\n<p>这里主要关注<code>add_library</code>这个指令中的，<code>STATIC</code>关键字，有这个关键字，在编译时，才会被编译成静态库。<br>在bc目录下，执行相关的指令，生成静态库文件。</p>\n<pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> build\n<span class=\"token builtin class-name\">cd</span> build\ncmake <span class=\"token punctuation\">..</span>\n<span class=\"token function\">make</span></code></pre>\n<p>执行完相关指令以后，在build目录下，会多一个libbc.a文件。</p>\n<h2 id=\"二、macOS-swiftUI项目\"><a href=\"#二、macOS-swiftUI项目\" class=\"headerlink\" title=\"二、macOS swiftUI项目\"></a>二、macOS swiftUI项目</h2><p>macOS的演示项目名称为TestA，其基本目录结构如下：</p>\n<pre class=\"language-css\" data-language=\"css\"><code class=\"language-css\">TestA\n├── TestA\n│   ├── main.swift\n│   ├── TestA-Bridging-Header.h\n│   └── ...\n├── TestA.xcodeproj\n|── include/bc.h\n└── libbc.a</code></pre>\n<p>TestA为项目根目录，其内部的TestA为同名Target目录。在根目录下，你可以看到一个libbc.a文件，实际上这个文件本身并不存在于该路径下，而是在上一段中提到的build目录下，当然，你也可以把文件本身拷贝到该目录下。</p>\n<h3 id=\"2-1-添加libbc-a\"><a href=\"#2-1-添加libbc-a\" class=\"headerlink\" title=\"2.1 添加libbc.a\"></a>2.1 添加libbc.a</h3><p>在根目录上，右键-&gt;Add Files to “TestA”，然后选择libbc.a，这样libbc.a就会显示在根目录下了。<br>左键点击项目根目录，弹出配置选项卡，点击<strong>Build Settings</strong>选项卡，在Filter中，输入”Other Linker Flags”，找到该配置项，然后增加配置值<code>-lbc</code>（这里的“bc”应该是你的库文件名去掉前缀“lib”和后缀“.a”，因为我的库名称叫bc，生成的文件上libbc.a，所以值为-lbc，如果你的库名称为xyz，则应该配置为-lxyz），这里需要注意，该配置项下有Debug和Release两个，都要配置，下同。</p>\n<h3 id=\"2-2-引入头文件\"><a href=\"#2-2-引入头文件\" class=\"headerlink\" title=\"2.2 引入头文件\"></a>2.2 引入头文件</h3><p>在根目录下，创建include目录，将头文件bc.h拷贝进来。然后在刚才的<strong>Build Settings</strong>选项卡中，搜索”Header Search Paths”，并设置值为<code>$(SRCROOT)/include</code>，注意，如果include下有子目录，同样需要添加到该配置中。添加了该配置后，在接下来的TestA-Bridging-Header.h中，才能引入相关头文件。</p>\n<h3 id=\"2-3-TestA-Bridging-Header-h\"><a href=\"#2-3-TestA-Bridging-Header-h\" class=\"headerlink\" title=\"2.3 TestA-Bridging-Header.h\"></a>2.3 TestA-Bridging-Header.h</h3><p>注意，是TestA-Bridging-Header.h，不是TestA-Bridge-Header.h。因为是桥接文件，所以好几次，我都想当然的认为是<code>Bridge</code>了，导致很多次配置都失败了。<br>文件内容如下：</p>\n<pre class=\"language-h\" data-language=\"h\"><code class=\"language-h\">#ifndef TestA_Bridging_Header_h\n#define TestA_Bridging_Header_h\n\n#include &quot;bc.h&quot;\n\n#endif</code></pre>\n<p>在此文件中，可以使用bc.h文件了。</p>\n<p>此时，在Swfit代码中还不能使用TestA-Bridge-Header.h中引入头文件的相关函数，需要设置Objective-C Bridging Header，同样在<strong>Build Settings</strong>中搜索”Objective-C Bridging Header”，设置值为<code>TestA/TestA-Bridging-Header.h</code>。</p>\n<h2 id=\"三、运行\"><a href=\"#三、运行\" class=\"headerlink\" title=\"三、运行\"></a>三、运行</h2><p>在Swift代码的UI配置文件中，使用c语言中的<code>getNumber</code>方法。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token class-name\">SwiftUI</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">View</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">View</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">VStack</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span>systemName<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"globe\"</span></span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">imageScale</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>large<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">foregroundStyle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>tint<span class=\"token punctuation\">)</span>\n            <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Hello, world!</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\"><span class=\"token function\">getNumber</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">padding</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>将该数字显示在Text中，效果如下：<br><img src=\"/../images/getNumber.png\" alt=\"getNumber\"></p>\n"},{"title":"MacOS项目引入c语言源码","date":"2024-04-29T14:40:00.000Z","_content":"\n在上一篇文章[macOS项目中引入c静态库](https://boybeak.github.io/2024/04/26/2024-04-26-MacOS%E9%A1%B9%E7%9B%AE%E4%B8%AD%E5%BC%95%E5%85%A5c%E9%9D%99%E6%80%81%E5%BA%93/)中，为阐述了如何在macOS项目中引入c语言的静态库，但是这样做有一个问题，就是静态库中的代码报错，会无法定义报错的位置，进而不利于排查问题。为了解决这个问题，我修改为源码引入c语言库。\n很多教程中都提到，要引入c语言库的源码，需要将源码和头文件都拷贝到macOS项目的目录中，这样做，有一个弊病，就是对于需要引入c语言库的项目，通常都是想底层多平台支持，底层代码就需要独立于任何一个平台代码，如果要拷贝到macOS项目中，那后续修改和维护都会比较麻烦，实际上这是不需要的，接下来就阐述一下我这两天的实践。\n\n## 一、项目结构\n我们准备两个示例项目，其中项目A是基于swift构建的macOS项目，项目B是基于cmake构建的c语言项目。其目录树如下：\n```css\nA/\n├── A   // macOS中的同名target\n│   └── AApp.swift\n│   └── ContentView.swift\n│   └── Assets\n│   └── ....    // Other files\n```\n```css\nB/\n├── CMakeLists.txt\n├── src/\n│   └── library.c\n└── include/\n    └── library.h\n```\nlibrary的头文件和代码文件如下：\n```h\n#include <stdio.h>\n\nint get_id();\n```\n```c\n#include \"../include/library.h\"\n\nint get_id()\n{\n    int *ptr = NULL;\n    *ptr = 10; // 这里会导致空指针解引用崩溃\n\n    return 100;\n}\n```\n这里c代码文件中，故意制造了一个空指针崩溃，以便于测试定位崩溃位置。\n\n## 二、macOS项目引入c语言源代码项目\n在XCode中，A项目的根目录下，右键-Add Files to \"A\"，然后选择项目B的根目录选择的时候，千万**不要勾选“Copy items if needed”**，然后点击Add，如此操作之后，你会在XCode的项目目录中，看到在根目录下多了一个名为B的Group，但是这个Group并不会出现在实际的文件目录下。那在XCode中，项目A的目录结构变成了如下这样：\n```css\nA/\n├── A   // macOS中的同名target\n│   └── AApp.swift\n│   └── ContentView.swift\n│   └── Assets\n│   └── ....    // Other files\n│\n├── B   // 引入的c源码库，只在XCode视图中可见\n│   └── CMakeLists.txt\n│   └──src/\n│   │   └── library.c\n│   └──include/\n        └── library.h\n```\n\n## 三、创建桥接文件\n与静态库方案类似，也需要创建一个桥接文件，名为A-Bridging-Header.h，放置在根目录下，然后在Build Settings下搜索**Header Search Paths**设置项，在Debug和Release下，设置B库的include目录，**注意**：因为B库并未实际在A项目的文件目录下，所以，你不能设置一个A项目下的目录。我设置的值为：`$(SRCROOT)/../B/include`。增加此配置后，在桥接文件中，增加头文件的引入，内容如下：\n```h\n#ifndef A_Bridging_Header_h\n#define A_Bridging_Header_h\n\n#include \"library.h\"\n\n#endif\n```\n\n还差最后一步，把桥接文件设置到**Objective-C Bridging Header**配置中，由于桥接文件在根目录下，所以我设置的值为`A-Bridging-Header.h`。\n\n## 四、运行\n在AApp.swift代码中，我们创建一个Application Delegate，代码如下：\n```swift\nimport SwiftUI\n\n@main\nstruct AApp: App {\n    @NSApplicationDelegateAdaptor var delegate: AppDelegate\n    var body: some Scene {\n        WindowGroup {\n            ContentView()\n        }\n    }\n}\n\nclass AppDelegate: NSObject, NSApplicationDelegate {\n    func applicationDidFinishLaunching(_ notification: Notification) {\n        print(\"applicationDidFinishLaunching\")\n        print(\"\\(get_id())\")\n    }\n}\n```\n当应用启动时，调用一下c语言中`get_id`这个方法，由于方法中有一个空指针错误，会触发崩溃，并指向崩溃位置。\n![crash](../images/macOS-App-crash.png)\n\n## 后记\n在现实项目中，c源码项目可能远比demo中的要复杂的多，引入源码后，可能会引起类似于如下的编译错误：\n```\nxcode macOS项目中，引入了第三方的c语言库后，出现了这样的错误，似乎是因为不能识别这些文件造成的，我把这些文件的引用从xcode删除后，就没有这些错误了，请问情况是这样的吗？以下是错误的内容：\nShowing All Issues\nMultiple commands produce '/Users/xxx/Library/Developer/Xcode/DerivedData/Test-gkhgciuuhcjhzjayrjomcyvjrhgq/Build/Products/Debug/Test.app/Contents/Resources/CI.yml'\nTarget 'Test' (project 'Test') has copy command from '/Users/xxx/byte-cat/ByteCat/native/bytecat-native/cJSON/.github/workflows/CI.yml' to '/Users/xxx/Library/Developer/Xcode/DerivedData/Test-gkhgciuuhcjhzjayrjomcyvjrhgq/Build/Products/Debug/Test.app/Contents/Resources/CI.yml'\nTarget 'Test' (project 'Test') has copy command from '/Users/xxx/byte-cat/ByteCat/native/bytecat-native/libhv/.github/workflows/CI.yml' to '/Users/xxx/Library/Developer/Xcode/DerivedData/Test-gkhgciuuhcjhzjayrjomcyvjrhgq/Build/Products/Debug/Test.app/Contents/Resources/CI.yml'\n```\n如果发生了这个错误，需要在**Build Phases**中，找到**Copy Bundle Resources**选项，点击底部\"-\"号按钮，删除掉重复的项，如果重复的项过多，这个按钮会被顶到列表最下边。","source":"_posts/2024-04-29-MacOS项目引入c语言源码.md","raw":"---\ntitle: MacOS项目引入c语言源码\ndate: 2024-04-29 22:40:00\ncategories: 独立开发笔记\ntags:\n- macOS\n---\n\n在上一篇文章[macOS项目中引入c静态库](https://boybeak.github.io/2024/04/26/2024-04-26-MacOS%E9%A1%B9%E7%9B%AE%E4%B8%AD%E5%BC%95%E5%85%A5c%E9%9D%99%E6%80%81%E5%BA%93/)中，为阐述了如何在macOS项目中引入c语言的静态库，但是这样做有一个问题，就是静态库中的代码报错，会无法定义报错的位置，进而不利于排查问题。为了解决这个问题，我修改为源码引入c语言库。\n很多教程中都提到，要引入c语言库的源码，需要将源码和头文件都拷贝到macOS项目的目录中，这样做，有一个弊病，就是对于需要引入c语言库的项目，通常都是想底层多平台支持，底层代码就需要独立于任何一个平台代码，如果要拷贝到macOS项目中，那后续修改和维护都会比较麻烦，实际上这是不需要的，接下来就阐述一下我这两天的实践。\n\n## 一、项目结构\n我们准备两个示例项目，其中项目A是基于swift构建的macOS项目，项目B是基于cmake构建的c语言项目。其目录树如下：\n```css\nA/\n├── A   // macOS中的同名target\n│   └── AApp.swift\n│   └── ContentView.swift\n│   └── Assets\n│   └── ....    // Other files\n```\n```css\nB/\n├── CMakeLists.txt\n├── src/\n│   └── library.c\n└── include/\n    └── library.h\n```\nlibrary的头文件和代码文件如下：\n```h\n#include <stdio.h>\n\nint get_id();\n```\n```c\n#include \"../include/library.h\"\n\nint get_id()\n{\n    int *ptr = NULL;\n    *ptr = 10; // 这里会导致空指针解引用崩溃\n\n    return 100;\n}\n```\n这里c代码文件中，故意制造了一个空指针崩溃，以便于测试定位崩溃位置。\n\n## 二、macOS项目引入c语言源代码项目\n在XCode中，A项目的根目录下，右键-Add Files to \"A\"，然后选择项目B的根目录选择的时候，千万**不要勾选“Copy items if needed”**，然后点击Add，如此操作之后，你会在XCode的项目目录中，看到在根目录下多了一个名为B的Group，但是这个Group并不会出现在实际的文件目录下。那在XCode中，项目A的目录结构变成了如下这样：\n```css\nA/\n├── A   // macOS中的同名target\n│   └── AApp.swift\n│   └── ContentView.swift\n│   └── Assets\n│   └── ....    // Other files\n│\n├── B   // 引入的c源码库，只在XCode视图中可见\n│   └── CMakeLists.txt\n│   └──src/\n│   │   └── library.c\n│   └──include/\n        └── library.h\n```\n\n## 三、创建桥接文件\n与静态库方案类似，也需要创建一个桥接文件，名为A-Bridging-Header.h，放置在根目录下，然后在Build Settings下搜索**Header Search Paths**设置项，在Debug和Release下，设置B库的include目录，**注意**：因为B库并未实际在A项目的文件目录下，所以，你不能设置一个A项目下的目录。我设置的值为：`$(SRCROOT)/../B/include`。增加此配置后，在桥接文件中，增加头文件的引入，内容如下：\n```h\n#ifndef A_Bridging_Header_h\n#define A_Bridging_Header_h\n\n#include \"library.h\"\n\n#endif\n```\n\n还差最后一步，把桥接文件设置到**Objective-C Bridging Header**配置中，由于桥接文件在根目录下，所以我设置的值为`A-Bridging-Header.h`。\n\n## 四、运行\n在AApp.swift代码中，我们创建一个Application Delegate，代码如下：\n```swift\nimport SwiftUI\n\n@main\nstruct AApp: App {\n    @NSApplicationDelegateAdaptor var delegate: AppDelegate\n    var body: some Scene {\n        WindowGroup {\n            ContentView()\n        }\n    }\n}\n\nclass AppDelegate: NSObject, NSApplicationDelegate {\n    func applicationDidFinishLaunching(_ notification: Notification) {\n        print(\"applicationDidFinishLaunching\")\n        print(\"\\(get_id())\")\n    }\n}\n```\n当应用启动时，调用一下c语言中`get_id`这个方法，由于方法中有一个空指针错误，会触发崩溃，并指向崩溃位置。\n![crash](../images/macOS-App-crash.png)\n\n## 后记\n在现实项目中，c源码项目可能远比demo中的要复杂的多，引入源码后，可能会引起类似于如下的编译错误：\n```\nxcode macOS项目中，引入了第三方的c语言库后，出现了这样的错误，似乎是因为不能识别这些文件造成的，我把这些文件的引用从xcode删除后，就没有这些错误了，请问情况是这样的吗？以下是错误的内容：\nShowing All Issues\nMultiple commands produce '/Users/xxx/Library/Developer/Xcode/DerivedData/Test-gkhgciuuhcjhzjayrjomcyvjrhgq/Build/Products/Debug/Test.app/Contents/Resources/CI.yml'\nTarget 'Test' (project 'Test') has copy command from '/Users/xxx/byte-cat/ByteCat/native/bytecat-native/cJSON/.github/workflows/CI.yml' to '/Users/xxx/Library/Developer/Xcode/DerivedData/Test-gkhgciuuhcjhzjayrjomcyvjrhgq/Build/Products/Debug/Test.app/Contents/Resources/CI.yml'\nTarget 'Test' (project 'Test') has copy command from '/Users/xxx/byte-cat/ByteCat/native/bytecat-native/libhv/.github/workflows/CI.yml' to '/Users/xxx/Library/Developer/Xcode/DerivedData/Test-gkhgciuuhcjhzjayrjomcyvjrhgq/Build/Products/Debug/Test.app/Contents/Resources/CI.yml'\n```\n如果发生了这个错误，需要在**Build Phases**中，找到**Copy Bundle Resources**选项，点击底部\"-\"号按钮，删除掉重复的项，如果重复的项过多，这个按钮会被顶到列表最下边。","slug":"2024-04-29-MacOS项目引入c语言源码","published":1,"updated":"2024-09-25T02:53:02.309Z","comments":1,"layout":"post","photos":["../images/macOS-App-crash.png"],"_id":"cm1ltr0g4002mbji089z49hrm","content":"<p>在上一篇文章<a href=\"https://boybeak.github.io/2024/04/26/2024-04-26-MacOS%E9%A1%B9%E7%9B%AE%E4%B8%AD%E5%BC%95%E5%85%A5c%E9%9D%99%E6%80%81%E5%BA%93/\">macOS项目中引入c静态库</a>中，为阐述了如何在macOS项目中引入c语言的静态库，但是这样做有一个问题，就是静态库中的代码报错，会无法定义报错的位置，进而不利于排查问题。为了解决这个问题，我修改为源码引入c语言库。<br>很多教程中都提到，要引入c语言库的源码，需要将源码和头文件都拷贝到macOS项目的目录中，这样做，有一个弊病，就是对于需要引入c语言库的项目，通常都是想底层多平台支持，底层代码就需要独立于任何一个平台代码，如果要拷贝到macOS项目中，那后续修改和维护都会比较麻烦，实际上这是不需要的，接下来就阐述一下我这两天的实践。</p>\n<h2 id=\"一、项目结构\"><a href=\"#一、项目结构\" class=\"headerlink\" title=\"一、项目结构\"></a>一、项目结构</h2><p>我们准备两个示例项目，其中项目A是基于swift构建的macOS项目，项目B是基于cmake构建的c语言项目。其目录树如下：</p>\n<pre class=\"language-css\" data-language=\"css\"><code class=\"language-css\">A/\n├── A   // macOS中的同名target\n│   └── AApp.swift\n│   └── ContentView.swift\n│   └── Assets\n│   └── ....    // Other files</code></pre>\n<pre class=\"language-css\" data-language=\"css\"><code class=\"language-css\">B/\n├── CMakeLists.txt\n├── src/\n│   └── library.c\n└── include/\n    └── library.h</code></pre>\n<p>library的头文件和代码文件如下：</p>\n<pre class=\"language-h\" data-language=\"h\"><code class=\"language-h\">#include &lt;stdio.h&gt;\n\nint get_id();</code></pre>\n<pre class=\"language-c\" data-language=\"c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"../include/library.h\"</span></span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">get_id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>ptr <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n    <span class=\"token operator\">*</span>ptr <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 这里会导致空指针解引用崩溃</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>这里c代码文件中，故意制造了一个空指针崩溃，以便于测试定位崩溃位置。</p>\n<h2 id=\"二、macOS项目引入c语言源代码项目\"><a href=\"#二、macOS项目引入c语言源代码项目\" class=\"headerlink\" title=\"二、macOS项目引入c语言源代码项目\"></a>二、macOS项目引入c语言源代码项目</h2><p>在XCode中，A项目的根目录下，右键-Add Files to “A”，然后选择项目B的根目录选择的时候，千万<strong>不要勾选“Copy items if needed”</strong>，然后点击Add，如此操作之后，你会在XCode的项目目录中，看到在根目录下多了一个名为B的Group，但是这个Group并不会出现在实际的文件目录下。那在XCode中，项目A的目录结构变成了如下这样：</p>\n<pre class=\"language-css\" data-language=\"css\"><code class=\"language-css\">A/\n├── A   // macOS中的同名target\n│   └── AApp.swift\n│   └── ContentView.swift\n│   └── Assets\n│   └── ....    // Other files\n│\n├── B   // 引入的c源码库，只在XCode视图中可见\n│   └── CMakeLists.txt\n│   └──src/\n│   │   └── library.c\n│   └──include/\n        └── library.h</code></pre>\n\n<h2 id=\"三、创建桥接文件\"><a href=\"#三、创建桥接文件\" class=\"headerlink\" title=\"三、创建桥接文件\"></a>三、创建桥接文件</h2><p>与静态库方案类似，也需要创建一个桥接文件，名为A-Bridging-Header.h，放置在根目录下，然后在Build Settings下搜索<strong>Header Search Paths</strong>设置项，在Debug和Release下，设置B库的include目录，<strong>注意</strong>：因为B库并未实际在A项目的文件目录下，所以，你不能设置一个A项目下的目录。我设置的值为：<code>$(SRCROOT)/../B/include</code>。增加此配置后，在桥接文件中，增加头文件的引入，内容如下：</p>\n<pre class=\"language-h\" data-language=\"h\"><code class=\"language-h\">#ifndef A_Bridging_Header_h\n#define A_Bridging_Header_h\n\n#include &quot;library.h&quot;\n\n#endif</code></pre>\n\n<p>还差最后一步，把桥接文件设置到<strong>Objective-C Bridging Header</strong>配置中，由于桥接文件在根目录下，所以我设置的值为<code>A-Bridging-Header.h</code>。</p>\n<h2 id=\"四、运行\"><a href=\"#四、运行\" class=\"headerlink\" title=\"四、运行\"></a>四、运行</h2><p>在AApp.swift代码中，我们创建一个Application Delegate，代码如下：</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token class-name\">SwiftUI</span>\n\n<span class=\"token attribute atrule\">@main</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">AApp</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">App</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token attribute atrule\">@NSApplicationDelegateAdaptor</span> <span class=\"token keyword\">var</span> delegate<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AppDelegate</span>\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">Scene</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">WindowGroup</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NSApplicationDelegate</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">applicationDidFinishLaunching</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> notification<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Notification</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"applicationDidFinishLaunching\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\"><span class=\"token function\">get_id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>当应用启动时，调用一下c语言中<code>get_id</code>这个方法，由于方法中有一个空指针错误，会触发崩溃，并指向崩溃位置。<br><img src=\"/../images/macOS-App-crash.png\" alt=\"crash\"></p>\n<h2 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h2><p>在现实项目中，c源码项目可能远比demo中的要复杂的多，引入源码后，可能会引起类似于如下的编译错误：</p>\n<pre class=\"language-none\"><code class=\"language-none\">xcode macOS项目中，引入了第三方的c语言库后，出现了这样的错误，似乎是因为不能识别这些文件造成的，我把这些文件的引用从xcode删除后，就没有这些错误了，请问情况是这样的吗？以下是错误的内容：\nShowing All Issues\nMultiple commands produce &#39;&#x2F;Users&#x2F;xxx&#x2F;Library&#x2F;Developer&#x2F;Xcode&#x2F;DerivedData&#x2F;Test-gkhgciuuhcjhzjayrjomcyvjrhgq&#x2F;Build&#x2F;Products&#x2F;Debug&#x2F;Test.app&#x2F;Contents&#x2F;Resources&#x2F;CI.yml&#39;\nTarget &#39;Test&#39; (project &#39;Test&#39;) has copy command from &#39;&#x2F;Users&#x2F;xxx&#x2F;byte-cat&#x2F;ByteCat&#x2F;native&#x2F;bytecat-native&#x2F;cJSON&#x2F;.github&#x2F;workflows&#x2F;CI.yml&#39; to &#39;&#x2F;Users&#x2F;xxx&#x2F;Library&#x2F;Developer&#x2F;Xcode&#x2F;DerivedData&#x2F;Test-gkhgciuuhcjhzjayrjomcyvjrhgq&#x2F;Build&#x2F;Products&#x2F;Debug&#x2F;Test.app&#x2F;Contents&#x2F;Resources&#x2F;CI.yml&#39;\nTarget &#39;Test&#39; (project &#39;Test&#39;) has copy command from &#39;&#x2F;Users&#x2F;xxx&#x2F;byte-cat&#x2F;ByteCat&#x2F;native&#x2F;bytecat-native&#x2F;libhv&#x2F;.github&#x2F;workflows&#x2F;CI.yml&#39; to &#39;&#x2F;Users&#x2F;xxx&#x2F;Library&#x2F;Developer&#x2F;Xcode&#x2F;DerivedData&#x2F;Test-gkhgciuuhcjhzjayrjomcyvjrhgq&#x2F;Build&#x2F;Products&#x2F;Debug&#x2F;Test.app&#x2F;Contents&#x2F;Resources&#x2F;CI.yml&#39;</code></pre>\n<p>如果发生了这个错误，需要在<strong>Build Phases</strong>中，找到<strong>Copy Bundle Resources</strong>选项，点击底部”-“号按钮，删除掉重复的项，如果重复的项过多，这个按钮会被顶到列表最下边。</p>\n","excerpt":"","more":"<p>在上一篇文章<a href=\"https://boybeak.github.io/2024/04/26/2024-04-26-MacOS%E9%A1%B9%E7%9B%AE%E4%B8%AD%E5%BC%95%E5%85%A5c%E9%9D%99%E6%80%81%E5%BA%93/\">macOS项目中引入c静态库</a>中，为阐述了如何在macOS项目中引入c语言的静态库，但是这样做有一个问题，就是静态库中的代码报错，会无法定义报错的位置，进而不利于排查问题。为了解决这个问题，我修改为源码引入c语言库。<br>很多教程中都提到，要引入c语言库的源码，需要将源码和头文件都拷贝到macOS项目的目录中，这样做，有一个弊病，就是对于需要引入c语言库的项目，通常都是想底层多平台支持，底层代码就需要独立于任何一个平台代码，如果要拷贝到macOS项目中，那后续修改和维护都会比较麻烦，实际上这是不需要的，接下来就阐述一下我这两天的实践。</p>\n<h2 id=\"一、项目结构\"><a href=\"#一、项目结构\" class=\"headerlink\" title=\"一、项目结构\"></a>一、项目结构</h2><p>我们准备两个示例项目，其中项目A是基于swift构建的macOS项目，项目B是基于cmake构建的c语言项目。其目录树如下：</p>\n<pre class=\"language-css\" data-language=\"css\"><code class=\"language-css\">A/\n├── A   // macOS中的同名target\n│   └── AApp.swift\n│   └── ContentView.swift\n│   └── Assets\n│   └── ....    // Other files</code></pre>\n<pre class=\"language-css\" data-language=\"css\"><code class=\"language-css\">B/\n├── CMakeLists.txt\n├── src/\n│   └── library.c\n└── include/\n    └── library.h</code></pre>\n<p>library的头文件和代码文件如下：</p>\n<pre class=\"language-h\" data-language=\"h\"><code class=\"language-h\">#include &lt;stdio.h&gt;\n\nint get_id();</code></pre>\n<pre class=\"language-c\" data-language=\"c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"../include/library.h\"</span></span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">get_id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>ptr <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n    <span class=\"token operator\">*</span>ptr <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 这里会导致空指针解引用崩溃</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>这里c代码文件中，故意制造了一个空指针崩溃，以便于测试定位崩溃位置。</p>\n<h2 id=\"二、macOS项目引入c语言源代码项目\"><a href=\"#二、macOS项目引入c语言源代码项目\" class=\"headerlink\" title=\"二、macOS项目引入c语言源代码项目\"></a>二、macOS项目引入c语言源代码项目</h2><p>在XCode中，A项目的根目录下，右键-Add Files to “A”，然后选择项目B的根目录选择的时候，千万<strong>不要勾选“Copy items if needed”</strong>，然后点击Add，如此操作之后，你会在XCode的项目目录中，看到在根目录下多了一个名为B的Group，但是这个Group并不会出现在实际的文件目录下。那在XCode中，项目A的目录结构变成了如下这样：</p>\n<pre class=\"language-css\" data-language=\"css\"><code class=\"language-css\">A/\n├── A   // macOS中的同名target\n│   └── AApp.swift\n│   └── ContentView.swift\n│   └── Assets\n│   └── ....    // Other files\n│\n├── B   // 引入的c源码库，只在XCode视图中可见\n│   └── CMakeLists.txt\n│   └──src/\n│   │   └── library.c\n│   └──include/\n        └── library.h</code></pre>\n\n<h2 id=\"三、创建桥接文件\"><a href=\"#三、创建桥接文件\" class=\"headerlink\" title=\"三、创建桥接文件\"></a>三、创建桥接文件</h2><p>与静态库方案类似，也需要创建一个桥接文件，名为A-Bridging-Header.h，放置在根目录下，然后在Build Settings下搜索<strong>Header Search Paths</strong>设置项，在Debug和Release下，设置B库的include目录，<strong>注意</strong>：因为B库并未实际在A项目的文件目录下，所以，你不能设置一个A项目下的目录。我设置的值为：<code>$(SRCROOT)/../B/include</code>。增加此配置后，在桥接文件中，增加头文件的引入，内容如下：</p>\n<pre class=\"language-h\" data-language=\"h\"><code class=\"language-h\">#ifndef A_Bridging_Header_h\n#define A_Bridging_Header_h\n\n#include &quot;library.h&quot;\n\n#endif</code></pre>\n\n<p>还差最后一步，把桥接文件设置到<strong>Objective-C Bridging Header</strong>配置中，由于桥接文件在根目录下，所以我设置的值为<code>A-Bridging-Header.h</code>。</p>\n<h2 id=\"四、运行\"><a href=\"#四、运行\" class=\"headerlink\" title=\"四、运行\"></a>四、运行</h2><p>在AApp.swift代码中，我们创建一个Application Delegate，代码如下：</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token class-name\">SwiftUI</span>\n\n<span class=\"token attribute atrule\">@main</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">AApp</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">App</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token attribute atrule\">@NSApplicationDelegateAdaptor</span> <span class=\"token keyword\">var</span> delegate<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AppDelegate</span>\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">Scene</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">WindowGroup</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NSApplicationDelegate</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">applicationDidFinishLaunching</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> notification<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Notification</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"applicationDidFinishLaunching\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\"><span class=\"token function\">get_id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>当应用启动时，调用一下c语言中<code>get_id</code>这个方法，由于方法中有一个空指针错误，会触发崩溃，并指向崩溃位置。<br><img src=\"/../images/macOS-App-crash.png\" alt=\"crash\"></p>\n<h2 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h2><p>在现实项目中，c源码项目可能远比demo中的要复杂的多，引入源码后，可能会引起类似于如下的编译错误：</p>\n<pre class=\"language-none\"><code class=\"language-none\">xcode macOS项目中，引入了第三方的c语言库后，出现了这样的错误，似乎是因为不能识别这些文件造成的，我把这些文件的引用从xcode删除后，就没有这些错误了，请问情况是这样的吗？以下是错误的内容：\nShowing All Issues\nMultiple commands produce &#39;&#x2F;Users&#x2F;xxx&#x2F;Library&#x2F;Developer&#x2F;Xcode&#x2F;DerivedData&#x2F;Test-gkhgciuuhcjhzjayrjomcyvjrhgq&#x2F;Build&#x2F;Products&#x2F;Debug&#x2F;Test.app&#x2F;Contents&#x2F;Resources&#x2F;CI.yml&#39;\nTarget &#39;Test&#39; (project &#39;Test&#39;) has copy command from &#39;&#x2F;Users&#x2F;xxx&#x2F;byte-cat&#x2F;ByteCat&#x2F;native&#x2F;bytecat-native&#x2F;cJSON&#x2F;.github&#x2F;workflows&#x2F;CI.yml&#39; to &#39;&#x2F;Users&#x2F;xxx&#x2F;Library&#x2F;Developer&#x2F;Xcode&#x2F;DerivedData&#x2F;Test-gkhgciuuhcjhzjayrjomcyvjrhgq&#x2F;Build&#x2F;Products&#x2F;Debug&#x2F;Test.app&#x2F;Contents&#x2F;Resources&#x2F;CI.yml&#39;\nTarget &#39;Test&#39; (project &#39;Test&#39;) has copy command from &#39;&#x2F;Users&#x2F;xxx&#x2F;byte-cat&#x2F;ByteCat&#x2F;native&#x2F;bytecat-native&#x2F;libhv&#x2F;.github&#x2F;workflows&#x2F;CI.yml&#39; to &#39;&#x2F;Users&#x2F;xxx&#x2F;Library&#x2F;Developer&#x2F;Xcode&#x2F;DerivedData&#x2F;Test-gkhgciuuhcjhzjayrjomcyvjrhgq&#x2F;Build&#x2F;Products&#x2F;Debug&#x2F;Test.app&#x2F;Contents&#x2F;Resources&#x2F;CI.yml&#39;</code></pre>\n<p>如果发生了这个错误，需要在<strong>Build Phases</strong>中，找到<strong>Copy Bundle Resources</strong>选项，点击底部”-“号按钮，删除掉重复的项，如果重复的项过多，这个按钮会被顶到列表最下边。</p>\n"},{"title":"MacOS SwiftUI托盘应用开发","date":"2024-05-08T15:29:00.000Z","_content":"\n最近想利用闲暇时间，做一些托盘工具类app的开发，主要是方便自己在Mac上的部分操作。在遇到各种问题后，总结了一下实现托盘SwiftUI应用的两种方式。\n> 小声吐槽：swiftUI在macOS上的适配真的是很烂，相当多的组件可以说是不完善甚至是不可用的状态，似乎苹果也没有完善的意思，这已经是swift迭代到5.10了啊，竟然还有这么多问题存在。\n\n## 方案一：NSApplicationDelegateAdaptor\n这种方式，应该是从Objective-C时代承袭过来的，我没有做过Objective-C的应用，这只是我的猜测。\n新建一个项目，通常会生成一个`XXXApp.swift`的文件，文件的内容如下：\n```swift\n@main\nstruct XXXApp: App {\n    var body: some Scene {\n        WindowGroup {\n            ContentView()\n        }\n    }\n}\n```\n我们要添加一行代码，变成如下这样：\n```swift\n@main\nstruct ByteCatApp: App {\n    @NSApplicationDelegateAdaptor(AppDelegate.self) var appDelegate\n    var body: some Scene {\n        WindowGroup {\n            ContentView()\n        }\n    }\n}\n```\n加入了`@NSApplicationDelegateAdaptor(AppDelegate.self) var appDelegate`这一行，现在开始写`AppDelegate`的代码。\n```swift\nclass AppDelegate: NSObject, NSApplicationDelegate {\n    var statusItem: NSStatusItem!\n    var popover: NSPopover!\n    \n    override init() {}\n    \n    func applicationDidFinishLaunching(_ notification: Notification) {\n        setupStatusBarItem()\n        setupPopover()\n    }\n    \n    func setupStatusBarItem() {\n        statusItem = NSStatusBar.system.statusItem(withLength: NSStatusItem.squareLength)\n        \n        if let button = statusItem.button {\n            let imageSize = NSSize(width: 22, height: 22)\n            button.image = NSImage(named: \"TrayIcon\")\n            button.image?.size = imageSize\n            button.action = #selector(togglePopover(_:))\n        }\n    }\n    \n    func setupPopover() {\n        popover = NSPopover()\n        popover.behavior = .transient\n        popover.contentViewController = PopoverViewController().makeNSViewController()\n    }\n    \n    @objc func togglePopover(_ sender: AnyObject?) {\n        if popover.isShown {\n            closePopover(sender)\n        } else {\n            showPopover(sender)\n        }\n    }\n    \n    func showPopover(_ sender: AnyObject?) {\n        if let button = statusItem.button {\n            popover.show(relativeTo: button.bounds, of: button, preferredEdge: NSRectEdge.minY)\n        }\n    }\n    \n    func closePopover(_ sender: AnyObject?) {\n        popover.performClose(sender)\n    }\n    \n}\n\nstruct PopoverViewController: NSViewControllerRepresentable {\n    func makeNSViewController(context: Context) -> NSViewController {\n        return makeNSViewController()\n    }\n    \n    func makeNSViewController() -> NSViewController {\n        let viewController = NSViewController()\n        viewController.view = NSHostingView(rootView: ContentView())\n        return viewController\n    }\n    \n    func updateNSViewController(_ nsViewController: NSViewController, context: Context) {\n        // Update code if needed\n    }\n}\n```\n\n## 方案二：MenuBarExtra\n```swift\n@main\nstruct XXXApp: App {\n    var body: some Scene {\n        return MenuBarExtra {\n            ContentView()\n        } label: {\n            Image(systemName: \"tray.2.fill\")\n        }.menuBarExtraStyle(.window)\n    }\n}\n```\n这个方案就是这么简单，几行代码就搞定，缺点是，弹出的窗口位置不可调整，也不会有一个三角形指向托盘图标的位置，而且窗口位置一直与托盘图标左对齐。\n\n## 问题\n\n### List导致UI异常\n方案一，当弹出窗口UI中包含了List组件，会使得弹出的窗口显示异常。\n正常情况是这样的：\n![images/normal_popover.png](../images/normal_popover.png)\n异常的情况如下：\n![images/unnormal_popover.png](../images/unnormal_popover.png)\n代码的差别，只是把其中的红色布局换成了List组件而已，顶端的三角指向消失了，而且窗口整体上移了。\n\n### MenuBarExtra的显示不同\n使用方案二，窗口弹出是这样的：\n![images/menu_bar_extra.png](../images/menu_bar_extra.png)\n同样没有顶部三角指向，固定与托盘图标左对齐。\n\n### 横向滑动列表不支持鼠标滚轮\n这并不是某个方案中的问题，而是二者都有的问题，这个应该是SwiftUI的相关组件没有适配macOS所致，这个并没有找到解决办法，似乎苹果也不想解决，毕竟大多数做桌面端app的，都是使用Electron方案，使用原生开发，而且只开发托盘应用的实在是少数。\n\n## 一点小改进\n如果你想让托盘应用启动后，只有在托盘中有图标，而在dock栏中没有图标，则需要在Info.plist中，设置一个属性**Application is agent(UIElement)**为YES。\n\n## 总结\nswiftUI真的不适合在macOS端开发稍微复杂一点的应用，之前开发过一个翻译的应用，只能说勉强够用而已，前提是足够简单。\n对于托盘应用这个极小的领域来说，尤其不能使用，electron不支持自定义UI的弹出窗口，只支持菜单，而swiftUI支持的情况更糟糕，可能只有原始的Objective-C方案可行了，原始人方案。","source":"_posts/2024-05-08-MacOS SwiftUI托盘应用开发.md","raw":"---\ntitle: MacOS SwiftUI托盘应用开发\ndate: 2024-05-08 23:29:00\ncategories: 独立开发笔记\ntags:\n- macOS\n---\n\n最近想利用闲暇时间，做一些托盘工具类app的开发，主要是方便自己在Mac上的部分操作。在遇到各种问题后，总结了一下实现托盘SwiftUI应用的两种方式。\n> 小声吐槽：swiftUI在macOS上的适配真的是很烂，相当多的组件可以说是不完善甚至是不可用的状态，似乎苹果也没有完善的意思，这已经是swift迭代到5.10了啊，竟然还有这么多问题存在。\n\n## 方案一：NSApplicationDelegateAdaptor\n这种方式，应该是从Objective-C时代承袭过来的，我没有做过Objective-C的应用，这只是我的猜测。\n新建一个项目，通常会生成一个`XXXApp.swift`的文件，文件的内容如下：\n```swift\n@main\nstruct XXXApp: App {\n    var body: some Scene {\n        WindowGroup {\n            ContentView()\n        }\n    }\n}\n```\n我们要添加一行代码，变成如下这样：\n```swift\n@main\nstruct ByteCatApp: App {\n    @NSApplicationDelegateAdaptor(AppDelegate.self) var appDelegate\n    var body: some Scene {\n        WindowGroup {\n            ContentView()\n        }\n    }\n}\n```\n加入了`@NSApplicationDelegateAdaptor(AppDelegate.self) var appDelegate`这一行，现在开始写`AppDelegate`的代码。\n```swift\nclass AppDelegate: NSObject, NSApplicationDelegate {\n    var statusItem: NSStatusItem!\n    var popover: NSPopover!\n    \n    override init() {}\n    \n    func applicationDidFinishLaunching(_ notification: Notification) {\n        setupStatusBarItem()\n        setupPopover()\n    }\n    \n    func setupStatusBarItem() {\n        statusItem = NSStatusBar.system.statusItem(withLength: NSStatusItem.squareLength)\n        \n        if let button = statusItem.button {\n            let imageSize = NSSize(width: 22, height: 22)\n            button.image = NSImage(named: \"TrayIcon\")\n            button.image?.size = imageSize\n            button.action = #selector(togglePopover(_:))\n        }\n    }\n    \n    func setupPopover() {\n        popover = NSPopover()\n        popover.behavior = .transient\n        popover.contentViewController = PopoverViewController().makeNSViewController()\n    }\n    \n    @objc func togglePopover(_ sender: AnyObject?) {\n        if popover.isShown {\n            closePopover(sender)\n        } else {\n            showPopover(sender)\n        }\n    }\n    \n    func showPopover(_ sender: AnyObject?) {\n        if let button = statusItem.button {\n            popover.show(relativeTo: button.bounds, of: button, preferredEdge: NSRectEdge.minY)\n        }\n    }\n    \n    func closePopover(_ sender: AnyObject?) {\n        popover.performClose(sender)\n    }\n    \n}\n\nstruct PopoverViewController: NSViewControllerRepresentable {\n    func makeNSViewController(context: Context) -> NSViewController {\n        return makeNSViewController()\n    }\n    \n    func makeNSViewController() -> NSViewController {\n        let viewController = NSViewController()\n        viewController.view = NSHostingView(rootView: ContentView())\n        return viewController\n    }\n    \n    func updateNSViewController(_ nsViewController: NSViewController, context: Context) {\n        // Update code if needed\n    }\n}\n```\n\n## 方案二：MenuBarExtra\n```swift\n@main\nstruct XXXApp: App {\n    var body: some Scene {\n        return MenuBarExtra {\n            ContentView()\n        } label: {\n            Image(systemName: \"tray.2.fill\")\n        }.menuBarExtraStyle(.window)\n    }\n}\n```\n这个方案就是这么简单，几行代码就搞定，缺点是，弹出的窗口位置不可调整，也不会有一个三角形指向托盘图标的位置，而且窗口位置一直与托盘图标左对齐。\n\n## 问题\n\n### List导致UI异常\n方案一，当弹出窗口UI中包含了List组件，会使得弹出的窗口显示异常。\n正常情况是这样的：\n![images/normal_popover.png](../images/normal_popover.png)\n异常的情况如下：\n![images/unnormal_popover.png](../images/unnormal_popover.png)\n代码的差别，只是把其中的红色布局换成了List组件而已，顶端的三角指向消失了，而且窗口整体上移了。\n\n### MenuBarExtra的显示不同\n使用方案二，窗口弹出是这样的：\n![images/menu_bar_extra.png](../images/menu_bar_extra.png)\n同样没有顶部三角指向，固定与托盘图标左对齐。\n\n### 横向滑动列表不支持鼠标滚轮\n这并不是某个方案中的问题，而是二者都有的问题，这个应该是SwiftUI的相关组件没有适配macOS所致，这个并没有找到解决办法，似乎苹果也不想解决，毕竟大多数做桌面端app的，都是使用Electron方案，使用原生开发，而且只开发托盘应用的实在是少数。\n\n## 一点小改进\n如果你想让托盘应用启动后，只有在托盘中有图标，而在dock栏中没有图标，则需要在Info.plist中，设置一个属性**Application is agent(UIElement)**为YES。\n\n## 总结\nswiftUI真的不适合在macOS端开发稍微复杂一点的应用，之前开发过一个翻译的应用，只能说勉强够用而已，前提是足够简单。\n对于托盘应用这个极小的领域来说，尤其不能使用，electron不支持自定义UI的弹出窗口，只支持菜单，而swiftUI支持的情况更糟糕，可能只有原始的Objective-C方案可行了，原始人方案。","slug":"2024-05-08-MacOS SwiftUI托盘应用开发","published":1,"updated":"2024-09-25T02:53:02.311Z","comments":1,"layout":"post","photos":["../images/normal_popover.png","../images/unnormal_popover.png","../images/menu_bar_extra.png"],"_id":"cm1ltr0g5002rbji0b1lfb5iz","content":"<p>最近想利用闲暇时间，做一些托盘工具类app的开发，主要是方便自己在Mac上的部分操作。在遇到各种问题后，总结了一下实现托盘SwiftUI应用的两种方式。</p>\n<blockquote>\n<p>小声吐槽：swiftUI在macOS上的适配真的是很烂，相当多的组件可以说是不完善甚至是不可用的状态，似乎苹果也没有完善的意思，这已经是swift迭代到5.10了啊，竟然还有这么多问题存在。</p>\n</blockquote>\n<h2 id=\"方案一：NSApplicationDelegateAdaptor\"><a href=\"#方案一：NSApplicationDelegateAdaptor\" class=\"headerlink\" title=\"方案一：NSApplicationDelegateAdaptor\"></a>方案一：NSApplicationDelegateAdaptor</h2><p>这种方式，应该是从Objective-C时代承袭过来的，我没有做过Objective-C的应用，这只是我的猜测。<br>新建一个项目，通常会生成一个<code>XXXApp.swift</code>的文件，文件的内容如下：</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token attribute atrule\">@main</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">XXXApp</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">App</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">Scene</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">WindowGroup</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>我们要添加一行代码，变成如下这样：</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token attribute atrule\">@main</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">ByteCatApp</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">App</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token attribute atrule\">@NSApplicationDelegateAdaptor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> appDelegate\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">Scene</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">WindowGroup</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>加入了<code>@NSApplicationDelegateAdaptor(AppDelegate.self) var appDelegate</code>这一行，现在开始写<code>AppDelegate</code>的代码。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NSApplicationDelegate</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">var</span> statusItem<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSStatusItem</span><span class=\"token operator\">!</span>\n    <span class=\"token keyword\">var</span> popover<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSPopover</span><span class=\"token operator\">!</span>\n    \n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">applicationDidFinishLaunching</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> notification<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Notification</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">setupStatusBarItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">setupPopover</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">setupStatusBarItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        statusItem <span class=\"token operator\">=</span> <span class=\"token class-name\">NSStatusBar</span><span class=\"token punctuation\">.</span>system<span class=\"token punctuation\">.</span><span class=\"token function\">statusItem</span><span class=\"token punctuation\">(</span>withLength<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSStatusItem</span><span class=\"token punctuation\">.</span>squareLength<span class=\"token punctuation\">)</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> button <span class=\"token operator\">=</span> statusItem<span class=\"token punctuation\">.</span>button <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">let</span> imageSize <span class=\"token operator\">=</span> <span class=\"token class-name\">NSSize</span><span class=\"token punctuation\">(</span>width<span class=\"token punctuation\">:</span> <span class=\"token number\">22</span><span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">:</span> <span class=\"token number\">22</span><span class=\"token punctuation\">)</span>\n            button<span class=\"token punctuation\">.</span>image <span class=\"token operator\">=</span> <span class=\"token class-name\">NSImage</span><span class=\"token punctuation\">(</span>named<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"TrayIcon\"</span></span><span class=\"token punctuation\">)</span>\n            button<span class=\"token punctuation\">.</span>image<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span>size <span class=\"token operator\">=</span> imageSize\n            button<span class=\"token punctuation\">.</span>action <span class=\"token operator\">=</span> <span class=\"token other-directive property\">#selector</span><span class=\"token punctuation\">(</span><span class=\"token function\">togglePopover</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">setupPopover</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        popover <span class=\"token operator\">=</span> <span class=\"token class-name\">NSPopover</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        popover<span class=\"token punctuation\">.</span>behavior <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span>transient\n        popover<span class=\"token punctuation\">.</span>contentViewController <span class=\"token operator\">=</span> <span class=\"token class-name\">PopoverViewController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">makeNSViewController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token attribute atrule\">@objc</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">togglePopover</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> sender<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyObject</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">if</span> popover<span class=\"token punctuation\">.</span>isShown <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token function\">closePopover</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token function\">showPopover</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">showPopover</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> sender<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyObject</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> button <span class=\"token operator\">=</span> statusItem<span class=\"token punctuation\">.</span>button <span class=\"token punctuation\">&#123;</span>\n            popover<span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span>relativeTo<span class=\"token punctuation\">:</span> button<span class=\"token punctuation\">.</span>bounds<span class=\"token punctuation\">,</span> of<span class=\"token punctuation\">:</span> button<span class=\"token punctuation\">,</span> preferredEdge<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSRectEdge</span><span class=\"token punctuation\">.</span>minY<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">closePopover</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> sender<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyObject</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        popover<span class=\"token punctuation\">.</span><span class=\"token function\">performClose</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">PopoverViewController</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSViewControllerRepresentable</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">makeNSViewController</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Context</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">NSViewController</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">makeNSViewController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">makeNSViewController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">NSViewController</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">let</span> viewController <span class=\"token operator\">=</span> <span class=\"token class-name\">NSViewController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        viewController<span class=\"token punctuation\">.</span>view <span class=\"token operator\">=</span> <span class=\"token class-name\">NSHostingView</span><span class=\"token punctuation\">(</span>rootView<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> viewController\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">updateNSViewController</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> nsViewController<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSViewController</span><span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Context</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// Update code if needed</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<h2 id=\"方案二：MenuBarExtra\"><a href=\"#方案二：MenuBarExtra\" class=\"headerlink\" title=\"方案二：MenuBarExtra\"></a>方案二：MenuBarExtra</h2><pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token attribute atrule\">@main</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">XXXApp</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">App</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">Scene</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">MenuBarExtra</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span> label<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span>systemName<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"tray.2.fill\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">.</span><span class=\"token function\">menuBarExtraStyle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>window<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>这个方案就是这么简单，几行代码就搞定，缺点是，弹出的窗口位置不可调整，也不会有一个三角形指向托盘图标的位置，而且窗口位置一直与托盘图标左对齐。</p>\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><h3 id=\"List导致UI异常\"><a href=\"#List导致UI异常\" class=\"headerlink\" title=\"List导致UI异常\"></a>List导致UI异常</h3><p>方案一，当弹出窗口UI中包含了List组件，会使得弹出的窗口显示异常。<br>正常情况是这样的：<br><img src=\"/../images/normal_popover.png\" alt=\"images/normal_popover.png\"><br>异常的情况如下：<br><img src=\"/../images/unnormal_popover.png\" alt=\"images/unnormal_popover.png\"><br>代码的差别，只是把其中的红色布局换成了List组件而已，顶端的三角指向消失了，而且窗口整体上移了。</p>\n<h3 id=\"MenuBarExtra的显示不同\"><a href=\"#MenuBarExtra的显示不同\" class=\"headerlink\" title=\"MenuBarExtra的显示不同\"></a>MenuBarExtra的显示不同</h3><p>使用方案二，窗口弹出是这样的：<br><img src=\"/../images/menu_bar_extra.png\" alt=\"images/menu_bar_extra.png\"><br>同样没有顶部三角指向，固定与托盘图标左对齐。</p>\n<h3 id=\"横向滑动列表不支持鼠标滚轮\"><a href=\"#横向滑动列表不支持鼠标滚轮\" class=\"headerlink\" title=\"横向滑动列表不支持鼠标滚轮\"></a>横向滑动列表不支持鼠标滚轮</h3><p>这并不是某个方案中的问题，而是二者都有的问题，这个应该是SwiftUI的相关组件没有适配macOS所致，这个并没有找到解决办法，似乎苹果也不想解决，毕竟大多数做桌面端app的，都是使用Electron方案，使用原生开发，而且只开发托盘应用的实在是少数。</p>\n<h2 id=\"一点小改进\"><a href=\"#一点小改进\" class=\"headerlink\" title=\"一点小改进\"></a>一点小改进</h2><p>如果你想让托盘应用启动后，只有在托盘中有图标，而在dock栏中没有图标，则需要在Info.plist中，设置一个属性**Application is agent(UIElement)**为YES。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>swiftUI真的不适合在macOS端开发稍微复杂一点的应用，之前开发过一个翻译的应用，只能说勉强够用而已，前提是足够简单。<br>对于托盘应用这个极小的领域来说，尤其不能使用，electron不支持自定义UI的弹出窗口，只支持菜单，而swiftUI支持的情况更糟糕，可能只有原始的Objective-C方案可行了，原始人方案。</p>\n","excerpt":"","more":"<p>最近想利用闲暇时间，做一些托盘工具类app的开发，主要是方便自己在Mac上的部分操作。在遇到各种问题后，总结了一下实现托盘SwiftUI应用的两种方式。</p>\n<blockquote>\n<p>小声吐槽：swiftUI在macOS上的适配真的是很烂，相当多的组件可以说是不完善甚至是不可用的状态，似乎苹果也没有完善的意思，这已经是swift迭代到5.10了啊，竟然还有这么多问题存在。</p>\n</blockquote>\n<h2 id=\"方案一：NSApplicationDelegateAdaptor\"><a href=\"#方案一：NSApplicationDelegateAdaptor\" class=\"headerlink\" title=\"方案一：NSApplicationDelegateAdaptor\"></a>方案一：NSApplicationDelegateAdaptor</h2><p>这种方式，应该是从Objective-C时代承袭过来的，我没有做过Objective-C的应用，这只是我的猜测。<br>新建一个项目，通常会生成一个<code>XXXApp.swift</code>的文件，文件的内容如下：</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token attribute atrule\">@main</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">XXXApp</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">App</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">Scene</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">WindowGroup</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>我们要添加一行代码，变成如下这样：</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token attribute atrule\">@main</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">ByteCatApp</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">App</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token attribute atrule\">@NSApplicationDelegateAdaptor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> appDelegate\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">Scene</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">WindowGroup</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>加入了<code>@NSApplicationDelegateAdaptor(AppDelegate.self) var appDelegate</code>这一行，现在开始写<code>AppDelegate</code>的代码。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NSApplicationDelegate</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">var</span> statusItem<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSStatusItem</span><span class=\"token operator\">!</span>\n    <span class=\"token keyword\">var</span> popover<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSPopover</span><span class=\"token operator\">!</span>\n    \n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">applicationDidFinishLaunching</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> notification<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Notification</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">setupStatusBarItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">setupPopover</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">setupStatusBarItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        statusItem <span class=\"token operator\">=</span> <span class=\"token class-name\">NSStatusBar</span><span class=\"token punctuation\">.</span>system<span class=\"token punctuation\">.</span><span class=\"token function\">statusItem</span><span class=\"token punctuation\">(</span>withLength<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSStatusItem</span><span class=\"token punctuation\">.</span>squareLength<span class=\"token punctuation\">)</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> button <span class=\"token operator\">=</span> statusItem<span class=\"token punctuation\">.</span>button <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">let</span> imageSize <span class=\"token operator\">=</span> <span class=\"token class-name\">NSSize</span><span class=\"token punctuation\">(</span>width<span class=\"token punctuation\">:</span> <span class=\"token number\">22</span><span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">:</span> <span class=\"token number\">22</span><span class=\"token punctuation\">)</span>\n            button<span class=\"token punctuation\">.</span>image <span class=\"token operator\">=</span> <span class=\"token class-name\">NSImage</span><span class=\"token punctuation\">(</span>named<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"TrayIcon\"</span></span><span class=\"token punctuation\">)</span>\n            button<span class=\"token punctuation\">.</span>image<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span>size <span class=\"token operator\">=</span> imageSize\n            button<span class=\"token punctuation\">.</span>action <span class=\"token operator\">=</span> <span class=\"token other-directive property\">#selector</span><span class=\"token punctuation\">(</span><span class=\"token function\">togglePopover</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">setupPopover</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        popover <span class=\"token operator\">=</span> <span class=\"token class-name\">NSPopover</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        popover<span class=\"token punctuation\">.</span>behavior <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span>transient\n        popover<span class=\"token punctuation\">.</span>contentViewController <span class=\"token operator\">=</span> <span class=\"token class-name\">PopoverViewController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">makeNSViewController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token attribute atrule\">@objc</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">togglePopover</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> sender<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyObject</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">if</span> popover<span class=\"token punctuation\">.</span>isShown <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token function\">closePopover</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token function\">showPopover</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">showPopover</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> sender<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyObject</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> button <span class=\"token operator\">=</span> statusItem<span class=\"token punctuation\">.</span>button <span class=\"token punctuation\">&#123;</span>\n            popover<span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span>relativeTo<span class=\"token punctuation\">:</span> button<span class=\"token punctuation\">.</span>bounds<span class=\"token punctuation\">,</span> of<span class=\"token punctuation\">:</span> button<span class=\"token punctuation\">,</span> preferredEdge<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSRectEdge</span><span class=\"token punctuation\">.</span>minY<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">closePopover</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> sender<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyObject</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        popover<span class=\"token punctuation\">.</span><span class=\"token function\">performClose</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">PopoverViewController</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSViewControllerRepresentable</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">makeNSViewController</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Context</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">NSViewController</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">makeNSViewController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">makeNSViewController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">NSViewController</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">let</span> viewController <span class=\"token operator\">=</span> <span class=\"token class-name\">NSViewController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        viewController<span class=\"token punctuation\">.</span>view <span class=\"token operator\">=</span> <span class=\"token class-name\">NSHostingView</span><span class=\"token punctuation\">(</span>rootView<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> viewController\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">updateNSViewController</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> nsViewController<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSViewController</span><span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Context</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// Update code if needed</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<h2 id=\"方案二：MenuBarExtra\"><a href=\"#方案二：MenuBarExtra\" class=\"headerlink\" title=\"方案二：MenuBarExtra\"></a>方案二：MenuBarExtra</h2><pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token attribute atrule\">@main</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">XXXApp</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">App</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">Scene</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">MenuBarExtra</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span> label<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span>systemName<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"tray.2.fill\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">.</span><span class=\"token function\">menuBarExtraStyle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>window<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>这个方案就是这么简单，几行代码就搞定，缺点是，弹出的窗口位置不可调整，也不会有一个三角形指向托盘图标的位置，而且窗口位置一直与托盘图标左对齐。</p>\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><h3 id=\"List导致UI异常\"><a href=\"#List导致UI异常\" class=\"headerlink\" title=\"List导致UI异常\"></a>List导致UI异常</h3><p>方案一，当弹出窗口UI中包含了List组件，会使得弹出的窗口显示异常。<br>正常情况是这样的：<br><img src=\"/../images/normal_popover.png\" alt=\"images/normal_popover.png\"><br>异常的情况如下：<br><img src=\"/../images/unnormal_popover.png\" alt=\"images/unnormal_popover.png\"><br>代码的差别，只是把其中的红色布局换成了List组件而已，顶端的三角指向消失了，而且窗口整体上移了。</p>\n<h3 id=\"MenuBarExtra的显示不同\"><a href=\"#MenuBarExtra的显示不同\" class=\"headerlink\" title=\"MenuBarExtra的显示不同\"></a>MenuBarExtra的显示不同</h3><p>使用方案二，窗口弹出是这样的：<br><img src=\"/../images/menu_bar_extra.png\" alt=\"images/menu_bar_extra.png\"><br>同样没有顶部三角指向，固定与托盘图标左对齐。</p>\n<h3 id=\"横向滑动列表不支持鼠标滚轮\"><a href=\"#横向滑动列表不支持鼠标滚轮\" class=\"headerlink\" title=\"横向滑动列表不支持鼠标滚轮\"></a>横向滑动列表不支持鼠标滚轮</h3><p>这并不是某个方案中的问题，而是二者都有的问题，这个应该是SwiftUI的相关组件没有适配macOS所致，这个并没有找到解决办法，似乎苹果也不想解决，毕竟大多数做桌面端app的，都是使用Electron方案，使用原生开发，而且只开发托盘应用的实在是少数。</p>\n<h2 id=\"一点小改进\"><a href=\"#一点小改进\" class=\"headerlink\" title=\"一点小改进\"></a>一点小改进</h2><p>如果你想让托盘应用启动后，只有在托盘中有图标，而在dock栏中没有图标，则需要在Info.plist中，设置一个属性**Application is agent(UIElement)**为YES。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>swiftUI真的不适合在macOS端开发稍微复杂一点的应用，之前开发过一个翻译的应用，只能说勉强够用而已，前提是足够简单。<br>对于托盘应用这个极小的领域来说，尤其不能使用，electron不支持自定义UI的弹出窗口，只支持菜单，而swiftUI支持的情况更糟糕，可能只有原始的Objective-C方案可行了，原始人方案。</p>\n"},{"title":"JustTodo开发(一) 项目初始化","date":"2024-05-11T10:33:00.000Z","_content":"\n正如很多开发者一样，进入一个新平台开发连带学习，通常都会开发一个极简的应用，很多人都会开发Todo类应用，这类应用一般来说比较简单容易上手。我也打算开发一个，一来是练手，二来是写一个自己用的极简Todo类应用。\n目前市面上的Todo类应用，一般来说，都比较复杂，太多我不需要的功能了，而且还有一些增值付费，对于我来说，根本没有那么多的复杂需求，只需要一个随手打开和关闭的记录而已，放在托盘上就非常的方便。\n所以，需求如下：\n1. macOS托盘应用，随手打开和关闭；\n2. 带有分页标签，以便标记不同类型的todo；\n3. 最好有利用iCloud的数据云同步，方便未来与其他平台同步数据；\n\n基于以上需求，做一个技术选型：\n1. 由于SwiftUI在macOS上表现实在是不敢恭维，所以选用传统的AppKit进行开发；\n2. 基于个人写Android应用的习惯，更倾向于使用代码或者XML的方式构建界面，所以在使用AppKit时，不使用Storyboard或者XIB的方式构建界面。\n\n## 一、创建项目\n打开Xcode，创建一个新的macOS项目，语言选择swift，Interface暂时选storyboard，先创建项目，在稍后删除相关的storyboard文件和配置。\n\n## 二、项目配置\n\n### 2.1 删除Main.storyboard\n首先，删除自动创建的storyboard文件Main.storyboard，此时再构建项目会出现错误，先不用着急，接下来进行修改。\n\n### 2.2 替换应用程序入口\n其次，在target目录下，创建一个main.swift文件，然后把AppDelegate.swift中的`@main`注解删除掉，main.swift文件内容如下：\n```swift\nimport Cocoa\n\nclass MyApplication: NSApplication {}\n\nlet app = MyApplication.shared\nlet delegate = AppDelegate()\n\napp.delegate = delegate\napp.run()\n```\n\n### 2.3 创建托盘应用的基本框架\n在AppDelegate.swift文件中，添加相关代码以实现点击托盘图标，主窗口的显示/隐藏。\n创建一个Tray类，用于管理托盘图标的创建和窗口的弹出。\n```swift\nclass Tray {\n    \n    public static let POPOVER_SIZE = NSSize(width: 320, height: 400)\n    \n    private let iconName: String\n    private var statusItem: NSStatusItem!\n    private var popover: NSPopover!\n    private var viewController: NSViewController\n    \n    init(iconName: String, viewController: NSViewController) {\n        self.iconName = iconName\n        self.viewController = viewController\n    }\n    \n    func install() {\n        statusItem = NSStatusBar.system.statusItem(withLength: NSStatusItem.variableLength)\n        \n        if let trayBtn: NSStatusBarButton = statusItem.button {\n            trayBtn.image = NSImage(systemSymbolName: iconName, accessibilityDescription: nil)\n            \n            trayBtn.target = self;\n            trayBtn.action = #selector(togglePopover(_:))\n        }\n        \n        viewController.loadViewIfNeeded()\n        viewController.view.frame = NSRect(x: 0, y: 0, width: Tray.POPOVER_SIZE.width, height: Tray.POPOVER_SIZE.height)\n        \n        popover = NSPopover()\n        popover.contentViewController = viewController\n        \n    }\n    \n    @objc private func togglePopover(_ sender: Any?) {\n        if popover.isShown {\n            closePopover(sender: sender)\n        } else {\n            showPopover(sender: sender)\n        }\n    }\n\n    private func showPopover(sender: Any?) {\n        if let button = statusItem.button {\n            popover.show(relativeTo: button.bounds, of: button, preferredEdge: NSRectEdge.minY)\n        }\n    }\n\n    private func closePopover(sender: Any?) {\n        popover.performClose(sender)\n    }\n    \n}\n```\n此类中，接收两个构造参数，一个是图标名称，对应着资源名称或者是SF Symbols图标名称，另外一个参数就是ViewController的具体实现。\n在AppDelegate中的`applicationDidFinishLaunching`方法中，执行`Tray.install()`，就添加了一个系统图标。\n```swift\nclass AppDelegate: NSObject, NSApplicationDelegate {\n    \n    private let tray = Tray(iconName: \"text.badge.checkmark\", viewController: ViewController())\n    \n    func applicationDidFinishLaunching(_ aNotification: Notification) {\n        tray.install()\n    }\n    \n}\n```\n> 此处需要注意的是，必须要声明一个Tray的成员变量，如果不声明成员变量，则系统图标不会添加成功。\n\n现在在ViewController中，显示一个Hello World。\n```swift\nclass ViewController: NSViewController {\n\n    override func viewDidLoad() {\n        super.viewDidLoad()\n\n        let text = NSTextView()\n        text.translatesAutoresizingMaskIntoConstraints = false\n        text.alignment = .center\n        text.string = \"Hello World\"\n        \n        self.view.addSubview(text)\n        \n        NSLayoutConstraint.activate([\n            text.leadingAnchor.constraint(equalTo: self.view.leadingAnchor),\n            text.trailingAnchor.constraint(equalTo: self.view.trailingAnchor),\n            text.topAnchor.constraint(equalTo: self.view.topAnchor),\n            text.bottomAnchor.constraint(equalTo: self.view.bottomAnchor)\n        ])\n    }\n}\n```\n注意此处的`text.translatesAutoresizingMaskIntoConstraints = false`，这里如果不设置的话，弹出窗口是不会填满整个父布局的。\ntranslatesAutoresizingMaskIntoConstraints 是一个布尔属性，用于指示是否启用自动布局中的自动转换。\n\n在 iOS 和 macOS 开发中，通常使用自动布局来管理界面的布局。自动布局系统使用约束（constraints）来描述视图之间的关系和布局规则。当你通过 Interface Builder 或代码创建视图时，默认情况下，视图的 translatesAutoresizingMaskIntoConstraints 属性是设置为 true 的。这意味着视图会根据其 frame 和 autoresizingMask 属性自动转换为相应的约束。\n\n但是，在使用自动布局时，通常推荐将 translatesAutoresizingMaskIntoConstraints 设置为 false。这样做的原因是，如果你手动创建约束来布局视图，那么这些约束将会和自动转换的约束发生冲突，导致布局问题。通过将 translatesAutoresizingMaskIntoConstraints 设置为 false，你可以明确地告诉系统不要自动转换视图的 autoresizingMask 为约束，从而避免这种冲突。\n\n最终的效果如下：\n![tray_app_hello_world](../images/tray_app_hello_world.png)\n\n另外，若要应用图标不显示在Docker栏上，需要在Info.plist上设置 **Application is agent (UIEelement)** 为YES。","source":"_posts/2024-05-11-JustTodo开发(一) 项目初始化.md","raw":"---\ntitle: JustTodo开发(一) 项目初始化\ndate: 2024-05-11 18:33:00\ncategories: 独立开发笔记\ntags:\n- macOS\n- JustTodo\n---\n\n正如很多开发者一样，进入一个新平台开发连带学习，通常都会开发一个极简的应用，很多人都会开发Todo类应用，这类应用一般来说比较简单容易上手。我也打算开发一个，一来是练手，二来是写一个自己用的极简Todo类应用。\n目前市面上的Todo类应用，一般来说，都比较复杂，太多我不需要的功能了，而且还有一些增值付费，对于我来说，根本没有那么多的复杂需求，只需要一个随手打开和关闭的记录而已，放在托盘上就非常的方便。\n所以，需求如下：\n1. macOS托盘应用，随手打开和关闭；\n2. 带有分页标签，以便标记不同类型的todo；\n3. 最好有利用iCloud的数据云同步，方便未来与其他平台同步数据；\n\n基于以上需求，做一个技术选型：\n1. 由于SwiftUI在macOS上表现实在是不敢恭维，所以选用传统的AppKit进行开发；\n2. 基于个人写Android应用的习惯，更倾向于使用代码或者XML的方式构建界面，所以在使用AppKit时，不使用Storyboard或者XIB的方式构建界面。\n\n## 一、创建项目\n打开Xcode，创建一个新的macOS项目，语言选择swift，Interface暂时选storyboard，先创建项目，在稍后删除相关的storyboard文件和配置。\n\n## 二、项目配置\n\n### 2.1 删除Main.storyboard\n首先，删除自动创建的storyboard文件Main.storyboard，此时再构建项目会出现错误，先不用着急，接下来进行修改。\n\n### 2.2 替换应用程序入口\n其次，在target目录下，创建一个main.swift文件，然后把AppDelegate.swift中的`@main`注解删除掉，main.swift文件内容如下：\n```swift\nimport Cocoa\n\nclass MyApplication: NSApplication {}\n\nlet app = MyApplication.shared\nlet delegate = AppDelegate()\n\napp.delegate = delegate\napp.run()\n```\n\n### 2.3 创建托盘应用的基本框架\n在AppDelegate.swift文件中，添加相关代码以实现点击托盘图标，主窗口的显示/隐藏。\n创建一个Tray类，用于管理托盘图标的创建和窗口的弹出。\n```swift\nclass Tray {\n    \n    public static let POPOVER_SIZE = NSSize(width: 320, height: 400)\n    \n    private let iconName: String\n    private var statusItem: NSStatusItem!\n    private var popover: NSPopover!\n    private var viewController: NSViewController\n    \n    init(iconName: String, viewController: NSViewController) {\n        self.iconName = iconName\n        self.viewController = viewController\n    }\n    \n    func install() {\n        statusItem = NSStatusBar.system.statusItem(withLength: NSStatusItem.variableLength)\n        \n        if let trayBtn: NSStatusBarButton = statusItem.button {\n            trayBtn.image = NSImage(systemSymbolName: iconName, accessibilityDescription: nil)\n            \n            trayBtn.target = self;\n            trayBtn.action = #selector(togglePopover(_:))\n        }\n        \n        viewController.loadViewIfNeeded()\n        viewController.view.frame = NSRect(x: 0, y: 0, width: Tray.POPOVER_SIZE.width, height: Tray.POPOVER_SIZE.height)\n        \n        popover = NSPopover()\n        popover.contentViewController = viewController\n        \n    }\n    \n    @objc private func togglePopover(_ sender: Any?) {\n        if popover.isShown {\n            closePopover(sender: sender)\n        } else {\n            showPopover(sender: sender)\n        }\n    }\n\n    private func showPopover(sender: Any?) {\n        if let button = statusItem.button {\n            popover.show(relativeTo: button.bounds, of: button, preferredEdge: NSRectEdge.minY)\n        }\n    }\n\n    private func closePopover(sender: Any?) {\n        popover.performClose(sender)\n    }\n    \n}\n```\n此类中，接收两个构造参数，一个是图标名称，对应着资源名称或者是SF Symbols图标名称，另外一个参数就是ViewController的具体实现。\n在AppDelegate中的`applicationDidFinishLaunching`方法中，执行`Tray.install()`，就添加了一个系统图标。\n```swift\nclass AppDelegate: NSObject, NSApplicationDelegate {\n    \n    private let tray = Tray(iconName: \"text.badge.checkmark\", viewController: ViewController())\n    \n    func applicationDidFinishLaunching(_ aNotification: Notification) {\n        tray.install()\n    }\n    \n}\n```\n> 此处需要注意的是，必须要声明一个Tray的成员变量，如果不声明成员变量，则系统图标不会添加成功。\n\n现在在ViewController中，显示一个Hello World。\n```swift\nclass ViewController: NSViewController {\n\n    override func viewDidLoad() {\n        super.viewDidLoad()\n\n        let text = NSTextView()\n        text.translatesAutoresizingMaskIntoConstraints = false\n        text.alignment = .center\n        text.string = \"Hello World\"\n        \n        self.view.addSubview(text)\n        \n        NSLayoutConstraint.activate([\n            text.leadingAnchor.constraint(equalTo: self.view.leadingAnchor),\n            text.trailingAnchor.constraint(equalTo: self.view.trailingAnchor),\n            text.topAnchor.constraint(equalTo: self.view.topAnchor),\n            text.bottomAnchor.constraint(equalTo: self.view.bottomAnchor)\n        ])\n    }\n}\n```\n注意此处的`text.translatesAutoresizingMaskIntoConstraints = false`，这里如果不设置的话，弹出窗口是不会填满整个父布局的。\ntranslatesAutoresizingMaskIntoConstraints 是一个布尔属性，用于指示是否启用自动布局中的自动转换。\n\n在 iOS 和 macOS 开发中，通常使用自动布局来管理界面的布局。自动布局系统使用约束（constraints）来描述视图之间的关系和布局规则。当你通过 Interface Builder 或代码创建视图时，默认情况下，视图的 translatesAutoresizingMaskIntoConstraints 属性是设置为 true 的。这意味着视图会根据其 frame 和 autoresizingMask 属性自动转换为相应的约束。\n\n但是，在使用自动布局时，通常推荐将 translatesAutoresizingMaskIntoConstraints 设置为 false。这样做的原因是，如果你手动创建约束来布局视图，那么这些约束将会和自动转换的约束发生冲突，导致布局问题。通过将 translatesAutoresizingMaskIntoConstraints 设置为 false，你可以明确地告诉系统不要自动转换视图的 autoresizingMask 为约束，从而避免这种冲突。\n\n最终的效果如下：\n![tray_app_hello_world](../images/tray_app_hello_world.png)\n\n另外，若要应用图标不显示在Docker栏上，需要在Info.plist上设置 **Application is agent (UIEelement)** 为YES。","slug":"2024-05-11-JustTodo开发(一) 项目初始化","published":1,"updated":"2024-09-25T02:53:02.313Z","comments":1,"layout":"post","photos":["../images/tray_app_hello_world.png"],"_id":"cm1ltr0g5002ubji0cy9e5n26","content":"<p>正如很多开发者一样，进入一个新平台开发连带学习，通常都会开发一个极简的应用，很多人都会开发Todo类应用，这类应用一般来说比较简单容易上手。我也打算开发一个，一来是练手，二来是写一个自己用的极简Todo类应用。<br>目前市面上的Todo类应用，一般来说，都比较复杂，太多我不需要的功能了，而且还有一些增值付费，对于我来说，根本没有那么多的复杂需求，只需要一个随手打开和关闭的记录而已，放在托盘上就非常的方便。<br>所以，需求如下：</p>\n<ol>\n<li>macOS托盘应用，随手打开和关闭；</li>\n<li>带有分页标签，以便标记不同类型的todo；</li>\n<li>最好有利用iCloud的数据云同步，方便未来与其他平台同步数据；</li>\n</ol>\n<p>基于以上需求，做一个技术选型：</p>\n<ol>\n<li>由于SwiftUI在macOS上表现实在是不敢恭维，所以选用传统的AppKit进行开发；</li>\n<li>基于个人写Android应用的习惯，更倾向于使用代码或者XML的方式构建界面，所以在使用AppKit时，不使用Storyboard或者XIB的方式构建界面。</li>\n</ol>\n<h2 id=\"一、创建项目\"><a href=\"#一、创建项目\" class=\"headerlink\" title=\"一、创建项目\"></a>一、创建项目</h2><p>打开Xcode，创建一个新的macOS项目，语言选择swift，Interface暂时选storyboard，先创建项目，在稍后删除相关的storyboard文件和配置。</p>\n<h2 id=\"二、项目配置\"><a href=\"#二、项目配置\" class=\"headerlink\" title=\"二、项目配置\"></a>二、项目配置</h2><h3 id=\"2-1-删除Main-storyboard\"><a href=\"#2-1-删除Main-storyboard\" class=\"headerlink\" title=\"2.1 删除Main.storyboard\"></a>2.1 删除Main.storyboard</h3><p>首先，删除自动创建的storyboard文件Main.storyboard，此时再构建项目会出现错误，先不用着急，接下来进行修改。</p>\n<h3 id=\"2-2-替换应用程序入口\"><a href=\"#2-2-替换应用程序入口\" class=\"headerlink\" title=\"2.2 替换应用程序入口\"></a>2.2 替换应用程序入口</h3><p>其次，在target目录下，创建一个main.swift文件，然后把AppDelegate.swift中的<code>@main</code>注解删除掉，main.swift文件内容如下：</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token class-name\">Cocoa</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MyApplication</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSApplication</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">let</span> app <span class=\"token operator\">=</span> <span class=\"token class-name\">MyApplication</span><span class=\"token punctuation\">.</span>shared\n<span class=\"token keyword\">let</span> delegate <span class=\"token operator\">=</span> <span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span>delegate <span class=\"token operator\">=</span> delegate\napp<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n\n<h3 id=\"2-3-创建托盘应用的基本框架\"><a href=\"#2-3-创建托盘应用的基本框架\" class=\"headerlink\" title=\"2.3 创建托盘应用的基本框架\"></a>2.3 创建托盘应用的基本框架</h3><p>在AppDelegate.swift文件中，添加相关代码以实现点击托盘图标，主窗口的显示&#x2F;隐藏。<br>创建一个Tray类，用于管理托盘图标的创建和窗口的弹出。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Tray</span> <span class=\"token punctuation\">&#123;</span>\n    \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">let</span> <span class=\"token constant\">POPOVER_SIZE</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">NSSize</span><span class=\"token punctuation\">(</span>width<span class=\"token punctuation\">:</span> <span class=\"token number\">320</span><span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">:</span> <span class=\"token number\">400</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> iconName<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> statusItem<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSStatusItem</span><span class=\"token operator\">!</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> popover<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSPopover</span><span class=\"token operator\">!</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> viewController<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSViewController</span>\n    \n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>iconName<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> viewController<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSViewController</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>iconName <span class=\"token operator\">=</span> iconName\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>viewController <span class=\"token operator\">=</span> viewController\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">install</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        statusItem <span class=\"token operator\">=</span> <span class=\"token class-name\">NSStatusBar</span><span class=\"token punctuation\">.</span>system<span class=\"token punctuation\">.</span><span class=\"token function\">statusItem</span><span class=\"token punctuation\">(</span>withLength<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSStatusItem</span><span class=\"token punctuation\">.</span>variableLength<span class=\"token punctuation\">)</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> trayBtn<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSStatusBarButton</span> <span class=\"token operator\">=</span> statusItem<span class=\"token punctuation\">.</span>button <span class=\"token punctuation\">&#123;</span>\n            trayBtn<span class=\"token punctuation\">.</span>image <span class=\"token operator\">=</span> <span class=\"token class-name\">NSImage</span><span class=\"token punctuation\">(</span>systemSymbolName<span class=\"token punctuation\">:</span> iconName<span class=\"token punctuation\">,</span> accessibilityDescription<span class=\"token punctuation\">:</span> <span class=\"token nil constant\">nil</span><span class=\"token punctuation\">)</span>\n            \n            trayBtn<span class=\"token punctuation\">.</span>target <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">;</span>\n            trayBtn<span class=\"token punctuation\">.</span>action <span class=\"token operator\">=</span> <span class=\"token other-directive property\">#selector</span><span class=\"token punctuation\">(</span><span class=\"token function\">togglePopover</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n        \n        viewController<span class=\"token punctuation\">.</span><span class=\"token function\">loadViewIfNeeded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        viewController<span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">.</span>frame <span class=\"token operator\">=</span> <span class=\"token class-name\">NSRect</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Tray</span><span class=\"token punctuation\">.</span><span class=\"token constant\">POPOVER_SIZE</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Tray</span><span class=\"token punctuation\">.</span><span class=\"token constant\">POPOVER_SIZE</span><span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span>\n        \n        popover <span class=\"token operator\">=</span> <span class=\"token class-name\">NSPopover</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        popover<span class=\"token punctuation\">.</span>contentViewController <span class=\"token operator\">=</span> viewController\n        \n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token attribute atrule\">@objc</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">togglePopover</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> sender<span class=\"token punctuation\">:</span> <span class=\"token keyword\">Any</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">if</span> popover<span class=\"token punctuation\">.</span>isShown <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token function\">closePopover</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">:</span> sender<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token function\">showPopover</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">:</span> sender<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">showPopover</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">:</span> <span class=\"token keyword\">Any</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> button <span class=\"token operator\">=</span> statusItem<span class=\"token punctuation\">.</span>button <span class=\"token punctuation\">&#123;</span>\n            popover<span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span>relativeTo<span class=\"token punctuation\">:</span> button<span class=\"token punctuation\">.</span>bounds<span class=\"token punctuation\">,</span> of<span class=\"token punctuation\">:</span> button<span class=\"token punctuation\">,</span> preferredEdge<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSRectEdge</span><span class=\"token punctuation\">.</span>minY<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">closePopover</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">:</span> <span class=\"token keyword\">Any</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        popover<span class=\"token punctuation\">.</span><span class=\"token function\">performClose</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>此类中，接收两个构造参数，一个是图标名称，对应着资源名称或者是SF Symbols图标名称，另外一个参数就是ViewController的具体实现。<br>在AppDelegate中的<code>applicationDidFinishLaunching</code>方法中，执行<code>Tray.install()</code>，就添加了一个系统图标。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NSApplicationDelegate</span> <span class=\"token punctuation\">&#123;</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> tray <span class=\"token operator\">=</span> <span class=\"token class-name\">Tray</span><span class=\"token punctuation\">(</span>iconName<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"text.badge.checkmark\"</span></span><span class=\"token punctuation\">,</span> viewController<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ViewController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">applicationDidFinishLaunching</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> aNotification<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Notification</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        tray<span class=\"token punctuation\">.</span><span class=\"token function\">install</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n<span class=\"token punctuation\">&#125;</span></code></pre>\n<blockquote>\n<p>此处需要注意的是，必须要声明一个Tray的成员变量，如果不声明成员变量，则系统图标不会添加成功。</p>\n</blockquote>\n<p>现在在ViewController中，显示一个Hello World。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewController</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSViewController</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">viewDidLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">viewDidLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">let</span> text <span class=\"token operator\">=</span> <span class=\"token class-name\">NSTextView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        text<span class=\"token punctuation\">.</span>translatesAutoresizingMaskIntoConstraints <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n        text<span class=\"token punctuation\">.</span>alignment <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span>center\n        text<span class=\"token punctuation\">.</span>string <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"Hello World\"</span></span>\n        \n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">.</span><span class=\"token function\">addSubview</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span>\n        \n        <span class=\"token class-name\">NSLayoutConstraint</span><span class=\"token punctuation\">.</span><span class=\"token function\">activate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n            text<span class=\"token punctuation\">.</span>leadingAnchor<span class=\"token punctuation\">.</span><span class=\"token function\">constraint</span><span class=\"token punctuation\">(</span>equalTo<span class=\"token punctuation\">:</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">.</span>leadingAnchor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            text<span class=\"token punctuation\">.</span>trailingAnchor<span class=\"token punctuation\">.</span><span class=\"token function\">constraint</span><span class=\"token punctuation\">(</span>equalTo<span class=\"token punctuation\">:</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">.</span>trailingAnchor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            text<span class=\"token punctuation\">.</span>topAnchor<span class=\"token punctuation\">.</span><span class=\"token function\">constraint</span><span class=\"token punctuation\">(</span>equalTo<span class=\"token punctuation\">:</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">.</span>topAnchor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            text<span class=\"token punctuation\">.</span>bottomAnchor<span class=\"token punctuation\">.</span><span class=\"token function\">constraint</span><span class=\"token punctuation\">(</span>equalTo<span class=\"token punctuation\">:</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">.</span>bottomAnchor<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>注意此处的<code>text.translatesAutoresizingMaskIntoConstraints = false</code>，这里如果不设置的话，弹出窗口是不会填满整个父布局的。<br>translatesAutoresizingMaskIntoConstraints 是一个布尔属性，用于指示是否启用自动布局中的自动转换。</p>\n<p>在 iOS 和 macOS 开发中，通常使用自动布局来管理界面的布局。自动布局系统使用约束（constraints）来描述视图之间的关系和布局规则。当你通过 Interface Builder 或代码创建视图时，默认情况下，视图的 translatesAutoresizingMaskIntoConstraints 属性是设置为 true 的。这意味着视图会根据其 frame 和 autoresizingMask 属性自动转换为相应的约束。</p>\n<p>但是，在使用自动布局时，通常推荐将 translatesAutoresizingMaskIntoConstraints 设置为 false。这样做的原因是，如果你手动创建约束来布局视图，那么这些约束将会和自动转换的约束发生冲突，导致布局问题。通过将 translatesAutoresizingMaskIntoConstraints 设置为 false，你可以明确地告诉系统不要自动转换视图的 autoresizingMask 为约束，从而避免这种冲突。</p>\n<p>最终的效果如下：<br><img src=\"/../images/tray_app_hello_world.png\" alt=\"tray_app_hello_world\"></p>\n<p>另外，若要应用图标不显示在Docker栏上，需要在Info.plist上设置 <strong>Application is agent (UIEelement)</strong> 为YES。</p>\n","excerpt":"","more":"<p>正如很多开发者一样，进入一个新平台开发连带学习，通常都会开发一个极简的应用，很多人都会开发Todo类应用，这类应用一般来说比较简单容易上手。我也打算开发一个，一来是练手，二来是写一个自己用的极简Todo类应用。<br>目前市面上的Todo类应用，一般来说，都比较复杂，太多我不需要的功能了，而且还有一些增值付费，对于我来说，根本没有那么多的复杂需求，只需要一个随手打开和关闭的记录而已，放在托盘上就非常的方便。<br>所以，需求如下：</p>\n<ol>\n<li>macOS托盘应用，随手打开和关闭；</li>\n<li>带有分页标签，以便标记不同类型的todo；</li>\n<li>最好有利用iCloud的数据云同步，方便未来与其他平台同步数据；</li>\n</ol>\n<p>基于以上需求，做一个技术选型：</p>\n<ol>\n<li>由于SwiftUI在macOS上表现实在是不敢恭维，所以选用传统的AppKit进行开发；</li>\n<li>基于个人写Android应用的习惯，更倾向于使用代码或者XML的方式构建界面，所以在使用AppKit时，不使用Storyboard或者XIB的方式构建界面。</li>\n</ol>\n<h2 id=\"一、创建项目\"><a href=\"#一、创建项目\" class=\"headerlink\" title=\"一、创建项目\"></a>一、创建项目</h2><p>打开Xcode，创建一个新的macOS项目，语言选择swift，Interface暂时选storyboard，先创建项目，在稍后删除相关的storyboard文件和配置。</p>\n<h2 id=\"二、项目配置\"><a href=\"#二、项目配置\" class=\"headerlink\" title=\"二、项目配置\"></a>二、项目配置</h2><h3 id=\"2-1-删除Main-storyboard\"><a href=\"#2-1-删除Main-storyboard\" class=\"headerlink\" title=\"2.1 删除Main.storyboard\"></a>2.1 删除Main.storyboard</h3><p>首先，删除自动创建的storyboard文件Main.storyboard，此时再构建项目会出现错误，先不用着急，接下来进行修改。</p>\n<h3 id=\"2-2-替换应用程序入口\"><a href=\"#2-2-替换应用程序入口\" class=\"headerlink\" title=\"2.2 替换应用程序入口\"></a>2.2 替换应用程序入口</h3><p>其次，在target目录下，创建一个main.swift文件，然后把AppDelegate.swift中的<code>@main</code>注解删除掉，main.swift文件内容如下：</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token class-name\">Cocoa</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MyApplication</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSApplication</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">let</span> app <span class=\"token operator\">=</span> <span class=\"token class-name\">MyApplication</span><span class=\"token punctuation\">.</span>shared\n<span class=\"token keyword\">let</span> delegate <span class=\"token operator\">=</span> <span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span>delegate <span class=\"token operator\">=</span> delegate\napp<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n\n<h3 id=\"2-3-创建托盘应用的基本框架\"><a href=\"#2-3-创建托盘应用的基本框架\" class=\"headerlink\" title=\"2.3 创建托盘应用的基本框架\"></a>2.3 创建托盘应用的基本框架</h3><p>在AppDelegate.swift文件中，添加相关代码以实现点击托盘图标，主窗口的显示&#x2F;隐藏。<br>创建一个Tray类，用于管理托盘图标的创建和窗口的弹出。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Tray</span> <span class=\"token punctuation\">&#123;</span>\n    \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">let</span> <span class=\"token constant\">POPOVER_SIZE</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">NSSize</span><span class=\"token punctuation\">(</span>width<span class=\"token punctuation\">:</span> <span class=\"token number\">320</span><span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">:</span> <span class=\"token number\">400</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> iconName<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> statusItem<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSStatusItem</span><span class=\"token operator\">!</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> popover<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSPopover</span><span class=\"token operator\">!</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> viewController<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSViewController</span>\n    \n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>iconName<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> viewController<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSViewController</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>iconName <span class=\"token operator\">=</span> iconName\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>viewController <span class=\"token operator\">=</span> viewController\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">install</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        statusItem <span class=\"token operator\">=</span> <span class=\"token class-name\">NSStatusBar</span><span class=\"token punctuation\">.</span>system<span class=\"token punctuation\">.</span><span class=\"token function\">statusItem</span><span class=\"token punctuation\">(</span>withLength<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSStatusItem</span><span class=\"token punctuation\">.</span>variableLength<span class=\"token punctuation\">)</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> trayBtn<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSStatusBarButton</span> <span class=\"token operator\">=</span> statusItem<span class=\"token punctuation\">.</span>button <span class=\"token punctuation\">&#123;</span>\n            trayBtn<span class=\"token punctuation\">.</span>image <span class=\"token operator\">=</span> <span class=\"token class-name\">NSImage</span><span class=\"token punctuation\">(</span>systemSymbolName<span class=\"token punctuation\">:</span> iconName<span class=\"token punctuation\">,</span> accessibilityDescription<span class=\"token punctuation\">:</span> <span class=\"token nil constant\">nil</span><span class=\"token punctuation\">)</span>\n            \n            trayBtn<span class=\"token punctuation\">.</span>target <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">;</span>\n            trayBtn<span class=\"token punctuation\">.</span>action <span class=\"token operator\">=</span> <span class=\"token other-directive property\">#selector</span><span class=\"token punctuation\">(</span><span class=\"token function\">togglePopover</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n        \n        viewController<span class=\"token punctuation\">.</span><span class=\"token function\">loadViewIfNeeded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        viewController<span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">.</span>frame <span class=\"token operator\">=</span> <span class=\"token class-name\">NSRect</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Tray</span><span class=\"token punctuation\">.</span><span class=\"token constant\">POPOVER_SIZE</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Tray</span><span class=\"token punctuation\">.</span><span class=\"token constant\">POPOVER_SIZE</span><span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span>\n        \n        popover <span class=\"token operator\">=</span> <span class=\"token class-name\">NSPopover</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        popover<span class=\"token punctuation\">.</span>contentViewController <span class=\"token operator\">=</span> viewController\n        \n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token attribute atrule\">@objc</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">togglePopover</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> sender<span class=\"token punctuation\">:</span> <span class=\"token keyword\">Any</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">if</span> popover<span class=\"token punctuation\">.</span>isShown <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token function\">closePopover</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">:</span> sender<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token function\">showPopover</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">:</span> sender<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">showPopover</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">:</span> <span class=\"token keyword\">Any</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> button <span class=\"token operator\">=</span> statusItem<span class=\"token punctuation\">.</span>button <span class=\"token punctuation\">&#123;</span>\n            popover<span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span>relativeTo<span class=\"token punctuation\">:</span> button<span class=\"token punctuation\">.</span>bounds<span class=\"token punctuation\">,</span> of<span class=\"token punctuation\">:</span> button<span class=\"token punctuation\">,</span> preferredEdge<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSRectEdge</span><span class=\"token punctuation\">.</span>minY<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">closePopover</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">:</span> <span class=\"token keyword\">Any</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        popover<span class=\"token punctuation\">.</span><span class=\"token function\">performClose</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>此类中，接收两个构造参数，一个是图标名称，对应着资源名称或者是SF Symbols图标名称，另外一个参数就是ViewController的具体实现。<br>在AppDelegate中的<code>applicationDidFinishLaunching</code>方法中，执行<code>Tray.install()</code>，就添加了一个系统图标。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NSApplicationDelegate</span> <span class=\"token punctuation\">&#123;</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> tray <span class=\"token operator\">=</span> <span class=\"token class-name\">Tray</span><span class=\"token punctuation\">(</span>iconName<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"text.badge.checkmark\"</span></span><span class=\"token punctuation\">,</span> viewController<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ViewController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">applicationDidFinishLaunching</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> aNotification<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Notification</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        tray<span class=\"token punctuation\">.</span><span class=\"token function\">install</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n<span class=\"token punctuation\">&#125;</span></code></pre>\n<blockquote>\n<p>此处需要注意的是，必须要声明一个Tray的成员变量，如果不声明成员变量，则系统图标不会添加成功。</p>\n</blockquote>\n<p>现在在ViewController中，显示一个Hello World。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewController</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSViewController</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">viewDidLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">viewDidLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">let</span> text <span class=\"token operator\">=</span> <span class=\"token class-name\">NSTextView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        text<span class=\"token punctuation\">.</span>translatesAutoresizingMaskIntoConstraints <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n        text<span class=\"token punctuation\">.</span>alignment <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span>center\n        text<span class=\"token punctuation\">.</span>string <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"Hello World\"</span></span>\n        \n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">.</span><span class=\"token function\">addSubview</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span>\n        \n        <span class=\"token class-name\">NSLayoutConstraint</span><span class=\"token punctuation\">.</span><span class=\"token function\">activate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n            text<span class=\"token punctuation\">.</span>leadingAnchor<span class=\"token punctuation\">.</span><span class=\"token function\">constraint</span><span class=\"token punctuation\">(</span>equalTo<span class=\"token punctuation\">:</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">.</span>leadingAnchor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            text<span class=\"token punctuation\">.</span>trailingAnchor<span class=\"token punctuation\">.</span><span class=\"token function\">constraint</span><span class=\"token punctuation\">(</span>equalTo<span class=\"token punctuation\">:</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">.</span>trailingAnchor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            text<span class=\"token punctuation\">.</span>topAnchor<span class=\"token punctuation\">.</span><span class=\"token function\">constraint</span><span class=\"token punctuation\">(</span>equalTo<span class=\"token punctuation\">:</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">.</span>topAnchor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            text<span class=\"token punctuation\">.</span>bottomAnchor<span class=\"token punctuation\">.</span><span class=\"token function\">constraint</span><span class=\"token punctuation\">(</span>equalTo<span class=\"token punctuation\">:</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">.</span>bottomAnchor<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>注意此处的<code>text.translatesAutoresizingMaskIntoConstraints = false</code>，这里如果不设置的话，弹出窗口是不会填满整个父布局的。<br>translatesAutoresizingMaskIntoConstraints 是一个布尔属性，用于指示是否启用自动布局中的自动转换。</p>\n<p>在 iOS 和 macOS 开发中，通常使用自动布局来管理界面的布局。自动布局系统使用约束（constraints）来描述视图之间的关系和布局规则。当你通过 Interface Builder 或代码创建视图时，默认情况下，视图的 translatesAutoresizingMaskIntoConstraints 属性是设置为 true 的。这意味着视图会根据其 frame 和 autoresizingMask 属性自动转换为相应的约束。</p>\n<p>但是，在使用自动布局时，通常推荐将 translatesAutoresizingMaskIntoConstraints 设置为 false。这样做的原因是，如果你手动创建约束来布局视图，那么这些约束将会和自动转换的约束发生冲突，导致布局问题。通过将 translatesAutoresizingMaskIntoConstraints 设置为 false，你可以明确地告诉系统不要自动转换视图的 autoresizingMask 为约束，从而避免这种冲突。</p>\n<p>最终的效果如下：<br><img src=\"/../images/tray_app_hello_world.png\" alt=\"tray_app_hello_world\"></p>\n<p>另外，若要应用图标不显示在Docker栏上，需要在Info.plist上设置 <strong>Application is agent (UIEelement)</strong> 为YES。</p>\n"},{"title":"JustTodo开发(三) 更换技术路线，跑步前进","date":"2024-05-17T15:28:00.000Z","_content":"\n在尝试使用AppKit原生开发界面几天后，我还是放弃了这种尝试了，其羸弱UI表现力，真的是让搭建界面的我心力交瘁。转而，我尝试使用web的形式来开发，即NSPopover中嵌套WKWebView的方式，配合原生层提供一些数据库接口。\n\n经过一番查找，终于找到了一个Material Design风格的Web UI框架[SoberJS](https://soberjs.com/)，作为一个android开发者，对这一套UI相对来说很熟悉了，用起来也驾轻就熟。\n\n经过两天的开发时间，效果图如下：\n![](../images/sober_my_todo.png)\n这样既实现了最初的顶部导航设想，又能加快开发速度。\n\n再次吐槽苹果的原生开发在macOS上真的好吃力。","source":"_posts/2024-05-17-JustTodo开发(三) 更换技术路线，跑步前进.md","raw":"---\ntitle: JustTodo开发(三) 更换技术路线，跑步前进\ndate: 2024-05-17 23:28:00\ncategories: 独立开发笔记\ntags:\n- macOS\n- JustTodo\n---\n\n在尝试使用AppKit原生开发界面几天后，我还是放弃了这种尝试了，其羸弱UI表现力，真的是让搭建界面的我心力交瘁。转而，我尝试使用web的形式来开发，即NSPopover中嵌套WKWebView的方式，配合原生层提供一些数据库接口。\n\n经过一番查找，终于找到了一个Material Design风格的Web UI框架[SoberJS](https://soberjs.com/)，作为一个android开发者，对这一套UI相对来说很熟悉了，用起来也驾轻就熟。\n\n经过两天的开发时间，效果图如下：\n![](../images/sober_my_todo.png)\n这样既实现了最初的顶部导航设想，又能加快开发速度。\n\n再次吐槽苹果的原生开发在macOS上真的好吃力。","slug":"2024-05-17-JustTodo开发(三) 更换技术路线，跑步前进","published":1,"updated":"2024-09-25T02:53:02.319Z","comments":1,"layout":"post","photos":["../images/sober_my_todo.png"],"_id":"cm1ltr0g5002xbji03gck52mp","content":"<p>在尝试使用AppKit原生开发界面几天后，我还是放弃了这种尝试了，其羸弱UI表现力，真的是让搭建界面的我心力交瘁。转而，我尝试使用web的形式来开发，即NSPopover中嵌套WKWebView的方式，配合原生层提供一些数据库接口。</p>\n<p>经过一番查找，终于找到了一个Material Design风格的Web UI框架<a href=\"https://soberjs.com/\">SoberJS</a>，作为一个android开发者，对这一套UI相对来说很熟悉了，用起来也驾轻就熟。</p>\n<p>经过两天的开发时间，效果图如下：<br><img src=\"/../images/sober_my_todo.png\"><br>这样既实现了最初的顶部导航设想，又能加快开发速度。</p>\n<p>再次吐槽苹果的原生开发在macOS上真的好吃力。</p>\n","excerpt":"","more":"<p>在尝试使用AppKit原生开发界面几天后，我还是放弃了这种尝试了，其羸弱UI表现力，真的是让搭建界面的我心力交瘁。转而，我尝试使用web的形式来开发，即NSPopover中嵌套WKWebView的方式，配合原生层提供一些数据库接口。</p>\n<p>经过一番查找，终于找到了一个Material Design风格的Web UI框架<a href=\"https://soberjs.com/\">SoberJS</a>，作为一个android开发者，对这一套UI相对来说很熟悉了，用起来也驾轻就熟。</p>\n<p>经过两天的开发时间，效果图如下：<br><img src=\"/../images/sober_my_todo.png\"><br>这样既实现了最初的顶部导航设想，又能加快开发速度。</p>\n<p>再次吐槽苹果的原生开发在macOS上真的好吃力。</p>\n"},{"title":"JustTodo开发(五) SwiftUI + web","date":"2024-05-26T09:41:00.000Z","_content":"\n初版完成以后，发现了一个问题，就是web中的输入框不接受复制/粘贴的快捷键(cmd+c, cmd+v)，触发快捷键时，会弹“咚”一声系统音，暂时在AppKit下没能解决这个问题，搜了很多资料，比如这里-[Cut/copy/paste keyboard shortcuts not working in NSPopover](https://stackoverflow.com/questions/49637675/cut-copy-paste-keyboard-shortcuts-not-working-in-nspopover)，想要支持这两个快捷键还是很不容易的，其实包括cmd+x, cmd+a也都不支持，但是我想到之前写的同样是托盘应用[Translator](https://github.com/boybeak/TranslatorDocs)，这个就支持这些快捷键，让我突然想到，是不是可以在SwiftUI下，封装一个WKWebView，然后再加载web内容呢？\n\n经过简单验证，封装一个WebView，然后先价值一个最简单的输入框的测试页面，发现这些快捷键是完全工作正常的，所以现在代码已经切换到SwiftUI+web了。\n\n![demo](../images/just-todo.gif)\n接下来的一个功能就是增加tab上的图标显示。\n\n\n**源码地址**: [JustTodo](https://github.com/boybeak/JustTodo)\n**下载地址**: [JustTodo-Releases](https://github.com/boybeak/JustTodo/releases)","source":"_posts/2024-05-26-JustTodo开发(五) SwiftUI + web.md","raw":"---\ntitle: JustTodo开发(五) SwiftUI + web\ndate: 2024-05-26 17:41:00\ncategories: 独立开发笔记\ntags:\n- macOS\n- JustTodo\n---\n\n初版完成以后，发现了一个问题，就是web中的输入框不接受复制/粘贴的快捷键(cmd+c, cmd+v)，触发快捷键时，会弹“咚”一声系统音，暂时在AppKit下没能解决这个问题，搜了很多资料，比如这里-[Cut/copy/paste keyboard shortcuts not working in NSPopover](https://stackoverflow.com/questions/49637675/cut-copy-paste-keyboard-shortcuts-not-working-in-nspopover)，想要支持这两个快捷键还是很不容易的，其实包括cmd+x, cmd+a也都不支持，但是我想到之前写的同样是托盘应用[Translator](https://github.com/boybeak/TranslatorDocs)，这个就支持这些快捷键，让我突然想到，是不是可以在SwiftUI下，封装一个WKWebView，然后再加载web内容呢？\n\n经过简单验证，封装一个WebView，然后先价值一个最简单的输入框的测试页面，发现这些快捷键是完全工作正常的，所以现在代码已经切换到SwiftUI+web了。\n\n![demo](../images/just-todo.gif)\n接下来的一个功能就是增加tab上的图标显示。\n\n\n**源码地址**: [JustTodo](https://github.com/boybeak/JustTodo)\n**下载地址**: [JustTodo-Releases](https://github.com/boybeak/JustTodo/releases)","slug":"2024-05-26-JustTodo开发(五) SwiftUI + web","published":1,"updated":"2024-09-25T02:53:02.323Z","comments":1,"layout":"post","photos":["../images/just-todo.gif"],"_id":"cm1ltr0g50031bji00exq987a","content":"<p>初版完成以后，发现了一个问题，就是web中的输入框不接受复制&#x2F;粘贴的快捷键(cmd+c, cmd+v)，触发快捷键时，会弹“咚”一声系统音，暂时在AppKit下没能解决这个问题，搜了很多资料，比如这里-<a href=\"https://stackoverflow.com/questions/49637675/cut-copy-paste-keyboard-shortcuts-not-working-in-nspopover\">Cut&#x2F;copy&#x2F;paste keyboard shortcuts not working in NSPopover</a>，想要支持这两个快捷键还是很不容易的，其实包括cmd+x, cmd+a也都不支持，但是我想到之前写的同样是托盘应用<a href=\"https://github.com/boybeak/TranslatorDocs\">Translator</a>，这个就支持这些快捷键，让我突然想到，是不是可以在SwiftUI下，封装一个WKWebView，然后再加载web内容呢？</p>\n<p>经过简单验证，封装一个WebView，然后先价值一个最简单的输入框的测试页面，发现这些快捷键是完全工作正常的，所以现在代码已经切换到SwiftUI+web了。</p>\n<p><img src=\"/../images/just-todo.gif\" alt=\"demo\"><br>接下来的一个功能就是增加tab上的图标显示。</p>\n<p><strong>源码地址</strong>: <a href=\"https://github.com/boybeak/JustTodo\">JustTodo</a><br><strong>下载地址</strong>: <a href=\"https://github.com/boybeak/JustTodo/releases\">JustTodo-Releases</a></p>\n","excerpt":"","more":"<p>初版完成以后，发现了一个问题，就是web中的输入框不接受复制&#x2F;粘贴的快捷键(cmd+c, cmd+v)，触发快捷键时，会弹“咚”一声系统音，暂时在AppKit下没能解决这个问题，搜了很多资料，比如这里-<a href=\"https://stackoverflow.com/questions/49637675/cut-copy-paste-keyboard-shortcuts-not-working-in-nspopover\">Cut&#x2F;copy&#x2F;paste keyboard shortcuts not working in NSPopover</a>，想要支持这两个快捷键还是很不容易的，其实包括cmd+x, cmd+a也都不支持，但是我想到之前写的同样是托盘应用<a href=\"https://github.com/boybeak/TranslatorDocs\">Translator</a>，这个就支持这些快捷键，让我突然想到，是不是可以在SwiftUI下，封装一个WKWebView，然后再加载web内容呢？</p>\n<p>经过简单验证，封装一个WebView，然后先价值一个最简单的输入框的测试页面，发现这些快捷键是完全工作正常的，所以现在代码已经切换到SwiftUI+web了。</p>\n<p><img src=\"/../images/just-todo.gif\" alt=\"demo\"><br>接下来的一个功能就是增加tab上的图标显示。</p>\n<p><strong>源码地址</strong>: <a href=\"https://github.com/boybeak/JustTodo\">JustTodo</a><br><strong>下载地址</strong>: <a href=\"https://github.com/boybeak/JustTodo/releases\">JustTodo-Releases</a></p>\n"},{"title":"JustTodo开发(二) 界面初始化","date":"2024-05-12T09:18:00.000Z","_content":"\n## 一、界面布局\n一个简单的界面布局描述如下：\n```css\n---------------------\n|   |               |\n|   |               |\n|   |               |\n| 1 |      2        |\n|   |               |\n|   |               |\n|   |---------------|\n|   |      3        |\n---------------------\n```\n简单分为3个区域：\n1. 导航 - 用于做Todo Item的分类导航，是一个列表；\n2. 内容 - 展示当前分类下的Todo Items；\n3. 输入 - 在当前分类下创建新的Todo。\n\n> 这实际上是一个妥协方案，我的理想方案是简单的上中下三部分，上部分上导航，类似于chrome浏览器顶部页面管理那种，但是macOS对于列表横向滑动的滚轮支持实在是太差了，没有找到成熟的方式实现，妥协成当前这样了\n\n## 二、页面构建\n[上一章]()中，我们有一个用于展示界面的ViewController类，这次要在其中填充上述的布局内容。\n代码可参考[MyTodo](https://github.com/boybeak/MyTodo)，最终实现效果如下：\n![my_todo_ui_init](../images/my_todo_ui_init.png)","source":"_posts/2024-05-12-JustTodo开发(二) 界面初始化.md","raw":"---\ntitle: JustTodo开发(二) 界面初始化\ndate: 2024-05-12 17:18:00\ncategories: 独立开发笔记\ntags:\n- macOS\n- JustTodo\n---\n\n## 一、界面布局\n一个简单的界面布局描述如下：\n```css\n---------------------\n|   |               |\n|   |               |\n|   |               |\n| 1 |      2        |\n|   |               |\n|   |               |\n|   |---------------|\n|   |      3        |\n---------------------\n```\n简单分为3个区域：\n1. 导航 - 用于做Todo Item的分类导航，是一个列表；\n2. 内容 - 展示当前分类下的Todo Items；\n3. 输入 - 在当前分类下创建新的Todo。\n\n> 这实际上是一个妥协方案，我的理想方案是简单的上中下三部分，上部分上导航，类似于chrome浏览器顶部页面管理那种，但是macOS对于列表横向滑动的滚轮支持实在是太差了，没有找到成熟的方式实现，妥协成当前这样了\n\n## 二、页面构建\n[上一章]()中，我们有一个用于展示界面的ViewController类，这次要在其中填充上述的布局内容。\n代码可参考[MyTodo](https://github.com/boybeak/MyTodo)，最终实现效果如下：\n![my_todo_ui_init](../images/my_todo_ui_init.png)","slug":"2024-05-12-JustTodo开发(二) 界面初始化","published":1,"updated":"2024-09-25T02:53:02.315Z","comments":1,"layout":"post","photos":["../images/my_todo_ui_init.png"],"_id":"cm1ltr0g60035bji0egfnd7cg","content":"<h2 id=\"一、界面布局\"><a href=\"#一、界面布局\" class=\"headerlink\" title=\"一、界面布局\"></a>一、界面布局</h2><p>一个简单的界面布局描述如下：</p>\n<pre class=\"language-css\" data-language=\"css\"><code class=\"language-css\">---------------------\n|   |               |\n|   |               |\n|   |               |\n| 1 |      2        |\n|   |               |\n|   |               |\n|   |---------------|\n|   |      3        |\n---------------------</code></pre>\n<p>简单分为3个区域：</p>\n<ol>\n<li>导航 - 用于做Todo Item的分类导航，是一个列表；</li>\n<li>内容 - 展示当前分类下的Todo Items；</li>\n<li>输入 - 在当前分类下创建新的Todo。</li>\n</ol>\n<blockquote>\n<p>这实际上是一个妥协方案，我的理想方案是简单的上中下三部分，上部分上导航，类似于chrome浏览器顶部页面管理那种，但是macOS对于列表横向滑动的滚轮支持实在是太差了，没有找到成熟的方式实现，妥协成当前这样了</p>\n</blockquote>\n<h2 id=\"二、页面构建\"><a href=\"#二、页面构建\" class=\"headerlink\" title=\"二、页面构建\"></a>二、页面构建</h2><p><a href=\"\">上一章</a>中，我们有一个用于展示界面的ViewController类，这次要在其中填充上述的布局内容。<br>代码可参考<a href=\"https://github.com/boybeak/MyTodo\">MyTodo</a>，最终实现效果如下：<br><img src=\"/../images/my_todo_ui_init.png\" alt=\"my_todo_ui_init\"></p>\n","excerpt":"","more":"<h2 id=\"一、界面布局\"><a href=\"#一、界面布局\" class=\"headerlink\" title=\"一、界面布局\"></a>一、界面布局</h2><p>一个简单的界面布局描述如下：</p>\n<pre class=\"language-css\" data-language=\"css\"><code class=\"language-css\">---------------------\n|   |               |\n|   |               |\n|   |               |\n| 1 |      2        |\n|   |               |\n|   |               |\n|   |---------------|\n|   |      3        |\n---------------------</code></pre>\n<p>简单分为3个区域：</p>\n<ol>\n<li>导航 - 用于做Todo Item的分类导航，是一个列表；</li>\n<li>内容 - 展示当前分类下的Todo Items；</li>\n<li>输入 - 在当前分类下创建新的Todo。</li>\n</ol>\n<blockquote>\n<p>这实际上是一个妥协方案，我的理想方案是简单的上中下三部分，上部分上导航，类似于chrome浏览器顶部页面管理那种，但是macOS对于列表横向滑动的滚轮支持实在是太差了，没有找到成熟的方式实现，妥协成当前这样了</p>\n</blockquote>\n<h2 id=\"二、页面构建\"><a href=\"#二、页面构建\" class=\"headerlink\" title=\"二、页面构建\"></a>二、页面构建</h2><p><a href=\"\">上一章</a>中，我们有一个用于展示界面的ViewController类，这次要在其中填充上述的布局内容。<br>代码可参考<a href=\"https://github.com/boybeak/MyTodo\">MyTodo</a>，最终实现效果如下：<br><img src=\"/../images/my_todo_ui_init.png\" alt=\"my_todo_ui_init\"></p>\n"},{"title":"JustTodo开发(四) 初版完成","date":"2024-05-23T13:53:00.000Z","_content":"\n初版已经完成，从切换到SoberJS，基本上只用了一周，便写出来了，如果是使用macOS的原生开发方案，可能现在还困在各种不兼容中。\n![demo](../images/just-todo.gif)\n\n## 基本功能\n1. 创建/删除 Tab；\n2. 创建/标记/删除 Todo笔记；\n3. 右键菜单，关于/退出；\n\n\n**源码地址**: [JustTodo](https://github.com/boybeak/JustTodo)\n**下载地址**: [JustTodo-Releases](https://github.com/boybeak/JustTodo/releases)","source":"_posts/2024-05-23-JustTodo开发(四) 初版完成.md","raw":"---\ntitle: JustTodo开发(四) 初版完成\ndate: 2024-05-23 21:53:00\ncategories: 独立开发笔记\ntags:\n- macOS\n- JustTodo\n---\n\n初版已经完成，从切换到SoberJS，基本上只用了一周，便写出来了，如果是使用macOS的原生开发方案，可能现在还困在各种不兼容中。\n![demo](../images/just-todo.gif)\n\n## 基本功能\n1. 创建/删除 Tab；\n2. 创建/标记/删除 Todo笔记；\n3. 右键菜单，关于/退出；\n\n\n**源码地址**: [JustTodo](https://github.com/boybeak/JustTodo)\n**下载地址**: [JustTodo-Releases](https://github.com/boybeak/JustTodo/releases)","slug":"2024-05-23-JustTodo开发(四) 初版完成","published":1,"updated":"2024-09-25T02:53:02.321Z","comments":1,"layout":"post","photos":["../images/just-todo.gif"],"_id":"cm1ltr0g60039bji08qgaclt8","content":"<p>初版已经完成，从切换到SoberJS，基本上只用了一周，便写出来了，如果是使用macOS的原生开发方案，可能现在还困在各种不兼容中。<br><img src=\"/../images/just-todo.gif\" alt=\"demo\"></p>\n<h2 id=\"基本功能\"><a href=\"#基本功能\" class=\"headerlink\" title=\"基本功能\"></a>基本功能</h2><ol>\n<li>创建&#x2F;删除 Tab；</li>\n<li>创建&#x2F;标记&#x2F;删除 Todo笔记；</li>\n<li>右键菜单，关于&#x2F;退出；</li>\n</ol>\n<p><strong>源码地址</strong>: <a href=\"https://github.com/boybeak/JustTodo\">JustTodo</a><br><strong>下载地址</strong>: <a href=\"https://github.com/boybeak/JustTodo/releases\">JustTodo-Releases</a></p>\n","excerpt":"","more":"<p>初版已经完成，从切换到SoberJS，基本上只用了一周，便写出来了，如果是使用macOS的原生开发方案，可能现在还困在各种不兼容中。<br><img src=\"/../images/just-todo.gif\" alt=\"demo\"></p>\n<h2 id=\"基本功能\"><a href=\"#基本功能\" class=\"headerlink\" title=\"基本功能\"></a>基本功能</h2><ol>\n<li>创建&#x2F;删除 Tab；</li>\n<li>创建&#x2F;标记&#x2F;删除 Todo笔记；</li>\n<li>右键菜单，关于&#x2F;退出；</li>\n</ol>\n<p><strong>源码地址</strong>: <a href=\"https://github.com/boybeak/JustTodo\">JustTodo</a><br><strong>下载地址</strong>: <a href=\"https://github.com/boybeak/JustTodo/releases\">JustTodo-Releases</a></p>\n"},{"title":"发布Swift Package库","date":"2024-06-04T14:19:00.000Z","_content":"\n最近开发[JustTodo](https://github.com/boybeak/JustTodo)时，发觉把处理托盘应用的代码封装起来是很有必要的，这样的话，在以后开发其他应用时，便不需要一而再的写重复代码。以前发布过很多Android平台的类库，但是对于macOS平台的swift库，我还是第一次。\n> 再次吐槽一下苹果生态下的包管理，挺混乱的，最终我选择使用最新的Swift Package Manager\n\n该文章中涉及到的所有代码都在[boybeak/Tray](https://github.com/boybeak/Tray)\n\n## 一、创建Github仓库\n我们需要先创建一个Github仓库，我的仓库名称为Tray，将其clone到本地。\n\n## 二、在仓库目录下，初始化一个Swift Package。\n在Tray仓库目录下，执行以下脚本。\n```shell\nTray % swift package init --type library\n```\n该命令，会自动按照目录名称，初始化一个Swift Package，其目录如下：\n```css\nTray\n  - Package.swift\n  - .gitignore\n  - Sources/\n    - Tray/Tray.swift\n  - Tests/\n    - TrayTests/TrayTests.swift\n```\n其中，Package.swift为库的索引入口，当Xcode在按照Github链接查找库时，会以查到此文件为准则。其内容如下：\n```swift\n// swift-tools-version: 5.10\n// The swift-tools-version declares the minimum version of Swift required to build this package.\n\nimport PackageDescription\n\nlet package = Package(\n    name: \"Tray\",\n    products: [\n        // Products define the executables and libraries a package produces, making them visible to other packages.\n        .library(\n            name: \"Tray\",\n            targets: [\"Tray\"]),\n    ],\n    targets: [\n        // Targets are the basic building blocks of a package, defining a module or a test suite.\n        // Targets can depend on other targets in this package and products from dependencies.\n        .target(\n            name: \"Tray\"),\n        .testTarget(\n            name: \"TrayTests\",\n            dependencies: [\"Tray\"]),\n    ]\n)\n```\n\n## 三、发布库\n补充相关逻辑代码，提交/推送到GitHub，便可以在其他库中使用。不需要特别的发布操作。\n在正式发布前，也可以本地使用，创建一个新项目，在Xcode中，File -> Add Package Denpendencies...，在弹出的管理窗口中，点击**Add Local**按钮，然后选择Tray文件夹，便可以本地使用，同时，你也可以在项目中，直接编辑该库的代码。\n\n提交代码到Github后，你可以把自己的库提交到[Swift Package Index](https://swiftpackageindex.com/)，方便他人查找。进入页面后，点击**Add a package**，进入新页面后，会有一个绿色的**Add Package(s)**按钮，此点击此按钮，会自动跳转到Swift Package Index的Github的issue页面，并会有一个提交模板，输入自己库的Github链接后，提issue，机器人会处理这个issue，并再提一个新的issue，点击链接到新的issue中，点击链接，对你的代码进行code review，注意勾选**viewed**复选框，完成code review后，机器人会自动处理接下来的流程。\n\n## 四、使用库\n在Xcode中，File -> Add Package Denpendencies...，在弹出的管理窗口中，复制`https://github.com/boybeak/Tray.git`到搜索库，然后就可以添加库了。\n","source":"_posts/2024-06-04-发布Swift Package库.md","raw":"---\ntitle: 发布Swift Package库\ndate: 2024-06-04 22:19:00\ncategories: 独立开发笔记\ntags:\n- macOS\n---\n\n最近开发[JustTodo](https://github.com/boybeak/JustTodo)时，发觉把处理托盘应用的代码封装起来是很有必要的，这样的话，在以后开发其他应用时，便不需要一而再的写重复代码。以前发布过很多Android平台的类库，但是对于macOS平台的swift库，我还是第一次。\n> 再次吐槽一下苹果生态下的包管理，挺混乱的，最终我选择使用最新的Swift Package Manager\n\n该文章中涉及到的所有代码都在[boybeak/Tray](https://github.com/boybeak/Tray)\n\n## 一、创建Github仓库\n我们需要先创建一个Github仓库，我的仓库名称为Tray，将其clone到本地。\n\n## 二、在仓库目录下，初始化一个Swift Package。\n在Tray仓库目录下，执行以下脚本。\n```shell\nTray % swift package init --type library\n```\n该命令，会自动按照目录名称，初始化一个Swift Package，其目录如下：\n```css\nTray\n  - Package.swift\n  - .gitignore\n  - Sources/\n    - Tray/Tray.swift\n  - Tests/\n    - TrayTests/TrayTests.swift\n```\n其中，Package.swift为库的索引入口，当Xcode在按照Github链接查找库时，会以查到此文件为准则。其内容如下：\n```swift\n// swift-tools-version: 5.10\n// The swift-tools-version declares the minimum version of Swift required to build this package.\n\nimport PackageDescription\n\nlet package = Package(\n    name: \"Tray\",\n    products: [\n        // Products define the executables and libraries a package produces, making them visible to other packages.\n        .library(\n            name: \"Tray\",\n            targets: [\"Tray\"]),\n    ],\n    targets: [\n        // Targets are the basic building blocks of a package, defining a module or a test suite.\n        // Targets can depend on other targets in this package and products from dependencies.\n        .target(\n            name: \"Tray\"),\n        .testTarget(\n            name: \"TrayTests\",\n            dependencies: [\"Tray\"]),\n    ]\n)\n```\n\n## 三、发布库\n补充相关逻辑代码，提交/推送到GitHub，便可以在其他库中使用。不需要特别的发布操作。\n在正式发布前，也可以本地使用，创建一个新项目，在Xcode中，File -> Add Package Denpendencies...，在弹出的管理窗口中，点击**Add Local**按钮，然后选择Tray文件夹，便可以本地使用，同时，你也可以在项目中，直接编辑该库的代码。\n\n提交代码到Github后，你可以把自己的库提交到[Swift Package Index](https://swiftpackageindex.com/)，方便他人查找。进入页面后，点击**Add a package**，进入新页面后，会有一个绿色的**Add Package(s)**按钮，此点击此按钮，会自动跳转到Swift Package Index的Github的issue页面，并会有一个提交模板，输入自己库的Github链接后，提issue，机器人会处理这个issue，并再提一个新的issue，点击链接到新的issue中，点击链接，对你的代码进行code review，注意勾选**viewed**复选框，完成code review后，机器人会自动处理接下来的流程。\n\n## 四、使用库\n在Xcode中，File -> Add Package Denpendencies...，在弹出的管理窗口中，复制`https://github.com/boybeak/Tray.git`到搜索库，然后就可以添加库了。\n","slug":"2024-06-04-发布Swift Package库","published":1,"updated":"2024-09-25T02:53:02.325Z","comments":1,"layout":"post","photos":[],"_id":"cm1ltr0g6003dbji04bhc0h91","content":"<p>最近开发<a href=\"https://github.com/boybeak/JustTodo\">JustTodo</a>时，发觉把处理托盘应用的代码封装起来是很有必要的，这样的话，在以后开发其他应用时，便不需要一而再的写重复代码。以前发布过很多Android平台的类库，但是对于macOS平台的swift库，我还是第一次。</p>\n<blockquote>\n<p>再次吐槽一下苹果生态下的包管理，挺混乱的，最终我选择使用最新的Swift Package Manager</p>\n</blockquote>\n<p>该文章中涉及到的所有代码都在<a href=\"https://github.com/boybeak/Tray\">boybeak&#x2F;Tray</a></p>\n<h2 id=\"一、创建Github仓库\"><a href=\"#一、创建Github仓库\" class=\"headerlink\" title=\"一、创建Github仓库\"></a>一、创建Github仓库</h2><p>我们需要先创建一个Github仓库，我的仓库名称为Tray，将其clone到本地。</p>\n<h2 id=\"二、在仓库目录下，初始化一个Swift-Package。\"><a href=\"#二、在仓库目录下，初始化一个Swift-Package。\" class=\"headerlink\" title=\"二、在仓库目录下，初始化一个Swift Package。\"></a>二、在仓库目录下，初始化一个Swift Package。</h2><p>在Tray仓库目录下，执行以下脚本。</p>\n<pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">Tray % swift package init <span class=\"token parameter variable\">--type</span> library</code></pre>\n<p>该命令，会自动按照目录名称，初始化一个Swift Package，其目录如下：</p>\n<pre class=\"language-css\" data-language=\"css\"><code class=\"language-css\">Tray\n  - Package.swift\n  - .gitignore\n  - Sources/\n    - Tray/Tray.swift\n  - Tests/\n    - TrayTests/TrayTests.swift</code></pre>\n<p>其中，Package.swift为库的索引入口，当Xcode在按照Github链接查找库时，会以查到此文件为准则。其内容如下：</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token comment\">// swift-tools-version: 5.10</span>\n<span class=\"token comment\">// The swift-tools-version declares the minimum version of Swift required to build this package.</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">PackageDescription</span>\n\n<span class=\"token keyword\">let</span> package <span class=\"token operator\">=</span> <span class=\"token class-name\">Package</span><span class=\"token punctuation\">(</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Tray\"</span></span><span class=\"token punctuation\">,</span>\n    products<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token comment\">// Products define the executables and libraries a package produces, making them visible to other packages.</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">library</span><span class=\"token punctuation\">(</span>\n            name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Tray\"</span></span><span class=\"token punctuation\">,</span>\n            targets<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"Tray\"</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    targets<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token comment\">// Targets are the basic building blocks of a package, defining a module or a test suite.</span>\n        <span class=\"token comment\">// Targets can depend on other targets in this package and products from dependencies.</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">target</span><span class=\"token punctuation\">(</span>\n            name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Tray\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">testTarget</span><span class=\"token punctuation\">(</span>\n            name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"TrayTests\"</span></span><span class=\"token punctuation\">,</span>\n            dependencies<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"Tray\"</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">)</span></code></pre>\n\n<h2 id=\"三、发布库\"><a href=\"#三、发布库\" class=\"headerlink\" title=\"三、发布库\"></a>三、发布库</h2><p>补充相关逻辑代码，提交&#x2F;推送到GitHub，便可以在其他库中使用。不需要特别的发布操作。<br>在正式发布前，也可以本地使用，创建一个新项目，在Xcode中，File -&gt; Add Package Denpendencies…，在弹出的管理窗口中，点击<strong>Add Local</strong>按钮，然后选择Tray文件夹，便可以本地使用，同时，你也可以在项目中，直接编辑该库的代码。</p>\n<p>提交代码到Github后，你可以把自己的库提交到<a href=\"https://swiftpackageindex.com/\">Swift Package Index</a>，方便他人查找。进入页面后，点击<strong>Add a package</strong>，进入新页面后，会有一个绿色的<strong>Add Package(s)<strong>按钮，此点击此按钮，会自动跳转到Swift Package Index的Github的issue页面，并会有一个提交模板，输入自己库的Github链接后，提issue，机器人会处理这个issue，并再提一个新的issue，点击链接到新的issue中，点击链接，对你的代码进行code review，注意勾选</strong>viewed</strong>复选框，完成code review后，机器人会自动处理接下来的流程。</p>\n<h2 id=\"四、使用库\"><a href=\"#四、使用库\" class=\"headerlink\" title=\"四、使用库\"></a>四、使用库</h2><p>在Xcode中，File -&gt; Add Package Denpendencies…，在弹出的管理窗口中，复制<code>https://github.com/boybeak/Tray.git</code>到搜索库，然后就可以添加库了。</p>\n","excerpt":"","more":"<p>最近开发<a href=\"https://github.com/boybeak/JustTodo\">JustTodo</a>时，发觉把处理托盘应用的代码封装起来是很有必要的，这样的话，在以后开发其他应用时，便不需要一而再的写重复代码。以前发布过很多Android平台的类库，但是对于macOS平台的swift库，我还是第一次。</p>\n<blockquote>\n<p>再次吐槽一下苹果生态下的包管理，挺混乱的，最终我选择使用最新的Swift Package Manager</p>\n</blockquote>\n<p>该文章中涉及到的所有代码都在<a href=\"https://github.com/boybeak/Tray\">boybeak&#x2F;Tray</a></p>\n<h2 id=\"一、创建Github仓库\"><a href=\"#一、创建Github仓库\" class=\"headerlink\" title=\"一、创建Github仓库\"></a>一、创建Github仓库</h2><p>我们需要先创建一个Github仓库，我的仓库名称为Tray，将其clone到本地。</p>\n<h2 id=\"二、在仓库目录下，初始化一个Swift-Package。\"><a href=\"#二、在仓库目录下，初始化一个Swift-Package。\" class=\"headerlink\" title=\"二、在仓库目录下，初始化一个Swift Package。\"></a>二、在仓库目录下，初始化一个Swift Package。</h2><p>在Tray仓库目录下，执行以下脚本。</p>\n<pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">Tray % swift package init <span class=\"token parameter variable\">--type</span> library</code></pre>\n<p>该命令，会自动按照目录名称，初始化一个Swift Package，其目录如下：</p>\n<pre class=\"language-css\" data-language=\"css\"><code class=\"language-css\">Tray\n  - Package.swift\n  - .gitignore\n  - Sources/\n    - Tray/Tray.swift\n  - Tests/\n    - TrayTests/TrayTests.swift</code></pre>\n<p>其中，Package.swift为库的索引入口，当Xcode在按照Github链接查找库时，会以查到此文件为准则。其内容如下：</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token comment\">// swift-tools-version: 5.10</span>\n<span class=\"token comment\">// The swift-tools-version declares the minimum version of Swift required to build this package.</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">PackageDescription</span>\n\n<span class=\"token keyword\">let</span> package <span class=\"token operator\">=</span> <span class=\"token class-name\">Package</span><span class=\"token punctuation\">(</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Tray\"</span></span><span class=\"token punctuation\">,</span>\n    products<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token comment\">// Products define the executables and libraries a package produces, making them visible to other packages.</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">library</span><span class=\"token punctuation\">(</span>\n            name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Tray\"</span></span><span class=\"token punctuation\">,</span>\n            targets<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"Tray\"</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    targets<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token comment\">// Targets are the basic building blocks of a package, defining a module or a test suite.</span>\n        <span class=\"token comment\">// Targets can depend on other targets in this package and products from dependencies.</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">target</span><span class=\"token punctuation\">(</span>\n            name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Tray\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">testTarget</span><span class=\"token punctuation\">(</span>\n            name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"TrayTests\"</span></span><span class=\"token punctuation\">,</span>\n            dependencies<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"Tray\"</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">)</span></code></pre>\n\n<h2 id=\"三、发布库\"><a href=\"#三、发布库\" class=\"headerlink\" title=\"三、发布库\"></a>三、发布库</h2><p>补充相关逻辑代码，提交&#x2F;推送到GitHub，便可以在其他库中使用。不需要特别的发布操作。<br>在正式发布前，也可以本地使用，创建一个新项目，在Xcode中，File -&gt; Add Package Denpendencies…，在弹出的管理窗口中，点击<strong>Add Local</strong>按钮，然后选择Tray文件夹，便可以本地使用，同时，你也可以在项目中，直接编辑该库的代码。</p>\n<p>提交代码到Github后，你可以把自己的库提交到<a href=\"https://swiftpackageindex.com/\">Swift Package Index</a>，方便他人查找。进入页面后，点击<strong>Add a package</strong>，进入新页面后，会有一个绿色的<strong>Add Package(s)<strong>按钮，此点击此按钮，会自动跳转到Swift Package Index的Github的issue页面，并会有一个提交模板，输入自己库的Github链接后，提issue，机器人会处理这个issue，并再提一个新的issue，点击链接到新的issue中，点击链接，对你的代码进行code review，注意勾选</strong>viewed</strong>复选框，完成code review后，机器人会自动处理接下来的流程。</p>\n<h2 id=\"四、使用库\"><a href=\"#四、使用库\" class=\"headerlink\" title=\"四、使用库\"></a>四、使用库</h2><p>在Xcode中，File -&gt; Add Package Denpendencies…，在弹出的管理窗口中，复制<code>https://github.com/boybeak/Tray.git</code>到搜索库，然后就可以添加库了。</p>\n"},{"title":"Tray - macOS菜单栏app开发库","date":"2024-06-14T07:15:00.000Z","_content":"\n最近开发了[JustTodo](https://github.com/boybeak/JustTodo)和[DeskNote](https://github.com/boybeak/DeskNote)两个macOS应用，都是启动入口在菜单栏的，通过菜单栏上图标点击，快速执行相关操作，这让我想起我开发第一款菜单栏app [Translator](https://github.com/boybeak/TranslatorDocs)时的痛苦。因为想使用最新的SwiftUI作为UI框架，但是此框架构建菜单栏app的资料很少，大多数都是生成一个简单菜单，而不是可以自定义的复杂界面，尤其是用swiftUI构建的界面。\n为了解决这一痛点，在总结了[JustTodo](https://github.com/boybeak/JustTodo)和[DeskNote](https://github.com/boybeak/DeskNote)两个macOS应用开发经验后，决心自己做了一个菜单栏应用快捷库[Tray](https://github.com/boybeak/Tray)，方便以后使用。\n\n## 一、引入\n在macOS项目中，点击**File** -> **Add Package Dependencies ...**，在包管理窗口的搜索框中，复制粘贴`https://github.com/boybeak/Tray.git`，待检索到库信息，点击**Add Package**按钮。\n\n## 二、使用\n以SwiftUI应用为例，在代码入口处，声明一个`AppDelegate`.\n\n### 2.1 初始化\n```swift\n@main\nstruct DeskNoteApp: App {\n\n    @NSApplicationDelegateAdaptor(AppDelegate.self) var app: AppDelegate\n\n    var body: some Scene {\n        Settings {}\n    }\n}\n```\n> 这里body中的`Settings {}`代码，是为了隐藏启动时的主窗口。\n\n然后创建AppDelegate类。\n```swift\nclass AppDelegate: NSObject, NSApplicationDelegate {\n\n    private var tray: Tray!\n    \n    func applicationDidFinishLaunching(_ notification: Notification) {\n\n        tray = Tray.install(named: \"TrayIcon\") { tray in \n            self.configTray(tray: tray)\n        }\n    }\n}\n```\n引入相关的类Tray并声明我们的托盘管理对象`var tray: Tray`，并在`applicationDidFinishLaunching`中为改对象赋值，传入资源文件名称，或者使用`SF Symbols`也可以，只是参数名要改为systemSymbolName，如果有更多要求，也可以直接以icon为参数名，传入一个NSImage对象。\n然后在闭包中配置tray.\n\n### 2.2 配置托盘信息\n\n```swift\nfunc configTray(tray: Tray) {\n    // 配置左键弹出view\n    tray.setView(content: ContentView())\n}\n```\n这里设置的是一个SwiftUI的View，你也可以设置NSView或者NSViewController，除了界面参数，还有其他三个可选参数：\n1. behavior: NSPopover的behavior，默认值为.transient，即点击窗口以外区域隐藏弹出界面；\n2. level: NSPopover的窗口层级，默认为.floating；\n3. size: NSPopover的大小，默认为nil，即使用View自己配置的大小；\n\n在JustTodo应用中，其效果如下图：\n![](../images/just-todo.gif)\n\n到这里，主要的配置就完成了，如果你不想弹出一个NSPopover，你也可以接管托盘图标的左键事件。\n```swift\ntray.setOnLeftClick {\n    return true\n}\n```\n返回true，表示事件完全处理，会阻止默认行为。默认行为就是弹出NSPopover，前提是设置了view。比如在DeskNote中，我接管了此事件，改为弹出笔记的编辑页面。\n![](../images/dest-note.gif)\n当然，同样你也可以为右键增加事件。\n```swift\ntray.setOnRightClick {\n    return true\n}\n```\n返回true，表示事件完成处理，阻止默认行为。默认行为是弹出菜单，前提是设置了菜单，正如下边代码。\n```swift\nlet menu = NSMenu()\n        \nlet newNoteMenuItem = NSMenuItem(title: NSLocalizedString(\"Menu_item_new_note\", comment: \"\"), action: #selector(onNewNoteAction), keyEquivalent: \"\")\nlet quitMenuItem = NSMenuItem(title: NSLocalizedString(\"Menu_item_quit\", comment: \"\"), action: #selector(onQuitAction), keyEquivalent: \"\")\n\nmenu.addItem(newNoteMenuItem)\nmenu.addItem(quitMenuItem)\n\ntray.setMenu(menu: menu)\n```\n效果如下：\n![](../images/dest-note-right.gif)\n\n这就是一些基本的使用和配置步骤。接下来是一些相关的小建议。\n\n## 三、建议\n### 3.1 托盘图标尺寸\n1x: 18*18\n2x: 36*36\n3x: 54*54\n\n### 3.2 隐藏Docker栏中应用的图标\n在Info.plist中，增加一个配置项: **Application is agent(UIElement)** - **YES**.","source":"_posts/2024-06-14-Tray-macOS菜单栏app开发库.md","raw":"---\ntitle: Tray - macOS菜单栏app开发库\ndate: 2024-06-14 15:15:00\ncategories: 独立开发笔记\ntags:\n- macOS\n---\n\n最近开发了[JustTodo](https://github.com/boybeak/JustTodo)和[DeskNote](https://github.com/boybeak/DeskNote)两个macOS应用，都是启动入口在菜单栏的，通过菜单栏上图标点击，快速执行相关操作，这让我想起我开发第一款菜单栏app [Translator](https://github.com/boybeak/TranslatorDocs)时的痛苦。因为想使用最新的SwiftUI作为UI框架，但是此框架构建菜单栏app的资料很少，大多数都是生成一个简单菜单，而不是可以自定义的复杂界面，尤其是用swiftUI构建的界面。\n为了解决这一痛点，在总结了[JustTodo](https://github.com/boybeak/JustTodo)和[DeskNote](https://github.com/boybeak/DeskNote)两个macOS应用开发经验后，决心自己做了一个菜单栏应用快捷库[Tray](https://github.com/boybeak/Tray)，方便以后使用。\n\n## 一、引入\n在macOS项目中，点击**File** -> **Add Package Dependencies ...**，在包管理窗口的搜索框中，复制粘贴`https://github.com/boybeak/Tray.git`，待检索到库信息，点击**Add Package**按钮。\n\n## 二、使用\n以SwiftUI应用为例，在代码入口处，声明一个`AppDelegate`.\n\n### 2.1 初始化\n```swift\n@main\nstruct DeskNoteApp: App {\n\n    @NSApplicationDelegateAdaptor(AppDelegate.self) var app: AppDelegate\n\n    var body: some Scene {\n        Settings {}\n    }\n}\n```\n> 这里body中的`Settings {}`代码，是为了隐藏启动时的主窗口。\n\n然后创建AppDelegate类。\n```swift\nclass AppDelegate: NSObject, NSApplicationDelegate {\n\n    private var tray: Tray!\n    \n    func applicationDidFinishLaunching(_ notification: Notification) {\n\n        tray = Tray.install(named: \"TrayIcon\") { tray in \n            self.configTray(tray: tray)\n        }\n    }\n}\n```\n引入相关的类Tray并声明我们的托盘管理对象`var tray: Tray`，并在`applicationDidFinishLaunching`中为改对象赋值，传入资源文件名称，或者使用`SF Symbols`也可以，只是参数名要改为systemSymbolName，如果有更多要求，也可以直接以icon为参数名，传入一个NSImage对象。\n然后在闭包中配置tray.\n\n### 2.2 配置托盘信息\n\n```swift\nfunc configTray(tray: Tray) {\n    // 配置左键弹出view\n    tray.setView(content: ContentView())\n}\n```\n这里设置的是一个SwiftUI的View，你也可以设置NSView或者NSViewController，除了界面参数，还有其他三个可选参数：\n1. behavior: NSPopover的behavior，默认值为.transient，即点击窗口以外区域隐藏弹出界面；\n2. level: NSPopover的窗口层级，默认为.floating；\n3. size: NSPopover的大小，默认为nil，即使用View自己配置的大小；\n\n在JustTodo应用中，其效果如下图：\n![](../images/just-todo.gif)\n\n到这里，主要的配置就完成了，如果你不想弹出一个NSPopover，你也可以接管托盘图标的左键事件。\n```swift\ntray.setOnLeftClick {\n    return true\n}\n```\n返回true，表示事件完全处理，会阻止默认行为。默认行为就是弹出NSPopover，前提是设置了view。比如在DeskNote中，我接管了此事件，改为弹出笔记的编辑页面。\n![](../images/dest-note.gif)\n当然，同样你也可以为右键增加事件。\n```swift\ntray.setOnRightClick {\n    return true\n}\n```\n返回true，表示事件完成处理，阻止默认行为。默认行为是弹出菜单，前提是设置了菜单，正如下边代码。\n```swift\nlet menu = NSMenu()\n        \nlet newNoteMenuItem = NSMenuItem(title: NSLocalizedString(\"Menu_item_new_note\", comment: \"\"), action: #selector(onNewNoteAction), keyEquivalent: \"\")\nlet quitMenuItem = NSMenuItem(title: NSLocalizedString(\"Menu_item_quit\", comment: \"\"), action: #selector(onQuitAction), keyEquivalent: \"\")\n\nmenu.addItem(newNoteMenuItem)\nmenu.addItem(quitMenuItem)\n\ntray.setMenu(menu: menu)\n```\n效果如下：\n![](../images/dest-note-right.gif)\n\n这就是一些基本的使用和配置步骤。接下来是一些相关的小建议。\n\n## 三、建议\n### 3.1 托盘图标尺寸\n1x: 18*18\n2x: 36*36\n3x: 54*54\n\n### 3.2 隐藏Docker栏中应用的图标\n在Info.plist中，增加一个配置项: **Application is agent(UIElement)** - **YES**.","slug":"2024-06-14-Tray-macOS菜单栏app开发库","published":1,"updated":"2024-09-25T02:53:02.327Z","comments":1,"layout":"post","photos":["../images/just-todo.gif","../images/dest-note.gif","../images/dest-note-right.gif"],"_id":"cm1ltr0g6003fbji01j6y3a1u","content":"<p>最近开发了<a href=\"https://github.com/boybeak/JustTodo\">JustTodo</a>和<a href=\"https://github.com/boybeak/DeskNote\">DeskNote</a>两个macOS应用，都是启动入口在菜单栏的，通过菜单栏上图标点击，快速执行相关操作，这让我想起我开发第一款菜单栏app <a href=\"https://github.com/boybeak/TranslatorDocs\">Translator</a>时的痛苦。因为想使用最新的SwiftUI作为UI框架，但是此框架构建菜单栏app的资料很少，大多数都是生成一个简单菜单，而不是可以自定义的复杂界面，尤其是用swiftUI构建的界面。<br>为了解决这一痛点，在总结了<a href=\"https://github.com/boybeak/JustTodo\">JustTodo</a>和<a href=\"https://github.com/boybeak/DeskNote\">DeskNote</a>两个macOS应用开发经验后，决心自己做了一个菜单栏应用快捷库<a href=\"https://github.com/boybeak/Tray\">Tray</a>，方便以后使用。</p>\n<h2 id=\"一、引入\"><a href=\"#一、引入\" class=\"headerlink\" title=\"一、引入\"></a>一、引入</h2><p>在macOS项目中，点击<strong>File</strong> -&gt; <strong>Add Package Dependencies …<strong>，在包管理窗口的搜索框中，复制粘贴<code>https://github.com/boybeak/Tray.git</code>，待检索到库信息，点击</strong>Add Package</strong>按钮。</p>\n<h2 id=\"二、使用\"><a href=\"#二、使用\" class=\"headerlink\" title=\"二、使用\"></a>二、使用</h2><p>以SwiftUI应用为例，在代码入口处，声明一个<code>AppDelegate</code>.</p>\n<h3 id=\"2-1-初始化\"><a href=\"#2-1-初始化\" class=\"headerlink\" title=\"2.1 初始化\"></a>2.1 初始化</h3><pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token attribute atrule\">@main</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">DeskNoteApp</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">App</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token attribute atrule\">@NSApplicationDelegateAdaptor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> app<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AppDelegate</span>\n\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">Scene</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">Settings</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<blockquote>\n<p>这里body中的<code>Settings &#123;&#125;</code>代码，是为了隐藏启动时的主窗口。</p>\n</blockquote>\n<p>然后创建AppDelegate类。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NSApplicationDelegate</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> tray<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Tray</span><span class=\"token operator\">!</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">applicationDidFinishLaunching</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> notification<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Notification</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\n        tray <span class=\"token operator\">=</span> <span class=\"token class-name\">Tray</span><span class=\"token punctuation\">.</span><span class=\"token function\">install</span><span class=\"token punctuation\">(</span>named<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"TrayIcon\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> tray <span class=\"token keyword\">in</span> \n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">configTray</span><span class=\"token punctuation\">(</span>tray<span class=\"token punctuation\">:</span> tray<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>引入相关的类Tray并声明我们的托盘管理对象<code>var tray: Tray</code>，并在<code>applicationDidFinishLaunching</code>中为改对象赋值，传入资源文件名称，或者使用<code>SF Symbols</code>也可以，只是参数名要改为systemSymbolName，如果有更多要求，也可以直接以icon为参数名，传入一个NSImage对象。<br>然后在闭包中配置tray.</p>\n<h3 id=\"2-2-配置托盘信息\"><a href=\"#2-2-配置托盘信息\" class=\"headerlink\" title=\"2.2 配置托盘信息\"></a>2.2 配置托盘信息</h3><pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">configTray</span><span class=\"token punctuation\">(</span>tray<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Tray</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 配置左键弹出view</span>\n    tray<span class=\"token punctuation\">.</span><span class=\"token function\">setView</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>这里设置的是一个SwiftUI的View，你也可以设置NSView或者NSViewController，除了界面参数，还有其他三个可选参数：</p>\n<ol>\n<li>behavior: NSPopover的behavior，默认值为.transient，即点击窗口以外区域隐藏弹出界面；</li>\n<li>level: NSPopover的窗口层级，默认为.floating；</li>\n<li>size: NSPopover的大小，默认为nil，即使用View自己配置的大小；</li>\n</ol>\n<p>在JustTodo应用中，其效果如下图：<br><img src=\"/../images/just-todo.gif\"></p>\n<p>到这里，主要的配置就完成了，如果你不想弹出一个NSPopover，你也可以接管托盘图标的左键事件。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\">tray<span class=\"token punctuation\">.</span>setOnLeftClick <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>返回true，表示事件完全处理，会阻止默认行为。默认行为就是弹出NSPopover，前提是设置了view。比如在DeskNote中，我接管了此事件，改为弹出笔记的编辑页面。<br><img src=\"/../images/dest-note.gif\"><br>当然，同样你也可以为右键增加事件。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\">tray<span class=\"token punctuation\">.</span>setOnRightClick <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>返回true，表示事件完成处理，阻止默认行为。默认行为是弹出菜单，前提是设置了菜单，正如下边代码。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> menu <span class=\"token operator\">=</span> <span class=\"token class-name\">NSMenu</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        \n<span class=\"token keyword\">let</span> newNoteMenuItem <span class=\"token operator\">=</span> <span class=\"token class-name\">NSMenuItem</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSLocalizedString</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Menu_item_new_note\"</span></span><span class=\"token punctuation\">,</span> comment<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">:</span> <span class=\"token other-directive property\">#selector</span><span class=\"token punctuation\">(</span>onNewNoteAction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> keyEquivalent<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> quitMenuItem <span class=\"token operator\">=</span> <span class=\"token class-name\">NSMenuItem</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSLocalizedString</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Menu_item_quit\"</span></span><span class=\"token punctuation\">,</span> comment<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">:</span> <span class=\"token other-directive property\">#selector</span><span class=\"token punctuation\">(</span>onQuitAction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> keyEquivalent<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"\"</span></span><span class=\"token punctuation\">)</span>\n\nmenu<span class=\"token punctuation\">.</span><span class=\"token function\">addItem</span><span class=\"token punctuation\">(</span>newNoteMenuItem<span class=\"token punctuation\">)</span>\nmenu<span class=\"token punctuation\">.</span><span class=\"token function\">addItem</span><span class=\"token punctuation\">(</span>quitMenuItem<span class=\"token punctuation\">)</span>\n\ntray<span class=\"token punctuation\">.</span><span class=\"token function\">setMenu</span><span class=\"token punctuation\">(</span>menu<span class=\"token punctuation\">:</span> menu<span class=\"token punctuation\">)</span></code></pre>\n<p>效果如下：<br><img src=\"/../images/dest-note-right.gif\"></p>\n<p>这就是一些基本的使用和配置步骤。接下来是一些相关的小建议。</p>\n<h2 id=\"三、建议\"><a href=\"#三、建议\" class=\"headerlink\" title=\"三、建议\"></a>三、建议</h2><h3 id=\"3-1-托盘图标尺寸\"><a href=\"#3-1-托盘图标尺寸\" class=\"headerlink\" title=\"3.1 托盘图标尺寸\"></a>3.1 托盘图标尺寸</h3><p>1x: 18<em>18<br>2x: 36</em>36<br>3x: 54*54</p>\n<h3 id=\"3-2-隐藏Docker栏中应用的图标\"><a href=\"#3-2-隐藏Docker栏中应用的图标\" class=\"headerlink\" title=\"3.2 隐藏Docker栏中应用的图标\"></a>3.2 隐藏Docker栏中应用的图标</h3><p>在Info.plist中，增加一个配置项: <strong>Application is agent(UIElement)</strong> - <strong>YES</strong>.</p>\n","excerpt":"","more":"<p>最近开发了<a href=\"https://github.com/boybeak/JustTodo\">JustTodo</a>和<a href=\"https://github.com/boybeak/DeskNote\">DeskNote</a>两个macOS应用，都是启动入口在菜单栏的，通过菜单栏上图标点击，快速执行相关操作，这让我想起我开发第一款菜单栏app <a href=\"https://github.com/boybeak/TranslatorDocs\">Translator</a>时的痛苦。因为想使用最新的SwiftUI作为UI框架，但是此框架构建菜单栏app的资料很少，大多数都是生成一个简单菜单，而不是可以自定义的复杂界面，尤其是用swiftUI构建的界面。<br>为了解决这一痛点，在总结了<a href=\"https://github.com/boybeak/JustTodo\">JustTodo</a>和<a href=\"https://github.com/boybeak/DeskNote\">DeskNote</a>两个macOS应用开发经验后，决心自己做了一个菜单栏应用快捷库<a href=\"https://github.com/boybeak/Tray\">Tray</a>，方便以后使用。</p>\n<h2 id=\"一、引入\"><a href=\"#一、引入\" class=\"headerlink\" title=\"一、引入\"></a>一、引入</h2><p>在macOS项目中，点击<strong>File</strong> -&gt; <strong>Add Package Dependencies …<strong>，在包管理窗口的搜索框中，复制粘贴<code>https://github.com/boybeak/Tray.git</code>，待检索到库信息，点击</strong>Add Package</strong>按钮。</p>\n<h2 id=\"二、使用\"><a href=\"#二、使用\" class=\"headerlink\" title=\"二、使用\"></a>二、使用</h2><p>以SwiftUI应用为例，在代码入口处，声明一个<code>AppDelegate</code>.</p>\n<h3 id=\"2-1-初始化\"><a href=\"#2-1-初始化\" class=\"headerlink\" title=\"2.1 初始化\"></a>2.1 初始化</h3><pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token attribute atrule\">@main</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">DeskNoteApp</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">App</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token attribute atrule\">@NSApplicationDelegateAdaptor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> app<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AppDelegate</span>\n\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">Scene</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">Settings</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<blockquote>\n<p>这里body中的<code>Settings &#123;&#125;</code>代码，是为了隐藏启动时的主窗口。</p>\n</blockquote>\n<p>然后创建AppDelegate类。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NSApplicationDelegate</span> <span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> tray<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Tray</span><span class=\"token operator\">!</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">applicationDidFinishLaunching</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> notification<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Notification</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\n        tray <span class=\"token operator\">=</span> <span class=\"token class-name\">Tray</span><span class=\"token punctuation\">.</span><span class=\"token function\">install</span><span class=\"token punctuation\">(</span>named<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"TrayIcon\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> tray <span class=\"token keyword\">in</span> \n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">configTray</span><span class=\"token punctuation\">(</span>tray<span class=\"token punctuation\">:</span> tray<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>引入相关的类Tray并声明我们的托盘管理对象<code>var tray: Tray</code>，并在<code>applicationDidFinishLaunching</code>中为改对象赋值，传入资源文件名称，或者使用<code>SF Symbols</code>也可以，只是参数名要改为systemSymbolName，如果有更多要求，也可以直接以icon为参数名，传入一个NSImage对象。<br>然后在闭包中配置tray.</p>\n<h3 id=\"2-2-配置托盘信息\"><a href=\"#2-2-配置托盘信息\" class=\"headerlink\" title=\"2.2 配置托盘信息\"></a>2.2 配置托盘信息</h3><pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">configTray</span><span class=\"token punctuation\">(</span>tray<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Tray</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 配置左键弹出view</span>\n    tray<span class=\"token punctuation\">.</span><span class=\"token function\">setView</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>这里设置的是一个SwiftUI的View，你也可以设置NSView或者NSViewController，除了界面参数，还有其他三个可选参数：</p>\n<ol>\n<li>behavior: NSPopover的behavior，默认值为.transient，即点击窗口以外区域隐藏弹出界面；</li>\n<li>level: NSPopover的窗口层级，默认为.floating；</li>\n<li>size: NSPopover的大小，默认为nil，即使用View自己配置的大小；</li>\n</ol>\n<p>在JustTodo应用中，其效果如下图：<br><img src=\"/../images/just-todo.gif\"></p>\n<p>到这里，主要的配置就完成了，如果你不想弹出一个NSPopover，你也可以接管托盘图标的左键事件。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\">tray<span class=\"token punctuation\">.</span>setOnLeftClick <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>返回true，表示事件完全处理，会阻止默认行为。默认行为就是弹出NSPopover，前提是设置了view。比如在DeskNote中，我接管了此事件，改为弹出笔记的编辑页面。<br><img src=\"/../images/dest-note.gif\"><br>当然，同样你也可以为右键增加事件。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\">tray<span class=\"token punctuation\">.</span>setOnRightClick <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p>返回true，表示事件完成处理，阻止默认行为。默认行为是弹出菜单，前提是设置了菜单，正如下边代码。</p>\n<pre class=\"language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> menu <span class=\"token operator\">=</span> <span class=\"token class-name\">NSMenu</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        \n<span class=\"token keyword\">let</span> newNoteMenuItem <span class=\"token operator\">=</span> <span class=\"token class-name\">NSMenuItem</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSLocalizedString</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Menu_item_new_note\"</span></span><span class=\"token punctuation\">,</span> comment<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">:</span> <span class=\"token other-directive property\">#selector</span><span class=\"token punctuation\">(</span>onNewNoteAction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> keyEquivalent<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> quitMenuItem <span class=\"token operator\">=</span> <span class=\"token class-name\">NSMenuItem</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSLocalizedString</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Menu_item_quit\"</span></span><span class=\"token punctuation\">,</span> comment<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">:</span> <span class=\"token other-directive property\">#selector</span><span class=\"token punctuation\">(</span>onQuitAction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> keyEquivalent<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"\"</span></span><span class=\"token punctuation\">)</span>\n\nmenu<span class=\"token punctuation\">.</span><span class=\"token function\">addItem</span><span class=\"token punctuation\">(</span>newNoteMenuItem<span class=\"token punctuation\">)</span>\nmenu<span class=\"token punctuation\">.</span><span class=\"token function\">addItem</span><span class=\"token punctuation\">(</span>quitMenuItem<span class=\"token punctuation\">)</span>\n\ntray<span class=\"token punctuation\">.</span><span class=\"token function\">setMenu</span><span class=\"token punctuation\">(</span>menu<span class=\"token punctuation\">:</span> menu<span class=\"token punctuation\">)</span></code></pre>\n<p>效果如下：<br><img src=\"/../images/dest-note-right.gif\"></p>\n<p>这就是一些基本的使用和配置步骤。接下来是一些相关的小建议。</p>\n<h2 id=\"三、建议\"><a href=\"#三、建议\" class=\"headerlink\" title=\"三、建议\"></a>三、建议</h2><h3 id=\"3-1-托盘图标尺寸\"><a href=\"#3-1-托盘图标尺寸\" class=\"headerlink\" title=\"3.1 托盘图标尺寸\"></a>3.1 托盘图标尺寸</h3><p>1x: 18<em>18<br>2x: 36</em>36<br>3x: 54*54</p>\n<h3 id=\"3-2-隐藏Docker栏中应用的图标\"><a href=\"#3-2-隐藏Docker栏中应用的图标\" class=\"headerlink\" title=\"3.2 隐藏Docker栏中应用的图标\"></a>3.2 隐藏Docker栏中应用的图标</h3><p>在Info.plist中，增加一个配置项: <strong>Application is agent(UIElement)</strong> - <strong>YES</strong>.</p>\n"},{"title":"面试笔记","date":"2024-06-16T09:03:00.000Z","_content":"\n边独立，边面试，两手都要抓，两手都要硬。\n### 1. 给定数组array与一个数字num，要求从array中找出两个数，其和为num，并返回这两个数的下标\n```kotlin\nfun findTwoSum(array: IntArray, num: Int): Pair<Int, Int>? {\n    // 创建一个哈希表来存储数组中的数字及其索引\n    val map = mutableMapOf<Int, Int>()\n\n    // 遍历数组\n    for (i in array.indices) {\n        val complement = num - array[i]\n\n        // 检查哈希表中是否存在这个补数\n        if (map.containsKey(complement)) {\n            // 如果存在，返回这个数及其补数的索引\n            return Pair(map[complement]!!, i)\n        }\n\n        // 将当前数字及其索引存入哈希表\n        map[array[i]] = i\n    }\n\n    // 如果没有找到符合条件的数对，返回null\n    return null\n}\n```\n**解读：**\n1. 创建一个map，在遍历的过程中，报错所有数字以及其对应的坐标，数字为键，坐标为值；\n2. 遍历时，计算出num与当前元素的差值，然后试图从map中索引，如果有索引，则命中，如果没有则继续遍历；\n3. map的作用，相当于取代了双层遍历法其中的一层遍历；\n\n### 2. jvm如何判断一个对象可以被回收？\n1. 引用计数法\n优点：实现简单，时间复杂度低；\n缺点：无法解决循环引用问题；\n2. 可达性分析算法\n通过GC Roots开始标记所有可达的对象；可以被标记的，认为是活的对象，未被标记的，则认为已经不需要，可以被回收；\n\n#### 2.1 有哪些可以作为GC Root?\n- 虚拟机栈（栈帧中的本地变量表）中引用的对象。\n- 方法区中的类静态属性引用的对象。\n- 方法区中常量引用的对象。\n- 本地方法栈中JNI（即Native方法）引用的对象。\n\n#### 2.2 垃圾回收的过程是怎样的？\n有三种策略：\n- 标记清除：首先标记所有可达对象，然后清除所有未被标记的对象；\n- 复制算法：将存活的对象，从一块内存复制到另外一块内存，然后清空原来的内存；\n- 标记-压缩： 首先标记所有可达的对象，然后将所有存活的对象压缩到内存的一端，清除便捷以外的空间；\n\n### 3. Android的Handler是如何造成内存泄露的？\n 非静态内部类或者匿名内部类，会隐式的持有外部类的对象，如果在Activity中声明一个Handler，而Handler执行延迟任务，在任务结束前，Activity已经被销毁了，则Activiey泄露了；\n\n #### 3.1 如何解决Handler的内存泄露？\n 1. 将`Handler`声明为静态内部类，并且使用弱引用持有外部类的引用；\n 2. 在Activity的onDestroy中，使用`Handler`的`removeCallbacksAndMessages`方法，移除所有未执行的消息和回调；\n\n #### 3.2 有没有非Activity的其他内存泄露的场景？\n 1. 单例持有外部对象；\n 2. 静态持有外部对象；\n 3. 未取消注册监听器或者回调；\n 4. WebView导致内存泄露；\n 5. 异步任务；\n 总结来说，就是生命周期长的对象，持有了一个生命周期短的对象的引用；\n\n ### 4. 应用启动白屏如何排查？如何解决？\n1. 在应用入口，比如Application的onCreate、启动Activity的onCreate中，做耗时检查，如果耗时异常，具体检查代码；\n2. 如果是Activity的onCreate中耗时长，检查是否为布局过于复杂，造成的布局解析耗时长，可以使用异步布局处理；\n3. 如果为系统机制问题导致，可以配置主题或者使用Splash库来做过渡；\n\n### 5. 线上问题如何排查？\n1. 运营种子用户，提前内测，按照用户反馈，复现问题场景；\n2. 集成bugly等线上日志抓取工具，按照机型、系统等信息，复现问题场景；\n3. 如果有可能，可以通过热更新修复问题；\n\n### 6. 不同任务类型(IO密集型/计算密集型)任务，如何分配线程池策略？\n#### IO密集型任务\n**特点**\nIO密集型任务主要涉及等待外部资源（如文件系统、网络请求、数据库操作等），因此大部分时间处于等待状态，而非消耗CPU。\n\n**策略**\n对于IO密集型任务，可以使用较大的线程池，因为线程在等待IO操作完成时不会消耗大量CPU资源。\n\n**线程池配置**\n通常，线程池的大小可以设置为CPU核心数的2倍或更多。一个常见的公式是：\n\n```bash\n线程池大小 = CPU核心数 * 2\n或更大，根据实际情况调整。\n```\n\n```java\nimport java.util.concurrent.Executors;\nimport java.util.concurrent.ExecutorService;\n\npublic class IOIntensiveTaskExample {\n    private static final int N_THREADS = Runtime.getRuntime().availableProcessors() * 2;\n\n    public static void main(String[] args) {\n        ExecutorService ioThreadPool = Executors.newFixedThreadPool(N_THREADS);\n\n        for (int i = 0; i < 100; i++) {\n            ioThreadPool.submit(() -> {\n                // 模拟IO操作\n                performIOOperation();\n            });\n        }\n\n        ioThreadPool.shutdown();\n    }\n\n    private static void performIOOperation() {\n        try {\n            // 模拟IO操作\n            Thread.sleep(1000);\n        } catch (InterruptedException e) {\n            Thread.currentThread().interrupt();\n        }\n    }\n}\n```\n\n#### 计算密集型任务\n**特点**\n计算密集型任务主要消耗CPU资源，执行过程中几乎不涉及等待时间，因此可以充分利用CPU。\n\n**策略**\n对于计算密集型任务，线程池的大小应设置为接近CPU核心数。过多的线程会导致频繁的上下文切换，反而降低性能。\n\n**线程池配置**\n通常，线程池的大小可以设置为CPU核心数。一个常见的公式是：\n\n```bash\n线程池大小 = CPU核心数\n```\n\n```java\nimport java.util.concurrent.Executors;\nimport java.util.concurrent.ExecutorService;\n\npublic class CPUIntensiveTaskExample {\n    private static final int N_THREADS = Runtime.getRuntime().availableProcessors();\n\n    public static void main(String[] args) {\n        ExecutorService cpuThreadPool = Executors.newFixedThreadPool(N_THREADS);\n\n        for (int i = 0; i < 100; i++) {\n            cpuThreadPool.submit(() -> {\n                // 模拟计算操作\n                performCPUTask();\n            });\n        }\n\n        cpuThreadPool.shutdown();\n    }\n\n    private static void performCPUTask() {\n        // 模拟计算操作\n        for (int i = 0; i < 1000000; i++) {\n            Math.pow(i, 2);\n        }\n    }\n}\n```\n**混合任务**\n在实际应用中，有些任务可能既包含IO操作又包含计算操作。这种情况下，可以考虑使用不同的线程池分别处理不同类型的任务，或者根据任务的主要特征选择适当的线程池配置。\n\n```java\nimport java.util.concurrent.Executors;\nimport java.util.concurrent.ExecutorService;\n\npublic class MixedTaskExample {\n    private static final int IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;\n    private static final int CPU_THREADS = Runtime.getRuntime().availableProcessors();\n\n    public static void main(String[] args) {\n        ExecutorService ioThreadPool = Executors.newFixedThreadPool(IO_THREADS);\n        ExecutorService cpuThreadPool = Executors.newFixedThreadPool(CPU_THREADS);\n\n        for (int i = 0; i < 100; i++) {\n            ioThreadPool.submit(() -> {\n                // 模拟IO操作\n                performIOOperation();\n            });\n\n            cpuThreadPool.submit(() -> {\n                // 模拟计算操作\n                performCPUTask();\n            });\n        }\n\n        ioThreadPool.shutdown();\n        cpuThreadPool.shutdown();\n    }\n\n    private static void performIOOperation() {\n        try {\n            // 模拟IO操作\n            Thread.sleep(1000);\n        } catch (InterruptedException e) {\n            Thread.currentThread().interrupt();\n        }\n    }\n\n    private static void performCPUTask() {\n        // 模拟计算操作\n        for (int i = 0; i < 1000000; i++) {\n            Math.pow(i, 2);\n        }\n    }\n}\n```\n#### 总结\n**IO密集型任务**：使用较大的线程池，通常为CPU核心数的2倍或更多，以应对大量的IO等待时间。\n**计算密集型任务**：使用较小的线程池，接近CPU核心数，以充分利用CPU资源，避免过多的线程上下文切换。\n**混合任务**：根据任务的主要特征，分别使用不同的线程池处理IO操作和计算操作。\n通过合理配置线程池，可以有效提高应用程序的性能和资源利用率。","source":"_posts/2024-06-16-面试总结1.md","raw":"---\ntitle: 面试笔记\ndate: 2024-06-16 17:03:00\ncategories: 面试笔记\ntags:\n- 面试\n---\n\n边独立，边面试，两手都要抓，两手都要硬。\n### 1. 给定数组array与一个数字num，要求从array中找出两个数，其和为num，并返回这两个数的下标\n```kotlin\nfun findTwoSum(array: IntArray, num: Int): Pair<Int, Int>? {\n    // 创建一个哈希表来存储数组中的数字及其索引\n    val map = mutableMapOf<Int, Int>()\n\n    // 遍历数组\n    for (i in array.indices) {\n        val complement = num - array[i]\n\n        // 检查哈希表中是否存在这个补数\n        if (map.containsKey(complement)) {\n            // 如果存在，返回这个数及其补数的索引\n            return Pair(map[complement]!!, i)\n        }\n\n        // 将当前数字及其索引存入哈希表\n        map[array[i]] = i\n    }\n\n    // 如果没有找到符合条件的数对，返回null\n    return null\n}\n```\n**解读：**\n1. 创建一个map，在遍历的过程中，报错所有数字以及其对应的坐标，数字为键，坐标为值；\n2. 遍历时，计算出num与当前元素的差值，然后试图从map中索引，如果有索引，则命中，如果没有则继续遍历；\n3. map的作用，相当于取代了双层遍历法其中的一层遍历；\n\n### 2. jvm如何判断一个对象可以被回收？\n1. 引用计数法\n优点：实现简单，时间复杂度低；\n缺点：无法解决循环引用问题；\n2. 可达性分析算法\n通过GC Roots开始标记所有可达的对象；可以被标记的，认为是活的对象，未被标记的，则认为已经不需要，可以被回收；\n\n#### 2.1 有哪些可以作为GC Root?\n- 虚拟机栈（栈帧中的本地变量表）中引用的对象。\n- 方法区中的类静态属性引用的对象。\n- 方法区中常量引用的对象。\n- 本地方法栈中JNI（即Native方法）引用的对象。\n\n#### 2.2 垃圾回收的过程是怎样的？\n有三种策略：\n- 标记清除：首先标记所有可达对象，然后清除所有未被标记的对象；\n- 复制算法：将存活的对象，从一块内存复制到另外一块内存，然后清空原来的内存；\n- 标记-压缩： 首先标记所有可达的对象，然后将所有存活的对象压缩到内存的一端，清除便捷以外的空间；\n\n### 3. Android的Handler是如何造成内存泄露的？\n 非静态内部类或者匿名内部类，会隐式的持有外部类的对象，如果在Activity中声明一个Handler，而Handler执行延迟任务，在任务结束前，Activity已经被销毁了，则Activiey泄露了；\n\n #### 3.1 如何解决Handler的内存泄露？\n 1. 将`Handler`声明为静态内部类，并且使用弱引用持有外部类的引用；\n 2. 在Activity的onDestroy中，使用`Handler`的`removeCallbacksAndMessages`方法，移除所有未执行的消息和回调；\n\n #### 3.2 有没有非Activity的其他内存泄露的场景？\n 1. 单例持有外部对象；\n 2. 静态持有外部对象；\n 3. 未取消注册监听器或者回调；\n 4. WebView导致内存泄露；\n 5. 异步任务；\n 总结来说，就是生命周期长的对象，持有了一个生命周期短的对象的引用；\n\n ### 4. 应用启动白屏如何排查？如何解决？\n1. 在应用入口，比如Application的onCreate、启动Activity的onCreate中，做耗时检查，如果耗时异常，具体检查代码；\n2. 如果是Activity的onCreate中耗时长，检查是否为布局过于复杂，造成的布局解析耗时长，可以使用异步布局处理；\n3. 如果为系统机制问题导致，可以配置主题或者使用Splash库来做过渡；\n\n### 5. 线上问题如何排查？\n1. 运营种子用户，提前内测，按照用户反馈，复现问题场景；\n2. 集成bugly等线上日志抓取工具，按照机型、系统等信息，复现问题场景；\n3. 如果有可能，可以通过热更新修复问题；\n\n### 6. 不同任务类型(IO密集型/计算密集型)任务，如何分配线程池策略？\n#### IO密集型任务\n**特点**\nIO密集型任务主要涉及等待外部资源（如文件系统、网络请求、数据库操作等），因此大部分时间处于等待状态，而非消耗CPU。\n\n**策略**\n对于IO密集型任务，可以使用较大的线程池，因为线程在等待IO操作完成时不会消耗大量CPU资源。\n\n**线程池配置**\n通常，线程池的大小可以设置为CPU核心数的2倍或更多。一个常见的公式是：\n\n```bash\n线程池大小 = CPU核心数 * 2\n或更大，根据实际情况调整。\n```\n\n```java\nimport java.util.concurrent.Executors;\nimport java.util.concurrent.ExecutorService;\n\npublic class IOIntensiveTaskExample {\n    private static final int N_THREADS = Runtime.getRuntime().availableProcessors() * 2;\n\n    public static void main(String[] args) {\n        ExecutorService ioThreadPool = Executors.newFixedThreadPool(N_THREADS);\n\n        for (int i = 0; i < 100; i++) {\n            ioThreadPool.submit(() -> {\n                // 模拟IO操作\n                performIOOperation();\n            });\n        }\n\n        ioThreadPool.shutdown();\n    }\n\n    private static void performIOOperation() {\n        try {\n            // 模拟IO操作\n            Thread.sleep(1000);\n        } catch (InterruptedException e) {\n            Thread.currentThread().interrupt();\n        }\n    }\n}\n```\n\n#### 计算密集型任务\n**特点**\n计算密集型任务主要消耗CPU资源，执行过程中几乎不涉及等待时间，因此可以充分利用CPU。\n\n**策略**\n对于计算密集型任务，线程池的大小应设置为接近CPU核心数。过多的线程会导致频繁的上下文切换，反而降低性能。\n\n**线程池配置**\n通常，线程池的大小可以设置为CPU核心数。一个常见的公式是：\n\n```bash\n线程池大小 = CPU核心数\n```\n\n```java\nimport java.util.concurrent.Executors;\nimport java.util.concurrent.ExecutorService;\n\npublic class CPUIntensiveTaskExample {\n    private static final int N_THREADS = Runtime.getRuntime().availableProcessors();\n\n    public static void main(String[] args) {\n        ExecutorService cpuThreadPool = Executors.newFixedThreadPool(N_THREADS);\n\n        for (int i = 0; i < 100; i++) {\n            cpuThreadPool.submit(() -> {\n                // 模拟计算操作\n                performCPUTask();\n            });\n        }\n\n        cpuThreadPool.shutdown();\n    }\n\n    private static void performCPUTask() {\n        // 模拟计算操作\n        for (int i = 0; i < 1000000; i++) {\n            Math.pow(i, 2);\n        }\n    }\n}\n```\n**混合任务**\n在实际应用中，有些任务可能既包含IO操作又包含计算操作。这种情况下，可以考虑使用不同的线程池分别处理不同类型的任务，或者根据任务的主要特征选择适当的线程池配置。\n\n```java\nimport java.util.concurrent.Executors;\nimport java.util.concurrent.ExecutorService;\n\npublic class MixedTaskExample {\n    private static final int IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;\n    private static final int CPU_THREADS = Runtime.getRuntime().availableProcessors();\n\n    public static void main(String[] args) {\n        ExecutorService ioThreadPool = Executors.newFixedThreadPool(IO_THREADS);\n        ExecutorService cpuThreadPool = Executors.newFixedThreadPool(CPU_THREADS);\n\n        for (int i = 0; i < 100; i++) {\n            ioThreadPool.submit(() -> {\n                // 模拟IO操作\n                performIOOperation();\n            });\n\n            cpuThreadPool.submit(() -> {\n                // 模拟计算操作\n                performCPUTask();\n            });\n        }\n\n        ioThreadPool.shutdown();\n        cpuThreadPool.shutdown();\n    }\n\n    private static void performIOOperation() {\n        try {\n            // 模拟IO操作\n            Thread.sleep(1000);\n        } catch (InterruptedException e) {\n            Thread.currentThread().interrupt();\n        }\n    }\n\n    private static void performCPUTask() {\n        // 模拟计算操作\n        for (int i = 0; i < 1000000; i++) {\n            Math.pow(i, 2);\n        }\n    }\n}\n```\n#### 总结\n**IO密集型任务**：使用较大的线程池，通常为CPU核心数的2倍或更多，以应对大量的IO等待时间。\n**计算密集型任务**：使用较小的线程池，接近CPU核心数，以充分利用CPU资源，避免过多的线程上下文切换。\n**混合任务**：根据任务的主要特征，分别使用不同的线程池处理IO操作和计算操作。\n通过合理配置线程池，可以有效提高应用程序的性能和资源利用率。","slug":"2024-06-16-面试总结1","published":1,"updated":"2024-09-25T02:53:02.334Z","comments":1,"layout":"post","photos":[],"_id":"cm1ltr0g6003jbji0e5mk9oh1","content":"<p>边独立，边面试，两手都要抓，两手都要硬。</p>\n<h3 id=\"1-给定数组array与一个数字num，要求从array中找出两个数，其和为num，并返回这两个数的下标\"><a href=\"#1-给定数组array与一个数字num，要求从array中找出两个数，其和为num，并返回这两个数的下标\" class=\"headerlink\" title=\"1. 给定数组array与一个数字num，要求从array中找出两个数，其和为num，并返回这两个数的下标\"></a>1. 给定数组array与一个数字num，要求从array中找出两个数，其和为num，并返回这两个数的下标</h3><pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">findTwoSum</span><span class=\"token punctuation\">(</span>array<span class=\"token operator\">:</span> IntArray<span class=\"token punctuation\">,</span> num<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Pair<span class=\"token operator\">&lt;</span>Int<span class=\"token punctuation\">,</span> Int<span class=\"token operator\">></span><span class=\"token operator\">?</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 创建一个哈希表来存储数组中的数字及其索引</span>\n    <span class=\"token keyword\">val</span> map <span class=\"token operator\">=</span> mutableMapOf<span class=\"token operator\">&lt;</span>Int<span class=\"token punctuation\">,</span> Int<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// 遍历数组</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token keyword\">in</span> array<span class=\"token punctuation\">.</span>indices<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">val</span> complement <span class=\"token operator\">=</span> num <span class=\"token operator\">-</span> array<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n\n        <span class=\"token comment\">// 检查哈希表中是否存在这个补数</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>map<span class=\"token punctuation\">.</span><span class=\"token function\">containsKey</span><span class=\"token punctuation\">(</span>complement<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">// 如果存在，返回这个数及其补数的索引</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">Pair</span><span class=\"token punctuation\">(</span>map<span class=\"token punctuation\">[</span>complement<span class=\"token punctuation\">]</span><span class=\"token operator\">!!</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token comment\">// 将当前数字及其索引存入哈希表</span>\n        map<span class=\"token punctuation\">[</span>array<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> i\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token comment\">// 如果没有找到符合条件的数对，返回null</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p><strong>解读：</strong></p>\n<ol>\n<li>创建一个map，在遍历的过程中，报错所有数字以及其对应的坐标，数字为键，坐标为值；</li>\n<li>遍历时，计算出num与当前元素的差值，然后试图从map中索引，如果有索引，则命中，如果没有则继续遍历；</li>\n<li>map的作用，相当于取代了双层遍历法其中的一层遍历；</li>\n</ol>\n<h3 id=\"2-jvm如何判断一个对象可以被回收？\"><a href=\"#2-jvm如何判断一个对象可以被回收？\" class=\"headerlink\" title=\"2. jvm如何判断一个对象可以被回收？\"></a>2. jvm如何判断一个对象可以被回收？</h3><ol>\n<li>引用计数法<br>优点：实现简单，时间复杂度低；<br>缺点：无法解决循环引用问题；</li>\n<li>可达性分析算法<br>通过GC Roots开始标记所有可达的对象；可以被标记的，认为是活的对象，未被标记的，则认为已经不需要，可以被回收；</li>\n</ol>\n<h4 id=\"2-1-有哪些可以作为GC-Root\"><a href=\"#2-1-有哪些可以作为GC-Root\" class=\"headerlink\" title=\"2.1 有哪些可以作为GC Root?\"></a>2.1 有哪些可以作为GC Root?</h4><ul>\n<li>虚拟机栈（栈帧中的本地变量表）中引用的对象。</li>\n<li>方法区中的类静态属性引用的对象。</li>\n<li>方法区中常量引用的对象。</li>\n<li>本地方法栈中JNI（即Native方法）引用的对象。</li>\n</ul>\n<h4 id=\"2-2-垃圾回收的过程是怎样的？\"><a href=\"#2-2-垃圾回收的过程是怎样的？\" class=\"headerlink\" title=\"2.2 垃圾回收的过程是怎样的？\"></a>2.2 垃圾回收的过程是怎样的？</h4><p>有三种策略：</p>\n<ul>\n<li>标记清除：首先标记所有可达对象，然后清除所有未被标记的对象；</li>\n<li>复制算法：将存活的对象，从一块内存复制到另外一块内存，然后清空原来的内存；</li>\n<li>标记-压缩： 首先标记所有可达的对象，然后将所有存活的对象压缩到内存的一端，清除便捷以外的空间；</li>\n</ul>\n<h3 id=\"3-Android的Handler是如何造成内存泄露的？\"><a href=\"#3-Android的Handler是如何造成内存泄露的？\" class=\"headerlink\" title=\"3. Android的Handler是如何造成内存泄露的？\"></a>3. Android的Handler是如何造成内存泄露的？</h3><p> 非静态内部类或者匿名内部类，会隐式的持有外部类的对象，如果在Activity中声明一个Handler，而Handler执行延迟任务，在任务结束前，Activity已经被销毁了，则Activiey泄露了；</p>\n<h4 id=\"3-1-如何解决Handler的内存泄露？\"><a href=\"#3-1-如何解决Handler的内存泄露？\" class=\"headerlink\" title=\"3.1 如何解决Handler的内存泄露？\"></a>3.1 如何解决Handler的内存泄露？</h4><ol>\n<li>将<code>Handler</code>声明为静态内部类，并且使用弱引用持有外部类的引用；</li>\n<li>在Activity的onDestroy中，使用<code>Handler</code>的<code>removeCallbacksAndMessages</code>方法，移除所有未执行的消息和回调；</li>\n</ol>\n<h4 id=\"3-2-有没有非Activity的其他内存泄露的场景？\"><a href=\"#3-2-有没有非Activity的其他内存泄露的场景？\" class=\"headerlink\" title=\"3.2 有没有非Activity的其他内存泄露的场景？\"></a>3.2 有没有非Activity的其他内存泄露的场景？</h4><ol>\n<li>单例持有外部对象；</li>\n<li>静态持有外部对象；</li>\n<li>未取消注册监听器或者回调；</li>\n<li>WebView导致内存泄露；</li>\n<li>异步任务；<br> 总结来说，就是生命周期长的对象，持有了一个生命周期短的对象的引用；</li>\n</ol>\n<h3 id=\"4-应用启动白屏如何排查？如何解决？\"><a href=\"#4-应用启动白屏如何排查？如何解决？\" class=\"headerlink\" title=\"4. 应用启动白屏如何排查？如何解决？\"></a>4. 应用启动白屏如何排查？如何解决？</h3><ol>\n<li>在应用入口，比如Application的onCreate、启动Activity的onCreate中，做耗时检查，如果耗时异常，具体检查代码；</li>\n<li>如果是Activity的onCreate中耗时长，检查是否为布局过于复杂，造成的布局解析耗时长，可以使用异步布局处理；</li>\n<li>如果为系统机制问题导致，可以配置主题或者使用Splash库来做过渡；</li>\n</ol>\n<h3 id=\"5-线上问题如何排查？\"><a href=\"#5-线上问题如何排查？\" class=\"headerlink\" title=\"5. 线上问题如何排查？\"></a>5. 线上问题如何排查？</h3><ol>\n<li>运营种子用户，提前内测，按照用户反馈，复现问题场景；</li>\n<li>集成bugly等线上日志抓取工具，按照机型、系统等信息，复现问题场景；</li>\n<li>如果有可能，可以通过热更新修复问题；</li>\n</ol>\n<h3 id=\"6-不同任务类型-IO密集型-计算密集型-任务，如何分配线程池策略？\"><a href=\"#6-不同任务类型-IO密集型-计算密集型-任务，如何分配线程池策略？\" class=\"headerlink\" title=\"6. 不同任务类型(IO密集型&#x2F;计算密集型)任务，如何分配线程池策略？\"></a>6. 不同任务类型(IO密集型&#x2F;计算密集型)任务，如何分配线程池策略？</h3><h4 id=\"IO密集型任务\"><a href=\"#IO密集型任务\" class=\"headerlink\" title=\"IO密集型任务\"></a>IO密集型任务</h4><p><strong>特点</strong><br>IO密集型任务主要涉及等待外部资源（如文件系统、网络请求、数据库操作等），因此大部分时间处于等待状态，而非消耗CPU。</p>\n<p><strong>策略</strong><br>对于IO密集型任务，可以使用较大的线程池，因为线程在等待IO操作完成时不会消耗大量CPU资源。</p>\n<p><strong>线程池配置</strong><br>通常，线程池的大小可以设置为CPU核心数的2倍或更多。一个常见的公式是：</p>\n<pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">线程池大小 <span class=\"token operator\">=</span> CPU核心数 * <span class=\"token number\">2</span>\n或更大，根据实际情况调整。</code></pre>\n\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Executors</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ExecutorService</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">IOIntensiveTaskExample</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">N_THREADS</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">availableProcessors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">ExecutorService</span> ioThreadPool <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token constant\">N_THREADS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            ioThreadPool<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token comment\">// 模拟IO操作</span>\n                <span class=\"token function\">performIOOperation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        ioThreadPool<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">performIOOperation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">// 模拟IO操作</span>\n            <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<h4 id=\"计算密集型任务\"><a href=\"#计算密集型任务\" class=\"headerlink\" title=\"计算密集型任务\"></a>计算密集型任务</h4><p><strong>特点</strong><br>计算密集型任务主要消耗CPU资源，执行过程中几乎不涉及等待时间，因此可以充分利用CPU。</p>\n<p><strong>策略</strong><br>对于计算密集型任务，线程池的大小应设置为接近CPU核心数。过多的线程会导致频繁的上下文切换，反而降低性能。</p>\n<p><strong>线程池配置</strong><br>通常，线程池的大小可以设置为CPU核心数。一个常见的公式是：</p>\n<pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">线程池大小 <span class=\"token operator\">=</span> CPU核心数</code></pre>\n\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Executors</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ExecutorService</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CPUIntensiveTaskExample</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">N_THREADS</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">availableProcessors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">ExecutorService</span> cpuThreadPool <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token constant\">N_THREADS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            cpuThreadPool<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token comment\">// 模拟计算操作</span>\n                <span class=\"token function\">performCPUTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        cpuThreadPool<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">performCPUTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 模拟计算操作</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">pow</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p><strong>混合任务</strong><br>在实际应用中，有些任务可能既包含IO操作又包含计算操作。这种情况下，可以考虑使用不同的线程池分别处理不同类型的任务，或者根据任务的主要特征选择适当的线程池配置。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Executors</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ExecutorService</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MixedTaskExample</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">IO_THREADS</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">availableProcessors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">CPU_THREADS</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">availableProcessors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">ExecutorService</span> ioThreadPool <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token constant\">IO_THREADS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ExecutorService</span> cpuThreadPool <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CPU_THREADS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            ioThreadPool<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token comment\">// 模拟IO操作</span>\n                <span class=\"token function\">performIOOperation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            cpuThreadPool<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token comment\">// 模拟计算操作</span>\n                <span class=\"token function\">performCPUTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        ioThreadPool<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        cpuThreadPool<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">performIOOperation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">// 模拟IO操作</span>\n            <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">performCPUTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 模拟计算操作</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">pow</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<h4 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h4><p><strong>IO密集型任务</strong>：使用较大的线程池，通常为CPU核心数的2倍或更多，以应对大量的IO等待时间。<br><strong>计算密集型任务</strong>：使用较小的线程池，接近CPU核心数，以充分利用CPU资源，避免过多的线程上下文切换。<br><strong>混合任务</strong>：根据任务的主要特征，分别使用不同的线程池处理IO操作和计算操作。<br>通过合理配置线程池，可以有效提高应用程序的性能和资源利用率。</p>\n","excerpt":"","more":"<p>边独立，边面试，两手都要抓，两手都要硬。</p>\n<h3 id=\"1-给定数组array与一个数字num，要求从array中找出两个数，其和为num，并返回这两个数的下标\"><a href=\"#1-给定数组array与一个数字num，要求从array中找出两个数，其和为num，并返回这两个数的下标\" class=\"headerlink\" title=\"1. 给定数组array与一个数字num，要求从array中找出两个数，其和为num，并返回这两个数的下标\"></a>1. 给定数组array与一个数字num，要求从array中找出两个数，其和为num，并返回这两个数的下标</h3><pre class=\"language-kotlin\" data-language=\"kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">findTwoSum</span><span class=\"token punctuation\">(</span>array<span class=\"token operator\">:</span> IntArray<span class=\"token punctuation\">,</span> num<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Pair<span class=\"token operator\">&lt;</span>Int<span class=\"token punctuation\">,</span> Int<span class=\"token operator\">></span><span class=\"token operator\">?</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 创建一个哈希表来存储数组中的数字及其索引</span>\n    <span class=\"token keyword\">val</span> map <span class=\"token operator\">=</span> mutableMapOf<span class=\"token operator\">&lt;</span>Int<span class=\"token punctuation\">,</span> Int<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// 遍历数组</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token keyword\">in</span> array<span class=\"token punctuation\">.</span>indices<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">val</span> complement <span class=\"token operator\">=</span> num <span class=\"token operator\">-</span> array<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n\n        <span class=\"token comment\">// 检查哈希表中是否存在这个补数</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>map<span class=\"token punctuation\">.</span><span class=\"token function\">containsKey</span><span class=\"token punctuation\">(</span>complement<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">// 如果存在，返回这个数及其补数的索引</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">Pair</span><span class=\"token punctuation\">(</span>map<span class=\"token punctuation\">[</span>complement<span class=\"token punctuation\">]</span><span class=\"token operator\">!!</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token comment\">// 将当前数字及其索引存入哈希表</span>\n        map<span class=\"token punctuation\">[</span>array<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> i\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token comment\">// 如果没有找到符合条件的数对，返回null</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p><strong>解读：</strong></p>\n<ol>\n<li>创建一个map，在遍历的过程中，报错所有数字以及其对应的坐标，数字为键，坐标为值；</li>\n<li>遍历时，计算出num与当前元素的差值，然后试图从map中索引，如果有索引，则命中，如果没有则继续遍历；</li>\n<li>map的作用，相当于取代了双层遍历法其中的一层遍历；</li>\n</ol>\n<h3 id=\"2-jvm如何判断一个对象可以被回收？\"><a href=\"#2-jvm如何判断一个对象可以被回收？\" class=\"headerlink\" title=\"2. jvm如何判断一个对象可以被回收？\"></a>2. jvm如何判断一个对象可以被回收？</h3><ol>\n<li>引用计数法<br>优点：实现简单，时间复杂度低；<br>缺点：无法解决循环引用问题；</li>\n<li>可达性分析算法<br>通过GC Roots开始标记所有可达的对象；可以被标记的，认为是活的对象，未被标记的，则认为已经不需要，可以被回收；</li>\n</ol>\n<h4 id=\"2-1-有哪些可以作为GC-Root\"><a href=\"#2-1-有哪些可以作为GC-Root\" class=\"headerlink\" title=\"2.1 有哪些可以作为GC Root?\"></a>2.1 有哪些可以作为GC Root?</h4><ul>\n<li>虚拟机栈（栈帧中的本地变量表）中引用的对象。</li>\n<li>方法区中的类静态属性引用的对象。</li>\n<li>方法区中常量引用的对象。</li>\n<li>本地方法栈中JNI（即Native方法）引用的对象。</li>\n</ul>\n<h4 id=\"2-2-垃圾回收的过程是怎样的？\"><a href=\"#2-2-垃圾回收的过程是怎样的？\" class=\"headerlink\" title=\"2.2 垃圾回收的过程是怎样的？\"></a>2.2 垃圾回收的过程是怎样的？</h4><p>有三种策略：</p>\n<ul>\n<li>标记清除：首先标记所有可达对象，然后清除所有未被标记的对象；</li>\n<li>复制算法：将存活的对象，从一块内存复制到另外一块内存，然后清空原来的内存；</li>\n<li>标记-压缩： 首先标记所有可达的对象，然后将所有存活的对象压缩到内存的一端，清除便捷以外的空间；</li>\n</ul>\n<h3 id=\"3-Android的Handler是如何造成内存泄露的？\"><a href=\"#3-Android的Handler是如何造成内存泄露的？\" class=\"headerlink\" title=\"3. Android的Handler是如何造成内存泄露的？\"></a>3. Android的Handler是如何造成内存泄露的？</h3><p> 非静态内部类或者匿名内部类，会隐式的持有外部类的对象，如果在Activity中声明一个Handler，而Handler执行延迟任务，在任务结束前，Activity已经被销毁了，则Activiey泄露了；</p>\n<h4 id=\"3-1-如何解决Handler的内存泄露？\"><a href=\"#3-1-如何解决Handler的内存泄露？\" class=\"headerlink\" title=\"3.1 如何解决Handler的内存泄露？\"></a>3.1 如何解决Handler的内存泄露？</h4><ol>\n<li>将<code>Handler</code>声明为静态内部类，并且使用弱引用持有外部类的引用；</li>\n<li>在Activity的onDestroy中，使用<code>Handler</code>的<code>removeCallbacksAndMessages</code>方法，移除所有未执行的消息和回调；</li>\n</ol>\n<h4 id=\"3-2-有没有非Activity的其他内存泄露的场景？\"><a href=\"#3-2-有没有非Activity的其他内存泄露的场景？\" class=\"headerlink\" title=\"3.2 有没有非Activity的其他内存泄露的场景？\"></a>3.2 有没有非Activity的其他内存泄露的场景？</h4><ol>\n<li>单例持有外部对象；</li>\n<li>静态持有外部对象；</li>\n<li>未取消注册监听器或者回调；</li>\n<li>WebView导致内存泄露；</li>\n<li>异步任务；<br> 总结来说，就是生命周期长的对象，持有了一个生命周期短的对象的引用；</li>\n</ol>\n<h3 id=\"4-应用启动白屏如何排查？如何解决？\"><a href=\"#4-应用启动白屏如何排查？如何解决？\" class=\"headerlink\" title=\"4. 应用启动白屏如何排查？如何解决？\"></a>4. 应用启动白屏如何排查？如何解决？</h3><ol>\n<li>在应用入口，比如Application的onCreate、启动Activity的onCreate中，做耗时检查，如果耗时异常，具体检查代码；</li>\n<li>如果是Activity的onCreate中耗时长，检查是否为布局过于复杂，造成的布局解析耗时长，可以使用异步布局处理；</li>\n<li>如果为系统机制问题导致，可以配置主题或者使用Splash库来做过渡；</li>\n</ol>\n<h3 id=\"5-线上问题如何排查？\"><a href=\"#5-线上问题如何排查？\" class=\"headerlink\" title=\"5. 线上问题如何排查？\"></a>5. 线上问题如何排查？</h3><ol>\n<li>运营种子用户，提前内测，按照用户反馈，复现问题场景；</li>\n<li>集成bugly等线上日志抓取工具，按照机型、系统等信息，复现问题场景；</li>\n<li>如果有可能，可以通过热更新修复问题；</li>\n</ol>\n<h3 id=\"6-不同任务类型-IO密集型-计算密集型-任务，如何分配线程池策略？\"><a href=\"#6-不同任务类型-IO密集型-计算密集型-任务，如何分配线程池策略？\" class=\"headerlink\" title=\"6. 不同任务类型(IO密集型&#x2F;计算密集型)任务，如何分配线程池策略？\"></a>6. 不同任务类型(IO密集型&#x2F;计算密集型)任务，如何分配线程池策略？</h3><h4 id=\"IO密集型任务\"><a href=\"#IO密集型任务\" class=\"headerlink\" title=\"IO密集型任务\"></a>IO密集型任务</h4><p><strong>特点</strong><br>IO密集型任务主要涉及等待外部资源（如文件系统、网络请求、数据库操作等），因此大部分时间处于等待状态，而非消耗CPU。</p>\n<p><strong>策略</strong><br>对于IO密集型任务，可以使用较大的线程池，因为线程在等待IO操作完成时不会消耗大量CPU资源。</p>\n<p><strong>线程池配置</strong><br>通常，线程池的大小可以设置为CPU核心数的2倍或更多。一个常见的公式是：</p>\n<pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">线程池大小 <span class=\"token operator\">=</span> CPU核心数 * <span class=\"token number\">2</span>\n或更大，根据实际情况调整。</code></pre>\n\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Executors</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ExecutorService</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">IOIntensiveTaskExample</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">N_THREADS</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">availableProcessors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">ExecutorService</span> ioThreadPool <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token constant\">N_THREADS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            ioThreadPool<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token comment\">// 模拟IO操作</span>\n                <span class=\"token function\">performIOOperation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        ioThreadPool<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">performIOOperation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">// 模拟IO操作</span>\n            <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n\n<h4 id=\"计算密集型任务\"><a href=\"#计算密集型任务\" class=\"headerlink\" title=\"计算密集型任务\"></a>计算密集型任务</h4><p><strong>特点</strong><br>计算密集型任务主要消耗CPU资源，执行过程中几乎不涉及等待时间，因此可以充分利用CPU。</p>\n<p><strong>策略</strong><br>对于计算密集型任务，线程池的大小应设置为接近CPU核心数。过多的线程会导致频繁的上下文切换，反而降低性能。</p>\n<p><strong>线程池配置</strong><br>通常，线程池的大小可以设置为CPU核心数。一个常见的公式是：</p>\n<pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">线程池大小 <span class=\"token operator\">=</span> CPU核心数</code></pre>\n\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Executors</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ExecutorService</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CPUIntensiveTaskExample</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">N_THREADS</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">availableProcessors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">ExecutorService</span> cpuThreadPool <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token constant\">N_THREADS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            cpuThreadPool<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token comment\">// 模拟计算操作</span>\n                <span class=\"token function\">performCPUTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        cpuThreadPool<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">performCPUTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 模拟计算操作</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">pow</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<p><strong>混合任务</strong><br>在实际应用中，有些任务可能既包含IO操作又包含计算操作。这种情况下，可以考虑使用不同的线程池分别处理不同类型的任务，或者根据任务的主要特征选择适当的线程池配置。</p>\n<pre class=\"language-java\" data-language=\"java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Executors</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ExecutorService</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MixedTaskExample</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">IO_THREADS</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">availableProcessors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">CPU_THREADS</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">availableProcessors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token class-name\">ExecutorService</span> ioThreadPool <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token constant\">IO_THREADS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ExecutorService</span> cpuThreadPool <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CPU_THREADS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            ioThreadPool<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token comment\">// 模拟IO操作</span>\n                <span class=\"token function\">performIOOperation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            cpuThreadPool<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token comment\">// 模拟计算操作</span>\n                <span class=\"token function\">performCPUTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        ioThreadPool<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        cpuThreadPool<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">performIOOperation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">// 模拟IO操作</span>\n            <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">performCPUTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 模拟计算操作</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">pow</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></code></pre>\n<h4 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h4><p><strong>IO密集型任务</strong>：使用较大的线程池，通常为CPU核心数的2倍或更多，以应对大量的IO等待时间。<br><strong>计算密集型任务</strong>：使用较小的线程池，接近CPU核心数，以充分利用CPU资源，避免过多的线程上下文切换。<br><strong>混合任务</strong>：根据任务的主要特征，分别使用不同的线程池处理IO操作和计算操作。<br>通过合理配置线程池，可以有效提高应用程序的性能和资源利用率。</p>\n"},{"title":"写了一个Hexo主题与插件","date":"2024-09-22T09:41:32.000Z","_content":"\n最近写了一个Hexo的主题，同时为了配合主题[Hexober](https://github.com/hexober/hexober.github.io)，写了一个插件[hexo-auto-photos](https://github.com/boybeak/hexo-auto-photos)。\n\n## Hexober\n[Hexober](https://github.com/hexober/hexober.github.io)是一个基于[soberJS](https://soberjs.com/)的Material Design风格的Hexo主题。本博客即将切换到该主题下。\n\n## hexo-auto-photos\n[hexo-auto-photos](https://github.com/boybeak/hexo-auto-photos)是一个自动从文章内容中，提取出photos字段的库，该库可配合[Hexober](https://github.com/hexober/hexober.github.io)或者其它支持文章列表展示图片的主题使用。当使用该库以后，如果用户没有指定文章的photos字段，将会自动从文章中找到图片部分，并填充到文章的photos字段中。","source":"_posts/2024-09-22-写了一个Hexo主题与插件.md","raw":"---\ntitle: 写了一个Hexo主题与插件\ndate: 2024-09-22 17:41:32\ntags:\n    - Hexo\n---\n\n最近写了一个Hexo的主题，同时为了配合主题[Hexober](https://github.com/hexober/hexober.github.io)，写了一个插件[hexo-auto-photos](https://github.com/boybeak/hexo-auto-photos)。\n\n## Hexober\n[Hexober](https://github.com/hexober/hexober.github.io)是一个基于[soberJS](https://soberjs.com/)的Material Design风格的Hexo主题。本博客即将切换到该主题下。\n\n## hexo-auto-photos\n[hexo-auto-photos](https://github.com/boybeak/hexo-auto-photos)是一个自动从文章内容中，提取出photos字段的库，该库可配合[Hexober](https://github.com/hexober/hexober.github.io)或者其它支持文章列表展示图片的主题使用。当使用该库以后，如果用户没有指定文章的photos字段，将会自动从文章中找到图片部分，并填充到文章的photos字段中。","slug":"2024-09-22-写了一个Hexo主题与插件","published":1,"updated":"2024-09-25T02:53:02.352Z","comments":1,"layout":"post","photos":[],"_id":"cm1ltr0g7003mbji06jfpcigs","content":"<p>最近写了一个Hexo的主题，同时为了配合主题<a href=\"https://github.com/hexober/hexober.github.io\">Hexober</a>，写了一个插件<a href=\"https://github.com/boybeak/hexo-auto-photos\">hexo-auto-photos</a>。</p>\n<h2 id=\"Hexober\"><a href=\"#Hexober\" class=\"headerlink\" title=\"Hexober\"></a>Hexober</h2><p><a href=\"https://github.com/hexober/hexober.github.io\">Hexober</a>是一个基于<a href=\"https://soberjs.com/\">soberJS</a>的Material Design风格的Hexo主题。本博客即将切换到该主题下。</p>\n<h2 id=\"hexo-auto-photos\"><a href=\"#hexo-auto-photos\" class=\"headerlink\" title=\"hexo-auto-photos\"></a>hexo-auto-photos</h2><p><a href=\"https://github.com/boybeak/hexo-auto-photos\">hexo-auto-photos</a>是一个自动从文章内容中，提取出photos字段的库，该库可配合<a href=\"https://github.com/hexober/hexober.github.io\">Hexober</a>或者其它支持文章列表展示图片的主题使用。当使用该库以后，如果用户没有指定文章的photos字段，将会自动从文章中找到图片部分，并填充到文章的photos字段中。</p>\n","excerpt":"","more":"<p>最近写了一个Hexo的主题，同时为了配合主题<a href=\"https://github.com/hexober/hexober.github.io\">Hexober</a>，写了一个插件<a href=\"https://github.com/boybeak/hexo-auto-photos\">hexo-auto-photos</a>。</p>\n<h2 id=\"Hexober\"><a href=\"#Hexober\" class=\"headerlink\" title=\"Hexober\"></a>Hexober</h2><p><a href=\"https://github.com/hexober/hexober.github.io\">Hexober</a>是一个基于<a href=\"https://soberjs.com/\">soberJS</a>的Material Design风格的Hexo主题。本博客即将切换到该主题下。</p>\n<h2 id=\"hexo-auto-photos\"><a href=\"#hexo-auto-photos\" class=\"headerlink\" title=\"hexo-auto-photos\"></a>hexo-auto-photos</h2><p><a href=\"https://github.com/boybeak/hexo-auto-photos\">hexo-auto-photos</a>是一个自动从文章内容中，提取出photos字段的库，该库可配合<a href=\"https://github.com/hexober/hexober.github.io\">Hexober</a>或者其它支持文章列表展示图片的主题使用。当使用该库以后，如果用户没有指定文章的photos字段，将会自动从文章中找到图片部分，并填充到文章的photos字段中。</p>\n"},{"title":"Hello World","_content":"Welcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","source":"_posts/hello-world.md","raw":"---\ntitle: Hello World\n---\nWelcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","slug":"hello-world","published":1,"date":"2024-09-25T02:53:02.361Z","updated":"2024-09-25T02:53:02.361Z","comments":1,"layout":"post","photos":[],"_id":"cm1ltr0g8004lbji0a3c7at3w","content":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">$ hexo new <span class=\"token string\">\"My New Post\"</span></code></pre>\n\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">$ hexo server</code></pre>\n\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">$ hexo generate</code></pre>\n\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">$ hexo deploy</code></pre>\n\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n","excerpt":"","more":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">$ hexo new <span class=\"token string\">\"My New Post\"</span></code></pre>\n\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">$ hexo server</code></pre>\n\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">$ hexo generate</code></pre>\n\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><pre class=\"language-bash\" data-language=\"bash\"><code class=\"language-bash\">$ hexo deploy</code></pre>\n\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cm1ltr0fx0006bji012l19ffc","category_id":"cm1ltr0fw0003bji02j179ag8","_id":"cm1ltr0fy000ebji02cgveg01"},{"post_id":"cm1ltr0fu0001bji0hv4ze1u6","category_id":"cm1ltr0fw0003bji02j179ag8","_id":"cm1ltr0fz000jbji04epjg6gc"},{"post_id":"cm1ltr0fx0007bji0e0sf7r88","category_id":"cm1ltr0fw0003bji02j179ag8","_id":"cm1ltr0fz000mbji08gjca6zu"},{"post_id":"cm1ltr0fy000bbji0bbpg5es7","category_id":"cm1ltr0fw0003bji02j179ag8","_id":"cm1ltr0g0000pbji01yyw2272"},{"post_id":"cm1ltr0fv0002bji010yn3i8n","category_id":"cm1ltr0fw0003bji02j179ag8","_id":"cm1ltr0g0000tbji0e273ggx9"},{"post_id":"cm1ltr0fy000dbji0gi4hgvqq","category_id":"cm1ltr0fw0003bji02j179ag8","_id":"cm1ltr0g0000wbji0810c04z0"},{"post_id":"cm1ltr0fz000ibji02cwr643p","category_id":"cm1ltr0fw0003bji02j179ag8","_id":"cm1ltr0g00010bji0g98l1on7"},{"post_id":"cm1ltr0fw0005bji02k3s4lvx","category_id":"cm1ltr0fw0003bji02j179ag8","_id":"cm1ltr0g10013bji08mpq7fcf"},{"post_id":"cm1ltr0g0000vbji0bawwhkcq","category_id":"cm1ltr0g0000qbji02tp2cwl5","_id":"cm1ltr0g10017bji02a057prh"},{"post_id":"cm1ltr0fz000lbji02d5n7ybx","category_id":"cm1ltr0g0000qbji02tp2cwl5","_id":"cm1ltr0g1001abji0fypyaxaq"},{"post_id":"cm1ltr0g0000ybji0eluh1e86","category_id":"cm1ltr0g0000qbji02tp2cwl5","_id":"cm1ltr0g1001dbji0edmigsyf"},{"post_id":"cm1ltr0g10012bji051ska1yp","category_id":"cm1ltr0fw0003bji02j179ag8","_id":"cm1ltr0g2001gbji0dg28h27o"},{"post_id":"cm1ltr0fz000obji0bcvf8gbb","category_id":"cm1ltr0g0000qbji02tp2cwl5","_id":"cm1ltr0g2001jbji0ec0p0uhz"},{"post_id":"cm1ltr0g10015bji0bbte3rfa","category_id":"cm1ltr0g0000qbji02tp2cwl5","_id":"cm1ltr0g2001mbji088pxf4l3"},{"post_id":"cm1ltr0g10019bji0hk1z5s8w","category_id":"cm1ltr0g0000qbji02tp2cwl5","_id":"cm1ltr0g2001rbji05w1s3bcf"},{"post_id":"cm1ltr0g0000sbji0d9chbfwy","category_id":"cm1ltr0g0000qbji02tp2cwl5","_id":"cm1ltr0g3001ubji0aix8f9wu"},{"post_id":"cm1ltr0g1001cbji07j9j4rg2","category_id":"cm1ltr0g0000qbji02tp2cwl5","_id":"cm1ltr0g3001zbji02ryvdq20"},{"post_id":"cm1ltr0g2001fbji00ntj154m","category_id":"cm1ltr0g0000qbji02tp2cwl5","_id":"cm1ltr0g30022bji013ij1uwt"},{"post_id":"cm1ltr0g2001qbji023gx8ruq","category_id":"cm1ltr0g0000qbji02tp2cwl5","_id":"cm1ltr0g30025bji0296z43pv"},{"post_id":"cm1ltr0g2001ibji08pul5boh","category_id":"cm1ltr0g2001nbji05nmmgq0a","_id":"cm1ltr0g4002abji0az0fa0wf"},{"post_id":"cm1ltr0g3001wbji0gs50h1yb","category_id":"cm1ltr0g0000qbji02tp2cwl5","_id":"cm1ltr0g4002dbji00ewh0j7k"},{"post_id":"cm1ltr0g30021bji0461ielbd","category_id":"cm1ltr0g0000qbji02tp2cwl5","_id":"cm1ltr0g4002hbji061iz2u7n"},{"post_id":"cm1ltr0g2001lbji0hgrgdmci","category_id":"cm1ltr0g3001xbji08n4mca3m","_id":"cm1ltr0g4002kbji00qyj6whx"},{"post_id":"cm1ltr0g30024bji07z2q6je4","category_id":"cm1ltr0g0000qbji02tp2cwl5","_id":"cm1ltr0g4002obji019cv1bn1"},{"post_id":"cm1ltr0g30029bji00bu6eukv","category_id":"cm1ltr0g0000qbji02tp2cwl5","_id":"cm1ltr0g5002sbji08mqb4tkp"},{"post_id":"cm1ltr0g2001tbji07vdr8e7r","category_id":"cm1ltr0g30026bji0hh19c26i","_id":"cm1ltr0g5002vbji0ha4gbjtq"},{"post_id":"cm1ltr0g4002cbji0e6edg6t3","category_id":"cm1ltr0g0000qbji02tp2cwl5","_id":"cm1ltr0g50030bji08ul2font"},{"post_id":"cm1ltr0g4002gbji0e8q2hlkv","category_id":"cm1ltr0g0000qbji02tp2cwl5","_id":"cm1ltr0g50033bji04p209vmj"},{"post_id":"cm1ltr0g5002ubji0cy9e5n26","category_id":"cm1ltr0g5002pbji0eluthjb4","_id":"cm1ltr0g60038bji02onz31eh"},{"post_id":"cm1ltr0g4002jbji0f4xj0zjo","category_id":"cm1ltr0g5002pbji0eluthjb4","_id":"cm1ltr0g6003bbji04igwfg2p"},{"post_id":"cm1ltr0g5002xbji03gck52mp","category_id":"cm1ltr0g5002pbji0eluthjb4","_id":"cm1ltr0g6003ebji05if09wfv"},{"post_id":"cm1ltr0g50031bji00exq987a","category_id":"cm1ltr0g5002pbji0eluthjb4","_id":"cm1ltr0g6003gbji0596v7x40"},{"post_id":"cm1ltr0g4002mbji089z49hrm","category_id":"cm1ltr0g5002pbji0eluthjb4","_id":"cm1ltr0g7003kbji0g9ny42qq"},{"post_id":"cm1ltr0g60035bji0egfnd7cg","category_id":"cm1ltr0g5002pbji0eluthjb4","_id":"cm1ltr0g7003nbji06yzb1g6p"},{"post_id":"cm1ltr0g60039bji08qgaclt8","category_id":"cm1ltr0g5002pbji0eluthjb4","_id":"cm1ltr0g7003rbji04c60hnr0"},{"post_id":"cm1ltr0g5002rbji0b1lfb5iz","category_id":"cm1ltr0g5002pbji0eluthjb4","_id":"cm1ltr0g7003tbji0h1zc0oth"},{"post_id":"cm1ltr0g6003dbji04bhc0h91","category_id":"cm1ltr0g5002pbji0eluthjb4","_id":"cm1ltr0g7003wbji0f5diddqw"},{"post_id":"cm1ltr0g6003fbji01j6y3a1u","category_id":"cm1ltr0g5002pbji0eluthjb4","_id":"cm1ltr0g7003ybji0cg9c2eaf"},{"post_id":"cm1ltr0g6003jbji0e5mk9oh1","category_id":"cm1ltr0g7003obji066vubhrm","_id":"cm1ltr0g70040bji08669ax7c"}],"PostTag":[{"post_id":"cm1ltr0fx0006bji012l19ffc","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0fy000abji02ig367cb"},{"post_id":"cm1ltr0fu0001bji0hv4ze1u6","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0fy000cbji02cktagmb"},{"post_id":"cm1ltr0fx0007bji0e0sf7r88","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0fz000hbji08yp0fjl0"},{"post_id":"cm1ltr0fy000bbji0bbpg5es7","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0fz000kbji0bg7eczty"},{"post_id":"cm1ltr0fv0002bji010yn3i8n","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0fz000nbji00u6e5nl7"},{"post_id":"cm1ltr0fy000dbji0gi4hgvqq","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g0000rbji00cim0ura"},{"post_id":"cm1ltr0fz000ibji02cwr643p","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g0000ubji050emf3vq"},{"post_id":"cm1ltr0fw0005bji02k3s4lvx","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g0000xbji05rkd5vqm"},{"post_id":"cm1ltr0fz000lbji02d5n7ybx","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g10011bji06aodcftw"},{"post_id":"cm1ltr0fz000obji0bcvf8gbb","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g10014bji04k0q3r7g"},{"post_id":"cm1ltr0g0000sbji0d9chbfwy","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g10018bji0hn33bgxm"},{"post_id":"cm1ltr0g0000vbji0bawwhkcq","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g1001bbji044mk9khh"},{"post_id":"cm1ltr0g0000ybji0eluh1e86","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g2001ebji0gqmmat71"},{"post_id":"cm1ltr0g10012bji051ska1yp","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g2001hbji0b70wbtdb"},{"post_id":"cm1ltr0g10015bji0bbte3rfa","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g2001kbji0dwsn7x0q"},{"post_id":"cm1ltr0g10019bji0hk1z5s8w","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g2001pbji0dccb1z2g"},{"post_id":"cm1ltr0g1001cbji07j9j4rg2","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g2001sbji0htkzhbw1"},{"post_id":"cm1ltr0g2001fbji00ntj154m","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g3001vbji0akae5gw3"},{"post_id":"cm1ltr0g2001qbji023gx8ruq","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g30020bji0ew0w6bd1"},{"post_id":"cm1ltr0g2001ibji08pul5boh","tag_id":"cm1ltr0g2001obji03f4709oy","_id":"cm1ltr0g30023bji0341h7mq5"},{"post_id":"cm1ltr0g3001wbji0gs50h1yb","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g30028bji0hzkn75kf"},{"post_id":"cm1ltr0g30021bji0461ielbd","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g4002bbji00q5a7s49"},{"post_id":"cm1ltr0g2001lbji0hgrgdmci","tag_id":"cm1ltr0g3001ybji02k48ck3g","_id":"cm1ltr0g4002fbji0evtl7njb"},{"post_id":"cm1ltr0g30024bji07z2q6je4","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g4002ibji0dr9d8zni"},{"post_id":"cm1ltr0g2001tbji07vdr8e7r","tag_id":"cm1ltr0g30027bji0163wewow","_id":"cm1ltr0g4002lbji032qhfdg1"},{"post_id":"cm1ltr0g30029bji00bu6eukv","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g5002qbji0g2md9hcw"},{"post_id":"cm1ltr0g30029bji00bu6eukv","tag_id":"cm1ltr0g4002ebji068zw75gl","_id":"cm1ltr0g5002tbji05fwqbntz"},{"post_id":"cm1ltr0g4002cbji0e6edg6t3","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g5002zbji02hc20da9"},{"post_id":"cm1ltr0g4002cbji0e6edg6t3","tag_id":"cm1ltr0g4002nbji0fodn3gwm","_id":"cm1ltr0g50032bji06p7r4r7h"},{"post_id":"cm1ltr0g4002gbji0e8q2hlkv","tag_id":"cm1ltr0fw0004bji03krk02m0","_id":"cm1ltr0g60037bji04dab3daf"},{"post_id":"cm1ltr0g4002gbji0e8q2hlkv","tag_id":"cm1ltr0g4002nbji0fodn3gwm","_id":"cm1ltr0g6003abji08vgge97t"},{"post_id":"cm1ltr0g6003dbji04bhc0h91","tag_id":"cm1ltr0g50034bji0hcwl5a1p","_id":"cm1ltr0g6003hbji089p5ejln"},{"post_id":"cm1ltr0g4002jbji0f4xj0zjo","tag_id":"cm1ltr0g50034bji0hcwl5a1p","_id":"cm1ltr0g7003lbji0cvmwgyge"},{"post_id":"cm1ltr0g4002jbji0f4xj0zjo","tag_id":"cm1ltr0g6003cbji0788xghlp","_id":"cm1ltr0g7003pbji05n83bbh0"},{"post_id":"cm1ltr0g6003fbji01j6y3a1u","tag_id":"cm1ltr0g50034bji0hcwl5a1p","_id":"cm1ltr0g7003sbji0gcze4160"},{"post_id":"cm1ltr0g4002mbji089z49hrm","tag_id":"cm1ltr0g50034bji0hcwl5a1p","_id":"cm1ltr0g7003ubji0f3ss3iss"},{"post_id":"cm1ltr0g5002rbji0b1lfb5iz","tag_id":"cm1ltr0g50034bji0hcwl5a1p","_id":"cm1ltr0g7003xbji0fbci6kwe"},{"post_id":"cm1ltr0g5002ubji0cy9e5n26","tag_id":"cm1ltr0g50034bji0hcwl5a1p","_id":"cm1ltr0g70042bji05rmv46c7"},{"post_id":"cm1ltr0g5002ubji0cy9e5n26","tag_id":"cm1ltr0g7003zbji0av3t70io","_id":"cm1ltr0g70043bji0a02ncqpg"},{"post_id":"cm1ltr0g5002xbji03gck52mp","tag_id":"cm1ltr0g50034bji0hcwl5a1p","_id":"cm1ltr0g80046bji01l7w3r5h"},{"post_id":"cm1ltr0g5002xbji03gck52mp","tag_id":"cm1ltr0g7003zbji0av3t70io","_id":"cm1ltr0g80047bji06yk3hqqm"},{"post_id":"cm1ltr0g50031bji00exq987a","tag_id":"cm1ltr0g50034bji0hcwl5a1p","_id":"cm1ltr0g8004abji0dams3c9w"},{"post_id":"cm1ltr0g50031bji00exq987a","tag_id":"cm1ltr0g7003zbji0av3t70io","_id":"cm1ltr0g8004bbji05iygbakg"},{"post_id":"cm1ltr0g60035bji0egfnd7cg","tag_id":"cm1ltr0g50034bji0hcwl5a1p","_id":"cm1ltr0g8004dbji09ckf8cqa"},{"post_id":"cm1ltr0g60035bji0egfnd7cg","tag_id":"cm1ltr0g7003zbji0av3t70io","_id":"cm1ltr0g8004ebji0fzpbelu5"},{"post_id":"cm1ltr0g60039bji08qgaclt8","tag_id":"cm1ltr0g50034bji0hcwl5a1p","_id":"cm1ltr0g8004gbji0aaoi5zkv"},{"post_id":"cm1ltr0g60039bji08qgaclt8","tag_id":"cm1ltr0g7003zbji0av3t70io","_id":"cm1ltr0g8004hbji0a0gwfmub"},{"post_id":"cm1ltr0g6003jbji0e5mk9oh1","tag_id":"cm1ltr0g8004fbji0cwnh3boy","_id":"cm1ltr0g8004jbji0hj0b6od6"},{"post_id":"cm1ltr0g7003mbji06jfpcigs","tag_id":"cm1ltr0g8004ibji089rkhqgn","_id":"cm1ltr0g8004kbji072vg9oa6"}],"Tag":[{"name":"Android","_id":"cm1ltr0fw0004bji03krk02m0"},{"name":"Kotlin","_id":"cm1ltr0g2001obji03f4709oy"},{"name":"陷阱与缺陷","_id":"cm1ltr0g3001ybji02k48ck3g"},{"name":"Translator","_id":"cm1ltr0g30027bji0163wewow"},{"name":"J2V8","_id":"cm1ltr0g4002ebji068zw75gl"},{"name":"Camera","_id":"cm1ltr0g4002nbji0fodn3gwm"},{"name":"macOS","_id":"cm1ltr0g50034bji0hcwl5a1p"},{"name":"静态库","_id":"cm1ltr0g6003cbji0788xghlp"},{"name":"JustTodo","_id":"cm1ltr0g7003zbji0av3t70io"},{"name":"面试","_id":"cm1ltr0g8004fbji0cwnh3boy"},{"name":"Hexo","_id":"cm1ltr0g8004ibji089rkhqgn"}]}}