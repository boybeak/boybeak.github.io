<!DOCTYPE html>






































<html
  class="not-ready text-sm lg:text-base"
  style="--bg: #faf6f1"
  lang="en-us"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>LeakCanary原理分析 - My New Hugo Site</title>

  
  <meta name="theme-color" />
  
  <meta name="description" content="LeakCanary原理分析 dependencies { // debugImplementation because LeakCanary should only run in debug builds. debugImplementation &#39;com.squareup.leakcanary:leakcanary-android:2.5&#39; } 只需要这样简单配置，就能接入LeakCanary内存泄漏分析，到底是怎样做到的？
我们将这个问题分成两个问题：
如何自动进行初始化的； 如何检测到内存泄漏的。 如何自动进行初始化的 这部分，我们可以分成两部分去理解——自动和初始化。
自动 这一切还要从ActivityThread说起。ActivityThread中，执行了一些应用启动的初始化工作，在ActivityThread源码中，我们可以看到其内部类class H extends Handler的handleMessage方法中，有很多与应用相关的一些基本操作，比如BIND_APPLICATION, EXIT_APPLICATION, CREATE_SERVICE, BIND_SERVICE等，其中需要我们关注的是BIND_APPLICATION。
public void handleMessage(Message msg) { .... switch (msg.what) { case BIND_APPLICATION: Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &#34;bindApplication&#34;); AppBindData data = (AppBindData)msg.obj; handleBindApplication(data); Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); break; .... } .... } 我们可以看到，其中调用了handleBindApplication方法。进入这个方法查看。
@UnsupportedAppUsage private void handleBindApplication(AppBindData data) { .... Application app; final StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites(); final StrictMode." />
  <meta name="author" content="" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://boybeak.github.io/main.min.css" />

  

  
  
  
    
  
  <link
    rel="preload"
    as="image"
    href="https://boybeak.github.io/theme.png"
  />

  
  
  
  <link rel="preload" as="image" href="https://www.gravatar.com/avatar/6fd8df4abe41f17fd8e2dd7d97b5cc8c?s=160&amp;d=identicon" />
  
  

  
  <link rel="preload" as="image" href="https://boybeak.github.io/twitter.svg" />
  
  <link rel="preload" as="image" href="https://boybeak.github.io/github.svg" />
  
  <link rel="preload" as="image" href="https://boybeak.github.io/instagram.svg" />
  
  <link rel="preload" as="image" href="https://boybeak.github.io/rss.svg" />
  

  
  <link rel="icon" href="https://boybeak.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://boybeak.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.101.0" />

  
  

  
  
  
  
  
  
  
  
  
  <meta property="og:title" content="LeakCanary原理分析" />
<meta property="og:description" content="LeakCanary原理分析 dependencies { // debugImplementation because LeakCanary should only run in debug builds. debugImplementation &#39;com.squareup.leakcanary:leakcanary-android:2.5&#39; } 只需要这样简单配置，就能接入LeakCanary内存泄漏分析，到底是怎样做到的？
我们将这个问题分成两个问题：
如何自动进行初始化的； 如何检测到内存泄漏的。 如何自动进行初始化的 这部分，我们可以分成两部分去理解——自动和初始化。
自动 这一切还要从ActivityThread说起。ActivityThread中，执行了一些应用启动的初始化工作，在ActivityThread源码中，我们可以看到其内部类class H extends Handler的handleMessage方法中，有很多与应用相关的一些基本操作，比如BIND_APPLICATION, EXIT_APPLICATION, CREATE_SERVICE, BIND_SERVICE等，其中需要我们关注的是BIND_APPLICATION。
public void handleMessage(Message msg) { .... switch (msg.what) { case BIND_APPLICATION: Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &#34;bindApplication&#34;); AppBindData data = (AppBindData)msg.obj; handleBindApplication(data); Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); break; .... } .... } 我们可以看到，其中调用了handleBindApplication方法。进入这个方法查看。
@UnsupportedAppUsage private void handleBindApplication(AppBindData data) { .... Application app; final StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites(); final StrictMode." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://boybeak.github.io/posts/-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/leakcanary%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-03T21:06:01+08:00" />
<meta property="article:modified_time" content="2022-09-03T21:06:01+08:00" />


  
  <meta itemprop="name" content="LeakCanary原理分析">
<meta itemprop="description" content="LeakCanary原理分析 dependencies { // debugImplementation because LeakCanary should only run in debug builds. debugImplementation &#39;com.squareup.leakcanary:leakcanary-android:2.5&#39; } 只需要这样简单配置，就能接入LeakCanary内存泄漏分析，到底是怎样做到的？
我们将这个问题分成两个问题：
如何自动进行初始化的； 如何检测到内存泄漏的。 如何自动进行初始化的 这部分，我们可以分成两部分去理解——自动和初始化。
自动 这一切还要从ActivityThread说起。ActivityThread中，执行了一些应用启动的初始化工作，在ActivityThread源码中，我们可以看到其内部类class H extends Handler的handleMessage方法中，有很多与应用相关的一些基本操作，比如BIND_APPLICATION, EXIT_APPLICATION, CREATE_SERVICE, BIND_SERVICE等，其中需要我们关注的是BIND_APPLICATION。
public void handleMessage(Message msg) { .... switch (msg.what) { case BIND_APPLICATION: Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &#34;bindApplication&#34;); AppBindData data = (AppBindData)msg.obj; handleBindApplication(data); Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); break; .... } .... } 我们可以看到，其中调用了handleBindApplication方法。进入这个方法查看。
@UnsupportedAppUsage private void handleBindApplication(AppBindData data) { .... Application app; final StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites(); final StrictMode."><meta itemprop="datePublished" content="2022-09-03T21:06:01+08:00" />
<meta itemprop="dateModified" content="2022-09-03T21:06:01+08:00" />
<meta itemprop="wordCount" content="830">
<meta itemprop="keywords" content="untagged," />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="LeakCanary原理分析"/>
<meta name="twitter:description" content="LeakCanary原理分析 dependencies { // debugImplementation because LeakCanary should only run in debug builds. debugImplementation &#39;com.squareup.leakcanary:leakcanary-android:2.5&#39; } 只需要这样简单配置，就能接入LeakCanary内存泄漏分析，到底是怎样做到的？
我们将这个问题分成两个问题：
如何自动进行初始化的； 如何检测到内存泄漏的。 如何自动进行初始化的 这部分，我们可以分成两部分去理解——自动和初始化。
自动 这一切还要从ActivityThread说起。ActivityThread中，执行了一些应用启动的初始化工作，在ActivityThread源码中，我们可以看到其内部类class H extends Handler的handleMessage方法中，有很多与应用相关的一些基本操作，比如BIND_APPLICATION, EXIT_APPLICATION, CREATE_SERVICE, BIND_SERVICE等，其中需要我们关注的是BIND_APPLICATION。
public void handleMessage(Message msg) { .... switch (msg.what) { case BIND_APPLICATION: Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &#34;bindApplication&#34;); AppBindData data = (AppBindData)msg.obj; handleBindApplication(data); Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); break; .... } .... } 我们可以看到，其中调用了handleBindApplication方法。进入这个方法查看。
@UnsupportedAppUsage private void handleBindApplication(AppBindData data) { .... Application app; final StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites(); final StrictMode."/>

  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a class="-translate-x-[1px] -translate-y-0.5 text-3xl font-bold" href="https://boybeak.github.io/"
      >My New Hugo Site</a
    >
    <a
      class="btn-dark ml-6 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.svg)_left_center/cover_no-repeat] dark:invert dark:[background-position:right]"
    ></a>
  </div>

  <a
    class="btn-menu relative z-50 -mr-8 flex h-[5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
  ></a>

  
  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = `"#faf6f1"`.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    const darkVal = localStorage.getItem('dark');
    setDark(darkVal ? darkVal === 'true' : darkScheme.matches);

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 dark:invert lg:mt-0 lg:ml-12 lg:items-center lg:space-x-6"
    >
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./twitter.svg)"
        href=" https://twitter.com/YOUR_TWITTER_ID "
        target="_blank"
      ></a>
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href=" https://github.com/YOUR_GITHUB_ID "
        target="_blank"
      ></a>
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./instagram.svg)"
        href=" https://instagram.com/YOUR_INSTAGRAM_ID "
        target="_blank"
      ></a>
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./rss.svg)"
        href=" https://boybeak.github.io/index.xml "
        target="_blank"
      ></a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-10rem)] max-w-3xl px-8 pt-20 pb-32 dark:prose-invert"
    >
      

<article>
  <header class="mb-20">
    <h1 class="!my-0 pb-2.5">LeakCanary原理分析</h1>

    
    <div class="text-sm opacity-60">
      
      <time>Sep 3, 2022</time>
      
      
    </div>
    
  </header>

  <section><h1 id="leakcanary原理分析">LeakCanary原理分析</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>dependencies <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// debugImplementation because LeakCanary should only run in debug builds.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  debugImplementation <span style="color:#e6db74">&#39;com.squareup.leakcanary:leakcanary-android:2.5&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>只需要这样简单配置，就能接入LeakCanary内存泄漏分析，到底是怎样做到的？</p>
<p>我们将这个问题分成两个问题：</p>
<ol>
<li>如何<strong>自动</strong>进行初始化的；</li>
<li>如何检测到内存泄漏的。</li>
</ol>
<h2 id="如何自动进行初始化的">如何自动进行初始化的</h2>
<p>这部分，我们可以分成两部分去理解——<strong>自动</strong>和<strong>初始化</strong>。</p>
<h3 id="自动">自动</h3>
<p>这一切还要从<code>ActivityThread</code>说起。<code>ActivityThread</code>中，执行了一些应用启动的初始化工作，在<code>ActivityThread</code>源码中，我们可以看到其内部类<code>class H extends Handler</code>的<code>handleMessage</code>方法中，有很多与应用相关的一些基本操作，比如<strong>BIND_APPLICATION</strong>, <strong>EXIT_APPLICATION</strong>, <strong>CREATE_SERVICE</strong>, <strong>BIND_SERVICE</strong>等，其中需要我们关注的是<strong>BIND_APPLICATION</strong>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleMessage</span><span style="color:#f92672">(</span>Message msg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">....</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">what</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">case</span> BIND_APPLICATION<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceBegin</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ACTIVITY_MANAGER</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;bindApplication&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    AppBindData data <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>AppBindData<span style="color:#f92672">)</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">obj</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    handleBindApplication<span style="color:#f92672">(</span>data<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceEnd</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ACTIVITY_MANAGER</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">....</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">....</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>我们可以看到，其中调用了<code>handleBindApplication</code>方法。进入这个方法查看。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@UnsupportedAppUsage</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleBindApplication</span><span style="color:#f92672">(</span>AppBindData data<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">....</span>
</span></span><span style="display:flex;"><span>  Application app<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> StrictMode<span style="color:#f92672">.</span><span style="color:#a6e22e">ThreadPolicy</span> savedPolicy <span style="color:#f92672">=</span> StrictMode<span style="color:#f92672">.</span><span style="color:#a6e22e">allowThreadDiskWrites</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> StrictMode<span style="color:#f92672">.</span><span style="color:#a6e22e">ThreadPolicy</span> writesAllowedPolicy <span style="color:#f92672">=</span> StrictMode<span style="color:#f92672">.</span><span style="color:#a6e22e">getThreadPolicy</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If the app is being launched for full backup or restore, bring it up in
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// a restricted environment with the base application class.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    app <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">makeApplication</span><span style="color:#f92672">(</span>data<span style="color:#f92672">.</span><span style="color:#a6e22e">restrictedBackupMode</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Propagate autofill compat state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    app<span style="color:#f92672">.</span><span style="color:#a6e22e">setAutofillOptions</span><span style="color:#f92672">(</span>data<span style="color:#f92672">.</span><span style="color:#a6e22e">autofillOptions</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Propagate Content Capture options
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    app<span style="color:#f92672">.</span><span style="color:#a6e22e">setContentCaptureOptions</span><span style="color:#f92672">(</span>data<span style="color:#f92672">.</span><span style="color:#a6e22e">contentCaptureOptions</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    mInitialApplication <span style="color:#f92672">=</span> app<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// don&#39;t bring up providers in restricted mode; they may depend on the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// app&#39;s custom Application class
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>data<span style="color:#f92672">.</span><span style="color:#a6e22e">restrictedBackupMode</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>ArrayUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>data<span style="color:#f92672">.</span><span style="color:#a6e22e">providers</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        installContentProviders<span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> data<span style="color:#f92672">.</span><span style="color:#a6e22e">providers</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Do this after providers, since instrumentation tests generally start their
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// test thread at this point, and we don&#39;t want that racing.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      mInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">onCreate</span><span style="color:#f92672">(</span>data<span style="color:#f92672">.</span><span style="color:#a6e22e">instrumentationArgs</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Exception thrown in onCreate() of &#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">+</span> data<span style="color:#f92672">.</span><span style="color:#a6e22e">instrumentationName</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      mInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">callApplicationOnCreate</span><span style="color:#f92672">(</span>app<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">onException</span><span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> e<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;Unable to create application &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If the app targets &lt; O-MR1, or doesn&#39;t change the thread policy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// during startup, clobber the policy to maintain behavior of b/36951662
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>data<span style="color:#f92672">.</span><span style="color:#a6e22e">appInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">targetSdkVersion</span> <span style="color:#f92672">&lt;</span> Build<span style="color:#f92672">.</span><span style="color:#a6e22e">VERSION_CODES</span><span style="color:#f92672">.</span><span style="color:#a6e22e">O_MR1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">||</span> StrictMode<span style="color:#f92672">.</span><span style="color:#a6e22e">getThreadPolicy</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>writesAllowedPolicy<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      StrictMode<span style="color:#f92672">.</span><span style="color:#a6e22e">setThreadPolicy</span><span style="color:#f92672">(</span>savedPolicy<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">....</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>从这个方法中，我们可以找到这样一段代码，需要重点关注的是，<code>ContentProvider</code>的初始化是先于<code>Application.onCreate</code>的，且是被<code>ActivityThread</code><strong>自动</strong>执行的。</p>
<p>接下来再看LeakCanary源码。找到<a href="https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher-android/src/main/java/leakcanary/internal/AppWatcherInstaller.kt"><strong>AppWatcherInstaller.kt</strong></a>这个类。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Content providers are loaded before the application class is created. [AppWatcherInstaller] is
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * used to install [leakcanary.AppWatcher] on application start.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">sealed</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AppWatcherInstaller</span> : ContentProvider() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * [MainProcess] automatically sets up the LeakCanary code that runs in the main app process.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MainProcess</span> : AppWatcherInstaller()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * When using the `leakcanary-android-process` artifact instead of `leakcanary-android`,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * [LeakCanaryProcess] automatically sets up the LeakCanary code
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LeakCanaryProcess</span> : AppWatcherInstaller()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">onCreate</span>(): Boolean {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> application = context<span style="color:#f92672">!!</span>.applicationContext <span style="color:#66d9ef">as</span> Application
</span></span><span style="display:flex;"><span>    AppWatcher.manualInstall(application)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">query</span>(
</span></span><span style="display:flex;"><span>    uri: Uri,
</span></span><span style="display:flex;"><span>    strings: Array&lt;String&gt;?,
</span></span><span style="display:flex;"><span>    s: String?,
</span></span><span style="display:flex;"><span>    strings1: Array&lt;String&gt;?,
</span></span><span style="display:flex;"><span>    s1: String?
</span></span><span style="display:flex;"><span>  ): Cursor? {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">getType</span>(uri: Uri): String? {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">insert</span>(
</span></span><span style="display:flex;"><span>    uri: Uri,
</span></span><span style="display:flex;"><span>    contentValues: ContentValues?
</span></span><span style="display:flex;"><span>  ): Uri? {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">delete</span>(
</span></span><span style="display:flex;"><span>    uri: Uri,
</span></span><span style="display:flex;"><span>    s: String?,
</span></span><span style="display:flex;"><span>    strings: Array&lt;String&gt;?
</span></span><span style="display:flex;"><span>  ): Int {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">update</span>(
</span></span><span style="display:flex;"><span>    uri: Uri,
</span></span><span style="display:flex;"><span>    contentValues: ContentValues?,
</span></span><span style="display:flex;"><span>    s: String?,
</span></span><span style="display:flex;"><span>    strings: Array&lt;String&gt;?
</span></span><span style="display:flex;"><span>  ): Int {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>我们可以看到，这个类是一个<code>ContentProvider</code>的子类，其query, insert等方法根本没有实际作用，有实际作用的只有<code>onCreate</code>方法，在这个方法中，执行了<code>AppWatcher</code>的install工作。</p>
<p>这里我们就可以看出来，LeakCanary就是利用<code>ContentProvider</code>的<code>onCreate</code>方法自动执行的特性，来自动“安装”这个类库的。</p>
<h3 id="初始化">初始化</h3>
<p>通过追踪<code>AppWatcher.manualInstall(application)</code>这句代码，我们可以追踪到<a href="https://github.com/square/leakcanary/blob/main/leakcanary-android-core/src/main/java/leakcanary/internal/InternalLeakCanary.kt"><strong>InternalLeakCanary.kt</strong></a>的<code>install</code>方法，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">install</span>(application: Application) {
</span></span><span style="display:flex;"><span>  checkMainThread()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span><span style="color:#f92672">::</span>application.isInitialized) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  InternalAppWatcher.application = application
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (isDebuggableBuild) {
</span></span><span style="display:flex;"><span>    SharkLog.logger = DefaultCanaryLog()
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> configProvider = { AppWatcher.config }
</span></span><span style="display:flex;"><span>  ActivityDestroyWatcher.install(application, objectWatcher, configProvider)
</span></span><span style="display:flex;"><span>  FragmentDestroyWatcher.install(application, objectWatcher, configProvider)
</span></span><span style="display:flex;"><span>  onAppWatcherInstalled(application)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>我们可以看到，先后执行了<code>ActivityDestroyWatcher.install</code>,<code>FragmentDestroyWatcher.install</code>和<code>onAppWatcherInstalled(application)</code>方法。</p>
<p>其中在<code>onAppWatcherInstalled</code>创建了LeakCanary图标的快捷方式，用于方便查看内存泄漏的路径信息。最终实现的具体过程可以查看<a href="https://github.com/square/leakcanary/blob/main/leakcanary-android-core/src/main/java/leakcanary/internal/InternalLeakCanary.kt"><strong>InternalLeakCanary.kt</strong></a>的<code>addDynamicShortcut</code>方法。</p>
<p>其他的两段代码——<code>ActivityDestroyWatcher.install</code>和<code>FragmentDestroyWatcher.install</code>，分别对应着两个类——<code>ActivityDestroyWatcher</code>和<code>FragmentDestroyWatcher</code>。这两个类相对来说比较简单，主要工作就是执行了<code>application.registerActivityLifecycleCallbacks</code>这段代码，目的是为了监听每个Activity的onDestroy事件。这也是判断该Activity是否泄漏的开端。</p>
<p>以<code>ActivityDestroyWatcher</code>为例，其ActivityLifecycleCallback中代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">val</span> lifecycleCallbacks =
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">object</span> <span style="color:#960050;background-color:#1e0010">: </span><span style="color:#a6e22e">Application</span>.ActivityLifecycleCallbacks <span style="color:#66d9ef">by</span> noOpDelegate() {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">onActivityDestroyed</span>(activity: Activity) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (configProvider().watchActivities) {
</span></span><span style="display:flex;"><span>          objectWatcher.watch(
</span></span><span style="display:flex;"><span>              activity, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${activity::class.java.name}</span><span style="color:#e6db74"> received Activity#onDestroy() callback&#34;</span>
</span></span><span style="display:flex;"><span>          )
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>我们可以看到，这其中，最终是<code>objectWatcher</code>来进行内存泄漏监控的。</p>
<h2 id="如何检测到内存泄漏的">如何检测到内存泄漏的</h2>
<p>这里涉及到两个关键的类：<strong><a href="https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher/src/main/java/leakcanary/ObjectWatcher.kt"><code>ObjectWatcher</code></a><strong>和</strong><a href="https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher/src/main/java/leakcanary/KeyedWeakReference.kt"><code>KeyedWeakReference</code></a></strong>。</p>
<p><code>KeyedWeakReference</code>是<code>WeakReference</code>的子类，添加了额外的属性，代码十分简单，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KeyedWeakReference</span>(
</span></span><span style="display:flex;"><span>  referent: Any,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> key: String,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> description: String,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> watchUptimeMillis: Long,
</span></span><span style="display:flex;"><span>  referenceQueue: ReferenceQueue&lt;Any&gt;
</span></span><span style="display:flex;"><span>) : WeakReference&lt;Any&gt;(
</span></span><span style="display:flex;"><span>    referent, referenceQueue
</span></span><span style="display:flex;"><span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * Time at which the associated object ([referent]) was considered retained, or -1 if it hasn&#39;t
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * been yet.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@Volatile</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> retainedUptimeMillis = -<span style="color:#ae81ff">1L</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">companion</span> <span style="color:#66d9ef">object</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Volatile</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@JvmStatic</span> <span style="color:#66d9ef">var</span> heapDumpUptimeMillis = <span style="color:#ae81ff">0L</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>接下来我们看<code>ObjectWatcher</code>中的<code>watchObject</code>方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * Watches the provided [watchedObject].
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param description Describes why the object is watched.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@Synchronized</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">watch</span>(
</span></span><span style="display:flex;"><span>    watchedObject: Any,
</span></span><span style="display:flex;"><span>    description: String
</span></span><span style="display:flex;"><span>  ) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!is</span>Enabled()) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    removeWeaklyReachableObjects()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> key = UUID.randomUUID()
</span></span><span style="display:flex;"><span>        .toString()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> watchUptimeMillis = clock.uptimeMillis()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> reference =
</span></span><span style="display:flex;"><span>      KeyedWeakReference(watchedObject, key, description, watchUptimeMillis, queue)
</span></span><span style="display:flex;"><span>    SharkLog.d {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Watching &#34;</span> +
</span></span><span style="display:flex;"><span>          (<span style="color:#66d9ef">if</span> (watchedObject <span style="color:#66d9ef">is</span> Class&lt;*&gt;) watchedObject.toString() <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;instance of </span><span style="color:#e6db74">${watchedObject.javaClass.name}</span><span style="color:#e6db74">&#34;</span>) +
</span></span><span style="display:flex;"><span>          (<span style="color:#66d9ef">if</span> (description.isNotEmpty()) <span style="color:#e6db74">&#34; (</span><span style="color:#e6db74">$description</span><span style="color:#e6db74">)&#34;</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;&#34;</span>) +
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34; with key </span><span style="color:#e6db74">$key</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    watchedObjects[key] = reference
</span></span><span style="display:flex;"><span>    checkRetainedExecutor.execute {
</span></span><span style="display:flex;"><span>      moveToRetained(key)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>这里分为三步：</p>
<ol>
<li>执行<code>removeWeaklyReachableObjects()</code>方法，这个方法之后讲到；</li>
<li>生成一个<code>KeyedWeakReference</code>对象，并将这个对象添加到<code>watchedObjects</code>去；</li>
<li>定时执行<code>moveToRetained</code>方法。</li>
</ol>
<ul>
<li>
<p>我们先看第二步，生成<code>KeyedWeakReference</code>对象时候，传入了一个一个<code>ReferenceQueue</code>对象，这是检测对象是否被回收的关键。假如一个对象O，被弱引用WR持有的时候，同时这个弱引用WR在构造时候传入了一个<code>ReferenceQueue</code>对象Q，则这个对象O被回收时候，WR将会被添加到Q中去，这样，通过检测Q中有没有值，便可以知道O有没有被回收掉。这也就是第一步做的事。</p>
</li>
<li>
<p>接下来我们查看<code>removeWeaklyReachableObjects</code>方法中做了什么。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">removeWeaklyReachableObjects</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// WeakReferences are enqueued as soon as the object to which they point to becomes weakly
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// reachable. This is before finalization or garbage collection has actually happened.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">var</span> ref: KeyedWeakReference?
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    ref = queue.poll() <span style="color:#66d9ef">as</span> KeyedWeakReference?
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (ref <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>      watchedObjects.remove(ref.key)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span> (ref <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在这个方法中，从queue中取值，取出来ref，则说明被ref修饰的对象已经被回收了，则将这个弱引用ref从<code>watchedObjects</code>清除掉。</p>
<ul>
<li>接下来到了第三步，这一步实际上是一个定时5秒(LeakCanary默认)去将watchedObjects中残留的引用，移入到<code>retainedObjects</code>中去。我们来看其中代码：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#a6e22e">@Synchronized</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">moveToRetained</span>(key: String) {
</span></span><span style="display:flex;"><span>  removeWeaklyReachableObjects()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> retainedRef = watchedObjects[key]
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (retainedRef <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>    retainedRef.retainedUptimeMillis = clock.uptimeMillis()
</span></span><span style="display:flex;"><span>    onObjectRetainedListeners.forEach { <span style="color:#66d9ef">it</span>.onObjectRetained() }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>执行这个任务的Executor实际实现在<a href="https://github.com/square/leakcanary/blob/main/leakcanary-object-watcher-android/src/main/java/leakcanary/internal/InternalAppWatcher.kt"><strong>InternalAppWatcher.kt</strong></a>中，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">val</span> checkRetainedExecutor = Executor {
</span></span><span style="display:flex;"><span>  mainHandler.postDelayed(<span style="color:#66d9ef">it</span>, AppWatcher.config.watchDurationMillis)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>我们发现，在<code>moveToRetained</code>中，还是先执行了<code>removeWeaklyReachableObjects</code>这一方法。目的是再次清除已经被回收的对象。如果经过这一步，仍然有引用留在watchedObjects中，则可以认为，这些对象泄漏了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * Returns the objects that are currently considered retained. Useful for logging purposes.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * Be careful with those objects and release them ASAP as you may creating longer lived leaks
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * then the one that are already there.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">val</span> retainedObjects: List&lt;Any&gt;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Synchronized</span> <span style="color:#66d9ef">get</span>() {
</span></span><span style="display:flex;"><span>  removeWeaklyReachableObjects()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> instances = mutableListOf&lt;Any&gt;()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (weakReference <span style="color:#66d9ef">in</span> watchedObjects.values) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (weakReference.retainedUptimeMillis <span style="color:#f92672">!=</span> -<span style="color:#ae81ff">1L</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">val</span> instance = weakReference.<span style="color:#66d9ef">get</span>()
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (instance <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        instances.add(instance)
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> instances
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="总结">总结</h2>
<p>不要在发行版本中使用LeakCanary，因为一系列初始化动作，可能会导致应用启动较慢。如果要用，请使用LeakCanary-Object-Watcher，或者直接使用Buggly这样的成熟框架。</p>
</section>

  
  
  <footer class="mt-12 flex flex-wrap">
     
    <a
      class="mr-1.5 mb-1.5 rounded-lg bg-black/[3%] px-5 py-2 no-underline dark:bg-white/[8%]"
      href="https://boybeak.github.io/tags/untagged"
      >untagged</a
    >
    
  </footer>
  

  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    <a class="flex w-1/2 items-center p-6 pr-3 no-underline" href="https://boybeak.github.io/posts/-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/jetpack%E4%B9%8Blivedata%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
      ><span class="mr-1.5">←</span><span>Jetpack之LiveData源码分析</span></a
    >
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end p-6 pl-3 no-underline"
      href="https://boybeak.github.io/posts/-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/liveeventbus%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
      ><span>LiveEventBus源码分析</span><span class="ml-1.5">→</span></a
    >
    
  </nav>
  

  
  
  <div id="disqus_thread"></div>
  <script>
    const disqusShortname = 'YOUR_DISQUS_SHORTNAME';
    const script = document.createElement('script');
    script.src = 'https://' + disqusShortname + '.disqus.com/embed.js';
    script.setAttribute('data-timestamp', +new Date());
    document.head.appendChild(script);
  </script>
  
</article>


    </main>

    <footer class="opaco mx-auto flex h-[5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60">
  <div class="mr-auto">
    &copy; 2022
    <a class="link" href="https://boybeak.github.io/">My New Hugo Site</a>
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank">Powered by Hugo️️</a
  >️
  <a class="link" href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank"
    >▷ Paper 6</a
  >
</footer>

  </body>
</html>
