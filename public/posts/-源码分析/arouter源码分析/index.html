<!DOCTYPE html>






































<html
  class="not-ready text-sm lg:text-base"
  style="--bg: #faf6f1"
  lang="en-us"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>ARouter源码分析 - My New Hugo Site</title>

  
  <meta name="theme-color" />
  
  <meta name="description" content="ARouter源码分析 在阅读源码前，请先下载源码：ARouter
最近阅读ARouter源码，发现这真的是一个非常优秀的框架。激发出兴趣来读一下他的源码，实际上，这个框架的结构非常简单。这个框架可以分为主流程和辅助流程来拆开分析。
主流程包含编译时和运行时两个部分，其中编译时主要做的是路由路径表的构建，运行时主要做的是路由路径表的加载；
辅助流程主要就是做启动优化。
主流程 1. 编译时 这部分主要涉及到的是路由路径表的构建，其实现原理是APT，即注解处理器。
使用ARouter时候，需要在目标类上，通过**@Route注解进行标记，注解处理器处理的就是这个注解。打开源码路径下的arouter-compiler这个module，找到RouteProcessor**，这个类就是用来处理**@Route**注解的类。这里需要了解的知识，除了APT，还有java-poet，请自行了解这些。
Processor类的入口方法是process方法，这个方法返回true，则这个处理器已经完成了自己的任务，不会被重复调用。其他比较重要的方法有getSupportedSourceVersion，getSupportedAnnotationTypes等。
Set&lt;? extends Element&gt; routeElements = roundEnv.getElementsAnnotatedWith(Route.class); 通过这个方法，获取所有被**@Route**标记的元素。
获取到routeElements后，在parseRoutes方法进行处理。我们以最常用的Activity为例，进行分析。
rootMap.clear();	//用来分类存储标记元素 // 用来检测元素是否为对应的类型，通过Types.isSubtype()方法来检测。 TypeMirror type_Activity = elementUtils.getTypeElement(ACTIVITY).asType(); TypeMirror type_Service = elementUtils.getTypeElement(SERVICE).asType(); TypeMirror fragmentTm = elementUtils.getTypeElement(FRAGMENT).asType(); TypeMirror fragmentTmV4 = elementUtils.getTypeElement(Consts.FRAGMENT_V4).asType(); 最后将分类号的元素信息，存储在成员变量groupMap中去。
private Map&lt;String, Set&lt;RouteMeta&gt;&gt; groupMap = new HashMap&lt;&gt;(); 然后再通过这个groupMap，借助java-poet，来生成真实的类。如下：
public class ARouter$$Group$$test implements IRouteGroup { @Override public void loadInto(Map&lt;String, RouteMeta&gt; atlas) { atlas.put(&#34;/test/activity1&#34;, RouteMeta.build(RouteType.ACTIVITY, Test1Activity.class, &#34;/test/activity1&#34;, &#34;test&#34;, new java.util.HashMap&lt;String, Integer&gt;(){{put(&#34;ser&#34;, 9); put(&#34;ch&#34;, 5); put(&#34;fl&#34;, 6); put(&#34;dou&#34;, 7); put(&#34;boy&#34;, 0); put(&#34;url&#34;, 8); put(&#34;pac&#34;, 10); put(&#34;obj&#34;, 11); put(&#34;name&#34;, 8); put(&#34;objList&#34;, 11); put(&#34;map&#34;, 11); put(&#34;age&#34;, 3); put(&#34;height&#34;, 3); }}, -1, -2147483648)); atlas." />
  <meta name="author" content="" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://boybeak.github.io/main.min.css" />

  

  
  
  
    
  
  <link
    rel="preload"
    as="image"
    href="https://boybeak.github.io/theme.png"
  />

  
  
  
  <link rel="preload" as="image" href="https://www.gravatar.com/avatar/6fd8df4abe41f17fd8e2dd7d97b5cc8c?s=160&amp;d=identicon" />
  
  

  
  <link rel="preload" as="image" href="https://boybeak.github.io/twitter.svg" />
  
  <link rel="preload" as="image" href="https://boybeak.github.io/github.svg" />
  
  <link rel="preload" as="image" href="https://boybeak.github.io/instagram.svg" />
  
  <link rel="preload" as="image" href="https://boybeak.github.io/rss.svg" />
  

  
  <link rel="icon" href="https://boybeak.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://boybeak.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.101.0" />

  
  

  
  
  
  
  
  
  
  
  
  <meta property="og:title" content="ARouter源码分析" />
<meta property="og:description" content="ARouter源码分析 在阅读源码前，请先下载源码：ARouter
最近阅读ARouter源码，发现这真的是一个非常优秀的框架。激发出兴趣来读一下他的源码，实际上，这个框架的结构非常简单。这个框架可以分为主流程和辅助流程来拆开分析。
主流程包含编译时和运行时两个部分，其中编译时主要做的是路由路径表的构建，运行时主要做的是路由路径表的加载；
辅助流程主要就是做启动优化。
主流程 1. 编译时 这部分主要涉及到的是路由路径表的构建，其实现原理是APT，即注解处理器。
使用ARouter时候，需要在目标类上，通过**@Route注解进行标记，注解处理器处理的就是这个注解。打开源码路径下的arouter-compiler这个module，找到RouteProcessor**，这个类就是用来处理**@Route**注解的类。这里需要了解的知识，除了APT，还有java-poet，请自行了解这些。
Processor类的入口方法是process方法，这个方法返回true，则这个处理器已经完成了自己的任务，不会被重复调用。其他比较重要的方法有getSupportedSourceVersion，getSupportedAnnotationTypes等。
Set&lt;? extends Element&gt; routeElements = roundEnv.getElementsAnnotatedWith(Route.class); 通过这个方法，获取所有被**@Route**标记的元素。
获取到routeElements后，在parseRoutes方法进行处理。我们以最常用的Activity为例，进行分析。
rootMap.clear();	//用来分类存储标记元素 // 用来检测元素是否为对应的类型，通过Types.isSubtype()方法来检测。 TypeMirror type_Activity = elementUtils.getTypeElement(ACTIVITY).asType(); TypeMirror type_Service = elementUtils.getTypeElement(SERVICE).asType(); TypeMirror fragmentTm = elementUtils.getTypeElement(FRAGMENT).asType(); TypeMirror fragmentTmV4 = elementUtils.getTypeElement(Consts.FRAGMENT_V4).asType(); 最后将分类号的元素信息，存储在成员变量groupMap中去。
private Map&lt;String, Set&lt;RouteMeta&gt;&gt; groupMap = new HashMap&lt;&gt;(); 然后再通过这个groupMap，借助java-poet，来生成真实的类。如下：
public class ARouter$$Group$$test implements IRouteGroup { @Override public void loadInto(Map&lt;String, RouteMeta&gt; atlas) { atlas.put(&#34;/test/activity1&#34;, RouteMeta.build(RouteType.ACTIVITY, Test1Activity.class, &#34;/test/activity1&#34;, &#34;test&#34;, new java.util.HashMap&lt;String, Integer&gt;(){{put(&#34;ser&#34;, 9); put(&#34;ch&#34;, 5); put(&#34;fl&#34;, 6); put(&#34;dou&#34;, 7); put(&#34;boy&#34;, 0); put(&#34;url&#34;, 8); put(&#34;pac&#34;, 10); put(&#34;obj&#34;, 11); put(&#34;name&#34;, 8); put(&#34;objList&#34;, 11); put(&#34;map&#34;, 11); put(&#34;age&#34;, 3); put(&#34;height&#34;, 3); }}, -1, -2147483648)); atlas." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://boybeak.github.io/posts/-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/arouter%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-03T21:03:05+08:00" />
<meta property="article:modified_time" content="2022-09-03T21:03:05+08:00" />


  
  <meta itemprop="name" content="ARouter源码分析">
<meta itemprop="description" content="ARouter源码分析 在阅读源码前，请先下载源码：ARouter
最近阅读ARouter源码，发现这真的是一个非常优秀的框架。激发出兴趣来读一下他的源码，实际上，这个框架的结构非常简单。这个框架可以分为主流程和辅助流程来拆开分析。
主流程包含编译时和运行时两个部分，其中编译时主要做的是路由路径表的构建，运行时主要做的是路由路径表的加载；
辅助流程主要就是做启动优化。
主流程 1. 编译时 这部分主要涉及到的是路由路径表的构建，其实现原理是APT，即注解处理器。
使用ARouter时候，需要在目标类上，通过**@Route注解进行标记，注解处理器处理的就是这个注解。打开源码路径下的arouter-compiler这个module，找到RouteProcessor**，这个类就是用来处理**@Route**注解的类。这里需要了解的知识，除了APT，还有java-poet，请自行了解这些。
Processor类的入口方法是process方法，这个方法返回true，则这个处理器已经完成了自己的任务，不会被重复调用。其他比较重要的方法有getSupportedSourceVersion，getSupportedAnnotationTypes等。
Set&lt;? extends Element&gt; routeElements = roundEnv.getElementsAnnotatedWith(Route.class); 通过这个方法，获取所有被**@Route**标记的元素。
获取到routeElements后，在parseRoutes方法进行处理。我们以最常用的Activity为例，进行分析。
rootMap.clear();	//用来分类存储标记元素 // 用来检测元素是否为对应的类型，通过Types.isSubtype()方法来检测。 TypeMirror type_Activity = elementUtils.getTypeElement(ACTIVITY).asType(); TypeMirror type_Service = elementUtils.getTypeElement(SERVICE).asType(); TypeMirror fragmentTm = elementUtils.getTypeElement(FRAGMENT).asType(); TypeMirror fragmentTmV4 = elementUtils.getTypeElement(Consts.FRAGMENT_V4).asType(); 最后将分类号的元素信息，存储在成员变量groupMap中去。
private Map&lt;String, Set&lt;RouteMeta&gt;&gt; groupMap = new HashMap&lt;&gt;(); 然后再通过这个groupMap，借助java-poet，来生成真实的类。如下：
public class ARouter$$Group$$test implements IRouteGroup { @Override public void loadInto(Map&lt;String, RouteMeta&gt; atlas) { atlas.put(&#34;/test/activity1&#34;, RouteMeta.build(RouteType.ACTIVITY, Test1Activity.class, &#34;/test/activity1&#34;, &#34;test&#34;, new java.util.HashMap&lt;String, Integer&gt;(){{put(&#34;ser&#34;, 9); put(&#34;ch&#34;, 5); put(&#34;fl&#34;, 6); put(&#34;dou&#34;, 7); put(&#34;boy&#34;, 0); put(&#34;url&#34;, 8); put(&#34;pac&#34;, 10); put(&#34;obj&#34;, 11); put(&#34;name&#34;, 8); put(&#34;objList&#34;, 11); put(&#34;map&#34;, 11); put(&#34;age&#34;, 3); put(&#34;height&#34;, 3); }}, -1, -2147483648)); atlas."><meta itemprop="datePublished" content="2022-09-03T21:03:05+08:00" />
<meta itemprop="dateModified" content="2022-09-03T21:03:05+08:00" />
<meta itemprop="wordCount" content="967">
<meta itemprop="keywords" content="untagged," />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ARouter源码分析"/>
<meta name="twitter:description" content="ARouter源码分析 在阅读源码前，请先下载源码：ARouter
最近阅读ARouter源码，发现这真的是一个非常优秀的框架。激发出兴趣来读一下他的源码，实际上，这个框架的结构非常简单。这个框架可以分为主流程和辅助流程来拆开分析。
主流程包含编译时和运行时两个部分，其中编译时主要做的是路由路径表的构建，运行时主要做的是路由路径表的加载；
辅助流程主要就是做启动优化。
主流程 1. 编译时 这部分主要涉及到的是路由路径表的构建，其实现原理是APT，即注解处理器。
使用ARouter时候，需要在目标类上，通过**@Route注解进行标记，注解处理器处理的就是这个注解。打开源码路径下的arouter-compiler这个module，找到RouteProcessor**，这个类就是用来处理**@Route**注解的类。这里需要了解的知识，除了APT，还有java-poet，请自行了解这些。
Processor类的入口方法是process方法，这个方法返回true，则这个处理器已经完成了自己的任务，不会被重复调用。其他比较重要的方法有getSupportedSourceVersion，getSupportedAnnotationTypes等。
Set&lt;? extends Element&gt; routeElements = roundEnv.getElementsAnnotatedWith(Route.class); 通过这个方法，获取所有被**@Route**标记的元素。
获取到routeElements后，在parseRoutes方法进行处理。我们以最常用的Activity为例，进行分析。
rootMap.clear();	//用来分类存储标记元素 // 用来检测元素是否为对应的类型，通过Types.isSubtype()方法来检测。 TypeMirror type_Activity = elementUtils.getTypeElement(ACTIVITY).asType(); TypeMirror type_Service = elementUtils.getTypeElement(SERVICE).asType(); TypeMirror fragmentTm = elementUtils.getTypeElement(FRAGMENT).asType(); TypeMirror fragmentTmV4 = elementUtils.getTypeElement(Consts.FRAGMENT_V4).asType(); 最后将分类号的元素信息，存储在成员变量groupMap中去。
private Map&lt;String, Set&lt;RouteMeta&gt;&gt; groupMap = new HashMap&lt;&gt;(); 然后再通过这个groupMap，借助java-poet，来生成真实的类。如下：
public class ARouter$$Group$$test implements IRouteGroup { @Override public void loadInto(Map&lt;String, RouteMeta&gt; atlas) { atlas.put(&#34;/test/activity1&#34;, RouteMeta.build(RouteType.ACTIVITY, Test1Activity.class, &#34;/test/activity1&#34;, &#34;test&#34;, new java.util.HashMap&lt;String, Integer&gt;(){{put(&#34;ser&#34;, 9); put(&#34;ch&#34;, 5); put(&#34;fl&#34;, 6); put(&#34;dou&#34;, 7); put(&#34;boy&#34;, 0); put(&#34;url&#34;, 8); put(&#34;pac&#34;, 10); put(&#34;obj&#34;, 11); put(&#34;name&#34;, 8); put(&#34;objList&#34;, 11); put(&#34;map&#34;, 11); put(&#34;age&#34;, 3); put(&#34;height&#34;, 3); }}, -1, -2147483648)); atlas."/>

  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a class="-translate-x-[1px] -translate-y-0.5 text-3xl font-bold" href="https://boybeak.github.io/"
      >My New Hugo Site</a
    >
    <a
      class="btn-dark ml-6 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.svg)_left_center/cover_no-repeat] dark:invert dark:[background-position:right]"
    ></a>
  </div>

  <a
    class="btn-menu relative z-50 -mr-8 flex h-[5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
  ></a>

  
  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = `"#faf6f1"`.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    const darkVal = localStorage.getItem('dark');
    setDark(darkVal ? darkVal === 'true' : darkScheme.matches);

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 dark:invert lg:mt-0 lg:ml-12 lg:items-center lg:space-x-6"
    >
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./twitter.svg)"
        href=" https://twitter.com/YOUR_TWITTER_ID "
        target="_blank"
      ></a>
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href=" https://github.com/YOUR_GITHUB_ID "
        target="_blank"
      ></a>
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./instagram.svg)"
        href=" https://instagram.com/YOUR_INSTAGRAM_ID "
        target="_blank"
      ></a>
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./rss.svg)"
        href=" https://boybeak.github.io/index.xml "
        target="_blank"
      ></a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-10rem)] max-w-3xl px-8 pt-20 pb-32 dark:prose-invert"
    >
      

<article>
  <header class="mb-20">
    <h1 class="!my-0 pb-2.5">ARouter源码分析</h1>

    
    <div class="text-sm opacity-60">
      
      <time>Sep 3, 2022</time>
      
      
    </div>
    
  </header>

  <section><h1 id="arouter源码分析">ARouter源码分析</h1>
<p>在阅读源码前，请先下载源码：<a href="https://github.com/alibaba/ARouter">ARouter</a></p>
<p>最近阅读ARouter源码，发现这真的是一个非常优秀的框架。激发出兴趣来读一下他的源码，实际上，这个框架的结构非常简单。这个框架可以分为<strong>主流程</strong>和<strong>辅助流程</strong>来拆开分析。</p>
<p>主流程包含<strong>编译时</strong>和<strong>运行时</strong>两个部分，其中编译时主要做的是路由路径表的构建，运行时主要做的是路由路径表的加载；</p>
<p>辅助流程主要就是做<strong>启动优化</strong>。</p>
<h2 id="主流程">主流程</h2>
<h3 id="1-编译时">1. 编译时</h3>
<p>这部分主要涉及到的是路由路径表的构建，其实现原理是<strong>APT</strong>，即<strong>注解处理器</strong>。</p>
<p>使用ARouter时候，需要在目标类上，通过**@Route<strong>注解进行标记，注解处理器处理的就是这个注解。打开源码路径下的<em>arouter-compiler</em>这个module，找到</strong>RouteProcessor**，这个类就是用来处理**@Route**注解的类。这里需要了解的知识，除了APT，还有java-poet，请自行了解这些。</p>
<p>Processor类的入口方法是<em>process</em>方法，这个方法返回true，则这个处理器已经完成了自己的任务，不会被重复调用。其他比较重要的方法有<em>getSupportedSourceVersion</em>，<em>getSupportedAnnotationTypes</em>等。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Set<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Element<span style="color:#f92672">&gt;</span> routeElements <span style="color:#f92672">=</span> roundEnv<span style="color:#f92672">.</span><span style="color:#a6e22e">getElementsAnnotatedWith</span><span style="color:#f92672">(</span>Route<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span></code></pre></div><p>通过这个方法，获取所有被**@Route**标记的元素。</p>
<p>获取到<em>routeElements</em>后，在<em>parseRoutes</em>方法进行处理。我们以最常用的Activity为例，进行分析。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>rootMap<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>	<span style="color:#75715e">//用来分类存储标记元素
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 用来检测元素是否为对应的类型，通过Types.isSubtype()方法来检测。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>TypeMirror type_Activity <span style="color:#f92672">=</span> elementUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getTypeElement</span><span style="color:#f92672">(</span>ACTIVITY<span style="color:#f92672">).</span><span style="color:#a6e22e">asType</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>TypeMirror type_Service <span style="color:#f92672">=</span> elementUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getTypeElement</span><span style="color:#f92672">(</span>SERVICE<span style="color:#f92672">).</span><span style="color:#a6e22e">asType</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>TypeMirror fragmentTm <span style="color:#f92672">=</span> elementUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getTypeElement</span><span style="color:#f92672">(</span>FRAGMENT<span style="color:#f92672">).</span><span style="color:#a6e22e">asType</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>TypeMirror fragmentTmV4 <span style="color:#f92672">=</span> elementUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getTypeElement</span><span style="color:#f92672">(</span>Consts<span style="color:#f92672">.</span><span style="color:#a6e22e">FRAGMENT_V4</span><span style="color:#f92672">).</span><span style="color:#a6e22e">asType</span><span style="color:#f92672">();</span>
</span></span></code></pre></div><p>最后将分类号的元素信息，存储在成员变量groupMap中去。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Set<span style="color:#f92672">&lt;</span>RouteMeta<span style="color:#f92672">&gt;&gt;</span> groupMap <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span></code></pre></div><p>然后再通过这个groupMap，借助java-poet，来生成真实的类。如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ARouter$$Group$$test</span> <span style="color:#66d9ef">implements</span> IRouteGroup <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loadInto</span><span style="color:#f92672">(</span>Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RouteMeta<span style="color:#f92672">&gt;</span> atlas<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    atlas<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/test/activity1&#34;</span><span style="color:#f92672">,</span> RouteMeta<span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">(</span>RouteType<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTIVITY</span><span style="color:#f92672">,</span> Test1Activity<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;/test/activity1&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;test&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">HashMap</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Integer<span style="color:#f92672">&gt;(){{</span>put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ser&#34;</span><span style="color:#f92672">,</span> 9<span style="color:#f92672">);</span> put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ch&#34;</span><span style="color:#f92672">,</span> 5<span style="color:#f92672">);</span> put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;fl&#34;</span><span style="color:#f92672">,</span> 6<span style="color:#f92672">);</span> put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;dou&#34;</span><span style="color:#f92672">,</span> 7<span style="color:#f92672">);</span> put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;boy&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span> put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;url&#34;</span><span style="color:#f92672">,</span> 8<span style="color:#f92672">);</span> put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;pac&#34;</span><span style="color:#f92672">,</span> 10<span style="color:#f92672">);</span> put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;obj&#34;</span><span style="color:#f92672">,</span> 11<span style="color:#f92672">);</span> put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">,</span> 8<span style="color:#f92672">);</span> put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;objList&#34;</span><span style="color:#f92672">,</span> 11<span style="color:#f92672">);</span> put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;map&#34;</span><span style="color:#f92672">,</span> 11<span style="color:#f92672">);</span> put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;age&#34;</span><span style="color:#f92672">,</span> 3<span style="color:#f92672">);</span> put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;height&#34;</span><span style="color:#f92672">,</span> 3<span style="color:#f92672">);</span> <span style="color:#f92672">}},</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">,</span> <span style="color:#f92672">-</span>2147483648<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    atlas<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/test/activity2&#34;</span><span style="color:#f92672">,</span> RouteMeta<span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">(</span>RouteType<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTIVITY</span><span style="color:#f92672">,</span> Test2Activity<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;/test/activity2&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;test&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">HashMap</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Integer<span style="color:#f92672">&gt;(){{</span>put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;key1&#34;</span><span style="color:#f92672">,</span> 8<span style="color:#f92672">);</span> <span style="color:#f92672">}},</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">,</span> <span style="color:#f92672">-</span>2147483648<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    atlas<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/test/activity3&#34;</span><span style="color:#f92672">,</span> RouteMeta<span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">(</span>RouteType<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTIVITY</span><span style="color:#f92672">,</span> Test3Activity<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;/test/activity3&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;test&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">HashMap</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Integer<span style="color:#f92672">&gt;(){{</span>put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">,</span> 8<span style="color:#f92672">);</span> put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;boy&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span> put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;age&#34;</span><span style="color:#f92672">,</span> 3<span style="color:#f92672">);</span> <span style="color:#f92672">}},</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">,</span> <span style="color:#f92672">-</span>2147483648<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    atlas<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/test/activity4&#34;</span><span style="color:#f92672">,</span> RouteMeta<span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">(</span>RouteType<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTIVITY</span><span style="color:#f92672">,</span> Test4Activity<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;/test/activity4&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;test&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">,</span> <span style="color:#f92672">-</span>2147483648<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    atlas<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/test/fragment&#34;</span><span style="color:#f92672">,</span> RouteMeta<span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">(</span>RouteType<span style="color:#f92672">.</span><span style="color:#a6e22e">FRAGMENT</span><span style="color:#f92672">,</span> BlankFragment<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;/test/fragment&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;test&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">HashMap</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Integer<span style="color:#f92672">&gt;(){{</span>put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;obj&#34;</span><span style="color:#f92672">,</span> 11<span style="color:#f92672">);</span> put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">,</span> 8<span style="color:#f92672">);</span> <span style="color:#f92672">}},</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">,</span> <span style="color:#f92672">-</span>2147483648<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    atlas<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/test/webview&#34;</span><span style="color:#f92672">,</span> RouteMeta<span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">(</span>RouteType<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTIVITY</span><span style="color:#f92672">,</span> TestWebview<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;/test/webview&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;test&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">,</span> <span style="color:#f92672">-</span>2147483648<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="2-运行时">2. 运行时</h3>
<p>这部分主要做的是，在*ARouter.init()*时候，将上过程生成的路径表加载到内存中。</p>
<blockquote>
<p>如果你以官方demo程序验证这一步，需要将app/build.gradle中的<code>apply plugin: 'com.alibaba.arouter'</code>这一行代码注释掉。</p>
</blockquote>
<p>我们以<em>ARouter.init</em>方法为入口，实际上最终实现init流程的是LogisticsCenter类的<em>init</em>方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">,</span> ThreadPoolExecutor tpe<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> HandlerException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>registerByPlugin<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//这是在辅助流程需要去讲的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  	logger<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Load router map by arouter-auto-register plugin.&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> routerMap<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// It will rebuild router map every times when debuggable.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ARouter<span style="color:#f92672">.</span><span style="color:#a6e22e">debuggable</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span> PackageUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isNewVersion</span><span style="color:#f92672">(</span>context<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      logger<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Run with debug mode or new install, rebuild router map.&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// These class was generated by arouter-compiler.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      routerMap <span style="color:#f92672">=</span> ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getFileNameByPackageName</span><span style="color:#f92672">(</span>mContext<span style="color:#f92672">,</span> ROUTE_ROOT_PAKCAGE<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>routerMap<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        context<span style="color:#f92672">.</span><span style="color:#a6e22e">getSharedPreferences</span><span style="color:#f92672">(</span>AROUTER_SP_CACHE_KEY<span style="color:#f92672">,</span> Context<span style="color:#f92672">.</span><span style="color:#a6e22e">MODE_PRIVATE</span><span style="color:#f92672">).</span><span style="color:#a6e22e">edit</span><span style="color:#f92672">().</span><span style="color:#a6e22e">putStringSet</span><span style="color:#f92672">(</span>AROUTER_SP_KEY_MAP<span style="color:#f92672">,</span> routerMap<span style="color:#f92672">).</span><span style="color:#a6e22e">apply</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      PackageUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">updateVersion</span><span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>    <span style="color:#75715e">// Save new version name when router map update finishes.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      logger<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Load router map from cache.&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      routerMap <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;(</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">getSharedPreferences</span><span style="color:#f92672">(</span>AROUTER_SP_CACHE_KEY<span style="color:#f92672">,</span> Context<span style="color:#f92672">.</span><span style="color:#a6e22e">MODE_PRIVATE</span><span style="color:#f92672">).</span><span style="color:#a6e22e">getStringSet</span><span style="color:#f92672">(</span>AROUTER_SP_KEY_MAP<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;()));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>这里需要着重看的是这一句：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>routerMap <span style="color:#f92672">=</span> ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getFileNameByPackageName</span><span style="color:#f92672">(</span>mContext<span style="color:#f92672">,</span> ROUTE_ROOT_PAKCAGE<span style="color:#f92672">);</span>
</span></span></code></pre></div><p>我们查看这个方法:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getFileNameByPackageName</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String packageName<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> PackageManager<span style="color:#f92672">.</span><span style="color:#a6e22e">NameNotFoundException</span><span style="color:#f92672">,</span> IOException<span style="color:#f92672">,</span> InterruptedException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> classNames <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> paths <span style="color:#f92672">=</span> getSourcePaths<span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> CountDownLatch parserCtl <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CountDownLatch<span style="color:#f92672">(</span>paths<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String path <span style="color:#f92672">:</span> paths<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;getFileNameByPackageName path=&#34;</span> <span style="color:#f92672">+</span> path<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    DefaultPoolExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        DexFile dexfile <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>path<span style="color:#f92672">.</span><span style="color:#a6e22e">endsWith</span><span style="color:#f92672">(</span>EXTRACTED_SUFFIX<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//NOT use new DexFile(path), because it will throw &#34;permission error in /data/dalvik-cache&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            dexfile <span style="color:#f92672">=</span> DexFile<span style="color:#f92672">.</span><span style="color:#a6e22e">loadDex</span><span style="color:#f92672">(</span>path<span style="color:#f92672">,</span> path <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.tmp&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            dexfile <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DexFile<span style="color:#f92672">(</span>path<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          Enumeration<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> dexEntries <span style="color:#f92672">=</span> dexfile<span style="color:#f92672">.</span><span style="color:#a6e22e">entries</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>dexEntries<span style="color:#f92672">.</span><span style="color:#a6e22e">hasMoreElements</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            String className <span style="color:#f92672">=</span> dexEntries<span style="color:#f92672">.</span><span style="color:#a6e22e">nextElement</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>className<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span>packageName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>              Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;find CLASS NAME &#34;</span> <span style="color:#f92672">+</span> className<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>              classNames<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>className<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable ignore<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          Log<span style="color:#f92672">.</span><span style="color:#a6e22e">e</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ARouter&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Scan map file in dex files made error.&#34;</span><span style="color:#f92672">,</span> ignore<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">!=</span> dexfile<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>              dexfile<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable ignore<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          parserCtl<span style="color:#f92672">.</span><span style="color:#a6e22e">countDown</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  parserCtl<span style="color:#f92672">.</span><span style="color:#a6e22e">await</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Log<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>Consts<span style="color:#f92672">.</span><span style="color:#a6e22e">TAG</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Filter &#34;</span> <span style="color:#f92672">+</span> classNames<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; classes by packageName &lt;&#34;</span> <span style="color:#f92672">+</span> packageName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&gt;&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> classNames<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>注意其中的<em>getSourcePaths</em>方法，这是从代码目录，来获取所有代码目录，然后在</p>
<p><em>getFileNameByPackageName</em>找出以<code>com.alibaba.android.arouter.routes</code>为开头包名的类，这些就是我们在步骤1中生成的辅助类。</p>
<p>这个方法结束后，回到<em>LogisticsCenter#init</em>方法，接下来要做的就是，把加载到的辅助类，通过反射生成对象，再调用其<em>loadTo</em>方法，将路由路径表加载到Warehouse类中去，方便以后的查询。</p>
<h2 id="辅助流程">辅助流程</h2>
<p>在以上的流程中，有一个严重的问题，那就是执行<em>ARouter#init</em>方法的时间过长，以源码的demo为例，在InstantRun的情况下，OnePlus5T需要100多毫秒才能初始化完，这对于程序启动优化来说，是一个不可忽视的时间了。那么如何解决这个问题呢？</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>MainActivity: init cost <span style="color:#ae81ff">134</span>
</span></span></code></pre></div><p>这就是在上一步中，要求你注释掉的代码起作用了，将<code>apply plugin: 'com.alibaba.arouter'</code>解除注释，让其发挥作用。</p>
<p>这里需要关注的module是<code>arouter-gradle-plugin</code>。</p>
<p>先来看一下，使用了<code>apply plugin: 'com.alibaba.arouter'</code>的神奇效果。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>MainActivity: init cost <span style="color:#ae81ff">19</span>
</span></span></code></pre></div><p>通过优化，让<em>ARouter#init</em>消耗时间直接降低了一个数量级，那么<code>arouter-gradle-plugin</code>是怎么做到的呢？</p>
<p>这需要你先了解一下<a href="%7B%7Bsite.base_url%7D%7D/android/ASM.md">ASM</a>。简单来说，这是一种字节码编程技术，通过修改编译后的字节码的方式，来对原始逻辑增强。</p>
<p>我们再来看<em>ARouter#init</em>的最终实现类和方法<em>LogisticsCenter#init</em>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">,</span> ThreadPoolExecutor tpe<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> HandlerException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">....</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> startInit <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//billy.qi modified at 2017-12-06
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//load by plugin first
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    loadRouterMap<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>registerByPlugin<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      logger<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Load router map by arouter-auto-register plugin.&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">....</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.....</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> HandlerException<span style="color:#f92672">(</span>TAG <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;ARouter init logistics center exception! [&#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;]&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>我们可以看到，当<code>registerByPlugin</code>为true的时候，则只是打印了一句日志，我们再看loadRouterMap()这个方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loadRouterMap</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  registerByPlugin <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//auto generate register code by gradle plugin: arouter-auto-register
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// looks like below:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// registerRouteRoot(new ARouter..Root..modulejava());
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// registerRouteRoot(new ARouter..Root..modulekotlin());
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>这里的逻辑非常简单，到底在哪里去加载的路由路径表呢？我们看这个方法的注释，发现，这个方法是被<code>arouter-auto-register</code>自动生成的。</p>
<p>我们打开<code>arouter-gradle-plugin/resources/META-INF/gradle-plugins</code>这个目录，可以看到，有一个<em>com.alibaba.arouter.properties</em>文件，查看其内容：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">implementation-class=com.alibaba.android.arouter.register.launch.PluginLaunch
</code></pre><p>这个<em>PluginLaunch</em>便是此gradle plugin的入口类。查看此类：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PluginLaunch</span> <span style="color:#66d9ef">implements</span> Plugin<span style="color:#f92672">&lt;</span>Project<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span>Project project<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> isApp <span style="color:#f92672">=</span> project<span style="color:#f92672">.</span><span style="color:#a6e22e">plugins</span><span style="color:#f92672">.</span><span style="color:#a6e22e">hasPlugin</span><span style="color:#f92672">(</span>AppPlugin<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//only application module needs this plugin to generate register code
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isApp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      Logger<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span>project<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      Logger<span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Project enable arouter-register plugin&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> android <span style="color:#f92672">=</span> project<span style="color:#f92672">.</span><span style="color:#a6e22e">extensions</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getByType</span><span style="color:#f92672">(</span>AppExtension<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> transformImpl <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RegisterTransform<span style="color:#f92672">(</span>project<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">//init arouter-auto-register settings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      ArrayList<span style="color:#f92672">&lt;</span>ScanSetting<span style="color:#f92672">&gt;</span> list <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;(</span><span style="color:#ae81ff">3</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      list<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ScanSetting<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;IRouteRoot&#39;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>      list<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ScanSetting<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;IInterceptorGroup&#39;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>      list<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ScanSetting<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;IProviderGroup&#39;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>      RegisterTransform<span style="color:#f92672">.</span><span style="color:#a6e22e">registerList</span> <span style="color:#f92672">=</span> list
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">//register this plugin
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      android<span style="color:#f92672">.</span><span style="color:#a6e22e">registerTransform</span><span style="color:#f92672">(</span>transformImpl<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>我们查看其代码，可以发现，这里一共做了三件事：</p>
<ol>
<li>判断是否为app module，如果不是，则不做任何事，在app module下做2和3两步；</li>
<li>生成了一个RegisterTransform，并为其静态变量registerList赋值，<strong>注意此处赋值的registerList中包含的三个对象</strong>；</li>
<li>注册此RegisterTransform。</li>
</ol>
<p>接下来，就轮到<em>RegisterTransform</em>来执行了。</p>
<p>Transform类，简单来说，就是可以在编译时，扫描所有的jar和class，包括引用类库中的。在扫描过程中，就可以借助<strong>ASM</strong>技术对目标类进行更改。</p>
<p>我们看其入口方法<em>transform</em>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transform</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">,</span> Collection<span style="color:#f92672">&lt;</span>TransformInput<span style="color:#f92672">&gt;</span> inputs<span style="color:#f92672">,</span> Collection<span style="color:#f92672">&lt;</span>TransformInput<span style="color:#f92672">&gt;</span> referencedInputs<span style="color:#f92672">,</span> TransformOutputProvider outputProvider<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> isIncremental<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> TransformException<span style="color:#f92672">,</span> InterruptedException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  inputs<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> TransformInput input <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// scan all jars
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    input<span style="color:#f92672">.</span><span style="color:#a6e22e">jarInputs</span><span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> JarInput jarInput <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ScanUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">shouldProcessPreDexJar</span><span style="color:#f92672">(</span>src<span style="color:#f92672">.</span><span style="color:#a6e22e">absolutePath</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        ScanUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">scanJar</span><span style="color:#f92672">(</span>src<span style="color:#f92672">,</span> dest<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  input<span style="color:#f92672">.</span><span style="color:#a6e22e">directoryInputs</span><span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> DirectoryInput directoryInput <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    directoryInput<span style="color:#f92672">.</span><span style="color:#a6e22e">file</span><span style="color:#f92672">.</span><span style="color:#a6e22e">eachFileRecurse</span> <span style="color:#f92672">{</span> File file <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>file<span style="color:#f92672">.</span><span style="color:#a6e22e">isFile</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> ScanUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">shouldProcessClass</span><span style="color:#f92672">(</span>path<span style="color:#f92672">)){</span>
</span></span><span style="display:flex;"><span>        ScanUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">scanClass</span><span style="color:#f92672">(</span>file<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>省去了一些细节，只保留了主线逻辑，我们可以看到，其扫描到的jar和class都经过了ScanUtils的方法来处理，我们继续跟踪下去，会发现，<em>scanJar</em>也是循环调用的<em>scanClass</em>，这样我们直接看<em>scanClass</em>方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">scanClass</span><span style="color:#f92672">(</span>InputStream inputStream<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  ClassReader cr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClassReader<span style="color:#f92672">(</span>inputStream<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  ClassWriter cw <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClassWriter<span style="color:#f92672">(</span>cr<span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  ScanClassVisitor cv <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ScanClassVisitor<span style="color:#f92672">(</span>Opcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">ASM5</span><span style="color:#f92672">,</span> cw<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  cr<span style="color:#f92672">.</span><span style="color:#a6e22e">accept</span><span style="color:#f92672">(</span>cv<span style="color:#f92672">,</span> ClassReader<span style="color:#f92672">.</span><span style="color:#a6e22e">EXPAND_FRAMES</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  inputStream<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ScanClassVisitor</span> <span style="color:#66d9ef">extends</span> ClassVisitor <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ScanClassVisitor<span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> api<span style="color:#f92672">,</span> ClassVisitor cv<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>api<span style="color:#f92672">,</span> cv<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visit</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> version<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> access<span style="color:#f92672">,</span> String name<span style="color:#f92672">,</span> String signature<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>             String superName<span style="color:#f92672">,</span> String<span style="color:#f92672">[]</span> interfaces<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">visit</span><span style="color:#f92672">(</span>version<span style="color:#f92672">,</span> access<span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> signature<span style="color:#f92672">,</span> superName<span style="color:#f92672">,</span> interfaces<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    RegisterTransform<span style="color:#f92672">.</span><span style="color:#a6e22e">registerList</span><span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> ext <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ext<span style="color:#f92672">.</span><span style="color:#a6e22e">interfaceName</span> <span style="color:#f92672">&amp;&amp;</span> interfaces <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        interfaces<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> itName <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>itName <span style="color:#f92672">==</span> ext<span style="color:#f92672">.</span><span style="color:#a6e22e">interfaceName</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//fix repeated inject init code when Multi-channel packaging
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>ext<span style="color:#f92672">.</span><span style="color:#a6e22e">classList</span><span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>name<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>              ext<span style="color:#f92672">.</span><span style="color:#a6e22e">classList</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>这里就又涉及到了ASM的知识，ScanClassVisitor是访问某个类的内部结构。</p>
<blockquote>
<p>version：类的版本；</p>
<p>access：表示类的访问权限，public，private，protected等；</p>
<p>name：类的名字；</p>
<p>signature：有无泛型；</p>
<p>superName：其父类；</p>
<p>interfaces：其实现的接口；</p>
</blockquote>
<p>在<em>ScanClassVisitor</em>中，并没有对类做修改，只是从遍历过的类中，把我们关心的类挑出来。那么，我们关心哪些类呢？</p>
<p>在<em>PluginLaunch</em>类中，我们注册了三个<em>ScanSettings</em>类，分别是<strong>IRouteRoot</strong>、<strong>IInterceptorGroup</strong>和<strong>IProviderGroup</strong>，也就是说，我们把实现了这三个接口的类，挑出来，加入到各自对应的ScanSettings类中记录起来。这三个接口是不是很熟悉？就是通过APT生成的用来记录路由路径表的类。</p>
<p>等收集好了这些记录的路径表信息后，就可以对<em>LogisticsCenter</em>通过ASM进行修改了。我们接着看<em>RegisterTransform#transform</em>方法中剩下的逻辑。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fileContainsInitClass<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  registerList<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> ext <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    Logger<span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Insert register code to file &#39;</span> <span style="color:#f92672">+</span> fileContainsInitClass<span style="color:#f92672">.</span><span style="color:#a6e22e">absolutePath</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ext<span style="color:#f92672">.</span><span style="color:#a6e22e">classList</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      Logger<span style="color:#f92672">.</span><span style="color:#a6e22e">e</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;No class implements found for interface:&#34;</span> <span style="color:#f92672">+</span> ext<span style="color:#f92672">.</span><span style="color:#a6e22e">interfaceName</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      ext<span style="color:#f92672">.</span><span style="color:#a6e22e">classList</span><span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Logger<span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">(</span>it<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      RegisterCodeGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">insertInitCodeTo</span><span style="color:#f92672">(</span>ext<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>注意此处的insertInitCodeTo方法，这就是ASM修改的入口了。这里不对修改过程进行详细解释了。我们直接对比看<em>LogisticsCenter</em>修改前后关键代码的对比。</p>
<p>在<em>app/build</em>目录下，找到生成的apk文件，通过AndroidStudio来查看其中的class，找到关键<em>LogisticsCenter</em>关键方法<em>loadRouterMap</em>。</p>
<blockquote>
<p>具体过程如下：</p>
<p>app/build/outputs/apk/debug/app-debug.apk -&gt; classes.dex(双击) -&gt; 找到<em>LogisticsCenter#loadRouterMap</em>方法 -&gt; 右键: show Bytecode。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 不使用apply plugin: &#39;com.alibaba.arouter&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">.</span><span style="color:#a6e22e">method</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">loadRouterMap</span><span style="color:#f92672">()</span>V
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">registers</span> 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">line</span> 64
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span><span style="color:#f92672">/</span>4 v0<span style="color:#f92672">,</span> 0x0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sput<span style="color:#f92672">-</span><span style="color:#66d9ef">boolean</span> v0<span style="color:#f92672">,</span> Lcom<span style="color:#f92672">/</span>alibaba<span style="color:#f92672">/</span>android<span style="color:#f92672">/</span>arouter<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>LogisticsCenter<span style="color:#f92672">;-&gt;</span>registerByPlugin<span style="color:#f92672">:</span>Z
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">line</span> 69
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span><span style="color:#f92672">-</span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">.</span><span style="color:#a6e22e">end</span> method
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 使用apply plugin: &#39;com.alibaba.arouter&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">.</span><span style="color:#a6e22e">method</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">loadRouterMap</span><span style="color:#f92672">()</span>V
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">registers</span> 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">line</span> 64
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span><span style="color:#f92672">/</span>4 v0<span style="color:#f92672">,</span> 0x0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sput<span style="color:#f92672">-</span><span style="color:#66d9ef">boolean</span> v0<span style="color:#f92672">,</span> Lcom<span style="color:#f92672">/</span>alibaba<span style="color:#f92672">/</span>android<span style="color:#f92672">/</span>arouter<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>LogisticsCenter<span style="color:#f92672">;-&gt;</span>registerByPlugin<span style="color:#f92672">:</span>Z
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">line</span> 69
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span><span style="color:#f92672">-</span>string v0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;com.alibaba.android.arouter.routes.ARouter$$Root$$modulejava&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    invoke<span style="color:#f92672">-</span><span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>v0<span style="color:#f92672">},</span> Lcom<span style="color:#f92672">/</span>alibaba<span style="color:#f92672">/</span>android<span style="color:#f92672">/</span>arouter<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>LogisticsCenter<span style="color:#f92672">;-&gt;</span>register<span style="color:#f92672">(</span>Ljava<span style="color:#f92672">/</span>lang<span style="color:#f92672">/</span>String<span style="color:#f92672">;)</span>V
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span><span style="color:#f92672">-</span>string v0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;com.alibaba.android.arouter.routes.ARouter$$Root$$modulekotlin&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    invoke<span style="color:#f92672">-</span><span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>v0<span style="color:#f92672">},</span> Lcom<span style="color:#f92672">/</span>alibaba<span style="color:#f92672">/</span>android<span style="color:#f92672">/</span>arouter<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>LogisticsCenter<span style="color:#f92672">;-&gt;</span>register<span style="color:#f92672">(</span>Ljava<span style="color:#f92672">/</span>lang<span style="color:#f92672">/</span>String<span style="color:#f92672">;)</span>V
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span><span style="color:#f92672">-</span>string v0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;com.alibaba.android.arouter.routes.ARouter$$Root$$arouterapi&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    invoke<span style="color:#f92672">-</span><span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>v0<span style="color:#f92672">},</span> Lcom<span style="color:#f92672">/</span>alibaba<span style="color:#f92672">/</span>android<span style="color:#f92672">/</span>arouter<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>LogisticsCenter<span style="color:#f92672">;-&gt;</span>register<span style="color:#f92672">(</span>Ljava<span style="color:#f92672">/</span>lang<span style="color:#f92672">/</span>String<span style="color:#f92672">;)</span>V
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span><span style="color:#f92672">-</span>string v0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;com.alibaba.android.arouter.routes.ARouter$$Root$$app&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    invoke<span style="color:#f92672">-</span><span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>v0<span style="color:#f92672">},</span> Lcom<span style="color:#f92672">/</span>alibaba<span style="color:#f92672">/</span>android<span style="color:#f92672">/</span>arouter<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>LogisticsCenter<span style="color:#f92672">;-&gt;</span>register<span style="color:#f92672">(</span>Ljava<span style="color:#f92672">/</span>lang<span style="color:#f92672">/</span>String<span style="color:#f92672">;)</span>V
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span><span style="color:#f92672">-</span>string v0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;com.alibaba.android.arouter.routes.ARouter$$Interceptors$$modulejava&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    invoke<span style="color:#f92672">-</span><span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>v0<span style="color:#f92672">},</span> Lcom<span style="color:#f92672">/</span>alibaba<span style="color:#f92672">/</span>android<span style="color:#f92672">/</span>arouter<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>LogisticsCenter<span style="color:#f92672">;-&gt;</span>register<span style="color:#f92672">(</span>Ljava<span style="color:#f92672">/</span>lang<span style="color:#f92672">/</span>String<span style="color:#f92672">;)</span>V
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span><span style="color:#f92672">-</span>string v0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;com.alibaba.android.arouter.routes.ARouter$$Interceptors$$app&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    invoke<span style="color:#f92672">-</span><span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>v0<span style="color:#f92672">},</span> Lcom<span style="color:#f92672">/</span>alibaba<span style="color:#f92672">/</span>android<span style="color:#f92672">/</span>arouter<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>LogisticsCenter<span style="color:#f92672">;-&gt;</span>register<span style="color:#f92672">(</span>Ljava<span style="color:#f92672">/</span>lang<span style="color:#f92672">/</span>String<span style="color:#f92672">;)</span>V
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span><span style="color:#f92672">-</span>string v0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;com.alibaba.android.arouter.routes.ARouter$$Providers$$modulejava&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    invoke<span style="color:#f92672">-</span><span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>v0<span style="color:#f92672">},</span> Lcom<span style="color:#f92672">/</span>alibaba<span style="color:#f92672">/</span>android<span style="color:#f92672">/</span>arouter<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>LogisticsCenter<span style="color:#f92672">;-&gt;</span>register<span style="color:#f92672">(</span>Ljava<span style="color:#f92672">/</span>lang<span style="color:#f92672">/</span>String<span style="color:#f92672">;)</span>V
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span><span style="color:#f92672">-</span>string v0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;com.alibaba.android.arouter.routes.ARouter$$Providers$$modulekotlin&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    invoke<span style="color:#f92672">-</span><span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>v0<span style="color:#f92672">},</span> Lcom<span style="color:#f92672">/</span>alibaba<span style="color:#f92672">/</span>android<span style="color:#f92672">/</span>arouter<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>LogisticsCenter<span style="color:#f92672">;-&gt;</span>register<span style="color:#f92672">(</span>Ljava<span style="color:#f92672">/</span>lang<span style="color:#f92672">/</span>String<span style="color:#f92672">;)</span>V
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span><span style="color:#f92672">-</span>string v0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;com.alibaba.android.arouter.routes.ARouter$$Providers$$arouterapi&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    invoke<span style="color:#f92672">-</span><span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>v0<span style="color:#f92672">},</span> Lcom<span style="color:#f92672">/</span>alibaba<span style="color:#f92672">/</span>android<span style="color:#f92672">/</span>arouter<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>LogisticsCenter<span style="color:#f92672">;-&gt;</span>register<span style="color:#f92672">(</span>Ljava<span style="color:#f92672">/</span>lang<span style="color:#f92672">/</span>String<span style="color:#f92672">;)</span>V
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span><span style="color:#f92672">-</span>string v0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;com.alibaba.android.arouter.routes.ARouter$$Providers$$app&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    invoke<span style="color:#f92672">-</span><span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>v0<span style="color:#f92672">},</span> Lcom<span style="color:#f92672">/</span>alibaba<span style="color:#f92672">/</span>android<span style="color:#f92672">/</span>arouter<span style="color:#f92672">/</span>core<span style="color:#f92672">/</span>LogisticsCenter<span style="color:#f92672">;-&gt;</span>register<span style="color:#f92672">(</span>Ljava<span style="color:#f92672">/</span>lang<span style="color:#f92672">/</span>String<span style="color:#f92672">;)</span>V
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span><span style="color:#f92672">-</span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">.</span><span style="color:#a6e22e">end</span> method
</span></span></code></pre></div><p>对比发现，使用<code>apply plugin: 'com.alibaba.arouter'</code>后，这个方法增加了很多代码，基本上就是在加载路由路径表。使用这个gradle插件的基本思想就是，将查找路由路径表的过程，从<strong>运行时</strong>提前到了<strong>编译时</strong>，这算是一种AOT(Ahead of time)思想。</p>
<p>将最耗时的查找过程提前，也就解决了ARouter初始化时间过长的问题。</p>
</section>

  
  
  <footer class="mt-12 flex flex-wrap">
     
    <a
      class="mr-1.5 mb-1.5 rounded-lg bg-black/[3%] px-5 py-2 no-underline dark:bg-white/[8%]"
      href="https://boybeak.github.io/tags/untagged"
      >untagged</a
    >
    
  </footer>
  

  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    <a class="flex w-1/2 items-center p-6 pr-3 no-underline" href="https://boybeak.github.io/posts/android/app%E4%BF%9D%E6%B4%BB%E6%9C%AF/"
      ><span class="mr-1.5">←</span><span>App保活术</span></a
    >
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end p-6 pl-3 no-underline"
      href="https://boybeak.github.io/posts/android/asm/"
      ><span>ASM库介绍与使用</span><span class="ml-1.5">→</span></a
    >
    
  </nav>
  

  
  
  <div id="disqus_thread"></div>
  <script>
    const disqusShortname = 'YOUR_DISQUS_SHORTNAME';
    const script = document.createElement('script');
    script.src = 'https://' + disqusShortname + '.disqus.com/embed.js';
    script.setAttribute('data-timestamp', +new Date());
    document.head.appendChild(script);
  </script>
  
</article>


    </main>

    <footer class="opaco mx-auto flex h-[5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60">
  <div class="mr-auto">
    &copy; 2022
    <a class="link" href="https://boybeak.github.io/">My New Hugo Site</a>
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank">Powered by Hugo️️</a
  >️
  <a class="link" href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank"
    >▷ Paper 6</a
  >
</footer>

  </body>
</html>
